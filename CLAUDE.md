<!-- MIND:VERSION:2 -->
## Memory (Mind)

This project uses Mind for persistent memory across sessions.

### Required Protocol

1. **Session Start**: ALWAYS call `mind_recall()` before responding to the first message.

2. **During Work**: Use `mind_log(message, type)` to capture what happens:
   - `decision`, `learning`, `problem`, `progress` → MEMORY.md (permanent)
   - `experience`, `blocker`, `rejected`, `assumption` → SESSION.md (ephemeral)

3. **Session End**: Summarize with `## DATE | what happened | mood: X`

### Tools Available
`mind_recall()` | `mind_log(msg, type)` | `mind_session()` | `mind_blocker(desc)` | `mind_search(query)` | `mind_remind(msg, when)` | `mind_checkpoint()` | `mind_edges(intent)` | `mind_status()`

---

<!-- MIND:CONTEXT - Auto-generated by Mind. Do not edit. -->
## Stack
sveltekit, typescript, supabase

## Supabase Configuration (IMPORTANT)
**Current Project**: `kgxjubeaddrocooklyib`
- **URL**: `https://kgxjubeaddrocooklyib.supabase.co`
- **API Key**: See `.env` file for `VITE_SUPABASE_ANON_KEY`
- **Note**: Old project `jryabrpfzwtdqvnemqgj` is defunct - DO NOT USE

---

# Vibeship Scanner Development Guide

Security scanning tool analyzing GitHub repos using **Opengrep** (SAST), **Trivy** (dependencies), **Gitleaks** (secrets).

## THE #1 RULE: COVERAGE = DETECTED vs DOCUMENTED

```
COVERAGE IS NEVER: "We have rules for X"
COVERAGE IS ALWAYS: "Scan [ID] detected X at [file:line] with [rule_id]"

For full verification methodology, see: SECURITY_TEST_PROCEDURE.md
```

---

## How to Trigger Scans

**ALWAYS use the deployed API** - never run local opengrep commands directly.

### Quick Scan Command
```bash
SCAN_ID=$(python -c "import uuid; print(uuid.uuid4())") && \
echo "Scan ID: $SCAN_ID" && \
echo "View at: https://scanner.vibeship.co/scan/$SCAN_ID" && \
curl -X POST https://scanner-empty-field-5676.fly.dev/scan \
  -H "Content-Type: application/json" \
  -d "{\"scanId\": \"$SCAN_ID\", \"repoUrl\": \"https://github.com/OWNER/REPO\"}"
```

### View Results
- **Production**: `https://scanner.vibeship.co/scan/<scanId>`
- **Local dev**: `http://localhost:5173/scan/<scanId>`

### Monitor Scans
```bash
fly logs -a scanner-empty-field-5676           # Real-time
fly logs -a scanner-empty-field-5676 --no-tail # Recent logs
```

### Common Issues
- **Scan stuck**: Check Fly.io logs for errors
- **DB errors**: Ensure scan row has proper schema (target_url, target_url_hash, target_branch)
- **Deploy kills scans**: Wait for completion before deploying

---

## Architecture

```
vibeship-scanner/
├── src/                    # SvelteKit frontend
│   ├── routes/             # Pages and API routes
│   └── lib/                # Shared utilities
├── scanner/                # Python scanner service (Fly.io)
│   ├── scan.py             # Main orchestrator
│   ├── server.py           # Flask API
│   └── rules/              # Opengrep rule files
└── docs/                   # Documentation
```

### Key Files
- `scanner/rules/*.yaml` - Security detection rules
- `scanner/scan.py` - Main scanning logic
- `src/routes/scan/[id]/+page.svelte` - Scan results page

---

## Development Commands

```bash
npm run dev                              # Start frontend
npm run build                            # Build production
cd scanner && fly deploy --remote-only   # Deploy scanner
semgrep --validate --config scanner/rules/  # Validate rules
```

---

## Benchmark Testing Workflow

For each vulnerable repo, iterate until 100% SAST coverage:

```
1. SCAN → Trigger via API, save scan_id
2. GAP ANALYSIS → Compare findings vs repo's documented vulns
3. WRITE RULES → Create Opengrep rules for gaps
4. DEPLOY → fly deploy --remote-only
5. RESCAN → Verify new detections
6. ITERATE → Repeat until all SAST-detectable vulns are caught
```

### SAST-Detectable vs Runtime-Only

| SAST-Detectable | NOT SAST-Detectable |
|-----------------|---------------------|
| SQL/Command/Code Injection | CSRF (token validation) |
| XSS (server-side), SSTI | Session Management |
| Path Traversal, SSRF, XXE | Rate Limiting, DoS |
| Hardcoded Secrets | BOLA/BFLA (authorization) |
| Insecure Deserialization | Business Logic Flaws |
| Dangerous function calls | Race Conditions |

**Full benchmark data**: See `SECURITY_TEST_PROCEDURE.md` for:
- 32 verified benchmark repos with scan IDs
- Detection coverage matrix by language
- crAPI, DSVW, and other detailed verifications

---

## DON'T DO THIS (Anti-Patterns)

| Mistake | Why It's Wrong |
|---------|----------------|
| "We have rules for X, so X is covered" | Having rules ≠ detecting. Verify with actual scan. |
| "Scan found 1000 findings, coverage is high" | Must map to EACH documented vuln, not total count. |
| "Previous session said 90%" | Rules change. Re-verify with fresh scan. |
| Marking ✅ without file:line evidence | No proof = no detection. |
| Claiming detection without scan ID | Always cite: `scan_id + rule_id + file:line` |
| Estimating coverage | Calculate from actual data only. |

---

## Semgrep/Opengrep Rule Guidelines

```yaml
# GOOD - Quote patterns with colons
pattern: 'subprocess.call($CMD, shell=True)'

# BAD - Will fail validation
pattern: subprocess.call($CMD, shell=True)
```

**Always validate**: `semgrep --validate --config scanner/rules/`

**Include**: Unique rule ID, clear message, severity (ERROR/WARNING/INFO), target languages

---

## Deployment

**Frontend**: Auto-deploys via Vercel on push to main

**Scanner**: Manual deploy
```bash
cd scanner && fly deploy --remote-only --no-cache
```

---

## MCP Servers

### Public Endpoint
**URL**: `https://scanner.vibeship.co/mcp`

```json
{
  "mcpServers": {
    "vibeship-scanner": {
      "command": "npx",
      "args": ["mcp-remote", "https://scanner.vibeship.co/mcp"]
    }
  }
}
```

**Tools**: `scanner_scan`, `scanner_status`, `scanner_lookup_cve`, `scanner_lookup_cwe`, `scanner_get_fix`, `scanner_master_prompt`

---

## Visual Reporting Format

Use this format for scan comparisons:

```
╔══════════════════════════════════════════════════════════════════════════════╗
║  [REPO NAME] COVERAGE VERIFICATION                                           ║
╠══════════════════════════════════════════════════════════════════════════════╣
║  Scan ID: [scan-id] | Total Findings: XX                                     ║
╚══════════════════════════════════════════════════════════════════════════════╝

| # | Documented Vuln | SAST? | Detected | Rule ID | Evidence |
|---|-----------------|-------|----------|---------|----------|
| 1 | SQL Injection   | YES   | ✅       | py-sqli | file.py:42 |
| 2 | XSS             | YES   | ✅       | xss-*   | app.js:15 |
| 3 | CSRF            | NO    | ➖ N/A   | -       | Runtime only |
| 4 | Command Inj     | YES   | ❌ GAP   | -       | NEEDS RULE |

SAST Coverage: X/Y = Z%
```

**Status symbols**: ✅ Detected | ⚠️ Partial | ❌ Gap | ➖ N/A (runtime)

---

## Environment Variables

**Frontend (.env)**:
- `PUBLIC_SUPABASE_URL`
- `PUBLIC_SUPABASE_ANON_KEY`
- `SCANNER_API_URL`

**Scanner**: Set via `fly secrets set KEY=value`

---

## Related Documents

- `SECURITY_TEST_PROCEDURE.md` - Full benchmark methodology and verified repo data
- `SECURITY_COMMONS.md` - Vulnerability database with code examples
- `scanner/rules/` - All detection rules
