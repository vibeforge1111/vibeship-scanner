# C# Security Rules
rules:
  # ============================================
  # SQL Injection
  # ============================================

  - id: csharp-sql-concat
    pattern: $CMD.CommandText = $Q + $INPUT
    message: C# SQL injection via concatenation - use parameterized queries
    languages: [csharp]
    severity: ERROR

  - id: csharp-sql-string-format
    pattern: $CMD.CommandText = string.Format($Q, ...)
    message: C# SQL injection via string.Format - use parameterized queries
    languages: [csharp]
    severity: ERROR

  - id: csharp-sql-interpolation
    pattern: $CMD.CommandText = $"..."
    message: C# SQL injection via string interpolation - use parameterized queries
    languages: [csharp]
    severity: ERROR

  - id: csharp-sqlcommand-text
    pattern: new SqlCommand($QUERY, ...)
    message: C# SqlCommand - ensure parameterized queries
    languages: [csharp]
    severity: WARNING

  - id: csharp-ef-rawsql
    pattern: $DB.Database.ExecuteSqlRaw($QUERY, ...)
    message: C# EF Core raw SQL - ensure parameterized
    languages: [csharp]
    severity: WARNING

  - id: csharp-ef-fromsqlraw
    pattern: $DB.FromSqlRaw($QUERY)
    message: C# EF Core FromSqlRaw - ensure parameterized
    languages: [csharp]
    severity: WARNING

  # ============================================
  # Command Injection
  # ============================================

  - id: csharp-process-start
    pattern: Process.Start($CMD)
    message: C# command execution - injection risk
    languages: [csharp]
    severity: WARNING

  - id: csharp-process-start-info
    pattern: new ProcessStartInfo($CMD)
    message: C# ProcessStartInfo - command injection risk
    languages: [csharp]
    severity: WARNING

  - id: csharp-process-filename
    pattern: $PSI.FileName = $CMD
    message: C# process filename from variable - injection risk
    languages: [csharp]
    severity: WARNING

  - id: csharp-process-arguments
    pattern: $PSI.Arguments = $ARGS
    message: C# process arguments from variable - injection risk
    languages: [csharp]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: csharp-binaryformatter
    pattern: BinaryFormatter().Deserialize($STREAM)
    message: C# BinaryFormatter deserialization is insecure
    languages: [csharp]
    severity: ERROR

  - id: csharp-binaryformatter-new
    pattern: new BinaryFormatter()
    message: C# BinaryFormatter is insecure - do not use
    languages: [csharp]
    severity: ERROR

  - id: csharp-javascriptserializer
    pattern: new JavaScriptSerializer().Deserialize($DATA)
    message: C# JavaScriptSerializer - use System.Text.Json instead
    languages: [csharp]
    severity: WARNING

  - id: csharp-netdatacontract
    pattern: new NetDataContractSerializer()
    message: C# NetDataContractSerializer is insecure
    languages: [csharp]
    severity: ERROR

  - id: csharp-losformatter
    pattern: new LosFormatter()
    message: C# LosFormatter is insecure
    languages: [csharp]
    severity: ERROR

  - id: csharp-objectstateformatter
    pattern: new ObjectStateFormatter()
    message: C# ObjectStateFormatter is insecure
    languages: [csharp]
    severity: ERROR

  - id: csharp-soapformatter
    pattern: new SoapFormatter()
    message: C# SoapFormatter is insecure
    languages: [csharp]
    severity: ERROR

  # ============================================
  # XXE (XML External Entity)
  # ============================================

  - id: csharp-xxe-xmlreader
    pattern: XmlReader.Create($INPUT)
    message: C# XXE risk - configure XmlReaderSettings
    languages: [csharp]
    severity: WARNING

  - id: csharp-xxe-xmldocument
    pattern: new XmlDocument()
    message: C# XmlDocument - ensure DTD processing is disabled
    languages: [csharp]
    severity: WARNING

  - id: csharp-xxe-xmltextreader
    pattern: new XmlTextReader($INPUT)
    message: C# XmlTextReader - XXE risk, use XmlReader with secure settings
    languages: [csharp]
    severity: WARNING

  - id: csharp-xxe-dtd-processing
    pattern: 'DtdProcessing = DtdProcessing.Parse'
    message: C# DTD processing enabled - XXE vulnerability
    languages: [csharp]
    severity: ERROR

  - id: csharp-xxe-prohibit-dtd
    pattern: 'ProhibitDtd = false'
    message: C# DTD not prohibited - XXE vulnerability
    languages: [csharp]
    severity: ERROR

  # ============================================
  # Path Traversal
  # ============================================

  - id: csharp-path-combine-user
    pattern: Path.Combine($BASE, $USER_INPUT)
    message: C# Path.Combine with user input - path traversal risk
    languages: [csharp]
    severity: WARNING

  - id: csharp-file-read-user
    pattern: File.ReadAllText($USER_INPUT)
    message: C# file read with user input - path traversal risk
    languages: [csharp]
    severity: ERROR

  - id: csharp-file-write-user
    pattern: File.WriteAllText($USER_INPUT, ...)
    message: C# file write with user input - path traversal risk
    languages: [csharp]
    severity: ERROR

  - id: csharp-filestream-user
    pattern: new FileStream($USER_INPUT, ...)
    message: C# FileStream with user input - path traversal risk
    languages: [csharp]
    severity: ERROR

  # ============================================
  # ReDoS
  # ============================================

  - id: csharp-regex-timeout
    pattern: new Regex($PATTERN)
    message: C# Regex without timeout - ReDoS risk
    languages: [csharp]
    severity: WARNING

  - id: csharp-regex-match-timeout
    pattern: Regex.Match($INPUT, $PATTERN)
    message: C# Regex.Match - consider using timeout parameter
    languages: [csharp]
    severity: INFO

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: csharp-md5-create
    pattern: MD5.Create()
    message: C# MD5 is weak - use SHA-256 or better
    languages: [csharp]
    severity: WARNING

  - id: csharp-sha1-create
    pattern: SHA1.Create()
    message: C# SHA1 is weak - use SHA-256 or better
    languages: [csharp]
    severity: WARNING

  - id: csharp-des-create
    pattern: DES.Create()
    message: C# DES is weak - use AES
    languages: [csharp]
    severity: ERROR

  - id: csharp-3des-create
    pattern: TripleDES.Create()
    message: C# 3DES is deprecated - use AES
    languages: [csharp]
    severity: WARNING

  - id: csharp-random
    pattern: new Random()
    message: C# Random is not cryptographically secure - use RandomNumberGenerator
    languages: [csharp]
    severity: WARNING

  - id: csharp-aes-ecb
    pattern: 'CipherMode.ECB'
    message: C# ECB mode is insecure - use CBC or GCM
    languages: [csharp]
    severity: ERROR

  # ============================================
  # SSL/TLS Issues
  # ============================================

  - id: csharp-ssl-callback-true
    pattern: 'ServerCertificateValidationCallback = (...) => true'
    message: C# SSL certificate validation disabled
    languages: [csharp]
    severity: ERROR

  - id: csharp-ssl-protocols-old
    pattern: 'SecurityProtocolType.Ssl3'
    message: C# SSL3 is insecure - use TLS 1.2+
    languages: [csharp]
    severity: ERROR

  - id: csharp-ssl-protocols-tls10
    pattern: 'SecurityProtocolType.Tls'
    message: C# TLS 1.0 is deprecated - use TLS 1.2+
    languages: [csharp]
    severity: WARNING

  - id: csharp-ssl-protocols-tls11
    pattern: 'SecurityProtocolType.Tls11'
    message: C# TLS 1.1 is deprecated - use TLS 1.2+
    languages: [csharp]
    severity: WARNING

  # ============================================
  # LDAP Injection
  # ============================================

  - id: csharp-ldap-filter
    pattern: $SEARCHER.Filter = $FILTER
    message: C# LDAP filter - potential LDAP injection
    languages: [csharp]
    severity: WARNING

  - id: csharp-ldap-path
    pattern: new DirectoryEntry($PATH)
    message: C# DirectoryEntry - validate path for LDAP injection
    languages: [csharp]
    severity: WARNING

  # ============================================
  # XSS
  # ============================================

  - id: csharp-razor-raw
    pattern: Html.Raw($INPUT)
    message: C# Html.Raw bypasses encoding - XSS risk
    languages: [csharp]
    severity: WARNING

  - id: csharp-response-write
    pattern: Response.Write($INPUT)
    message: C# Response.Write - ensure output is encoded
    languages: [csharp]
    severity: WARNING

  # ============================================
  # Open Redirect
  # ============================================

  - id: csharp-redirect-user
    pattern: Response.Redirect($URL)
    message: C# redirect - validate URL to prevent open redirect
    languages: [csharp]
    severity: WARNING

  - id: csharp-redirect-action
    pattern: Redirect($URL)
    message: C# MVC Redirect - validate URL to prevent open redirect
    languages: [csharp]
    severity: WARNING

  # ============================================
  # Hardcoded Credentials
  # ============================================

  - id: csharp-hardcoded-password
    pattern: 'password = "..."'
    message: C# hardcoded password detected
    languages: [csharp]
    severity: ERROR

  - id: csharp-hardcoded-connectionstring
    pattern: 'connectionString = "..."'
    message: C# hardcoded connection string - use configuration
    languages: [csharp]
    severity: ERROR

  - id: csharp-sqlconnection-literal
    pattern: new SqlConnection("...")
    message: C# hardcoded connection string in SqlConnection
    languages: [csharp]
    severity: ERROR

  # ============================================
  # CSRF
  # ============================================

  - id: csharp-validateantiforgerytoken-missing
    pattern: |
      [HttpPost]
      public $RETURN $METHOD(...)
    message: C# HttpPost without ValidateAntiForgeryToken - CSRF risk
    languages: [csharp]
    severity: WARNING

  # ============================================
  # Session Security
  # ============================================

  - id: csharp-session-httponly-false
    pattern: 'HttpOnly = false'
    message: C# session cookie HttpOnly disabled
    languages: [csharp]
    severity: WARNING

  - id: csharp-session-secure-false
    pattern: 'Secure = false'
    message: C# session cookie Secure flag disabled
    languages: [csharp]
    severity: WARNING

  # ============================================
  # SSRF (Server-Side Request Forgery)
  # ============================================

  - id: csharp-ssrf-httpclient-getasync
    pattern: $CLIENT.GetAsync($URL)
    message: "C# HttpClient.GetAsync with variable URL - potential SSRF vulnerability (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  - id: csharp-ssrf-httpclient-postasync
    pattern: $CLIENT.PostAsync($URL, ...)
    message: "C# HttpClient.PostAsync with variable URL - potential SSRF vulnerability (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  - id: csharp-ssrf-httpclient-sendasync
    pattern: $CLIENT.SendAsync($REQUEST)
    message: "C# HttpClient.SendAsync - verify request URL is validated (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  - id: csharp-ssrf-webclient-download
    pattern: $CLIENT.DownloadString($URL)
    message: "C# WebClient.DownloadString with variable URL - potential SSRF (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  - id: csharp-ssrf-webclient-downloaddata
    pattern: $CLIENT.DownloadData($URL)
    message: "C# WebClient.DownloadData with variable URL - potential SSRF (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  - id: csharp-ssrf-webrequest-create
    pattern: WebRequest.Create($URL)
    message: "C# WebRequest.Create with variable URL - potential SSRF (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  - id: csharp-ssrf-httpwebrequest-create
    pattern: HttpWebRequest.Create($URL)
    message: "C# HttpWebRequest.Create with variable URL - potential SSRF (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  - id: csharp-ssrf-uri-user
    pattern: new Uri($USER_INPUT)
    message: "C# Uri from user input - validate to prevent SSRF (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  - id: csharp-ssrf-restclient
    pattern: new RestClient($URL)
    message: "C# RestSharp RestClient with variable URL - potential SSRF (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  - id: csharp-ssrf-flurl
    pattern: $URL.GetAsync()
    message: "C# Flurl request with variable URL - potential SSRF (CWE-918)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # ============================================
  # Insecure Logging (DVTA Gap)
  # ============================================

  - id: csharp-log-password
    patterns:
      - pattern: Console.WriteLine($FMT, ..., $PASSWORD, ...)
      - pattern: Debug.WriteLine($FMT, ..., $PASSWORD, ...)
      - pattern: Trace.WriteLine($MSG)
      - pattern: '$LOGGER.Log(..., $MSG, ...)'
    message: "C# logging may expose sensitive data - ensure passwords/secrets are not logged (CWE-532)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-532"
      tags: [logging]

  - id: csharp-console-write-sensitive
    pattern-either:
      - pattern: 'Console.WriteLine($"...password...")'
      - pattern: 'Console.WriteLine($"...secret...")'
      - pattern: 'Console.WriteLine($"...token...")'
      - pattern: 'Console.WriteLine($"...credential...")'
    message: "C# Console.WriteLine may log sensitive data (CWE-532)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-532"
      tags: [logging]

  - id: csharp-debug-write-sensitive
    pattern-either:
      - pattern: 'Debug.WriteLine($"...password...")'
      - pattern: 'Debug.WriteLine($"...secret...")'
      - pattern: 'Debug.WriteLine($"...token...")'
    message: "C# Debug.WriteLine may log sensitive data (CWE-532)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-532"
      tags: [logging]

  # ============================================
  # CSV Injection (DVTA Gap)
  # ============================================

  - id: csharp-csv-injection
    patterns:
      - pattern: $WRITER.WriteLine($DATA)
      - pattern: File.WriteAllText($PATH, $CSV)
      - pattern: File.AppendAllText($PATH, $CSV)
    message: "C# CSV output - sanitize data to prevent formula injection (CWE-1236)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-1236"
      tags: [csv-injection]

  - id: csharp-csv-formula-chars
    pattern-regex: '["=+\-@\|].*\.csv'
    message: "C# CSV with formula characters - potential CSV injection (CWE-1236)"
    languages: [csharp]
    severity: INFO
    metadata:
      cwe: "CWE-1236"
      tags: [csv-injection]

  # ============================================
  # DLL Hijacking (DVTA Gap)
  # ============================================

  - id: csharp-dllimport-no-path
    pattern: '[DllImport("$DLL")]'
    message: "C# DllImport without full path - DLL hijacking risk (CWE-427)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-427"
      tags: [dll-hijacking]

  - id: csharp-loadlibrary
    pattern: LoadLibrary($DLL)
    message: "C# LoadLibrary - potential DLL hijacking if path not validated (CWE-427)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-427"
      tags: [dll-hijacking]

  - id: csharp-assembly-loadfrom
    pattern: Assembly.LoadFrom($PATH)
    message: "C# Assembly.LoadFrom - DLL hijacking risk, use LoadFile with full path (CWE-427)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-427"
      tags: [dll-hijacking]

  - id: csharp-assembly-load
    pattern: Assembly.Load($NAME)
    message: "C# Assembly.Load - verify assembly binding to prevent hijacking (CWE-427)"
    languages: [csharp]
    severity: INFO
    metadata:
      cwe: "CWE-427"
      tags: [dll-hijacking]

  # ============================================
  # Cleartext Communication (DVTA Gap)
  # ============================================

  - id: csharp-http-url
    pattern-regex: '"http://[^"]*"'
    message: "C# HTTP URL detected - use HTTPS for secure communication (CWE-319)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-319"
      tags: [cleartext]

  - id: csharp-ftp-client
    pattern: new FtpClient($HOST)
    message: "C# FTP client - use SFTP/FTPS for secure file transfer (CWE-319)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-319"
      tags: [cleartext]

  - id: csharp-tcp-client-nossl
    pattern: new TcpClient($HOST, $PORT)
    message: "C# TcpClient - ensure SSL/TLS is used for sensitive data (CWE-319)"
    languages: [csharp]
    severity: INFO
    metadata:
      cwe: "CWE-319"
      tags: [cleartext]

  # ============================================
  # Insecure Storage (DVTA Gap)
  # ============================================

  - id: csharp-registry-password
    patterns:
      - pattern: 'Registry.SetValue($KEY, "password", $VALUE)'
      - pattern: 'Registry.SetValue($KEY, "secret", $VALUE)'
      - pattern: '$REG.SetValue("password", $VALUE)'
    message: "C# storing credentials in registry - use DPAPI or secure credential store (CWE-312)"
    languages: [csharp]
    severity: ERROR
    metadata:
      cwe: "CWE-312"
      tags: [insecure-storage]

  - id: csharp-file-write-credentials
    patterns:
      - pattern: File.WriteAllText($PATH, $PASSWORD)
      - pattern: '$WRITER.Write($PASSWORD)'
    message: "C# writing credentials to file - encrypt sensitive data (CWE-312)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-312"
      tags: [insecure-storage]

  - id: csharp-settings-password
    pattern: 'Properties.Settings.Default.$SETTING = $PASSWORD'
    message: "C# storing sensitive data in Settings - use secure storage (CWE-312)"
    languages: [csharp]
    severity: WARNING
    metadata:
      cwe: "CWE-312"
      tags: [insecure-storage]
