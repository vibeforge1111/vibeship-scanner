# JavaScript/TypeScript Security Rules
# Tags: core, react, vue, angular, nextjs, express, node, typescript
rules:
  # ============================================
  # Core: Code Injection (always run)
  # ============================================

  - id: js-eval-injection
    pattern: eval(...)
    message: Dangerous eval() call - potential code injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-new-function
    pattern: new Function(...)
    message: new Function() - potential code injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-settimeout-string
    pattern: 'setTimeout("...", ...)'
    message: setTimeout with string argument - code injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-setinterval-string
    pattern: 'setInterval("...", ...)'
    message: setInterval with string argument - code injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  # ============================================
  # Core: XSS (DOM manipulation)
  # ============================================

  - id: js-innerhtml-xss
    pattern: $X.innerHTML = $Y
    message: innerHTML assignment - potential XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-document-write
    pattern: document.write(...)
    message: document.write() usage - potential XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-outerhtml-xss
    pattern: $X.outerHTML = $Y
    message: outerHTML assignment - potential XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-insertadjacenthtml
    pattern: $X.insertAdjacentHTML(...)
    message: insertAdjacentHTML - potential XSS without sanitization
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  # ============================================
  # React XSS
  # ============================================

  - id: react-dangerously-set-inner-html
    pattern: dangerouslySetInnerHTML={...}
    message: React dangerouslySetInnerHTML - XSS risk without proper sanitization
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [react, xss]

  - id: react-href-javascript
    pattern: 'href={"javascript:$X"}'
    message: "React javascript: URL in href - XSS vulnerability"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [react, xss]

  - id: react-ref-innerhtml
    pattern: $REF.current.innerHTML = $X
    message: React ref innerHTML manipulation - XSS risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [react, xss]

  # ============================================
  # Vue.js XSS
  # ============================================

  - id: vue-v-html-directive
    pattern: 'v-html="$X"'
    message: Vue v-html directive bypasses sanitization - XSS risk with user input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [vue, xss]

  - id: vue-compile-dynamic
    pattern: Vue.compile($X)
    message: Dynamic Vue template compilation - potential XSS with user input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [vue, xss]

  - id: vue-render-raw
    pattern: "h('div', {innerHTML: $X})"
    message: Vue render function with innerHTML - XSS risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [vue, xss]

  # ============================================
  # Angular XSS
  # ============================================

  - id: angular-bypass-security-html
    pattern: bypassSecurityTrustHtml(...)
    message: Angular bypassSecurityTrustHtml - XSS risk without proper sanitization
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [angular, xss]

  - id: angular-bypass-security-script
    pattern: bypassSecurityTrustScript(...)
    message: Angular bypassSecurityTrustScript - XSS risk, avoid using
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [angular, xss]

  - id: angular-bypass-security-url
    pattern: bypassSecurityTrustUrl(...)
    message: Angular bypassSecurityTrustUrl - potential open redirect or XSS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [angular, xss]

  - id: angular-bypass-security-resource-url
    pattern: bypassSecurityTrustResourceUrl(...)
    message: Angular bypassSecurityTrustResourceUrl - potential XSS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [angular, xss]

  # ============================================
  # Next.js Specific
  # ============================================

  - id: nextjs-dangerouslysetinnerhtml-getserverside
    pattern: |
      export async function getServerSideProps(...) {
        ...
        return { props: { $HTML } }
      }
    message: Next.js SSR with HTML prop - ensure sanitized before dangerouslySetInnerHTML
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [nextjs, xss]

  - id: nextjs-api-sql-injection
    pattern: |
      export default async function handler(req, res) {
        ...
        $DB.query($Q + req.$X)
        ...
      }
    message: Next.js API route SQL injection - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [nextjs, injection]

  - id: nextjs-headers-exposed
    pattern: 'headers: { "Access-Control-Allow-Origin": "*" }'
    message: Next.js API with CORS wildcard - restrict origins in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [nextjs, config]

  - id: nextjs-middleware-bypass
    pattern: |
      if (req.nextUrl.pathname.startsWith($PATH)) {
        return NextResponse.next()
      }
    message: Next.js middleware - verify auth check isn't bypassed
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [nextjs, auth]

  # ============================================
  # SvelteKit Specific
  # ============================================

  - id: sveltekit-html-injection
    pattern: '{@html $X}'
    message: SvelteKit @html - XSS risk if content is user-controlled
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [svelte, xss]

  - id: sveltekit-load-user-data
    pattern: |
      export async function load({ params }) {
        ...
        return { $DATA: params.$X }
      }
    message: SvelteKit load with unvalidated params - validate before use
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [svelte, validation]

  - id: sveltekit-form-action-sqli
    pattern: |
      export const actions = {
        default: async ({ request }) => {
          ...
          $DB.query($Q + $FORM)
          ...
        }
      }
    message: SvelteKit form action SQL injection - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [svelte, injection]

  # ============================================
  # Node.js: Command Injection
  # ============================================

  - id: node-exec-call
    pattern: exec(...)
    message: Command execution detected - potential command injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  - id: node-execsync-call
    pattern: execSync(...)
    message: Synchronous command execution - potential command injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  - id: node-child-process-exec
    pattern: child_process.exec(...)
    message: child_process.exec() - potential command injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  - id: node-spawn-shell
    pattern: "spawn($CMD, $ARGS, {shell: true})"
    message: spawn with shell=true - command injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  # ============================================
  # Node.js: Path Traversal
  # ============================================

  - id: node-path-traversal-readfile
    pattern: fs.readFile(req.$X.$Y, ...)
    message: Reading file from user input - potential path traversal
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, path-traversal]

  - id: node-path-traversal-readfilesync
    pattern: fs.readFileSync(req.$X.$Y)
    message: Reading file from user input - potential path traversal
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, path-traversal]

  - id: node-path-join-user
    pattern: path.join($BASE, req.$X.$Y)
    message: path.join with user input - validate to prevent traversal
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [node, path-traversal]

  # ============================================
  # Express.js Security
  # ============================================

  - id: express-cors-wildcard
    pattern: 'cors({origin: "*"})'
    message: CORS allows all origins - restrict to specific domains in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, config]

  - id: express-cors-credentials-wildcard
    pattern: 'cors({origin: "*", credentials: true})'
    message: CORS wildcard with credentials - security risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, config]

  - id: express-session-hardcoded
    patterns:
      - pattern: 'session({secret: "..."})'
      - pattern: "session({secret: '...'})"
    message: Hardcoded session secret - use environment variable
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, secrets]

  - id: express-redirect-open
    pattern: res.redirect(req.$X.$Y)
    message: Redirect using user input - potential open redirect
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, redirect]

  - id: express-sql-injection
    pattern: '$DB.query("SELECT * FROM " + req.$X)'
    message: Express SQL injection via concatenation
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, injection]

  - id: express-nosql-injection-body
    pattern: '$COLL.find(req.body)'
    message: Express MongoDB with raw body - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, injection]

  - id: express-nosql-injection-query
    pattern: '$COLL.find(req.query)'
    message: Express MongoDB with raw query - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, injection]

  # ============================================
  # Core: Weak Cryptography
  # ============================================

  - id: js-weak-hash-md5
    pattern: 'crypto.createHash("md5")'
    message: MD5 is a weak hash function - use SHA-256 or better
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, crypto]

  - id: js-weak-hash-sha1
    pattern: 'crypto.createHash("sha1")'
    message: SHA1 is a weak hash function - use SHA-256 or better
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, crypto]

  - id: js-math-random
    pattern: Math.random()
    message: Math.random() is not cryptographically secure - use crypto.randomBytes()
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [core, crypto]

  - id: js-weak-cipher-des
    pattern: 'crypto.createCipheriv("des", ...)'
    message: DES is a weak cipher - use AES-256-GCM instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-weak-cipher-rc4
    pattern: 'crypto.createCipheriv("rc4", ...)'
    message: RC4 is a broken cipher - use AES-256-GCM instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-weak-cipher-ecb-mode
    pattern-regex: "createCipheriv\\([\"']aes[^\"]*-ecb[\"']"
    message: ECB mode is insecure - use GCM or CBC with proper IV
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-static-iv
    patterns:
      - pattern: 'createCipheriv($ALG, $KEY, "...")'
      - pattern: "createCipheriv($ALG, $KEY, '...')"
    message: Static IV in encryption - IV should be random for each encryption
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-crypto-createcipher-deprecated
    pattern: crypto.createCipher(...)
    message: crypto.createCipher is deprecated - use createCipheriv with random IV
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  # ============================================
  # Core: TLS/SSL Issues
  # ============================================

  - id: js-tls-reject-unauthorized
    pattern: rejectUnauthorized = false
    message: TLS certificate verification disabled - MITM attack risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, tls]

  - id: js-node-tls-reject-env
    pattern: 'process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0"'
    message: TLS verification disabled globally - MITM attack risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, tls]

  # ============================================
  # Core: JWT Security
  # ============================================

  - id: js-jwt-none-algorithm
    pattern: '"alg":"none"'
    message: JWT none algorithm - authentication bypass vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  - id: js-jwt-hardcoded-secret
    pattern: 'jwt.sign($PAYLOAD, "...")'
    message: Hardcoded JWT secret - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  - id: js-jwt-verify-hardcoded
    pattern: 'jwt.verify($TOKEN, "...")'
    message: Hardcoded JWT secret - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  - id: js-jwt-verify-disabled
    pattern: 'verify: false'
    message: JWT verification disabled - tokens will not be validated
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  # ============================================
  # Core: SQL/NoSQL Injection
  # ============================================

  - id: js-prisma-queryraw-unsafe
    pattern: prisma.$queryRawUnsafe($QUERY)
    message: Prisma unsafe raw query - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-prisma-executeraw-unsafe
    pattern: prisma.$executeRawUnsafe($QUERY)
    message: Prisma unsafe raw execute - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-sequelize-query-raw
    pattern: sequelize.query($Q, ...)
    message: Raw SQL query - potential injection if not parameterized
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, injection]

  - id: js-knex-raw
    pattern: knex.raw($QUERY)
    message: Knex raw query - potential SQL injection
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, injection]

  - id: js-mongodb-where
    pattern: '$COLL.find({$where: $FUNC})'
    message: MongoDB $where operator - code injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-drizzle-raw
    pattern: sql.raw($QUERY)
    message: Drizzle raw SQL - injection risk if query contains user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, injection]

  # ============================================
  # Core: SSRF
  # ============================================

  - id: js-fetch-user-input
    pattern: fetch(req.$X.$Y)
    message: Fetch with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: js-axios-user-input
    pattern: axios.get(req.$X.$Y)
    message: Axios GET with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: js-axios-post-user-input
    pattern: axios.post(req.$X.$Y, ...)
    message: Axios POST with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  # ============================================
  # Core: Prototype Pollution
  # ============================================

  - id: js-lodash-merge
    pattern: '_.merge($TARGET, $SRC)'
    message: lodash merge can cause prototype pollution with user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-lodash-defaultsdeep
    pattern: '_.defaultsDeep($TARGET, $SRC)'
    message: lodash defaultsDeep can cause prototype pollution with user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-object-assign-user
    pattern: Object.assign($TARGET, req.$X)
    message: Object.assign with user input - prototype pollution risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  # ============================================
  # Core: Authentication
  # ============================================

  - id: js-password-comparison
    pattern: password === $VAR
    message: Plaintext password comparison - use bcrypt.compare() instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, auth]

  - id: js-timing-attack-comparison
    pattern: $SECRET === req.$X
    message: String comparison may be vulnerable to timing attacks - use crypto.timingSafeEqual
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, auth]

  # ============================================
  # Core: ReDoS
  # ============================================

  - id: js-dynamic-regex
    pattern: new RegExp($PATTERN)
    message: Dynamic regex with user input - potential ReDoS vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, redos]

  # ============================================
  # TypeScript Specific
  # ============================================

  - id: ts-any-type
    pattern: ': any'
    message: TypeScript any type bypasses type safety - consider strict typing
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-type-assertion-any
    pattern: 'as any'
    message: Type assertion to any - bypasses type checking
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-non-null-assertion
    pattern: $X!
    message: Non-null assertion - may cause runtime errors if value is null
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-ts-ignore
    pattern: '// @ts-ignore'
    message: "'@ts-ignore suppresses TypeScript errors - review carefully'"
    languages: [typescript]
    severity: WARNING
    metadata:
      tags: [typescript, type-safety]

  - id: ts-ts-expect-error
    pattern: '// @ts-expect-error'
    message: "'@ts-expect-error suppresses TypeScript errors - ensure intentional'"
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-unsafe-type-assertion
    pattern: '$X as unknown as $Y'
    message: Double type assertion bypasses type safety entirely
    languages: [typescript]
    severity: WARNING
    metadata:
      tags: [typescript, type-safety]

  # ============================================
  # Supabase/Firebase (common with vibe coders)
  # ============================================

  - id: supabase-service-role-client
    pattern: 'createClient($URL, $SERVICE_ROLE_KEY)'
    message: Supabase service role key in client - should only be used server-side
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [supabase, secrets]

  - id: supabase-rls-bypass
    pattern: '.from($TABLE).select().eq($COL, $VAL)'
    message: Supabase query - ensure RLS policies are enabled for security
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [supabase, auth]

  - id: firebase-admin-client
    pattern: 'admin.initializeApp({credential: admin.credential.cert($KEY)})'
    message: Firebase Admin SDK - ensure credentials are not exposed client-side
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [firebase, secrets]

  - id: firebase-security-rules-disabled
    pattern: '.write": true'
    message: Firebase security rules allow all writes - restrict in production
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [firebase, config]

  # ============================================
  # API Key Exposure
  # ============================================

  - id: js-hardcoded-api-key
    pattern-regex: "(api[_-]?key|apikey)\\s*[=:]\\s*['\"][a-zA-Z0-9]{20,}['\"]"
    message: Hardcoded API key detected - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  - id: js-hardcoded-secret
    pattern-regex: "(secret|password|token)\\s*[=:]\\s*['\"][^'\"]{8,}['\"]"
    message: Hardcoded secret detected - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  # ============================================
  # SQL Injection - Node.js/Express/Sequelize
  # ============================================

  - id: node-sql-string-concat
    patterns:
      - pattern: $DB.query($Q + $INPUT)
      - pattern: $DB.query($Q + req.$X)
      - pattern: $DB.query(`${...}`)
      - pattern: 'connection.query($Q + $INPUT)'
      - pattern: 'connection.query(`${...}`)'
    message: SQL injection - string concatenation in query. Use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sequelize-raw-query
    patterns:
      - pattern: 'sequelize.query($Q + $INPUT)'
      - pattern: 'sequelize.query(`${...}`)'
      - pattern: '$MODEL.sequelize.query($Q + $INPUT)'
    message: Sequelize raw query with string interpolation - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sequelize, injection, sql]

  - id: sequelize-literal-unsafe
    patterns:
      - pattern: 'Sequelize.literal($INPUT)'
      - pattern: 'sequelize.literal($INPUT)'
    message: Sequelize.literal with user input - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sequelize, injection, sql]

  - id: knex-raw-unsafe
    patterns:
      - pattern: 'knex.raw($Q + $INPUT)'
      - pattern: 'knex.raw(`${...}`)'
      - pattern: '$DB.raw($Q + $INPUT)'
    message: Knex raw query with interpolation - use bindings instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [knex, injection, sql]

  - id: mysql-query-unsafe
    patterns:
      - pattern: 'mysql.query($Q + $INPUT)'
      - pattern: 'mysql.query(`${...}`)'
      - pattern: 'pool.query($Q + $INPUT)'
      - pattern: 'pool.query(`${...}`)'
    message: MySQL query with string concatenation - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mysql, injection, sql]

  - id: pg-query-unsafe
    patterns:
      - pattern: 'client.query($Q + $INPUT)'
      - pattern: 'client.query(`${...}`)'
      - pattern: 'pool.query($Q + $INPUT)'
      - pattern: 'pool.query(`${...}`)'
    message: PostgreSQL query with string interpolation - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [postgres, injection, sql]

  # ============================================
  # XSS - Cross-Site Scripting
  # ============================================

  - id: js-innerhtml-xss
    patterns:
      - pattern: '$EL.innerHTML = $INPUT'
      - pattern: 'document.getElementById($ID).innerHTML = $INPUT'
      - pattern: '$EL.outerHTML = $INPUT'
    message: innerHTML assignment - potential XSS if input is user-controlled
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-document-write-xss
    patterns:
      - pattern: 'document.write($INPUT)'
      - pattern: 'document.writeln($INPUT)'
    message: document.write with dynamic content - XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-insertadjacenthtml-xss
    pattern: '$EL.insertAdjacentHTML($POS, $INPUT)'
    message: insertAdjacentHTML - XSS risk if input is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, xss]

  - id: express-res-send-unsanitized
    patterns:
      - pattern: 'res.send(req.$PARAM)'
      - pattern: 'res.send($INPUT + req.$PARAM)'
    message: Express response reflects user input - potential reflected XSS
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, xss]

  - id: express-res-render-unsanitized
    pattern: 'res.render($TEMPLATE, {$KEY: req.$PARAM})'
    message: User input passed to template - ensure template escapes output
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, xss]

  - id: jquery-html-xss
    patterns:
      - pattern: '$($SEL).html($INPUT)'
      - pattern: '$.html($INPUT)'
    message: jQuery .html() with dynamic content - XSS risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [jquery, xss]

  - id: jquery-append-xss
    patterns:
      - pattern: '$($SEL).append($INPUT)'
      - pattern: '$($SEL).prepend($INPUT)'
      - pattern: '$($SEL).after($INPUT)'
      - pattern: '$($SEL).before($INPUT)'
    message: jQuery DOM insertion with dynamic content - XSS risk if unsanitized
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [jquery, xss]

  # ============================================
  # NoSQL Injection
  # ============================================

  - id: mongodb-nosql-injection
    patterns:
      - pattern: '$COLLECTION.find({$FIELD: req.$PARAM})'
      - pattern: '$COLLECTION.findOne({$FIELD: req.$PARAM})'
      - pattern: '$COLLECTION.findOneAndUpdate({$FIELD: req.$PARAM}, ...)'
      - pattern: '$COLLECTION.deleteOne({$FIELD: req.$PARAM})'
      - pattern: '$COLLECTION.updateOne({$FIELD: req.$PARAM}, ...)'
    message: MongoDB query with direct user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongodb-where-injection
    patterns:
      - pattern: '$COLLECTION.find({$where: $INPUT})'
      - pattern: '$MODEL.find({$where: $INPUT})'
    message: MongoDB $where with user input - code injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongoose-unsafe-query
    patterns:
      - pattern: '$MODEL.find(req.$PARAM)'
      - pattern: '$MODEL.findOne(req.$PARAM)'
      - pattern: '$MODEL.findById(req.$PARAM.$FIELD)'
    message: Mongoose query with unvalidated user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [mongoose, injection, nosql]

  # ============================================
  # SSRF - Server-Side Request Forgery
  # ============================================

  - id: node-ssrf-fetch
    patterns:
      - pattern: 'fetch(req.$PARAM)'
      - pattern: 'fetch($URL + req.$PARAM)'
      - pattern: 'fetch(`${...}${req.$PARAM}...`)'
    message: Server-side fetch with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: node-ssrf-axios
    patterns:
      - pattern: 'axios.get(req.$PARAM)'
      - pattern: 'axios.get($URL + req.$PARAM)'
      - pattern: 'axios.post(req.$PARAM, ...)'
      - pattern: 'axios({url: req.$PARAM})'
    message: Axios request with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [axios, ssrf]

  - id: node-ssrf-request
    patterns:
      - pattern: 'request(req.$PARAM)'
      - pattern: 'request.get(req.$PARAM)'
      - pattern: 'request({url: req.$PARAM})'
    message: HTTP request with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: node-ssrf-http
    patterns:
      - pattern: 'http.get(req.$PARAM, ...)'
      - pattern: 'https.get(req.$PARAM, ...)'
      - pattern: 'http.request({host: req.$PARAM}, ...)'
    message: Native HTTP request with user input - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  # ============================================
  # Path Traversal
  # ============================================

  - id: node-path-traversal
    patterns:
      - pattern: 'fs.readFile($PATH + req.$PARAM, ...)'
      - pattern: 'fs.readFileSync($PATH + req.$PARAM)'
      - pattern: 'fs.readFile(`${...}${req.$PARAM}...`, ...)'
      - pattern: 'path.join($BASE, req.$PARAM)'
    message: Path traversal - user input in file path without validation
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, path-traversal]

  - id: express-sendfile-traversal
    patterns:
      - pattern: 'res.sendFile(req.$PARAM)'
      - pattern: 'res.sendFile($PATH + req.$PARAM)'
      - pattern: 'res.download(req.$PARAM)'
    message: Express file send with user input - path traversal risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, path-traversal]

  - id: node-fs-unvalidated
    patterns:
      - pattern: 'fs.writeFile(req.$PARAM, ...)'
      - pattern: 'fs.unlink(req.$PARAM, ...)'
      - pattern: 'fs.rmdir(req.$PARAM, ...)'
      - pattern: 'fs.mkdir(req.$PARAM, ...)'
    message: File system operation with user-controlled path - validate input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, path-traversal]

  # ============================================
  # XXE - XML External Entity
  # ============================================

  - id: node-xxe-xml2js
    pattern: 'xml2js.parseString($INPUT, ...)'
    message: XML parsing - ensure external entities are disabled to prevent XXE
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  - id: node-xxe-libxmljs
    patterns:
      - pattern: 'libxmljs.parseXml($INPUT)'
      - pattern: 'libxmljs.parseXmlString($INPUT)'
    message: libxmljs XML parsing - disable external entities to prevent XXE
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  - id: node-xxe-domparser
    pattern: 'new DOMParser().parseFromString($INPUT, ...)'
    message: DOMParser XML parsing - potential XXE if processing untrusted XML
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: node-unsafe-deserialize
    patterns:
      - pattern: 'serialize.unserialize($INPUT)'
      - pattern: 'node-serialize.unserialize($INPUT)'
    message: Unsafe deserialization - can lead to remote code execution
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, deserialization]

  - id: node-json-parse-uncaught
    pattern: 'JSON.parse(req.$PARAM)'
    message: JSON.parse on user input without try-catch - may crash on invalid JSON
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, error-handling]

  # ============================================
  # IDOR - Insecure Direct Object Reference
  # ============================================

  - id: express-idor-param
    patterns:
      - pattern: '$MODEL.findById(req.params.$ID)'
      - pattern: '$MODEL.findByPk(req.params.$ID)'
      - pattern: '$DB.find({id: req.params.$ID})'
    message: Direct object access using URL parameter - verify user authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, idor, authz]

  # ============================================
  # Authentication/Session Issues
  # ============================================

  - id: express-session-insecure
    patterns:
      - pattern: 'session({secret: $SECRET, cookie: {secure: false}})'
      - pattern: 'session({cookie: {httpOnly: false}})'
    message: Insecure session configuration - enable secure and httpOnly
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, session, auth]

  - id: jwt-none-algorithm
    patterns:
      - pattern: 'jwt.verify($TOKEN, $SECRET, {algorithms: ["none"]})'
      - pattern: 'jwt.decode($TOKEN)'
    message: JWT with none algorithm or decode without verify - authentication bypass
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [jwt, auth]

  - id: bcrypt-low-rounds
    pattern: 'bcrypt.hash($PASS, $ROUNDS)'
    message: Verify bcrypt salt rounds - should be at least 10 for security
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [crypto, auth]

  # ============================================
  # CORS Misconfiguration
  # ============================================

  - id: express-cors-wildcard
    patterns:
      - pattern: "cors({origin: '*'})"
      - pattern: "cors({origin: true})"
      - pattern: 'res.setHeader("Access-Control-Allow-Origin", "*")'
    message: CORS allows all origins - restrict to trusted domains in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, cors]

  - id: express-cors-credentials-wildcard
    pattern: "cors({origin: '*', credentials: true})"
    message: CORS wildcard with credentials - security misconfiguration
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, cors]

  # ============================================
  # Prototype Pollution
  # ============================================

  - id: js-prototype-pollution
    patterns:
      - pattern: '$OBJ[req.$PARAM] = $VALUE'
      - pattern: '$OBJ[$KEY][req.$PARAM] = $VALUE'
      - pattern: 'Object.assign($TARGET, req.$PARAM)'
      - pattern: '_.merge($TARGET, req.$PARAM)'
      - pattern: '_.extend($TARGET, req.$PARAM)'
    message: Potential prototype pollution - validate property names
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, prototype-pollution]

  # ============================================
  # Missing Security Headers
  # ============================================

  - id: express-no-helmet
    pattern: 'express()'
    message: Express app - consider using helmet() for security headers
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [express, headers]

