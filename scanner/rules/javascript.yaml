# JavaScript/TypeScript Security Rules
# Tags: core, react, vue, angular, nextjs, express, node, typescript
rules:
  # ============================================
  # Core: Code Injection (always run)
  # ============================================

  - id: js-eval-injection
    pattern: eval(...)
    message: Dangerous eval() call - potential code injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-new-function
    pattern: new Function(...)
    message: new Function() - potential code injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-settimeout-string
    pattern: 'setTimeout("...", ...)'
    message: setTimeout with string argument - code injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-setinterval-string
    pattern: 'setInterval("...", ...)'
    message: setInterval with string argument - code injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  # ============================================
  # Core: XSS (DOM manipulation)
  # ============================================

  - id: js-innerhtml-xss
    pattern: $X.innerHTML = $Y
    message: innerHTML assignment - potential XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-document-write
    pattern: document.write(...)
    message: document.write() usage - potential XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-outerhtml-xss
    pattern: $X.outerHTML = $Y
    message: outerHTML assignment - potential XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-insertadjacenthtml
    pattern: $X.insertAdjacentHTML(...)
    message: insertAdjacentHTML - potential XSS without sanitization
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  # ============================================
  # React XSS
  # ============================================

  - id: react-dangerously-set-inner-html
    pattern: dangerouslySetInnerHTML={...}
    message: React dangerouslySetInnerHTML - XSS risk without proper sanitization
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [react, xss]

  - id: react-href-javascript
    pattern: 'href={"javascript:$X"}'
    message: "React javascript: URL in href - XSS vulnerability"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [react, xss]

  - id: react-ref-innerhtml
    pattern: $REF.current.innerHTML = $X
    message: React ref innerHTML manipulation - XSS risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [react, xss]

  # ============================================
  # Vue.js XSS
  # ============================================

  - id: vue-v-html-directive
    pattern: 'v-html="$X"'
    message: Vue v-html directive bypasses sanitization - XSS risk with user input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [vue, xss]

  - id: vue-compile-dynamic
    pattern: Vue.compile($X)
    message: Dynamic Vue template compilation - potential XSS with user input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [vue, xss]

  - id: vue-render-raw
    pattern: "h('div', {innerHTML: $X})"
    message: Vue render function with innerHTML - XSS risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [vue, xss]

  # ============================================
  # Angular XSS
  # ============================================

  - id: angular-bypass-security-html
    pattern: bypassSecurityTrustHtml(...)
    message: Angular bypassSecurityTrustHtml - XSS risk without proper sanitization
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [angular, xss]

  - id: angular-bypass-security-script
    pattern: bypassSecurityTrustScript(...)
    message: Angular bypassSecurityTrustScript - XSS risk, avoid using
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [angular, xss]

  - id: angular-bypass-security-url
    pattern: bypassSecurityTrustUrl(...)
    message: Angular bypassSecurityTrustUrl - potential open redirect or XSS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [angular, xss]

  - id: angular-bypass-security-resource-url
    pattern: bypassSecurityTrustResourceUrl(...)
    message: Angular bypassSecurityTrustResourceUrl - potential XSS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [angular, xss]

  # ============================================
  # Next.js Specific
  # ============================================

  - id: nextjs-dangerouslysetinnerhtml-getserverside
    pattern: |
      export async function getServerSideProps(...) {
        ...
        return { props: { $HTML } }
      }
    message: Next.js SSR with HTML prop - ensure sanitized before dangerouslySetInnerHTML
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [nextjs, xss]

  - id: nextjs-api-sql-injection
    pattern: |
      export default async function handler(req, res) {
        ...
        $DB.query($Q + req.$X)
        ...
      }
    message: Next.js API route SQL injection - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [nextjs, injection]

  - id: nextjs-headers-exposed
    pattern: 'headers: { "Access-Control-Allow-Origin": "*" }'
    message: Next.js API with CORS wildcard - restrict origins in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [nextjs, config]

  - id: nextjs-middleware-bypass
    pattern: |
      if (req.nextUrl.pathname.startsWith($PATH)) {
        return NextResponse.next()
      }
    message: Next.js middleware - verify auth check isn't bypassed
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [nextjs, auth]

  # ============================================
  # SvelteKit Specific
  # ============================================

  - id: sveltekit-html-injection
    pattern: '{@html $X}'
    message: SvelteKit @html - XSS risk if content is user-controlled
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [svelte, xss]

  - id: sveltekit-load-user-data
    pattern: |
      export async function load({ params }) {
        ...
        return { $DATA: params.$X }
      }
    message: SvelteKit load with unvalidated params - validate before use
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [svelte, validation]

  - id: sveltekit-form-action-sqli
    pattern: |
      export const actions = {
        default: async ({ request }) => {
          ...
          $DB.query($Q + $FORM)
          ...
        }
      }
    message: SvelteKit form action SQL injection - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [svelte, injection]

  # ============================================
  # Node.js: Command Injection
  # ============================================

  - id: node-exec-call
    pattern: exec(...)
    message: Command execution detected - potential command injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  - id: node-execsync-call
    pattern: execSync(...)
    message: Synchronous command execution - potential command injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  - id: node-child-process-exec
    pattern: child_process.exec(...)
    message: child_process.exec() - potential command injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  - id: node-spawn-shell
    pattern: "spawn($CMD, $ARGS, {shell: true})"
    message: spawn with shell=true - command injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  # ============================================
  # Node.js: Path Traversal
  # ============================================

  - id: node-path-traversal-readfile
    pattern: fs.readFile(req.$X.$Y, ...)
    message: Reading file from user input - potential path traversal
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, path-traversal]

  - id: node-path-traversal-readfilesync
    pattern: fs.readFileSync(req.$X.$Y)
    message: Reading file from user input - potential path traversal
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, path-traversal]

  - id: node-path-join-user
    pattern: path.join($BASE, req.$X.$Y)
    message: path.join with user input - validate to prevent traversal
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [node, path-traversal]

  # ============================================
  # Express.js Security
  # ============================================

  - id: express-cors-wildcard
    pattern: 'cors({origin: "*"})'
    message: CORS allows all origins - restrict to specific domains in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, config]

  - id: express-cors-credentials-wildcard
    pattern: 'cors({origin: "*", credentials: true})'
    message: CORS wildcard with credentials - security risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, config]

  - id: express-session-hardcoded
    patterns:
      - pattern: 'session({secret: "..."})'
      - pattern: "session({secret: '...'})"
    message: Hardcoded session secret - use environment variable
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, secrets]

  - id: express-redirect-open
    pattern: res.redirect(req.$X.$Y)
    message: Redirect using user input - potential open redirect
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, redirect]

  - id: express-sql-injection
    pattern: '$DB.query("SELECT * FROM " + req.$X)'
    message: Express SQL injection via concatenation
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, injection]

  - id: express-nosql-injection-body
    pattern: '$COLL.find(req.body)'
    message: Express MongoDB with raw body - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, injection]

  - id: express-nosql-injection-query
    pattern: '$COLL.find(req.query)'
    message: Express MongoDB with raw query - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, injection]

  # ============================================
  # Core: Weak Cryptography
  # ============================================

  - id: js-weak-hash-md5
    pattern: 'crypto.createHash("md5")'
    message: MD5 is a weak hash function - use SHA-256 or better
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, crypto]

  - id: js-weak-hash-sha1
    pattern: 'crypto.createHash("sha1")'
    message: SHA1 is a weak hash function - use SHA-256 or better
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, crypto]

  - id: js-math-random
    pattern: Math.random()
    message: Math.random() is not cryptographically secure - use crypto.randomBytes()
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [core, crypto]

  - id: js-weak-cipher-des
    pattern: 'crypto.createCipheriv("des", ...)'
    message: DES is a weak cipher - use AES-256-GCM instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-weak-cipher-rc4
    pattern: 'crypto.createCipheriv("rc4", ...)'
    message: RC4 is a broken cipher - use AES-256-GCM instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-weak-cipher-ecb-mode
    pattern-regex: "createCipheriv\\([\"']aes[^\"]*-ecb[\"']"
    message: ECB mode is insecure - use GCM or CBC with proper IV
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-static-iv
    patterns:
      - pattern: 'createCipheriv($ALG, $KEY, "...")'
      - pattern: "createCipheriv($ALG, $KEY, '...')"
    message: Static IV in encryption - IV should be random for each encryption
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-crypto-createcipher-deprecated
    pattern: crypto.createCipher(...)
    message: crypto.createCipher is deprecated - use createCipheriv with random IV
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  # ============================================
  # Core: TLS/SSL Issues
  # ============================================

  - id: js-tls-reject-unauthorized
    pattern: rejectUnauthorized = false
    message: TLS certificate verification disabled - MITM attack risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, tls]

  - id: js-node-tls-reject-env
    pattern: 'process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0"'
    message: TLS verification disabled globally - MITM attack risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, tls]

  # ============================================
  # Core: JWT Security
  # ============================================

  - id: js-jwt-none-algorithm
    pattern: '"alg":"none"'
    message: JWT none algorithm - authentication bypass vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  - id: js-jwt-hardcoded-secret
    pattern: 'jwt.sign($PAYLOAD, "...")'
    message: Hardcoded JWT secret - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  - id: js-jwt-verify-hardcoded
    pattern: 'jwt.verify($TOKEN, "...")'
    message: Hardcoded JWT secret - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  - id: js-jwt-verify-disabled
    pattern: 'verify: false'
    message: JWT verification disabled - tokens will not be validated
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  # ============================================
  # Core: SQL/NoSQL Injection
  # ============================================

  - id: js-prisma-queryraw-unsafe
    pattern: prisma.$queryRawUnsafe($QUERY)
    message: Prisma unsafe raw query - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-prisma-executeraw-unsafe
    pattern: prisma.$executeRawUnsafe($QUERY)
    message: Prisma unsafe raw execute - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-sequelize-query-raw
    pattern: sequelize.query($Q, ...)
    message: Raw SQL query - potential injection if not parameterized
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, injection]

  - id: js-knex-raw
    pattern: knex.raw($QUERY)
    message: Knex raw query - potential SQL injection
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, injection]

  - id: js-mongodb-where
    pattern: '$COLL.find({$where: $FUNC})'
    message: MongoDB $where operator - code injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-drizzle-raw
    pattern: sql.raw($QUERY)
    message: Drizzle raw SQL - injection risk if query contains user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, injection]

  # ============================================
  # Core: SSRF
  # ============================================

  - id: js-fetch-user-input
    pattern: fetch(req.$X.$Y)
    message: Fetch with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: js-axios-user-input
    pattern: axios.get(req.$X.$Y)
    message: Axios GET with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: js-axios-post-user-input
    pattern: axios.post(req.$X.$Y, ...)
    message: Axios POST with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  # ============================================
  # Core: Prototype Pollution
  # ============================================

  - id: js-lodash-merge
    pattern: '_.merge($TARGET, $SRC)'
    message: lodash merge can cause prototype pollution with user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-lodash-defaultsdeep
    pattern: '_.defaultsDeep($TARGET, $SRC)'
    message: lodash defaultsDeep can cause prototype pollution with user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-object-assign-user
    pattern: Object.assign($TARGET, req.$X)
    message: Object.assign with user input - prototype pollution risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  # ============================================
  # Core: Authentication
  # ============================================

  - id: js-password-comparison
    pattern: password === $VAR
    message: Plaintext password comparison - use bcrypt.compare() instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, auth]

  - id: js-timing-attack-comparison
    pattern: $SECRET === req.$X
    message: String comparison may be vulnerable to timing attacks - use crypto.timingSafeEqual
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, auth]

  # ============================================
  # Core: ReDoS
  # ============================================

  - id: js-dynamic-regex
    pattern: new RegExp($PATTERN)
    message: Dynamic regex with user input - potential ReDoS vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, redos]

  # ============================================
  # TypeScript Specific
  # ============================================

  - id: ts-any-type
    pattern: ': any'
    message: TypeScript any type bypasses type safety - consider strict typing
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-type-assertion-any
    pattern: 'as any'
    message: Type assertion to any - bypasses type checking
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-non-null-assertion
    pattern: $X!
    message: Non-null assertion - may cause runtime errors if value is null
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-ts-ignore
    pattern: '// @ts-ignore'
    message: "'@ts-ignore suppresses TypeScript errors - review carefully'"
    languages: [typescript]
    severity: WARNING
    metadata:
      tags: [typescript, type-safety]

  - id: ts-ts-expect-error
    pattern: '// @ts-expect-error'
    message: "'@ts-expect-error suppresses TypeScript errors - ensure intentional'"
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-unsafe-type-assertion
    pattern: '$X as unknown as $Y'
    message: Double type assertion bypasses type safety entirely
    languages: [typescript]
    severity: WARNING
    metadata:
      tags: [typescript, type-safety]

  # ============================================
  # Supabase/Firebase (common with vibe coders)
  # ============================================

  - id: supabase-service-role-client
    pattern: 'createClient($URL, $SERVICE_ROLE_KEY)'
    message: Supabase service role key in client - should only be used server-side
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [supabase, secrets]

  - id: supabase-rls-bypass
    pattern: '.from($TABLE).select().eq($COL, $VAL)'
    message: Supabase query - ensure RLS policies are enabled for security
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [supabase, auth]

  - id: firebase-admin-client
    pattern: 'admin.initializeApp({credential: admin.credential.cert($KEY)})'
    message: Firebase Admin SDK - ensure credentials are not exposed client-side
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [firebase, secrets]

  - id: firebase-security-rules-disabled
    pattern: '.write": true'
    message: Firebase security rules allow all writes - restrict in production
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [firebase, config]

  # ============================================
  # API Key Exposure
  # ============================================

  - id: js-hardcoded-api-key
    pattern-regex: "(api[_-]?key|apikey)\\s*[=:]\\s*['\"][a-zA-Z0-9]{20,}['\"]"
    message: Hardcoded API key detected - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  - id: js-hardcoded-secret
    pattern-regex: "(secret|password|token)\\s*[=:]\\s*['\"][^'\"]{8,}['\"]"
    message: Hardcoded secret detected - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  # ============================================
  # SQL Injection - Node.js/Express/Sequelize
  # ============================================

  - id: node-sql-string-concat
    patterns:
      - pattern: $DB.query($Q + $INPUT)
      - pattern: $DB.query($Q + req.$X)
      - pattern: $DB.query(`${...}`)
      - pattern: 'connection.query($Q + $INPUT)'
      - pattern: 'connection.query(`${...}`)'
    message: SQL injection - string concatenation in query. Use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sequelize-raw-query
    patterns:
      - pattern: 'sequelize.query($Q + $INPUT)'
      - pattern: 'sequelize.query(`${...}`)'
      - pattern: '$MODEL.sequelize.query($Q + $INPUT)'
    message: Sequelize raw query with string interpolation - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sequelize, injection, sql]

  - id: sequelize-literal-unsafe
    patterns:
      - pattern: 'Sequelize.literal($INPUT)'
      - pattern: 'sequelize.literal($INPUT)'
    message: Sequelize.literal with user input - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sequelize, injection, sql]

  - id: knex-raw-unsafe
    patterns:
      - pattern: 'knex.raw($Q + $INPUT)'
      - pattern: 'knex.raw(`${...}`)'
      - pattern: '$DB.raw($Q + $INPUT)'
    message: Knex raw query with interpolation - use bindings instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [knex, injection, sql]

  - id: mysql-query-unsafe
    patterns:
      - pattern: 'mysql.query($Q + $INPUT)'
      - pattern: 'mysql.query(`${...}`)'
      - pattern: 'pool.query($Q + $INPUT)'
      - pattern: 'pool.query(`${...}`)'
    message: MySQL query with string concatenation - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mysql, injection, sql]

  - id: pg-query-unsafe
    patterns:
      - pattern: 'client.query($Q + $INPUT)'
      - pattern: 'client.query(`${...}`)'
      - pattern: 'pool.query($Q + $INPUT)'
      - pattern: 'pool.query(`${...}`)'
    message: PostgreSQL query with string interpolation - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [postgres, injection, sql]

  # ============================================
  # XSS - Cross-Site Scripting
  # ============================================

  - id: js-innerhtml-xss
    patterns:
      - pattern: '$EL.innerHTML = $INPUT'
      - pattern: 'document.getElementById($ID).innerHTML = $INPUT'
      - pattern: '$EL.outerHTML = $INPUT'
    message: innerHTML assignment - potential XSS if input is user-controlled
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-document-write-xss
    patterns:
      - pattern: 'document.write($INPUT)'
      - pattern: 'document.writeln($INPUT)'
    message: document.write with dynamic content - XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-insertadjacenthtml-xss
    pattern: '$EL.insertAdjacentHTML($POS, $INPUT)'
    message: insertAdjacentHTML - XSS risk if input is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, xss]

  - id: express-res-send-unsanitized
    patterns:
      - pattern: 'res.send(req.$PARAM)'
      - pattern: 'res.send($INPUT + req.$PARAM)'
    message: Express response reflects user input - potential reflected XSS
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, xss]

  - id: express-res-render-unsanitized
    pattern: 'res.render($TEMPLATE, {$KEY: req.$PARAM})'
    message: User input passed to template - ensure template escapes output
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, xss]

  - id: jquery-html-xss
    patterns:
      - pattern: '$($SEL).html($INPUT)'
      - pattern: '$.html($INPUT)'
    message: jQuery .html() with dynamic content - XSS risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [jquery, xss]

  - id: jquery-append-xss
    patterns:
      - pattern: '$($SEL).append($INPUT)'
      - pattern: '$($SEL).prepend($INPUT)'
      - pattern: '$($SEL).after($INPUT)'
      - pattern: '$($SEL).before($INPUT)'
    message: jQuery DOM insertion with dynamic content - XSS risk if unsanitized
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [jquery, xss]

  # ============================================
  # NoSQL Injection
  # ============================================

  - id: mongodb-nosql-injection
    patterns:
      - pattern: '$COLLECTION.find({$FIELD: req.$PARAM})'
      - pattern: '$COLLECTION.findOne({$FIELD: req.$PARAM})'
      - pattern: '$COLLECTION.findOneAndUpdate({$FIELD: req.$PARAM}, ...)'
      - pattern: '$COLLECTION.deleteOne({$FIELD: req.$PARAM})'
      - pattern: '$COLLECTION.updateOne({$FIELD: req.$PARAM}, ...)'
    message: MongoDB query with direct user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongodb-where-injection
    patterns:
      - pattern: '$COLLECTION.find({$where: $INPUT})'
      - pattern: '$MODEL.find({$where: $INPUT})'
    message: MongoDB $where with user input - code injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongoose-unsafe-query
    patterns:
      - pattern: '$MODEL.find(req.$PARAM)'
      - pattern: '$MODEL.findOne(req.$PARAM)'
      - pattern: '$MODEL.findById(req.$PARAM.$FIELD)'
    message: Mongoose query with unvalidated user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [mongoose, injection, nosql]

  # ============================================
  # SSRF - Server-Side Request Forgery
  # ============================================

  - id: node-ssrf-fetch
    patterns:
      - pattern: 'fetch(req.$PARAM)'
      - pattern: 'fetch($URL + req.$PARAM)'
      - pattern: 'fetch(`${...}${req.$PARAM}...`)'
    message: Server-side fetch with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: node-ssrf-axios
    patterns:
      - pattern: 'axios.get(req.$PARAM)'
      - pattern: 'axios.get($URL + req.$PARAM)'
      - pattern: 'axios.post(req.$PARAM, ...)'
      - pattern: 'axios({url: req.$PARAM})'
    message: Axios request with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [axios, ssrf]

  - id: node-ssrf-request
    patterns:
      - pattern: 'request(req.$PARAM)'
      - pattern: 'request.get(req.$PARAM)'
      - pattern: 'request({url: req.$PARAM})'
    message: HTTP request with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: node-ssrf-http
    patterns:
      - pattern: 'http.get(req.$PARAM, ...)'
      - pattern: 'https.get(req.$PARAM, ...)'
      - pattern: 'http.request({host: req.$PARAM}, ...)'
    message: Native HTTP request with user input - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  # ============================================
  # Path Traversal
  # ============================================

  - id: node-path-traversal
    patterns:
      - pattern: 'fs.readFile($PATH + req.$PARAM, ...)'
      - pattern: 'fs.readFileSync($PATH + req.$PARAM)'
      - pattern: 'fs.readFile(`${...}${req.$PARAM}...`, ...)'
      - pattern: 'path.join($BASE, req.$PARAM)'
    message: Path traversal - user input in file path without validation
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, path-traversal]

  - id: express-sendfile-traversal
    patterns:
      - pattern: 'res.sendFile(req.$PARAM)'
      - pattern: 'res.sendFile($PATH + req.$PARAM)'
      - pattern: 'res.download(req.$PARAM)'
    message: Express file send with user input - path traversal risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, path-traversal]

  - id: node-fs-unvalidated
    patterns:
      - pattern: 'fs.writeFile(req.$PARAM, ...)'
      - pattern: 'fs.unlink(req.$PARAM, ...)'
      - pattern: 'fs.rmdir(req.$PARAM, ...)'
      - pattern: 'fs.mkdir(req.$PARAM, ...)'
    message: File system operation with user-controlled path - validate input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, path-traversal]

  # ============================================
  # XXE - XML External Entity
  # ============================================

  - id: node-xxe-xml2js
    pattern: 'xml2js.parseString($INPUT, ...)'
    message: XML parsing - ensure external entities are disabled to prevent XXE
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  - id: node-xxe-libxmljs
    patterns:
      - pattern: 'libxmljs.parseXml($INPUT)'
      - pattern: 'libxmljs.parseXmlString($INPUT)'
    message: libxmljs XML parsing - disable external entities to prevent XXE
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  - id: node-xxe-domparser
    pattern: 'new DOMParser().parseFromString($INPUT, ...)'
    message: DOMParser XML parsing - potential XXE if processing untrusted XML
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: node-unsafe-deserialize
    patterns:
      - pattern: 'serialize.unserialize($INPUT)'
      - pattern: 'node-serialize.unserialize($INPUT)'
    message: Unsafe deserialization - can lead to remote code execution
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, deserialization]

  - id: node-json-parse-uncaught
    pattern: 'JSON.parse(req.$PARAM)'
    message: JSON.parse on user input without try-catch - may crash on invalid JSON
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, error-handling]

  # ============================================
  # IDOR - Insecure Direct Object Reference
  # ============================================

  - id: express-idor-param
    patterns:
      - pattern: '$MODEL.findById(req.params.$ID)'
      - pattern: '$MODEL.findByPk(req.params.$ID)'
      - pattern: '$DB.find({id: req.params.$ID})'
    message: Direct object access using URL parameter - verify user authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, idor, authz]

  # ============================================
  # Authentication/Session Issues
  # ============================================

  - id: express-session-insecure
    patterns:
      - pattern: 'session({secret: $SECRET, cookie: {secure: false}})'
      - pattern: 'session({cookie: {httpOnly: false}})'
    message: Insecure session configuration - enable secure and httpOnly
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, session, auth]

  - id: jwt-none-algorithm
    patterns:
      - pattern: 'jwt.verify($TOKEN, $SECRET, {algorithms: ["none"]})'
      - pattern: 'jwt.decode($TOKEN)'
    message: JWT with none algorithm or decode without verify - authentication bypass
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [jwt, auth]

  - id: bcrypt-low-rounds
    pattern: 'bcrypt.hash($PASS, $ROUNDS)'
    message: Verify bcrypt salt rounds - should be at least 10 for security
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [crypto, auth]

  # ============================================
  # CORS Misconfiguration
  # ============================================

  - id: express-cors-wildcard
    patterns:
      - pattern: "cors({origin: '*'})"
      - pattern: "cors({origin: true})"
      - pattern: 'res.setHeader("Access-Control-Allow-Origin", "*")'
    message: CORS allows all origins - restrict to trusted domains in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, cors]

  - id: express-cors-credentials-wildcard
    pattern: "cors({origin: '*', credentials: true})"
    message: CORS wildcard with credentials - security misconfiguration
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, cors]

  # ============================================
  # Prototype Pollution
  # ============================================

  - id: js-prototype-pollution
    patterns:
      - pattern: '$OBJ[req.$PARAM] = $VALUE'
      - pattern: '$OBJ[$KEY][req.$PARAM] = $VALUE'
      - pattern: 'Object.assign($TARGET, req.$PARAM)'
      - pattern: '_.merge($TARGET, req.$PARAM)'
      - pattern: '_.extend($TARGET, req.$PARAM)'
    message: Potential prototype pollution - validate property names
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, prototype-pollution]

  # ============================================
  # Missing Security Headers
  # ============================================

  - id: express-no-helmet
    pattern: 'express()'
    message: Express app - consider using helmet() for security headers
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [express, headers]

  # ============================================
  # DVNA-Specific Vulnerability Patterns
  # ============================================

  # SQL Injection - String concatenation patterns
  - id: sql-string-concat-login
    pattern-regex: "\"SELECT[^\"]+WHERE[^\"]+='\\s*\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation with user input in WHERE clause
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sql-string-concat-select
    pattern-regex: "\"SELECT[^\"]+\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation in SELECT query
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sql-string-concat-insert
    pattern-regex: "\"INSERT[^\"]+\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation in INSERT query
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sql-string-concat-update
    pattern-regex: "\"UPDATE[^\"]+\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation in UPDATE query
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sql-string-concat-delete
    pattern-regex: "\"DELETE[^\"]+\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation in DELETE query
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  # Code Injection - mathjs.eval
  - id: mathjs-eval-injection
    patterns:
      - pattern: 'mathjs.eval($INPUT)'
      - pattern: 'math.eval($INPUT)'
      - pattern: 'mathjs.evaluate($INPUT)'
      - pattern: 'math.evaluate($INPUT)'
    message: Code injection via mathjs eval - user input can execute arbitrary expressions
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, code]

  - id: mathjs-eval-request
    pattern-regex: "math(js)?\\.(eval|evaluate)\\(req\\."
    message: Code injection - mathjs eval with request input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, code]

  # Insecure Deserialization - node-serialize
  - id: node-serialize-unserialize
    patterns:
      - pattern: 'serialize.unserialize(...)'
      - pattern: 'nodeSerialize.unserialize(...)'
      - pattern: 'unserialize(...)'
    message: Insecure deserialization - node-serialize can lead to RCE
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, deserialization, rce]

  - id: node-serialize-regex
    pattern-regex: "serialize\\.unserialize\\("
    message: Insecure deserialization via node-serialize - remote code execution risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, deserialization, rce]

  # XXE - libxmljs with noent:true
  - id: libxmljs-xxe-noent
    pattern-regex: "libxmljs\\.parseXml(String)?\\([^,]+,\\s*\\{[^}]*noent\\s*:\\s*true"
    message: XXE vulnerability - libxmljs with noent:true enables external entity processing
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [xml, xxe]

  - id: xml-external-entities
    pattern-regex: "\\{[^}]*noent\\s*:\\s*true[^}]*\\}"
    message: XML external entity processing enabled - potential XXE vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  # Open Redirect - res.redirect with user input
  - id: express-open-redirect
    patterns:
      - pattern: 'res.redirect(req.body.$PARAM)'
      - pattern: 'res.redirect(req.query.$PARAM)'
      - pattern: 'res.redirect(req.params.$PARAM)'
    message: Open redirect - user-controlled redirect destination
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, redirect]

  - id: open-redirect-regex
    pattern-regex: "res\\.redirect\\(req\\.(body|query|params)\\."
    message: Open redirect vulnerability - validate redirect URL against whitelist
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, redirect]

  # Stored XSS via database
  - id: stored-xss-db-to-html
    patterns:
      - pattern: 'res.send($DATA)'
      - pattern: 'res.send(`${$DATA}`)'
    message: Response may contain unsanitized data - potential stored XSS
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [express, xss]

  # SSRF via user-controlled URLs
  - id: ssrf-needle
    patterns:
      - pattern: 'needle($METHOD, req.$PARAM.$FIELD, ...)'
      - pattern: 'needle.get(req.$PARAM.$FIELD, ...)'
      - pattern: 'needle.post(req.$PARAM.$FIELD, ...)'
    message: SSRF - needle HTTP request with user-controlled URL
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: ssrf-got
    patterns:
      - pattern: 'got(req.$PARAM.$FIELD)'
      - pattern: 'got.get(req.$PARAM.$FIELD)'
    message: SSRF - got HTTP request with user-controlled URL
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  # Hardcoded credentials detection
  - id: hardcoded-db-password
    pattern-regex: "(password|passwd|pwd)\\s*[=:]\\s*['\"][^'\"]{4,}['\"]"
    message: Hardcoded database password detected - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  - id: hardcoded-db-connection
    pattern-regex: "(mysql|postgres|mongodb)://[^:]+:[^@]+@"
    message: Hardcoded database credentials in connection string
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  # Weak crypto
  - id: crypto-weak-hash-password
    pattern-regex: "createHash\\(['\"]md5['\"]\\)"
    message: MD5 is cryptographically weak - do not use for passwords
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [crypto]

  # Missing input validation
  - id: express-unvalidated-body
    patterns:
      - pattern: 'db.query($Q, [req.body.$FIELD])'
      - pattern: '$MODEL.create(req.body)'
      - pattern: '$MODEL.update(req.body)'
    message: User input passed directly to database - add input validation
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, validation]

  # File upload vulnerabilities
  - id: multer-no-filefilter
    pattern: 'multer({dest: $DEST})'
    message: Multer without file type validation - may allow malicious uploads
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, upload]

  # Information disclosure
  - id: express-stack-trace
    pattern: 'res.send(err.stack)'
    message: Stack trace exposed to client - information disclosure
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, disclosure]

  - id: express-error-details
    pattern: 'res.status($CODE).send(err)'
    message: Full error object sent to client - may leak sensitive info
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [express, disclosure]

  # ============================================
  # MongoDB/Mongoose NoSQL Injection (Enhanced)
  # ============================================

  - id: mongodb-find-user-input
    patterns:
      - pattern: '$COLL.find({$FIELD: req.body.$PARAM})'
      - pattern: '$COLL.find({$FIELD: req.query.$PARAM})'
      - pattern: '$COLL.find({$FIELD: req.params.$PARAM})'
      - pattern: '$COLL.findOne({$FIELD: req.body.$PARAM})'
      - pattern: '$COLL.findOne({$FIELD: req.query.$PARAM})'
    message: MongoDB query with user input - NoSQL injection risk, sanitize input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongodb-update-user-input
    patterns:
      - pattern: '$COLL.update({$FIELD: req.body.$PARAM}, ...)'
      - pattern: '$COLL.updateOne({$FIELD: req.body.$PARAM}, ...)'
      - pattern: '$COLL.updateMany({$FIELD: req.body.$PARAM}, ...)'
      - pattern: '$COLL.findOneAndUpdate({$FIELD: req.body.$PARAM}, ...)'
    message: MongoDB update with user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongodb-delete-user-input
    patterns:
      - pattern: '$COLL.remove({$FIELD: req.body.$PARAM})'
      - pattern: '$COLL.deleteOne({$FIELD: req.body.$PARAM})'
      - pattern: '$COLL.deleteMany({$FIELD: req.body.$PARAM})'
    message: MongoDB delete with user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongoose-find-user-input
    patterns:
      - pattern: '$MODEL.find(req.body)'
      - pattern: '$MODEL.find(req.query)'
      - pattern: '$MODEL.findOne(req.body)'
      - pattern: '$MODEL.findOne(req.query)'
      - pattern: '$MODEL.findById(req.body.$PARAM)'
      - pattern: '$MODEL.findById(req.params.$PARAM)'
    message: Mongoose query with unvalidated user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongoose, injection, nosql]

  - id: mongodb-regex-user-input
    patterns:
      - pattern: '{$regex: req.$PARAM}'
      - pattern: '{$FIELD: {$regex: $INPUT}}'
      - pattern: 'new RegExp(req.$PARAM.$FIELD)'
    message: MongoDB regex with user input - ReDoS and injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, redos]

  - id: mongodb-operator-injection
    pattern-regex: "\\{\\s*\\$[a-z]+\\s*:\\s*req\\.(body|query|params)"
    message: MongoDB operator injection - user input may contain $ operators
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  # ============================================
  # XSS - Template Rendering (Swig, EJS, Pug)
  # ============================================

  - id: swig-render-user-input
    patterns:
      - pattern: 'swig.render($TEMPLATE, {$KEY: req.$PARAM})'
      - pattern: 'swig.renderFile($FILE, {$KEY: req.$PARAM})'
    message: Swig template with user input - potential XSS if not escaped
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [swig, xss, template]

  - id: ejs-render-user-input
    patterns:
      - pattern: 'ejs.render($TEMPLATE, {$KEY: req.$PARAM})'
      - pattern: 'ejs.renderFile($FILE, {$KEY: req.$PARAM})'
      - pattern: 'res.render($VIEW, {$KEY: req.body.$PARAM})'
      - pattern: 'res.render($VIEW, {$KEY: req.query.$PARAM})'
    message: Template render with user input - ensure output is escaped
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ejs, xss, template]

  - id: pug-render-unescaped
    patterns:
      - pattern: '!{$VAR}'
      - pattern: '!= $VAR'
    message: Pug unescaped output - XSS risk if variable contains user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [pug, xss, template]

  - id: handlebars-triple-stache
    pattern-regex: "\\{\\{\\{[^}]+\\}\\}\\}"
    message: Handlebars triple-mustache bypasses escaping - XSS risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [handlebars, xss, template]

  - id: express-send-html-user-input
    patterns:
      - pattern: 'res.send("<html>" + $INPUT)'
      - pattern: 'res.send(`<html>${$INPUT}`)'
      - pattern: 'res.send("<div>" + req.$PARAM)'
    message: HTML response with user input - XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, xss]

  - id: express-write-html
    patterns:
      - pattern: 'res.write("<" + $INPUT)'
      - pattern: 'res.write(`<${$INPUT}`)'
    message: Writing HTML with dynamic content - XSS risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, xss]

  # ============================================
  # Authorization/IDOR Patterns
  # ============================================

  - id: idor-direct-param-access
    patterns:
      - pattern: '$MODEL.findById(req.params.id)'
      - pattern: '$MODEL.findById(req.params.$ID)'
      - pattern: '$COLL.findOne({_id: req.params.$ID})'
    message: Direct object access via URL param - verify user authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [authz, idor]

  - id: idor-missing-owner-check
    patterns:
      - pattern: |
          $MODEL.findById($ID)
          ...
          res.json($DATA)
      - pattern: |
          $MODEL.findOne({_id: $ID})
          ...
          res.send($DATA)
    message: Object lookup without ownership verification - potential IDOR
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [authz, idor]

  - id: auth-bypass-admin-check
    patterns:
      - pattern: 'if (req.body.isAdmin)'
      - pattern: 'if (req.query.admin)'
      - pattern: 'if (req.body.role === "admin")'
    message: Admin check using user-supplied input - authentication bypass
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [authz, bypass]

  # ============================================
  # SSRF Patterns (Enhanced)
  # ============================================

  - id: ssrf-url-user-input
    patterns:
      - pattern: 'new URL(req.body.$PARAM)'
      - pattern: 'new URL(req.query.$PARAM)'
      - pattern: 'url.parse(req.body.$PARAM)'
      - pattern: 'url.parse(req.query.$PARAM)'
    message: URL parsing user input - validate against allowlist for SSRF prevention
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ssrf, url]

  - id: ssrf-image-fetch
    patterns:
      - pattern: 'fetch(req.body.imageUrl)'
      - pattern: 'fetch(req.body.url)'
      - pattern: 'axios.get(req.body.url)'
      - pattern: 'request(req.body.url)'
    message: Fetching user-supplied URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssrf]

  - id: ssrf-dns-rebinding
    pattern-regex: "(fetch|axios|request|http\\.get)\\(.*req\\.(body|query)\\."
    message: HTTP request with user-controlled URL - SSRF/DNS rebinding risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssrf]

  # ============================================
  # Session Security
  # ============================================

  - id: session-fixation
    patterns:
      - pattern: 'req.session = req.body.$PARAM'
      - pattern: 'req.session.id = req.$PARAM'
    message: Session assignment from user input - session fixation risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [session, fixation]

  - id: session-no-regenerate
    pattern: |
      req.session.user = $USER
      ...
      res.redirect($URL)
    message: Session not regenerated after login - session fixation risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [session, fixation]

  - id: cookie-no-httponly
    pattern: "res.cookie($NAME, $VALUE, {httpOnly: false})"
    message: Cookie without httpOnly flag - vulnerable to XSS theft
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [cookie, session]

  - id: cookie-no-secure
    pattern: "res.cookie($NAME, $VALUE, {secure: false})"
    message: Cookie without secure flag - sent over HTTP
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [cookie, session]

  # ============================================
  # Sensitive Data Exposure
  # ============================================

  - id: password-in-response
    patterns:
      - pattern: 'res.json({password: $PASS})'
      - pattern: 'res.send({password: $PASS})'
      - pattern: 'res.json($USER)'
    message: Potentially exposing password in response - exclude sensitive fields
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [data-exposure]

  - id: user-enumeration
    patterns:
      - pattern: 'res.send("User not found")'
      - pattern: 'res.send("Invalid username")'
      - pattern: 'res.json({error: "User does not exist"})'
    message: User enumeration - use generic error messages
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [auth, enumeration]

  - id: verbose-error-message
    patterns:
      - pattern: 'res.send(err.message)'
      - pattern: 'res.json({error: err.message})'
      - pattern: 'res.status($CODE).json({error: $ERR.message})'
    message: Verbose error messages may leak sensitive information
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [disclosure]

  # ============================================
  # Insecure Crypto
  # ============================================

  - id: crypto-weak-key
    patterns:
      - pattern: 'crypto.createCipheriv($ALG, $KEY, ...)'
      - pattern: 'crypto.pbkdf2($PASS, $SALT, $ITER, ...)'
    message: Review crypto parameters - ensure adequate key size and iterations
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [crypto]

  - id: password-plaintext-storage
    patterns:
      - pattern: 'user.password = req.body.password'
      - pattern: '{password: req.body.password}'
    message: Storing password - ensure it's hashed with bcrypt/argon2
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, crypto]

  - id: password-md5-hash
    patterns:
      - pattern: 'crypto.createHash("md5").update(password)'
      - pattern: 'md5(password)'
    message: MD5 is not suitable for password hashing - use bcrypt
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, crypto]

  # ============================================
  # Server-Side Template Injection (SSTI)
  # ============================================

  - id: nunjucks-renderstring-ssti
    patterns:
      - pattern: nunjucks.renderString($INPUT)
      - pattern: nunjucks.renderString(req.query.$PARAM)
      - pattern: nunjucks.renderString(req.body.$PARAM)
      - pattern: nunjucks.renderString(req.params.$PARAM)
    message: Nunjucks renderString with user input - SSTI vulnerability (RCE possible)
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssti, rce]

  - id: nunjucks-ssti-variable
    patterns:
      - pattern: |
          $MSG = req.query.$PARAM
          ...
          nunjucks.renderString($MSG)
      - pattern: |
          $MSG = req.body.$PARAM
          ...
          nunjucks.renderString($MSG)
    message: Variable from user input passed to nunjucks.renderString - SSTI/RCE
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssti, rce]

  - id: nunjucks-ssti-regex
    pattern-regex: "nunjucks\\.renderString\\s*\\("
    message: nunjucks.renderString usage - ensure input is not user-controlled (SSTI risk)
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ssti]

  - id: pug-render-user-input
    patterns:
      - pattern: pug.render($USER_INPUT)
      - pattern: pug.compile($USER_INPUT)
    message: Pug render with user input - SSTI vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssti, rce]

  - id: ejs-render-user-input
    patterns:
      - pattern: ejs.render($INPUT, ...)
      - pattern: ejs.compile($INPUT)
    message: EJS render with user input - potential SSTI
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ssti]

  - id: mustache-render-user-input
    pattern: Mustache.render($TEMPLATE, ...)
    message: Mustache render - ensure template is not user-controlled
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [ssti]

  # ============================================
  # XSS via Redirect
  # ============================================

  - id: xss-redirect-concat
    patterns:
      - pattern: 'res.redirect($BASE + req.query.$PARAM)'
      - pattern: 'res.redirect($BASE + req.body.$PARAM)'
      - pattern: 'res.redirect("..." + $USER_INPUT)'
    message: Redirect with concatenated user input - XSS/open redirect risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xss, redirect]

  - id: xss-redirect-template
    patterns:
      - pattern: 'res.redirect(`${$BASE}${req.query.$PARAM}`)'
      - pattern: 'res.redirect(`...${$USER_INPUT}...`)'
    message: Redirect with template literal user input - XSS/open redirect risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xss, redirect]

  - id: xss-redirect-url-param-concat
    pattern-regex: "res\\.redirect\\s*\\(\\s*[\"'][^\"']*\\?\\w+=[\"']?\\s*\\+\\s*\\w+"
    message: Redirect URL with concatenated parameter - XSS/injection risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xss, redirect]

  # ============================================
  # JWT Security Issues
  # ============================================

  - id: jwt-decode-no-verify
    patterns:
      - pattern: jwt.decode($TOKEN)
      - pattern: jwt.decode($TOKEN, ...)
    message: jwt.decode() without verification - use jwt.verify() instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, jwt]

  - id: jwt-verify-no-algorithm
    pattern: 'jwt.verify($TOKEN, $SECRET)'
    message: jwt.verify without algorithm option - specify algorithms array
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, jwt]

  - id: jwt-none-algorithm
    patterns:
      - pattern: 'jwt.sign($PAYLOAD, $SECRET, {algorithm: "none"})'
      - pattern: '{algorithms: ["none"]}'
    message: JWT none algorithm - authentication bypass vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, jwt]

  # ============================================
  # IDOR / Missing Authorization
  # ============================================

  - id: express-route-no-auth-delete
    pattern-regex: "app\\.(delete|del)\\(['\"][^'\"]+/:id['\"]"
    message: DELETE route with ID param - verify authorization check exists
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, auth]

  - id: express-route-no-auth-put
    pattern-regex: "app\\.put\\(['\"][^'\"]+/:id['\"]"
    message: PUT route with ID param - verify authorization check exists
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, auth]

  - id: sequelize-find-by-id-param
    patterns:
      - pattern: '$MODEL.findByPk(req.params.id)'
      - pattern: '$MODEL.findByPk(req.params.$ID)'
      - pattern: '$MODEL.findOne({where: {id: req.params.id}})'
    message: Direct object lookup by URL param - ensure authorization check
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola]

  - id: mongoose-find-by-id-param
    patterns:
      - pattern: '$MODEL.findById(req.params.id)'
      - pattern: '$MODEL.findById(req.params.$ID)'
    message: MongoDB findById with URL param - verify authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola]

  # ============================================
  # Weak Password Handling
  # ============================================

  - id: plaintext-password-compare
    patterns:
      - pattern: '$USER.password == $INPUT'
      - pattern: '$INPUT == $USER.password'
      - pattern: 'password == user.password'
      - pattern: 'user.password == password'
      - pattern: '$VAR[0].password == $INPUT'
      - pattern: '$INPUT == $VAR[0].password'
    message: Plaintext password comparison - use bcrypt.compare()
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, crypto]

  - id: md5-password-compare
    patterns:
      - pattern: 'md5($PASSWORD) == $USER.password'
      - pattern: '$USER.password == md5($PASSWORD)'
      - pattern: 'md5($VAR.password) == $INPUT'
      - pattern: '$INPUT == md5($VAR.password)'
      - pattern: 'md5($VAR[0].password) == $INPUT'
    message: MD5 password comparison - use bcrypt instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, crypto]

  - id: weak-password-compare-regex
    pattern-regex: "\\.(password)\\s*==\\s*\\w+|\\w+\\s*==\\s*\\w+\\.password"
    message: Direct password comparison detected - use bcrypt.compare() for secure comparison
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, crypto]

  # ============================================
  # Session Security
  # ============================================

  - id: session-regenerate-missing
    pattern-regex: "req\\.session\\.user\\s*="
    message: Session user assignment - call req.session.regenerate() to prevent fixation
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [session, auth]

  - id: session-secret-weak
    patterns:
      - pattern: 'session({secret: "secret"})'
      - pattern: 'session({secret: "keyboard cat"})'
      - pattern: "session({secret: 'secret'})"
    message: Weak session secret - use strong random secret
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [session]

  # ============================================
  # SSRF Patterns
  # ============================================

  - id: axios-ssrf-user-url
    patterns:
      - pattern: 'axios.get(req.body.$URL)'
      - pattern: 'axios.get(req.query.$URL)'
      - pattern: 'axios.post(req.body.$URL, ...)'
      - pattern: 'axios($CONFIG)'
    message: Axios request with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ssrf]

  - id: fetch-ssrf-user-url
    patterns:
      - pattern: 'fetch(req.body.$URL)'
      - pattern: 'fetch(req.query.$URL)'
      - pattern: 'fetch(req.params.$URL)'
    message: Fetch with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssrf]

  # ============================================
  # Path Traversal
  # ============================================

  - id: path-traversal-join
    patterns:
      - pattern: 'path.join($BASE, req.params.$FILE)'
      - pattern: 'path.join($BASE, req.query.$FILE)'
      - pattern: 'path.join($BASE, req.body.$FILE)'
    message: Path join with user input - validate and sanitize for path traversal
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [path-traversal]

  - id: fs-read-user-path
    patterns:
      - pattern: 'fs.readFile(req.params.$FILE, ...)'
      - pattern: 'fs.readFileSync(req.query.$FILE)'
      - pattern: 'fs.createReadStream(req.body.$FILE)'
    message: File read with user input - path traversal vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [path-traversal]

  - id: res-sendfile-user-path
    patterns:
      - pattern: 'res.sendFile(req.params.$FILE)'
      - pattern: 'res.sendFile(req.query.$FILE)'
      - pattern: 'res.download(req.params.$FILE)'
    message: sendFile/download with user input - path traversal risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [path-traversal]

  # ============================================
  # Mass Assignment
  # ============================================

  - id: sequelize-mass-assignment
    patterns:
      - pattern: '$MODEL.create(req.body)'
      - pattern: '$MODEL.update(req.body, ...)'
      - pattern: '$INSTANCE.update(req.body)'
    message: Sequelize create/update with full req.body - mass assignment risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [mass-assignment]

  - id: mongoose-mass-assignment
    patterns:
      - pattern: 'new $MODEL(req.body)'
      - pattern: '$MODEL.findByIdAndUpdate($ID, req.body)'
      - pattern: '$DOC.set(req.body)'
    message: Mongoose with full req.body - mass assignment vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [mass-assignment]

  # ============================================
  # Missing Security Headers
  # ============================================

  - id: missing-helmet
    pattern: 'const app = express()'
    message: Express app - consider using helmet() for security headers
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [headers]

  - id: cors-wildcard-credentials
    patterns:
      - pattern: 'cors({origin: "*", credentials: true})'
      - pattern: 'cors({origin: true, credentials: true})'
    message: CORS wildcard with credentials - security misconfiguration
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [cors]

  # ============================================
  # SQL Injection (Sequelize)
  # ============================================

  - id: sequelize-raw-query
    patterns:
      - pattern: 'sequelize.query($QUERY)'
      - pattern: '$DB.query($QUERY)'
    message: Sequelize raw query - ensure parameterized
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [sqli]

  - id: sequelize-literal-user-input
    patterns:
      - pattern: 'Sequelize.literal(req.body.$FIELD)'
      - pattern: 'Sequelize.literal(req.query.$FIELD)'
      - pattern: 'sequelize.literal($USER_INPUT)'
    message: Sequelize.literal with user input - SQL injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sqli]

  # ============================================
  # User Enumeration
  # ============================================

  - id: user-enumeration-error
    patterns:
      - pattern: 'res.send("User not found")'
      - pattern: 'res.json({error: "User not found"})'
      - pattern: 'res.send("Invalid username")'
      - pattern: '"User does not exist"'
    message: User enumeration - use generic error message
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, enumeration]

  - id: user-enumeration-password
    patterns:
      - pattern: 'res.send("Wrong password")'
      - pattern: 'res.json({error: "Incorrect password"})'
      - pattern: '"Password is incorrect"'
    message: Password error reveals user exists - use generic error
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, enumeration]

  # ============================================
  # Enhanced IDOR/BOLA Detection
  # ============================================

  - id: idor-query-id-to-function
    patterns:
      - pattern: '$FUNC(req.query.id)'
      - pattern: '$FUNC(req.query.id, ...)'
      - pattern: '$FUNC(req.params.id)'
      - pattern: '$FUNC(req.params.id, ...)'
      - pattern: '$FUNC(req.body.id)'
      - pattern: '$FUNC(req.body.id, ...)'
    message: Function called with user-controlled ID - verify authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola]

  - id: idor-sequelize-query-id
    patterns:
      - pattern: '$MODEL.findOne({where: {id: req.query.id}})'
      - pattern: '$MODEL.findOne({where: {id: req.params.id}})'
      - pattern: '$MODEL.findOne({where: {id: req.body.id}})'
      - pattern: '$MODEL.update($DATA, {where: {id: req.query.id}})'
      - pattern: '$MODEL.update($DATA, {where: {id: req.body.id}})'
      - pattern: '$MODEL.destroy({where: {id: req.query.id}})'
      - pattern: '$MODEL.destroy({where: {id: req.params.id}})'
    message: Sequelize query with user-controlled ID - IDOR risk without auth check
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola, sequelize]

  - id: idor-knex-query-id
    patterns:
      - pattern: '$DB($TABLE).where({id: req.query.id})'
      - pattern: '$DB($TABLE).where({id: req.params.id})'
      - pattern: '$DB($TABLE).where("id", req.query.id)'
      - pattern: '$DB.select(...).where({id: req.params.id})'
    message: Knex query with user-controlled ID - verify authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola, knex]

  - id: idor-prisma-query-id
    patterns:
      - pattern: 'prisma.$MODEL.findUnique({where: {id: req.params.id}})'
      - pattern: 'prisma.$MODEL.findUnique({where: {id: req.query.id}})'
      - pattern: 'prisma.$MODEL.update({where: {id: req.body.id}, ...})'
      - pattern: 'prisma.$MODEL.delete({where: {id: req.params.id}})'
    message: Prisma query with user-controlled ID - IDOR risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola, prisma]

  # ============================================
  # XSS in Express Views
  # ============================================

  - id: xss-res-send-user-input
    patterns:
      - pattern: 'res.send(req.query.$PARAM)'
      - pattern: 'res.send(req.body.$PARAM)'
      - pattern: 'res.send(req.params.$PARAM)'
      - pattern: 'res.send("<..." + req.query.$PARAM + "...")'
    message: Response with user input - XSS risk without encoding
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [xss]

  - id: xss-template-variable-unescaped
    patterns:
      - pattern: 'res.render($TEMPLATE, {$VAR: req.query.$PARAM})'
      - pattern: 'res.render($TEMPLATE, {$VAR: req.body.$PARAM})'
    message: User input passed to template - ensure template escapes output
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xss]

  - id: xss-ejs-unescaped
    pattern-regex: "<%[-=]\\s*[^%]*req\\.(query|body|params)"
    message: EJS template with user input - use <%= for escaping
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [xss, ejs]

  # ============================================
  # Path Traversal (Enhanced)
  # ============================================

  - id: path-traversal-resolve
    patterns:
      - pattern: 'path.resolve($BASE, req.query.$FILE)'
      - pattern: 'path.resolve($BASE, req.params.$FILE)'
      - pattern: 'path.resolve($BASE, req.body.$FILE)'
    message: path.resolve with user input - path traversal risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [path-traversal]

  - id: path-traversal-concat
    patterns:
      - pattern: '$DIR + "/" + req.query.$FILE'
      - pattern: '$DIR + "/" + req.params.$FILE'
      - pattern: '`${$DIR}/${req.query.$FILE}`'
      - pattern: '`${$DIR}/${req.params.$FILE}`'
    message: Path concatenation with user input - path traversal vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [path-traversal]

  # ============================================
  # Broken Access Control
  # ============================================

  - id: broken-access-admin-param
    patterns:
      - pattern: 'if (req.query.admin)'
      - pattern: 'if (req.body.admin)'
      - pattern: 'if (req.query.isAdmin)'
      - pattern: 'if (req.body.isAdmin)'
      - pattern: 'if (req.body.role === "admin")'
    message: Admin/role check from user input - privilege escalation risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, privilege-escalation]

  - id: broken-access-user-id-comparison
    patterns:
      - pattern: 'if (req.user.id == req.params.id)'
      - pattern: 'if (req.user.id === req.params.id)'
      - pattern: 'req.params.id == req.user.id'
    message: User ID comparison - ensure proper authorization logic
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [auth, idor]

  # ============================================
  # Sensitive Data Exposure
  # ============================================

  - id: sensitive-data-password-response
    patterns:
      - pattern: 'res.json({..., password: $PASS, ...})'
      - pattern: 'res.send({..., password: $PASS, ...})'
      - pattern: '{password: user.password}'
      - pattern: '{password: $USER.password}'
    message: Password in API response - remove sensitive field
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [data-exposure]

  - id: sensitive-data-token-response
    patterns:
      - pattern: 'res.json({..., token: $TOKEN, ...})'
      - pattern: 'console.log($MSG, token)'
      - pattern: 'console.log($MSG, $USER.token)'
    message: Token may be exposed - verify intentional
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [data-exposure]

  # ============================================
  # Input Validation Issues
  # ============================================

  - id: no-input-validation-parseInt
    patterns:
      - pattern: 'parseInt(req.query.$PARAM)'
      - pattern: 'parseInt(req.body.$PARAM)'
      - pattern: 'Number(req.query.$PARAM)'
    message: Parsing user input - handle NaN and invalid values
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [validation]

  - id: json-parse-user-input
    patterns:
      - pattern: 'JSON.parse(req.body.$PARAM)'
      - pattern: 'JSON.parse(req.query.$PARAM)'
    message: JSON.parse on user input - handle parse errors
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [validation]

  # ============================================
  # Logging Sensitive Data
  # ============================================

  - id: logging-password
    patterns:
      - pattern: 'console.log($MSG, password)'
      - pattern: 'console.log($MSG, req.body.password)'
      - pattern: 'logger.info($MSG, password)'
    message: Password logged - remove from logs
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [logging, data-exposure]

  - id: logging-full-request
    patterns:
      - pattern: 'console.log(req.body)'
      - pattern: 'console.log(req)'
      - pattern: 'logger.debug(req.body)'
    message: Full request body logged - may contain sensitive data
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [logging]

  # ============================================
  # Insecure Randomness
  # ============================================

  - id: math-random-security
    patterns:
      - pattern: 'Math.random()'
    message: Math.random() is not cryptographically secure - use crypto.randomBytes
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [crypto]

  - id: insecure-token-generation
    patterns:
      - pattern: 'Math.random().toString(36)'
      - pattern: 'Math.random().toString(16)'
    message: Insecure token generation - use crypto.randomBytes or uuid
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [crypto, auth]

  # ============================================
  # A04: Insecure Design Patterns
  # ============================================

  - id: no-rate-limit-login
    pattern-regex: "app\\.(post|put)\\s*\\(\\s*['\"]/(login|auth|signin|authenticate)['\"]"
    message: Login endpoint without visible rate limiting - add rate-limiter-flexible or express-rate-limit
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a04, rate-limit, auth]

  - id: no-rate-limit-password-reset
    pattern-regex: "app\\.(post|put)\\s*\\(\\s*['\"]/(forgot|reset|password)[^'\"]*['\"]"
    message: Password reset endpoint - ensure rate limiting is applied
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a04, rate-limit]

  - id: hardcoded-admin-bypass
    patterns:
      - pattern: 'if (user.role === "admin")'
      - pattern: 'if (role === "admin")'
      - pattern: 'user.isAdmin === true'
    message: Hardcoded admin check - ensure proper RBAC implementation
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a04, rbac]

  # ============================================
  # A07: Identification and Authentication Failures
  # ============================================

  - id: jwt-no-expiry
    pattern: 'jwt.sign($PAYLOAD, $SECRET)'
    message: JWT sign without expiresIn option - tokens should expire
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a07, jwt, auth]

  - id: jwt-long-expiry
    pattern-regex: "expiresIn:\\s*['\"]\\d+d['\"]"
    message: JWT with multi-day expiry - consider shorter token lifetimes
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a07, jwt]

  - id: session-no-expiry
    pattern: 'session({secret: $SECRET})'
    message: Session without maxAge/expires - sessions should timeout
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a07, session]

  - id: cookie-no-httponly
    patterns:
      - pattern: 'res.cookie($NAME, $VALUE)'
      - pattern: 'res.cookie($NAME, $VALUE, {secure: true})'
    message: Cookie without httpOnly flag - vulnerable to XSS theft
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a07, cookie]

  - id: password-min-length-weak
    pattern-regex: "(password|pwd)\\.length\\s*(<|<=|>=|>)\\s*[1-7][^0-9]"
    message: Weak password length requirement - use at least 8 characters
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a07, password]

  - id: no-account-lockout
    pattern-regex: "failedAttempts|loginAttempts|attempts"
    message: Failed login tracking found - ensure account lockout is implemented
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a07, brute-force]

  # ============================================
  # A08: Software and Data Integrity Failures
  # ============================================

  - id: npm-install-no-lockfile
    pattern-regex: "npm install(?!.*--frozen-lockfile)(?!.*--ci)"
    message: npm install without lockfile integrity - use npm ci in CI/CD
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a08, supply-chain]

  - id: eval-json-parse
    patterns:
      - pattern: 'eval("(" + $DATA + ")")'
      - pattern: 'eval($JSON_STRING)'
    message: eval() for JSON parsing - use JSON.parse() instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a08, deserialization]

  - id: yaml-load-unsafe
    patterns:
      - pattern: 'yaml.load($DATA)'
      - pattern: 'YAML.parse($DATA)'
    message: YAML load may execute code - use yaml.safeLoad or safe schema
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a08, deserialization]

  - id: child-process-curl-pipe
    pattern-regex: "exec\\(['\"]curl[^'\"]*\\|[^'\"]*['\"]"
    message: curl piped to shell - download and verify before executing
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a08, command-injection]

  - id: script-integrity-missing
    pattern-regex: "<script[^>]+src=['\"]https?://[^'\"]+['\"][^>]*>"
    message: External script without integrity attribute - add SRI hash
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a08, integrity]

  # ============================================
  # A10: Server-Side Request Forgery (SSRF)
  # ============================================

  - id: ssrf-url-constructor
    patterns:
      - pattern: 'new URL(req.body.$PARAM)'
      - pattern: 'new URL(req.query.$PARAM)'
      - pattern: 'new URL($USER_INPUT)'
    message: URL constructed from user input - validate against SSRF
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-got-request
    patterns:
      - pattern: 'got(req.body.$URL)'
      - pattern: 'got(req.query.$URL)'
      - pattern: 'got.get(req.body.$URL)'
    message: got HTTP request with user URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-request-library
    patterns:
      - pattern: 'request(req.body.$URL)'
      - pattern: 'request.get(req.query.$URL)'
      - pattern: 'superagent.get(req.body.$URL)'
    message: HTTP request with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-puppeteer-goto
    patterns:
      - pattern: 'page.goto(req.body.$URL)'
      - pattern: 'page.goto(req.query.$URL)'
      - pattern: 'browser.newPage().goto($USER_URL)'
    message: Puppeteer goto with user URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-image-download
    patterns:
      - pattern: 'axios.get(req.body.imageUrl, {responseType: "arraybuffer"})'
      - pattern: 'fetch(req.body.imageUrl)'
      - pattern: 'download(req.body.$URL)'
    message: Image/file download from user URL - validate against SSRF
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-webhook-url
    patterns:
      - pattern: 'fetch(req.body.webhookUrl)'
      - pattern: 'axios.post(req.body.callbackUrl, ...)'
      - pattern: 'http.request(req.body.notifyUrl)'
    message: Webhook/callback URL from user input - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a10, ssrf]

