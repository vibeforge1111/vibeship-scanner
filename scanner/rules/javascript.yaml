# JavaScript/TypeScript Security Rules
# Tags: core, react, vue, angular, nextjs, express, node, typescript
rules:
  # ============================================
  # Core: Code Injection (always run)
  # ============================================

  - id: js-eval-injection
    pattern: eval(...)
    message: Dangerous eval() call - potential code injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-new-function
    pattern: new Function(...)
    message: new Function() - potential code injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-settimeout-string
    pattern: 'setTimeout("...", ...)'
    message: setTimeout with string argument - code injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-setinterval-string
    pattern: 'setInterval("...", ...)'
    message: setInterval with string argument - code injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  # ============================================
  # Core: XSS (DOM manipulation)
  # ============================================

  - id: js-innerhtml-xss
    pattern: $X.innerHTML = $Y
    message: innerHTML assignment - potential XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-document-write
    pattern: document.write(...)
    message: document.write() usage - potential XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-outerhtml-xss
    pattern: $X.outerHTML = $Y
    message: outerHTML assignment - potential XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-insertadjacenthtml
    pattern: $X.insertAdjacentHTML(...)
    message: insertAdjacentHTML - potential XSS without sanitization
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  # ============================================
  # React XSS
  # ============================================

  - id: react-dangerously-set-inner-html
    pattern: dangerouslySetInnerHTML={...}
    message: React dangerouslySetInnerHTML - XSS risk without proper sanitization
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [react, xss]

  - id: react-href-javascript
    pattern-regex: 'href\s*=\s*[{"\''"]javascript:'
    message: "React javascript: URL in href - XSS vulnerability"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [react, xss]

  - id: react-ref-innerhtml
    pattern: $REF.current.innerHTML = $X
    message: React ref innerHTML manipulation - XSS risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [react, xss]

  # ============================================
  # Vue.js XSS
  # ============================================

  - id: vue-v-html-directive
    pattern-regex: 'v-html\s*=\s*["\'']\S+'
    message: Vue v-html directive bypasses sanitization - XSS risk with user input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [vue, xss]

  - id: vue-compile-dynamic
    pattern: Vue.compile($X)
    message: Dynamic Vue template compilation - potential XSS with user input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [vue, xss]

  - id: vue-render-raw
    pattern: "h('div', {innerHTML: $X})"
    message: Vue render function with innerHTML - XSS risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [vue, xss]

  # ============================================
  # Angular XSS
  # ============================================

  - id: angular-bypass-security-html
    pattern: bypassSecurityTrustHtml(...)
    message: Angular bypassSecurityTrustHtml - XSS risk without proper sanitization
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [angular, xss]

  - id: angular-bypass-security-script
    pattern: bypassSecurityTrustScript(...)
    message: Angular bypassSecurityTrustScript - XSS risk, avoid using
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [angular, xss]

  - id: angular-bypass-security-url
    pattern: bypassSecurityTrustUrl(...)
    message: Angular bypassSecurityTrustUrl - potential open redirect or XSS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [angular, xss]

  - id: angular-bypass-security-resource-url
    pattern: bypassSecurityTrustResourceUrl(...)
    message: Angular bypassSecurityTrustResourceUrl - potential XSS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [angular, xss]

  # ============================================
  # Next.js Specific
  # ============================================

  - id: nextjs-dangerouslysetinnerhtml-getserverside
    pattern: |
      export async function getServerSideProps(...) {
        ...
        return { props: { $HTML } }
      }
    message: Next.js SSR with HTML prop - ensure sanitized before dangerouslySetInnerHTML
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [nextjs, xss]

  - id: nextjs-api-sql-injection
    pattern: |
      export default async function handler(req, res) {
        ...
        $DB.query($Q + req.$X)
        ...
      }
    message: Next.js API route SQL injection - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [nextjs, injection]

  - id: nextjs-headers-exposed
    pattern: 'headers: { "Access-Control-Allow-Origin": "*" }'
    message: Next.js API with CORS wildcard - restrict origins in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [nextjs, config]

  - id: nextjs-middleware-bypass
    pattern: |
      if (req.nextUrl.pathname.startsWith($PATH)) {
        return NextResponse.next()
      }
    message: Next.js middleware - verify auth check isn't bypassed
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [nextjs, auth]

  # ============================================
  # SvelteKit Specific
  # ============================================

  - id: sveltekit-html-injection
    pattern-regex: '\{@html\s+\S+'
    message: SvelteKit @html - XSS risk if content is user-controlled
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [svelte, xss]

  - id: sveltekit-load-user-data
    pattern: |
      export async function load({ params }) {
        ...
        return { $DATA: params.$X }
      }
    message: SvelteKit load with unvalidated params - validate before use
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [svelte, validation]

  - id: sveltekit-form-action-sqli
    pattern: |
      export const actions = {
        default: async ({ request }) => {
          ...
          $DB.query($Q + $FORM)
          ...
        }
      }
    message: SvelteKit form action SQL injection - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [svelte, injection]

  # ============================================
  # Node.js: Command Injection
  # ============================================

  - id: node-exec-call
    pattern: exec(...)
    message: Command execution detected - potential command injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  - id: node-execsync-call
    pattern: execSync(...)
    message: Synchronous command execution - potential command injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  - id: node-child-process-exec
    pattern: child_process.exec(...)
    message: child_process.exec() - potential command injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  - id: node-spawn-shell
    pattern: "spawn($CMD, $ARGS, {shell: true})"
    message: spawn with shell=true - command injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, injection]

  # ============================================
  # Node.js: Path Traversal
  # ============================================

  - id: node-path-traversal-readfile
    pattern: fs.readFile(req.$X.$Y, ...)
    message: Reading file from user input - potential path traversal
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, path-traversal]

  - id: node-path-traversal-readfilesync
    pattern: fs.readFileSync(req.$X.$Y)
    message: Reading file from user input - potential path traversal
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, path-traversal]

  - id: node-path-traversal-concat
    patterns:
      - pattern: fs.readFileSync($PATH + $VAR)
      - pattern: fs.readFileSync($PATH + $VAR, ...)
      - pattern: fs.readFile($PATH + $VAR, ...)
      - pattern: fs.createReadStream($PATH + $VAR)
      - pattern: fs.createReadStream($PATH + $VAR, ...)
      - pattern: fs.existsSync($PATH + $VAR)
      - pattern: fs.statSync($PATH + $VAR)
    message: File operation with string concatenation - potential path traversal vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [node, path-traversal]

  - id: node-path-traversal-template
    patterns:
      - pattern: 'fs.readFileSync(`${...}${$VAR}...`)'
      - pattern: 'fs.readFileSync(`${...}${$VAR}...`, ...)'
      - pattern: 'fs.readFile(`${...}${$VAR}...`, ...)'
      - pattern: 'fs.createReadStream(`${...}${$VAR}...`)'
    message: File operation with template literal - potential path traversal if variable is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [node, path-traversal]

  - id: node-path-join-user
    pattern: path.join($BASE, req.$X.$Y)
    message: path.join with user input - validate to prevent traversal
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [node, path-traversal]

  - id: node-path-join-variable
    patterns:
      - pattern: path.join($BASE, $VAR)
      - pattern: path.resolve($BASE, $VAR)
    message: path.join/resolve with variable - validate to prevent directory traversal
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [node, path-traversal]

  - id: express-sendfile-variable
    patterns:
      - pattern: res.sendFile($PATH + $VAR)
      - pattern: res.sendFile($PATH + $VAR, ...)
      - pattern: 'res.sendFile(`${...}${$VAR}...`)'
      - pattern: res.download($PATH + $VAR)
      - pattern: res.download($PATH + $VAR, ...)
    message: Express sendFile/download with variable path - potential path traversal
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, path-traversal]

  - id: express-sendfile-path-resolve
    patterns:
      - pattern: res.sendFile(path.resolve(...))
      - pattern: res.sendFile(path.resolve(...), ...)
      - pattern: res.sendFile(path.join(...))
      - pattern: res.sendFile(path.join(...), ...)
    message: Express sendFile with path.resolve/join - potential path traversal if any argument is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, path-traversal]

  - id: node-serialize-unserialize
    patterns:
      - pattern: serialize.unserialize(...)
      - pattern: $X.unserialize(...)
    message: node-serialize unserialize() is vulnerable to RCE - never use with untrusted data
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, deserialization, rce]

  - id: js-yaml-load-unsafe
    patterns:
      - pattern: yaml.load($DATA)
      - pattern: jsyaml.load($DATA)
      - pattern: YAML.load($DATA)
    message: js-yaml load() can execute code - use safeLoad() or {schema:SAFE_SCHEMA}
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [node, deserialization]

  - id: json-parse-reviver
    pattern: JSON.parse($DATA, $REVIVER)
    message: JSON.parse with reviver function - ensure reviver doesn't introduce vulnerabilities
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [node, deserialization]

  - id: node-fs-write-traversal
    patterns:
      - pattern: fs.writeFileSync($PATH + $VAR, ...)
      - pattern: fs.writeFile($PATH + $VAR, ...)
      - pattern: fs.createWriteStream($PATH + $VAR)
      - pattern: fs.createWriteStream($PATH + $VAR, ...)
      - pattern: 'fs.createWriteStream(`${...}${$VAR}...`)'
      - pattern: 'fs.createWriteStream(`${...}${$VAR}...`, ...)'
    message: File write with variable path - potential path traversal for arbitrary file write
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [node, path-traversal]

  - id: node-fs-unlink-traversal
    patterns:
      - pattern: fs.unlinkSync($PATH + $VAR)
      - pattern: fs.unlink($PATH + $VAR, ...)
      - pattern: fs.rmSync($PATH + $VAR)
      - pattern: fs.rmSync($PATH + $VAR, ...)
    message: File deletion with variable path - potential path traversal for arbitrary file deletion
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [node, path-traversal]

  # ============================================
  # Open Redirect
  # ============================================

  - id: express-redirect-user-input
    patterns:
      - pattern: res.redirect(req.$X)
      - pattern: res.redirect(req.$X.$Y)
      - pattern: res.redirect($URL)
    message: Redirect with potentially user-controlled URL - validate against allowlist to prevent open redirect
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, redirect]

  - id: express-redirect-query-param
    patterns:
      - pattern: res.redirect(req.query.$PARAM)
      - pattern: res.redirect(req.body.$PARAM)
      - pattern: res.redirect(req.params.$PARAM)
    message: Open redirect vulnerability - user input directly used in redirect
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, redirect]

  - id: window-location-user-input
    patterns:
      - pattern: window.location = $VAR
      - pattern: window.location.href = $VAR
      - pattern: location.href = $VAR
      - pattern: location.assign($VAR)
      - pattern: location.replace($VAR)
    message: Client-side redirect with variable - potential open redirect if user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [browser, redirect]

  # ============================================
  # CSRF Protection
  # ============================================

  - id: express-no-csrf-post
    patterns:
      - pattern: app.post($PATH, $HANDLER)
      - pattern: router.post($PATH, $HANDLER)
    message: POST route without explicit CSRF middleware - ensure CSRF protection is applied
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [express, csrf]

  - id: express-csrf-disabled
    patterns:
      - pattern: 'csrf: false'
      - pattern: 'csrfProtection: false'
    message: CSRF protection explicitly disabled - verify this is intentional
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, csrf]

  # ============================================
  # Insecure Cookies
  # ============================================

  - id: cookie-no-httponly
    patterns:
      - pattern: 'res.cookie($NAME, $VAL, {httpOnly: false, ...})'
      - pattern: 'res.cookie($NAME, $VAL, {..., httpOnly: false})'
    message: Cookie without httpOnly flag - vulnerable to XSS cookie theft
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, cookie]

  - id: cookie-no-secure
    patterns:
      - pattern: 'res.cookie($NAME, $VAL, {secure: false, ...})'
      - pattern: 'res.cookie($NAME, $VAL, {..., secure: false})'
    message: Cookie without secure flag - sent over HTTP, vulnerable to interception
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, cookie]

  - id: session-cookie-insecure
    patterns:
      - pattern: 'cookie: {secure: false}'
      - pattern: 'cookie: {httpOnly: false}'
    message: Session cookie with insecure settings
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, session]

  # ============================================
  # Additional Path Traversal Patterns
  # ============================================

  - id: express-static-user-path
    patterns:
      - pattern: express.static($PATH)
      - pattern: express.static(path.join(...))
      - pattern: express.static(path.resolve(...))
    message: Express static file serving - ensure path is not user-controlled
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [express, path-traversal]

  - id: fs-readfile-user-input
    patterns:
      - pattern: fs.readFileSync(req.$X)
      - pattern: fs.readFileSync(req.$X.$Y)
      - pattern: fs.readFile(req.$X, ...)
      - pattern: fs.readFile(req.$X.$Y, ...)
    message: Reading file with user-controlled path - path traversal vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [node, path-traversal]

  - id: path-normalize-bypass
    pattern: path.normalize($VAR)
    message: path.normalize alone does not prevent traversal - validate path is within allowed directory
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [node, path-traversal]

  # ============================================
  # Header Injection
  # ============================================

  - id: header-injection
    patterns:
      - pattern: res.setHeader($NAME, req.$X)
      - pattern: res.setHeader($NAME, req.$X.$Y)
      - pattern: res.set($NAME, req.$X)
    message: HTTP header set from user input - potential header injection
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, injection]

  # ============================================
  # Timing Attacks
  # ============================================

  - id: timing-safe-compare
    patterns:
      - pattern: $TOKEN === req.$X
      - pattern: req.$X === $TOKEN
      - pattern: $SECRET === $INPUT
    message: Direct string comparison - use crypto.timingSafeEqual for secrets to prevent timing attacks
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [crypto, timing]

  # ============================================
  # Denial of Service
  # ============================================

  - id: regex-dos
    patterns:
      - pattern: new RegExp(req.$X)
      - pattern: new RegExp(req.$X.$Y)
      - pattern: $STR.match(new RegExp($VAR))
      - pattern: $STR.replace(new RegExp($VAR), ...)
    message: Regex with user input - potential ReDoS vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [dos, regex]

  - id: json-parse-large
    pattern: JSON.parse(req.body)
    message: Parsing raw request body - ensure body size limits are enforced
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [dos]

  # ============================================
  # Information Disclosure
  # ============================================

  - id: stack-trace-exposed
    patterns:
      - pattern: res.send(err.stack)
      - pattern: res.json({...})
    message: Stack trace exposed to client - information disclosure
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [info-disclosure]

  - id: verbose-error
    patterns:
      - pattern: 'res.status(500).send(err)'
      - pattern: 'res.status(500).json(err)'
    message: Full error object sent to client - may leak sensitive information
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [info-disclosure]

  # ============================================
  # Insecure Randomness
  # ============================================

  - id: uuid-v1-predictable
    patterns:
      - pattern: uuid.v1()
      - pattern: uuidv1()
    message: UUID v1 is time-based and predictable - use v4 for security-sensitive IDs
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [crypto]

  # ============================================
  # Express.js Security
  # ============================================

  - id: express-cors-wildcard
    pattern: 'cors({origin: "*"})'
    message: CORS allows all origins - restrict to specific domains in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, config]

  - id: express-cors-credentials-wildcard
    pattern: 'cors({origin: "*", credentials: true})'
    message: CORS wildcard with credentials - security risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, config]

  - id: express-session-hardcoded
    patterns:
      - pattern: 'session({secret: "..."})'
      - pattern: "session({secret: '...'})"
    message: Hardcoded session secret - use environment variable
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, secrets]

  - id: express-redirect-open
    pattern: res.redirect(req.$X.$Y)
    message: Redirect using user input - potential open redirect
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, redirect]

  - id: express-sql-injection
    pattern: '$DB.query("SELECT * FROM " + req.$X)'
    message: Express SQL injection via concatenation
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, injection]

  - id: express-nosql-injection-body
    pattern: '$COLL.find(req.body)'
    message: Express MongoDB with raw body - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, injection]

  - id: express-nosql-injection-query
    pattern: '$COLL.find(req.query)'
    message: Express MongoDB with raw query - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, injection]

  # ============================================
  # Core: Weak Cryptography
  # ============================================

  - id: js-weak-hash-md5
    pattern: 'crypto.createHash("md5")'
    message: MD5 is a weak hash function - use SHA-256 or better
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, crypto]

  - id: js-weak-hash-sha1
    pattern: 'crypto.createHash("sha1")'
    message: SHA1 is a weak hash function - use SHA-256 or better
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, crypto]

  - id: js-math-random
    pattern: Math.random()
    message: Math.random() is not cryptographically secure - use crypto.randomBytes()
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [core, crypto]

  - id: js-weak-cipher-des
    pattern: 'crypto.createCipheriv("des", ...)'
    message: DES is a weak cipher - use AES-256-GCM instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-weak-cipher-rc4
    pattern: 'crypto.createCipheriv("rc4", ...)'
    message: RC4 is a broken cipher - use AES-256-GCM instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-weak-cipher-ecb-mode
    pattern-regex: "createCipheriv\\([\"']aes[^\"]*-ecb[\"']"
    message: ECB mode is insecure - use GCM or CBC with proper IV
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-static-iv
    patterns:
      - pattern: 'createCipheriv($ALG, $KEY, "...")'
      - pattern: "createCipheriv($ALG, $KEY, '...')"
    message: Static IV in encryption - IV should be random for each encryption
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  - id: js-crypto-createcipher-deprecated
    pattern: crypto.createCipher(...)
    message: crypto.createCipher is deprecated - use createCipheriv with random IV
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, crypto]

  # ============================================
  # Core: TLS/SSL Issues
  # ============================================

  - id: js-tls-reject-unauthorized
    pattern: rejectUnauthorized = false
    message: TLS certificate verification disabled - MITM attack risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, tls]

  - id: js-node-tls-reject-env
    pattern: 'process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0"'
    message: TLS verification disabled globally - MITM attack risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, tls]

  # ============================================
  # Core: JWT Security
  # ============================================

  - id: js-jwt-none-algorithm
    pattern: '"alg":"none"'
    message: JWT none algorithm - authentication bypass vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  - id: js-jwt-hardcoded-secret
    pattern: 'jwt.sign($PAYLOAD, "...")'
    message: Hardcoded JWT secret - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  - id: js-jwt-verify-hardcoded
    pattern: 'jwt.verify($TOKEN, "...")'
    message: Hardcoded JWT secret - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  - id: js-jwt-verify-disabled
    pattern: 'verify: false'
    message: JWT verification disabled - tokens will not be validated
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, jwt]

  # ============================================
  # Core: SQL/NoSQL Injection
  # ============================================

  - id: js-prisma-queryraw-unsafe
    pattern: prisma.$queryRawUnsafe($QUERY)
    message: Prisma unsafe raw query - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-prisma-executeraw-unsafe
    pattern: prisma.$executeRawUnsafe($QUERY)
    message: Prisma unsafe raw execute - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-sequelize-query-raw
    pattern: sequelize.query($Q, ...)
    message: Raw SQL query - potential injection if not parameterized
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, injection]

  - id: js-knex-raw
    pattern: knex.raw($QUERY)
    message: Knex raw query - potential SQL injection
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, injection]

  - id: js-mongodb-where
    pattern: '$COLL.find({$where: $FUNC})'
    message: MongoDB $where operator - code injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection]

  - id: js-mongodb-where-regex
    pattern-regex: "\\$where\\s*:"
    message: MongoDB $where operator detected - server-side JavaScript injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, nosql-injection]

  - id: js-nosql-operator-injection
    pattern-regex: "req\\.(body|query|params)\\.[^\\s]+\\s*\\[\\s*['\"]\\$"
    message: NoSQL operator from user input - injection risk ($gt, $ne, $regex)
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, nosql-injection]

  - id: js-mongodb-query-user-input
    patterns:
      - pattern: '$COLL.find(req.body)'
      - pattern: '$COLL.find(req.query)'
      - pattern: '$COLL.findOne(req.body)'
      - pattern: '$COLL.findOne(req.query)'
    message: MongoDB query with raw user input - NoSQL injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, nosql-injection]

  - id: js-mongoose-query-user-input
    patterns:
      - pattern: '$MODEL.find(req.body)'
      - pattern: '$MODEL.findOne(req.body)'
      - pattern: '$MODEL.findOneAndUpdate(req.body, ...)'
      - pattern: '$MODEL.updateMany(req.body, ...)'
    message: Mongoose query with raw user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, nosql-injection]

  # ============================================
  # Log Injection / CRLF
  # ============================================

  - id: js-log-injection
    patterns:
      - pattern: 'console.log($MSG + req.body.$PARAM)'
      - pattern: 'console.log($MSG + req.query.$PARAM)'
      - pattern: 'logger.info($MSG + req.body.$PARAM)'
      - pattern: 'logger.info($MSG + req.query.$PARAM)'
    message: Log message with unsanitized user input - log injection risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [log-injection]

  - id: js-log-injection-template
    patterns:
      - pattern: 'console.log(`${req.body.$PARAM}`)'
      - pattern: 'console.log(`${req.query.$PARAM}`)'
      - pattern: 'logger.info(`${req.body.$PARAM}`)'
    message: User input in log template - log injection/CRLF risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [log-injection]

  - id: js-log-injection-comma
    patterns:
      - pattern: 'console.log($MSG, $USER_INPUT)'
      - pattern: 'console.error($MSG, $USER_INPUT)'
      - pattern: 'console.warn($MSG, $USER_INPUT)'
      - pattern: 'logger.info($MSG, $USER_INPUT)'
      - pattern: 'logger.error($MSG, $USER_INPUT)'
      - pattern: 'logger.warn($MSG, $USER_INPUT)'
    message: User variable logged directly - sanitize to prevent log injection/CRLF attacks
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [log-injection]

  - id: js-log-user-input-regex
    pattern-regex: "console\\.(log|error|warn)\\s*\\([^)]*\\b(userName|username|user|email|password|input|query|param)\\b"
    message: Logging user-controlled variable - potential log injection if input contains newlines
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [log-injection]

  - id: js-crlf-header-injection
    patterns:
      - pattern: 'res.setHeader($NAME, req.query.$VALUE)'
      - pattern: 'res.setHeader($NAME, req.body.$VALUE)'
      - pattern: 'res.set($NAME, req.query.$VALUE)'
    message: HTTP header from user input - CRLF/header injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [crlf, header-injection]

  - id: js-drizzle-raw
    pattern: sql.raw($QUERY)
    message: Drizzle raw SQL - injection risk if query contains user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, injection]

  # ============================================
  # Core: SSRF
  # ============================================

  - id: js-fetch-user-input
    pattern: fetch(req.$X.$Y)
    message: Fetch with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: js-fetch-variable-url
    patterns:
      - pattern: fetch($URL)
      - pattern: fetch($URL, ...)
      - pattern-not: 'fetch("...")'
      - pattern-not: "fetch('...')"
      - pattern-not: 'fetch(`...`)'
    message: Fetch with variable URL - potential SSRF if URL is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, ssrf]

  - id: js-axios-user-input
    pattern: axios.get(req.$X.$Y)
    message: Axios GET with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: js-axios-variable-url
    patterns:
      - pattern: axios.get($URL)
      - pattern: axios.post($URL, ...)
      - pattern: axios.put($URL, ...)
      - pattern: axios.delete($URL)
      - pattern: axios($CONFIG)
    message: Axios request with variable URL - potential SSRF if URL is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, ssrf]

  - id: js-axios-post-user-input
    pattern: axios.post(req.$X.$Y, ...)
    message: Axios POST with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: js-http-get-variable
    patterns:
      - pattern: http.get($URL, ...)
      - pattern: https.get($URL, ...)
      - pattern: http.request($URL, ...)
      - pattern: https.request($URL, ...)
    message: HTTP request with variable URL - potential SSRF vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, ssrf]

  - id: js-request-variable-url
    patterns:
      - pattern: request($URL)
      - pattern: request($URL, ...)
      - pattern: request.get($URL)
      - pattern: request.post($URL, ...)
    message: Request library with variable URL - potential SSRF if user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, ssrf]

  - id: js-got-variable-url
    patterns:
      - pattern: got($URL)
      - pattern: got($URL, ...)
      - pattern: got.get($URL)
      - pattern: got.post($URL, ...)
    message: Got library request with variable URL - potential SSRF
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, ssrf]

  - id: js-needle-variable-url
    patterns:
      - pattern: needle($METHOD, $URL, ...)
      - pattern: needle.get($URL, ...)
      - pattern: needle.post($URL, ...)
    message: Needle library request with variable URL - potential SSRF
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, ssrf]

  - id: js-superagent-variable-url
    patterns:
      - pattern: superagent.get($URL)
      - pattern: superagent.post($URL)
      - pattern: superagent($METHOD, $URL)
    message: Superagent request with variable URL - potential SSRF
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, ssrf]

  # ============================================
  # Core: Prototype Pollution
  # ============================================

  - id: js-lodash-merge
    pattern: '_.merge($TARGET, $SRC)'
    message: lodash merge can cause prototype pollution with user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-lodash-defaultsdeep
    pattern: '_.defaultsDeep($TARGET, $SRC)'
    message: lodash defaultsDeep can cause prototype pollution with user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-object-assign-user
    pattern: Object.assign($TARGET, req.$X)
    message: Object.assign with user input - prototype pollution risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-proto-access
    patterns:
      - pattern: $OBJ.__proto__
      - pattern: $OBJ["__proto__"]
      - pattern: "$OBJ['__proto__']"
    message: Direct __proto__ access - potential prototype pollution vector
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, prototype-pollution]

  - id: js-constructor-prototype
    patterns:
      - pattern: $OBJ.constructor.prototype
      - pattern: $OBJ["constructor"]["prototype"]
    message: Constructor prototype access - potential prototype pollution
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, prototype-pollution]

  - id: js-bracket-notation-user-key
    patterns:
      - pattern: $OBJ[req.$X.$Y]
      - pattern: $OBJ[req.$X.$Y] = $VAL
    message: Bracket notation with user-controlled key - prototype pollution risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-recursive-merge
    patterns:
      - pattern: 'function $FUNC($A, $B) { ... for (...) { ... $A[$KEY] = ... } ... }'
    message: Recursive merge function may be vulnerable to prototype pollution
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-lodash-set
    patterns:
      - pattern: '_.set($OBJ, $PATH, $VAL)'
      - pattern: '_.setWith($OBJ, $PATH, $VAL, ...)'
    message: lodash set with dynamic path - potential prototype pollution
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-lodash-zipobjectdeep
    pattern: '_.zipObjectDeep($KEYS, $VALS)'
    message: lodash zipObjectDeep can cause prototype pollution with user-controlled keys
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-deep-extend
    patterns:
      - pattern: deepExtend($TARGET, $SRC)
      - pattern: extend(true, $TARGET, $SRC)
      - pattern: jQuery.extend(true, $TARGET, $SRC)
      - pattern: '$.extend(true, $TARGET, $SRC)'
    message: Deep extend/merge operation - potential prototype pollution if source is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-object-setprototypeof
    pattern: Object.setPrototypeOf($OBJ, $PROTO)
    message: Object.setPrototypeOf can modify prototype chain - verify source is trusted
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-reflect-set
    pattern: Reflect.set($TARGET, $KEY, $VAL)
    message: Reflect.set with dynamic key - potential prototype pollution if key is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  - id: js-object-defineproperty-dynamic
    pattern: Object.defineProperty($OBJ, $KEY, $DESC)
    message: Object.defineProperty with dynamic key - verify key is not user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, prototype-pollution]

  # ============================================
  # Core: Authentication
  # ============================================

  - id: js-password-comparison
    pattern: password === $VAR
    message: Plaintext password comparison - use bcrypt.compare() instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, auth]

  - id: js-timing-attack-comparison
    pattern: $SECRET === req.$X
    message: String comparison may be vulnerable to timing attacks - use crypto.timingSafeEqual
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, auth]

  # ============================================
  # Core: ReDoS
  # ============================================

  - id: js-dynamic-regex
    pattern: new RegExp($PATTERN)
    message: Dynamic regex with user input - potential ReDoS vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, redos]

  # ============================================
  # TypeScript Specific
  # ============================================

  - id: ts-any-type
    pattern-regex: ':\s*any\b'
    message: TypeScript any type bypasses type safety - consider strict typing
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-type-assertion-any
    pattern-regex: '\bas\s+any\b'
    message: Type assertion to any - bypasses type checking
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-non-null-assertion
    pattern: $X!
    message: Non-null assertion - may cause runtime errors if value is null
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-ts-ignore
    pattern: '// @ts-ignore'
    message: "'@ts-ignore suppresses TypeScript errors - review carefully'"
    languages: [typescript]
    severity: WARNING
    metadata:
      tags: [typescript, type-safety]

  - id: ts-ts-expect-error
    pattern: '// @ts-expect-error'
    message: "'@ts-expect-error suppresses TypeScript errors - ensure intentional'"
    languages: [typescript]
    severity: INFO
    metadata:
      tags: [typescript, type-safety]

  - id: ts-unsafe-type-assertion
    pattern: '$X as unknown as $Y'
    message: Double type assertion bypasses type safety entirely
    languages: [typescript]
    severity: WARNING
    metadata:
      tags: [typescript, type-safety]

  # ============================================
  # Supabase/Firebase (common with vibe coders)
  # ============================================

  - id: supabase-service-role-client
    pattern: 'createClient($URL, $SERVICE_ROLE_KEY)'
    message: Supabase service role key in client - should only be used server-side
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [supabase, secrets]

  - id: supabase-rls-bypass
    pattern: '.from($TABLE).select().eq($COL, $VAL)'
    message: Supabase query - ensure RLS policies are enabled for security
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [supabase, auth]

  - id: firebase-admin-client
    pattern: 'admin.initializeApp({credential: admin.credential.cert($KEY)})'
    message: Firebase Admin SDK - ensure credentials are not exposed client-side
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [firebase, secrets]

  - id: firebase-security-rules-disabled
    pattern-regex: '"\\.write"\\s*:\\s*true'
    message: Firebase security rules allow all writes - restrict in production
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [firebase, config]

  # ============================================
  # API Key Exposure
  # ============================================

  - id: js-hardcoded-api-key
    pattern-regex: "(api[_-]?key|apikey)\\s*[=:]\\s*['\"][a-zA-Z0-9]{20,}['\"]"
    message: Hardcoded API key detected - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  - id: js-hardcoded-secret
    pattern-regex: "(secret|password|token)\\s*[=:]\\s*['\"][^'\"]{8,}['\"]"
    message: Hardcoded secret detected - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  # ============================================
  # SQL Injection - Node.js/Express/Sequelize
  # ============================================

  - id: node-sql-string-concat
    patterns:
      - pattern: $DB.query($Q + $INPUT)
      - pattern: $DB.query($Q + req.$X)
      - pattern: $DB.query(`${...}`)
      - pattern: 'connection.query($Q + $INPUT)'
      - pattern: 'connection.query(`${...}`)'
    message: SQL injection - string concatenation in query. Use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sequelize-raw-query
    patterns:
      - pattern: 'sequelize.query($Q + $INPUT)'
      - pattern: 'sequelize.query(`${...}`)'
      - pattern: '$MODEL.sequelize.query($Q + $INPUT)'
    message: Sequelize raw query with string interpolation - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sequelize, injection, sql]

  - id: sequelize-literal-unsafe
    patterns:
      - pattern: 'Sequelize.literal($INPUT)'
      - pattern: 'sequelize.literal($INPUT)'
    message: Sequelize.literal with user input - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sequelize, injection, sql]

  - id: knex-raw-unsafe
    patterns:
      - pattern: 'knex.raw($Q + $INPUT)'
      - pattern: 'knex.raw(`${...}`)'
      - pattern: '$DB.raw($Q + $INPUT)'
    message: Knex raw query with interpolation - use bindings instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [knex, injection, sql]

  - id: mysql-query-unsafe
    patterns:
      - pattern: 'mysql.query($Q + $INPUT)'
      - pattern: 'mysql.query(`${...}`)'
      - pattern: 'pool.query($Q + $INPUT)'
      - pattern: 'pool.query(`${...}`)'
    message: MySQL query with string concatenation - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mysql, injection, sql]

  - id: pg-query-unsafe
    patterns:
      - pattern: 'client.query($Q + $INPUT)'
      - pattern: 'client.query(`${...}`)'
      - pattern: 'pool.query($Q + $INPUT)'
      - pattern: 'pool.query(`${...}`)'
    message: PostgreSQL query with string interpolation - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [postgres, injection, sql]

  # ============================================
  # XSS - Cross-Site Scripting
  # ============================================

  - id: js-innerhtml-xss
    patterns:
      - pattern: '$EL.innerHTML = $INPUT'
      - pattern: 'document.getElementById($ID).innerHTML = $INPUT'
      - pattern: '$EL.outerHTML = $INPUT'
    message: innerHTML assignment - potential XSS if input is user-controlled
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-document-write-xss
    patterns:
      - pattern: 'document.write($INPUT)'
      - pattern: 'document.writeln($INPUT)'
    message: document.write with dynamic content - XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, xss]

  - id: js-insertadjacenthtml-xss
    pattern: '$EL.insertAdjacentHTML($POS, $INPUT)'
    message: insertAdjacentHTML - XSS risk if input is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, xss]

  - id: express-res-send-unsanitized
    patterns:
      - pattern: 'res.send(req.$PARAM)'
      - pattern: 'res.send($INPUT + req.$PARAM)'
    message: Express response reflects user input - potential reflected XSS
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, xss]

  - id: express-res-render-unsanitized
    pattern: 'res.render($TEMPLATE, {$KEY: req.$PARAM})'
    message: User input passed to template - ensure template escapes output
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, xss]

  - id: jquery-html-xss
    patterns:
      - pattern: '$($SEL).html($INPUT)'
      - pattern: '$.html($INPUT)'
    message: jQuery .html() with dynamic content - XSS risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [jquery, xss]

  - id: jquery-append-xss
    patterns:
      - pattern: '$($SEL).append($INPUT)'
      - pattern: '$($SEL).prepend($INPUT)'
      - pattern: '$($SEL).after($INPUT)'
      - pattern: '$($SEL).before($INPUT)'
    message: jQuery DOM insertion with dynamic content - XSS risk if unsanitized
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [jquery, xss]

  # ============================================
  # NoSQL Injection
  # ============================================

  - id: mongodb-nosql-injection
    patterns:
      - pattern: '$COLLECTION.find({$FIELD: req.$PARAM})'
      - pattern: '$COLLECTION.findOne({$FIELD: req.$PARAM})'
      - pattern: '$COLLECTION.findOneAndUpdate({$FIELD: req.$PARAM}, ...)'
      - pattern: '$COLLECTION.deleteOne({$FIELD: req.$PARAM})'
      - pattern: '$COLLECTION.updateOne({$FIELD: req.$PARAM}, ...)'
    message: MongoDB query with direct user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongodb-where-injection
    patterns:
      - pattern: '$COLLECTION.find({$where: $INPUT})'
      - pattern: '$MODEL.find({$where: $INPUT})'
    message: MongoDB $where with user input - code injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongoose-unsafe-query
    patterns:
      - pattern: '$MODEL.find(req.$PARAM)'
      - pattern: '$MODEL.findOne(req.$PARAM)'
      - pattern: '$MODEL.findById(req.$PARAM.$FIELD)'
    message: Mongoose query with unvalidated user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [mongoose, injection, nosql]

  # ============================================
  # SSRF - Server-Side Request Forgery
  # ============================================

  - id: node-ssrf-fetch
    patterns:
      - pattern: 'fetch(req.$PARAM)'
      - pattern: 'fetch($URL + req.$PARAM)'
      - pattern: 'fetch(`${...}${req.$PARAM}...`)'
    message: Server-side fetch with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: node-ssrf-axios
    patterns:
      - pattern: 'axios.get(req.$PARAM)'
      - pattern: 'axios.get($URL + req.$PARAM)'
      - pattern: 'axios.post(req.$PARAM, ...)'
      - pattern: 'axios({url: req.$PARAM})'
    message: Axios request with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [axios, ssrf]

  - id: node-ssrf-request
    patterns:
      - pattern: 'request(req.$PARAM)'
      - pattern: 'request.get(req.$PARAM)'
      - pattern: 'request({url: req.$PARAM})'
    message: HTTP request with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: node-ssrf-http
    patterns:
      - pattern: 'http.get(req.$PARAM, ...)'
      - pattern: 'https.get(req.$PARAM, ...)'
      - pattern: 'http.request({host: req.$PARAM}, ...)'
    message: Native HTTP request with user input - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  # ============================================
  # Path Traversal
  # ============================================

  - id: node-path-traversal
    patterns:
      - pattern: 'fs.readFile($PATH + req.$PARAM, ...)'
      - pattern: 'fs.readFileSync($PATH + req.$PARAM)'
      - pattern: 'fs.readFile(`${...}${req.$PARAM}...`, ...)'
      - pattern: 'path.join($BASE, req.$PARAM)'
    message: Path traversal - user input in file path without validation
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, path-traversal]

  - id: express-sendfile-traversal
    patterns:
      - pattern: 'res.sendFile(req.$PARAM)'
      - pattern: 'res.sendFile($PATH + req.$PARAM)'
      - pattern: 'res.download(req.$PARAM)'
    message: Express file send with user input - path traversal risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, path-traversal]

  - id: node-fs-unvalidated
    patterns:
      - pattern: 'fs.writeFile(req.$PARAM, ...)'
      - pattern: 'fs.unlink(req.$PARAM, ...)'
      - pattern: 'fs.rmdir(req.$PARAM, ...)'
      - pattern: 'fs.mkdir(req.$PARAM, ...)'
    message: File system operation with user-controlled path - validate input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, path-traversal]

  # ============================================
  # XXE - XML External Entity
  # ============================================

  - id: node-xxe-xml2js
    pattern: 'xml2js.parseString($INPUT, ...)'
    message: XML parsing - ensure external entities are disabled to prevent XXE
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  - id: node-xxe-libxmljs
    patterns:
      - pattern: 'libxmljs.parseXml($INPUT)'
      - pattern: 'libxmljs.parseXmlString($INPUT)'
    message: libxmljs XML parsing - disable external entities to prevent XXE
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  - id: node-xxe-domparser
    pattern: 'new DOMParser().parseFromString($INPUT, ...)'
    message: DOMParser XML parsing - potential XXE if processing untrusted XML
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: node-unsafe-deserialize
    patterns:
      - pattern: 'serialize.unserialize($INPUT)'
      - pattern: 'node-serialize.unserialize($INPUT)'
    message: Unsafe deserialization - can lead to remote code execution
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, deserialization]

  - id: node-json-parse-uncaught
    pattern: 'JSON.parse(req.$PARAM)'
    message: JSON.parse on user input without try-catch - may crash on invalid JSON
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [core, error-handling]

  # ============================================
  # IDOR - Insecure Direct Object Reference
  # ============================================

  - id: express-idor-param
    patterns:
      - pattern: '$MODEL.findById(req.params.$ID)'
      - pattern: '$MODEL.findByPk(req.params.$ID)'
      - pattern: '$DB.find({id: req.params.$ID})'
    message: Direct object access using URL parameter - verify user authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, idor, authz]

  # ============================================
  # Authentication/Session Issues
  # ============================================

  - id: express-session-insecure
    patterns:
      - pattern: 'session({secret: $SECRET, cookie: {secure: false}})'
      - pattern: 'session({cookie: {httpOnly: false}})'
    message: Insecure session configuration - enable secure and httpOnly
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, session, auth]

  - id: jwt-none-algorithm
    patterns:
      - pattern: 'jwt.verify($TOKEN, $SECRET, {algorithms: ["none"]})'
      - pattern: 'jwt.decode($TOKEN)'
    message: JWT with none algorithm or decode without verify - authentication bypass
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [jwt, auth]

  - id: bcrypt-low-rounds
    pattern: 'bcrypt.hash($PASS, $ROUNDS)'
    message: Verify bcrypt salt rounds - should be at least 10 for security
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [crypto, auth]

  # ============================================
  # CORS Misconfiguration
  # ============================================

  - id: express-cors-wildcard
    patterns:
      - pattern: "cors({origin: '*'})"
      - pattern: "cors({origin: true})"
      - pattern: 'res.setHeader("Access-Control-Allow-Origin", "*")'
    message: CORS allows all origins - restrict to trusted domains in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, cors]

  - id: express-cors-credentials-wildcard
    pattern: "cors({origin: '*', credentials: true})"
    message: CORS wildcard with credentials - security misconfiguration
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, cors]

  # ============================================
  # Prototype Pollution
  # ============================================

  - id: js-prototype-pollution
    patterns:
      - pattern: '$OBJ[req.$PARAM] = $VALUE'
      - pattern: '$OBJ[$KEY][req.$PARAM] = $VALUE'
      - pattern: 'Object.assign($TARGET, req.$PARAM)'
      - pattern: '_.merge($TARGET, req.$PARAM)'
      - pattern: '_.extend($TARGET, req.$PARAM)'
    message: Potential prototype pollution - validate property names
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, prototype-pollution]

  # ============================================
  # Missing Security Headers
  # ============================================

  - id: express-no-helmet
    pattern: 'express()'
    message: Express app - consider using helmet() for security headers
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [express, headers]

  # ============================================
  # DVNA-Specific Vulnerability Patterns
  # ============================================

  # SQL Injection - String concatenation patterns
  - id: sql-string-concat-login
    pattern-regex: "\"SELECT[^\"]+WHERE[^\"]+='\\s*\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation with user input in WHERE clause
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sql-string-concat-select
    pattern-regex: "\"SELECT[^\"]+\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation in SELECT query
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sql-string-concat-insert
    pattern-regex: "\"INSERT[^\"]+\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation in INSERT query
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sql-string-concat-update
    pattern-regex: "\"UPDATE[^\"]+\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation in UPDATE query
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  - id: sql-string-concat-delete
    pattern-regex: "\"DELETE[^\"]+\"\\s*\\+\\s*req\\."
    message: SQL injection - string concatenation in DELETE query
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, sql]

  # Code Injection - mathjs.eval
  - id: mathjs-eval-injection
    patterns:
      - pattern: 'mathjs.eval($INPUT)'
      - pattern: 'math.eval($INPUT)'
      - pattern: 'mathjs.evaluate($INPUT)'
      - pattern: 'math.evaluate($INPUT)'
    message: Code injection via mathjs eval - user input can execute arbitrary expressions
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, code]

  - id: mathjs-eval-request
    pattern-regex: "math(js)?\\.(eval|evaluate)\\(req\\."
    message: Code injection - mathjs eval with request input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, injection, code]

  # Insecure Deserialization - node-serialize
  - id: node-serialize-unserialize
    patterns:
      - pattern: 'serialize.unserialize(...)'
      - pattern: 'nodeSerialize.unserialize(...)'
      - pattern: 'unserialize(...)'
    message: Insecure deserialization - node-serialize can lead to RCE
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, deserialization, rce]

  - id: node-serialize-regex
    pattern-regex: "serialize\\.unserialize\\("
    message: Insecure deserialization via node-serialize - remote code execution risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, deserialization, rce]

  # XXE - libxmljs with noent:true
  - id: libxmljs-xxe-noent
    pattern-regex: "libxmljs\\.parseXml(String)?\\([^,]+,\\s*\\{[^}]*noent\\s*:\\s*true"
    message: XXE vulnerability - libxmljs with noent:true enables external entity processing
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [xml, xxe]

  - id: xml-external-entities
    pattern-regex: "\\{[^}]*noent\\s*:\\s*true[^}]*\\}"
    message: XML external entity processing enabled - potential XXE vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xml, xxe]

  # Open Redirect - res.redirect with user input
  - id: express-open-redirect
    patterns:
      - pattern: 'res.redirect(req.body.$PARAM)'
      - pattern: 'res.redirect(req.query.$PARAM)'
      - pattern: 'res.redirect(req.params.$PARAM)'
    message: Open redirect - user-controlled redirect destination
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, redirect]

  - id: open-redirect-regex
    pattern-regex: "res\\.redirect\\(req\\.(body|query|params)\\."
    message: Open redirect vulnerability - validate redirect URL against whitelist
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, redirect]

  # Stored XSS via database
  - id: stored-xss-db-to-html
    patterns:
      - pattern: 'res.send($DATA)'
      - pattern: 'res.send(`${$DATA}`)'
    message: Response may contain unsanitized data - potential stored XSS
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [express, xss]

  # SSRF via user-controlled URLs
  - id: ssrf-needle
    patterns:
      - pattern: 'needle($METHOD, req.$PARAM.$FIELD, ...)'
      - pattern: 'needle.get(req.$PARAM.$FIELD, ...)'
      - pattern: 'needle.post(req.$PARAM.$FIELD, ...)'
    message: SSRF - needle HTTP request with user-controlled URL
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  - id: ssrf-got
    patterns:
      - pattern: 'got(req.$PARAM.$FIELD)'
      - pattern: 'got.get(req.$PARAM.$FIELD)'
    message: SSRF - got HTTP request with user-controlled URL
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, ssrf]

  # Hardcoded credentials detection
  - id: hardcoded-db-password
    pattern-regex: "(password|passwd|pwd)\\s*[=:]\\s*['\"][^'\"]{4,}['\"]"
    message: Hardcoded database password detected - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  - id: hardcoded-db-connection
    pattern-regex: "(mysql|postgres|mongodb)://[^:]+:[^@]+@"
    message: Hardcoded database credentials in connection string
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, secrets]

  # Weak crypto
  - id: crypto-weak-hash-password
    pattern-regex: "createHash\\(['\"]md5['\"]\\)"
    message: MD5 is cryptographically weak - do not use for passwords
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [crypto]

  # Missing input validation
  - id: express-unvalidated-body
    patterns:
      - pattern: 'db.query($Q, [req.body.$FIELD])'
      - pattern: '$MODEL.create(req.body)'
      - pattern: '$MODEL.update(req.body)'
    message: User input passed directly to database - add input validation
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, validation]

  # File upload vulnerabilities
  - id: multer-no-filefilter
    pattern: 'multer({dest: $DEST})'
    message: Multer without file type validation - may allow malicious uploads
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, upload]

  # Information disclosure
  - id: express-stack-trace
    pattern: 'res.send(err.stack)'
    message: Stack trace exposed to client - information disclosure
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, disclosure]

  - id: express-error-details
    pattern: 'res.status($CODE).send(err)'
    message: Full error object sent to client - may leak sensitive info
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [express, disclosure]

  # ============================================
  # MongoDB/Mongoose NoSQL Injection (Enhanced)
  # ============================================

  - id: mongodb-find-user-input
    patterns:
      - pattern: '$COLL.find({$FIELD: req.body.$PARAM})'
      - pattern: '$COLL.find({$FIELD: req.query.$PARAM})'
      - pattern: '$COLL.find({$FIELD: req.params.$PARAM})'
      - pattern: '$COLL.findOne({$FIELD: req.body.$PARAM})'
      - pattern: '$COLL.findOne({$FIELD: req.query.$PARAM})'
    message: MongoDB query with user input - NoSQL injection risk, sanitize input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongodb-update-user-input
    patterns:
      - pattern: '$COLL.update({$FIELD: req.body.$PARAM}, ...)'
      - pattern: '$COLL.updateOne({$FIELD: req.body.$PARAM}, ...)'
      - pattern: '$COLL.updateMany({$FIELD: req.body.$PARAM}, ...)'
      - pattern: '$COLL.findOneAndUpdate({$FIELD: req.body.$PARAM}, ...)'
    message: MongoDB update with user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongodb-delete-user-input
    patterns:
      - pattern: '$COLL.remove({$FIELD: req.body.$PARAM})'
      - pattern: '$COLL.deleteOne({$FIELD: req.body.$PARAM})'
      - pattern: '$COLL.deleteMany({$FIELD: req.body.$PARAM})'
    message: MongoDB delete with user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  - id: mongoose-find-user-input
    patterns:
      - pattern: '$MODEL.find(req.body)'
      - pattern: '$MODEL.find(req.query)'
      - pattern: '$MODEL.findOne(req.body)'
      - pattern: '$MODEL.findOne(req.query)'
      - pattern: '$MODEL.findById(req.body.$PARAM)'
      - pattern: '$MODEL.findById(req.params.$PARAM)'
    message: Mongoose query with unvalidated user input - NoSQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongoose, injection, nosql]

  - id: mongodb-regex-user-input
    patterns:
      - pattern: '{$regex: req.$PARAM}'
      - pattern: '{$FIELD: {$regex: $INPUT}}'
      - pattern: 'new RegExp(req.$PARAM.$FIELD)'
    message: MongoDB regex with user input - ReDoS and injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, redos]

  - id: mongodb-operator-injection
    pattern-regex: "\\{\\s*\\$[a-z]+\\s*:\\s*req\\.(body|query|params)"
    message: MongoDB operator injection - user input may contain $ operators
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [mongodb, injection, nosql]

  # ============================================
  # XSS - Template Rendering (Swig, EJS, Pug)
  # ============================================

  - id: swig-render-user-input
    patterns:
      - pattern: 'swig.render($TEMPLATE, {$KEY: req.$PARAM})'
      - pattern: 'swig.renderFile($FILE, {$KEY: req.$PARAM})'
    message: Swig template with user input - potential XSS if not escaped
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [swig, xss, template]

  - id: ejs-render-user-input
    patterns:
      - pattern: 'ejs.render($TEMPLATE, {$KEY: req.$PARAM})'
      - pattern: 'ejs.renderFile($FILE, {$KEY: req.$PARAM})'
      - pattern: 'res.render($VIEW, {$KEY: req.body.$PARAM})'
      - pattern: 'res.render($VIEW, {$KEY: req.query.$PARAM})'
    message: Template render with user input - ensure output is escaped
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ejs, xss, template]

  - id: pug-render-unescaped
    pattern-regex: '!\s*[{=]\s*\w+'
    message: Pug unescaped output - XSS risk if variable contains user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [pug, xss, template]

  - id: handlebars-triple-stache
    pattern-regex: "\\{\\{\\{[^}]+\\}\\}\\}"
    message: Handlebars triple-mustache bypasses escaping - XSS risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [handlebars, xss, template]

  - id: express-send-html-user-input
    patterns:
      - pattern: 'res.send("<html>" + $INPUT)'
      - pattern: 'res.send(`<html>${$INPUT}`)'
      - pattern: 'res.send("<div>" + req.$PARAM)'
    message: HTML response with user input - XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [express, xss]

  - id: express-write-html
    patterns:
      - pattern: 'res.write("<" + $INPUT)'
      - pattern: 'res.write(`<${$INPUT}`)'
    message: Writing HTML with dynamic content - XSS risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [express, xss]

  # ============================================
  # Authorization/IDOR Patterns
  # ============================================

  - id: idor-direct-param-access
    patterns:
      - pattern: '$MODEL.findById(req.params.id)'
      - pattern: '$MODEL.findById(req.params.$ID)'
      - pattern: '$COLL.findOne({_id: req.params.$ID})'
    message: Direct object access via URL param - verify user authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [authz, idor]

  - id: idor-missing-owner-check
    patterns:
      - pattern: |
          $MODEL.findById($ID)
          ...
          res.json($DATA)
      - pattern: |
          $MODEL.findOne({_id: $ID})
          ...
          res.send($DATA)
    message: Object lookup without ownership verification - potential IDOR
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [authz, idor]

  - id: auth-bypass-admin-check
    patterns:
      - pattern: 'if (req.body.isAdmin)'
      - pattern: 'if (req.query.admin)'
      - pattern: 'if (req.body.role === "admin")'
    message: Admin check using user-supplied input - authentication bypass
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [authz, bypass]

  # ============================================
  # SSRF Patterns (Enhanced)
  # ============================================

  - id: ssrf-url-user-input
    patterns:
      - pattern: 'new URL(req.body.$PARAM)'
      - pattern: 'new URL(req.query.$PARAM)'
      - pattern: 'url.parse(req.body.$PARAM)'
      - pattern: 'url.parse(req.query.$PARAM)'
    message: URL parsing user input - validate against allowlist for SSRF prevention
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ssrf, url]

  - id: ssrf-image-fetch
    patterns:
      - pattern: 'fetch(req.body.imageUrl)'
      - pattern: 'fetch(req.body.url)'
      - pattern: 'axios.get(req.body.url)'
      - pattern: 'request(req.body.url)'
    message: Fetching user-supplied URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssrf]

  - id: ssrf-dns-rebinding
    pattern-regex: "(fetch|axios|request|http\\.get)\\(.*req\\.(body|query)\\."
    message: HTTP request with user-controlled URL - SSRF/DNS rebinding risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssrf]

  # ============================================
  # Session Security
  # ============================================

  - id: session-fixation
    patterns:
      - pattern: 'req.session = req.body.$PARAM'
      - pattern: 'req.session.id = req.$PARAM'
    message: Session assignment from user input - session fixation risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [session, fixation]

  - id: session-no-regenerate
    pattern: |
      req.session.user = $USER
      ...
      res.redirect($URL)
    message: Session not regenerated after login - session fixation risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [session, fixation]

  - id: cookie-no-httponly
    pattern: "res.cookie($NAME, $VALUE, {httpOnly: false})"
    message: Cookie without httpOnly flag - vulnerable to XSS theft
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [cookie, session]

  - id: cookie-no-secure
    pattern: "res.cookie($NAME, $VALUE, {secure: false})"
    message: Cookie without secure flag - sent over HTTP
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [cookie, session]

  # ============================================
  # Sensitive Data Exposure
  # ============================================

  - id: password-in-response
    patterns:
      - pattern: 'res.json({password: $PASS})'
      - pattern: 'res.send({password: $PASS})'
      - pattern: 'res.json($USER)'
    message: Potentially exposing password in response - exclude sensitive fields
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [data-exposure]

  - id: user-enumeration
    patterns:
      - pattern: 'res.send("User not found")'
      - pattern: 'res.send("Invalid username")'
      - pattern: 'res.json({error: "User does not exist"})'
    message: User enumeration - use generic error messages
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [auth, enumeration]

  - id: verbose-error-message
    patterns:
      - pattern: 'res.send(err.message)'
      - pattern: 'res.json({error: err.message})'
      - pattern: 'res.status($CODE).json({error: $ERR.message})'
    message: Verbose error messages may leak sensitive information
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [disclosure]

  # ============================================
  # Insecure Crypto
  # ============================================

  - id: crypto-weak-key
    patterns:
      - pattern: 'crypto.createCipheriv($ALG, $KEY, ...)'
      - pattern: 'crypto.pbkdf2($PASS, $SALT, $ITER, ...)'
    message: Review crypto parameters - ensure adequate key size and iterations
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [crypto]

  - id: password-plaintext-storage
    patterns:
      - pattern: 'user.password = req.body.password'
      - pattern: '{password: req.body.password}'
    message: Storing password - ensure it's hashed with bcrypt/argon2
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, crypto]

  - id: password-md5-hash
    patterns:
      - pattern: 'crypto.createHash("md5").update(password)'
      - pattern: 'md5(password)'
    message: MD5 is not suitable for password hashing - use bcrypt
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, crypto]

  # ============================================
  # Server-Side Template Injection (SSTI)
  # ============================================

  - id: nunjucks-renderstring-ssti
    patterns:
      - pattern: nunjucks.renderString($INPUT)
      - pattern: nunjucks.renderString(req.query.$PARAM)
      - pattern: nunjucks.renderString(req.body.$PARAM)
      - pattern: nunjucks.renderString(req.params.$PARAM)
    message: Nunjucks renderString with user input - SSTI vulnerability (RCE possible)
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssti, rce]

  - id: nunjucks-ssti-variable
    patterns:
      - pattern: |
          $MSG = req.query.$PARAM
          ...
          nunjucks.renderString($MSG)
      - pattern: |
          $MSG = req.body.$PARAM
          ...
          nunjucks.renderString($MSG)
    message: Variable from user input passed to nunjucks.renderString - SSTI/RCE
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssti, rce]

  - id: nunjucks-ssti-regex
    pattern-regex: "nunjucks\\.renderString\\s*\\("
    message: nunjucks.renderString usage - ensure input is not user-controlled (SSTI risk)
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ssti]

  - id: pug-render-user-input
    patterns:
      - pattern: pug.render($USER_INPUT)
      - pattern: pug.compile($USER_INPUT)
    message: Pug render with user input - SSTI vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssti, rce]

  - id: ejs-render-user-input
    patterns:
      - pattern: ejs.render($INPUT, ...)
      - pattern: ejs.compile($INPUT)
    message: EJS render with user input - potential SSTI
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ssti]

  - id: mustache-render-user-input
    pattern: Mustache.render($TEMPLATE, ...)
    message: Mustache render - ensure template is not user-controlled
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [ssti]

  # ============================================
  # XSS via Redirect
  # ============================================

  - id: xss-redirect-concat
    patterns:
      - pattern: 'res.redirect($BASE + req.query.$PARAM)'
      - pattern: 'res.redirect($BASE + req.body.$PARAM)'
      - pattern: 'res.redirect("..." + $USER_INPUT)'
    message: Redirect with concatenated user input - XSS/open redirect risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xss, redirect]

  - id: xss-redirect-template
    patterns:
      - pattern: 'res.redirect(`${$BASE}${req.query.$PARAM}`)'
      - pattern: 'res.redirect(`...${$USER_INPUT}...`)'
    message: Redirect with template literal user input - XSS/open redirect risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xss, redirect]

  - id: xss-redirect-url-param-concat
    pattern-regex: "res\\.redirect\\s*\\(\\s*[\"'][^\"']*\\?\\w+=[\"']?\\s*\\+\\s*\\w+"
    message: Redirect URL with concatenated parameter - XSS/injection risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xss, redirect]

  # ============================================
  # JWT Security Issues
  # ============================================

  - id: jwt-decode-no-verify
    patterns:
      - pattern: jwt.decode($TOKEN)
      - pattern: jwt.decode($TOKEN, ...)
    message: jwt.decode() without verification - use jwt.verify() instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, jwt]

  - id: jwt-verify-no-algorithm
    pattern: 'jwt.verify($TOKEN, $SECRET)'
    message: jwt.verify without algorithm option - specify algorithms array
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, jwt]

  - id: jwt-none-algorithm
    patterns:
      - pattern: 'jwt.sign($PAYLOAD, $SECRET, {algorithm: "none"})'
      - pattern: '{algorithms: ["none"]}'
    message: JWT none algorithm - authentication bypass vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, jwt]

  # ============================================
  # IDOR / Missing Authorization
  # ============================================

  - id: express-route-no-auth-delete
    pattern-regex: "app\\.(delete|del)\\(['\"][^'\"]+/:id['\"]"
    message: DELETE route with ID param - verify authorization check exists
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, auth]

  - id: express-route-no-auth-put
    pattern-regex: "app\\.put\\(['\"][^'\"]+/:id['\"]"
    message: PUT route with ID param - verify authorization check exists
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, auth]

  - id: sequelize-find-by-id-param
    patterns:
      - pattern: '$MODEL.findByPk(req.params.id)'
      - pattern: '$MODEL.findByPk(req.params.$ID)'
      - pattern: '$MODEL.findOne({where: {id: req.params.id}})'
    message: Direct object lookup by URL param - ensure authorization check
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola]

  - id: mongoose-find-by-id-param
    patterns:
      - pattern: '$MODEL.findById(req.params.id)'
      - pattern: '$MODEL.findById(req.params.$ID)'
    message: MongoDB findById with URL param - verify authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola]

  # ============================================
  # Weak Password Handling
  # ============================================

  - id: plaintext-password-compare
    patterns:
      - pattern: '$USER.password == $INPUT'
      - pattern: '$INPUT == $USER.password'
      - pattern: 'password == user.password'
      - pattern: 'user.password == password'
      - pattern: '$VAR[0].password == $INPUT'
      - pattern: '$INPUT == $VAR[0].password'
    message: Plaintext password comparison - use bcrypt.compare()
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, crypto]

  - id: md5-password-compare
    patterns:
      - pattern: 'md5($PASSWORD) == $USER.password'
      - pattern: '$USER.password == md5($PASSWORD)'
      - pattern: 'md5($VAR.password) == $INPUT'
      - pattern: '$INPUT == md5($VAR.password)'
      - pattern: 'md5($VAR[0].password) == $INPUT'
    message: MD5 password comparison - use bcrypt instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, crypto]

  - id: weak-password-compare-regex
    pattern-regex: "\\.(password)\\s*==\\s*\\w+|\\w+\\s*==\\s*\\w+\\.password"
    message: Direct password comparison detected - use bcrypt.compare() for secure comparison
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, crypto]

  # ============================================
  # Session Security
  # ============================================

  - id: session-regenerate-missing
    pattern-regex: "req\\.session\\.user\\s*="
    message: Session user assignment - call req.session.regenerate() to prevent fixation
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [session, auth]

  - id: session-secret-weak
    patterns:
      - pattern: 'session({secret: "secret"})'
      - pattern: 'session({secret: "keyboard cat"})'
      - pattern: "session({secret: 'secret'})"
    message: Weak session secret - use strong random secret
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [session]

  # ============================================
  # SSRF Patterns
  # ============================================

  - id: axios-ssrf-user-url
    patterns:
      - pattern: 'axios.get(req.body.$URL)'
      - pattern: 'axios.get(req.query.$URL)'
      - pattern: 'axios.post(req.body.$URL, ...)'
      - pattern: 'axios($CONFIG)'
    message: Axios request with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [ssrf]

  - id: fetch-ssrf-user-url
    patterns:
      - pattern: 'fetch(req.body.$URL)'
      - pattern: 'fetch(req.query.$URL)'
      - pattern: 'fetch(req.params.$URL)'
    message: Fetch with user-controlled URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [ssrf]

  # ============================================
  # Path Traversal
  # ============================================

  - id: path-traversal-join
    patterns:
      - pattern: 'path.join($BASE, req.params.$FILE)'
      - pattern: 'path.join($BASE, req.query.$FILE)'
      - pattern: 'path.join($BASE, req.body.$FILE)'
    message: Path join with user input - validate and sanitize for path traversal
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [path-traversal]

  - id: fs-read-user-path
    patterns:
      - pattern: 'fs.readFile(req.params.$FILE, ...)'
      - pattern: 'fs.readFileSync(req.query.$FILE)'
      - pattern: 'fs.createReadStream(req.body.$FILE)'
    message: File read with user input - path traversal vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [path-traversal]

  - id: res-sendfile-user-path
    patterns:
      - pattern: 'res.sendFile(req.params.$FILE)'
      - pattern: 'res.sendFile(req.query.$FILE)'
      - pattern: 'res.download(req.params.$FILE)'
    message: sendFile/download with user input - path traversal risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [path-traversal]

  # ============================================
  # Mass Assignment
  # ============================================

  - id: sequelize-mass-assignment
    patterns:
      - pattern: '$MODEL.create(req.body)'
      - pattern: '$MODEL.update(req.body, ...)'
      - pattern: '$INSTANCE.update(req.body)'
    message: Sequelize create/update with full req.body - mass assignment risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [mass-assignment]

  - id: mongoose-mass-assignment
    patterns:
      - pattern: 'new $MODEL(req.body)'
      - pattern: '$MODEL.findByIdAndUpdate($ID, req.body)'
      - pattern: '$DOC.set(req.body)'
    message: Mongoose with full req.body - mass assignment vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [mass-assignment]

  # ============================================
  # Missing Security Headers
  # ============================================

  - id: missing-helmet
    pattern: 'const app = express()'
    message: Express app - consider using helmet() for security headers
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [headers]

  - id: cors-wildcard-credentials
    patterns:
      - pattern: 'cors({origin: "*", credentials: true})'
      - pattern: 'cors({origin: true, credentials: true})'
    message: CORS wildcard with credentials - security misconfiguration
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [cors]

  # ============================================
  # SQL Injection (Sequelize)
  # ============================================

  - id: sequelize-raw-query
    patterns:
      - pattern: 'sequelize.query($QUERY)'
      - pattern: '$DB.query($QUERY)'
    message: Sequelize raw query - ensure parameterized
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [sqli]

  - id: sequelize-literal-user-input
    patterns:
      - pattern: 'Sequelize.literal(req.body.$FIELD)'
      - pattern: 'Sequelize.literal(req.query.$FIELD)'
      - pattern: 'sequelize.literal($USER_INPUT)'
    message: Sequelize.literal with user input - SQL injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sqli]

  - id: sequelize-query-template-literal
    pattern-regex: "sequelize\\.query\\s*\\(\\s*`[^`]*\\$\\{[^}]*req\\."
    message: Sequelize query with template literal user input - SQL injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sqli]

  - id: sql-template-literal-injection
    pattern-regex: "`SELECT[^`]*\\$\\{[^}]*(req\\.|user|input|param)"
    message: SQL query with template literal interpolation - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sqli]

  - id: sql-string-concat-injection
    pattern-regex: "['\"]SELECT[^'\"]*['\"]\\s*\\+\\s*(req\\.|user|input)"
    message: SQL query with string concatenation - SQL injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sqli]

  - id: sql-where-interpolation
    pattern-regex: "WHERE[^`'\"]*=\\s*['\"]?\\s*\\$\\{[^}]*(req\\.|user)"
    message: SQL WHERE clause with user interpolation - SQL injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sqli]

  - id: models-sequelize-query-unsafe
    patterns:
      - pattern: 'models.sequelize.query(`...$REQ...`)'
      - pattern: 'models.sequelize.query(`...${req.body.$FIELD}...`)'
      - pattern: 'models.sequelize.query(`...${req.query.$FIELD}...`)'
    message: Sequelize query with interpolated user input - SQL injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [sqli]

  # ============================================
  # User Enumeration
  # ============================================

  - id: user-enumeration-error
    patterns:
      - pattern: 'res.send("User not found")'
      - pattern: 'res.json({error: "User not found"})'
      - pattern: 'res.send("Invalid username")'
      - pattern: '"User does not exist"'
    message: User enumeration - use generic error message
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, enumeration]

  - id: user-enumeration-password
    patterns:
      - pattern: 'res.send("Wrong password")'
      - pattern: 'res.json({error: "Incorrect password"})'
      - pattern: '"Password is incorrect"'
    message: Password error reveals user exists - use generic error
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [auth, enumeration]

  # ============================================
  # Enhanced IDOR/BOLA Detection
  # ============================================

  - id: idor-query-id-to-function
    patterns:
      - pattern: '$FUNC(req.query.id)'
      - pattern: '$FUNC(req.query.id, ...)'
      - pattern: '$FUNC(req.params.id)'
      - pattern: '$FUNC(req.params.id, ...)'
      - pattern: '$FUNC(req.body.id)'
      - pattern: '$FUNC(req.body.id, ...)'
    message: Function called with user-controlled ID - verify authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola]

  - id: idor-sequelize-query-id
    patterns:
      - pattern: '$MODEL.findOne({where: {id: req.query.id}})'
      - pattern: '$MODEL.findOne({where: {id: req.params.id}})'
      - pattern: '$MODEL.findOne({where: {id: req.body.id}})'
      - pattern: '$MODEL.update($DATA, {where: {id: req.query.id}})'
      - pattern: '$MODEL.update($DATA, {where: {id: req.body.id}})'
      - pattern: '$MODEL.destroy({where: {id: req.query.id}})'
      - pattern: '$MODEL.destroy({where: {id: req.params.id}})'
    message: Sequelize query with user-controlled ID - IDOR risk without auth check
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola, sequelize]

  - id: idor-knex-query-id
    patterns:
      - pattern: '$DB($TABLE).where({id: req.query.id})'
      - pattern: '$DB($TABLE).where({id: req.params.id})'
      - pattern: '$DB($TABLE).where("id", req.query.id)'
      - pattern: '$DB.select(...).where({id: req.params.id})'
    message: Knex query with user-controlled ID - verify authorization
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola, knex]

  - id: idor-prisma-query-id
    patterns:
      - pattern: 'prisma.$MODEL.findUnique({where: {id: req.params.id}})'
      - pattern: 'prisma.$MODEL.findUnique({where: {id: req.query.id}})'
      - pattern: 'prisma.$MODEL.update({where: {id: req.body.id}, ...})'
      - pattern: 'prisma.$MODEL.delete({where: {id: req.params.id}})'
    message: Prisma query with user-controlled ID - IDOR risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola, prisma]

  # ============================================
  # XSS in Express Views
  # ============================================

  - id: xss-res-send-user-input
    patterns:
      - pattern: 'res.send(req.query.$PARAM)'
      - pattern: 'res.send(req.body.$PARAM)'
      - pattern: 'res.send(req.params.$PARAM)'
      - pattern: 'res.send("<..." + req.query.$PARAM + "...")'
      - pattern: 'res.send(`$X${req.query.$PARAM}$Y`)'
      - pattern: 'res.send(`$X${req.body.$PARAM}$Y`)'
      - pattern: 'res.send(`$X${req.params.$PARAM}$Y`)'
    message: Response with user input - XSS risk without encoding
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [xss]

  - id: xss-res-send-template-literal-regex
    pattern-regex: "res\\.send\\s*\\(\\s*`[^`]*\\$\\{[^}]*(req\\.(query|body|params)|user)"
    message: res.send() with template literal containing user input - XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [xss]

  - id: xss-template-variable-unescaped
    patterns:
      - pattern: 'res.render($TEMPLATE, {$VAR: req.query.$PARAM})'
      - pattern: 'res.render($TEMPLATE, {$VAR: req.body.$PARAM})'
    message: User input passed to template - ensure template escapes output
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xss]

  - id: xss-ejs-unescaped
    pattern-regex: "<%[-=]\\s*[^%]*req\\.(query|body|params)"
    message: EJS template with user input - use <%= for escaping
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [xss, ejs]

  # ============================================
  # Path Traversal (Enhanced)
  # ============================================

  - id: path-traversal-resolve
    patterns:
      - pattern: 'path.resolve($BASE, req.query.$FILE)'
      - pattern: 'path.resolve($BASE, req.params.$FILE)'
      - pattern: 'path.resolve($BASE, req.body.$FILE)'
    message: path.resolve with user input - path traversal risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [path-traversal]

  - id: path-traversal-concat
    patterns:
      - pattern: '$DIR + "/" + req.query.$FILE'
      - pattern: '$DIR + "/" + req.params.$FILE'
      - pattern: '`${$DIR}/${req.query.$FILE}`'
      - pattern: '`${$DIR}/${req.params.$FILE}`'
    message: Path concatenation with user input - path traversal vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [path-traversal]

  # ============================================
  # Broken Access Control
  # ============================================

  - id: broken-access-admin-param
    patterns:
      - pattern: 'if (req.query.admin)'
      - pattern: 'if (req.body.admin)'
      - pattern: 'if (req.query.isAdmin)'
      - pattern: 'if (req.body.isAdmin)'
      - pattern: 'if (req.body.role === "admin")'
    message: Admin/role check from user input - privilege escalation risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [auth, privilege-escalation]

  - id: broken-access-user-id-comparison
    patterns:
      - pattern: 'if (req.user.id == req.params.id)'
      - pattern: 'if (req.user.id === req.params.id)'
      - pattern: 'req.params.id == req.user.id'
    message: User ID comparison - ensure proper authorization logic
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [auth, idor]

  # ============================================
  # Sensitive Data Exposure
  # ============================================

  - id: sensitive-data-password-response
    patterns:
      - pattern: 'res.json({..., password: $PASS, ...})'
      - pattern: 'res.send({..., password: $PASS, ...})'
      - pattern: '{password: user.password}'
      - pattern: '{password: $USER.password}'
    message: Password in API response - remove sensitive field
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [data-exposure]

  - id: sensitive-data-token-response
    patterns:
      - pattern: 'res.json({..., token: $TOKEN, ...})'
      - pattern: 'console.log($MSG, token)'
      - pattern: 'console.log($MSG, $USER.token)'
    message: Token may be exposed - verify intentional
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [data-exposure]

  # ============================================
  # Input Validation Issues
  # ============================================

  - id: no-input-validation-parseInt
    patterns:
      - pattern: 'parseInt(req.query.$PARAM)'
      - pattern: 'parseInt(req.body.$PARAM)'
      - pattern: 'Number(req.query.$PARAM)'
    message: Parsing user input - handle NaN and invalid values
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [validation]

  - id: json-parse-user-input
    patterns:
      - pattern: 'JSON.parse(req.body.$PARAM)'
      - pattern: 'JSON.parse(req.query.$PARAM)'
    message: JSON.parse on user input - handle parse errors
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [validation]

  # ============================================
  # Logging Sensitive Data
  # ============================================

  - id: logging-password
    patterns:
      - pattern: 'console.log($MSG, password)'
      - pattern: 'console.log($MSG, req.body.password)'
      - pattern: 'logger.info($MSG, password)'
    message: Password logged - remove from logs
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [logging, data-exposure]

  - id: logging-full-request
    patterns:
      - pattern: 'console.log(req.body)'
      - pattern: 'console.log(req)'
      - pattern: 'logger.debug(req.body)'
    message: Full request body logged - may contain sensitive data
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [logging]

  # ============================================
  # Insecure Randomness
  # ============================================

  - id: math-random-security
    patterns:
      - pattern: 'Math.random()'
    message: Math.random() is not cryptographically secure - use crypto.randomBytes
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [crypto]

  - id: insecure-token-generation
    patterns:
      - pattern: 'Math.random().toString(36)'
      - pattern: 'Math.random().toString(16)'
    message: Insecure token generation - use crypto.randomBytes or uuid
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [crypto, auth]

  # ============================================
  # A04: Insecure Design Patterns
  # ============================================

  - id: no-rate-limit-login
    pattern-regex: "app\\.(post|put)\\s*\\(\\s*['\"]/(login|auth|signin|authenticate)['\"]"
    message: Login endpoint without visible rate limiting - add rate-limiter-flexible or express-rate-limit
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a04, rate-limit, auth]

  - id: no-rate-limit-password-reset
    pattern-regex: "app\\.(post|put)\\s*\\(\\s*['\"]/(forgot|reset|password)[^'\"]*['\"]"
    message: Password reset endpoint - ensure rate limiting is applied
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a04, rate-limit]

  - id: hardcoded-admin-bypass
    patterns:
      - pattern: 'if (user.role === "admin")'
      - pattern: 'if (role === "admin")'
      - pattern: 'user.isAdmin === true'
    message: Hardcoded admin check - ensure proper RBAC implementation
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a04, rbac]

  # ============================================
  # A07: Identification and Authentication Failures
  # ============================================

  - id: jwt-no-expiry
    pattern: 'jwt.sign($PAYLOAD, $SECRET)'
    message: JWT sign without expiresIn option - tokens should expire
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a07, jwt, auth]

  - id: jwt-long-expiry
    pattern-regex: "expiresIn:\\s*['\"]\\d+d['\"]"
    message: JWT with multi-day expiry - consider shorter token lifetimes
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a07, jwt]

  - id: session-no-expiry
    pattern: 'session({secret: $SECRET})'
    message: Session without maxAge/expires - sessions should timeout
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a07, session]

  - id: cookie-no-httponly
    patterns:
      - pattern: 'res.cookie($NAME, $VALUE)'
      - pattern: 'res.cookie($NAME, $VALUE, {secure: true})'
    message: Cookie without httpOnly flag - vulnerable to XSS theft
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a07, cookie]

  - id: password-min-length-weak
    pattern-regex: "(password|pwd)\\.length\\s*(<|<=|>=|>)\\s*[1-7][^0-9]"
    message: Weak password length requirement - use at least 8 characters
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a07, password]

  - id: no-account-lockout
    pattern-regex: "failedAttempts|loginAttempts|attempts"
    message: Failed login tracking found - ensure account lockout is implemented
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a07, brute-force]

  # ============================================
  # A08: Software and Data Integrity Failures
  # ============================================

  - id: npm-install-no-lockfile
    pattern-regex: "npm install(?!.*--frozen-lockfile)(?!.*--ci)"
    message: npm install without lockfile integrity - use npm ci in CI/CD
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a08, supply-chain]

  - id: eval-json-parse
    patterns:
      - pattern: 'eval("(" + $DATA + ")")'
      - pattern: 'eval($JSON_STRING)'
    message: eval() for JSON parsing - use JSON.parse() instead
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a08, deserialization]

  - id: yaml-load-unsafe
    patterns:
      - pattern: 'yaml.load($DATA)'
      - pattern: 'YAML.parse($DATA)'
    message: YAML load may execute code - use yaml.safeLoad or safe schema
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a08, deserialization]

  - id: child-process-curl-pipe
    pattern-regex: "exec\\(['\"]curl[^'\"]*\\|[^'\"]*['\"]"
    message: curl piped to shell - download and verify before executing
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a08, command-injection]

  - id: script-integrity-missing
    pattern-regex: "<script[^>]+src=['\"]https?://[^'\"]+['\"][^>]*>"
    message: External script without integrity attribute - add SRI hash
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [a08, integrity]

  # ============================================
  # A10: Server-Side Request Forgery (SSRF)
  # ============================================

  - id: ssrf-url-constructor
    patterns:
      - pattern: 'new URL(req.body.$PARAM)'
      - pattern: 'new URL(req.query.$PARAM)'
      - pattern: 'new URL($USER_INPUT)'
    message: URL constructed from user input - validate against SSRF
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-got-request
    patterns:
      - pattern: 'got(req.body.$URL)'
      - pattern: 'got(req.query.$URL)'
      - pattern: 'got.get(req.body.$URL)'
    message: got HTTP request with user URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-request-library
    patterns:
      - pattern: 'request(req.body.$URL)'
      - pattern: 'request.get(req.query.$URL)'
      - pattern: 'superagent.get(req.body.$URL)'
    message: HTTP request with user-controlled URL - SSRF risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-puppeteer-goto
    patterns:
      - pattern: 'page.goto(req.body.$URL)'
      - pattern: 'page.goto(req.query.$URL)'
      - pattern: 'browser.newPage().goto($USER_URL)'
    message: Puppeteer goto with user URL - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-image-download
    patterns:
      - pattern: 'axios.get(req.body.imageUrl, {responseType: "arraybuffer"})'
      - pattern: 'fetch(req.body.imageUrl)'
      - pattern: 'download(req.body.$URL)'
    message: Image/file download from user URL - validate against SSRF
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [a10, ssrf]

  - id: ssrf-webhook-url
    patterns:
      - pattern: 'fetch(req.body.webhookUrl)'
      - pattern: 'axios.post(req.body.callbackUrl, ...)'
      - pattern: 'http.request(req.body.notifyUrl)'
    message: Webhook/callback URL from user input - SSRF vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [a10, ssrf]

  # ============================================
  # SQL Injection - Template Literals & Sequelize
  # ============================================

  - id: sequelize-query-template-literal
    pattern-regex: "sequelize\\.query\\s*\\(\\s*`[^`]*\\$\\{"
    message: Sequelize query with template literal interpolation - SQL injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  - id: sql-template-literal-select
    pattern-regex: "`SELECT[^`]*\\$\\{[^}]*(req\\.|user|input|param|body|query)"
    message: SQL SELECT with template literal user interpolation - SQL injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  - id: sql-template-literal-where
    pattern-regex: "`[^`]*WHERE[^`]*\\$\\{[^}]*(req\\.|user|input|param|body|query)"
    message: SQL WHERE clause with template literal interpolation - SQL injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  - id: sql-template-literal-insert
    pattern-regex: "`INSERT[^`]*VALUES[^`]*\\$\\{[^}]*(req\\.|user|input|param|body|query)"
    message: SQL INSERT with template literal user interpolation - SQL injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  - id: sql-template-literal-update
    pattern-regex: "`UPDATE[^`]*SET[^`]*\\$\\{[^}]*(req\\.|user|input|param|body|query)"
    message: SQL UPDATE with template literal user interpolation - SQL injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  - id: sql-template-literal-delete
    pattern-regex: "`DELETE[^`]*WHERE[^`]*\\$\\{[^}]*(req\\.|user|input|param|body|query)"
    message: SQL DELETE with template literal user interpolation - SQL injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  - id: sql-string-concat-injection
    pattern-regex: "['\"]SELECT[^'\"]*['\"]\\s*\\+\\s*(req\\.|user|input|param)"
    message: SQL query with string concatenation of user input - SQL injection
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  - id: models-sequelize-raw-query
    pattern-regex: "models\\.sequelize\\.query\\s*\\(\\s*`"
    message: Sequelize raw query with template literal - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  - id: sequelize-literal-user-input
    pattern-regex: "Sequelize\\.literal\\s*\\(\\s*[`'\"][^`'\"]*\\$\\{[^}]*(req\\.|user)"
    message: Sequelize.literal with user input - SQL injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  - id: typeorm-query-template-literal
    pattern-regex: "(createQueryBuilder|query)\\s*\\(\\s*`[^`]*\\$\\{"
    message: TypeORM query with template literal - use parameterized queries
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [core, sql-injection]

  # ============================================
  # DVNA-Specific Vulnerabilities
  # ============================================

  # DVNA: node-serialize RCE
  - id: node-serialize-unserialize
    patterns:
      - pattern: serialize.unserialize(...)
      - pattern: require("node-serialize").unserialize(...)
      - pattern: 'require("node-serialize")'
    message: node-serialize unserialize() is vulnerable to RCE - never use with untrusted data
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [deserialization, rce, dvna]

  # DVNA: mathjs eval
  - id: mathjs-eval-user-input
    patterns:
      - pattern: math.eval(req.$PARAM)
      - pattern: math.eval(req.$PARAM.$FIELD)
      - pattern: math.evaluate(req.$PARAM)
      - pattern: math.evaluate(req.$PARAM.$FIELD)
    message: Code injection - mathjs eval with request input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [injection, code-injection, dvna]

  # DVNA: libxmljs XXE
  - id: libxmljs-xxe-noent
    patterns:
      - pattern: 'libxmljs.parseXml($DATA, {noent: true})'
      - pattern: 'libxmljs.parseXmlString($DATA, {noent: true})'
      - pattern: 'parseXml($DATA, {noent: true, ...})'
    message: XXE vulnerability - libxmljs with noent:true enables external entity processing
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [xxe, dvna]

  - id: xml-parser-external-entities
    patterns:
      - pattern: '{noent: true}'
      - pattern: '{dtdload: true}'
      - pattern: '{dtdvalid: true}'
    message: XML external entity processing enabled - potential XXE vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [xxe]

  # DVNA: Direct password comparison (without bcrypt)
  - id: direct-password-comparison
    patterns:
      - pattern: 'if ($USER.password === $INPUT)'
      - pattern: 'if ($USER.password == $INPUT)'
      - pattern: 'if ($INPUT === $USER.password)'
      - pattern: 'if ($INPUT == $USER.password)'
      - pattern: 'password === user.password'
      - pattern: 'password == user.password'
      - pattern: 'user.password === password'
      - pattern: 'user.password == password'
    message: Direct password comparison detected - use bcrypt.compare() for secure comparison
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [authentication, password]

  # DVNA: Open redirect patterns
  - id: express-redirect-param
    patterns:
      - pattern: 'res.redirect(req.query.$PARAM)'
      - pattern: 'res.redirect(req.body.$PARAM)'
      - pattern: 'res.redirect(req.params.$PARAM)'
      - pattern: 'res.redirect(req.query.next)'
      - pattern: 'res.redirect(req.query.url)'
      - pattern: 'res.redirect(req.query.redirect)'
      - pattern: 'res.redirect(req.query.returnUrl)'
      - pattern: 'res.redirect(req.query.return_url)'
    message: Open redirect vulnerability - validate redirect URL against whitelist
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [redirect, open-redirect, dvna]

  - id: redirect-user-controlled
    patterns:
      - pattern: 'res.redirect($URL)'
      - pattern: 'res.location($URL)'
    message: Redirect using user input - potential open redirect
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [redirect]

  # ============================================
  # IDOR/BOLA (Broken Object Level Authorization)
  # ============================================

  - id: express-idor-param-lookup
    patterns:
      - pattern: '$MODEL.findById(req.params.$ID)'
      - pattern: '$MODEL.findByPk(req.params.$ID)'
      - pattern: '$MODEL.findOne({where: {id: req.params.$ID}})'
      - pattern: 'User.findById(req.params.id)'
      - pattern: 'User.findByPk(req.params.id)'
    message: IDOR - object lookup by URL parameter without authorization check
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola, authorization]

  - id: express-idor-update
    patterns:
      - pattern: '$MODEL.findByIdAndUpdate(req.params.$ID, ...)'
      - pattern: '$MODEL.updateOne({_id: req.params.$ID}, ...)'
      - pattern: '$MODEL.update({...}, {where: {id: req.params.$ID}})'
    message: IDOR - updating object by URL param without ownership verification
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola, authorization]

  - id: express-idor-delete
    patterns:
      - pattern: '$MODEL.findByIdAndDelete(req.params.$ID)'
      - pattern: '$MODEL.deleteOne({_id: req.params.$ID})'
      - pattern: '$MODEL.destroy({where: {id: req.params.$ID}})'
    message: IDOR - deleting object by URL param without ownership check
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [idor, bola, authorization]

  # ============================================
  # Session Security
  # ============================================

  - id: session-no-maxage
    patterns:
      - pattern: 'session({secret: $SECRET})'
      - pattern: 'session({..., cookie: {}})'
    message: Session without maxAge/expires - sessions should timeout
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [session, authentication]

  - id: session-insecure-cookie
    patterns:
      - pattern: 'cookie: {secure: false}'
      - pattern: 'cookie: {..., secure: false, ...}'
    message: Session cookie not secure - enable secure flag for HTTPS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [session, cookie]

  - id: session-no-httponly
    patterns:
      - pattern: 'cookie: {httpOnly: false}'
      - pattern: 'cookie: {..., httpOnly: false, ...}'
    message: Session cookie not httpOnly - vulnerable to XSS theft
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [session, cookie]

  # ============================================
  # Rate Limiting / Brute Force
  # ============================================

  - id: express-login-no-rate-limit
    pattern-regex: "app\\.(post|put)\\s*\\(['\"].*login"
    message: Login endpoint - consider adding rate limiting to prevent brute force
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [rate-limiting, authentication]

  - id: express-register-no-rate-limit
    pattern-regex: "app\\.(post|put)\\s*\\(['\"].*register"
    message: Registration endpoint - consider adding rate limiting
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [rate-limiting]

  - id: express-password-reset-no-rate-limit
    pattern-regex: "app\\.(post|put)\\s*\\(['\"].*password|reset|forgot"
    message: Password reset endpoint - add rate limiting to prevent abuse
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [rate-limiting, authentication]

  # ============================================
  # Broken Access Control Patterns
  # ============================================

  - id: admin-route-no-auth-check
    pattern-regex: "app\\.(get|post|put|delete)\\s*\\(['\"].*/admin"
    message: Admin route detected - ensure proper authorization middleware
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [authorization, admin]

  - id: api-route-no-auth
    patterns:
      - pattern: |
          app.$METHOD($PATH, ($REQ, $RES) => {
            ...
            $MODEL.find(...)
            ...
          })
    message: API route without authentication middleware - verify auth is enforced
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [authorization]

  - id: role-from-user-input
    patterns:
      - pattern: 'if (req.body.role === "admin")'
      - pattern: 'if (req.query.admin)'
      - pattern: 'if (req.body.isAdmin)'
      - pattern: 'if (req.body.is_admin)'
      - pattern: 'user.role = req.body.role'
      - pattern: 'user.admin = req.body.admin'
    message: Role/admin check from user input - privilege escalation vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [authorization, privilege-escalation]

  # ============================================
  # Information Disclosure
  # ============================================

  - id: express-error-stack-trace
    patterns:
      - pattern: 'res.send(err.stack)'
      - pattern: 'res.json({..., stack: err.stack, ...})'
      - pattern: 'res.json({error: err.message, stack: err.stack})'
    message: Stack trace in response - information disclosure vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [info-disclosure]

  - id: express-verbose-error
    patterns:
      - pattern: 'res.status(500).send(err)'
      - pattern: 'res.status(500).json(err)'
      - pattern: 'res.send(error.message)'
    message: Verbose error response - may leak sensitive information
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [info-disclosure]

  # ============================================
  # User Enumeration
  # ============================================

  - id: user-enumeration-error
    patterns:
      - pattern: 'res.json({error: "User not found"})'
      - pattern: 'res.json({error: "Invalid username"})'
      - pattern: 'res.json({message: "User does not exist"})'
      - pattern: '"Username not found"'
      - pattern: '"Invalid password"'
    message: User enumeration - error message reveals if user exists
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [enumeration, authentication]

  # ============================================
  # Session Fixation
  # ============================================

  - id: session-fixation-no-regenerate
    patterns:
      - pattern: |
          req.session.user = $USER
      - pattern: |
          req.session.userId = $ID
      - pattern: |
          req.session.authenticated = true
    message: Session fixation - regenerate session ID after authentication (use req.session.regenerate())
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-384"
      tags: [session, authentication, fixation]

  - id: session-no-regenerate-on-login
    pattern-regex: "(login|authenticate|signin).*\\{[\\s\\S]*?req\\.session\\.[a-zA-Z]+\\s*="
    message: Login without session regeneration - potential session fixation vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-384"
      tags: [session, authentication]

  - id: session-id-from-user-input
    patterns:
      - pattern: 'req.session.id = req.body.$ID'
      - pattern: 'req.session.id = req.query.$ID'
      - pattern: 'req.session.id = req.params.$ID'
      - pattern: 'req.sessionID = req.$SOURCE.$PARAM'
    message: Session ID from user input - session fixation vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-384"
      tags: [session, fixation]

  # ============================================
  # Credentials in URLs
  # ============================================

  - id: credentials-in-url
    patterns:
      - pattern-regex: 'https?://[^:]+:[^@]+@'
      - pattern-regex: "password=['\"]?[^'\"\\s&]+"
      - pattern-regex: "apikey=['\"]?[^'\"\\s&]+"
      - pattern-regex: "api_key=['\"]?[^'\"\\s&]+"
      - pattern-regex: "token=['\"]?[^'\"\\s&]+"
      - pattern-regex: "secret=['\"]?[^'\"\\s&]+"
    message: Credentials in URL - sensitive data exposed in URL string
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-598"
      tags: [secrets, credentials, url]

  - id: basic-auth-in-url
    pattern-regex: "https?://[a-zA-Z0-9_]+:[a-zA-Z0-9_!@#$%^&*]+@"
    message: Basic auth credentials in URL - credentials visible in logs and browser history
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-598"
      tags: [credentials, authentication]

  - id: password-in-query-string
    patterns:
      - pattern: 'req.query.password'
      - pattern: 'req.query.passwd'
      - pattern: 'req.query.pwd'
      - pattern: 'req.query.secret'
      - pattern: 'req.query.token'
      - pattern: 'req.query.apiKey'
      - pattern: 'req.query.api_key'
    message: Sensitive data in query string - use POST body or headers instead
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-598"
      tags: [credentials, query-string]

  # ============================================
  # CSRF Protection
  # ============================================

  - id: express-no-csrf-protection
    patterns:
      - pattern: |
          app.post($PATH, ($REQ, $RES) => {
            ...
          })
    message: POST endpoint without CSRF middleware - verify CSRF protection is enabled
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-352"
      tags: [csrf, authentication]

  - id: csrf-token-in-url
    patterns:
      - pattern: 'req.query.csrf'
      - pattern: 'req.query._csrf'
      - pattern: 'req.query.csrfToken'
    message: CSRF token in URL query - tokens should be in headers or POST body
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-352"
      tags: [csrf]

  - id: form-missing-csrf-field
    pattern-regex: "<form[^>]*method=['\"]post['\"][^>]*>(?:(?!csrf|_token|authenticity_token)[\\s\\S])*?</form>"
    message: Form POST without CSRF token field
    languages: [html]
    severity: WARNING
    metadata:
      cwe: "CWE-352"
      tags: [csrf, form]

  - id: cookie-without-samesite
    patterns:
      - pattern: 'res.cookie($NAME, $VALUE)'
      - pattern: 'res.cookie($NAME, $VALUE, {...})'
    message: Cookie set without SameSite attribute - potential CSRF vulnerability
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-352"
      tags: [csrf, cookie]

  # ============================================
  # Debug Code / Development Artifacts
  # ============================================

  - id: debug-endpoint-exposed
    patterns:
      - pattern-regex: "app\\.(get|post|all)\\s*\\(['\"].*(debug|test|dev|admin/debug)"
      - pattern-regex: "router\\.(get|post|all)\\s*\\(['\"].*(debug|test|dev)"
    message: Debug/test endpoint exposed - remove before production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [debug, development]

  - id: console-log-sensitive
    patterns:
      - pattern: 'console.log(..., password, ...)'
      - pattern: 'console.log(..., req.body.password, ...)'
      - pattern: 'console.log(..., user.password, ...)'
      - pattern: 'console.log(..., token, ...)'
      - pattern: 'console.log(..., secret, ...)'
      - pattern: 'console.log(..., apiKey, ...)'
    message: Sensitive data in console.log - remove debug logging
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [debug, logging, secrets]

  - id: debugger-statement
    pattern: 'debugger'
    message: Debugger statement - remove before production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [debug]

  - id: todo-fixme-security
    pattern-regex: "(TODO|FIXME|HACK|XXX).*?(security|auth|password|token|secret|vulnerability|insecure)"
    message: Security-related TODO/FIXME found - address before production
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [debug, todo]

  - id: development-only-code
    patterns:
      - pattern: 'if (process.env.NODE_ENV !== "production")'
      - pattern: 'if (process.env.NODE_ENV === "development")'
      - pattern: "if (process.env.NODE_ENV === 'dev')"
    message: Development-only code block - verify security implications in production
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [debug, development]

  - id: express-dev-error-handler
    patterns:
      - pattern: 'app.use(errorhandler())'
      - pattern: "require('errorhandler')"
    message: Development error handler - exposes stack traces, disable in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [debug, error-handling]

  # ============================================
  # Mass Assignment
  # ============================================

  - id: express-mass-assignment
    patterns:
      - pattern: '$MODEL.create(req.body)'
      - pattern: '$MODEL.update(req.body)'
      - pattern: '$MODEL.findByIdAndUpdate($ID, req.body)'
      - pattern: '$MODEL.findOneAndUpdate($QUERY, req.body)'
      - pattern: 'new $MODEL(req.body)'
      - pattern: 'Object.assign($OBJ, req.body)'
      - pattern: '{...$OBJ, ...req.body}'
    message: Mass assignment - directly using req.body allows attackers to set any field
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment, injection]

  - id: sequelize-mass-assignment
    patterns:
      - pattern: '$MODEL.create(req.body)'
      - pattern: '$MODEL.update(req.body, ...)'
      - pattern: '$MODEL.bulkCreate(req.body)'
      - pattern: '$INSTANCE.update(req.body)'
    message: Sequelize mass assignment - use allowlist of permitted fields
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment, sequelize]

  - id: mongoose-mass-assignment
    patterns:
      - pattern: '$MODEL.findByIdAndUpdate($ID, req.body)'
      - pattern: '$MODEL.updateOne($QUERY, req.body)'
      - pattern: '$MODEL.updateMany($QUERY, req.body)'
      - pattern: '$INSTANCE.set(req.body)'
    message: Mongoose mass assignment - use $set with specific fields
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment, mongoose]

  - id: user-role-mass-assignment
    patterns:
      - pattern: 'user.role = req.body.role'
      - pattern: 'user.isAdmin = req.body.isAdmin'
      - pattern: 'user.admin = req.body.admin'
      - pattern: 'user.permissions = req.body.permissions'
    message: Privilege escalation via mass assignment - never allow role/admin from user input
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment, privilege-escalation]

  # ============================================
  # Path Traversal Enhanced
  # ============================================

  - id: path-traversal-fs-operations
    patterns:
      - pattern: 'fs.readFile(req.params.$PATH, ...)'
      - pattern: 'fs.readFile(req.query.$PATH, ...)'
      - pattern: 'fs.readFile(req.body.$PATH, ...)'
      - pattern: 'fs.readFileSync(req.params.$PATH, ...)'
      - pattern: 'fs.readFileSync(req.query.$PATH, ...)'
      - pattern: 'fs.writeFile(req.params.$PATH, ...)'
      - pattern: 'fs.writeFile(req.query.$PATH, ...)'
      - pattern: 'fs.unlink(req.params.$PATH, ...)'
      - pattern: 'fs.unlink(req.query.$PATH, ...)'
    message: Path traversal - user input in file system operation
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, file-access]

  - id: path-traversal-sendfile
    patterns:
      - pattern: 'res.sendFile(req.params.$FILE)'
      - pattern: 'res.sendFile(req.query.$FILE)'
      - pattern: 'res.sendFile(req.body.$FILE)'
      - pattern: 'res.download(req.params.$FILE)'
      - pattern: 'res.download(req.query.$FILE)'
    message: Path traversal in file download - validate and sanitize file path
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, file-download]

  - id: path-traversal-concat
    patterns:
      - pattern: 'path.join($BASE, req.params.$PATH)'
      - pattern: 'path.join($BASE, req.query.$PATH)'
      - pattern: 'path.resolve($BASE, req.params.$PATH)'
      - pattern: '$BASE + "/" + req.params.$PATH'
      - pattern: '$BASE + req.params.$PATH'
      - pattern: '`${$BASE}/${req.params.$PATH}`'
    message: Path traversal - concatenating user input to file path
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal]

  - id: path-traversal-no-normalize
    pattern-regex: "(?<!path\\.normalize\\()(?<!path\\.basename\\()req\\.(params|query|body)\\.[a-zA-Z]+.*\\.(readFile|writeFile|unlink|access|stat)"
    message: File operation with user input - use path.normalize() and validate path
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal]

  # ============================================
  # PII Leakage / Excessive Data Exposure
  # ============================================

  - id: pii-in-logs
    patterns:
      - pattern: 'console.log(..., email, ...)'
      - pattern: 'console.log(..., user.email, ...)'
      - pattern: 'console.log(..., ssn, ...)'
      - pattern: 'console.log(..., creditCard, ...)'
      - pattern: 'console.log(..., phoneNumber, ...)'
      - pattern: 'logger.info(..., user, ...)'
      - pattern: 'logger.debug(..., user, ...)'
    message: PII in logs - avoid logging personal identifiable information
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-532"
      tags: [pii, logging, privacy]

  - id: excessive-data-exposure-user
    patterns:
      - pattern: 'res.json(user)'
      - pattern: 'res.send(user)'
      - pattern: 'res.json(users)'
      - pattern: 'res.json({user: user})'
    message: Excessive data exposure - return only necessary user fields, exclude password/sensitive data
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      tags: [data-exposure, api]

  - id: password-in-response
    patterns:
      - pattern: 'res.json({..., password: $PWD, ...})'
      - pattern: 'res.send({..., password: $PWD, ...})'
      - pattern: 'res.json({..., hash: $HASH, ...})'
      - pattern: 'res.json({..., passwordHash: $HASH, ...})'
    message: Password/hash in API response - never expose credentials
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-200"
      tags: [data-exposure, password]

  - id: token-in-response-body
    patterns:
      - pattern: 'res.json({..., refreshToken: $TOKEN, ...})'
      - pattern: 'res.json({..., apiKey: $KEY, ...})'
      - pattern: 'res.json({..., secretKey: $KEY, ...})'
    message: Sensitive token in response body - consider secure alternatives
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-200"
      tags: [data-exposure, token]

  - id: find-without-select
    patterns:
      - pattern: '$MODEL.find($QUERY).then(...)'
      - pattern: '$MODEL.findOne($QUERY).then(...)'
      - pattern: 'await $MODEL.find($QUERY)'
      - pattern: 'await $MODEL.findOne($QUERY)'
    message: Database query without field selection - may expose sensitive fields
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-200"
      tags: [data-exposure, database]

  # ============================================
  # Stored XSS Patterns
  # ============================================

  - id: stored-xss-db-to-html
    patterns:
      - pattern: 'res.send($DATA.content)'
      - pattern: 'res.send($DATA.body)'
      - pattern: 'res.send($DATA.html)'
      - pattern: 'res.send($DATA.message)'
    message: Stored XSS - database content rendered without escaping
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, stored-xss]

  - id: innerhtml-db-content
    patterns:
      - pattern: '$ELEM.innerHTML = $DATA'
      - pattern: 'document.getElementById($ID).innerHTML = $DATA'
      - pattern: '$ELEM.outerHTML = $DATA'
    message: DOM XSS - innerHTML with dynamic data, use textContent or sanitize
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, dom-xss]

  - id: template-literal-html
    pattern-regex: "res\\.send\\s*\\(\\s*`<[^`]*\\$\\{[^}]+\\}[^`]*`\\s*\\)"
    message: Template literal with HTML - ensure user data is escaped
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss]

  # ============================================
  # Insecure Randomness
  # ============================================

  - id: math-random-security
    patterns:
      - pattern: 'Math.random()'
    message: Math.random() is not cryptographically secure - use crypto.randomBytes() for security
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-330"
      tags: [randomness, crypto]

  - id: weak-token-generation
    patterns:
      - pattern: 'Math.random().toString(36)'
      - pattern: 'Date.now().toString(36)'
      - pattern: 'new Date().getTime().toString()'
    message: Weak token generation - use crypto.randomBytes() for secure tokens
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-330"
      tags: [randomness, token]

  - id: uuid-v1-predictable
    patterns:
      - pattern: 'uuid.v1()'
      - pattern: "require('uuid').v1()"
      - pattern: 'uuidv1()'
    message: UUID v1 is time-based and predictable - use v4 for security-sensitive contexts
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-330"
      tags: [randomness, uuid]

  # ============================================
  # Weak Password / OTP Handling
  # ============================================

  - id: weak-otp-generation
    patterns:
      - pattern: 'Math.floor(Math.random() * $MAX)'
      - pattern: 'Math.random() * 1000000'
      - pattern: "String(Math.random()).substring(2, $LEN)"
    message: Weak OTP generation - use cryptographically secure random numbers
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-330"
      tags: [otp, randomness]

  - id: short-otp
    pattern-regex: "otp.*=.*\\d{1,5}[^\\d]"
    message: OTP too short - use at least 6 digits for security
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [otp]

  - id: otp-no-expiry
    patterns:
      - pattern: 'user.otp = $OTP'
      - pattern: '$USER.verificationCode = $CODE'
    message: OTP stored without expiry time - implement OTP expiration
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [otp, authentication]

  # ============================================
  # Insufficient Logging / Audit
  # ============================================

  - id: login-no-logging
    pattern-regex: "app\\.(post|put)\\s*\\(['\"].*(login|auth|signin).*\\{[\\s\\S]{0,500}\\}"
    message: Authentication endpoint - ensure login attempts are logged for security audit
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-778"
      tags: [logging, authentication]

  - id: admin-action-no-logging
    pattern-regex: "app\\.(post|put|delete)\\s*\\(['\"].*/admin.*\\{[\\s\\S]{0,300}(?!log)[\\s\\S]{0,200}\\}"
    message: Admin action without logging - audit critical operations
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-778"
      tags: [logging, admin]

  # ============================================
  # Business Logic Vulnerabilities
  # ============================================

  - id: negative-quantity-check
    patterns:
      - pattern: 'if ($QTY > 0)'
      - pattern: 'quantity > 0'
    message: Quantity check - ensure negative values are also rejected
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [business-logic]

  - id: price-from-client
    patterns:
      - pattern: 'req.body.price'
      - pattern: 'req.body.amount'
      - pattern: 'req.body.total'
      - pattern: 'req.body.discount'
    message: Price/amount from client input - always calculate on server side
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [business-logic, price-manipulation]

  - id: coupon-no-validation
    patterns:
      - pattern: 'req.body.coupon'
      - pattern: 'req.body.discount_code'
      - pattern: 'req.body.promo'
    message: Coupon/discount from user input - validate against server-side rules
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [business-logic]

  # ============================================
  # NodeGoat / OWASP Top 10 - Advanced Detection
  # ============================================

  # MongoDB eval() injection (NodeGoat A1)
  - id: mongodb-eval-injection
    patterns:
      - pattern: '$DB.eval($CODE)'
      - pattern: '$DB.eval($CODE, ...)'
      - pattern: 'db.eval($CODE)'
    message: MongoDB eval() executes arbitrary JavaScript - critical injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-94"
      owasp: "A03:2021"
      tags: [nosql-injection, mongodb, critical]

  # MongoDB $where with string interpolation
  - id: mongodb-where-string-interpolation
    pattern-regex: "\\$where\\s*:\\s*['\"`][^'\"]*\\$\\{|\\$where\\s*:\\s*['\"`][^'\"]*\\+\\s*\\w"
    message: MongoDB $where with string interpolation - NoSQL injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-943"
      owasp: "A03:2021"
      tags: [nosql-injection, mongodb]

  # MongoDB mapReduce injection
  - id: mongodb-mapreduce-injection
    patterns:
      - pattern: '$COLL.mapReduce($MAP, $REDUCE, ...)'
      - pattern: 'mapReduce($MAP, $REDUCE, ...)'
    message: MongoDB mapReduce with dynamic functions - code injection risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-94"
      tags: [nosql-injection, mongodb]

  # Direct object reference without authorization check (IDOR)
  - id: express-idor-no-auth-check
    pattern-regex: "\\.(get|post|put|delete)\\s*\\(['\"].*/:id.*['\"]\\s*,\\s*(?:async\\s+)?(?:function)?\\s*\\([^)]*\\)\\s*(?:=>)?\\s*\\{[^}]{0,200}(?:findById|findOne|find)\\s*\\("
    message: Route with ID parameter accesses database without visible authorization check - potential IDOR
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021"
      tags: [idor, access-control]

  # Accessing user data by ID from params without ownership check
  - id: idor-user-data-access
    patterns:
      - pattern: '$MODEL.findById(req.params.$ID)'
      - pattern: '$MODEL.findOne({_id: req.params.$ID})'
      - pattern: '$MODEL.findOne({id: req.params.$ID})'
    message: Database lookup by user-provided ID - ensure authorization check before access
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021"
      tags: [idor, access-control]

  # Session fixation - session ID in URL
  - id: session-fixation-url
    pattern-regex: "req\\.(query|params)\\.(session|sessionId|sid|token)"
    message: Session identifier from URL parameter - session fixation vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-384"
      owasp: "A07:2021"
      tags: [session, authentication]

  # Insecure session configuration
  - id: express-session-insecure
    patterns:
      - pattern: 'session({..., secret: "...", ...})'
      - pattern: "session({..., secret: '...', ...})"
    message: Hardcoded session secret - use environment variable
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [session, hardcoded-secret]

  # Session without secure cookie settings
  - id: express-session-no-secure
    pattern-regex: 'session\s*\([^)]*secure\s*:\s*false'
    message: Session cookie without secure flag - vulnerable to MITM on HTTP
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-614"
      tags: [session, cookies]

  # Weak bcrypt cost factor
  - id: bcrypt-weak-rounds
    patterns:
      - pattern: 'bcrypt.hash($PASS, 1)'
      - pattern: 'bcrypt.hash($PASS, 2)'
      - pattern: 'bcrypt.hash($PASS, 3)'
      - pattern: 'bcrypt.hash($PASS, 4)'
      - pattern: 'bcrypt.hash($PASS, 5)'
      - pattern: 'bcrypt.hash($PASS, 6)'
      - pattern: 'bcrypt.hash($PASS, 7)'
      - pattern: 'bcrypt.hash($PASS, 8)'
      - pattern: 'bcrypt.hash($PASS, 9)'
      - pattern: 'bcrypt.hashSync($PASS, 1)'
      - pattern: 'bcrypt.hashSync($PASS, 2)'
      - pattern: 'bcrypt.hashSync($PASS, 3)'
      - pattern: 'bcrypt.hashSync($PASS, 4)'
      - pattern: 'bcrypt.hashSync($PASS, 5)'
      - pattern: 'bcrypt.hashSync($PASS, 6)'
      - pattern: 'bcrypt.hashSync($PASS, 7)'
      - pattern: 'bcrypt.hashSync($PASS, 8)'
      - pattern: 'bcrypt.hashSync($PASS, 9)'
    message: bcrypt cost factor too low (< 10) - use at least 10-12 rounds
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-916"
      tags: [crypto, password]

  # Swig template injection (NodeGoat uses Swig)
  - id: swig-template-injection
    patterns:
      - pattern: 'swig.render($USER_INPUT)'
      - pattern: 'swig.render($USER_INPUT, ...)'
      - pattern: 'swig.compile($USER_INPUT)'
      - pattern: 'swig.renderFile($PATH + $VAR, ...)'
    message: Swig template with dynamic input - Server-Side Template Injection (SSTI) risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      owasp: "A03:2021"
      tags: [ssti, template-injection]

  # Handlebars SSTI
  - id: handlebars-template-injection
    patterns:
      - pattern: 'Handlebars.compile($USER_INPUT)'
      - pattern: 'handlebars.compile($USER_INPUT)'
      - pattern: 'hbs.compile($USER_INPUT)'
    message: Handlebars template with dynamic input - SSTI risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      tags: [ssti, template-injection]

  # EJS template injection
  - id: ejs-template-injection
    patterns:
      - pattern: 'ejs.render($USER_INPUT)'
      - pattern: 'ejs.render($USER_INPUT, ...)'
      - pattern: 'ejs.compile($USER_INPUT)'
    message: EJS template with dynamic input - SSTI risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      tags: [ssti, template-injection]

  # Pug/Jade template injection
  - id: pug-template-injection
    patterns:
      - pattern: 'pug.render($USER_INPUT)'
      - pattern: 'pug.render($USER_INPUT, ...)'
      - pattern: 'pug.compile($USER_INPUT)'
      - pattern: 'jade.render($USER_INPUT)'
      - pattern: 'jade.compile($USER_INPUT)'
    message: Pug/Jade template with dynamic input - SSTI risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      tags: [ssti, template-injection]

  # Missing HTTPS redirect
  - id: express-no-https-redirect
    pattern-regex: "app\\.listen\\s*\\(\\s*(80|process\\.env\\.PORT|\\d{4})\\s*[,)]"
    message: HTTP server without HTTPS redirect - consider enforcing HTTPS
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-319"
      tags: [transport-security]

  # Helmet not used
  - id: express-no-helmet
    pattern-regex: "app\\.use\\s*\\(\\s*express\\."
    message: Express app detected - ensure helmet middleware is used for security headers
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [security-headers]

  # Debug mode in production
  - id: express-debug-production
    patterns:
      - pattern: "app.set('env', 'development')"
      - pattern: 'debug: true'
    message: Debug mode enabled - disable in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-489"
      tags: [config, debug]

  # DEBUG environment variable pattern (regex-based)
  - id: debug-env-wildcard
    pattern-regex: 'DEBUG\s*=\s*\*'
    message: DEBUG=* enables all debug output - disable in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-489"
      tags: [config, debug]

  # Verbose error messages
  - id: express-verbose-errors
    patterns:
      - pattern: 'res.send(err)'
      - pattern: 'res.send(error)'
      - pattern: 'res.json(err)'
      - pattern: 'res.json(error)'
      - pattern: 'res.send(err.stack)'
      - pattern: 'res.json({error: err})'
      - pattern: 'res.json({error: err.message, stack: err.stack})'
    message: Error details sent to client - may leak sensitive information
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      tags: [error-handling, information-disclosure]

  # Mass assignment vulnerability
  - id: mongoose-mass-assignment
    patterns:
      - pattern: 'new $MODEL(req.body)'
      - pattern: '$MODEL.create(req.body)'
      - pattern: '$MODEL.update($Q, req.body)'
      - pattern: '$MODEL.updateOne($Q, req.body)'
      - pattern: '$MODEL.updateMany($Q, req.body)'
      - pattern: '$MODEL.findOneAndUpdate($Q, req.body)'
      - pattern: '$MODEL.findByIdAndUpdate($ID, req.body)'
    message: Direct use of req.body in model - mass assignment vulnerability, use allowlisted fields
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      owasp: "A08:2021"
      tags: [mass-assignment]

  # Regex DoS (ReDoS) patterns
  - id: regex-redos-nested-quantifiers
    pattern-regex: "new RegExp\\s*\\([^)]*[+*]\\s*[+*]|/[^/]*[+*]\\s*[+*][^/]*/"
    message: Regex with nested quantifiers - potential ReDoS vulnerability
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-1333"
      tags: [redos, regex]

  # Regex with overlapping groups
  - id: regex-redos-overlapping
    pattern-regex: "new RegExp\\s*\\([^)]*\\([^)]*\\|[^)]*\\)[+*]|/[^/]*\\([^)]*\\|[^)]*\\)[+*][^/]*/"
    message: Regex with overlapping alternation - potential ReDoS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-1333"
      tags: [redos, regex]

  # User input in regex
  - id: regex-user-input
    patterns:
      - pattern: 'new RegExp(req.$X.$Y)'
      - pattern: 'new RegExp(req.$X.$Y, ...)'
      - pattern: '$STR.match(new RegExp($VAR))'
      - pattern: '$STR.replace(new RegExp($VAR), ...)'
    message: User input in RegExp constructor - ReDoS and regex injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-1333"
      tags: [redos, regex, injection]

  # XML parsing without protection (XXE)
  - id: xxe-xml-parser
    patterns:
      - pattern: 'xml2js.parseString($DATA, ...)'
      - pattern: 'libxmljs.parseXml($DATA)'
      - pattern: 'libxmljs.parseXml($DATA, ...)'
      - pattern: 'DOMParser().parseFromString($DATA, ...)'
    message: XML parsing - ensure external entities are disabled to prevent XXE
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2021"
      tags: [xxe, xml]

  # Zip slip / path traversal in archive extraction
  - id: zip-slip-vulnerability
    patterns:
      - pattern: 'unzip.Extract({path: $PATH})'
      - pattern: 'tar.extract({cwd: $PATH})'
      - pattern: 'AdmZip().extractAllTo($PATH)'
      - pattern: 'AdmZip().extractAllTo($PATH, ...)'
    message: Archive extraction - validate file paths to prevent Zip Slip attacks
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, zip-slip]

  # Child process with shell and user input
  - id: command-injection-shell-user-input
    patterns:
      - pattern: 'exec($CMD + req.$X.$Y, ...)'
      - pattern: 'exec(`${$PREFIX}${req.$X.$Y}`, ...)'
      - pattern: 'execSync($CMD + req.$X.$Y)'
      - pattern: 'execSync(`${$PREFIX}${req.$X.$Y}`)'
    message: Command execution with user input - command injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021"
      tags: [command-injection, critical]

  # Spawn with shell true and user input
  - id: spawn-shell-user-input
    pattern: 'spawn($CMD, [..., req.$X.$Y, ...], {shell: true})'
    message: Spawn with shell=true and user input - command injection risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-78"
      tags: [command-injection]

  # vm module code execution
  - id: vm-code-execution
    patterns:
      - pattern: 'vm.runInContext($CODE, ...)'
      - pattern: 'vm.runInNewContext($CODE, ...)'
      - pattern: 'vm.runInThisContext($CODE)'
      - pattern: 'new vm.Script($CODE)'
    message: VM module executing dynamic code - sandbox escape and RCE risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-94"
      tags: [code-execution, sandbox-escape]

  # Unsafe object property access
  - id: unsafe-property-access
    patterns:
      - pattern: '$OBJ[req.body.$KEY]'
      - pattern: '$OBJ[req.query.$KEY]'
      - pattern: '$OBJ[req.params.$KEY]'
    message: Object property access with user-controlled key - prototype pollution risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-1321"
      tags: [prototype-pollution]

  # Express without rate limiting
  - id: express-no-rate-limit
    pattern-regex: "app\\.(post|put)\\s*\\(['\"].*(login|auth|signin|signup|register|password|forgot|reset)"
    message: Authentication endpoint - ensure rate limiting is applied to prevent brute force
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-307"
      owasp: "A07:2021"
      tags: [rate-limiting, brute-force]

  # Timing attack on string comparison
  - id: timing-attack-comparison
    patterns:
      - pattern: 'if ($SECRET === req.$X.$Y)'
      - pattern: 'if ($SECRET == req.$X.$Y)'
      - pattern: 'if (req.$X.$Y === $SECRET)'
      - pattern: '$TOKEN === $USER_TOKEN'
    message: String comparison may be vulnerable to timing attacks - use crypto.timingSafeEqual
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-208"
      tags: [timing-attack, crypto]

  # ============================================
  # PostgreSQL (pg library) SQL Injection
  # ============================================

  # pg client.query with template literal (samoylenko vulnerable app pattern)
  - id: pg-client-query-template-literal
    pattern-regex: "client\\.query\\s*\\(\\s*`[^`]*\\$\\{[^}]+\\}[^`]*`"
    message: PostgreSQL query with template literal interpolation - SQL injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sql-injection, postgres, critical]

  # pg pool.query with template literal
  - id: pg-pool-query-template-literal
    pattern-regex: "pool\\.query\\s*\\(\\s*`[^`]*\\$\\{[^}]+\\}[^`]*`"
    message: PostgreSQL pool query with template literal - SQL injection vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sql-injection, postgres, critical]

  # pg query with string concatenation
  - id: pg-query-string-concat
    patterns:
      - pattern: 'client.query($Q + $VAR)'
      - pattern: 'client.query($Q + $VAR, ...)'
      - pattern: 'pool.query($Q + $VAR)'
      - pattern: 'pool.query($Q + $VAR, ...)'
    message: PostgreSQL query with string concatenation - use parameterized queries ($1, $2)
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection, postgres]

  # pg query with req.params/query/body directly
  - id: pg-query-user-input
    patterns:
      - pattern: 'client.query($Q, [req.params.$ID])'
      - pattern: 'client.query($Q, [req.query.$ID])'
      - pattern: 'client.query($Q, [req.body.$ID])'
    message: PostgreSQL query with user input - ensure proper parameterization
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection, postgres]

  # ============================================
  # Reflected XSS - Express Response Patterns
  # ============================================

  # res.send with direct string concatenation of user input
  - id: express-xss-res-send-concat
    patterns:
      - pattern: 'res.send("..." + req.query.$PARAM)'
      - pattern: 'res.send("..." + req.query.$PARAM + "...")'
      - pattern: "res.send('...' + req.query.$PARAM)"
      - pattern: "res.send('...' + req.query.$PARAM + '...')"
      - pattern: 'res.send("..." + req.params.$PARAM)'
      - pattern: 'res.send("..." + req.body.$PARAM)'
    message: Express res.send with user input concatenation - reflected XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, reflected-xss, critical]

  # res.send with template literal containing user input
  - id: express-xss-res-send-template
    pattern-regex: "res\\.send\\s*\\(\\s*`[^`]*\\$\\{\\s*req\\.(query|params|body)\\.[^}]+\\}[^`]*`\\s*\\)"
    message: Express res.send with template literal user input - reflected XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, reflected-xss, critical]

  # res.send with variable that might contain user input
  - id: express-xss-res-send-variable
    patterns:
      - pattern: 'res.send($VAR)'
      - pattern-not: 'res.send("...")'
      - pattern-not: "res.send('...')"
      - pattern-not: 'res.send(`...`)'
      - pattern-not: 'res.send({...})'
    message: Express res.send with variable - ensure output is escaped if user-controlled
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-79"
      tags: [xss]

  # res.write with user input
  - id: express-xss-res-write
    patterns:
      - pattern: 'res.write(req.query.$PARAM)'
      - pattern: 'res.write(req.params.$PARAM)'
      - pattern: 'res.write(req.body.$PARAM)'
      - pattern: 'res.write("..." + req.query.$PARAM)'
    message: Express res.write with user input - XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, reflected-xss]

  # ============================================
  # Database Value Reflection (Stored XSS)
  # ============================================

  # Sending database row directly to response
  - id: express-stored-xss-db-reflect
    patterns:
      - pattern: 'res.send($RESULT.rows[0])'
      - pattern: 'res.send($RESULT.rows)'
      - pattern: 'res.send($RESULT[0])'
      - pattern: 'res.json($RESULT.rows[0])'
    message: Database result sent directly to response - potential stored XSS if data contains user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, stored-xss]

  # Mongoose/MongoDB result reflection
  - id: express-stored-xss-mongo-reflect
    patterns:
      - pattern: 'res.send($DOC)'
      - pattern: 'res.send($USER)'
      - pattern: 'res.send($DATA)'
    message: Variable sent to response - ensure HTML encoding if rendering user-controlled data
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-79"
      tags: [xss]

  # ============================================
  # Pug/Jade Template XSS (unescaped output)
  # ============================================

  # Pug != unescaped interpolation in template files
  - id: pug-unescaped-interpolation
    pattern-regex: "!=\\s*['\"]?[^'\"\\n]*\\+|!=\\s*\\w+\\s*$"
    message: Pug unescaped output (!=) with concatenation - XSS vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, pug, template]

  # Pug !{} unescaped interpolation
  - id: pug-unescaped-bracket
    pattern-regex: "!\\{[^}]+\\}"
    message: Pug unescaped interpolation !{} - XSS risk if variable contains user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, pug, template]

  # EJS <%- unescaped output
  - id: ejs-unescaped-output
    pattern-regex: "<%-\\s*\\w+"
    message: EJS unescaped output (<%-) - XSS vulnerability if variable contains user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, ejs, template]

  # Handlebars triple-mustache unescaped
  - id: handlebars-triple-mustache
    pattern-regex: "\\{\\{\\{[^}]+\\}\\}\\}"
    message: Handlebars unescaped output ({{{}}}) - XSS risk with user input
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, handlebars, template]

  # ============================================
  # Hardcoded Database Credentials
  # ============================================

  # PostgreSQL connection string with password
  - id: postgres-hardcoded-password
    pattern-regex: "postgres(ql)?://[^:]+:[^@]+@"
    message: Hardcoded PostgreSQL password in connection string - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [secrets, hardcoded-credentials]

  # MySQL connection string with password
  - id: mysql-hardcoded-password
    pattern-regex: "mysql://[^:]+:[^@]+@"
    message: Hardcoded MySQL password in connection string - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [secrets, hardcoded-credentials]

  # MongoDB connection string with password
  - id: mongodb-hardcoded-password
    pattern-regex: "mongodb(\\+srv)?://[^:]+:[^@]+@"
    message: Hardcoded MongoDB password in connection string - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [secrets, hardcoded-credentials]

  # pg.Client or Pool with hardcoded password
  - id: pg-client-hardcoded-password
    patterns:
      - pattern: 'new Client({..., password: "...", ...})'
      - pattern: "new Client({..., password: '...', ...})"
      - pattern: 'new Pool({..., password: "...", ...})'
      - pattern: "new Pool({..., password: '...', ...})"
    message: Hardcoded database password - use environment variables
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [secrets, hardcoded-credentials, postgres]

  # ============================================
  # Vulnerable Dependencies Detection
  # ============================================

  # Lodash vulnerable versions (prototype pollution)
  - id: lodash-require-vulnerable
    pattern-regex: "require\\s*\\(['\"]lodash['\"]\\)"
    message: Lodash import detected - ensure version >= 4.17.21 to avoid prototype pollution CVEs
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-1321"
      tags: [dependencies, prototype-pollution]

  # Lodash ES import
  - id: lodash-import-check
    pattern-regex: "import\\s+.*from\\s+['\"]lodash['\"]"
    message: Lodash import detected - verify version >= 4.17.21 for security patches
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [dependencies]

  # ============================================
  # NodeGoat-Specific Vulnerability Patterns
  # ============================================

  # SSRF via needle with query param URL
  - id: ssrf-needle-query-url
    patterns:
      - pattern: needle($METHOD, $URL, ...)
      - pattern-not: 'needle($M, "...", ...)'
      - pattern-not: "needle($M, '...', ...)"
    message: SSRF - needle HTTP client with dynamic URL - validate and whitelist allowed URLs
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021"
      tags: [ssrf, nodegoat]

  # SSRF URL concatenation with query params
  - id: ssrf-url-concat-query
    pattern-regex: "http[s]?://[^\\s]*\\$\\{?req\\.(query|params|body)\\.[^\\s]*\\}?"
    message: SSRF - URL constructed with user input - validate against allowlist
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021"
      tags: [ssrf, nodegoat]

  # res.write with variable (not just req params)
  - id: xss-res-write-variable
    patterns:
      - pattern: res.write($BODY)
      - pattern-not: 'res.write("...")'
      - pattern-not: "res.write('...')"
      - pattern-not: "res.write(`...`)"
    message: res.write with variable - ensure content is escaped to prevent XSS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, nodegoat]

  # Wrong encoding context - HTML encoding used in URL
  - id: wrong-encoding-context-url
    patterns:
      - pattern: ESAPI.encoder().encodeForHTML($X)
    message: ESAPI encodeForHTML detected - verify encoding matches context (use encodeForURL for URLs)
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-838"
      tags: [encoding, xss, nodegoat]

  # Swig template engine (deprecated, known vulnerabilities)
  - id: swig-template-deprecated
    pattern-regex: "require\\s*\\(['\"]swig['\"]\\)|from\\s+['\"]swig['\"]"
    message: Swig template engine is deprecated and has known path traversal vulnerabilities - migrate to EJS, Pug, or Nunjucks
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-22"
      tags: [template, deprecated, nodegoat]

  # Swig renderFile with variable path
  - id: swig-render-path-traversal
    patterns:
      - pattern: swig.renderFile($PATH, ...)
      - pattern-not: 'swig.renderFile("...", ...)'
    message: Swig renderFile with dynamic path - path traversal vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, template, nodegoat]

  # Nested quantifier ReDoS (more specific pattern)
  - id: redos-nested-quantifier-specific
    pattern-regex: "/\\([^)]*[+*]\\)[+*]"
    message: Regex with nested quantifiers - potential ReDoS vulnerability (exponential backtracking)
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-1333"
      tags: [redos, nodegoat]

  # HTTP Parameter Pollution - multiple same params
  - id: hpp-array-param
    patterns:
      - pattern: $X = req.query.$PARAM
    message: Query parameter access - if parameter can be array, validate to prevent HPP attacks
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-235"
      tags: [hpp, nodegoat]

  # Missing input sanitization before DB
  - id: db-insert-no-validation
    patterns:
      - pattern: $DB.insert(req.body)
      - pattern: $DB.insert({ ...req.body })
      - pattern: $DB.create(req.body)
      - pattern: $COLLECTION.insertOne(req.body)
      - pattern: $COLLECTION.insertMany(req.body)
    message: Database insert with raw request body - sanitize and validate input first
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-20"
      owasp: "A03:2021"
      tags: [injection, validation, nodegoat]

  # parseInt without radix (can cause issues)
  - id: parseint-radix-missing
    pattern: parseInt($X)
    message: parseInt without radix parameter - specify base to avoid unexpected behavior
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [best-practice, nodegoat]

  # User ID from URL used directly in query
  - id: idor-user-id-query
    patterns:
      - pattern: |
          $COLLECTION.find({_id: parseInt($REQ.$PARAMS.$ID)})
      - pattern: |
          $COLLECTION.findOne({_id: parseInt($REQ.$PARAMS.$ID)})
      - pattern: |
          $COLLECTION.updateOne({_id: parseInt($REQ.$PARAMS.$ID)}, ...)
    message: User ID from URL used in query - verify requesting user owns this resource (IDOR)
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021"
      tags: [idor, bola, nodegoat]

  # Hardcoded isAdmin in response
  - id: hardcoded-admin-flag
    pattern-regex: "isAdmin\\s*:\\s*true"
    message: Hardcoded isAdmin flag - verify this is based on actual user role check
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-863"
      tags: [authorization, nodegoat]

  # Missing error callback handling
  - id: mongodb-callback-error-ignored
    patterns:
      - pattern: |
          $COLLECTION.$METHOD(..., function($ERR, $RESULT) {
            ...
            $CALLBACK(null, $DATA)
          })
    message: MongoDB callback may ignore errors - check $ERR before calling success callback
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [error-handling, nodegoat]

  # Profile/sensitive data update without ownership check
  - id: profile-update-no-owner-check
    patterns:
      - pattern: |
          $COLLECTION.update({_id: $USER_ID}, {$set: $DATA})
      - pattern: |
          $COLLECTION.updateOne({_id: $USER_ID}, {$set: $DATA})
    message: Profile update - ensure user owns this profile before updating (IDOR prevention)
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      tags: [idor, profile, nodegoat]

  # Callback response without auth check
  - id: express-callback-no-auth
    patterns:
      - pattern: |
          res.render($TEMPLATE, {
            ...
            $DATA
          })
    message: Template render - ensure user is authenticated and authorized to view this data
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [authorization, nodegoat]

  # Direct assignment of user input to model
  - id: mass-assignment-user-input
    patterns:
      - pattern: $MODEL.$FIELD = req.body.$FIELD
      - pattern: $MODEL.$FIELD = req.query.$FIELD
      - pattern: |
          Object.assign($MODEL, req.body)
    message: Mass assignment - user input directly assigned to model without validation
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      owasp: "A08:2021"
      tags: [mass-assignment, nodegoat]

  # Timestamp from client
  - id: client-controlled-timestamp
    patterns:
      - pattern: |
          { ..., timestamp: req.body.timestamp, ... }
      - pattern: |
          { ..., createdAt: req.body.createdAt, ... }
      - pattern: |
          { ..., date: req.body.date, ... }
    message: Timestamp from client input - use server-generated timestamps instead
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-20"
      tags: [validation, nodegoat]

  # Revealing error details
  - id: error-message-exposure
    patterns:
      - pattern: 'res.send({ error: $ERR.message })'
      - pattern: 'res.json({ error: $ERR.message })'
      - pattern: 'res.send("Error: " + $ERR.message)'
      - pattern: 'res.send(`Error: ${$ERR.message}`)'
    message: Error message exposed to client - use generic messages in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      tags: [information-disclosure, nodegoat]

  # Find with empty query (returns all)
  - id: mongodb-find-all
    patterns:
      - pattern: $COLLECTION.find({})
      - pattern: $COLLECTION.find()
    message: MongoDB find all documents - ensure user is authorized to access all records
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-862"
      tags: [authorization, nodegoat]

  # Benefits/sensitive update without role check
  - id: sensitive-update-no-role-check
    patterns:
      - pattern: |
          $DAO.update$X(req.body.$ID, req.body.$DATA)
      - pattern: |
          $DAO.update$X($REQ.body.userId, ...)
    message: Sensitive data update - verify user has permission to modify this resource
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-863"
      tags: [authorization, nodegoat]

  # Stored XSS in profile fields
  - id: stored-xss-profile-field
    patterns:
      - pattern: |
          $USER.website = $INPUT
      - pattern: |
          $USER.bio = $INPUT
      - pattern: |
          $USER.description = $INPUT
      - pattern: |
          $PROFILE.website = $INPUT
    message: User profile field update - sanitize input to prevent stored XSS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, stored-xss, nodegoat]

  # SSN/Financial data in code
  - id: sensitive-data-ssn
    pattern-regex: "ssn|social.?security|bank.?account|routing.?number"
    message: Sensitive financial data field - ensure proper encryption and access control
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-311"
      tags: [sensitive-data, nodegoat]

  # ============================================
  # A2: Broken Authentication (Additional Rules)
  # ============================================

  # Plain text password storage - should use bcrypt/argon2
  - id: password-plain-text-storage
    patterns:
      - pattern: |
          $USER.password = $INPUT
      - pattern: |
          password: $REQ.body.password
      - pattern: |
          $OBJ.password = req.body.password
    message: Password may be stored without hashing - use bcrypt.hash() or argon2
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-256"
      cvss: "9.8"
      fix_id: password-hashing
      tags: [auth, password, nodegoat]

  # Password comparison without bcrypt.compare
  - id: password-comparison-plain
    patterns:
      - pattern: |
          if ($USER.password === $INPUT) { ... }
      - pattern: |
          if ($USER.password == $INPUT) { ... }
      - pattern: |
          $USER.password === req.body.password
      - pattern: |
          password === $INPUT
    message: Password compared directly without bcrypt.compare() - timing attack risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-208"
      tags: [auth, password, nodegoat]

  # Credential enumeration via different error messages
  - id: credential-enumeration-username
    pattern-regex: "Invalid username|User not found|No such user|Username does not exist"
    message: Credential enumeration - use generic "Invalid username or password" message
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-204"
      tags: [auth, enumeration, nodegoat]

  - id: credential-enumeration-password
    pattern-regex: "Invalid password|Wrong password|Incorrect password|Password incorrect"
    message: Credential enumeration - use generic "Invalid username or password" message
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-204"
      tags: [auth, enumeration, nodegoat]

  # ============================================
  # A6: Sensitive Data Exposure (Additional Rules)
  # ============================================

  # Missing autocomplete off on sensitive forms
  - id: form-missing-autocomplete-off
    pattern-regex: '<input[^>]*type=.?(password|ssn|credit)[^>]*>'
    message: Sensitive form field - consider adding autocomplete="off" to prevent browser autofill
    languages: [html, javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-200"
      tags: [sensitive-data, forms, nodegoat]

  # Missing cache-control on sensitive responses
  - id: missing-cache-control-sensitive
    patterns:
      - pattern: |
          res.render($TEMPLATE, { ..., ssn: $X, ... })
      - pattern: |
          res.render($TEMPLATE, { ..., password: $X, ... })
      - pattern: |
          res.render($TEMPLATE, { ..., creditCard: $X, ... })
    message: Sensitive data in response - add Cache-Control no-store header
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-525"
      tags: [sensitive-data, caching, nodegoat]

  # ============================================
  # A7: Missing Function Level Access Control
  # ============================================

  # Route with isLoggedIn but no role check
  - id: route-missing-authorization
    patterns:
      - pattern: |
          app.get($PATH, isLoggedIn, function($REQ, $RES) { ... })
      - pattern: |
          app.post($PATH, isLoggedIn, function($REQ, $RES) { ... })
      - pattern: |
          router.get($PATH, isLoggedIn, $HANDLER)
      - pattern: |
          router.post($PATH, isLoggedIn, $HANDLER)
    message: Route has authentication but may lack authorization check - verify role-based access
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-285"
      tags: [authorization, access-control, nodegoat]

  # Accessing admin routes without isAdmin check
  - id: admin-route-no-check
    patterns:
      - pattern-regex: '(admin|benefit|manage|settings)["\''"]\\s*,\\s*(isLoggedIn|authenticate)\\s*,'
    message: Admin/privileged route may lack proper authorization middleware
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-285"
      tags: [authorization, admin, nodegoat]

  # ============================================
  # Swig Template XSS (NodeGoat uses Swig)
  # ============================================

  - id: swig-unescaped-output
    patterns:
      - pattern-regex: '\\{\\{\\s*\\|\\s*raw\\s*\\}\\}'
      - pattern-regex: "swig\\.setFilter\\(['\"]raw['\"]"
    message: Swig raw filter bypasses escaping - XSS vulnerability if user input
    languages: [javascript, typescript, html]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, swig, template, nodegoat]

  - id: swig-autoescape-disabled
    patterns:
      - pattern: |
          swig.setDefaults({ autoescape: false })
      - pattern-regex: "autoescape:\\s*false"
    message: Swig autoescape disabled - all output vulnerable to XSS
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, swig, nodegoat]

  # ============================================
  # A9: Vulnerable marked library (NodeGoat specific)
  # ============================================

  - id: marked-xss-vulnerability
    patterns:
      - pattern: |
          marked($INPUT)
      - pattern: |
          marked.parse($INPUT)
      - pattern: |
          marked($INPUT, { sanitize: false })
    message: Marked library parsing - verify version is patched for XSS (CVE-2016-10531)
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, markdown, nodegoat]

  # ============================================
  # A2: Additional Authentication Weaknesses
  # ============================================

  # No password length/complexity validation
  - id: password-no-length-check
    patterns:
      - pattern-regex: "password\\s*&&\\s*password\\.length\\s*[<>=]\\s*[0-5]"
      - pattern-regex: "password\\.length\\s*[<>]=?\\s*[0-5]\\s*\\)"
    message: Weak password length requirement (should be at least 8 characters)
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-521"
      tags: [auth, password, nodegoat]

  # No account lockout after failed attempts
  - id: login-no-lockout
    patterns:
      - pattern: |
          if ($USER.password !== $INPUT) {
            ...
            return $CALLBACK($ERR);
          }
      - pattern: |
          if (!$BCRYPT.compare(...)) {
            ...
            return $CALLBACK($ERR);
          }
    message: Login failure without account lockout - add lockout after N failed attempts
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-307"
      tags: [auth, brute-force, nodegoat]

  # ============================================
  # A5: Security Misconfiguration - HTTPS
  # ============================================

  # HTTP server without HTTPS redirect
  - id: http-no-https-redirect
    patterns:
      - pattern: |
          http.createServer($APP)
      - pattern: |
          app.listen($PORT)
    message: HTTP server - ensure HTTPS is enforced in production (use helmet HSTS)
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-319"
      tags: [https, tls, nodegoat]

  # Missing HSTS header
  - id: missing-hsts-header
    patterns:
      - pattern-regex: "helmet\\(\\{[^}]*hsts:\\s*false"
      - pattern-regex: "helmet\\.hsts\\(\\{\\s*\\}\\)"
    message: HSTS disabled or misconfigured - enable Strict-Transport-Security header
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-319"
      tags: [https, headers, nodegoat]

  # ============================================
  # A6: Sensitive Data - Password in Logs
  # ============================================

  # Logging password field
  - id: password-in-logs
    patterns:
      - pattern: |
          console.log(..., $X.password, ...)
      - pattern: |
          logger.$LEVEL(..., password, ...)
      - pattern-regex: "console\\.(log|error|warn|info)\\([^)]*password"
    message: Password may be logged - never log sensitive credentials
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-532"
      tags: [logging, password, nodegoat]

  # ============================================
  # A7: Missing Function Level Access - Benefits
  # ============================================

  # Benefits/admin route without isAdmin middleware
  - id: benefits-route-no-admin-check
    pattern-regex: "router\\.(get|post)\\(['\"]/?benefits['\"].*isLoggedIn(?!.*isAdmin)"
    message: Benefits route may lack admin authorization check
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-285"
      tags: [authorization, nodegoat]

  # ============================================
  # Juice Shop Specific - Additional Detection Rules
  # ============================================

  # Prototype Pollution - Direct __proto__ access
  - id: proto-direct-access
    pattern-regex: '__proto__'
    message: Direct __proto__ access detected - prototype pollution vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-1321"
      tags: [prototype-pollution, juice-shop]

  # Prototype Pollution - constructor.prototype
  - id: constructor-prototype-access
    pattern-regex: 'constructor\s*\.\s*prototype'
    message: constructor.prototype access - potential prototype pollution
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-1321"
      tags: [prototype-pollution, juice-shop]

  # Prototype Pollution - Object property from user input
  - id: bracket-notation-user-input
    pattern: $OBJ[$USER_INPUT] = $VALUE
    message: Dynamic property assignment - prototype pollution if key is user-controlled
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-1321"
      tags: [prototype-pollution]

  # Zip Slip - Path traversal in archive extraction
  - id: zip-extract-no-sanitize
    patterns:
      - pattern: $ARCHIVE.extractAllTo(...)
      - pattern: $ARCHIVE.extractEntryTo(...)
      - pattern: unzip($INPUT, ...)
      - pattern: extract($INPUT, ...)
    message: Archive extraction without path sanitization - Zip Slip vulnerability risk
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, zip-slip, juice-shop]

  # Zip Slip - adm-zip vulnerable pattern
  - id: admzip-extract-all
    pattern-regex: 'new\s+AdmZip\s*\([^)]*\)\s*\.\s*extractAllTo'
    message: adm-zip extractAllTo - verify path traversal protection (Zip Slip)
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, zip-slip]

  # Path traversal in extracted filename
  - id: path-join-archive-entry
    pattern: path.join($BASE, $ENTRY.entryName)
    message: Archive entry path used without sanitization - check for ../
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, zip-slip]

  # File Upload - No type validation
  - id: multer-no-filefilter
    pattern-regex: 'multer\s*\(\s*\{\s*(?!.*fileFilter)[^}]*\}\s*\)'
    message: Multer without fileFilter - add file type validation
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-434"
      tags: [file-upload, juice-shop]

  # File Upload - Accepting any file type
  - id: file-upload-any-type
    pattern-regex: 'fileFilter.*(?:mimetype|originalname).*(?:return\s+cb\s*\(\s*null\s*,\s*true|cb\s*\(\s*null\s*,\s*true)'
    message: File filter accepting all files - restrict to allowed types only
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-434"
      tags: [file-upload]

  # File Upload - No size limit
  - id: multer-no-limits
    pattern-regex: 'multer\s*\(\s*\{\s*(?!.*limits)[^}]*\}\s*\)'
    message: Multer without size limits - add limits.fileSize to prevent DoS
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-400"
      tags: [file-upload, dos]

  # IDOR - Sequential ID without auth check
  - id: route-id-param-no-auth
    pattern-regex: "router\\.(get|put|delete)\\s*\\(\\s*['\"]/:id['\"]\\s*,\\s*(?:async\\s*)?\\(req"
    message: Route with :id param - verify ownership/authorization check exists
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-639"
      tags: [idor, authorization]

  # Error disclosure - Stack trace in response
  - id: stack-trace-exposed
    patterns:
      - pattern: res.send($ERR.stack)
      - pattern: 'res.json({..., stack: $ERR.stack, ...})'
      - pattern: res.status(...).send($ERR.stack)
    message: Stack trace exposed in response - information disclosure
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-209"
      tags: [info-disclosure, juice-shop]

  # Error disclosure - Full error object in catch block
  - id: full-error-response
    pattern-regex: 'catch\s*\(\s*\w+\s*\)\s*\{[^}]*res\.(send|json)\s*\(\s*\w+\s*\)'
    message: Full error object sent in response - may expose sensitive info
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      tags: [info-disclosure]

  # Debug endpoint in production
  - id: debug-route-exposed
    pattern-regex: "router\\.(get|post)\\s*\\(\\s*['\"].*debug"
    message: Debug route detected - ensure disabled in production
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-489"
      tags: [debug, security-misconfiguration]

  # No rate limiting on auth endpoints
  - id: auth-no-rate-limit
    pattern-regex: "router\\.post\\s*\\(\\s*['\"].*(?:login|signin|auth|password|reset)['\"].*(?!rateLimit)"
    message: Auth endpoint without rate limiting - brute force risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-307"
      tags: [brute-force, rate-limit, juice-shop]

  # Metrics/admin endpoint exposed
  - id: metrics-endpoint-exposed
    pattern-regex: "app\\.(get|use)\\s*\\(\\s*['\"].*(?:metrics|prometheus|health|status)['\"]"
    message: Metrics/status endpoint - ensure authentication if exposing sensitive data
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-200"
      tags: [info-disclosure]

  # B2B integration without auth
  - id: b2b-endpoint-no-auth
    pattern-regex: "router\\.(get|post)\\s*\\(\\s*['\"].*(?:b2b|api/orders|bulk|batch)['\"]\\s*,\\s*(?:async\\s*)?\\(req"
    message: B2B/bulk endpoint - verify proper authentication exists
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-306"
      tags: [authorization, b2b]

  # Unsafe file read with user input
  - id: fs-read-user-input
    patterns:
      - pattern: fs.readFile($REQ.$PARAM, ...)
      - pattern: fs.readFileSync($REQ.$PARAM, ...)
      - pattern: fs.readFile(req.params.$X, ...)
      - pattern: fs.readFile(req.query.$X, ...)
      - pattern: fs.readFile(req.body.$X, ...)
    message: File read with user input - path traversal vulnerability
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, lfi, juice-shop]

  # Directory listing enabled
  - id: express-static-directory-listing
    pattern-regex: "serveIndex\\s*\\("
    message: Directory listing enabled - information disclosure risk
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-548"
      tags: [info-disclosure]

  # Captcha bypass - No server-side validation
  - id: captcha-client-only
    pattern-regex: "(?:captcha|recaptcha).*(?:validate|verify).*(?:req\\.(body|query)\\.)"
    message: CAPTCHA validation - ensure server-side verification with secret key
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-804"
      tags: [captcha, automation]

  # Memory storage for sessions (not persistent)
  - id: session-memory-store
    pattern-regex: "session\\s*\\(\\s*\\{[^}]*(?!store)[^}]*\\}\\s*\\)"
    message: Session using memory store - not suitable for production
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-384"
      tags: [session, security-misconfiguration]

  # Swagger/API docs exposed
  - id: swagger-docs-exposed
    pattern-regex: "app\\.(use|get)\\s*\\(\\s*['\"].*(?:swagger|api-docs|openapi)['\"]"
    message: API documentation endpoint - ensure access control in production
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-200"
      tags: [info-disclosure, api-docs]

  # FTP service enabled
  - id: ftp-server-enabled
    pattern-regex: "new\\s+(?:ftpd|FTPServer|ftp-srv)"
    message: FTP server detected - consider SFTP for secure file transfer
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-319"
      tags: [ftp, cleartext]

  # Chatbot without input validation
  - id: chatbot-user-input
    pattern-regex: "(?:chatbot|bot)\\.(?:process|respond|handle)\\s*\\(\\s*req\\."
    message: Chatbot processing user input - ensure sanitization
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [chatbot, input-validation]

  # Crypto mining detection
  - id: crypto-mining-script
    pattern-regex: "(?:coinhive|cryptoloot|minero|coinpot|cryptonight)"
    message: Potential crypto mining script reference detected
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [malware, crypto-mining]

  # Video/image URL without validation
  - id: media-url-user-controlled
    patterns:
      - pattern: '<video src={$USER_INPUT}'
      - pattern: '<img src={$USER_INPUT}'
      - pattern: '<iframe src={$USER_INPUT}'
    message: Media element with user-controlled URL - potential SSRF or XSS
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf, xss]

  # Blockchain/Web3 without validation
  - id: web3-user-input
    pattern-regex: "web3\\.eth\\.(?:sendTransaction|call)\\s*\\(\\s*\\{[^}]*(?:from|to|data):\\s*req\\."
    message: Web3 transaction with user input - verify all parameters
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [web3, blockchain, juice-shop]

  # NFT minting without validation
  - id: nft-mint-no-validation
    pattern-regex: "(?:mint|createNFT|mintNFT)\\s*\\([^)]*req\\."
    message: NFT minting with user input - verify ownership and limits
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [nft, web3]

  # ============================================
  # INSECURE DESERIALIZATION (CWE-502)
  # ============================================

  # node-serialize deserialization (CVE-2017-5941)
  - id: node-serialize-unserialize
    pattern-regex: "require\\s*\\(\\s*['\"]node-serialize['\"]\\s*\\)"
    message: "node-serialize library is vulnerable to RCE via deserialization - use safe alternatives"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      owasp: "A08:2021"
      tags: [deserialization, rce, juice-shop]

  - id: unserialize-call
    pattern-regex: "\\.unserialize\\s*\\("
    message: "Insecure deserialization - unserialize() can execute arbitrary code"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, rce]

  # serialize-javascript eval
  - id: serialize-to-js-eval
    pattern-regex: "eval\\s*\\(\\s*serialize\\s*\\("
    message: "Dangerous pattern - serialized data passed to eval can lead to RCE"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, rce]

  # JSON.parse with user input (potential prototype pollution via __proto__)
  - id: json-parse-user-input
    pattern: JSON.parse(req.$PARAM)
    message: "JSON.parse with user input - sanitize to prevent prototype pollution"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, prototype-pollution]

  - id: json-parse-body
    pattern: JSON.parse(req.body)
    message: "JSON.parse on request body - use body-parser middleware instead"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-502"
      tags: [deserialization]

  # YAML deserialization (yaml.load is unsafe)
  - id: yaml-load-unsafe
    pattern-regex: "yaml\\.load\\s*\\([^)]+\\)"
    message: "yaml.load is unsafe - use yaml.safeLoad or js-yaml with safe schema"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, rce]

  # vm module eval patterns
  - id: vm-runinnewcontext-user
    pattern-regex: "vm\\.(?:runInNewContext|runInThisContext|runInContext)\\s*\\([^)]*(?:req\\.|user|input)"
    message: "VM execution with user input - potential sandbox escape"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, rce, sandbox-escape]

  # Function constructor with user input
  - id: function-constructor-user-input
    pattern-regex: "new\\s+Function\\s*\\([^)]*(?:req\\.|user|input|body)"
    message: "Function constructor with user input enables code injection"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [code-injection, rce]

  # ============================================
  # SECURITY MISCONFIGURATION (OWASP A05:2021)
  # ============================================

  # Debug mode enabled
  - id: debug-mode-enabled
    pattern-regex: "(?:DEBUG|debug)\\s*[=:]\\s*(?:true|1|['\"]true['\"])"
    message: "Debug mode enabled - disable in production"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      owasp: "A05:2021"
      tags: [misconfiguration, debug, juice-shop]

  # NODE_ENV not production
  - id: node-env-development
    pattern-regex: "NODE_ENV\\s*[!=]==?\\s*['\"](?:development|dev|test)['\"]"
    message: "Code checking for non-production environment - ensure proper env handling"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [misconfiguration, environment]

  # Verbose error messages
  - id: verbose-error-response
    pattern-regex: "res\\.(?:json|send)\\s*\\([^)]*(?:err\\.message|err\\.stack|error\\.message)"
    message: "Verbose error details in response - may leak sensitive information"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      owasp: "A05:2021"
      tags: [misconfiguration, information-disclosure]

  # Default credentials
  - id: default-admin-password
    pattern-regex: "(?:password|passwd|pwd)\\s*[=:]\\s*['\"](?:admin|password|123456|default|changeme)['\"]"
    message: "Default or weak password detected - use strong, unique credentials"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      owasp: "A05:2021"
      tags: [misconfiguration, credentials, juice-shop]

  # CORS Allow All Origins
  - id: cors-allow-all
    pattern-regex: "Access-Control-Allow-Origin['\"]?\\s*[,:]\\s*['\"]\\*['\"]"
    message: "CORS allows all origins - restrict to trusted domains"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      owasp: "A05:2021"
      tags: [misconfiguration, cors]

  - id: cors-origin-star
    pattern: "cors({ origin: '*' })"
    message: "CORS middleware allows all origins - restrict to trusted domains"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [misconfiguration, cors]

  - id: cors-credentials-true-star
    pattern-regex: "cors\\s*\\(\\s*\\{[^}]*credentials\\s*:\\s*true[^}]*origin\\s*:\\s*['\"]?\\*"
    message: "CORS with credentials and wildcard origin is a security risk"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      tags: [misconfiguration, cors]

  # Missing security headers
  - id: missing-helmet
    pattern-regex: "app\\.use\\s*\\(\\s*express\\.static"
    message: "Express static serving without helmet - consider adding security headers"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      owasp: "A05:2021"
      tags: [misconfiguration, headers]

  # X-Powered-By header not disabled
  - id: xpoweredby-enabled
    pattern-regex: "app\\.(?:enable|set)\\s*\\([^)]*['\"]x-powered-by['\"]"
    message: "X-Powered-By header enabled - consider disabling to hide framework"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [misconfiguration, fingerprinting]

  # HTTP instead of HTTPS redirect
  - id: http-not-https
    pattern-regex: "(?:redirect|location)\\s*[=:]\\s*['\"]http://"
    message: "HTTP redirect detected - use HTTPS for secure connections"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      owasp: "A05:2021"
      tags: [misconfiguration, transport]

  # TLS/SSL disabled or weak
  - id: ssl-verify-disabled
    pattern-regex: "rejectUnauthorized\\s*:\\s*false"
    message: "SSL certificate verification disabled - vulnerable to MITM attacks"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      owasp: "A05:2021"
      tags: [misconfiguration, tls]

  # Session config without secure flags
  - id: session-insecure-cookie
    pattern-regex: "session\\s*\\([^)]*(?:secure\\s*:\\s*false|httpOnly\\s*:\\s*false)"
    message: "Insecure session cookie configuration - enable secure and httpOnly"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      owasp: "A05:2021"
      cwe: "CWE-614"
      tags: [misconfiguration, session]

  # GraphQL introspection enabled
  - id: graphql-introspection-enabled
    pattern-regex: "introspection\\s*:\\s*true"
    message: "GraphQL introspection enabled - disable in production"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      owasp: "A05:2021"
      tags: [misconfiguration, graphql]

  # Express trust proxy misconfiguration
  - id: trust-proxy-true
    pattern-regex: "app\\.set\\s*\\([^)]*['\"]trust proxy['\"]\\s*,\\s*true"
    message: "trust proxy set to true - be specific about proxy configuration"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [misconfiguration, proxy]

  # ============================================
  # SECURITY THROUGH OBSCURITY / HIDDEN FILES
  # ============================================

  # Backup file extensions in routes
  - id: backup-file-served
    pattern-regex: "\\.(bak|backup|old|orig|copy|tmp|temp|swp|save)\\b"
    message: "Backup file reference detected - ensure not publicly accessible"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      owasp: "A05:2021"
      tags: [obscurity, backup, juice-shop]

  # .git directory exposure
  - id: git-directory-served
    pattern-regex: "(?:sendFile|static|serve).*\\.git"
    message: ".git directory may be exposed - exclude from static serving"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-538"
      tags: [obscurity, source-exposure]

  # Serving hidden dot files
  - id: dotfiles-served
    pattern-regex: "dotfiles\\s*:\\s*['\"]allow['\"]"
    message: "Hidden dotfiles serving enabled - may expose sensitive config"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [obscurity, configuration]

  # robots.txt disallow patterns (info disclosure)
  - id: robots-txt-sensitive
    pattern-regex: "Disallow:\\s*/(?:admin|api|backup|config|db|private|secret)"
    message: "robots.txt may reveal sensitive paths - consider honeypot instead"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [obscurity, information-disclosure]

  # Source map files in production
  - id: sourcemap-production
    pattern-regex: "(?:sourceMap|sourceMaps)\\s*:\\s*true"
    message: "Source maps enabled - disable in production to protect source code"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [obscurity, source-exposure]

  # Hidden admin routes
  - id: hidden-admin-route
    pattern-regex: "(?:app|router)\\.(?:get|post|put|delete)\\s*\\([^)]*['\"]/?(?:_admin|__admin|.admin|secret-admin|backdoor)"
    message: "Hidden admin route detected - use proper authentication instead"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [obscurity, authentication, juice-shop]

  # Debug endpoints
  - id: debug-endpoint
    pattern-regex: "(?:app|router)\\.(?:get|post)\\s*\\([^)]*['\"]/?(?:debug|_debug|__debug|test-|dev-)"
    message: "Debug endpoint detected - remove in production"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [obscurity, debug]

  # Metrics endpoints without auth
  - id: metrics-endpoint-exposed
    pattern-regex: "(?:app|router)\\.get\\s*\\([^)]*['\"]/?(?:metrics|health|status|info)['\"]"
    message: "Metrics/status endpoint - ensure proper access control"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [obscurity, information-disclosure]

  # Swagger/API docs in production
  - id: swagger-docs-exposed
    pattern-regex: "(?:swagger-ui|openapi|api-docs).*(?:app|router)\\.(?:use|get)"
    message: "API documentation exposed - consider restricting access in production"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [obscurity, documentation]

  # Hidden file download routes
  - id: hidden-download-route
    pattern-regex: "download.*\\.(?:sql|db|sqlite|dump|log|conf|cfg|ini)"
    message: "Sensitive file download endpoint - ensure proper authorization"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-538"
      tags: [obscurity, data-exposure]

  # FTP credentials in code
  - id: ftp-credentials-exposed
    pattern-regex: "ftp://[^:]+:[^@]+@"
    message: "FTP credentials in code - use environment variables"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [obscurity, credentials]

  # Prometheus metrics without auth
  - id: prometheus-metrics-open
    pattern-regex: "(?:promClient|prom-client).*\\.(?:register|metrics)"
    message: "Prometheus metrics endpoint - ensure access is restricted"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [obscurity, metrics]

  # Actuator endpoints (Spring Boot style)
  - id: actuator-style-endpoints
    pattern-regex: "(?:app|router)\\.(?:get|use)\\s*\\([^)]*['\"]/?(?:actuator|env|configprops|mappings)['\"]"
    message: "Actuator-style endpoint exposed - restrict access"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [obscurity, information-disclosure]

  # Version endpoint disclosure
  - id: version-endpoint
    pattern-regex: "(?:app|router)\\.get\\s*\\([^)]*['\"]/?version['\"]"
    message: "Version endpoint exposed - may aid attackers in identifying vulnerabilities"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [obscurity, fingerprinting]

  # Temporary file paths
  - id: temp-file-paths
    pattern-regex: "(?:path|fs).*(?:/tmp/|/temp/|\\\\temp\\\\|\\\\tmp\\\\)"
    message: "Temporary file path usage - ensure proper cleanup and permissions"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      tags: [obscurity, filesystem]

  # Config file endpoints
  - id: config-file-endpoint
    pattern-regex: "sendFile.*(?:config|settings|env).*\\.(?:json|yml|yaml|xml|ini)"
    message: "Config file served via endpoint - ensure no sensitive data"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [obscurity, configuration]

  # Package.json exposure
  - id: package-json-exposed
    pattern-regex: "(?:sendFile|static).*package\\.json"
    message: "package.json may be exposed - reveals dependencies and versions"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      tags: [obscurity, information-disclosure]

  # .env file served
  - id: env-file-exposed
    pattern-regex: "(?:sendFile|static).*\\.env"
    message: ".env file accessible - contains sensitive environment variables"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-538"
      tags: [obscurity, secrets]

  # ============================================
  # XXE - XML External Entity Injection
  # ============================================

  # libxmljs without safe parsing
  - id: libxmljs-xxe-external-entities
    patterns:
      - pattern: libxml.parseXml($XML, ...)
      - pattern: libxml.parseXmlString($XML, ...)
      - pattern: libxmljs.parseXml($XML, ...)
      - pattern: libxmljs.parseXmlString($XML, ...)
    message: "libxmljs XML parsing may be vulnerable to XXE. Disable external entities with {noent: false, nonet: true}"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2021"
      tags: [xxe, injection]

  # xml2js with external entities enabled
  - id: xml2js-xxe-vulnerable
    pattern-regex: "xml2js\\.parseString.*(?:externals|entities).*true"
    message: "xml2js with external entities enabled - vulnerable to XXE attacks"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-611"
      tags: [xxe, injection]

  # DOMParser without sanitization
  - id: domparser-xxe-risk
    patterns:
      - pattern: new DOMParser().parseFromString($XML, "text/xml")
      - pattern: new DOMParser().parseFromString($XML, "application/xml")
    message: "DOMParser XML parsing may be vulnerable to XXE in certain environments"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe]

  # sax parser vulnerable config
  - id: sax-parser-xxe
    pattern-regex: "sax\\.(?:parser|createStream).*(?:strict.*false|entities)"
    message: "SAX parser configuration may be vulnerable to XXE"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe]

  # xmldom parsing
  - id: xmldom-xxe-vulnerable
    patterns:
      - pattern: new DOMParser().parseFromString($XML, ...)
      - pattern: xmldom.DOMParser().parseFromString($XML, ...)
    message: "xmldom parsing without proper XXE protection"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe]

  # fast-xml-parser without entity disabled
  - id: fast-xml-parser-xxe
    pattern-regex: "new XMLParser\\(.*(?:processEntities|allowBooleanAttributes).*true"
    message: "fast-xml-parser with entity processing enabled may be vulnerable to XXE"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe]

  # ============================================
  # CSRF - Cross-Site Request Forgery
  # ============================================

  # Missing CSRF protection on state-changing routes
  - id: express-post-no-csrf
    pattern-regex: "app\\.(?:post|put|delete|patch)\\(['\"][^'\"]+['\"]\\s*,\\s*(?:async\\s*)?(?:\\(|function)"
    message: "State-changing route without CSRF protection. Consider using csurf or lusca middleware"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-352"
      owasp: "A01:2021"
      tags: [csrf, authentication]

  # CSRF protection disabled
  - id: csrf-protection-disabled
    pattern-regex: "(?:csurf|csrf).*(?:ignore|disabled|false)"
    message: "CSRF protection appears to be disabled or bypassed"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-352"
      tags: [csrf]

  # Cookie without SameSite attribute
  - id: cookie-no-samesite
    pattern-regex: "res\\.cookie\\([^)]+\\)(?!.*sameSite)"
    message: "Cookie set without SameSite attribute - may be vulnerable to CSRF"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-352"
      tags: [csrf, cookies]

  # SameSite None without Secure
  - id: cookie-samesite-none-insecure
    pattern-regex: "sameSite.*['\"]?none['\"]?(?!.*secure.*true)"
    message: "SameSite=None cookie without Secure flag - browsers will reject this cookie"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-614"
      tags: [csrf, cookies]

  # Missing CSRF token in forms
  - id: form-missing-csrf-token
    pattern-regex: "<form[^>]*method=['\"]?post['\"]?[^>]*>(?!.*csrf|.*_token|.*xsrf)"
    message: "Form POST without CSRF token field"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-352"
      tags: [csrf]

  # CORS with credentials but no origin check
  - id: cors-credentials-any-origin
    pattern-regex: "credentials.*true.*origin.*['\"]\\*['\"]|origin.*['\"]\\*['\"].*credentials.*true"
    message: "CORS allowing credentials from any origin - CSRF risk"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-346"
      tags: [csrf, cors]

  # ============================================
  # Unvalidated Redirects and Forwards
  # ============================================

  # Direct redirect from user input
  - id: redirect-user-input
    patterns:
      - pattern: res.redirect($INPUT)
      - pattern: res.redirect(req.query.$PARAM)
      - pattern: res.redirect(req.body.$PARAM)
      - pattern: res.redirect(req.params.$PARAM)
    message: "Redirect using user-controlled input - vulnerable to open redirect attacks"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-601"
      owasp: "A01:2021"
      tags: [redirect, injection]

  # Window.location from user input
  - id: window-location-user-input
    pattern-regex: "(?:window\\.)?location(?:\\.href)?\\s*=\\s*(?:req\\.|params\\.|query\\.|input|url|redirect|next|return)"
    message: "Setting window.location from potentially user-controlled value - open redirect risk"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-601"
      tags: [redirect, xss]

  # Redirect URL from query parameter
  - id: redirect-url-query-param
    pattern-regex: "redirect.*(?:req\\.query|req\\.params|searchParams|URLSearchParams)"
    message: "Redirect URL sourced from query parameters without validation"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-601"
      tags: [redirect]

  # Unvalidated URL in response header
  - id: location-header-user-input
    patterns:
      - pattern: res.setHeader("Location", $URL)
      - pattern: res.set("Location", $URL)
      - pattern: res.header("Location", $URL)
    message: "Location header set with potentially user-controlled URL"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [redirect]

  # URL redirect validation bypass patterns
  - id: redirect-validation-bypass
    pattern-regex: "(?:startsWith|indexOf|includes).*(?:http|//|\\\\)"
    message: "Redirect URL validation may be bypassable (e.g., //evil.com, http://evil.com)"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-601"
      tags: [redirect, validation]

  # Next.js router push from user input
  - id: nextjs-router-push-user-input
    patterns:
      - pattern: router.push($URL)
      - pattern: Router.push($URL)
    message: "Next.js router.push may be using user-controlled URL - validate before redirecting"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [redirect, nextjs]

  # React Router navigate with user input
  - id: react-router-navigate-user-input
    patterns:
      - pattern: navigate($URL)
      - pattern: useNavigate()($URL)
    message: "React Router navigate with potentially user-controlled URL"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [redirect, react]

  # Helmet redirect
  - id: helmet-redirect-user-input
    pattern-regex: "contentSecurityPolicy.*reportUri"
    message: "Helmet CSP reportUri may contain user-controlled URL"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-601"
      tags: [redirect, csp]

  # ============================================
  # Prototype Pollution (Extended)
  # ============================================

  # Lodash merge with user input
  - id: lodash-merge-prototype-pollution
    patterns:
      - pattern: _.merge($TARGET, $INPUT)
      - pattern: lodash.merge($TARGET, $INPUT)
      - pattern: _.defaultsDeep($TARGET, $INPUT)
    message: "Lodash merge/defaultsDeep with user input - vulnerable to prototype pollution"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-1321"
      tags: [prototype-pollution]

  # Object.assign with req.body
  - id: object-assign-prototype-pollution
    patterns:
      - pattern: Object.assign($TARGET, req.body)
      - pattern: Object.assign($TARGET, req.query)
      - pattern: Object.assign({...}, req.body)
    message: "Object.assign with user input - may be vulnerable to prototype pollution"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-1321"
      tags: [prototype-pollution]

  # Spread operator with user input
  - id: spread-operator-prototype-pollution
    patterns:
      - pattern: "{...$OBJ, ...req.body}"
      - pattern: "{...$OBJ, ...req.query}"
    message: "Spread operator with user input - potential prototype pollution vector"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-1321"
      tags: [prototype-pollution]

  # Deep clone/copy without prototype protection
  - id: deep-clone-prototype-pollution
    pattern-regex: "(?:deepClone|deepCopy|deepMerge|deepExtend)\\([^)]*(?:req\\.|input|data|body)"
    message: "Deep clone/merge with user input - verify prototype pollution protection"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-1321"
      tags: [prototype-pollution]

  # ============================================
  # SSRF - Server-Side Request Forgery (Extended)
  # ============================================

  # Axios with user-controlled URL
  - id: axios-ssrf-user-url
    patterns:
      - pattern: axios.get($URL)
      - pattern: axios.post($URL, ...)
      - pattern: 'axios.request({..., url: $URL, ...})'
      - pattern: 'axios({..., url: $URL, ...})'
    message: "Axios request with potentially user-controlled URL - SSRF risk"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021"
      tags: [ssrf]

  # fetch with user URL
  - id: fetch-ssrf-user-url
    patterns:
      - pattern: fetch($URL)
      - pattern: fetch($URL, ...)
    message: "Fetch API with potentially user-controlled URL - validate to prevent SSRF"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # Node request module SSRF
  - id: request-module-ssrf
    patterns:
      - pattern: request($URL, ...)
      - pattern: request.get($URL, ...)
      - pattern: request.post($URL, ...)
    message: "Request module with potentially user-controlled URL - SSRF risk"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # got library SSRF
  - id: got-ssrf-user-url
    patterns:
      - pattern: got($URL)
      - pattern: got.get($URL)
      - pattern: got.post($URL, ...)
    message: "Got HTTP client with potentially user-controlled URL - SSRF risk"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # Puppeteer/Playwright SSRF
  - id: headless-browser-ssrf
    patterns:
      - pattern: page.goto($URL)
      - pattern: page.goto($URL, ...)
      - pattern: browser.newPage().goto($URL)
    message: "Headless browser navigation with user URL - high-impact SSRF risk"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      tags: [ssrf, puppeteer]

  # DNS rebinding via URL
  - id: dns-rebinding-risk
    pattern-regex: "(?:localhost|127\\.0\\.0\\.1|0\\.0\\.0\\.0|internal|private).*(?:whitelist|allow|valid)"
    message: "Localhost/internal URL validation may be vulnerable to DNS rebinding attacks"
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      cwe: "CWE-918"
      tags: [ssrf, dns-rebinding]

  # ============================================
  # NodeGoat-Specific Vulnerabilities
  # ============================================

  # SSRF - URL constructed from query params then passed to HTTP client
  - id: ssrf-url-from-query-concat
    pattern-regex: "(?:const|let|var)\\s+\\w+\\s*=\\s*req\\.query\\.\\w+\\s*\\+\\s*req\\.query"
    message: "URL constructed from concatenated query parameters - SSRF vulnerability"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021 Server-Side Request Forgery"
      tags: [ssrf, nodegoat]

  # SSRF - needle.get with variable (indirect)
  - id: ssrf-needle-variable
    patterns:
      - pattern: |
          $URL = ...
          ...
          needle.get($URL, ...)
      - pattern: |
          $URL = ...
          ...
          needle($METHOD, $URL, ...)
    message: "needle HTTP request with variable URL - verify URL is not user-controlled (SSRF)"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # IDOR - destructured params passed to DAO
  - id: idor-destructured-params
    pattern-regex: "const\\s*\\{\\s*(?:userId|id|user_id|accountId)\\s*\\}\\s*=\\s*req\\.params"
    message: "User ID from URL params - verify authorization check exists (IDOR risk)"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021 Broken Access Control"
      tags: [idor, authz, nodegoat]

  # IDOR - req.params.userId passed to function
  - id: idor-userid-param-to-dao
    patterns:
      - pattern: '$DAO.getByUserId(req.params.$ID, ...)'
      - pattern: '$DAO.findByUserId(req.params.$ID, ...)'
      - pattern: '$DAO.getByUserIdAndThreshold(req.params.$ID, ...)'
    message: "DAO query using URL param - IDOR vulnerability if no auth check"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021 Broken Access Control"
      tags: [idor, authz]

  # IDOR - variable from req.params used in query
  - id: idor-param-variable-query
    pattern: |
        $VAR = req.params.$PARAM
        ...
        $DAO.$METHOD($VAR, ...)
    message: "URL parameter passed to data access - ensure authorization is verified (IDOR)"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      tags: [idor, authz]

  # MongoDB NoSQL Injection - operator injection in auth
  - id: nosql-auth-operator-injection
    patterns:
      - pattern: '$COLL.findOne({username: $USER, password: $PASS})'
      - pattern: '$COLL.find({username: $USER, password: $PASS})'
    message: "MongoDB auth query - vulnerable to operator injection ({$gt:''}) without input validation"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-943"
      owasp: "A03:2021 Injection"
      tags: [nosql, injection, auth]

  # MongoDB - $where with any variable
  - id: nosql-where-injection
    pattern-regex: "\\$where\\s*:\\s*[`\"'].*\\$\\{|\\$where\\s*:\\s*[^\"']"
    message: "MongoDB $where with dynamic content - JavaScript injection vulnerability"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-943"
      tags: [nosql, injection]

  # Stored XSS - user input stored then rendered
  - id: stored-xss-profile-field
    pattern-regex: "(firstName|lastName|name|displayName|bio|description)\\s*[=:]\\s*req\\.(body|query)\\."
    message: "User input stored in profile field - sanitize before storing to prevent stored XSS"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021 Injection"
      tags: [xss, stored]

  # Express res.write with variable - XSS sink
  - id: express-res-write-xss
    patterns:
      - pattern: 'res.write($VAR)'
      - pattern: 'res.write(`${$VAR}`)'
      - pattern: 'res.write($A + $B)'
    message: "res.write with variable - ensure content is escaped to prevent XSS"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, express]

  # Missing function-level access control
  - id: express-route-no-admin-check
    pattern-regex: "app\\.(get|post|put|delete)\\(['\"]/(admin|benefits|settings|users)['\"],\\s*isLoggedIn\\s*,"
    message: "Admin route with only login check - add role/permission verification"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-285"
      owasp: "A01:2021 Broken Access Control"
      tags: [authz, access-control]

  # Session fixation - login without regenerate
  - id: session-fixation-login
    pattern-regex: "req\\.session\\.userId\\s*=|req\\.session\\.user\\s*=(?!.*regenerate)"
    message: "Session ID assignment without regeneration - session fixation vulnerability"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-384"
      tags: [session, auth]
