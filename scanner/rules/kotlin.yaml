# Kotlin Security Rules
rules:
  # ============================================
  # Command Injection
  # ============================================

  - id: kotlin-runtime-exec
    pattern: Runtime.getRuntime().exec($CMD)
    message: Kotlin command execution - injection risk
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-processbuilder
    pattern: ProcessBuilder($CMD)
    message: Kotlin ProcessBuilder - command injection risk
    languages: [kotlin]
    severity: WARNING

  # ============================================
  # SQL Injection
  # ============================================

  - id: kotlin-sql-concat
    pattern: '"SELECT " + $VAR'
    message: Kotlin SQL concatenation - SQL injection risk
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-sql-template
    pattern: '"SELECT ... $VAR ..."'
    message: Kotlin SQL string template - SQL injection risk
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-createquery
    pattern: $EM.createQuery($QUERY)
    message: Kotlin JPA createQuery - ensure parameterized queries
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-createnativequery
    pattern: $EM.createNativeQuery($QUERY)
    message: Kotlin JPA native query - SQL injection risk
    languages: [kotlin]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: kotlin-objectinputstream
    pattern: ObjectInputStream($STREAM).readObject()
    message: Kotlin insecure deserialization
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-objectinputstream-new
    pattern: ObjectInputStream(...)
    message: Kotlin ObjectInputStream - deserialization vulnerability
    languages: [kotlin]
    severity: ERROR

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: kotlin-md5
    pattern: 'MessageDigest.getInstance("MD5")'
    message: Kotlin MD5 is weak - use SHA-256 or better
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-sha1
    pattern: 'MessageDigest.getInstance("SHA-1")'
    message: Kotlin SHA1 is deprecated - use SHA-256 or better
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-des
    pattern: 'Cipher.getInstance("DES")'
    message: Kotlin DES is weak - use AES
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-ecb
    pattern: 'Cipher.getInstance("AES/ECB/$PADDING")'
    message: Kotlin ECB mode is insecure - use GCM or CBC
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-random
    pattern: Random()
    message: Kotlin Random not secure - use SecureRandom
    languages: [kotlin]
    severity: WARNING

  # ============================================
  # XXE
  # ============================================

  - id: kotlin-xxe-documentbuilder
    pattern: DocumentBuilderFactory.newInstance()
    message: Kotlin XML parser may be vulnerable to XXE
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-xxe-saxparser
    pattern: SAXParserFactory.newInstance()
    message: Kotlin SAX parser may be vulnerable to XXE
    languages: [kotlin]
    severity: WARNING

  # ============================================
  # Path Traversal
  # ============================================

  - id: kotlin-file-user
    pattern: File($USER_INPUT)
    message: Kotlin File with user input - path traversal risk
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-paths-get
    pattern: Paths.get($USER_INPUT)
    message: Kotlin Paths.get with user input - path traversal risk
    languages: [kotlin]
    severity: WARNING

  # ============================================
  # SSRF
  # ============================================

  - id: kotlin-url-user
    pattern: URL($USER_INPUT)
    message: Kotlin URL with user input - potential SSRF
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-http-get
    pattern: $CLIENT.get($URL)
    message: Kotlin HTTP request - validate URL for SSRF
    languages: [kotlin]
    severity: INFO

  # ============================================
  # SSL/TLS Issues
  # ============================================

  - id: kotlin-ssl-trust-all
    pattern: 'hostnameVerifier = HostnameVerifier { _, _ -> true }'
    message: Kotlin hostname verification disabled
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-ssl-context-old
    pattern: 'SSLContext.getInstance("SSL")'
    message: Kotlin SSL is outdated - use TLS 1.2+
    languages: [kotlin]
    severity: ERROR

  # ============================================
  # Hardcoded Credentials
  # ============================================

  - id: kotlin-hardcoded-password
    pattern: 'val password = "..."'
    message: Kotlin hardcoded password detected
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-hardcoded-secret
    pattern: 'val secret = "..."'
    message: Kotlin hardcoded secret detected
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-hardcoded-apikey
    pattern: 'val apiKey = "..."'
    message: Kotlin hardcoded API key detected
    languages: [kotlin]
    severity: ERROR

  # ============================================
  # Android Specific
  # ============================================

  - id: kotlin-android-webview-js
    pattern: $WEBVIEW.settings.javaScriptEnabled = true
    message: Kotlin WebView JavaScript enabled - XSS risk if loading untrusted content
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-android-webview-file
    pattern: $WEBVIEW.settings.allowFileAccess = true
    message: Kotlin WebView file access enabled - potential data leak
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-android-intent-extra
    pattern: intent.getStringExtra($KEY)
    message: Kotlin intent extra - validate data from other apps
    languages: [kotlin]
    severity: INFO

  # Note: android:exported is XML, moved to yaml-config.yaml for XML scanning
  # Using regex to catch exported=true in Kotlin code annotations/comments
  - id: kotlin-android-exported-true
    pattern-regex: 'exported\s*=\s*true'
    message: Android exported component - verify access control (CWE-926)
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-926"

  - id: kotlin-android-world-readable
    pattern: MODE_WORLD_READABLE
    message: Kotlin world-readable file mode - security risk
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-android-world-writable
    pattern: MODE_WORLD_WRITEABLE
    message: Kotlin world-writable file mode - security risk
    languages: [kotlin]
    severity: ERROR

  # ============================================
  # Logging Sensitive Data
  # ============================================

  - id: kotlin-log-password
    pattern: Log.d($TAG, ...$PASSWORD...)
    message: Kotlin logging potentially sensitive data
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-println-debug
    pattern: println(...)
    message: Kotlin println - use proper logging, avoid in production
    languages: [kotlin]
    severity: INFO

  # ============================================
  # Android - WebView Security (InsecureShop gaps)
  # ============================================

  - id: kotlin-android-webview-loadurl-intent
    pattern: $WEBVIEW.loadUrl(intent.$METHOD(...))
    message: WebView loading URL from Intent - validate URL origin (CWE-939)
    languages: [kotlin]
    severity: ERROR
    metadata:
      cwe: "CWE-939"

  - id: kotlin-android-webview-loadurl-getstring
    pattern: $WEBVIEW.loadUrl($INTENT.getStringExtra(...))
    message: WebView loading URL from Intent extra - URL injection risk
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-android-webview-loadurl-data
    pattern: $WEBVIEW.loadUrl($DATA.toString())
    message: WebView loading URL from data - validate before loading
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-android-webview-content-access
    pattern: $WEBVIEW.settings.allowContentAccess = true
    message: WebView content access enabled - potential content provider leak
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-android-webview-universal-access
    pattern: $WEBVIEW.settings.allowUniversalAccessFromFileURLs = true
    message: WebView universal file access - severe security risk (CWE-200)
    languages: [kotlin]
    severity: ERROR
    metadata:
      cwe: "CWE-200"

  # ============================================
  # Android - Broadcast Security
  # ============================================

  - id: kotlin-android-sendbroadcast
    pattern: sendBroadcast($INTENT)
    message: Implicit broadcast - use LocalBroadcastManager or explicit receiver (CWE-927)
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-927"

  - id: kotlin-android-sendbroadcast-url
    pattern: |
      $INTENT.putExtra(..., $URL)
      ...
      sendBroadcast($INTENT)
    message: Broadcasting URL via implicit intent - may leak to malicious apps
    languages: [kotlin]
    severity: ERROR

  - id: kotlin-android-registerreceiver-unprotected
    pattern: registerReceiver($RECEIVER, $FILTER)
    message: Unprotected broadcast receiver - consider permission protection
    languages: [kotlin]
    severity: WARNING

  # ============================================
  # Android - Intent Security
  # ============================================

  - id: kotlin-android-implicit-intent
    pattern: Intent($ACTION)
    message: Implicit Intent may be intercepted - prefer explicit intents for sensitive data
    languages: [kotlin]
    severity: INFO

  - id: kotlin-android-intent-setdata-untrusted
    pattern: |
      intent.data = $URI
      ...
      startActivity(intent)
    message: Starting activity with untrusted data URI - validate origin
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-android-setresult-uri
    pattern: setResult($CODE, Intent().setData($URI))
    message: Returning URI in result - ensure proper access control (CWE-284)
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-284"

  - id: kotlin-android-setresult-intent
    pattern: setResult(..., $INTENT)
    message: Returning Intent as result - validate content before returning
    languages: [kotlin]
    severity: INFO

  - id: kotlin-android-startactivityforresult-implicit
    pattern: startActivityForResult(Intent(...), ...)
    message: startActivityForResult with implicit intent - result may come from malicious app
    languages: [kotlin]
    severity: WARNING

  # ============================================
  # Android - Content Provider Security
  # ============================================

  - id: kotlin-android-contentprovider-query
    pattern: contentResolver.query($URI, ...)
    message: ContentProvider query - validate URI source and permissions
    languages: [kotlin]
    severity: INFO

  - id: kotlin-android-contentprovider-openinputstream
    pattern: contentResolver.openInputStream($URI)
    message: Opening stream from ContentProvider URI - validate URI source
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-android-grant-uri-permission
    pattern: grantUriPermission($PACKAGE, $URI, ...)
    message: Granting URI permission - verify package and URI (CWE-284)
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-284"

  - id: kotlin-android-flag-grant-read
    pattern: Intent.FLAG_GRANT_READ_URI_PERMISSION
    message: Granting read URI permission via Intent flag - verify recipient
    languages: [kotlin]
    severity: INFO

  # ============================================
  # Android - File Provider Security
  # ============================================

  - id: kotlin-android-fileprovider-geturi
    pattern: FileProvider.getUriForFile($CTX, $AUTH, $FILE)
    message: FileProvider URI generation - ensure paths are properly scoped
    languages: [kotlin]
    severity: INFO

  - id: kotlin-android-chooser-with-uri
    pattern: Intent.createChooser($INTENT, ...)
    message: Chooser with file - ensure no sensitive files are exposed (CWE-552)
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-552"

  # ============================================
  # Android - AWS/Cloud SDK Security
  # ============================================

  - id: kotlin-aws-cognito-identitypool
    pattern: CognitoCredentialsProvider($POOL_ID, ...)
    message: AWS Cognito Identity Pool - ensure unauthenticated access is properly restricted
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-aws-cognito-userpool
    pattern: CognitoUserPool($CTX, $POOL_ID, $CLIENT_ID, ...)
    message: AWS Cognito User Pool - verify client ID is not exposed in source
    languages: [kotlin]
    severity: INFO

  - id: kotlin-aws-s3-public-read
    pattern: CannedAccessControlList.PublicRead
    message: AWS S3 public read ACL - ensure intentional (CWE-284)
    languages: [kotlin]
    severity: ERROR
    metadata:
      cwe: "CWE-284"

  # ============================================
  # Android - SharedPreferences Security
  # ============================================

  - id: kotlin-android-sharedprefs-mode-private-missing
    pattern: getSharedPreferences($NAME, $MODE)
    message: SharedPreferences - ensure MODE_PRIVATE for sensitive data
    languages: [kotlin]
    severity: INFO

  - id: kotlin-android-sharedprefs-putstring-password
    pattern: $PREFS.edit().putString(..., $PASSWORD)
    message: Storing sensitive data in SharedPreferences - use EncryptedSharedPreferences
    languages: [kotlin]
    severity: WARNING

  - id: kotlin-android-encryptedprefs-missing
    pattern-regex: 'getSharedPreferences\(.*\)'
    pattern-not-regex: 'EncryptedSharedPreferences'
    message: Consider EncryptedSharedPreferences for sensitive data
    languages: [kotlin]
    severity: INFO

  # ============================================
  # Android - SSL/TLS Pinning Issues
  # ============================================

  - id: kotlin-android-onreceivedssllerror-proceed
    pattern: |
      fun onReceivedSslError(..., $HANDLER: SslErrorHandler, ...) {
        ...
        $HANDLER.proceed()
        ...
      }
    message: SSL error ignored - certificate validation bypassed (CWE-295)
    languages: [kotlin]
    severity: ERROR
    metadata:
      cwe: "CWE-295"

  - id: kotlin-android-sslsocketfactory-trust
    pattern: SSLSocketFactory($TRUST_MANAGER)
    message: Custom SSLSocketFactory - verify proper certificate validation
    languages: [kotlin]
    severity: WARNING

  # ============================================
  # Android - Deep Link Security
  # ============================================

  - id: kotlin-android-deeplink-getdata
    pattern: intent?.data
    message: Deep link data - validate URL scheme and host before processing
    languages: [kotlin]
    severity: INFO

  - id: kotlin-android-deeplink-host-check-missing
    pattern: |
      val uri = intent.data
      ...
      $WEBVIEW.loadUrl(uri.toString())
    message: Deep link loaded in WebView without host validation (CWE-939)
    languages: [kotlin]
    severity: ERROR
    metadata:
      cwe: "CWE-939"

  # ============================================
  # Android - Logging Credentials
  # ============================================

  - id: kotlin-android-log-credentials
    pattern: Log.$METHOD($TAG, ...$CRED...)
    message: Potential credential logging - sensitive data in logcat
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-532"

  - id: kotlin-android-log-token
    pattern-regex: 'Log\.\w+\([^,]+,\s*.*(?:token|password|secret|key|auth).*\)'
    message: Sensitive data may be logged - review for credential exposure
    languages: [kotlin]
    severity: WARNING

  # ============================================
  # Android - Activity/Component Export
  # ============================================

  - id: kotlin-android-activity-intent-filter
    pattern-regex: '@.*IntentFilter'
    message: Activity with IntentFilter is implicitly exported - verify access control
    languages: [kotlin]
    severity: INFO

  - id: kotlin-android-broadcast-receiver-class
    pattern: 'class $NAME : BroadcastReceiver()'
    message: BroadcastReceiver - ensure proper permission protection if exported
    languages: [kotlin]
    severity: INFO

  # ============================================
  # Android - Arbitrary Code Execution (ACE)
  # Third-party Package Context Abuse
  # ============================================

  - id: kotlin-android-createpackagecontext-include-code
    pattern-regex: 'createPackageContext\s*\([^)]*CONTEXT_INCLUDE_CODE'
    message: createPackageContext with CONTEXT_INCLUDE_CODE enables code execution from external packages - ACE risk (CWE-94)
    languages: [kotlin]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  - id: kotlin-android-createpackagecontext-ignore-security
    pattern-regex: 'createPackageContext\s*\([^)]*CONTEXT_IGNORE_SECURITY'
    message: createPackageContext with CONTEXT_IGNORE_SECURITY bypasses security checks - ACE risk (CWE-94)
    languages: [kotlin]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  - id: kotlin-android-createpackagecontext
    pattern: createPackageContext($PKG, $FLAGS)
    message: createPackageContext may load code from external apps - verify signature validation (CWE-94)
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-94"

  - id: kotlin-android-classloader-loadclass
    pattern: $CTX.classLoader.loadClass($CLASS)
    message: Dynamic class loading from external package - potential ACE if package is untrusted (CWE-94)
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-94"

  - id: kotlin-android-reflection-getmethod-invoke
    pattern: |
      $OBJ.getMethod($METHOD, ...)
      ...
      $X.invoke(...)
    message: Reflection-based method invocation - verify class source is trusted (CWE-470)
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-470"

  - id: kotlin-android-dexclassloader
    pattern: DexClassLoader($DEX, ...)
    message: DexClassLoader loads external code - ensure dex source is trusted and verified (CWE-94)
    languages: [kotlin]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  - id: kotlin-android-pathclassloader
    pattern: PathClassLoader($PATH, ...)
    message: PathClassLoader loads external code - ensure path source is trusted (CWE-94)
    languages: [kotlin]
    severity: WARNING
    metadata:
      cwe: "CWE-94"

  - id: kotlin-android-getinstalledpackages
    pattern: $PM.getInstalledPackages(...)
    message: Enumerating installed packages - if combined with createPackageContext may enable ACE
    languages: [kotlin]
    severity: INFO

  - id: kotlin-android-package-prefix-check
    pattern-regex: 'packageName\s*\.\s*startsWith\s*\('
    message: Package name prefix check - weak validation for module loading, verify signature instead
    languages: [kotlin]
    severity: WARNING
