# Template Security Rules (Pug, EJS, Handlebars, Nunjucks)
# Scans template files for XSS and injection vulnerabilities
rules:
  # ============================================
  # Pug/Jade Template XSS
  # ============================================

  # Pug unescaped interpolation with != operator
  - id: pug-xss-unescaped-operator
    pattern-regex: "!=\\s*['\"]?.*\\+"
    message: "Pug unescaped output (!=) with string concatenation - XSS vulnerability"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, pug, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"

  # Pug != with variable
  - id: pug-xss-unescaped-variable
    pattern-regex: "^\\s*\\w+!=\\s*\\w+|\\s+!=\\s*\\w+"
    message: "Pug unescaped output (!=) - XSS risk if variable contains user input"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, pug, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"

  # Pug !{} unescaped interpolation
  - id: pug-xss-unescaped-interpolation
    pattern-regex: "!\\{[^}]+\\}"
    message: "Pug unescaped interpolation (!{}) - XSS vulnerability if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, pug, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"

  # Pug script tag with variable
  - id: pug-xss-script-variable
    pattern-regex: "script\\.?\\s*\\.?\\s*=?\\s*[\"']?.*#\\{"
    message: "Pug script tag with interpolation - potential XSS"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, pug, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"

  # ============================================
  # EJS Template XSS
  # ============================================

  # EJS <%- unescaped output
  - id: ejs-xss-unescaped
    pattern-regex: "<%-[^%]*%>"
    message: "EJS unescaped output (<%-) - XSS vulnerability if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, ejs, template]
    paths:
      include:
        - "*.ejs"

  # EJS with innerHTML
  - id: ejs-xss-innerhtml
    pattern-regex: "innerHTML\\s*=.*<%="
    message: "EJS output in innerHTML context - XSS risk"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, ejs, template]
    paths:
      include:
        - "*.ejs"

  # ============================================
  # Handlebars Template XSS
  # ============================================

  # Handlebars triple-mustache unescaped
  - id: handlebars-xss-triple-mustache
    pattern-regex: "\\{\\{\\{[^}]+\\}\\}\\}"
    message: "Handlebars unescaped output ({{{}}}) - XSS vulnerability if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, handlebars, template]
    paths:
      include:
        - "*.hbs"
        - "*.handlebars"

  # Handlebars SafeString
  - id: handlebars-safestring-user-input
    pattern-regex: "Handlebars\\.SafeString\\s*\\("
    message: "Handlebars.SafeString bypasses escaping - ensure content is sanitized"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, handlebars, template]
    paths:
      include:
        - "*.hbs"
        - "*.handlebars"
        - "*.js"

  # ============================================
  # Nunjucks Template XSS
  # ============================================

  # Nunjucks safe filter
  - id: nunjucks-xss-safe-filter
    pattern-regex: "\\|\\s*safe\\s*}}"
    message: "Nunjucks safe filter bypasses escaping - XSS risk if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, nunjucks, template]
    paths:
      include:
        - "*.njk"
        - "*.nunjucks"
        - "*.html"

  # ============================================
  # Mustache Template XSS
  # ============================================

  # Mustache triple-mustache unescaped
  - id: mustache-xss-triple-mustache
    pattern-regex: "\\{\\{\\{[^}]+\\}\\}\\}"
    message: "Mustache unescaped output ({{{}}}) - XSS vulnerability"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, mustache, template]
    paths:
      include:
        - "*.mustache"

  # Mustache &-prefixed unescaped
  - id: mustache-xss-ampersand
    pattern-regex: "\\{\\{&[^}]+\\}\\}"
    message: "Mustache unescaped output ({{&}}) - XSS vulnerability"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, mustache, template]
    paths:
      include:
        - "*.mustache"

  # ============================================
  # Twig Template XSS
  # ============================================

  # Twig raw filter
  - id: twig-xss-raw-filter
    pattern-regex: "\\|\\s*raw\\s*}}"
    message: "Twig raw filter bypasses escaping - XSS risk if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, twig, template]
    paths:
      include:
        - "*.twig"

  # ============================================
  # General Template Injection
  # ============================================

  # SSTI indicators - user input in template
  - id: template-ssti-indicator
    pattern-regex: "\\{\\{\\s*\\d+\\s*\\*\\s*\\d+\\s*\\}\\}|\\{\\{.*\\.__class__.*\\}\\}|\\{\\{.*config.*\\}\\}"
    message: "Potential Server-Side Template Injection (SSTI) payload detected"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      owasp: "A03:2021"
      tags: [ssti, template-injection]
    paths:
      include:
        - "*.pug"
        - "*.jade"
        - "*.ejs"
        - "*.hbs"
        - "*.njk"
        - "*.twig"
        - "*.mustache"

  # Dangerous template includes
  - id: template-dynamic-include
    pattern-regex: "include\\s+[\"']?\\s*\\+|extends\\s+[\"']?\\s*\\+"
    message: "Dynamic template include/extends - potential path traversal or SSTI"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"
        - "*.ejs"
        - "*.njk"

  # ============================================
  # Jinja2 Template XSS (Flask/Python)
  # ============================================

  # Jinja2 safe filter
  - id: jinja2-xss-safe-filter
    pattern-regex: "\\|\\s*safe\\s*\\}\\}"
    message: "Jinja2 safe filter bypasses HTML escaping - XSS risk if content is user-controlled (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, jinja2, flask, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 .decode() in template (binary to string without escaping)
  - id: jinja2-xss-decode
    pattern-regex: "\\{\\{[^}]*\\.decode\\(\\)[^}]*\\}\\}"
    message: "Jinja2 .decode() in template - binary data may contain XSS payload (CWE-79)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 variable in data attribute
  - id: jinja2-data-attr-xss
    pattern-regex: "data\\s*=\\s*[\"']\\{\\{[^}]+\\}\\}[\"']"
    message: "Jinja2 variable in data attribute - may allow data URI injection (CWE-79)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 variable in href/src (potential open redirect)
  - id: jinja2-href-src-injection
    pattern-regex: "(href|src)\\s*=\\s*[\"']\\{\\{[^}]+\\}\\}[\"']"
    message: "Jinja2 variable in href/src - validate URL to prevent open redirect (CWE-601)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [redirect, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 variable in onclick/event handlers
  - id: jinja2-event-handler-xss
    pattern-regex: "(onclick|onerror|onload|onmouseover|onfocus)\\s*=\\s*[\"'][^\"']*\\{\\{"
    message: "Jinja2 variable in event handler - critical XSS vulnerability (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 variable in style attribute (CSS injection)
  - id: jinja2-style-injection
    pattern-regex: "style\\s*=\\s*[\"'][^\"']*\\{\\{"
    message: "Jinja2 variable in style attribute - CSS injection risk (CWE-79)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, css-injection, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 in script tag
  - id: jinja2-script-injection
    pattern-regex: "<script[^>]*>[^<]*\\{\\{[^}]+\\}\\}"
    message: "Jinja2 variable inside script tag - XSS risk, use |tojson filter (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # ============================================
  # HTML Object/Embed Tags
  # ============================================

  # Object tag with template variable
  - id: html-object-tag-injection
    pattern-regex: "<object[^>]*\\{\\{"
    message: "Object tag with template variable - may allow malicious embedding (CWE-829)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-829"
      tags: [xss, embed, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"
        - "*.ejs"
        - "*.hbs"

  # Embed tag with template variable
  - id: html-embed-tag-injection
    pattern-regex: "<embed[^>]*\\{\\{"
    message: "Embed tag with template variable - may allow malicious embedding (CWE-829)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-829"
      tags: [xss, embed, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"
        - "*.ejs"
        - "*.hbs"

  # Iframe with template variable
  - id: html-iframe-injection
    pattern-regex: "<iframe[^>]*\\{\\{"
    message: "Iframe with template variable - clickjacking or malicious embedding risk (CWE-1021)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-1021"
      tags: [clickjacking, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"
        - "*.ejs"
        - "*.hbs"

  # ============================================
  # Meta Tag Security
  # ============================================

  # Meta refresh with template variable
  - id: html-meta-refresh-injection
    pattern-regex: "<meta[^>]*http-equiv\\s*=\\s*[\"']refresh[\"'][^>]*\\{\\{"
    message: "Meta refresh with template variable - open redirect risk (CWE-601)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [redirect, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Base tag with template variable
  - id: html-base-tag-injection
    pattern-regex: "<base[^>]*href\\s*=\\s*[\"']\\{\\{"
    message: "Base tag with template variable - can hijack all relative URLs (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # ============================================
  # Credential Disclosure in Templates
  # ============================================

  # Hardcoded credentials displayed in HTML/templates
  - id: html-credential-disclosure
    pattern-regex: "(?:admin|user|root|test)\\s*[:/]\\s*(?:admin|password|pass|123|test|secret)"
    message: "Plaintext credentials visible in template - information disclosure (CWE-200)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-200"
      owasp: "A01:2021"
      tags: [credential-disclosure, information-disclosure, vulnerable-node]
    paths:
      include:
        - "*.html"
        - "*.ejs"
        - "*.pug"
        - "*.jade"
        - "*.hbs"
        - "*.jinja"
        - "*.jinja2"

  # Password hint/display in templates
  - id: template-password-display
    pattern-regex: "(?:<p|<span|<div|<td|<li)[^>]*>.*(?:password|pwd|passwd)\\s*[:=]\\s*\\w+"
    message: "Password displayed in template - credentials should never be shown in UI (CWE-200)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-200"
      tags: [credential-disclosure, vulnerable-node]
    paths:
      include:
        - "*.html"
        - "*.ejs"
        - "*.pug"
        - "*.hbs"

  # Demo/test user credentials in templates
  - id: template-demo-credentials
    pattern-regex: "(?:demo|test|sample|example)\\s+(?:user|account|login)[^<]*:\\s*\\w+"
    message: "Demo credentials in template - may be exploited if left in production (CWE-798)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-798"
      tags: [credential-disclosure]
    paths:
      include:
        - "*.html"
        - "*.ejs"
        - "*.pug"
        - "*.hbs"
