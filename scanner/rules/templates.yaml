# Template Security Rules (Pug, EJS, Handlebars, Nunjucks)
# Scans template files for XSS and injection vulnerabilities
rules:
  # ============================================
  # Pug/Jade Template XSS
  # ============================================

  # Pug unescaped interpolation with != operator
  - id: pug-xss-unescaped-operator
    pattern-regex: "!=\\s*['\"]?.*\\+"
    message: "Pug unescaped output (!=) with string concatenation - XSS vulnerability"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, pug, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"

  # Pug != with variable
  - id: pug-xss-unescaped-variable
    pattern-regex: "^\\s*\\w+!=\\s*\\w+|\\s+!=\\s*\\w+"
    message: "Pug unescaped output (!=) - XSS risk if variable contains user input"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, pug, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"

  # Pug !{} unescaped interpolation
  - id: pug-xss-unescaped-interpolation
    pattern-regex: "!\\{[^}]+\\}"
    message: "Pug unescaped interpolation (!{}) - XSS vulnerability if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, pug, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"

  # Pug script tag with variable
  - id: pug-xss-script-variable
    pattern-regex: "script\\.?\\s*\\.?\\s*=?\\s*[\"']?.*#\\{"
    message: "Pug script tag with interpolation - potential XSS"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, pug, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"

  # ============================================
  # EJS Template XSS
  # ============================================

  # EJS <%- unescaped output
  - id: ejs-xss-unescaped
    pattern-regex: "<%-[^%]*%>"
    message: "EJS unescaped output (<%-) - XSS vulnerability if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, ejs, template]
    paths:
      include:
        - "*.ejs"

  # EJS with innerHTML
  - id: ejs-xss-innerhtml
    pattern-regex: "innerHTML\\s*=.*<%="
    message: "EJS output in innerHTML context - XSS risk"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, ejs, template]
    paths:
      include:
        - "*.ejs"

  # ============================================
  # Handlebars Template XSS
  # ============================================

  # Handlebars triple-mustache unescaped
  - id: handlebars-xss-triple-mustache
    pattern-regex: "\\{\\{\\{[^}]+\\}\\}\\}"
    message: "Handlebars unescaped output ({{{}}}) - XSS vulnerability if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, handlebars, template]
    paths:
      include:
        - "*.hbs"
        - "*.handlebars"

  # Handlebars SafeString
  - id: handlebars-safestring-user-input
    pattern-regex: "Handlebars\\.SafeString\\s*\\("
    message: "Handlebars.SafeString bypasses escaping - ensure content is sanitized"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, handlebars, template]
    paths:
      include:
        - "*.hbs"
        - "*.handlebars"
        - "*.js"

  # ============================================
  # Nunjucks Template XSS
  # ============================================

  # Nunjucks safe filter
  - id: nunjucks-xss-safe-filter
    pattern-regex: "\\|\\s*safe\\s*}}"
    message: "Nunjucks safe filter bypasses escaping - XSS risk if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, nunjucks, template]
    paths:
      include:
        - "*.njk"
        - "*.nunjucks"
        - "*.html"

  # ============================================
  # Mustache Template XSS
  # ============================================

  # Mustache triple-mustache unescaped
  - id: mustache-xss-triple-mustache
    pattern-regex: "\\{\\{\\{[^}]+\\}\\}\\}"
    message: "Mustache unescaped output ({{{}}}) - XSS vulnerability"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, mustache, template]
    paths:
      include:
        - "*.mustache"

  # Mustache &-prefixed unescaped
  - id: mustache-xss-ampersand
    pattern-regex: "\\{\\{&[^}]+\\}\\}"
    message: "Mustache unescaped output ({{&}}) - XSS vulnerability"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, mustache, template]
    paths:
      include:
        - "*.mustache"

  # ============================================
  # Twig Template XSS
  # ============================================

  # Twig raw filter
  - id: twig-xss-raw-filter
    pattern-regex: "\\|\\s*raw\\s*}}"
    message: "Twig raw filter bypasses escaping - XSS risk if content is user-controlled"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, twig, template]
    paths:
      include:
        - "*.twig"

  # ============================================
  # General Template Injection
  # ============================================

  # SSTI indicators - user input in template
  - id: template-ssti-indicator
    pattern-regex: "\\{\\{\\s*\\d+\\s*\\*\\s*\\d+\\s*\\}\\}|\\{\\{.*\\.__class__.*\\}\\}|\\{\\{.*config.*\\}\\}"
    message: "Potential Server-Side Template Injection (SSTI) payload detected"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      owasp: "A03:2021"
      tags: [ssti, template-injection]
    paths:
      include:
        - "*.pug"
        - "*.jade"
        - "*.ejs"
        - "*.hbs"
        - "*.njk"
        - "*.twig"
        - "*.mustache"

  # Dangerous template includes
  - id: template-dynamic-include
    pattern-regex: "include\\s+[\"']?\\s*\\+|extends\\s+[\"']?\\s*\\+"
    message: "Dynamic template include/extends - potential path traversal or SSTI"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, template]
    paths:
      include:
        - "*.pug"
        - "*.jade"
        - "*.ejs"
        - "*.njk"

  # ============================================
  # Jinja2 Template XSS (Flask/Python)
  # ============================================

  # Jinja2 safe filter
  - id: jinja2-xss-safe-filter
    pattern-regex: "\\|\\s*safe\\s*\\}\\}"
    message: "Jinja2 safe filter bypasses HTML escaping - XSS risk if content is user-controlled (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, jinja2, flask, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 .decode() in template (binary to string without escaping)
  - id: jinja2-xss-decode
    pattern-regex: "\\{\\{[^}]*\\.decode\\(\\)[^}]*\\}\\}"
    message: "Jinja2 .decode() in template - binary data may contain XSS payload (CWE-79)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 variable in data attribute
  - id: jinja2-data-attr-xss
    pattern-regex: "data\\s*=\\s*[\"']\\{\\{[^}]+\\}\\}[\"']"
    message: "Jinja2 variable in data attribute - may allow data URI injection (CWE-79)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 variable in href/src (potential open redirect)
  - id: jinja2-href-src-injection
    pattern-regex: "(href|src)\\s*=\\s*[\"']\\{\\{[^}]+\\}\\}[\"']"
    message: "Jinja2 variable in href/src - validate URL to prevent open redirect (CWE-601)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [redirect, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 variable in onclick/event handlers
  - id: jinja2-event-handler-xss
    pattern-regex: "(onclick|onerror|onload|onmouseover|onfocus)\\s*=\\s*[\"'][^\"']*\\{\\{"
    message: "Jinja2 variable in event handler - critical XSS vulnerability (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 variable in style attribute (CSS injection)
  - id: jinja2-style-injection
    pattern-regex: "style\\s*=\\s*[\"'][^\"']*\\{\\{"
    message: "Jinja2 variable in style attribute - CSS injection risk (CWE-79)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, css-injection, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Jinja2 in script tag
  - id: jinja2-script-injection
    pattern-regex: "<script[^>]*>[^<]*\\{\\{[^}]+\\}\\}"
    message: "Jinja2 variable inside script tag - XSS risk, use |tojson filter (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, jinja2, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # ============================================
  # HTML Object/Embed Tags
  # ============================================

  # Object tag with template variable
  - id: html-object-tag-injection
    pattern-regex: "<object[^>]*\\{\\{"
    message: "Object tag with template variable - may allow malicious embedding (CWE-829)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-829"
      tags: [xss, embed, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"
        - "*.ejs"
        - "*.hbs"

  # Embed tag with template variable
  - id: html-embed-tag-injection
    pattern-regex: "<embed[^>]*\\{\\{"
    message: "Embed tag with template variable - may allow malicious embedding (CWE-829)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-829"
      tags: [xss, embed, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"
        - "*.ejs"
        - "*.hbs"

  # Iframe with template variable
  - id: html-iframe-injection
    pattern-regex: "<iframe[^>]*\\{\\{"
    message: "Iframe with template variable - clickjacking or malicious embedding risk (CWE-1021)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-1021"
      tags: [clickjacking, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"
        - "*.ejs"
        - "*.hbs"

  # ============================================
  # Meta Tag Security
  # ============================================

  # Meta refresh with template variable
  - id: html-meta-refresh-injection
    pattern-regex: "<meta[^>]*http-equiv\\s*=\\s*[\"']refresh[\"'][^>]*\\{\\{"
    message: "Meta refresh with template variable - open redirect risk (CWE-601)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [redirect, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Base tag with template variable
  - id: html-base-tag-injection
    pattern-regex: "<base[^>]*href\\s*=\\s*[\"']\\{\\{"
    message: "Base tag with template variable - can hijack all relative URLs (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, template]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # ============================================
  # Credential Disclosure in Templates
  # ============================================

  # Hardcoded credentials displayed in HTML/templates
  - id: html-credential-disclosure
    pattern-regex: "(?:admin|user|root|test)\\s*[:/]\\s*(?:admin|password|pass|123|test|secret)"
    message: "Plaintext credentials visible in template - information disclosure (CWE-200)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-200"
      owasp: "A01:2021"
      tags: [credential-disclosure, information-disclosure, vulnerable-node]
    paths:
      include:
        - "*.html"
        - "*.ejs"
        - "*.pug"
        - "*.jade"
        - "*.hbs"
        - "*.jinja"
        - "*.jinja2"

  # Password hint/display in templates
  - id: template-password-display
    pattern-regex: "(?:<p|<span|<div|<td|<li)[^>]*>.*(?:password|pwd|passwd)\\s*[:=]\\s*\\w+"
    message: "Password displayed in template - credentials should never be shown in UI (CWE-200)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-200"
      tags: [credential-disclosure, vulnerable-node]
    paths:
      include:
        - "*.html"
        - "*.ejs"
        - "*.pug"
        - "*.hbs"

  # Demo/test user credentials in templates
  - id: template-demo-credentials
    pattern-regex: "(?:demo|test|sample|example)\\s+(?:user|account|login)[^<]*:\\s*\\w+"
    message: "Demo credentials in template - may be exploited if left in production (CWE-798)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-798"
      tags: [credential-disclosure]
    paths:
      include:
        - "*.html"
        - "*.ejs"
        - "*.pug"
        - "*.hbs"

  # ============================================
  # Stack Trace / Error Disclosure in Templates
  # ============================================

  # EJS error.stack display
  - id: ejs-stack-trace-disclosure
    pattern-regex: "<%[=-]\\s*(?:error|err|exception)\\.stack\\s*%>"
    message: "Stack trace displayed in template - information disclosure vulnerability (CWE-209)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-209"
      owasp: "A01:2021"
      tags: [information-disclosure, ejs, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # Jinja2 error stack display
  - id: jinja2-stack-trace-disclosure
    pattern-regex: "\\{\\{\\s*(?:error|exception)\\.(?:stack|traceback|__traceback__)\\s*\\}\\}"
    message: "Stack trace displayed in Jinja2 template - information disclosure (CWE-209)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-209"
      tags: [information-disclosure, jinja2]
    paths:
      include:
        - "*.html"
        - "*.jinja"
        - "*.jinja2"

  # Generic error object in template
  - id: template-error-object-display
    pattern-regex: "<%[=-]\\s*error\\s*%>|\\{\\{\\s*error\\s*\\}\\}"
    message: "Error object displayed in template - may expose sensitive details (CWE-209)"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      tags: [information-disclosure]
    paths:
      include:
        - "*.ejs"
        - "*.html"
        - "*.jinja"
        - "*.hbs"

  # ============================================
  # EJS Credential Exposure (vulnerable-node Round 6)
  # ============================================

  # Hardcoded credentials in EJS template
  - id: ejs-hardcoded-credentials
    pattern-regex: "admin\\s*:\\s*admin|password\\s*:\\s*\\w+|user\\s*:\\s*\\w+"
    message: "Hardcoded credentials in template - remove test accounts before production"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      owasp: "A07:2021"
      tags: [credentials, vulnerable-node]
    paths:
      include:
        - "*.ejs"
        - "*.html"
        - "*.hbs"

  # Default password displayed in template
  - id: template-password-displayed
    pattern-regex: "password.*['\"][a-zA-Z0-9]+['\"]|['\"][a-zA-Z0-9]+['\"].*password"
    message: "Password visible in template - potential credential exposure"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-312"
      tags: [credentials, vulnerable-node]
    paths:
      include:
        - "*.ejs"
        - "*.html"

  # ============================================
  # EJS Hidden Field XSS (vulnerable-node Round 6)
  # ============================================

  # EJS variable in hidden field without escaping
  - id: ejs-hidden-field-xss
    pattern-regex: "type=['\"]hidden['\"][^>]*value=['\"]<%-"
    message: "EJS unescaped output in hidden field - XSS via value attribute"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, ejs, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # Hidden input with server variable
  - id: ejs-hidden-input-variable
    pattern-regex: "<input[^>]*type=['\"]hidden['\"][^>]*<%[-=]"
    message: "Server variable in hidden input - validate and escape properly"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, ejs, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # ============================================
  # EJS Error Message Display (vulnerable-node Round 6)
  # ============================================

  # EJS auth_error or error message displayed
  - id: ejs-error-message-display
    pattern-regex: "<%[-=]\\s*(?:auth_)?error\\s*%>|<%[-=]\\s*\\w+_error\\s*%>"
    message: "Error message displayed in template - sanitize to prevent XSS"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, information-disclosure, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # Error in span/label without escaping
  - id: ejs-error-in-element
    pattern-regex: "<(?:span|label|div)[^>]*class=['\"][^'\"]*(?:error|danger|warning)[^'\"]*['\"][^>]*>\\s*<%[-=]"
    message: "Error message in styled element - ensure proper escaping"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # ============================================
  # EJS URL Parameter Display (vulnerable-node Round 6)
  # ============================================

  # Return URL in template
  - id: ejs-returnurl-xss
    pattern-regex: "<%[-=]\\s*returnurl\\s*%>|<%[-=]\\s*return_url\\s*%>|<%[-=]\\s*redirect\\s*%>"
    message: "URL parameter in template - validate to prevent XSS and open redirect"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, open-redirect, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # Query parameter in href
  - id: ejs-query-param-href
    pattern-regex: "href=['\"]<%[-=]\\s*\\w+\\s*%>['\"]"
    message: "Server variable in href - validate to prevent XSS and open redirect"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [xss, open-redirect, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # ============================================
  # EJS Product/Data Display (vulnerable-node Round 6)
  # ============================================

  # Product data unescaped
  - id: ejs-product-data-xss
    pattern-regex: "<%[-]\\s*product\\.(?:name|description|title|image)\\s*%>"
    message: "Product data displayed without escaping - stored XSS risk"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, stored-xss, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # User data unescaped
  - id: ejs-user-data-xss
    pattern-regex: "<%[-]\\s*user\\.(?:name|email|bio|website)\\s*%>"
    message: "User data displayed without escaping - stored XSS risk"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, stored-xss, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # Loop variable unescaped in link
  - id: ejs-loop-variable-href
    pattern-regex: "href=['\"][^'\"]*<%[-]\\s*\\w+\\.(?:id|url|link)\\s*%>"
    message: "Loop variable in href - ensure ID is numeric or URL is validated"
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, vulnerable-node]
    paths:
      include:
        - "*.ejs"

  # ============================================
  # Django Template XSS (DjangoGoat)
  # ============================================

  # Django template |safe filter
  - id: django-template-safe-filter
    pattern-regex: "\\{\\{\\s*\\w+[^}]*\\|\\s*safe\\s*\\}\\}"
    message: "Django template |safe filter - XSS vulnerability if content is user-controlled (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, django, template, djangogoat]
    paths:
      include:
        - "*.html"
        - "*.django"
        - "*.jinja2"

  # Django template autoescape off
  - id: django-template-autoescape-off
    pattern-regex: "\\{%\\s*autoescape\\s+off\\s*%\\}"
    message: "Django template autoescape disabled - XSS vulnerability (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, django, template, djangogoat]
    paths:
      include:
        - "*.html"
        - "*.django"
        - "*.jinja2"

  # Django template variable in onclick/event handler
  - id: django-template-event-handler
    pattern-regex: "(onclick|onerror|onload|onmouseover)\\s*=\\s*[\"'][^\"']*\\{\\{"
    message: "Django template variable in event handler - XSS vulnerability (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, django, template]
    paths:
      include:
        - "*.html"
        - "*.django"

  # Django template mark_safe in template tag
  - id: django-template-mark-safe
    pattern-regex: "mark_safe\\s*\\("
    message: "Django mark_safe() - XSS risk if input is user-controlled (CWE-79)"
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, django, template]
    paths:
      include:
        - "*.py"
        - "*.html"
