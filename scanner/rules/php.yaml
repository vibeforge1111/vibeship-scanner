# PHP Security Rules (Streamlined ~65 rules)
rules:
  # ============================================
  # Command Injection
  # ============================================

  - id: php-shell-exec
    pattern: shell_exec(...)
    message: PHP shell_exec() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-exec
    pattern: exec(...)
    message: PHP exec() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-system
    pattern: system(...)
    message: PHP system() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-passthru
    pattern: passthru(...)
    message: PHP passthru() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-popen
    pattern: popen(...)
    message: PHP popen() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-proc-open
    pattern: proc_open(...)
    message: PHP proc_open() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-backtick
    pattern: '`$CMD`'
    message: PHP backtick execution - command injection risk
    languages: [php]
    severity: ERROR

  # ============================================
  # Code Injection
  # ============================================

  - id: php-eval
    pattern: eval(...)
    message: PHP eval() - code injection risk
    languages: [php]
    severity: ERROR

  - id: php-assert
    pattern: assert(...)
    message: PHP assert() with string - code injection risk
    languages: [php]
    severity: ERROR

  - id: php-create-function
    pattern: create_function(...)
    message: PHP create_function() - code injection risk (deprecated)
    languages: [php]
    severity: ERROR

  - id: php-preg-replace-e
    pattern: 'preg_replace("/.*/e", ...)'
    message: PHP preg_replace with /e modifier - code injection
    languages: [php]
    severity: ERROR

  # ============================================
  # File Inclusion (LFI/RFI)
  # ============================================

  - id: php-include-var
    pattern: include($X)
    message: PHP include with variable - file inclusion risk
    languages: [php]
    severity: ERROR

  - id: php-include-once-var
    pattern: include_once($X)
    message: PHP include_once with variable - file inclusion risk
    languages: [php]
    severity: ERROR

  - id: php-require-var
    pattern: require($X)
    message: PHP require with variable - file inclusion risk
    languages: [php]
    severity: ERROR

  - id: php-require-once-var
    pattern: require_once($X)
    message: PHP require_once with variable - file inclusion risk
    languages: [php]
    severity: ERROR

  # ============================================
  # SQL Injection
  # ============================================

  - id: php-mysqli-query-concat
    pattern: mysqli_query($CONN, $Q . $V)
    message: PHP SQL injection via string concatenation
    languages: [php]
    severity: ERROR

  - id: php-mysql-query
    pattern: mysql_query(...)
    message: PHP mysql_query() - deprecated and SQL injection risk
    languages: [php]
    severity: ERROR

  - id: php-pdo-query-var
    pattern: $PDO->query($QUERY)
    message: PHP PDO query() - use prepare() with bound parameters
    languages: [php]
    severity: WARNING

  - id: php-pdo-exec-var
    pattern: $PDO->exec($QUERY)
    message: PHP PDO exec() - use prepare() with bound parameters
    languages: [php]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: php-unserialize
    pattern: unserialize(...)
    message: PHP unserialize() - insecure deserialization risk
    languages: [php]
    severity: ERROR

  # ============================================
  # Weak Password Handling
  # ============================================

  - id: php-md5-password
    pattern: md5($PASSWORD)
    message: PHP MD5 for password - use password_hash() instead
    languages: [php]
    severity: WARNING

  - id: php-sha1-password
    pattern: sha1($PASSWORD)
    message: PHP SHA1 for password - use password_hash() instead
    languages: [php]
    severity: WARNING

  - id: php-password-plain-compare
    pattern: if ($PASSWORD == $X)
    message: PHP password - use password_verify() instead
    languages: [php]
    severity: ERROR

  # ============================================
  # SSRF
  # ============================================

  - id: php-file-get-contents-url
    pattern: file_get_contents($URL)
    message: PHP file_get_contents with URL - potential SSRF
    languages: [php]
    severity: WARNING

  - id: php-curl-ssl-verify-off
    pattern: 'curl_setopt($CH, CURLOPT_SSL_VERIFYPEER, false)'
    message: PHP cURL SSL verification disabled
    languages: [php]
    severity: ERROR

  # ============================================
  # Variable Injection
  # ============================================

  - id: php-extract
    pattern: extract(...)
    message: PHP extract() - variable injection risk
    languages: [php]
    severity: WARNING

  - id: php-parse-str
    pattern: parse_str($X)
    message: PHP parse_str() without second param - variable injection
    languages: [php]
    severity: WARNING

  # ============================================
  # File Upload
  # ============================================

  - id: php-move-uploaded-file
    pattern: move_uploaded_file(...)
    message: PHP file upload - ensure proper validation
    languages: [php]
    severity: WARNING

  # ============================================
  # Open Redirect
  # ============================================

  - id: php-header-redirect
    pattern: 'header("Location: " . $X)'
    message: PHP open redirect risk
    languages: [php]
    severity: WARNING

  # ============================================
  # Session/Cookie Security
  # ============================================

  - id: php-setcookie-no-flags
    pattern: setcookie($NAME, $VALUE)
    message: PHP cookie - missing httponly/secure flags
    languages: [php]
    severity: WARNING

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: php-rand-crypto
    pattern: rand()
    message: PHP rand() not cryptographically secure - use random_int()
    languages: [php]
    severity: WARNING

  - id: php-mt-rand-crypto
    pattern: mt_rand()
    message: PHP mt_rand() not cryptographically secure - use random_int()
    languages: [php]
    severity: WARNING

  - id: php-uniqid-token
    pattern: uniqid()
    message: PHP uniqid() is predictable - use random_bytes() for tokens
    languages: [php]
    severity: WARNING

  - id: php-openssl-ecb
    pattern: 'openssl_encrypt($DATA, "...-ecb", ...)'
    message: PHP ECB mode is insecure - use GCM or CBC
    languages: [php]
    severity: ERROR

  # ============================================
  # Information Disclosure
  # ============================================

  - id: php-phpinfo
    pattern: phpinfo()
    message: PHP phpinfo() exposes sensitive server configuration
    languages: [php]
    severity: WARNING

  - id: php-display-errors-on
    pattern: 'ini_set("display_errors", "1")'
    message: PHP display_errors enabled - disable in production
    languages: [php]
    severity: WARNING

  # ============================================
  # Taint Mode - XSS
  # ============================================

  - id: php-xss-printf
    mode: taint
    message: PHP XSS vulnerability - user input in printf without sanitization
    languages: [php]
    severity: ERROR
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
    pattern-sinks:
      - pattern: printf(...)
      - pattern: sprintf(...)
    pattern-sanitizers:
      - pattern: htmlspecialchars(...)
      - pattern: htmlentities(...)

  # ============================================
  # Taint Mode - SQL Injection
  # ============================================

  - id: php-taint-sqli-query
    mode: taint
    message: PHP SQL injection - user input in database query
    languages: [php]
    severity: ERROR
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
    pattern-sinks:
      - pattern: mysqli_query($CONN, $SINK)
      - pattern: $PDO->query($SINK)
      - pattern: $MYSQLI->query($SINK)
    pattern-sanitizers:
      - pattern: mysqli_real_escape_string(...)
      - pattern: intval(...)
      - pattern: (int)$X

  # ============================================
  # Taint Mode - File Operations
  # ============================================

  - id: php-taint-file-read
    mode: taint
    message: PHP file read with user input - path traversal/SSRF risk
    languages: [php]
    severity: ERROR
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
    pattern-sinks:
      - pattern: file_get_contents($SINK)
      - pattern: fopen($SINK, ...)
      - pattern: readfile($SINK)
    pattern-sanitizers:
      - pattern: basename(...)
      - pattern: realpath(...)

  - id: php-taint-include
    mode: taint
    message: PHP file inclusion with user input - LFI/RFI vulnerability
    languages: [php]
    severity: ERROR
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
    pattern-sinks:
      - pattern: include($SINK)
      - pattern: include_once($SINK)
      - pattern: require($SINK)
      - pattern: require_once($SINK)
    pattern-sanitizers:
      - pattern: basename(...)

  # ============================================
  # Taint Mode - Command Injection
  # ============================================

  - id: php-taint-command-injection
    mode: taint
    message: PHP command injection - user input in shell command
    languages: [php]
    severity: ERROR
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
    pattern-sinks:
      - pattern: shell_exec($SINK)
      - pattern: exec($SINK)
      - pattern: system($SINK)
      - pattern: passthru($SINK)
    pattern-sanitizers:
      - pattern: escapeshellarg(...)
      - pattern: escapeshellcmd(...)

  # ============================================
  # Taint Mode - XXE
  # ============================================

  - id: php-taint-xxe
    mode: taint
    message: PHP XXE vulnerability - user input in XML parsing
    languages: [php]
    severity: ERROR
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
      - pattern: file_get_contents("php://input")
    pattern-sinks:
      - pattern: simplexml_load_string($SINK)
      - pattern: new SimpleXMLElement($SINK)
      - pattern: $DOM->loadXML($SINK)

  # ============================================
  # Laravel Security
  # ============================================

  - id: php-laravel-raw-sql
    pattern: DB::raw($QUERY)
    message: Laravel DB::raw() - ensure proper escaping for user input
    languages: [php]
    severity: WARNING

  - id: php-laravel-raw-where
    pattern: '$QUERY->whereRaw($SQL)'
    message: Laravel whereRaw() - SQL injection risk with user input
    languages: [php]
    severity: WARNING

  - id: php-laravel-unguarded
    pattern: '$MODEL::unguard()'
    message: Laravel mass assignment protection disabled
    languages: [php]
    severity: WARNING

  - id: php-laravel-blade-unescape
    pattern: '{!! $VAR !!}'
    message: Laravel Blade unescaped output - XSS risk
    languages: [php]
    severity: ERROR

  - id: php-laravel-debug-true
    pattern: "'debug' => true"
    message: Laravel debug mode enabled - disable in production
    languages: [php]
    severity: WARNING

  # ============================================
  # Symfony Security
  # ============================================

  - id: php-symfony-raw-filter
    pattern: '|raw'
    message: Symfony Twig raw filter - XSS risk
    languages: [php]
    severity: WARNING

  - id: php-symfony-csrf-disabled
    pattern: "'csrf_protection' => false"
    message: Symfony CSRF protection disabled
    languages: [php]
    severity: ERROR

  # ============================================
  # Type Juggling
  # ============================================

  - id: php-loose-comparison
    pattern: if ($PASSWORD == $HASH)
    message: PHP loose comparison - use === for security comparisons
    languages: [php]
    severity: ERROR

  - id: php-strcmp-comparison
    pattern: if (strcmp($A, $B) == 0)
    message: PHP strcmp loose comparison - use === for result check
    languages: [php]
    severity: WARNING

  # ============================================
  # JWT Security
  # ============================================

  - id: php-jwt-none-algorithm
    pattern: '"alg":"none"'
    message: PHP JWT none algorithm - authentication bypass
    languages: [php]
    severity: ERROR

  # ============================================
  # Object Injection
  # ============================================

  - id: php-wakeup-magic
    pattern: 'function __wakeup()'
    message: PHP __wakeup magic method - review for object injection
    languages: [php]
    severity: INFO

  - id: php-destruct-magic
    pattern: 'function __destruct()'
    message: PHP __destruct magic method - review for object injection
    languages: [php]
    severity: INFO

  # ============================================
  # Additional SSRF
  # ============================================

  - id: php-curl-user-url
    pattern: curl_setopt($CH, CURLOPT_URL, $USER_INPUT)
    message: PHP cURL with user input - SSRF risk
    languages: [php]
    severity: WARNING

  - id: php-guzzle-request
    pattern: '$CLIENT->request($METHOD, $USER_INPUT)'
    message: PHP Guzzle request with user input - SSRF risk
    languages: [php]
    severity: WARNING

