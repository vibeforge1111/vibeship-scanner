# PHP Security Rules (Streamlined ~65 rules)
rules:
  # ============================================
  # Command Injection
  # ============================================

  - id: php-shell-exec
    pattern: shell_exec(...)
    message: PHP shell_exec() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-exec
    pattern: exec(...)
    message: PHP exec() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-system
    pattern: system(...)
    message: PHP system() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-passthru
    pattern: passthru(...)
    message: PHP passthru() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-popen
    pattern: popen(...)
    message: PHP popen() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-proc-open
    pattern: proc_open(...)
    message: PHP proc_open() - command injection risk
    languages: [php]
    severity: ERROR

  - id: php-backtick
    pattern: '`$CMD`'
    message: PHP backtick execution - command injection risk
    languages: [php]
    severity: ERROR

  # ============================================
  # Code Injection
  # ============================================

  - id: php-eval
    pattern: eval(...)
    message: PHP eval() - code injection risk
    languages: [php]
    severity: ERROR

  - id: php-assert
    pattern: assert(...)
    message: PHP assert() with string - code injection risk
    languages: [php]
    severity: ERROR

  - id: php-create-function
    pattern: create_function(...)
    message: PHP create_function() - code injection risk (deprecated)
    languages: [php]
    severity: ERROR

  - id: php-preg-replace-e
    pattern: 'preg_replace("/.*/e", ...)'
    message: PHP preg_replace with /e modifier - code injection
    languages: [php]
    severity: ERROR

  # ============================================
  # File Inclusion (LFI/RFI)
  # ============================================

  - id: php-include-var
    pattern: include($X)
    message: PHP include with variable - file inclusion risk
    languages: [php]
    severity: ERROR

  - id: php-include-once-var
    pattern: include_once($X)
    message: PHP include_once with variable - file inclusion risk
    languages: [php]
    severity: ERROR

  - id: php-require-var
    pattern: require($X)
    message: PHP require with variable - file inclusion risk
    languages: [php]
    severity: ERROR

  - id: php-require-once-var
    pattern: require_once($X)
    message: PHP require_once with variable - file inclusion risk
    languages: [php]
    severity: ERROR

  # ============================================
  # SQL Injection
  # ============================================

  - id: php-mysqli-query-concat
    pattern: mysqli_query($CONN, $Q . $V)
    message: PHP SQL injection via string concatenation
    languages: [php]
    severity: ERROR

  - id: php-mysql-query
    pattern: mysql_query(...)
    message: PHP mysql_query() - deprecated and SQL injection risk
    languages: [php]
    severity: ERROR

  - id: php-pdo-query-var
    pattern: $PDO->query($QUERY)
    message: PHP PDO query() - use prepare() with bound parameters
    languages: [php]
    severity: WARNING

  - id: php-pdo-exec-var
    pattern: $PDO->exec($QUERY)
    message: PHP PDO exec() - use prepare() with bound parameters
    languages: [php]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: php-unserialize
    pattern: unserialize(...)
    message: PHP unserialize() - insecure deserialization risk
    languages: [php]
    severity: ERROR

  # ============================================
  # Weak Password Handling
  # ============================================

  - id: php-md5-password
    pattern: md5($PASSWORD)
    message: PHP MD5 for password - use password_hash() instead
    languages: [php]
    severity: WARNING

  - id: php-sha1-password
    pattern: sha1($PASSWORD)
    message: PHP SHA1 for password - use password_hash() instead
    languages: [php]
    severity: WARNING

  - id: php-password-plain-compare
    pattern: if ($PASSWORD == $X)
    message: PHP password - use password_verify() instead
    languages: [php]
    severity: ERROR

  # ============================================
  # SSRF
  # ============================================

  - id: php-file-get-contents-url
    pattern: file_get_contents($URL)
    message: PHP file_get_contents with URL - potential SSRF
    languages: [php]
    severity: WARNING

  - id: php-curl-ssl-verify-off
    pattern: 'curl_setopt($CH, CURLOPT_SSL_VERIFYPEER, false)'
    message: PHP cURL SSL verification disabled
    languages: [php]
    severity: ERROR

  # ============================================
  # Variable Injection
  # ============================================

  - id: php-extract
    pattern: extract(...)
    message: PHP extract() - variable injection risk
    languages: [php]
    severity: WARNING

  - id: php-parse-str
    pattern: parse_str($X)
    message: PHP parse_str() without second param - variable injection
    languages: [php]
    severity: WARNING

  # ============================================
  # File Upload
  # ============================================

  - id: php-move-uploaded-file
    pattern: move_uploaded_file(...)
    message: PHP file upload - ensure proper validation
    languages: [php]
    severity: WARNING

  # ============================================
  # Open Redirect
  # ============================================

  - id: php-header-redirect
    pattern: 'header("Location: " . $X)'
    message: PHP open redirect risk
    languages: [php]
    severity: WARNING

  # ============================================
  # Session/Cookie Security
  # ============================================

  - id: php-setcookie-no-flags
    pattern: setcookie($NAME, $VALUE)
    message: PHP cookie - missing httponly/secure flags
    languages: [php]
    severity: WARNING

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: php-rand-crypto
    pattern: rand()
    message: PHP rand() not cryptographically secure - use random_int()
    languages: [php]
    severity: WARNING

  - id: php-mt-rand-crypto
    pattern: mt_rand()
    message: PHP mt_rand() not cryptographically secure - use random_int()
    languages: [php]
    severity: WARNING

  - id: php-uniqid-token
    pattern: uniqid()
    message: PHP uniqid() is predictable - use random_bytes() for tokens
    languages: [php]
    severity: WARNING

  - id: php-openssl-ecb
    pattern: 'openssl_encrypt($DATA, "...-ecb", ...)'
    message: PHP ECB mode is insecure - use GCM or CBC
    languages: [php]
    severity: ERROR

  # ============================================
  # Information Disclosure
  # ============================================

  - id: php-phpinfo
    pattern: phpinfo()
    message: PHP phpinfo() exposes sensitive server configuration
    languages: [php]
    severity: WARNING

  - id: php-display-errors-on
    pattern: 'ini_set("display_errors", "1")'
    message: PHP display_errors enabled - disable in production
    languages: [php]
    severity: WARNING

  # ============================================
  # Direct User Input Patterns (replaces taint mode)
  # ============================================

  - id: php-get-in-query
    pattern: mysqli_query($CONN, $_GET[$X])
    message: PHP SQL injection - direct $_GET in query
    languages: [php]
    severity: ERROR

  - id: php-post-in-query
    pattern: mysqli_query($CONN, $_POST[$X])
    message: PHP SQL injection - direct $_POST in query
    languages: [php]
    severity: ERROR

  - id: php-request-in-query
    pattern: mysqli_query($CONN, $_REQUEST[$X])
    message: PHP SQL injection - direct $_REQUEST in query
    languages: [php]
    severity: ERROR

  - id: php-get-in-shell
    pattern: shell_exec($_GET[$X])
    message: PHP command injection - direct $_GET in shell_exec
    languages: [php]
    severity: ERROR

  - id: php-get-in-system
    pattern: system($_GET[$X])
    message: PHP command injection - direct $_GET in system
    languages: [php]
    severity: ERROR

  - id: php-get-in-exec
    pattern: exec($_GET[$X])
    message: PHP command injection - direct $_GET in exec
    languages: [php]
    severity: ERROR

  - id: php-get-in-include
    pattern: include($_GET[$X])
    message: PHP LFI/RFI - direct $_GET in include
    languages: [php]
    severity: ERROR

  - id: php-get-in-require
    pattern: require($_GET[$X])
    message: PHP LFI/RFI - direct $_GET in require
    languages: [php]
    severity: ERROR

  - id: php-get-in-file
    pattern: file_get_contents($_GET[$X])
    message: PHP SSRF/path traversal - direct $_GET in file_get_contents
    languages: [php]
    severity: ERROR

  - id: php-echo-get
    pattern-regex: 'echo\s+\$_GET\s*\['
    message: PHP XSS - direct echo of $_GET without escaping (CWE-79)
    languages: [php]
    severity: ERROR
    metadata:
      cwe: "CWE-79"

  - id: php-echo-post
    pattern-regex: 'echo\s+\$_POST\s*\['
    message: PHP XSS - direct echo of $_POST without escaping (CWE-79)
    languages: [php]
    severity: ERROR
    metadata:
      cwe: "CWE-79"

  - id: php-echo-request
    pattern-regex: 'echo\s+\$_REQUEST\s*\['
    message: PHP XSS - direct echo of $_REQUEST without escaping (CWE-79)
    languages: [php]
    severity: ERROR
    metadata:
      cwe: "CWE-79"

  - id: php-print-get
    pattern: print($_GET[$X])
    message: PHP XSS - direct print of $_GET without escaping
    languages: [php]
    severity: ERROR

  # ============================================
  # Laravel Security
  # ============================================

  - id: php-laravel-raw-sql
    pattern: DB::raw($QUERY)
    message: Laravel DB::raw() - ensure proper escaping for user input
    languages: [php]
    severity: WARNING

  - id: php-laravel-raw-where
    pattern: '$QUERY->whereRaw($SQL)'
    message: Laravel whereRaw() - SQL injection risk with user input
    languages: [php]
    severity: WARNING

  - id: php-laravel-unguarded
    pattern: '$MODEL::unguard()'
    message: Laravel mass assignment protection disabled
    languages: [php]
    severity: WARNING

  - id: php-laravel-blade-unescape
    pattern-regex: '\{!!\s*\$\w+\s*!!\}'
    message: Laravel Blade unescaped output - XSS risk (CWE-79)
    languages: [php]
    severity: ERROR
    metadata:
      cwe: "CWE-79"

  - id: php-laravel-debug-true
    pattern-regex: '["\x27]debug["\x27]\s*=>\s*true'
    message: Laravel debug mode enabled - disable in production (CWE-489)
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-489"

  # ============================================
  # Symfony Security
  # ============================================

  - id: php-symfony-raw-filter
    pattern-regex: '\{\{\s*\w+\s*\|\s*raw\s*\}\}'
    message: Symfony Twig raw filter - XSS risk (CWE-79)
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  - id: php-symfony-csrf-disabled
    pattern-regex: '["\x27]csrf_protection["\x27]\s*=>\s*false'
    message: Symfony CSRF protection disabled (CWE-352)
    languages: [php]
    severity: ERROR
    metadata:
      cwe: "CWE-352"

  # ============================================
  # Type Juggling
  # ============================================

  - id: php-loose-comparison
    pattern: if ($PASSWORD == $HASH)
    message: PHP loose comparison - use === for security comparisons
    languages: [php]
    severity: ERROR

  - id: php-strcmp-comparison
    pattern: if (strcmp($A, $B) == 0)
    message: PHP strcmp loose comparison - use === for result check
    languages: [php]
    severity: WARNING

  # ============================================
  # JWT Security
  # ============================================

  - id: php-jwt-none-algorithm
    pattern-regex: '"alg"\s*:\s*"none"'
    message: PHP JWT none algorithm - authentication bypass (CWE-287)
    languages: [php]
    severity: ERROR
    metadata:
      cwe: "CWE-287"

  # ============================================
  # Object Injection
  # ============================================

  - id: php-wakeup-magic
    pattern-regex: 'function\s+__wakeup\s*\('
    message: PHP __wakeup magic method - review for object injection (CWE-502)
    languages: [php]
    severity: INFO
    metadata:
      cwe: "CWE-502"

  - id: php-destruct-magic
    pattern-regex: 'function\s+__destruct\s*\('
    message: PHP __destruct magic method - review for object injection (CWE-502)
    languages: [php]
    severity: INFO
    metadata:
      cwe: "CWE-502"

  # ============================================
  # Additional SSRF
  # ============================================

  - id: php-curl-user-url
    pattern: curl_setopt($CH, CURLOPT_URL, $USER_INPUT)
    message: PHP cURL with user input - SSRF risk
    languages: [php]
    severity: WARNING

  - id: php-guzzle-request
    pattern: '$CLIENT->request($METHOD, $USER_INPUT)'
    message: PHP Guzzle request with user input - SSRF risk
    languages: [php]
    severity: WARNING

  # ============================================
  # XXE (XML External Entity) Injection
  # ============================================

  - id: php-xxe-libxml-disable-entity-false
    pattern-regex: "libxml_disable_entity_loader\\s*\\(\\s*false\\s*\\)"
    message: "PHP XXE - libxml_disable_entity_loader(false) enables external entities (CWE-611)"
    languages: [php]
    severity: ERROR
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2021"
      tags: [xxe, xml, injection]

  - id: php-xxe-libxml-noent
    pattern-regex: "LIBXML_NOENT"
    message: "PHP XXE - LIBXML_NOENT substitutes entities, enabling XXE attacks (CWE-611)"
    languages: [php]
    severity: ERROR
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2021"
      tags: [xxe, xml, injection]

  - id: php-xxe-libxml-dtdload
    pattern-regex: "LIBXML_DTDLOAD"
    message: "PHP XXE - LIBXML_DTDLOAD enables external DTD loading (CWE-611)"
    languages: [php]
    severity: ERROR
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2021"
      tags: [xxe, xml, injection]

  - id: php-xxe-simplexml-load
    pattern: simplexml_load_string($XML, ...)
    message: "PHP SimpleXML - ensure external entities are disabled (CWE-611)"
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: php-xxe-domdocument-loadxml
    pattern: '$DOC->loadXML($XML)'
    message: "PHP DOMDocument::loadXML - disable external entities to prevent XXE (CWE-611)"
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: php-xxe-domdocument-load
    pattern: '$DOC->load($FILE)'
    message: "PHP DOMDocument::load - disable external entities to prevent XXE (CWE-611)"
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: php-xxe-xmlreader-xml
    pattern: '$READER->xml($XML)'
    message: "PHP XMLReader::xml - disable external entities to prevent XXE (CWE-611)"
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: php-xxe-xmlreader-open
    pattern: '$READER->open($FILE)'
    message: "PHP XMLReader::open - disable external entities to prevent XXE (CWE-611)"
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]
