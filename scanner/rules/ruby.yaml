# Ruby Security Rules
rules:
  # ============================================
  # Command Injection
  # ============================================

  - id: ruby-system-call
    pattern: system($CMD)
    message: Ruby system() - command injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-exec-call
    pattern: exec($CMD)
    message: Ruby exec() - command injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-backtick
    pattern: '`$CMD`'
    message: Ruby backtick execution - command injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-spawn
    pattern: spawn($CMD)
    message: Ruby spawn() - command injection risk
    languages: [ruby]
    severity: WARNING

  - id: ruby-io-popen
    pattern: IO.popen($CMD)
    message: Ruby IO.popen() - command injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-open3
    pattern: Open3.capture2($CMD)
    message: Ruby Open3 - command injection risk
    languages: [ruby]
    severity: WARNING

  - id: ruby-open3-capture3
    pattern: Open3.capture3($CMD)
    message: Ruby Open3 - command injection risk
    languages: [ruby]
    severity: WARNING

  # ============================================
  # Code Injection
  # ============================================

  - id: ruby-eval
    pattern: eval($CODE)
    message: Ruby eval() - code injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-instance-eval
    pattern: instance_eval($CODE)
    message: Ruby instance_eval() - code injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-class-eval
    pattern: class_eval($CODE)
    message: Ruby class_eval() - code injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-module-eval
    pattern: module_eval($CODE)
    message: Ruby module_eval() - code injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-send-dynamic
    pattern: $OBJ.send(params[$X], ...)
    message: Ruby dynamic send - code injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-constantize
    pattern: params[$X].constantize
    message: Ruby constantize - arbitrary class instantiation risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-constantize-safe
    pattern: $X.constantize
    message: Ruby constantize - ensure input is validated
    languages: [ruby]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: ruby-yaml-load
    pattern: YAML.load($DATA)
    message: Ruby YAML.load - insecure deserialization (use safe_load)
    languages: [ruby]
    severity: ERROR

  - id: ruby-marshal-load
    pattern: Marshal.load($DATA)
    message: Ruby Marshal.load - insecure deserialization
    languages: [ruby]
    severity: ERROR

  - id: ruby-marshal-restore
    pattern: Marshal.restore($DATA)
    message: Ruby Marshal.restore - insecure deserialization
    languages: [ruby]
    severity: ERROR

  # ============================================
  # Template Injection
  # ============================================

  - id: ruby-erb-render
    pattern: ERB.new(params[$X]).result
    message: Ruby ERB template injection
    languages: [ruby]
    severity: ERROR

  - id: ruby-erb-new-user
    pattern: ERB.new($USER_INPUT)
    message: Ruby ERB with user input - template injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-render-inline
    pattern: 'render inline: params[$X]'
    message: Ruby Rails inline render - template injection
    languages: [ruby]
    severity: ERROR

  - id: ruby-render-inline-var
    pattern: 'render inline: $VAR'
    message: Ruby Rails inline render - potential template injection
    languages: [ruby]
    severity: WARNING

  # ============================================
  # SSRF/Command Injection via open
  # ============================================

  - id: ruby-open-uri
    pattern: open(params[$X])
    message: Ruby open() with user input - SSRF/command injection risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-open-uri-var
    pattern: open($URL)
    message: Ruby open() - potential SSRF if URL is user-controlled
    languages: [ruby]
    severity: WARNING

  - id: ruby-uri-open
    pattern: URI.open($URL)
    message: Ruby URI.open() - potential SSRF
    languages: [ruby]
    severity: WARNING

  # ============================================
  # Open Redirect
  # ============================================

  - id: ruby-redirect-to-params
    pattern: redirect_to params[$X]
    message: Ruby open redirect risk
    languages: [ruby]
    severity: WARNING

  - id: ruby-redirect-to-var
    pattern: redirect_to $URL
    message: Ruby redirect - ensure URL is validated
    languages: [ruby]
    severity: INFO

  # ============================================
  # SQL Injection
  # ============================================

  - id: ruby-find-by-sql
    pattern: $MODEL.find_by_sql($QUERY)
    message: Ruby find_by_sql - ensure parameterized queries
    languages: [ruby]
    severity: WARNING

  - id: ruby-where-string
    pattern: $MODEL.where($STRING)
    message: Ruby where with string - use hash or array syntax
    languages: [ruby]
    severity: WARNING

  - id: ruby-execute-sql
    pattern: $CONN.execute($QUERY)
    message: Ruby raw SQL execution - ensure parameterized
    languages: [ruby]
    severity: WARNING

  - id: ruby-exec-query
    pattern: ActiveRecord::Base.connection.execute($QUERY)
    message: Ruby raw SQL execution - SQL injection risk
    languages: [ruby]
    severity: WARNING

  # ============================================
  # Mass Assignment
  # ============================================

  - id: ruby-permit-all
    pattern: params.permit!
    message: Ruby mass assignment - all parameters permitted
    languages: [ruby]
    severity: ERROR

  - id: ruby-update-attributes
    pattern: $MODEL.update_attributes(params[$X])
    message: Ruby mass assignment - use strong parameters
    languages: [ruby]
    severity: WARNING

  # ============================================
  # Session Security
  # ============================================

  - id: ruby-session-secret-hardcoded
    pattern: 'secret_key_base = "..."'
    message: Ruby hardcoded secret key - use environment variables
    languages: [ruby]
    severity: ERROR

  - id: ruby-cookie-store-secret
    pattern: 'config.secret_key = "..."'
    message: Ruby hardcoded secret key
    languages: [ruby]
    severity: ERROR

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: ruby-md5-digest
    pattern: Digest::MD5.hexdigest($X)
    message: Ruby MD5 is weak - use SHA-256 or better
    languages: [ruby]
    severity: WARNING

  - id: ruby-sha1-digest
    pattern: Digest::SHA1.hexdigest($X)
    message: Ruby SHA1 is weak - use SHA-256 or better
    languages: [ruby]
    severity: WARNING

  - id: ruby-random-security
    pattern: rand()
    message: Ruby rand() not cryptographically secure - use SecureRandom
    languages: [ruby]
    severity: WARNING

  # ============================================
  # File Operations
  # ============================================

  - id: ruby-file-read-user
    pattern: File.read(params[$X])
    message: Ruby file read with user input - path traversal risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-file-open-user
    pattern: File.open(params[$X])
    message: Ruby file open with user input - path traversal risk
    languages: [ruby]
    severity: ERROR

  - id: ruby-send-file-user
    pattern: send_file(params[$X])
    message: Ruby send_file with user input - path traversal risk
    languages: [ruby]
    severity: ERROR

  # ============================================
  # XSS
  # ============================================

  - id: ruby-raw-output
    pattern: raw($INPUT)
    message: Ruby raw() bypasses HTML escaping - XSS risk
    languages: [ruby]
    severity: WARNING

  - id: ruby-html-safe
    pattern: $X.html_safe
    message: Ruby html_safe bypasses HTML escaping - XSS risk
    languages: [ruby]
    severity: WARNING

  # ============================================
  # Direct User Input Patterns (replaces taint mode)
  # ============================================

  - id: ruby-params-in-where
    pattern: $MODEL.where(params[$X])
    message: Ruby SQL injection - direct params in where clause
    languages: [ruby]
    severity: ERROR

  - id: ruby-params-in-find-by-sql
    pattern: $MODEL.find_by_sql(params[$X])
    message: Ruby SQL injection - direct params in find_by_sql
    languages: [ruby]
    severity: ERROR

  - id: ruby-params-in-system
    pattern: system(params[$X])
    message: Ruby command injection - direct params in system
    languages: [ruby]
    severity: ERROR

  - id: ruby-params-in-exec
    pattern: exec(params[$X])
    message: Ruby command injection - direct params in exec
    languages: [ruby]
    severity: ERROR

  - id: ruby-params-in-redirect
    pattern: redirect_to(params[$X])
    message: Ruby open redirect - direct params in redirect_to
    languages: [ruby]
    severity: WARNING

  - id: ruby-params-in-render-inline
    pattern: 'render inline: params[$X]'
    message: Ruby XSS - direct params in render inline
    languages: [ruby]
    severity: ERROR

  # ============================================
  # String Interpolation SQL Injection
  # ============================================

  - id: ruby-sql-interpolation
    pattern: '"SELECT $...WHERE $... = #{$VAR}"'
    message: Ruby SQL injection via string interpolation - use parameterized queries
    languages: [ruby]
    severity: ERROR

  - id: ruby-sql-interpolation-insert
    pattern: '"INSERT INTO $... VALUES (#{$VAR}"'
    message: Ruby SQL injection via string interpolation in INSERT
    languages: [ruby]
    severity: ERROR

  - id: ruby-sql-interpolation-update
    pattern: '"UPDATE $... SET $... = #{$VAR}"'
    message: Ruby SQL injection via string interpolation in UPDATE
    languages: [ruby]
    severity: ERROR

  - id: ruby-sql-interpolation-delete
    pattern: '"DELETE FROM $... WHERE $... = #{$VAR}"'
    message: Ruby SQL injection via string interpolation in DELETE
    languages: [ruby]
    severity: ERROR

  - id: ruby-execute-interpolation
    pattern: |
      $DB.execute("... #{$VAR} ...")
    message: Ruby SQL injection - string interpolation in execute
    languages: [ruby]
    severity: ERROR

  # ============================================
  # String Interpolation XSS
  # ============================================

  - id: ruby-html-interpolation
    pattern: '"<$TAG>#{$VAR}</$TAG>"'
    message: Ruby XSS via HTML string interpolation - escape user data
    languages: [ruby]
    severity: WARNING

  - id: ruby-html-h1-interpolation
    pattern: '"<h1>$...#{$VAR}$...</h1>"'
    message: Ruby XSS via HTML interpolation in heading
    languages: [ruby]
    severity: WARNING

  - id: ruby-html-div-interpolation
    pattern: '"<div>$...#{$VAR}$...</div>"'
    message: Ruby XSS via HTML interpolation in div
    languages: [ruby]
    severity: WARNING

  - id: ruby-html-span-interpolation
    pattern: '"<span>$...#{$VAR}$...</span>"'
    message: Ruby XSS via HTML interpolation in span
    languages: [ruby]
    severity: WARNING

  # ============================================
  # XXE (XML External Entity) - CWE-611
  # ============================================

  - id: ruby-xxe-nokogiri-xml
    pattern: Nokogiri::XML($INPUT)
    message: "Ruby Nokogiri XML parsing - ensure external entities are disabled (CWE-611)"
    languages: [ruby]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2017 XXE"
      tags: [xxe, xml]

  - id: ruby-xxe-nokogiri-huge
    pattern: Nokogiri::XML($INPUT, ..., Nokogiri::XML::ParseOptions::HUGE)
    message: "Ruby Nokogiri HUGE option enables large entity expansion - XXE vulnerability (CWE-611)"
    languages: [ruby]
    severity: ERROR
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: ruby-xxe-nokogiri-dtdload
    pattern: Nokogiri::XML($INPUT, ..., Nokogiri::XML::ParseOptions::DTDLOAD)
    message: "Ruby Nokogiri DTDLOAD option enables external DTD loading - XXE vulnerability (CWE-611)"
    languages: [ruby]
    severity: ERROR
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: ruby-xxe-nokogiri-noent
    pattern: Nokogiri::XML($INPUT, ..., Nokogiri::XML::ParseOptions::NOENT)
    message: "Ruby Nokogiri NOENT option substitutes entities - XXE vulnerability (CWE-611)"
    languages: [ruby]
    severity: ERROR
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: ruby-xxe-rexml-document
    pattern: REXML::Document.new($INPUT)
    message: "Ruby REXML XML parsing - disable external entities to prevent XXE (CWE-611)"
    languages: [ruby]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2017 XXE"
      tags: [xxe, xml]

  - id: ruby-xxe-rexml-source
    pattern: REXML::Source.new($INPUT)
    message: "Ruby REXML Source - potential XXE vulnerability (CWE-611)"
    languages: [ruby]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: ruby-xxe-libxml-parse
    pattern: LibXML::XML::Parser.string($INPUT)
    message: "Ruby LibXML parsing - disable external entities to prevent XXE (CWE-611)"
    languages: [ruby]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: ruby-xxe-libxml-document
    pattern: LibXML::XML::Document.string($INPUT)
    message: "Ruby LibXML document parsing - XXE vulnerability risk (CWE-611)"
    languages: [ruby]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: ruby-xxe-ox-parse
    pattern: Ox.parse($INPUT)
    message: "Ruby Ox XML parsing - verify external entities are disabled (CWE-611)"
    languages: [ruby]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      tags: [xxe, xml]

  - id: ruby-xxe-xpath-user-input
    pattern: $DOC.xpath(params[$X])
    message: "Ruby XPath with user input - XPath injection vulnerability (CWE-643)"
    languages: [ruby]
    severity: ERROR
    metadata:
      cwe: "CWE-643"
      tags: [xpath, injection]
