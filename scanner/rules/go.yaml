# Go Security Rules
rules:
  # ============================================
  # SQL Injection
  # ============================================

  - id: go-sql-query-concat
    pattern: db.Query($Q + $INPUT)
    message: Go SQL injection via concatenation - use parameterized queries
    languages: [go]
    severity: ERROR

  - id: go-sql-exec-concat
    pattern: db.Exec($Q + $INPUT)
    message: Go SQL injection via concatenation - use parameterized queries
    languages: [go]
    severity: ERROR

  - id: go-sql-queryrow-concat
    pattern: db.QueryRow($Q + $INPUT)
    message: Go SQL injection via concatenation - use parameterized queries
    languages: [go]
    severity: ERROR

  - id: go-sql-prepare-concat
    pattern: db.Prepare($Q + $INPUT)
    message: Go SQL injection via concatenation - use parameterized queries
    languages: [go]
    severity: ERROR

  - id: go-sql-sprintf
    pattern: db.Query(fmt.Sprintf($Q, ...))
    message: Go SQL injection via fmt.Sprintf - use parameterized queries
    languages: [go]
    severity: ERROR

  # ============================================
  # Command Injection
  # ============================================

  - id: go-exec-command
    pattern: exec.Command($CMD, ...)
    message: Go command execution - ensure input validation
    languages: [go]
    severity: WARNING

  - id: go-exec-command-context
    pattern: exec.CommandContext($CTX, $CMD, ...)
    message: Go command execution - ensure input validation
    languages: [go]
    severity: WARNING

  - id: go-os-exec
    pattern: os.StartProcess($CMD, ...)
    message: Go process execution - ensure input validation
    languages: [go]
    severity: WARNING

  # ============================================
  # XSS
  # ============================================

  - id: go-template-html
    pattern: template.HTML($INPUT)
    message: Go template.HTML bypasses escaping - XSS risk
    languages: [go]
    severity: ERROR

  - id: go-template-js
    pattern: template.JS($INPUT)
    message: Go template.JS bypasses escaping - XSS risk
    languages: [go]
    severity: ERROR

  - id: go-template-css
    pattern: template.CSS($INPUT)
    message: Go template.CSS bypasses escaping - XSS risk
    languages: [go]
    severity: WARNING

  - id: go-template-url
    pattern: template.URL($INPUT)
    message: Go template.URL bypasses escaping - potential XSS/open redirect
    languages: [go]
    severity: WARNING

  # ============================================
  # TLS/SSL Issues
  # ============================================

  - id: go-tls-insecure
    pattern: 'InsecureSkipVerify: true'
    message: Go TLS verification disabled - MITM attack risk
    languages: [go]
    severity: ERROR

  - id: go-tls-min-version
    pattern: 'MinVersion: tls.VersionSSL30'
    message: Go SSL 3.0 is insecure - use TLS 1.2+
    languages: [go]
    severity: ERROR

  - id: go-tls-min-version-tls10
    pattern: 'MinVersion: tls.VersionTLS10'
    message: Go TLS 1.0 is deprecated - use TLS 1.2+
    languages: [go]
    severity: WARNING

  - id: go-tls-min-version-tls11
    pattern: 'MinVersion: tls.VersionTLS11'
    message: Go TLS 1.1 is deprecated - use TLS 1.2+
    languages: [go]
    severity: WARNING

  # ============================================
  # YAML/Deserialization
  # ============================================

  - id: go-yaml-unmarshal
    pattern: yaml.Unmarshal($DATA, ...)
    message: Go YAML unmarshal - ensure safe parsing of untrusted data
    languages: [go]
    severity: WARNING

  - id: go-json-unmarshal-interface
    pattern-regex: 'json\.Unmarshal\s*\([^,]+,\s*&interface\s*\{\s*\}\s*\)'
    message: Go JSON unmarshal to interface{} - type confusion risk
    languages: [go]
    severity: INFO

  # ============================================
  # Path Traversal
  # ============================================

  - id: go-filepath-join-user
    pattern: filepath.Join($BASE, $USER_INPUT)
    message: Go filepath.Join with user input - path traversal risk
    languages: [go]
    severity: WARNING

  - id: go-os-open-user
    pattern: os.Open($USER_INPUT)
    message: Go file open with user input - path traversal risk
    languages: [go]
    severity: WARNING

  - id: go-ioutil-readfile-user
    pattern: ioutil.ReadFile($USER_INPUT)
    message: Go file read with user input - path traversal risk
    languages: [go]
    severity: WARNING

  - id: go-os-readfile-user
    pattern: os.ReadFile($USER_INPUT)
    message: Go file read with user input - path traversal risk
    languages: [go]
    severity: WARNING

  # ============================================
  # SSRF
  # ============================================

  - id: go-http-get-user
    pattern: http.Get($USER_INPUT)
    message: Go HTTP request with user input - potential SSRF
    languages: [go]
    severity: WARNING

  - id: go-http-post-user
    pattern: http.Post($USER_INPUT, ...)
    message: Go HTTP request with user input - potential SSRF
    languages: [go]
    severity: WARNING

  - id: go-http-newrequest-user
    pattern: http.NewRequest($METHOD, $USER_INPUT, ...)
    message: Go HTTP request with user input - potential SSRF
    languages: [go]
    severity: WARNING

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: go-md5-new
    pattern: md5.New()
    message: Go MD5 is weak - use SHA-256 or better
    languages: [go]
    severity: WARNING

  - id: go-md5-sum
    pattern: md5.Sum($X)
    message: Go MD5 is weak - use SHA-256 or better
    languages: [go]
    severity: WARNING

  - id: go-sha1-new
    pattern: sha1.New()
    message: Go SHA1 is weak - use SHA-256 or better
    languages: [go]
    severity: WARNING

  - id: go-sha1-sum
    pattern: sha1.Sum($X)
    message: Go SHA1 is weak - use SHA-256 or better
    languages: [go]
    severity: WARNING

  - id: go-des-cipher
    pattern: des.NewCipher($KEY)
    message: Go DES is weak - use AES
    languages: [go]
    severity: ERROR

  - id: go-rand-intn
    pattern: rand.Intn($X)
    message: Go math/rand is not cryptographically secure - use crypto/rand
    languages: [go]
    severity: WARNING

  - id: go-rand-int
    pattern: rand.Int()
    message: Go math/rand is not cryptographically secure - use crypto/rand
    languages: [go]
    severity: WARNING

  # ============================================
  # Error Handling
  # ============================================

  - id: go-ignored-error
    pattern: $VAR, _ := $FUNC(...)
    message: Go error ignored - handle errors properly
    languages: [go]
    severity: INFO

  # ============================================
  # Race Conditions
  # ============================================

  - id: go-goroutine-closure
    pattern-regex: 'for\s+\w+\s*:=\s*range\s+\w+\s*\{[^}]*go\s+func\s*\(\s*\)\s*\{'
    message: Go closure captures loop variable - race condition risk (CWE-362)
    languages: [go]
    severity: WARNING
    metadata:
      cwe: "CWE-362"

  # ============================================
  # Hardcoded Credentials
  # ============================================

  - id: go-hardcoded-password
    pattern: 'password := "..."'
    message: Go hardcoded password detected (CWE-798)
    languages: [go]
    severity: ERROR
    metadata:
      cwe: "CWE-798"

  - id: go-hardcoded-secret
    pattern: 'secret := "..."'
    message: Go hardcoded secret detected (CWE-798)
    languages: [go]
    severity: ERROR
    metadata:
      cwe: "CWE-798"

  - id: go-hardcoded-apikey
    pattern: 'apiKey := "..."'
    message: Go hardcoded API key detected (CWE-798)
    languages: [go]
    severity: ERROR
    metadata:
      cwe: "CWE-798"

  - id: go-const-password
    pattern-regex: 'const\s+(db)?[pP]assword\s*=\s*"[^"]+"'
    message: Go hardcoded password in const (CWE-798)
    languages: [go]
    severity: ERROR
    metadata:
      cwe: "CWE-798"

  - id: go-const-apikey
    pattern-regex: 'const\s+[aA]pi[Kk]ey\s*=\s*"[^"]+"'
    message: Go hardcoded API key in const (CWE-798)
    languages: [go]
    severity: ERROR
    metadata:
      cwe: "CWE-798"

  - id: go-const-secret
    pattern-regex: 'const\s+[sS]ecret\s*=\s*"[^"]+"'
    message: Go hardcoded secret in const (CWE-798)
    languages: [go]
    severity: ERROR
    metadata:
      cwe: "CWE-798"

  - id: go-var-password
    pattern-regex: 'var\s+(db)?[pP]assword\s*=\s*"[^"]+"'
    message: Go hardcoded password in var (CWE-798)
    languages: [go]
    severity: ERROR
    metadata:
      cwe: "CWE-798"

  - id: go-sql-open-hardcoded
    pattern-regex: 'sql\.Open\s*\(\s*"[^"]+"\s*,\s*"[^"]*:[^"]*@'
    message: Go hardcoded database credentials in sql.Open (CWE-798)
    languages: [go]
    severity: ERROR
    metadata:
      cwe: "CWE-798"

  # ============================================
  # JWT Security
  # ============================================

  - id: go-jwt-none-method
    pattern: jwt.SigningMethodNone
    message: Go JWT none algorithm - authentication bypass
    languages: [go]
    severity: ERROR

  - id: go-jwt-parse-unverified
    pattern: jwt.ParseUnverified($TOKEN, ...)
    message: Go JWT parsed without verification
    languages: [go]
    severity: ERROR

  # ============================================
  # Gin/Echo/Fiber Framework Security
  # ============================================

  - id: go-gin-html-raw
    pattern: c.HTML($CODE, $TEMPLATE, gin.H{$DATA})
    message: Gin HTML rendering - ensure templates escape user data
    languages: [go]
    severity: INFO

  - id: go-gin-cors-all
    pattern: 'cors.Default()'
    message: Gin CORS allows all origins - restrict in production
    languages: [go]
    severity: WARNING

  - id: go-echo-html-blob
    pattern: c.HTMLBlob($CODE, $DATA)
    message: Echo HTMLBlob - ensure data is properly escaped
    languages: [go]
    severity: WARNING

  - id: go-fiber-static-user
    pattern: c.SendFile($USER_INPUT)
    message: Fiber SendFile with user input - path traversal risk
    languages: [go]
    severity: WARNING

  # ============================================
  # GORM / Database Security
  # ============================================

  - id: go-gorm-raw
    pattern: db.Raw($QUERY)
    message: GORM Raw query - ensure parameterized
    languages: [go]
    severity: WARNING

  - id: go-gorm-exec
    pattern: db.Exec($QUERY)
    message: GORM Exec - ensure parameterized queries
    languages: [go]
    severity: WARNING

  - id: go-sqlx-get-unsafe
    pattern: sqlx.Get($DB, $DEST, $QUERY+$INPUT)
    message: sqlx query concatenation - SQL injection risk
    languages: [go]
    severity: ERROR

  # ============================================
  # Additional Crypto Issues
  # ============================================

  - id: go-des-3des
    pattern: des.NewTripleDESCipher($KEY)
    message: Go 3DES is deprecated - use AES
    languages: [go]
    severity: WARNING

  - id: go-rc4-cipher
    pattern: rc4.NewCipher($KEY)
    message: Go RC4 is broken - use AES
    languages: [go]
    severity: ERROR

  - id: go-weak-rsa-key
    pattern: rsa.GenerateKey($RAND, 1024)
    message: Go RSA key size too small - use at least 2048 bits
    languages: [go]
    severity: ERROR

  - id: go-weak-rsa-key-512
    pattern: rsa.GenerateKey($RAND, 512)
    message: Go RSA key size too small - use at least 2048 bits
    languages: [go]
    severity: ERROR

  - id: go-static-iv
    pattern: 'cipher.NewCBCEncrypter($BLOCK, []byte{...})'
    message: Go static IV in encryption - IV should be random
    languages: [go]
    severity: ERROR

  # ============================================
  # Open Redirect
  # ============================================

  - id: go-http-redirect-user
    pattern: http.Redirect($W, $R, $USER_INPUT, $CODE)
    message: Go redirect with user input - open redirect risk
    languages: [go]
    severity: WARNING

  - id: go-gin-redirect-user
    pattern: c.Redirect($CODE, $USER_INPUT)
    message: Gin redirect with user input - open redirect risk
    languages: [go]
    severity: WARNING

  # ============================================
  # Information Disclosure
  # ============================================

  - id: go-panic-error
    pattern: panic($ERR)
    message: Go panic exposes stack trace - use proper error handling
    languages: [go]
    severity: WARNING

  - id: go-log-sensitive
    pattern: log.Print($ERR)
    message: Go log may expose sensitive data - review log content
    languages: [go]
    severity: INFO

  # ============================================
  # XML/XXE
  # ============================================

  - id: go-xml-decode-unsafe
    pattern: xml.NewDecoder($INPUT).Decode(...)
    message: Go XML parsing - ensure external entities are disabled
    languages: [go]
    severity: WARNING

  # ============================================
  # Prototype Pollution Equivalent (Map Merge)
  # ============================================

  - id: go-map-user-keys
    pattern: '$MAP[$USER_INPUT] = $VALUE'
    message: Go map with user-controlled keys - verify key validation
    languages: [go]
    severity: INFO

  # ============================================
  # fmt.Sprintf SQL Injection Patterns
  # ============================================

  - id: go-sql-sprintf-select
    pattern: 'fmt.Sprintf("SELECT $... FROM $... WHERE $... = %s", $VAR)'
    message: Go SQL injection via fmt.Sprintf - use parameterized queries (CWE-89)
    languages: [go]
    severity: ERROR

  - id: go-sql-sprintf-select-v
    pattern: 'fmt.Sprintf("SELECT $... FROM $... WHERE $... = %v", $VAR)'
    message: Go SQL injection via fmt.Sprintf - use parameterized queries (CWE-89)
    languages: [go]
    severity: ERROR

  - id: go-sql-sprintf-insert
    pattern: 'fmt.Sprintf("INSERT INTO $... VALUES (%s", $VAR)'
    message: Go SQL injection via fmt.Sprintf in INSERT
    languages: [go]
    severity: ERROR

  - id: go-sql-sprintf-update
    pattern: 'fmt.Sprintf("UPDATE $... SET $... = %s", $VAR)'
    message: Go SQL injection via fmt.Sprintf in UPDATE
    languages: [go]
    severity: ERROR

  - id: go-sql-sprintf-delete
    pattern: 'fmt.Sprintf("DELETE FROM $... WHERE $... = %s", $VAR)'
    message: Go SQL injection via fmt.Sprintf in DELETE
    languages: [go]
    severity: ERROR

  - id: go-sql-sprintf-generic
    pattern: 'fmt.Sprintf("$...SELECT$...%s$...", ...)'
    message: Go potential SQL injection via fmt.Sprintf
    languages: [go]
    severity: WARNING

  # ============================================
  # fmt.Fprintf XSS Patterns
  # ============================================

  - id: go-xss-fprintf
    pattern: fmt.Fprintf($W, $TEMPLATE, $USER_INPUT)
    message: Go XSS via fmt.Fprintf - use html/template for escaping (CWE-79)
    languages: [go]
    severity: WARNING

  - id: go-xss-fprintf-html
    pattern: 'fmt.Fprintf($W, "<$...", $VAR)'
    message: Go XSS - raw HTML output via fmt.Fprintf (CWE-79)
    languages: [go]
    severity: ERROR

  - id: go-xss-sprintf-html
    pattern: 'fmt.Sprintf("<$...", $VAR)'
    message: Go XSS - raw HTML output via fmt.Sprintf (CWE-79)
    languages: [go]
    severity: WARNING

  - id: go-xss-write-html
    pattern: '$W.Write([]byte("<$..." + $VAR))'
    message: Go XSS - raw HTML concatenation to response (CWE-79)
    languages: [go]
    severity: ERROR

  - id: go-xss-writestring-html
    pattern: '$W.WriteString("<$..." + $VAR)'
    message: Go XSS - raw HTML concatenation to response (CWE-79)
    languages: [go]
    severity: ERROR
