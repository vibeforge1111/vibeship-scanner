# Perl Security Rules
rules:
  # ============================================
  # SQL Injection
  # ============================================

  - id: perl-sql-select-interpolation
    pattern-regex: '"SELECT\s+[^"]*\$\w+[^"]*"'
    message: Perl SQL injection via variable interpolation in SELECT - use parameterized queries (CWE-89)
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"

  - id: perl-sql-insert-interpolation
    pattern-regex: '"INSERT\s+INTO\s+[^"]*\$\w+[^"]*"'
    message: Perl SQL injection via variable interpolation in INSERT (CWE-89)
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  - id: perl-sql-update-interpolation
    pattern-regex: '"UPDATE\s+[^"]*\$\w+[^"]*"'
    message: Perl SQL injection via variable interpolation in UPDATE (CWE-89)
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  - id: perl-sql-delete-interpolation
    pattern-regex: '"DELETE\s+FROM\s+[^"]*\$\w+[^"]*"'
    message: Perl SQL injection via variable interpolation in DELETE (CWE-89)
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  - id: perl-sql-where-interpolation
    pattern-regex: 'WHERE\s+\w+\s*=\s*\$\w+'
    message: Perl SQL injection - variable in WHERE clause (CWE-89)
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  - id: perl-execute-variable
    pattern: $STH->execute($QUERY)
    message: Perl SQL execution - ensure parameterized queries
    languages: [generic]
    severity: WARNING

  - id: perl-prepare-interpolation
    pattern: '$DBH->prepare("$...$$VAR$...")'
    message: Perl SQL injection in prepare statement
    languages: [generic]
    severity: ERROR

  - id: perl-do-interpolation
    pattern: '$DBH->do("$...$$VAR$...")'
    message: Perl SQL injection in do statement
    languages: [generic]
    severity: ERROR

  # ============================================
  # XSS
  # ============================================

  - id: perl-html-variable-interpolation
    pattern-regex: 'print\s+"<[^"]*\$\w+[^"]*>"'
    message: Perl XSS via variable interpolation in HTML - escape output (CWE-79)
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"

  - id: perl-html-tag-interpolation
    pattern-regex: 'print\s+"<(h\d|div|span|p|a|li|td|th|pre|code)[^"]*\$\w+'
    message: Perl XSS via interpolation in HTML tag (CWE-79)
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  - id: perl-cgi-param-print
    pattern-regex: 'print\s+.*\$\w+->param\s*\('
    message: Perl XSS - printing CGI param without escaping (CWE-79)
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"

  - id: perl-cgi-param-concat
    pattern-regex: 'print\s+"[^"]*"\s*\.\s*\$\w+->param\s*\('
    message: Perl XSS - CGI param concatenated in output (CWE-79)
    languages: [generic]
    severity: ERROR
    metadata:
      cwe: "CWE-79"

  - id: perl-heredoc-html-interpolation
    pattern-regex: '<<\s*(HTML|EOF|END|DOC)\s*;[^;]*\$\w+'
    message: Perl XSS - variable interpolation in heredoc HTML (CWE-79)
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  - id: perl-sprintf-html
    pattern-regex: 'sprintf\s*\(\s*"<[^"]+"\s*,'
    message: Perl XSS - sprintf with HTML output (CWE-79)
    languages: [generic]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  # ============================================
  # Command Injection
  # ============================================

  - id: perl-system-variable
    pattern: system($VAR)
    message: Perl command injection via system() (CWE-78)
    languages: [generic]
    severity: ERROR

  - id: perl-exec-variable
    pattern: exec($VAR)
    message: Perl command injection via exec() (CWE-78)
    languages: [generic]
    severity: ERROR

  - id: perl-backtick-variable
    pattern: '`$VAR`'
    message: Perl command injection via backticks (CWE-78)
    languages: [generic]
    severity: ERROR

  - id: perl-open-pipe
    pattern: 'open($FH, "|$VAR")'
    message: Perl command injection via open pipe (CWE-78)
    languages: [generic]
    severity: ERROR

  - id: perl-open-pipe-read
    pattern: 'open($FH, "$VAR|")'
    message: Perl command injection via open pipe read (CWE-78)
    languages: [generic]
    severity: ERROR

  - id: perl-qx-variable
    pattern: qx($VAR)
    message: Perl command injection via qx (CWE-78)
    languages: [generic]
    severity: ERROR

  # ============================================
  # File Inclusion
  # ============================================

  - id: perl-require-variable
    pattern: require $VAR
    message: Perl arbitrary file inclusion via require
    languages: [generic]
    severity: ERROR

  - id: perl-do-variable
    pattern: do $VAR
    message: Perl arbitrary file execution via do
    languages: [generic]
    severity: ERROR

  - id: perl-eval-variable
    pattern: eval $VAR
    message: Perl code injection via eval (CWE-95)
    languages: [generic]
    severity: ERROR

  # ============================================
  # Path Traversal
  # ============================================

  - id: perl-open-variable
    pattern: 'open($FH, $VAR)'
    message: Perl path traversal via open (CWE-22)
    languages: [generic]
    severity: WARNING

  - id: perl-open-read-variable
    pattern: 'open($FH, "<", $VAR)'
    message: Perl path traversal via open read (CWE-22)
    languages: [generic]
    severity: WARNING

  - id: perl-open-write-variable
    pattern: 'open($FH, ">", $VAR)'
    message: Perl path traversal via open write (CWE-22)
    languages: [generic]
    severity: WARNING

  # ============================================
  # Hardcoded Credentials
  # ============================================

  - id: perl-hardcoded-password
    pattern: '$password = "..."'
    message: Perl hardcoded password detected (CWE-798)
    languages: [generic]
    severity: ERROR

  - id: perl-hardcoded-secret
    pattern: '$secret = "..."'
    message: Perl hardcoded secret detected (CWE-798)
    languages: [generic]
    severity: ERROR

  - id: perl-hardcoded-api-key
    pattern: '$api_key = "..."'
    message: Perl hardcoded API key detected (CWE-798)
    languages: [generic]
    severity: ERROR

  - id: perl-dbi-connect-password
    pattern: 'DBI->connect($DSN, $USER, "...")'
    message: Perl hardcoded database password in DBI connect
    languages: [generic]
    severity: ERROR

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: perl-md5-digest
    pattern: Digest::MD5::md5_hex($X)
    message: Perl MD5 is weak - use SHA-256 or better
    languages: [generic]
    severity: WARNING

  - id: perl-md5-new
    pattern: Digest::MD5->new
    message: Perl MD5 is weak - use SHA-256 or better
    languages: [generic]
    severity: WARNING

  - id: perl-sha1-digest
    pattern: Digest::SHA1::sha1_hex($X)
    message: Perl SHA1 is weak - use SHA-256 or better
    languages: [generic]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: perl-storable-thaw
    pattern: Storable::thaw($DATA)
    message: Perl insecure deserialization via Storable::thaw
    languages: [generic]
    severity: ERROR

  - id: perl-storable-retrieve
    pattern: Storable::retrieve($FILE)
    message: Perl insecure deserialization via Storable::retrieve
    languages: [generic]
    severity: WARNING

  # ============================================
  # LDAP Injection
  # ============================================

  - id: perl-ldap-search-filter
    pattern: '$LDAP->search(filter => "$...$VAR$...")'
    message: Perl LDAP injection via filter interpolation
    languages: [generic]
    severity: ERROR

  # ============================================
  # CGI Specific Issues
  # ============================================

  - id: perl-cgi-param-eval
    pattern: eval($CGI->param($X))
    message: Perl code injection via CGI param in eval
    languages: [generic]
    severity: ERROR

  - id: perl-cgi-param-system
    pattern: system($CGI->param($X))
    message: Perl command injection via CGI param in system
    languages: [generic]
    severity: ERROR

  - id: perl-cgi-param-open
    pattern: 'open($FH, $CGI->param($X))'
    message: Perl path traversal via CGI param in open
    languages: [generic]
    severity: ERROR
