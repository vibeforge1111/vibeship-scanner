# Java Security Rules (Streamlined ~70 rules)
rules:
  # ============================================
  # Command Injection
  # ============================================

  - id: java-runtime-exec
    pattern: Runtime.getRuntime().exec($CMD)
    message: Java command execution - injection risk
    languages: [java]
    severity: ERROR

  - id: java-processbuilder
    pattern: new ProcessBuilder($CMD)
    message: Java ProcessBuilder - command injection risk
    languages: [java]
    severity: WARNING

  # ============================================
  # SQL Injection
  # ============================================

  - id: java-statement-execute
    pattern: $STMT.execute($QUERY)
    message: Java SQL - use PreparedStatement instead
    languages: [java]
    severity: WARNING

  - id: java-statement-executequery
    pattern: $STMT.executeQuery($QUERY)
    message: Java SQL - use PreparedStatement instead
    languages: [java]
    severity: WARNING

  - id: java-sql-concat
    pattern: '"SELECT " + $VAR'
    message: Java SQL concatenation - SQL injection risk
    languages: [java]
    severity: ERROR

  # ============================================
  # XPath Injection
  # ============================================

  - id: java-xpath-evaluate
    pattern: $XPATH.evaluate($EXPR, ...)
    message: Java XPath - injection risk if expression is user input
    languages: [java]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: java-objectinputstream
    pattern: new ObjectInputStream($STREAM).readObject()
    message: Java insecure deserialization
    languages: [java]
    severity: ERROR

  - id: java-objectinputstream-new
    pattern: new ObjectInputStream(...)
    message: Java ObjectInputStream - insecure deserialization vulnerability
    languages: [java]
    severity: ERROR

  - id: java-xmldecoder
    pattern: new XMLDecoder(...)
    message: Java XMLDecoder - insecure deserialization vulnerability
    languages: [java]
    severity: ERROR

  - id: java-xstream
    pattern: new XStream()
    message: Java XStream without security configuration - insecure deserialization
    languages: [java]
    severity: ERROR

  - id: java-snakeyaml
    pattern: new Yaml()
    message: Java SnakeYAML without safe constructor - insecure deserialization
    languages: [java]
    severity: WARNING

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: java-crypto-ecb
    pattern: 'Cipher.getInstance("AES/ECB/$PADDING")'
    message: Java ECB mode is insecure - use GCM or CBC
    languages: [java]
    severity: ERROR

  - id: java-crypto-des
    pattern: 'Cipher.getInstance("DES")'
    message: Java DES is weak - use AES
    languages: [java]
    severity: ERROR

  - id: java-random-security
    pattern: new Random()
    message: Java Random not secure - use SecureRandom
    languages: [java]
    severity: WARNING

  - id: java-md5-hash
    pattern: 'MessageDigest.getInstance("MD5")'
    message: Java MD5 is weak for security purposes
    languages: [java]
    severity: WARNING

  - id: java-sha1-hash
    pattern: 'MessageDigest.getInstance("SHA-1")'
    message: Java SHA-1 is deprecated for security
    languages: [java]
    severity: WARNING

  - id: java-crypto-rc4
    pattern: 'Cipher.getInstance("RC4")'
    message: Java RC4 is broken - use AES
    languages: [java]
    severity: ERROR

  - id: java-weak-rsa-keygen
    pattern: $KPG.initialize(1024)
    message: Java RSA key size too small - use at least 2048 bits
    languages: [java]
    severity: ERROR

  - id: java-static-iv
    pattern: 'new IvParameterSpec("...".getBytes())'
    message: Java static IV in encryption - IV should be random
    languages: [java]
    severity: ERROR

  # ============================================
  # XXE (XML External Entity)
  # ============================================

  - id: java-xxe-documentbuilder
    pattern: DocumentBuilderFactory.newInstance()
    message: Java XML parser may be vulnerable to XXE - disable external entities
    languages: [java]
    severity: WARNING

  - id: java-xxe-saxparser
    pattern: SAXParserFactory.newInstance()
    message: Java SAX parser may be vulnerable to XXE - disable external entities
    languages: [java]
    severity: WARNING

  - id: java-xxe-xmlinputfactory
    pattern: XMLInputFactory.newInstance()
    message: Java StAX parser may be vulnerable to XXE - disable external entities
    languages: [java]
    severity: WARNING

  - id: java-xxe-external-entities-enabled
    pattern: $FACTORY.setFeature("http://xml.org/sax/features/external-general-entities", true)
    message: External entities enabled - XXE vulnerability
    languages: [java]
    severity: ERROR

  # ============================================
  # Path Traversal
  # ============================================

  - id: java-path-traversal-file-new
    pattern: new File($REQUEST)
    message: Java File creation with user input - potential path traversal
    languages: [java]
    severity: ERROR

  - id: java-path-traversal-paths-get
    pattern: Paths.get($REQUEST)
    message: Java Paths.get() with user input - potential path traversal
    languages: [java]
    severity: ERROR

  - id: java-path-traversal-fileinputstream
    pattern: new FileInputStream($REQUEST)
    message: Java FileInputStream with user input - potential path traversal
    languages: [java]
    severity: ERROR

  # ============================================
  # JWT Security
  # ============================================

  - id: java-jwt-none-algorithm
    pattern-regex: '"alg"\s*:\s*"none"'
    message: JWT none algorithm - authentication bypass vulnerability (CWE-287)
    languages: [java]
    severity: ERROR
    metadata:
      cwe: "CWE-287"

  - id: java-jwt-algorithm-none
    pattern: Algorithm.none()
    message: Java JWT none algorithm - authentication bypass vulnerability
    languages: [java]
    severity: ERROR

  # ============================================
  # SSRF
  # ============================================

  - id: java-ssrf-url
    pattern: new URL($USER_INPUT)
    message: Java URL with user input - potential SSRF vulnerability
    languages: [java]
    severity: ERROR

  - id: java-ssrf-httpurlconnection
    pattern: $URL.openConnection()
    message: Java HTTP connection - verify URL is validated against SSRF
    languages: [java]
    severity: WARNING

  # ============================================
  # LDAP Injection
  # ============================================

  - id: java-ldap-injection
    pattern: $CTX.search($BASE, $FILTER, ...)
    message: Java LDAP search - potential LDAP injection if filter contains user input
    languages: [java]
    severity: WARNING

  # ============================================
  # JNDI Injection (Log4Shell style)
  # ============================================

  - id: java-jndi-injection
    pattern: $CTX.lookup($INPUT)
    message: JNDI lookup - potential JNDI injection (Log4Shell style attack)
    languages: [java]
    severity: ERROR

  - id: java-jndi-ldap-url
    pattern: '"ldap://..."'
    message: LDAP URL in code - potential JNDI injection vector
    languages: [java]
    severity: ERROR

  - id: java-jndi-rmi-url
    pattern: '"rmi://..."'
    message: RMI URL in code - potential JNDI injection vector
    languages: [java]
    severity: ERROR

  # ============================================
  # Spring Security
  # ============================================

  - id: java-spring-csrf-disabled
    pattern: http.csrf().disable()
    message: Spring Security CSRF protection disabled
    languages: [java]
    severity: ERROR

  - id: java-spring-csrf-disabled-lambda
    pattern: csrf(csrf -> csrf.disable())
    message: Spring Security CSRF protection disabled
    languages: [java]
    severity: ERROR

  - id: java-spring-headers-disabled
    pattern: $X.headers().disable()
    message: Spring Security headers disabled - removes XSS and clickjacking protection
    languages: [java]
    severity: ERROR

  - id: java-spring-frame-options-disabled
    pattern: $X.frameOptions().disable()
    message: Spring Security frame options disabled - clickjacking vulnerability
    languages: [java]
    severity: WARNING

  # ============================================
  # SSL/TLS Issues
  # ============================================

  - id: java-weak-ssl-context
    pattern: 'SSLContext.getInstance("SSL")'
    message: Java SSL context uses outdated protocol - use TLSv1.2 or higher
    languages: [java]
    severity: ERROR

  - id: java-trust-all-certs
    pattern: X509TrustManager
    message: Java X509TrustManager - ensure certificates are properly validated
    languages: [java]
    severity: WARNING

  # ============================================
  # Hardcoded Credentials
  # ============================================

  - id: java-hardcoded-password-literal
    pattern: DriverManager.getConnection($URL, $USER, "...")
    message: Hardcoded password in database connection
    languages: [java]
    severity: ERROR

  - id: java-hardcoded-password-properties
    pattern: $PROPS.setProperty("password", "...")
    message: Hardcoded password in Properties
    languages: [java]
    severity: ERROR

  # ============================================
  # Spring Boot / Hibernate ORM
  # ============================================

  - id: java-hibernate-native-query
    pattern: $EM.createNativeQuery($QUERY)
    message: Java Hibernate native query - SQL injection risk with user input
    languages: [java]
    severity: WARNING

  - id: java-hibernate-hql-concat
    pattern: $EM.createQuery("..." + $VAR)
    message: Java HQL query concatenation - injection risk
    languages: [java]
    severity: ERROR

  - id: java-spring-spel-injection
    pattern: 'SpelExpressionParser().parseExpression($INPUT)'
    message: Spring SpEL expression - injection risk with user input
    languages: [java]
    severity: ERROR

  # ============================================
  # Expression Language Injection
  # ============================================

  - id: java-el-injection
    pattern: $EF.createValueExpression($CTX, $USER_INPUT, ...)
    message: Java EL injection - user input in expression
    languages: [java]
    severity: ERROR

  - id: java-ognl-injection
    pattern: Ognl.getValue($EXPR, ...)
    message: Java OGNL injection risk
    languages: [java]
    severity: ERROR

  - id: java-mvel-injection
    pattern: MVEL.eval($USER_INPUT)
    message: Java MVEL expression injection
    languages: [java]
    severity: ERROR

  # ============================================
  # Server-Side Template Injection
  # ============================================

  - id: java-velocity-template-user
    pattern: Velocity.evaluate($CTX, $WRITER, $TAG, $USER_INPUT)
    message: Java Velocity template from user input - SSTI risk
    languages: [java]
    severity: ERROR

  - id: java-freemarker-template-user
    pattern: new Template($NAME, new StringReader($USER_INPUT), ...)
    message: Java FreeMarker template from user input - SSTI risk
    languages: [java]
    severity: ERROR

  # ============================================
  # Open Redirect
  # ============================================

  - id: java-servlet-redirect
    pattern: $RESPONSE.sendRedirect($USER_INPUT)
    message: Java servlet redirect with user input - open redirect risk
    languages: [java]
    severity: WARNING

  - id: java-spring-redirect
    pattern: '"redirect:" + $USER_INPUT'
    message: Spring redirect with user input - open redirect risk
    languages: [java]
    severity: WARNING

  # ============================================
  # Logging Sensitive Data
  # ============================================

  - id: java-log4j-format-user
    pattern: $LOG.info($USER_INPUT)
    message: Java logging user input - potential Log4Shell if unpatched
    languages: [java]
    severity: WARNING

  # ============================================
  # File Upload
  # ============================================

  - id: java-multipart-filename
    pattern: $FILE.getOriginalFilename()
    message: Java file upload - validate/sanitize filename before use
    languages: [java]
    severity: WARNING

  - id: java-file-transfer
    pattern: $FILE.transferTo($DEST)
    message: Java file upload - ensure destination path is validated
    languages: [java]
    severity: WARNING

  # ============================================
  # Cookie Security
  # ============================================

  - id: java-cookie-no-httponly
    pattern: $COOKIE.setHttpOnly(false)
    message: Java cookie HttpOnly disabled - XSS risk
    languages: [java]
    severity: ERROR

  - id: java-cookie-no-secure
    pattern: $COOKIE.setSecure(false)
    message: Java cookie Secure flag disabled - MITM risk
    languages: [java]
    severity: WARNING

  # ============================================
  # Reflection Security
  # ============================================

  - id: java-class-forname-user
    pattern: Class.forName($USER_INPUT)
    message: Java Class.forName with user input - arbitrary class loading
    languages: [java]
    severity: ERROR

  # ============================================
  # Misconfiguration
  # ============================================

  - id: java-cors-allow-all
    pattern-regex: '\.allowedOrigins\s*\(\s*"\*"\s*\)'
    message: Java CORS allows all origins - restrict in production (CWE-942)
    languages: [java]
    severity: WARNING
    metadata:
      cwe: "CWE-942"

  - id: java-cors-credentials-wildcard
    pattern-regex: '\.allowedOrigins\s*\(\s*"\*"\s*\)[^;]*\.allowCredentials\s*\(\s*true\s*\)'
    message: Java CORS wildcard with credentials - security risk (CWE-942)
    languages: [java]
    severity: ERROR
    metadata:
      cwe: "CWE-942"

