# Python Security Rules
rules:
  # ============================================
  # Command Injection
  # ============================================

  - id: py-os-system
    pattern: os.system(...)
    message: os.system() call - potential command injection vulnerability
    languages: [python]
    severity: ERROR

  - id: py-subprocess-shell
    pattern: 'subprocess.call($CMD, shell=True)'
    message: subprocess with shell=True - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-subprocess-popen-shell
    pattern: 'subprocess.Popen($CMD, shell=True)'
    message: Popen with shell=True - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-subprocess-run-shell
    pattern: 'subprocess.run($CMD, shell=True)'
    message: subprocess.run with shell=True - command injection risk
    languages: [python]
    severity: ERROR

  # ============================================
  # Code Injection
  # ============================================

  - id: py-exec-call
    pattern: exec(...)
    message: Python exec() - code injection risk
    languages: [python]
    severity: ERROR

  - id: py-eval-call
    pattern: eval(...)
    message: Python eval() - code injection risk
    languages: [python]
    severity: ERROR

  - id: py-compile-call
    pattern: compile($CODE, ...)
    message: Python compile() with user input - code injection risk
    languages: [python]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: py-pickle-loads
    pattern: pickle.loads(...)
    message: pickle.loads() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-pickle-load
    pattern: pickle.load(...)
    message: pickle.load() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-cPickle-loads
    pattern: cPickle.loads(...)
    message: cPickle.loads() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-cPickle-load
    pattern: cPickle.load(...)
    message: cPickle.load() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-yaml-unsafe
    pattern: yaml.load($DATA)
    message: yaml.load() without Loader - insecure deserialization (use safe_load)
    languages: [python]
    severity: ERROR

  - id: py-yaml-unsafe-loader
    pattern: 'yaml.load($DATA, Loader=yaml.Loader)'
    message: yaml.load with Loader - insecure deserialization (use safe_load)
    languages: [python]
    severity: ERROR

  - id: py-marshal-loads
    pattern: marshal.loads(...)
    message: marshal.loads() - insecure deserialization
    languages: [python]
    severity: ERROR

  - id: py-shelve-open
    pattern: shelve.open(...)
    message: shelve uses pickle internally - insecure deserialization risk
    languages: [python]
    severity: WARNING

  # ============================================
  # SQL Injection
  # ============================================

  - id: py-sql-format
    pattern: cursor.execute($Q % $V)
    message: SQL query with string formatting - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-sql-concat
    pattern: cursor.execute($Q + $V)
    message: SQL query with string concatenation - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-sql-fstring
    pattern: cursor.execute(f"...")
    message: SQL query with f-string - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-sqlalchemy-text
    pattern: text($QUERY)
    message: SQLAlchemy text() - ensure parameterized queries
    languages: [python]
    severity: WARNING

  # ============================================
  # Path Traversal
  # ============================================

  - id: py-open-user-input
    pattern: open($USER_INPUT, ...)
    message: File open with user input - potential path traversal
    languages: [python]
    severity: WARNING

  - id: py-os-path-join-user
    pattern: os.path.join($BASE, request.$X)
    message: Path construction with user input - path traversal risk
    languages: [python]
    severity: WARNING

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: py-md5-hashlib
    pattern: hashlib.md5(...)
    message: MD5 is a weak hash function - use SHA-256 or better
    languages: [python]
    severity: WARNING

  - id: py-sha1-hashlib
    pattern: hashlib.sha1(...)
    message: SHA1 is a weak hash function - use SHA-256 or better
    languages: [python]
    severity: WARNING

  - id: py-random-security
    pattern: random.random()
    message: random module is not cryptographically secure - use secrets module
    languages: [python]
    severity: WARNING

  - id: py-random-randint
    pattern: random.randint(...)
    message: random module is not cryptographically secure - use secrets module
    languages: [python]
    severity: WARNING

  - id: py-random-choice
    pattern: random.choice(...)
    message: random module is not cryptographically secure - use secrets.choice()
    languages: [python]
    severity: WARNING

  - id: py-weak-cipher-des
    pattern: 'DES.new(...)'
    message: DES is a weak cipher - use AES instead
    languages: [python]
    severity: ERROR

  - id: py-weak-cipher-des3
    pattern: 'DES3.new(...)'
    message: Triple DES (3DES) is deprecated - use AES instead
    languages: [python]
    severity: WARNING

  - id: py-weak-cipher-blowfish
    pattern: 'Blowfish.new(...)'
    message: Blowfish is deprecated - use AES instead
    languages: [python]
    severity: WARNING

  - id: py-weak-cipher-rc4
    pattern: 'ARC4.new(...)'
    message: RC4 is broken - use AES instead
    languages: [python]
    severity: ERROR

  - id: py-ecb-mode
    pattern: 'AES.new($KEY, AES.MODE_ECB)'
    message: ECB mode is insecure - use GCM or CBC with random IV
    languages: [python]
    severity: ERROR

  - id: py-weak-rsa-key
    pattern: 'RSA.generate(1024)'
    message: RSA key size too small - use at least 2048 bits
    languages: [python]
    severity: ERROR

  - id: py-weak-rsa-key-512
    pattern: 'RSA.generate(512)'
    message: RSA key size too small - use at least 2048 bits
    languages: [python]
    severity: ERROR

  - id: py-static-iv
    patterns:
      - pattern: 'AES.new($KEY, $MODE, iv=b"...")'
      - pattern: "AES.new($KEY, $MODE, iv=b'...')"
    message: Static IV in encryption - IV should be random for each encryption
    languages: [python]
    severity: ERROR

  - id: py-fernet-hardcoded-key
    pattern: 'Fernet(b"...")'
    message: Hardcoded Fernet key - use environment variable
    languages: [python]
    severity: ERROR

  # ============================================
  # TLS/SSL Issues
  # ============================================

  - id: py-ssl-unverified
    pattern: 'ssl._create_unverified_context()'
    message: SSL certificate verification disabled - MITM attack risk
    languages: [python]
    severity: ERROR

  - id: py-requests-verify-false
    pattern: 'requests.get($URL, verify=False)'
    message: SSL verification disabled in requests - MITM attack risk
    languages: [python]
    severity: ERROR

  - id: py-requests-post-verify-false
    pattern: 'requests.post($URL, verify=False)'
    message: SSL verification disabled in requests - MITM attack risk
    languages: [python]
    severity: ERROR

  # ============================================
  # JWT Security
  # ============================================

  - id: py-jwt-none-algorithm
    pattern: '"alg":"none"'
    message: JWT none algorithm - authentication bypass vulnerability
    languages: [python]
    severity: ERROR

  - id: py-jwt-decode-no-verify
    pattern: 'jwt.decode($TOKEN, verify=False)'
    message: JWT verification disabled - authentication bypass
    languages: [python]
    severity: ERROR

  - id: py-jwt-decode-options-no-verify
    pattern: 'jwt.decode($TOKEN, options={"verify_signature": False})'
    message: JWT signature verification disabled
    languages: [python]
    severity: ERROR

  # ============================================
  # SSRF (Server-Side Request Forgery)
  # ============================================

  - id: py-requests-user-url
    pattern: requests.get($USER_INPUT)
    message: HTTP request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  - id: py-urllib-user-url
    pattern: urllib.request.urlopen($USER_INPUT)
    message: URL open with user input - potential SSRF
    languages: [python]
    severity: WARNING

  # ============================================
  # XXE (XML External Entity)
  # ============================================

  - id: py-xml-etree-parse
    pattern: ET.parse($INPUT)
    message: XML parsing - ensure external entities are disabled
    languages: [python]
    severity: WARNING

  - id: py-xml-etree-fromstring
    pattern: ET.fromstring($INPUT)
    message: XML parsing - ensure external entities are disabled
    languages: [python]
    severity: WARNING

  - id: py-lxml-parse
    pattern: lxml.etree.parse($INPUT)
    message: lxml XML parsing - disable external entities
    languages: [python]
    severity: WARNING

  # ============================================
  # Django Specific
  # ============================================

  - id: py-django-mark-safe
    pattern: mark_safe($INPUT)
    message: Django mark_safe() - XSS risk if input is user-controlled
    languages: [python]
    severity: WARNING

  - id: py-django-raw-sql
    pattern: $MODEL.objects.raw($QUERY)
    message: Django raw SQL - ensure parameterized queries
    languages: [python]
    severity: WARNING

  - id: py-django-extra
    pattern: $QUERYSET.extra($KWARGS)
    message: Django QuerySet.extra() is deprecated - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-django-debug-true
    pattern: 'DEBUG = True'
    message: Django DEBUG enabled - disable in production
    languages: [python]
    severity: WARNING

  # ============================================
  # Flask Specific
  # ============================================

  - id: py-flask-debug-true
    pattern: 'app.run(debug=True)'
    message: Flask debug mode enabled - disable in production
    languages: [python]
    severity: WARNING

  - id: py-flask-secret-key-hardcoded
    pattern: 'app.secret_key = "..."'
    message: Hardcoded Flask secret key - use environment variables
    languages: [python]
    severity: ERROR

  # ============================================
  # Hardcoded Credentials
  # ============================================

  - id: py-hardcoded-password
    pattern: 'password = "..."'
    message: Hardcoded password detected
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-api-key
    pattern: 'api_key = "..."'
    message: Hardcoded API key detected
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-secret
    pattern: 'secret = "..."'
    message: Hardcoded secret detected
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-secret-uppercase
    patterns:
      - pattern: 'SECRET = "..."'
      - pattern: 'SECRET_KEY = "..."'
      - pattern: 'API_SECRET = "..."'
      - pattern: 'APP_SECRET = "..."'
    message: Hardcoded secret detected - use environment variables
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-token
    patterns:
      - pattern: 'TOKEN = "..."'
      - pattern: 'token = "..."'
      - pattern: 'API_TOKEN = "..."'
      - pattern: 'ACCESS_TOKEN = "..."'
      - pattern: 'AUTH_TOKEN = "..."'
    message: Hardcoded token detected - use environment variables
    languages: [python]
    severity: ERROR

  - id: py-secret-in-variable-name-regex
    pattern-regex: "(?i)(SECRET|TOKEN|PASSWORD|CREDENTIAL|API_KEY)\\s*=\\s*[\"'][^\"']{4,}[\"']"
    message: Potential hardcoded secret in variable assignment - use environment variables
    languages: [python]
    severity: WARNING

  # ============================================
  # Debug/Info Disclosure
  # ============================================

  - id: py-print-statement
    pattern: print(...)
    message: Print statement found - consider using logging
    languages: [python]
    severity: INFO

  - id: py-traceback-print
    pattern: traceback.print_exc()
    message: Traceback printed - may expose sensitive information
    languages: [python]
    severity: INFO

  # ============================================
  # FastAPI / Starlette Security
  # ============================================

  - id: py-fastapi-cors-wildcard
    pattern: 'CORSMiddleware($APP, allow_origins=["*"])'
    message: FastAPI CORS allows all origins - restrict in production
    languages: [python]
    severity: WARNING

  - id: py-fastapi-cors-credentials-wildcard
    pattern: 'CORSMiddleware($APP, allow_origins=["*"], allow_credentials=True)'
    message: FastAPI CORS wildcard with credentials - security risk
    languages: [python]
    severity: ERROR

  - id: py-starlette-session-hardcoded
    pattern: 'SessionMiddleware($APP, secret_key="...")'
    message: Hardcoded session secret - use environment variable
    languages: [python]
    severity: ERROR

  - id: py-fastapi-debug-mode
    patterns:
      - pattern: 'uvicorn.run(..., debug=True, ...)'
      - pattern: 'uvicorn.run(..., reload=True, ...)'
      - pattern: 'app.run(debug=True)'
    message: FastAPI/Uvicorn debug/reload enabled - disable in production
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-489"
      tags: [fastapi, debug]

  - id: py-fastapi-debug-variable
    pattern-regex: "debug\\s*=\\s*(True|config\\.DEBUG|settings\\.DEBUG)"
    message: Debug mode may be enabled - ensure disabled in production
    languages: [python]
    severity: INFO
    metadata:
      tags: [fastapi, debug]

  - id: py-fastapi-no-auth-endpoint
    patterns:
      - pattern: |
          @app.get($PATH)
          def $FUNC():
              ...
              return $DB.query($MODEL).all()
      - pattern: |
          @app.get($PATH)
          async def $FUNC():
              ...
              return $DB.query($MODEL).all()
    message: FastAPI endpoint returns all records - ensure authentication is required
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-862"
      tags: [fastapi, auth]

  - id: py-fastapi-response-model-expose
    pattern: '@app.$METHOD($PATH, response_model=list[$MODEL])'
    message: FastAPI returns list of models - ensure sensitive fields are excluded
    languages: [python]
    severity: INFO
    metadata:
      tags: [fastapi, data-exposure]

  # ============================================
  # Server-Side Template Injection (SSTI)
  # ============================================

  - id: py-jinja2-autoescape-false
    pattern: 'Environment(autoescape=False)'
    message: Jinja2 autoescape disabled - XSS vulnerability
    languages: [python]
    severity: ERROR

  - id: py-jinja2-from-string
    pattern: 'Template($USER_INPUT).render(...)'
    message: Jinja2 template from user input - SSTI vulnerability
    languages: [python]
    severity: ERROR

  - id: py-mako-template-user
    pattern: 'MakoTemplate($USER_INPUT).render(...)'
    message: Mako template from user input - SSTI vulnerability
    languages: [python]
    severity: ERROR

  - id: py-flask-render-template-string
    pattern: render_template_string($INPUT)
    message: Flask render_template_string - SSTI risk with user input
    languages: [python]
    severity: WARNING

  # ============================================
  # Additional ORM/Database Patterns
  # ============================================

  - id: py-sqlalchemy-execute-text
    pattern: '$CONN.execute(text($QUERY))'
    message: SQLAlchemy execute with text - ensure parameterized
    languages: [python]
    severity: WARNING

  - id: py-django-cursor-execute
    pattern: 'cursor.execute($QUERY.format(...))'
    message: Django raw SQL with format - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-django-connection-cursor
    pattern: 'connection.cursor().execute($Q % $V)'
    message: Django raw SQL with string formatting - SQL injection
    languages: [python]
    severity: ERROR

  - id: py-peewee-raw
    pattern: '$MODEL.raw($QUERY)'
    message: Peewee raw SQL - ensure parameterized
    languages: [python]
    severity: WARNING

  - id: py-tortoise-raw
    pattern: '$CONN.execute_query($QUERY)'
    message: Tortoise ORM raw query - ensure parameterized
    languages: [python]
    severity: WARNING

  # ============================================
  # Additional SSRF Patterns
  # ============================================

  - id: py-httpx-user-url
    pattern: httpx.get($USER_INPUT)
    message: httpx request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  - id: py-aiohttp-user-url
    patterns:
      - pattern: 'await $SESSION.get(request.$ATTR)'
      - pattern: 'await $SESSION.post(request.$ATTR, ...)'
      - pattern: 'await $SESSION.request($METHOD, request.$ATTR)'
    message: aiohttp request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  - id: py-urllib3-user-url
    pattern: 'urllib3.request("GET", $USER_INPUT)'
    message: urllib3 request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  # ============================================
  # Mass Assignment / Object Injection
  # ============================================

  - id: py-django-model-from-dict
    pattern: '$MODEL(**request.POST)'
    message: Django model from POST data - mass assignment risk
    languages: [python]
    severity: ERROR

  - id: py-django-form-unvalidated
    pattern: '$MODEL(**request.data)'
    message: Model from request data - ensure validation
    languages: [python]
    severity: WARNING

  - id: py-setattr-user-input
    pattern: setattr($OBJ, $USER_INPUT, $VALUE)
    message: setattr with user input - attribute injection risk
    languages: [python]
    severity: ERROR

  # ============================================
  # Information Disclosure
  # ============================================

  - id: py-exception-details
    pattern: 'return {"error": str($EXCEPTION)}'
    message: Exception details in response - may leak sensitive info
    languages: [python]
    severity: WARNING

  - id: py-flask-exception-response
    pattern: 'return str(e), 500'
    message: Exception details returned - may leak sensitive info
    languages: [python]
    severity: WARNING

  # ============================================
  # Async Security Issues
  # ============================================

  - id: py-asyncio-subprocess-shell
    pattern: 'asyncio.create_subprocess_shell(...)'
    message: Async subprocess with shell - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-asyncio-run-in-executor-os
    pattern: 'loop.run_in_executor($EX, os.system, $CMD)'
    message: os.system in executor - command injection risk
    languages: [python]
    severity: ERROR

  # ============================================
  # OWASP API Security Top 10
  # ============================================

  # API1: Broken Object Level Authorization (BOLA/IDOR)
  - id: py-flask-idor-param
    patterns:
      - pattern: '$MODEL.query.get(request.args.get($ID))'
      - pattern: '$MODEL.query.get(request.form.get($ID))'
      - pattern: '$MODEL.query.filter_by(id=request.args[$ID])'
      - pattern: 'db.session.query($MODEL).get($ID)'
    message: Direct object access via user input - verify authorization
    languages: [python]
    severity: WARNING

  - id: py-sqlalchemy-idor
    patterns:
      - pattern: '$SESSION.query($MODEL).filter($MODEL.id == $USER_INPUT)'
      - pattern: '$MODEL.query.filter_by(id=$USER_INPUT).first()'
    message: Object lookup by user-supplied ID - ensure authorization check
    languages: [python]
    severity: WARNING

  # API2: Broken Authentication
  - id: py-flask-no-auth-decorator
    pattern: |
      @app.route($PATH)
      def $FUNC(...):
        ...
        return $DATA
    message: Flask route without authentication decorator - verify auth is enforced
    languages: [python]
    severity: INFO

  - id: py-jwt-weak-secret
    patterns:
      - pattern: 'jwt.encode($PAYLOAD, "...")'
      - pattern: "jwt.encode($PAYLOAD, '...')"
    message: Hardcoded JWT secret - use environment variable
    languages: [python]
    severity: ERROR

  - id: py-flask-login-no-fresh
    pattern: '@login_required'
    message: Using login_required - consider fresh_login_required for sensitive actions
    languages: [python]
    severity: INFO

  # API3: Broken Object Property Level Authorization
  - id: py-flask-mass-assignment
    patterns:
      - pattern: '$MODEL(**request.json)'
      - pattern: '$MODEL(**request.get_json())'
      - pattern: '$MODEL(**request.form.to_dict())'
    message: Mass assignment from request data - whitelist allowed fields
    languages: [python]
    severity: ERROR

  - id: py-sqlalchemy-update-dict
    patterns:
      - pattern: '$OBJ.update(request.json)'
      - pattern: '$OBJ.update(request.get_json())'
    message: Updating object with unvalidated request data - mass assignment risk
    languages: [python]
    severity: ERROR

  - id: py-flask-restful-mass-assign
    pattern: '$MODEL.query.filter_by($FILTER).update(request.json)'
    message: Bulk update with request data - mass assignment vulnerability
    languages: [python]
    severity: ERROR

  # API4: Unrestricted Resource Consumption
  - id: py-flask-no-rate-limit
    pattern: '@app.route($PATH, methods=["POST"])'
    message: POST endpoint - consider adding rate limiting
    languages: [python]
    severity: INFO

  - id: py-file-upload-no-size-limit
    patterns:
      - pattern: 'request.files[$FILE]'
      - pattern: 'request.files.get($FILE)'
    message: File upload - ensure MAX_CONTENT_LENGTH is configured
    languages: [python]
    severity: WARNING

  # API5: Broken Function Level Authorization
  - id: py-flask-admin-route
    pattern-regex: "@app\\.route\\(['\"].*admin.*['\"]"
    message: Admin route detected - ensure proper authorization
    languages: [python]
    severity: WARNING

  - id: py-role-check-user-input
    patterns:
      - pattern: 'if request.json.get("role") == "admin"'
      - pattern: 'if request.args.get("is_admin")'
    message: Admin check from user input - authorization bypass risk
    languages: [python]
    severity: ERROR

  # API6: Unrestricted Access to Sensitive Business Flows
  - id: py-flask-no-csrf
    pattern: 'WTF_CSRF_ENABLED = False'
    message: CSRF protection disabled - enable for production
    languages: [python]
    severity: ERROR

  # API7: Server Side Request Forgery (SSRF) - Enhanced
  - id: py-ssrf-requests-json
    patterns:
      - pattern: 'requests.get(request.json.get($URL))'
      - pattern: 'requests.get(request.json[$URL])'
      - pattern: 'requests.post(request.json.get($URL), ...)'
    message: HTTP request with URL from JSON body - SSRF vulnerability
    languages: [python]
    severity: ERROR

  - id: py-ssrf-aiohttp-session
    patterns:
      - pattern: 'await session.get(request.json[$URL])'
      - pattern: 'await session.post(request.json[$URL], ...)'
    message: aiohttp request with user-controlled URL - SSRF vulnerability
    languages: [python]
    severity: ERROR

  - id: py-ssrf-httpx
    patterns:
      - pattern: 'await client.get(request.json[$URL])'
      - pattern: 'httpx.get(request.json[$URL])'
    message: httpx request with user-controlled URL - SSRF vulnerability
    languages: [python]
    severity: ERROR

  # API8: Security Misconfiguration
  - id: py-flask-secret-key-default
    pattern: "app.secret_key = 'dev'"
    message: Flask using default/dev secret key - use strong random key
    languages: [python]
    severity: ERROR

  - id: py-flask-cors-all-origins
    pattern: 'CORS(app, origins="*")'
    message: Flask CORS allows all origins - restrict in production
    languages: [python]
    severity: WARNING

  - id: py-flask-cors-credentials-wildcard
    pattern: 'CORS(app, origins="*", supports_credentials=True)'
    message: CORS wildcard with credentials - security misconfiguration
    languages: [python]
    severity: ERROR

  - id: py-debug-endpoint
    pattern-regex: "@app\\.route\\(['\"].*(debug|test|dev).*['\"]"
    message: Debug/test endpoint detected - remove in production
    languages: [python]
    severity: WARNING

  # API9: Improper Inventory Management
  - id: py-deprecated-endpoint
    pattern-regex: "@app\\.route\\(['\"].*v1.*['\"]"
    message: Version 1 API endpoint - ensure deprecated versions are removed
    languages: [python]
    severity: INFO

  # API10: Unsafe Consumption of APIs
  - id: py-external-api-no-validation
    patterns:
      - pattern: 'response.json()'
      - pattern: 'await response.json()'
    message: External API response - validate data before processing
    languages: [python]
    severity: INFO

  # ============================================
  # Flask-SQLAlchemy SQL Injection
  # ============================================

  - id: py-sqlalchemy-raw-sql
    patterns:
      - pattern: 'db.engine.execute($QUERY)'
      - pattern: 'db.session.execute($QUERY)'
      - pattern: 'engine.execute($QUERY)'
    message: Raw SQL execution - use parameterized queries
    languages: [python]
    severity: WARNING

  - id: py-sqlalchemy-text-format
    patterns:
      - pattern: 'text(f"...")'
      - pattern: 'text($Q % $V)'
      - pattern: 'text($Q + $V)'
      - pattern: 'text($Q.format(...))'
    message: SQLAlchemy text with string interpolation - SQL injection
    languages: [python]
    severity: ERROR

  - id: py-sqlalchemy-from-statement
    pattern: '$MODEL.query.from_statement(text($QUERY))'
    message: from_statement with text - ensure parameterized
    languages: [python]
    severity: WARNING

  - id: py-filter-by-user-input
    pattern: '$MODEL.query.filter_by(**request.args)'
    message: filter_by with request args - NoSQL-style injection risk
    languages: [python]
    severity: ERROR

  # ============================================
  # Flask Authentication Issues
  # ============================================

  - id: py-flask-password-compare
    patterns:
      - pattern: 'if password == user.password'
      - pattern: 'if user.password == password'
    message: Direct password comparison - use check_password_hash
    languages: [python]
    severity: ERROR

  - id: py-flask-password-plaintext
    patterns:
      - pattern: 'user.password = request.json["password"]'
      - pattern: 'user.password = password'
    message: Storing password without hashing - use generate_password_hash
    languages: [python]
    severity: ERROR

  - id: py-werkzeug-weak-hash
    pattern: 'generate_password_hash($PASS, method="md5")'
    message: MD5 password hashing is weak - use pbkdf2 or scrypt
    languages: [python]
    severity: ERROR

  # ============================================
  # Flask Session Security
  # ============================================

  - id: py-flask-session-permanent
    pattern: 'session.permanent = True'
    message: Permanent session - ensure PERMANENT_SESSION_LIFETIME is set
    languages: [python]
    severity: INFO

  - id: py-flask-session-cookie-insecure
    patterns:
      - pattern: 'SESSION_COOKIE_SECURE = False'
      - pattern: 'SESSION_COOKIE_HTTPONLY = False'
    message: Insecure session cookie configuration
    languages: [python]
    severity: ERROR

  - id: py-flask-session-from-user
    patterns:
      - pattern: 'session[$KEY] = request.json[$VALUE]'
      - pattern: 'session.update(request.json)'
    message: Session data from user input - validate before storing
    languages: [python]
    severity: WARNING

  # ============================================
  # Flask Response Security
  # ============================================

  - id: py-flask-jsonify-sensitive
    patterns:
      - pattern: 'return jsonify(user)'
      - pattern: 'return jsonify({"user": user})'
    message: Returning full user object - exclude sensitive fields
    languages: [python]
    severity: WARNING

  - id: py-flask-password-in-response
    patterns:
      - pattern: 'jsonify({"password": $PASS})'
      - pattern: 'jsonify({..., "password": $PASS, ...})'
    message: Password in API response - remove immediately
    languages: [python]
    severity: ERROR

  - id: py-flask-user-enumeration
    patterns:
      - pattern: 'return {"error": "User not found"}'
      - pattern: 'return jsonify({"error": "Invalid username"})'
      - pattern: 'abort(404, "User does not exist")'
    message: User enumeration via error message - use generic errors
    languages: [python]
    severity: WARNING

  # ============================================
  # Input Validation
  # ============================================

  - id: py-flask-no-input-validation
    pattern: |
      @app.route($PATH, methods=["POST"])
      def $FUNC():
        data = request.json
        ...
    message: POST endpoint - validate input data with schema
    languages: [python]
    severity: INFO

  - id: py-marshmallow-no-strict
    pattern: 'Schema().load(data)'
    message: Marshmallow load without strict - unknown fields accepted
    languages: [python]
    severity: INFO

  - id: py-pydantic-no-validation
    pattern: '$MODEL.parse_obj(request.json)'
    message: Pydantic parsing - handle ValidationError
    languages: [python]
    severity: INFO

  # ============================================
  # Dangerous Operations
  # ============================================

  - id: py-flask-send-file-user
    patterns:
      - pattern: 'send_file(request.args[$FILE])'
      - pattern: 'send_file(request.form[$FILE])'
      - pattern: 'send_from_directory($DIR, request.args[$FILE])'
    message: File send with user input - path traversal risk
    languages: [python]
    severity: ERROR

  - id: py-flask-redirect-open
    patterns:
      - pattern: 'redirect(request.args.get("next"))'
      - pattern: 'redirect(request.args.get("url"))'
      - pattern: 'redirect(request.args.get("redirect"))'
    message: Open redirect - validate redirect URL against whitelist
    languages: [python]
    severity: WARNING

  - id: py-flask-redirect-unvalidated
    patterns:
      - pattern: 'redirect(request.json[$URL])'
      - pattern: 'redirect(request.form[$URL])'
    message: Redirect with user-controlled URL - open redirect vulnerability
    languages: [python]
    severity: ERROR

  # ============================================
  # Logging Security
  # ============================================

  - id: py-logging-password
    patterns:
      - pattern: 'logging.info($MSG, password)'
      - pattern: 'logger.info($MSG, password)'
      - pattern: 'app.logger.info($MSG, password)'
    message: Password logged - remove sensitive data from logs
    languages: [python]
    severity: ERROR

  - id: py-logging-token
    patterns:
      - pattern: 'logging.info($MSG, token)'
      - pattern: 'logger.debug($MSG, $OBJ.token)'
    message: Token logged - remove sensitive data from logs
    languages: [python]
    severity: ERROR

  # ============================================
  # Database Connection Security
  # ============================================

  - id: py-sqlalchemy-uri-password
    pattern-regex: "SQLALCHEMY_DATABASE_URI.*://.*:.*@"
    message: Database credentials in URI - use environment variables
    languages: [python]
    severity: ERROR

  - id: py-mongodb-hardcoded-creds
    pattern-regex: "mongodb://[^:]+:[^@]+@"
    message: MongoDB credentials hardcoded - use environment variables
    languages: [python]
    severity: ERROR

  # ============================================
  # VAmPI-Style Vulnerabilities (Common Flask/API Patterns)
  # ============================================

  # SQL Injection - f-string in SQL query
  - id: py-sqli-fstring-select
    pattern-regex: "f[\"']SELECT.*FROM.*WHERE.*\\{.*\\}"
    message: SQL injection - f-string in SELECT query with user variable
    languages: [python]
    severity: ERROR

  - id: py-sqli-session-execute-text
    patterns:
      - pattern: 'db.session.execute(text(f"..."))'
      - pattern: '$DB.session.execute(text(f"..."))'
    message: SQL injection - f-string in SQLAlchemy text() execution
    languages: [python]
    severity: ERROR

  - id: py-sqli-execute-fstring
    patterns:
      - pattern: '$CONN.execute(f"...")'
      - pattern: 'cursor.execute(f"...")'
    message: SQL injection - f-string in SQL execute
    languages: [python]
    severity: ERROR

  # IDOR/BOLA - Object access by URL parameter
  - id: py-idor-url-param-lookup
    patterns:
      - pattern: '$MODEL.query.filter_by(username=username).first()'
      - pattern: '$MODEL.query.filter_by($FIELD=$PARAM).first()'
    message: Object lookup by URL/function parameter - verify authorization
    languages: [python]
    severity: WARNING

  - id: py-idor-no-auth-update
    patterns:
      - pattern: |
          user = $MODEL.query.filter_by(username=username).first()
          ...
          user.$FIELD = $VALUE
      - pattern: |
          $OBJ = $MODEL.query.filter_by($FIELD=$PARAM).first()
          ...
          $OBJ.$ATTR = $VALUE
    message: Object update without checking current user owns object - IDOR risk
    languages: [python]
    severity: WARNING

  # Mass Assignment - Admin privilege escalation
  - id: py-mass-assignment-admin
    patterns:
      - pattern: 'if $DATA["admin"]'
      - pattern: 'if request_data["admin"]'
      - pattern: "if $DATA.get('admin')"
      - pattern: 'if request_data.get("admin")'
    message: Admin flag from user input - mass assignment privilege escalation
    languages: [python]
    severity: ERROR

  - id: py-mass-assignment-role
    patterns:
      - pattern: '$USER.admin = $DATA["admin"]'
      - pattern: '$USER.role = request.json["role"]'
      - pattern: '$USER.is_admin = $DATA.get("is_admin")'
    message: User role/admin from request data - privilege escalation risk
    languages: [python]
    severity: ERROR

  # User Enumeration - Different error messages
  - id: py-user-enum-username
    patterns:
      - pattern: 'return "Username does not exist"'
      - pattern: 'return {"status": "fail", "message": "Username does not exist"}'
      - pattern: '"Username does not exist"'
    message: User enumeration - reveals if username exists
    languages: [python]
    severity: WARNING

  - id: py-user-enum-password
    patterns:
      - pattern: 'return "Password is not correct"'
      - pattern: '"Password is not correct"'
      - pattern: 'return {"status": "fail", "message": "Password is not correct..."}'
    message: User enumeration - password error reveals username exists
    languages: [python]
    severity: WARNING

  - id: py-user-enum-separate-errors
    patterns:
      - pattern: 'if not user: return $USER_ERROR'
      - pattern: 'elif not user: return $USER_ERROR'
    message: Separate user/password errors enable enumeration - use generic message
    languages: [python]
    severity: WARNING

  # ReDoS - Dangerous regex patterns
  - id: py-redos-nested-quantifier
    pattern-regex: "re\\.search\\([rf]?[\"'][^\"']*\\([^)]+\\)\\*[^\"']*[\"']"
    message: ReDoS - nested quantifiers in regex can cause catastrophic backtracking
    languages: [python]
    severity: WARNING

  - id: py-redos-pattern
    pattern-regex: "re\\.(search|match|findall)\\([rf]?[\"'][^\"']*\\+\\*[^\"']*[\"']"
    message: ReDoS - greedy quantifiers may cause excessive backtracking
    languages: [python]
    severity: WARNING

  # ReDoS - Nested group with quantifier like ([a-z]+)+ or (\w+)+
  - id: py-redos-nested-group-plus
    pattern-regex: "re\\.(search|match|findall)\\([rf]?[\"'][^\"']*\\([^)]+\\+\\)\\+[^\"']*[\"']"
    message: ReDoS - nested quantifier pattern (group+)+ causes catastrophic backtracking
    languages: [python]
    severity: ERROR

  # ReDoS - Email validation with nested quantifiers (VAmPI pattern)
  - id: py-redos-email-validation
    patterns:
      - pattern: 're.search($PATTERN, $EMAIL)'
      - pattern: 're.match($PATTERN, $EMAIL)'
    message: Email regex validation - check for ReDoS vulnerable patterns like (a+)+
    languages: [python]
    severity: INFO

  # Debug/Info Disclosure - Exposing sensitive data
  - id: py-debug-password-response
    patterns:
      - pattern: '"password": user.password'
      - pattern: '"password": $USER.password'
      - pattern: "'password': user.password"
    message: Password exposed in API response - remove immediately
    languages: [python]
    severity: ERROR

  - id: py-debug-json-all-fields
    patterns:
      - pattern: 'return user.json_debug()'
      - pattern: 'return $OBJ.json_debug()'
      - pattern: 'jsonify($MODEL.json_debug())'
    message: Debug JSON method in response - may expose sensitive fields
    languages: [python]
    severity: WARNING

  - id: py-debug-get-all-users
    patterns:
      - pattern: 'return User.get_all_users()'
      - pattern: 'return $MODEL.get_all_users()'
      - pattern: '$MODEL.query.all()'
    message: Returning all users - ensure authorization and field filtering
    languages: [python]
    severity: WARNING

  # Weak Authentication - Plaintext password comparison
  - id: py-plaintext-password-check
    patterns:
      - pattern: 'request_data.get("password") != user.password'
      - pattern: '$DATA["password"] != $USER.password'
      - pattern: 'password != user.password'
    message: Plaintext password comparison - use password hashing
    languages: [python]
    severity: ERROR

  - id: py-plaintext-password-store
    patterns:
      - pattern: 'user.password = request_data.get("password")'
      - pattern: '$USER.password = $DATA["password"]'
      - pattern: 'self.password = password'
    message: Storing plaintext password - use generate_password_hash
    languages: [python]
    severity: ERROR

  # Broken Object Level Authorization (BOLA) - No ownership check
  - id: py-bola-update-any-user
    patterns:
      - pattern: |
          user = User.query.filter_by(username=username).first()
          user.password = $NEW_PASS
      - pattern: |
          $OBJ = $MODEL.query.filter_by($FIELD=$PARAM).first()
          ...
          db.session.commit()
    message: BOLA - updating object by URL param without ownership verification
    languages: [python]
    severity: ERROR

  - id: py-bola-delete-any
    patterns:
      - pattern: |
          $OBJ = $MODEL.query.filter_by($FIELD=$PARAM).first()
          db.session.delete($OBJ)
    message: BOLA - deleting object by URL param without ownership check
    languages: [python]
    severity: ERROR

  # Excessive Data Exposure
  - id: py-excessive-data-all-fields
    patterns:
      - pattern: 'return jsonify([u.__dict__ for u in $USERS])'
      - pattern: 'return jsonify([$U.to_dict() for $U in $USERS])'
    message: Excessive data exposure - filter fields in response
    languages: [python]
    severity: WARNING

  - id: py-excessive-data-model-dump
    patterns:
      - pattern: 'return jsonify($MODEL.__dict__)'
      - pattern: 'return jsonify(vars($MODEL))'
    message: Model __dict__ in response - exposes all fields including sensitive
    languages: [python]
    severity: WARNING

  # Broken Authentication - Weak JWT
  - id: py-jwt-hardcoded-secret
    patterns:
      - pattern: 'SECRET_KEY = "..."'
      - pattern: "SECRET_KEY = '...'"
      - pattern: 'jwt.encode($P, "...", ...)'
    message: Hardcoded JWT secret - use environment variable
    languages: [python]
    severity: ERROR

  - id: py-jwt-no-expiry
    pattern: 'jwt.encode($PAYLOAD, $SECRET)'
    message: JWT without expiration - add exp claim
    languages: [python]
    severity: WARNING

  # Missing Rate Limiting
  - id: py-no-rate-limit-login
    pattern-regex: "@app\\.route\\(['\"].*login.*['\"]"
    message: Login endpoint - add rate limiting to prevent brute force
    languages: [python]
    severity: WARNING

  - id: py-no-rate-limit-register
    pattern-regex: "@app\\.route\\(['\"].*register.*['\"]"
    message: Registration endpoint - add rate limiting to prevent abuse
    languages: [python]
    severity: INFO

  # SQLAlchemy f-string injection (VAmPI specific)
  - id: py-sqli-vampi-style
    pattern: |
      $QUERY = f"SELECT * FROM $TABLE WHERE $FIELD = '{$VAR}'"
    message: SQL injection - user input in f-string query
    languages: [python]
    severity: ERROR

  - id: py-sqli-text-fstring
    pattern: 'text(f"...")'
    message: SQL injection - f-string in SQLAlchemy text()
    languages: [python]
    severity: ERROR

  # Broad Exception Handling
  - id: py-bare-except
    pattern: |
      try:
        ...
      except:
        ...
    message: Bare except clause - catch specific exceptions
    languages: [python]
    severity: INFO

  - id: py-except-pass
    pattern: |
      except:
        pass
    message: Silent exception swallowing - log or handle errors
    languages: [python]
    severity: WARNING

  # ============================================
  # VAmPI-Specific Exact Patterns
  # ============================================

  # SQL Injection - f-string with variable in WHERE clause (VAmPI pattern)
  - id: py-vampi-sqli-fstring
    pattern-regex: "user_query\\s*=\\s*f[\"']SELECT.*FROM.*WHERE.*\\{.*\\}"
    message: SQL injection - f-string with user input in WHERE clause
    languages: [python]
    severity: ERROR

  - id: py-vampi-sqli-text-execute
    pattern: 'db.session.execute(text($QUERY))'
    message: SQL injection - executing text query (check for f-string interpolation)
    languages: [python]
    severity: WARNING

  # Mass Assignment - admin flag from request data (VAmPI pattern)
  - id: py-vampi-mass-assign-admin-check
    pattern-regex: "if.*'admin'\\s+in\\s+request_data"
    message: Mass assignment - checking for admin flag in user input allows privilege escalation
    languages: [python]
    severity: ERROR

  - id: py-vampi-mass-assign-admin-value
    pattern-regex: "if\\s+request_data\\['admin'\\]"
    message: Mass assignment - admin flag from user input allows privilege escalation
    languages: [python]
    severity: ERROR

  - id: py-vampi-admin-from-request
    pattern: 'admin = $DATA[$KEY]'
    message: Admin flag from user request - mass assignment privilege escalation
    languages: [python]
    severity: ERROR

  # User Enumeration - specific error messages (VAmPI pattern)
  - id: py-vampi-user-enum-password-error
    pattern-regex: '"Password is not correct'
    message: User enumeration - password error message reveals username exists
    languages: [python]
    severity: WARNING

  - id: py-vampi-user-enum-username-error
    pattern-regex: '"Username does not exist'
    message: User enumeration - error message reveals username does not exist
    languages: [python]
    severity: WARNING

  # ReDoS - Complex regex with nested quantifiers (VAmPI pattern)
  - id: py-vampi-redos-email
    pattern-regex: "re\\.search\\([rf]?[\"'][^\"']*\\[-\\.\\\\w\\]\\*[^\"']*\\)"
    message: ReDoS - complex regex with nested quantifiers can cause catastrophic backtracking
    languages: [python]
    severity: WARNING

  - id: py-redos-email-validator
    pattern-regex: "re\\.(search|match)\\([^,]+,\\s*str\\(request"
    message: ReDoS - regex on user input may be vulnerable to ReDoS attack
    languages: [python]
    severity: WARNING

  # Weak JWT Secret - hardcoded in config (VAmPI pattern)
  - id: py-vampi-weak-jwt-secret
    pattern-regex: "config\\['SECRET_KEY'\\]\\s*=\\s*['\"]\\w+['\"]"
    message: Weak JWT secret - hardcoded short/predictable secret enables token forgery
    languages: [python]
    severity: ERROR

  - id: py-flask-config-secret-key
    pattern: "$APP.config['SECRET_KEY'] = '...'"
    message: Hardcoded Flask SECRET_KEY - use environment variable
    languages: [python]
    severity: ERROR

  # Debug Endpoint - exposing all user data (VAmPI pattern)
  - id: py-vampi-debug-endpoint
    pattern-regex: "def\\s+debug\\(\\):"
    message: Debug function exposed - may leak sensitive data
    languages: [python]
    severity: WARNING

  - id: py-vampi-debug-all-users
    pattern: 'User.get_all_users_debug()'
    message: Debug endpoint exposing all users with sensitive fields
    languages: [python]
    severity: ERROR

  - id: py-debug-method-call
    pattern: '$OBJ.get_all_$TYPE_debug()'
    message: Debug method exposing sensitive data - remove in production
    languages: [python]
    severity: ERROR

  - id: py-json-debug-method
    pattern: 'return $OBJ.json_debug()'
    message: Debug JSON method exposes sensitive fields like passwords
    languages: [python]
    severity: ERROR

  # BOLA - Object access by URL parameter without auth check (VAmPI pattern)
  - id: py-vampi-bola-password-update
    pattern: |
      user = User.query.filter_by(username=username).first()
      ...
      user.password = $VALUE
    message: BOLA - updating user password by URL username without ownership check
    languages: [python]
    severity: ERROR

  - id: py-vampi-bola-book-access
    pattern: 'Book.query.filter_by(book_title=$TITLE).first()'
    message: BOLA - accessing book by title without owner verification
    languages: [python]
    severity: WARNING

  - id: py-bola-query-url-param
    pattern: '$MODEL.query.filter_by($FIELD=$URL_PARAM).first()'
    message: BOLA - object lookup by URL parameter without authorization check
    languages: [python]
    severity: WARNING

  # Plaintext Password Comparison (VAmPI pattern)
  - id: py-vampi-plaintext-password
    pattern: "request_data.get('password') == user.password"
    message: Plaintext password comparison - passwords should be hashed
    languages: [python]
    severity: ERROR

  - id: py-vampi-plaintext-password-ne
    pattern: "request_data.get('password') != user.password"
    message: Plaintext password comparison - passwords should be hashed
    languages: [python]
    severity: ERROR

  - id: py-direct-password-equality
    pattern: '$USER_INPUT == $USER.password'
    message: Direct password comparison - use check_password_hash
    languages: [python]
    severity: ERROR

  # Flask Debug Mode (VAmPI has debug=True)
  - id: py-vampi-flask-debug
    pattern: 'vuln_app.run(host=$HOST, port=$PORT, debug=True)'
    message: Flask running with debug=True - disable in production
    languages: [python]
    severity: WARNING

  # Password stored in User model without hashing
  - id: py-model-password-plaintext
    pattern: 'self.password = password'
    message: Storing password without hashing - use generate_password_hash
    languages: [python]
    severity: ERROR

  # Missing authorization check on sensitive operations
  - id: py-update-without-auth-check
    pattern: |
      user = $MODEL.query.filter_by(username=$PARAM).first()
      user.$FIELD = $VALUE
      db.session.commit()
    message: Database update without authorization check - verify user owns object
    languages: [python]
    severity: ERROR

  # API route returning user debug info
  - id: py-route-returns-debug
    pattern: 'return_value = jsonify({...: $MODEL.get_all_$TYPE_debug()})'
    message: API route returning debug data - may expose sensitive fields
    languages: [python]
    severity: ERROR

  # Password in JSON response
  - id: py-password-in-json-response
    pattern-regex: "'password':\\s*\\$?\\w+\\.password"
    message: Password field in response - never expose passwords in API responses
    languages: [python]
    severity: ERROR

  # Random string for secret (VAmPI uses 'random')
  - id: py-weak-secret-string
    pattern-regex: "SECRET_KEY['\"]\\]?\\s*=\\s*['\"]random['\"]"
    message: Weak secret key - use cryptographically secure random value
    languages: [python]
    severity: ERROR

  # JWT encode with config secret
  - id: py-jwt-encode-config-secret
    pattern: 'jwt.encode($PAYLOAD, $CONFIG.get($KEY), algorithm=$ALG)'
    message: JWT encoding - ensure secret key is not weak/hardcoded
    languages: [python]
    severity: INFO

  # ============================================
  # VAmPI: RegexDOS - Denial of Service via Regex
  # ============================================

  # Nested quantifiers in regex - exponential backtracking
  - id: py-redos-nested-quantifiers
    pattern-regex: "re\\.(match|search|findall|fullmatch|sub)\\([^)]*\\([^)]*[+*]\\)[^)]*[+*]"
    message: Regex with nested quantifiers - potential ReDoS vulnerability (exponential backtracking)
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1333"
      tags: [redos, vampi]

  # Evil regex patterns - common ReDoS patterns
  - id: py-redos-evil-pattern
    pattern-regex: "re\\.(compile|match|search)\\(['\"][^'\"]*\\([^)]+\\)\\+\\)[^'\"]*['\"]"
    message: Regex pattern may cause ReDoS - nested quantifiers with backtracking
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1333"
      tags: [redos, vampi]

  # Regex with user input without timeout
  - id: py-regex-user-input
    patterns:
      - pattern: |
          re.match($PATTERN, request.$X)
      - pattern: |
          re.search($PATTERN, request.$X)
      - pattern: |
          re.findall($PATTERN, request.$X)
    message: Regex on user input - consider using timeout to prevent ReDoS
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"
      tags: [redos, vampi]

  # ============================================
  # VAmPI: API Rate Limiting Missing
  # ============================================

  # Flask route without rate limiting
  - id: py-flask-no-rate-limit
    patterns:
      - pattern: |
          @app.route($PATH)
          def $FUNC():
              ...
      - pattern: |
          @app.route($PATH, methods=$METHODS)
          def $FUNC():
              ...
    message: Flask route without rate limiting - add flask-limiter to prevent abuse
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      tags: [rate-limiting, vampi]

  # Login endpoint without rate limiting
  - id: py-login-no-rate-limit
    pattern-regex: "@app\\.route\\(['\"]/(login|auth|signin|authenticate)['\"]"
    message: Authentication endpoint without visible rate limiting - add @limiter.limit() to prevent brute force
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-307"
      tags: [rate-limiting, auth, vampi]

  # Password reset without rate limiting
  - id: py-password-reset-no-rate-limit
    pattern-regex: "@app\\.route\\(['\"]/(reset|forgot|password)[^'\"]*['\"]"
    message: Password reset endpoint - ensure rate limiting is applied
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-307"
      tags: [rate-limiting, auth, vampi]

  # Flask-RESTful without rate limiting
  - id: py-flask-restful-no-rate-limit
    patterns:
      - pattern: |
          class $RESOURCE(Resource):
              def get(self):
                  ...
      - pattern: |
          class $RESOURCE(Resource):
              def post(self):
                  ...
    message: Flask-RESTful resource without rate limiting - add flask-limiter
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      tags: [rate-limiting, vampi]

  # Blueprint route without rate limiting
  - id: py-blueprint-no-rate-limit
    pattern-regex: "@\\w+_bp\\.route\\("
    message: Flask Blueprint route - ensure rate limiting is configured
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      tags: [rate-limiting, vampi]

  # ============================================
  # VAmPI: JWT Weak Key Detection (Additional)
  # ============================================

  # JWT with weak/short secret
  - id: py-jwt-weak-secret
    pattern-regex: "jwt\\.(encode|decode)\\([^)]+,\\s*['\"][^'\"]{1,16}['\"]"
    message: JWT with potentially weak secret (less than 16 chars) - use strong random key
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-327"
      tags: [jwt, vampi]

  # JWT algorithm none attack
  - id: py-jwt-algorithm-none
    patterns:
      - pattern: "jwt.decode($TOKEN, options={'verify_signature': False})"
      - pattern-regex: "algorithm\\s*=\\s*['\"]none['\"]"
    message: JWT signature verification disabled or algorithm=none - authentication bypass risk
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-347"
      tags: [jwt, vampi]
