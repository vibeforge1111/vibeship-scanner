# Python Security Rules
rules:
  # ============================================
  # Command Injection
  # ============================================

  - id: py-os-system
    pattern: os.system(...)
    message: os.system() call - potential command injection vulnerability
    languages: [python]
    severity: ERROR

  - id: py-subprocess-shell
    pattern: 'subprocess.call($CMD, shell=True)'
    message: subprocess with shell=True - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-subprocess-popen-shell
    pattern: 'subprocess.Popen($CMD, shell=True)'
    message: Popen with shell=True - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-subprocess-run-shell
    pattern: 'subprocess.run($CMD, shell=True)'
    message: subprocess.run with shell=True - command injection risk
    languages: [python]
    severity: ERROR

  # ============================================
  # Code Injection
  # ============================================

  - id: py-exec-call
    pattern: exec(...)
    message: Python exec() - code injection risk
    languages: [python]
    severity: ERROR

  - id: py-eval-call
    pattern: eval(...)
    message: Python eval() - code injection risk
    languages: [python]
    severity: ERROR

  - id: py-compile-call
    pattern: compile($CODE, ...)
    message: Python compile() with user input - code injection risk
    languages: [python]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: py-pickle-loads
    pattern: pickle.loads(...)
    message: pickle.loads() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-pickle-load
    pattern: pickle.load(...)
    message: pickle.load() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-cPickle-loads
    pattern: cPickle.loads(...)
    message: cPickle.loads() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-cPickle-load
    pattern: cPickle.load(...)
    message: cPickle.load() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-yaml-unsafe
    pattern: yaml.load($DATA)
    message: yaml.load() without Loader - insecure deserialization (use safe_load)
    languages: [python]
    severity: ERROR

  - id: py-yaml-unsafe-loader
    pattern: 'yaml.load($DATA, Loader=yaml.Loader)'
    message: yaml.load with Loader - insecure deserialization (use safe_load)
    languages: [python]
    severity: ERROR

  - id: py-marshal-loads
    pattern: marshal.loads(...)
    message: marshal.loads() - insecure deserialization
    languages: [python]
    severity: ERROR

  - id: py-shelve-open
    pattern: shelve.open(...)
    message: shelve uses pickle internally - insecure deserialization risk
    languages: [python]
    severity: WARNING

  # ============================================
  # SQL Injection
  # ============================================

  - id: py-sql-format
    pattern: cursor.execute($Q % $V)
    message: SQL query with string formatting - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-sql-concat
    pattern: cursor.execute($Q + $V)
    message: SQL query with string concatenation - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-sql-fstring
    pattern: cursor.execute(f"...")
    message: SQL query with f-string - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-sqlalchemy-text
    pattern: text($QUERY)
    message: SQLAlchemy text() - ensure parameterized queries
    languages: [python]
    severity: WARNING

  # ============================================
  # Path Traversal
  # ============================================

  - id: py-open-user-input
    pattern: open($USER_INPUT, ...)
    message: File open with user input - potential path traversal
    languages: [python]
    severity: WARNING

  - id: py-os-path-join-user
    pattern: os.path.join($BASE, request.$X)
    message: Path construction with user input - path traversal risk
    languages: [python]
    severity: WARNING

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: py-md5-hashlib
    pattern: hashlib.md5(...)
    message: MD5 is a weak hash function - use SHA-256 or better
    languages: [python]
    severity: WARNING

  - id: py-sha1-hashlib
    pattern: hashlib.sha1(...)
    message: SHA1 is a weak hash function - use SHA-256 or better
    languages: [python]
    severity: WARNING

  - id: py-random-security
    pattern: random.random()
    message: random module is not cryptographically secure - use secrets module
    languages: [python]
    severity: WARNING

  - id: py-random-randint
    pattern: random.randint(...)
    message: random module is not cryptographically secure - use secrets module
    languages: [python]
    severity: WARNING

  - id: py-random-choice
    pattern: random.choice(...)
    message: random module is not cryptographically secure - use secrets.choice()
    languages: [python]
    severity: WARNING

  - id: py-weak-cipher-des
    pattern: 'DES.new(...)'
    message: DES is a weak cipher - use AES instead
    languages: [python]
    severity: ERROR

  - id: py-weak-cipher-des3
    pattern: 'DES3.new(...)'
    message: Triple DES (3DES) is deprecated - use AES instead
    languages: [python]
    severity: WARNING

  - id: py-weak-cipher-blowfish
    pattern: 'Blowfish.new(...)'
    message: Blowfish is deprecated - use AES instead
    languages: [python]
    severity: WARNING

  - id: py-weak-cipher-rc4
    pattern: 'ARC4.new(...)'
    message: RC4 is broken - use AES instead
    languages: [python]
    severity: ERROR

  - id: py-ecb-mode
    pattern: 'AES.new($KEY, AES.MODE_ECB)'
    message: ECB mode is insecure - use GCM or CBC with random IV
    languages: [python]
    severity: ERROR

  - id: py-weak-rsa-key
    pattern: 'RSA.generate(1024)'
    message: RSA key size too small - use at least 2048 bits
    languages: [python]
    severity: ERROR

  - id: py-weak-rsa-key-512
    pattern: 'RSA.generate(512)'
    message: RSA key size too small - use at least 2048 bits
    languages: [python]
    severity: ERROR

  - id: py-static-iv
    patterns:
      - pattern: 'AES.new($KEY, $MODE, iv=b"...")'
      - pattern: "AES.new($KEY, $MODE, iv=b'...')"
    message: Static IV in encryption - IV should be random for each encryption
    languages: [python]
    severity: ERROR

  - id: py-fernet-hardcoded-key
    pattern: 'Fernet(b"...")'
    message: Hardcoded Fernet key - use environment variable
    languages: [python]
    severity: ERROR

  # ============================================
  # TLS/SSL Issues
  # ============================================

  - id: py-ssl-unverified
    pattern: 'ssl._create_unverified_context()'
    message: SSL certificate verification disabled - MITM attack risk
    languages: [python]
    severity: ERROR

  - id: py-requests-verify-false
    pattern: 'requests.get($URL, verify=False)'
    message: SSL verification disabled in requests - MITM attack risk
    languages: [python]
    severity: ERROR

  - id: py-requests-post-verify-false
    pattern: 'requests.post($URL, verify=False)'
    message: SSL verification disabled in requests - MITM attack risk
    languages: [python]
    severity: ERROR

  # ============================================
  # JWT Security
  # ============================================

  - id: py-jwt-none-algorithm
    pattern: '"alg":"none"'
    message: JWT none algorithm - authentication bypass vulnerability
    languages: [python]
    severity: ERROR

  - id: py-jwt-decode-no-verify
    pattern: 'jwt.decode($TOKEN, verify=False)'
    message: JWT verification disabled - authentication bypass
    languages: [python]
    severity: ERROR

  - id: py-jwt-decode-options-no-verify
    pattern: 'jwt.decode($TOKEN, options={"verify_signature": False})'
    message: JWT signature verification disabled
    languages: [python]
    severity: ERROR

  # ============================================
  # SSRF (Server-Side Request Forgery)
  # ============================================

  - id: py-requests-user-url
    pattern: requests.get($USER_INPUT)
    message: HTTP request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  - id: py-urllib-user-url
    pattern: urllib.request.urlopen($USER_INPUT)
    message: URL open with user input - potential SSRF
    languages: [python]
    severity: WARNING

  # ============================================
  # XXE (XML External Entity)
  # ============================================

  - id: py-xml-etree-parse
    pattern: ET.parse($INPUT)
    message: XML parsing - ensure external entities are disabled
    languages: [python]
    severity: WARNING

  - id: py-xml-etree-fromstring
    pattern: ET.fromstring($INPUT)
    message: XML parsing - ensure external entities are disabled
    languages: [python]
    severity: WARNING

  - id: py-lxml-parse
    pattern: lxml.etree.parse($INPUT)
    message: lxml XML parsing - disable external entities
    languages: [python]
    severity: WARNING

  # ============================================
  # Django Specific
  # ============================================

  - id: py-django-mark-safe
    pattern: mark_safe($INPUT)
    message: Django mark_safe() - XSS risk if input is user-controlled
    languages: [python]
    severity: WARNING

  - id: py-django-raw-sql
    pattern: $MODEL.objects.raw($QUERY)
    message: Django raw SQL - ensure parameterized queries
    languages: [python]
    severity: WARNING

  - id: py-django-extra
    pattern: $QUERYSET.extra($KWARGS)
    message: Django QuerySet.extra() is deprecated - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-django-debug-true
    pattern: 'DEBUG = True'
    message: Django DEBUG enabled - disable in production
    languages: [python]
    severity: WARNING

  # ============================================
  # Flask Specific
  # ============================================

  - id: py-flask-debug-true
    pattern: 'app.run(debug=True)'
    message: Flask debug mode enabled - disable in production
    languages: [python]
    severity: WARNING

  - id: py-flask-secret-key-hardcoded
    pattern: 'app.secret_key = "..."'
    message: Hardcoded Flask secret key - use environment variables
    languages: [python]
    severity: ERROR

  # ============================================
  # Hardcoded Credentials
  # ============================================

  - id: py-hardcoded-password
    pattern: 'password = "..."'
    message: Hardcoded password detected
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-api-key
    pattern: 'api_key = "..."'
    message: Hardcoded API key detected
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-secret
    pattern: 'secret = "..."'
    message: Hardcoded secret detected
    languages: [python]
    severity: ERROR

  # ============================================
  # Debug/Info Disclosure
  # ============================================

  - id: py-print-statement
    pattern: print(...)
    message: Print statement found - consider using logging
    languages: [python]
    severity: INFO

  - id: py-traceback-print
    pattern: traceback.print_exc()
    message: Traceback printed - may expose sensitive information
    languages: [python]
    severity: INFO

  # ============================================
  # FastAPI / Starlette Security
  # ============================================

  - id: py-fastapi-cors-wildcard
    pattern: 'CORSMiddleware($APP, allow_origins=["*"])'
    message: FastAPI CORS allows all origins - restrict in production
    languages: [python]
    severity: WARNING

  - id: py-fastapi-cors-credentials-wildcard
    pattern: 'CORSMiddleware($APP, allow_origins=["*"], allow_credentials=True)'
    message: FastAPI CORS wildcard with credentials - security risk
    languages: [python]
    severity: ERROR

  - id: py-starlette-session-hardcoded
    pattern: 'SessionMiddleware($APP, secret_key="...")'
    message: Hardcoded session secret - use environment variable
    languages: [python]
    severity: ERROR

  # ============================================
  # Server-Side Template Injection (SSTI)
  # ============================================

  - id: py-jinja2-autoescape-false
    pattern: 'Environment(autoescape=False)'
    message: Jinja2 autoescape disabled - XSS vulnerability
    languages: [python]
    severity: ERROR

  - id: py-jinja2-from-string
    pattern: 'Template($USER_INPUT).render(...)'
    message: Jinja2 template from user input - SSTI vulnerability
    languages: [python]
    severity: ERROR

  - id: py-mako-template-user
    pattern: 'MakoTemplate($USER_INPUT).render(...)'
    message: Mako template from user input - SSTI vulnerability
    languages: [python]
    severity: ERROR

  - id: py-flask-render-template-string
    pattern: render_template_string($INPUT)
    message: Flask render_template_string - SSTI risk with user input
    languages: [python]
    severity: WARNING

  # ============================================
  # Additional ORM/Database Patterns
  # ============================================

  - id: py-sqlalchemy-execute-text
    pattern: '$CONN.execute(text($QUERY))'
    message: SQLAlchemy execute with text - ensure parameterized
    languages: [python]
    severity: WARNING

  - id: py-django-cursor-execute
    pattern: 'cursor.execute($QUERY.format(...))'
    message: Django raw SQL with format - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-django-connection-cursor
    pattern: 'connection.cursor().execute($Q % $V)'
    message: Django raw SQL with string formatting - SQL injection
    languages: [python]
    severity: ERROR

  - id: py-peewee-raw
    pattern: '$MODEL.raw($QUERY)'
    message: Peewee raw SQL - ensure parameterized
    languages: [python]
    severity: WARNING

  - id: py-tortoise-raw
    pattern: '$CONN.execute_query($QUERY)'
    message: Tortoise ORM raw query - ensure parameterized
    languages: [python]
    severity: WARNING

  # ============================================
  # Additional SSRF Patterns
  # ============================================

  - id: py-httpx-user-url
    pattern: httpx.get($USER_INPUT)
    message: httpx request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  - id: py-aiohttp-user-url
    pattern: '$SESSION.get($USER_INPUT)'
    message: aiohttp request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  - id: py-urllib3-user-url
    pattern: 'urllib3.request("GET", $USER_INPUT)'
    message: urllib3 request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  # ============================================
  # Mass Assignment / Object Injection
  # ============================================

  - id: py-django-model-from-dict
    pattern: '$MODEL(**request.POST)'
    message: Django model from POST data - mass assignment risk
    languages: [python]
    severity: ERROR

  - id: py-django-form-unvalidated
    pattern: '$MODEL(**request.data)'
    message: Model from request data - ensure validation
    languages: [python]
    severity: WARNING

  - id: py-setattr-user-input
    pattern: setattr($OBJ, $USER_INPUT, $VALUE)
    message: setattr with user input - attribute injection risk
    languages: [python]
    severity: ERROR

  # ============================================
  # Information Disclosure
  # ============================================

  - id: py-exception-details
    pattern: 'return {"error": str($EXCEPTION)}'
    message: Exception details in response - may leak sensitive info
    languages: [python]
    severity: WARNING

  - id: py-flask-exception-response
    pattern: 'return str(e), 500'
    message: Exception details returned - may leak sensitive info
    languages: [python]
    severity: WARNING

  # ============================================
  # Async Security Issues
  # ============================================

  - id: py-asyncio-subprocess-shell
    pattern: 'asyncio.create_subprocess_shell(...)'
    message: Async subprocess with shell - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-asyncio-run-in-executor-os
    pattern: 'loop.run_in_executor($EX, os.system, $CMD)'
    message: os.system in executor - command injection risk
    languages: [python]
    severity: ERROR
