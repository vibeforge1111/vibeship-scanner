# Python Security Rules
rules:
  # ============================================
  # Command Injection
  # ============================================

  - id: py-os-system
    pattern: os.system(...)
    message: os.system() call - potential command injection vulnerability
    languages: [python]
    severity: ERROR

  - id: py-subprocess-shell
    pattern: subprocess.call(..., shell=True, ...)
    message: subprocess with shell=True - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-subprocess-popen-shell
    pattern: subprocess.Popen(..., shell=True, ...)
    message: Popen with shell=True - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-subprocess-run-shell
    pattern: subprocess.run(..., shell=True, ...)
    message: subprocess.run with shell=True - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-subprocess-check-output
    pattern: subprocess.check_output(...)
    message: "subprocess.check_output() - verify user input is validated before use (CWE-78)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021 Injection"

  - id: py-subprocess-check-call
    pattern: subprocess.check_call(...)
    message: "subprocess.check_call() - verify user input is validated before use (CWE-78)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021 Injection"

  - id: py-subprocess-call-no-shell
    pattern: subprocess.call(...)
    message: "subprocess.call() - verify user input is validated before use (CWE-78)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021 Injection"

  - id: py-subprocess-popen-no-shell
    pattern: subprocess.Popen(...)
    message: "subprocess.Popen() - verify user input is validated before use (CWE-78)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021 Injection"

  - id: py-subprocess-run-no-shell
    pattern: subprocess.run(...)
    message: "subprocess.run() - verify user input is validated before use (CWE-78)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021 Injection"

  # ============================================
  # Code Injection
  # ============================================

  - id: py-exec-call
    pattern: exec(...)
    message: Python exec() - code injection risk
    languages: [python]
    severity: ERROR

  - id: py-eval-call
    pattern: eval(...)
    message: Python eval() - code injection risk
    languages: [python]
    severity: ERROR

  - id: py-compile-call
    pattern: compile($CODE, ...)
    message: Python compile() with user input - code injection risk
    languages: [python]
    severity: WARNING

  # ============================================
  # Insecure Deserialization
  # ============================================

  - id: py-pickle-loads
    pattern: pickle.loads(...)
    message: pickle.loads() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-pickle-load
    pattern: pickle.load(...)
    message: pickle.load() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-cPickle-loads
    pattern: cPickle.loads(...)
    message: cPickle.loads() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-cPickle-load
    pattern: cPickle.load(...)
    message: cPickle.load() - insecure deserialization vulnerability
    languages: [python]
    severity: ERROR

  - id: py-yaml-unsafe
    pattern: yaml.load($DATA)
    message: yaml.load() without Loader - insecure deserialization (use safe_load)
    languages: [python]
    severity: ERROR

  - id: py-yaml-unsafe-loader
    pattern: 'yaml.load($DATA, Loader=yaml.Loader)'
    message: yaml.load with Loader - insecure deserialization (use safe_load)
    languages: [python]
    severity: ERROR

  - id: py-marshal-loads
    pattern: marshal.loads(...)
    message: marshal.loads() - insecure deserialization
    languages: [python]
    severity: ERROR

  - id: py-shelve-open
    pattern: shelve.open(...)
    message: shelve uses pickle internally - insecure deserialization risk
    languages: [python]
    severity: WARNING

  # ============================================
  # SQL Injection
  # ============================================

  - id: py-sql-format
    pattern: cursor.execute($Q % $V)
    message: SQL query with string formatting - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-sql-concat
    pattern: cursor.execute($Q + $V)
    message: SQL query with string concatenation - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-sql-fstring
    pattern: cursor.execute(f"...")
    message: SQL query with f-string - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-sql-db-execute-fstring
    pattern: $DB.execute(f"...")
    message: "SQL query with f-string - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-await-execute-fstring
    pattern: await $DB.execute(f"...")
    message: "Async SQL query with f-string - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-execute-var
    patterns:
      - pattern-either:
          - pattern: |
              $QUERY = f"..."
              ...
              $DB.execute($QUERY, ...)
          - pattern: |
              $QUERY = f"..."
              ...
              await $DB.execute($QUERY, ...)
          - pattern: |
              $QUERY = f"..."
              ...
              $CURSOR.execute($QUERY, ...)
    message: "SQL query built with f-string then executed - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-aiosqlite-fstring
    pattern-regex: 'await\s+\w+\.execute\s*\(\s*f["\''"]'
    message: "aiosqlite execute with f-string - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-fstring-select-single
    pattern-regex: "f'[^']*SELECT[^']*\\{[^}]+\\}[^']*'"
    message: "SQL SELECT with f-string interpolation - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-fstring-select-double
    pattern-regex: 'f"[^"]*SELECT[^"]*\{[^}]+\}[^"]*"'
    message: "SQL SELECT with f-string interpolation - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-fstring-insert-single
    pattern-regex: "f'[^']*INSERT[^']*\\{[^}]+\\}[^']*'"
    message: "SQL INSERT with f-string interpolation - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-fstring-insert-double
    pattern-regex: 'f"[^"]*INSERT[^"]*\{[^}]+\}[^"]*"'
    message: "SQL INSERT with f-string interpolation - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-fstring-delete-single
    pattern-regex: "f'[^']*DELETE[^']*\\{[^}]+\\}[^']*'"
    message: "SQL DELETE with f-string interpolation - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-fstring-delete-double
    pattern-regex: 'f"[^"]*DELETE[^"]*\{[^}]+\}[^"]*"'
    message: "SQL DELETE with f-string interpolation - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-fstring-update-single
    pattern-regex: "f'[^']*UPDATE[^']*\\{[^}]+\\}[^']*'"
    message: "SQL UPDATE with f-string interpolation - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sql-fstring-update-double
    pattern-regex: 'f"[^"]*UPDATE[^"]*\{[^}]+\}[^"]*"'
    message: "SQL UPDATE with f-string interpolation - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sqlalchemy-text
    pattern: text($QUERY)
    message: SQLAlchemy text() - ensure parameterized queries
    languages: [python]
    severity: WARNING

  # ============================================
  # Path Traversal
  # ============================================

  - id: py-open-user-input
    pattern: open($USER_INPUT, ...)
    message: File open with user input - potential path traversal
    languages: [python]
    severity: WARNING

  - id: py-os-path-join-user
    pattern: os.path.join($BASE, request.$X)
    message: Path construction with user input - path traversal risk
    languages: [python]
    severity: WARNING

  # ============================================
  # Weak Cryptography
  # ============================================

  - id: py-md5-hashlib
    pattern: hashlib.md5(...)
    message: MD5 is a weak hash function - use SHA-256 or better
    languages: [python]
    severity: WARNING

  - id: py-md5-direct
    pattern: md5(...)
    message: "MD5 is a weak hash - use SHA-256 or bcrypt for passwords (CWE-328)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-328"

  - id: py-md5-hexdigest
    pattern-regex: 'md5\(.*\)\.hexdigest\(\)'
    message: "MD5 hexdigest - weak hash, use SHA-256 or bcrypt for passwords (CWE-328)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-328"

  - id: py-sha1-hashlib
    pattern: hashlib.sha1(...)
    message: SHA1 is a weak hash function - use SHA-256 or better
    languages: [python]
    severity: WARNING

  - id: py-random-security
    pattern: random.random()
    message: random module is not cryptographically secure - use secrets module
    languages: [python]
    severity: WARNING

  - id: py-random-randint
    pattern: random.randint(...)
    message: random module is not cryptographically secure - use secrets module
    languages: [python]
    severity: WARNING

  - id: py-random-choice
    pattern: random.choice(...)
    message: random module is not cryptographically secure - use secrets.choice()
    languages: [python]
    severity: WARNING

  - id: py-weak-cipher-des
    pattern: 'DES.new(...)'
    message: DES is a weak cipher - use AES instead
    languages: [python]
    severity: ERROR

  - id: py-weak-cipher-des3
    pattern: 'DES3.new(...)'
    message: Triple DES (3DES) is deprecated - use AES instead
    languages: [python]
    severity: WARNING

  - id: py-weak-cipher-blowfish
    pattern: 'Blowfish.new(...)'
    message: Blowfish is deprecated - use AES instead
    languages: [python]
    severity: WARNING

  - id: py-weak-cipher-rc4
    pattern: 'ARC4.new(...)'
    message: RC4 is broken - use AES instead
    languages: [python]
    severity: ERROR

  - id: py-ecb-mode
    pattern: 'AES.new($KEY, AES.MODE_ECB)'
    message: ECB mode is insecure - use GCM or CBC with random IV
    languages: [python]
    severity: ERROR

  - id: py-weak-rsa-key
    pattern: 'RSA.generate(1024)'
    message: RSA key size too small - use at least 2048 bits
    languages: [python]
    severity: ERROR

  - id: py-weak-rsa-key-512
    pattern: 'RSA.generate(512)'
    message: RSA key size too small - use at least 2048 bits
    languages: [python]
    severity: ERROR

  - id: py-static-iv
    patterns:
      - pattern: 'AES.new($KEY, $MODE, iv=b"...")'
      - pattern: "AES.new($KEY, $MODE, iv=b'...')"
    message: Static IV in encryption - IV should be random for each encryption
    languages: [python]
    severity: ERROR

  - id: py-fernet-hardcoded-key
    pattern: 'Fernet(b"...")'
    message: Hardcoded Fernet key - use environment variable
    languages: [python]
    severity: ERROR

  - id: py-aes-hardcoded-key
    patterns:
      - pattern: 'AES.new(b"...", ...)'
      - pattern: "AES.new(b'...', ...)"
    message: Hardcoded AES encryption key - use environment variable or key derivation (CWE-321)
    languages: [python]
    severity: ERROR

  - id: py-aes-hardcoded-key-var
    pattern: |
      $KEY = b"..."
      ...
      AES.new($KEY, ...)
    message: Hardcoded AES key in variable - encryption keys should be derived from secure sources (CWE-321)
    languages: [python]
    severity: ERROR

  - id: py-cipher-hardcoded-key
    pattern: |
      $KEY = b"..."
      ...
      $CIPHER.new($KEY, ...)
    message: Hardcoded encryption key detected - use key derivation or secure key management (CWE-321)
    languages: [python]
    severity: ERROR

  - id: py-crypto-key-literal
    pattern-regex: "key\\s*=\\s*b['\"][^'\"]{8,}['\"]"
    message: Hardcoded cryptographic key - use environment variables or key derivation (CWE-321)
    languages: [python]
    severity: ERROR

  - id: py-crypto-no-kdf
    pattern: 'AES.new($KEY, $MODE)'
    message: AES cipher without key derivation function - consider using PBKDF2 or scrypt for key derivation
    languages: [python]
    severity: INFO

  # ============================================
  # TLS/SSL Issues
  # ============================================

  - id: py-ssl-unverified
    pattern: 'ssl._create_unverified_context()'
    message: SSL certificate verification disabled - MITM attack risk
    languages: [python]
    severity: ERROR

  - id: py-requests-verify-false
    pattern: 'requests.get($URL, verify=False)'
    message: SSL verification disabled in requests - MITM attack risk
    languages: [python]
    severity: ERROR

  - id: py-requests-post-verify-false
    pattern: 'requests.post($URL, verify=False)'
    message: SSL verification disabled in requests - MITM attack risk
    languages: [python]
    severity: ERROR

  # ============================================
  # JWT Security
  # ============================================

  - id: py-jwt-none-algorithm
    pattern: '"alg":"none"'
    message: JWT none algorithm - authentication bypass vulnerability
    languages: [python]
    severity: ERROR

  - id: py-jwt-decode-no-verify
    pattern: 'jwt.decode($TOKEN, verify=False)'
    message: JWT verification disabled - authentication bypass
    languages: [python]
    severity: ERROR

  - id: py-jwt-decode-options-no-verify
    pattern: 'jwt.decode($TOKEN, options={"verify_signature": False})'
    message: JWT signature verification disabled
    languages: [python]
    severity: ERROR

  # ============================================
  # SSRF (Server-Side Request Forgery)
  # ============================================

  - id: py-requests-user-url
    pattern: requests.get($USER_INPUT)
    message: HTTP request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  - id: py-urllib-user-url
    pattern: urllib.request.urlopen($USER_INPUT)
    message: URL open with user input - potential SSRF
    languages: [python]
    severity: WARNING

  # ============================================
  # XXE (XML External Entity)
  # ============================================

  - id: py-xml-etree-parse
    pattern: ET.parse($INPUT)
    message: XML parsing - ensure external entities are disabled
    languages: [python]
    severity: WARNING

  - id: py-xml-etree-fromstring
    pattern: ET.fromstring($INPUT)
    message: XML parsing - ensure external entities are disabled
    languages: [python]
    severity: WARNING

  - id: py-lxml-parse
    pattern: lxml.etree.parse($INPUT)
    message: lxml XML parsing - disable external entities
    languages: [python]
    severity: WARNING

  # ============================================
  # Django Specific
  # ============================================

  - id: py-django-mark-safe
    pattern: mark_safe($INPUT)
    message: Django mark_safe() - XSS risk if input is user-controlled
    languages: [python]
    severity: WARNING

  - id: py-django-raw-sql
    pattern: $MODEL.objects.raw($QUERY)
    message: Django raw SQL - ensure parameterized queries
    languages: [python]
    severity: WARNING

  - id: py-django-extra
    pattern: $QUERYSET.extra($KWARGS)
    message: Django QuerySet.extra() is deprecated - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-django-debug-true
    pattern: 'DEBUG = True'
    message: Django DEBUG enabled - disable in production
    languages: [python]
    severity: WARNING

  # ============================================
  # Flask Specific
  # ============================================

  - id: py-flask-debug-true
    pattern: 'app.run(debug=True)'
    message: Flask debug mode enabled - disable in production
    languages: [python]
    severity: WARNING


  # Flask debug=True with additional arguments (host, port, etc)
  - id: py-flask-debug-run-args
    pattern-regex: '\.run\s*\([^)]*debug\s*=\s*True'
    message: "Flask/Connexion app running with debug=True - critical security issue in production (CWE-489)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-489"
      tags: [flask, debug, production]
  - id: py-flask-secret-key-hardcoded
    pattern: 'app.secret_key = "..."'
    message: Hardcoded Flask secret key - use environment variables
    languages: [python]
    severity: ERROR

  # ============================================
  # Hardcoded Credentials
  # ============================================

  - id: py-hardcoded-password
    pattern: 'password = "..."'
    message: Hardcoded password detected
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-api-key
    pattern: 'api_key = "..."'
    message: Hardcoded API key detected
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-secret
    pattern: 'secret = "..."'
    message: Hardcoded secret detected
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-secret-uppercase
    patterns:
      - pattern: 'SECRET = "..."'
      - pattern: 'SECRET_KEY = "..."'
      - pattern: 'API_SECRET = "..."'
      - pattern: 'APP_SECRET = "..."'
    message: Hardcoded secret detected - use environment variables
    languages: [python]
    severity: ERROR

  - id: py-hardcoded-token
    patterns:
      - pattern: 'TOKEN = "..."'
      - pattern: 'token = "..."'
      - pattern: 'API_TOKEN = "..."'
      - pattern: 'ACCESS_TOKEN = "..."'
      - pattern: 'AUTH_TOKEN = "..."'
    message: Hardcoded token detected - use environment variables
    languages: [python]
    severity: ERROR

  - id: py-secret-in-variable-name-regex
    pattern-regex: "(?i)(SECRET|TOKEN|PASSWORD|CREDENTIAL|API_KEY)\\s*=\\s*[\"'][^\"']{4,}[\"']"
    message: Potential hardcoded secret in variable assignment - use environment variables
    languages: [python]
    severity: WARNING

  # ============================================
  # Debug/Info Disclosure
  # ============================================

  - id: py-print-statement
    pattern: print(...)
    message: Print statement found - consider using logging
    languages: [python]
    severity: INFO

  - id: py-traceback-print
    pattern: traceback.print_exc()
    message: Traceback printed - may expose sensitive information
    languages: [python]
    severity: INFO

  # ============================================
  # FastAPI / Starlette Security
  # ============================================

  - id: py-fastapi-cors-wildcard
    pattern: 'CORSMiddleware($APP, allow_origins=["*"])'
    message: FastAPI CORS allows all origins - restrict in production
    languages: [python]
    severity: WARNING

  - id: py-fastapi-cors-credentials-wildcard
    pattern: 'CORSMiddleware($APP, allow_origins=["*"], allow_credentials=True)'
    message: FastAPI CORS wildcard with credentials - security risk
    languages: [python]
    severity: ERROR

  - id: py-starlette-session-hardcoded
    pattern: 'SessionMiddleware($APP, secret_key="...")'
    message: Hardcoded session secret - use environment variable
    languages: [python]
    severity: ERROR

  - id: py-fastapi-debug-mode
    patterns:
      - pattern: 'uvicorn.run(..., debug=True, ...)'
      - pattern: 'uvicorn.run(..., reload=True, ...)'
      - pattern: 'app.run(debug=True)'
    message: FastAPI/Uvicorn debug/reload enabled - disable in production
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-489"
      tags: [fastapi, debug]

  - id: py-fastapi-debug-variable
    pattern-regex: "debug\\s*=\\s*(True|config\\.DEBUG|settings\\.DEBUG)"
    message: Debug mode may be enabled - ensure disabled in production
    languages: [python]
    severity: INFO
    metadata:
      tags: [fastapi, debug]

  - id: py-fastapi-no-auth-endpoint
    patterns:
      - pattern: |
          @app.get($PATH)
          def $FUNC():
              ...
              return $DB.query($MODEL).all()
      - pattern: |
          @app.get($PATH)
          async def $FUNC():
              ...
              return $DB.query($MODEL).all()
    message: FastAPI endpoint returns all records - ensure authentication is required
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-862"
      tags: [fastapi, auth]

  - id: py-fastapi-response-model-expose
    pattern: '@app.$METHOD($PATH, response_model=list[$MODEL])'
    message: FastAPI returns list of models - ensure sensitive fields are excluded
    languages: [python]
    severity: INFO
    metadata:
      tags: [fastapi, data-exposure]

  # ============================================
  # Server-Side Template Injection (SSTI)
  # ============================================

  - id: py-jinja2-autoescape-false
    pattern: 'Environment(autoescape=False)'
    message: Jinja2 autoescape disabled - XSS vulnerability
    languages: [python]
    severity: ERROR

  # Generic autoescape=False detection (aiohttp_jinja2.setup, Flask, etc.)
  - id: py-autoescape-disabled
    pattern-regex: 'autoescape\s*=\s*False'
    message: "Template autoescape disabled - XSS vulnerability (CWE-79)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021 Injection"
      tags: [xss, template, autoescape]

  - id: py-jinja2-from-string
    pattern: 'Template($USER_INPUT).render(...)'
    message: Jinja2 template from user input - SSTI vulnerability
    languages: [python]
    severity: ERROR

  - id: py-mako-template-user
    pattern: 'MakoTemplate($USER_INPUT).render(...)'
    message: Mako template from user input - SSTI vulnerability
    languages: [python]
    severity: ERROR

  - id: py-flask-render-template-string
    pattern: render_template_string($INPUT)
    message: Flask render_template_string - SSTI risk with user input
    languages: [python]
    severity: WARNING

  # ============================================
  # Additional ORM/Database Patterns
  # ============================================

  - id: py-sqlalchemy-execute-text
    pattern: '$CONN.execute(text($QUERY))'
    message: SQLAlchemy execute with text - ensure parameterized
    languages: [python]
    severity: WARNING

  - id: py-django-cursor-execute
    pattern: 'cursor.execute($QUERY.format(...))'
    message: Django raw SQL with format - SQL injection risk
    languages: [python]
    severity: ERROR

  - id: py-django-connection-cursor
    pattern: 'connection.cursor().execute($Q % $V)'
    message: Django raw SQL with string formatting - SQL injection
    languages: [python]
    severity: ERROR

  - id: py-peewee-raw
    pattern: '$MODEL.raw($QUERY)'
    message: Peewee raw SQL - ensure parameterized
    languages: [python]
    severity: WARNING

  - id: py-tortoise-raw
    pattern: '$CONN.execute_query($QUERY)'
    message: Tortoise ORM raw query - ensure parameterized
    languages: [python]
    severity: WARNING

  # ============================================
  # Additional SSRF Patterns
  # ============================================

  - id: py-httpx-user-url
    pattern: httpx.get($USER_INPUT)
    message: httpx request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  - id: py-aiohttp-user-url
    patterns:
      - pattern: 'await $SESSION.get(request.$ATTR)'
      - pattern: 'await $SESSION.post(request.$ATTR, ...)'
      - pattern: 'await $SESSION.request($METHOD, request.$ATTR)'
    message: aiohttp request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  - id: py-urllib3-user-url
    pattern: 'urllib3.request("GET", $USER_INPUT)'
    message: urllib3 request with user input - potential SSRF
    languages: [python]
    severity: WARNING

  # ============================================
  # Mass Assignment / Object Injection
  # ============================================

  - id: py-django-model-from-dict
    pattern: '$MODEL(**request.POST)'
    message: Django model from POST data - mass assignment risk
    languages: [python]
    severity: ERROR

  - id: py-django-form-unvalidated
    pattern: '$MODEL(**request.data)'
    message: Model from request data - ensure validation
    languages: [python]
    severity: WARNING

  - id: py-setattr-user-input
    pattern: setattr($OBJ, $USER_INPUT, $VALUE)
    message: setattr with user input - attribute injection risk
    languages: [python]
    severity: ERROR

  # ============================================
  # Information Disclosure
  # ============================================

  - id: py-exception-details
    pattern: 'return {"error": str($EXCEPTION)}'
    message: Exception details in response - may leak sensitive info
    languages: [python]
    severity: WARNING

  - id: py-flask-exception-response
    pattern: 'return str(e), 500'
    message: Exception details returned - may leak sensitive info
    languages: [python]
    severity: WARNING

  # ============================================
  # Async Security Issues
  # ============================================

  - id: py-asyncio-subprocess-shell
    pattern: 'asyncio.create_subprocess_shell(...)'
    message: Async subprocess with shell - command injection risk
    languages: [python]
    severity: ERROR

  - id: py-asyncio-run-in-executor-os
    pattern: 'loop.run_in_executor($EX, os.system, $CMD)'
    message: os.system in executor - command injection risk
    languages: [python]
    severity: ERROR

  # ============================================
  # OWASP API Security Top 10
  # ============================================

  # API1: Broken Object Level Authorization (BOLA/IDOR)
  - id: py-flask-idor-param
    patterns:
      - pattern: '$MODEL.query.get(request.args.get($ID))'
      - pattern: '$MODEL.query.get(request.form.get($ID))'
      - pattern: '$MODEL.query.filter_by(id=request.args[$ID])'
      - pattern: 'db.session.query($MODEL).get($ID)'
    message: Direct object access via user input - verify authorization
    languages: [python]
    severity: WARNING

  - id: py-sqlalchemy-idor
    patterns:
      - pattern: '$SESSION.query($MODEL).filter($MODEL.id == $USER_INPUT)'
      - pattern: '$MODEL.query.filter_by(id=$USER_INPUT).first()'
    message: Object lookup by user-supplied ID - ensure authorization check
    languages: [python]
    severity: WARNING

  # API2: Broken Authentication
  - id: py-flask-no-auth-decorator
    pattern: |
      @app.route($PATH)
      def $FUNC(...):
        ...
        return $DATA
    message: Flask route without authentication decorator - verify auth is enforced
    languages: [python]
    severity: INFO

  - id: py-jwt-weak-secret
    patterns:
      - pattern: 'jwt.encode($PAYLOAD, "...")'
      - pattern: "jwt.encode($PAYLOAD, '...')"
    message: Hardcoded JWT secret - use environment variable
    languages: [python]
    severity: ERROR

  - id: py-flask-login-no-fresh
    pattern: '@login_required'
    message: Using login_required - consider fresh_login_required for sensitive actions
    languages: [python]
    severity: INFO

  # API3: Broken Object Property Level Authorization
  - id: py-flask-mass-assignment
    patterns:
      - pattern: '$MODEL(**request.json)'
      - pattern: '$MODEL(**request.get_json())'
      - pattern: '$MODEL(**request.form.to_dict())'
    message: Mass assignment from request data - whitelist allowed fields
    languages: [python]
    severity: ERROR

  - id: py-sqlalchemy-update-dict
    patterns:
      - pattern: '$OBJ.update(request.json)'
      - pattern: '$OBJ.update(request.get_json())'
    message: Updating object with unvalidated request data - mass assignment risk
    languages: [python]
    severity: ERROR

  - id: py-flask-restful-mass-assign
    pattern: '$MODEL.query.filter_by($FILTER).update(request.json)'
    message: Bulk update with request data - mass assignment vulnerability
    languages: [python]
    severity: ERROR

  # API4: Unrestricted Resource Consumption
  - id: py-flask-no-rate-limit
    pattern: '@app.route($PATH, methods=["POST"])'
    message: POST endpoint - consider adding rate limiting
    languages: [python]
    severity: INFO

  - id: py-file-upload-no-size-limit
    patterns:
      - pattern: 'request.files[$FILE]'
      - pattern: 'request.files.get($FILE)'
    message: File upload - ensure MAX_CONTENT_LENGTH is configured
    languages: [python]
    severity: WARNING

  # API5: Broken Function Level Authorization
  - id: py-flask-admin-route
    pattern-regex: "@app\\.route\\(['\"].*admin.*['\"]"
    message: Admin route detected - ensure proper authorization
    languages: [python]
    severity: WARNING

  - id: py-role-check-user-input
    pattern-regex: 'request\.(json|args|form)\.get\(["\''](role|is_admin|admin)["\'']\)'
    message: Admin check from user input - authorization bypass risk
    languages: [python]
    severity: ERROR

  # API6: Unrestricted Access to Sensitive Business Flows
  - id: py-flask-no-csrf
    pattern: 'WTF_CSRF_ENABLED = False'
    message: CSRF protection disabled - enable for production
    languages: [python]
    severity: ERROR

  # API7: Server Side Request Forgery (SSRF) - Enhanced
  - id: py-ssrf-requests-json
    patterns:
      - pattern: 'requests.get(request.json.get($URL))'
      - pattern: 'requests.get(request.json[$URL])'
      - pattern: 'requests.post(request.json.get($URL), ...)'
    message: HTTP request with URL from JSON body - SSRF vulnerability
    languages: [python]
    severity: ERROR

  - id: py-ssrf-aiohttp-session
    patterns:
      - pattern: 'await session.get(request.json[$URL])'
      - pattern: 'await session.post(request.json[$URL], ...)'
    message: aiohttp request with user-controlled URL - SSRF vulnerability
    languages: [python]
    severity: ERROR

  - id: py-ssrf-httpx
    patterns:
      - pattern: 'await client.get(request.json[$URL])'
      - pattern: 'httpx.get(request.json[$URL])'
    message: httpx request with user-controlled URL - SSRF vulnerability
    languages: [python]
    severity: ERROR

  # API8: Security Misconfiguration
  - id: py-flask-secret-key-default
    pattern: "app.secret_key = 'dev'"
    message: Flask using default/dev secret key - use strong random key
    languages: [python]
    severity: ERROR

  - id: py-flask-cors-all-origins
    pattern: 'CORS(app, origins="*")'
    message: Flask CORS allows all origins - restrict in production
    languages: [python]
    severity: WARNING

  - id: py-flask-cors-credentials-wildcard
    pattern: 'CORS(app, origins="*", supports_credentials=True)'
    message: CORS wildcard with credentials - security misconfiguration
    languages: [python]
    severity: ERROR

  - id: py-debug-endpoint
    pattern-regex: "@app\\.route\\(['\"].*(debug|test|dev).*['\"]"
    message: Debug/test endpoint detected - remove in production
    languages: [python]
    severity: WARNING

  # API9: Improper Inventory Management
  - id: py-deprecated-endpoint
    pattern-regex: "@app\\.route\\(['\"].*v1.*['\"]"
    message: Version 1 API endpoint - ensure deprecated versions are removed
    languages: [python]
    severity: INFO

  # API10: Unsafe Consumption of APIs
  - id: py-external-api-no-validation
    patterns:
      - pattern: 'response.json()'
      - pattern: 'await response.json()'
    message: External API response - validate data before processing
    languages: [python]
    severity: INFO

  # ============================================
  # Flask-SQLAlchemy SQL Injection
  # ============================================

  - id: py-sqlalchemy-raw-sql
    patterns:
      - pattern: 'db.engine.execute($QUERY)'
      - pattern: 'db.session.execute($QUERY)'
      - pattern: 'engine.execute($QUERY)'
    message: Raw SQL execution - use parameterized queries
    languages: [python]
    severity: WARNING

  - id: py-sqlalchemy-text-format
    patterns:
      - pattern: 'text(f"...")'
      - pattern: 'text($Q % $V)'
      - pattern: 'text($Q + $V)'
      - pattern: 'text($Q.format(...))'
    message: SQLAlchemy text with string interpolation - SQL injection
    languages: [python]
    severity: ERROR

  - id: py-sqlalchemy-from-statement
    pattern: '$MODEL.query.from_statement(text($QUERY))'
    message: from_statement with text - ensure parameterized
    languages: [python]
    severity: WARNING

  - id: py-filter-by-user-input
    pattern: '$MODEL.query.filter_by(**request.args)'
    message: filter_by with request args - NoSQL-style injection risk
    languages: [python]
    severity: ERROR

  # ============================================
  # Flask Authentication Issues
  # ============================================

  - id: py-flask-password-compare
    pattern-regex: 'if\s+(password\s*==\s*user\.password|user\.password\s*==\s*password)'
    message: Direct password comparison - use check_password_hash
    languages: [python]
    severity: ERROR

  - id: py-flask-password-plaintext
    patterns:
      - pattern: 'user.password = request.json["password"]'
      - pattern: 'user.password = password'
    message: Storing password without hashing - use generate_password_hash
    languages: [python]
    severity: ERROR

  - id: py-werkzeug-weak-hash
    pattern: 'generate_password_hash($PASS, method="md5")'
    message: MD5 password hashing is weak - use pbkdf2 or scrypt
    languages: [python]
    severity: ERROR

  # ============================================
  # Flask Session Security
  # ============================================

  - id: py-flask-session-permanent
    pattern: 'session.permanent = True'
    message: Permanent session - ensure PERMANENT_SESSION_LIFETIME is set
    languages: [python]
    severity: INFO

  - id: py-flask-session-cookie-insecure
    patterns:
      - pattern: 'SESSION_COOKIE_SECURE = False'
      - pattern: 'SESSION_COOKIE_HTTPONLY = False'
    message: Insecure session cookie configuration
    languages: [python]
    severity: ERROR

  - id: py-flask-session-from-user
    patterns:
      - pattern: 'session[$KEY] = request.json[$VALUE]'
      - pattern: 'session.update(request.json)'
    message: Session data from user input - validate before storing
    languages: [python]
    severity: WARNING

  # ============================================
  # Flask Response Security
  # ============================================

  - id: py-flask-jsonify-sensitive
    patterns:
      - pattern: 'return jsonify(user)'
      - pattern: 'return jsonify({"user": user})'
    message: Returning full user object - exclude sensitive fields
    languages: [python]
    severity: WARNING

  - id: py-flask-password-in-response
    patterns:
      - pattern: 'jsonify({"password": $PASS})'
      - pattern: 'jsonify({..., "password": $PASS, ...})'
    message: Password in API response - remove immediately
    languages: [python]
    severity: ERROR

  - id: py-flask-user-enumeration
    patterns:
      - pattern: 'return {"error": "User not found"}'
      - pattern: 'return jsonify({"error": "Invalid username"})'
      - pattern: 'abort(404, "User does not exist")'
    message: User enumeration via error message - use generic errors
    languages: [python]
    severity: WARNING

  # ============================================
  # Input Validation
  # ============================================

  - id: py-flask-no-input-validation
    pattern: |
      @app.route($PATH, methods=["POST"])
      def $FUNC():
        data = request.json
        ...
    message: POST endpoint - validate input data with schema
    languages: [python]
    severity: INFO

  - id: py-marshmallow-no-strict
    pattern: 'Schema().load(data)'
    message: Marshmallow load without strict - unknown fields accepted
    languages: [python]
    severity: INFO

  - id: py-pydantic-no-validation
    pattern: '$MODEL.parse_obj(request.json)'
    message: Pydantic parsing - handle ValidationError
    languages: [python]
    severity: INFO

  # ============================================
  # Dangerous Operations
  # ============================================

  - id: py-flask-send-file-user
    patterns:
      - pattern: 'send_file(request.args[$FILE])'
      - pattern: 'send_file(request.form[$FILE])'
      - pattern: 'send_from_directory($DIR, request.args[$FILE])'
    message: File send with user input - path traversal risk
    languages: [python]
    severity: ERROR

  - id: py-flask-redirect-open
    patterns:
      - pattern: 'redirect(request.args.get("next"))'
      - pattern: 'redirect(request.args.get("url"))'
      - pattern: 'redirect(request.args.get("redirect"))'
    message: Open redirect - validate redirect URL against whitelist
    languages: [python]
    severity: WARNING

  - id: py-flask-redirect-unvalidated
    patterns:
      - pattern: 'redirect(request.json[$URL])'
      - pattern: 'redirect(request.form[$URL])'
    message: Redirect with user-controlled URL - open redirect vulnerability
    languages: [python]
    severity: ERROR

  # ============================================
  # Logging Security
  # ============================================

  - id: py-logging-password
    patterns:
      - pattern: 'logging.info($MSG, password)'
      - pattern: 'logger.info($MSG, password)'
      - pattern: 'app.logger.info($MSG, password)'
    message: Password logged - remove sensitive data from logs
    languages: [python]
    severity: ERROR

  - id: py-logging-token
    patterns:
      - pattern: 'logging.info($MSG, token)'
      - pattern: 'logger.debug($MSG, $OBJ.token)'
    message: Token logged - remove sensitive data from logs
    languages: [python]
    severity: ERROR

  # ============================================
  # Database Connection Security
  # ============================================

  - id: py-sqlalchemy-uri-password
    pattern-regex: "SQLALCHEMY_DATABASE_URI.*://.*:.*@"
    message: Database credentials in URI - use environment variables
    languages: [python]
    severity: ERROR

  - id: py-mongodb-hardcoded-creds
    pattern-regex: "mongodb://[^:]+:[^@]+@"
    message: MongoDB credentials hardcoded - use environment variables
    languages: [python]
    severity: ERROR

  # ============================================
  # VAmPI-Style Vulnerabilities (Common Flask/API Patterns)
  # ============================================

  # SQL Injection - f-string in SQL query
  - id: py-sqli-fstring-select
    pattern-regex: "f[\"']SELECT.*FROM.*WHERE.*\\{.*\\}"
    message: SQL injection - f-string in SELECT query with user variable
    languages: [python]
    severity: ERROR

  - id: py-sqli-session-execute-text
    patterns:
      - pattern: 'db.session.execute(text(f"..."))'
      - pattern: '$DB.session.execute(text(f"..."))'
    message: SQL injection - f-string in SQLAlchemy text() execution
    languages: [python]
    severity: ERROR

  - id: py-sqli-execute-fstring
    patterns:
      - pattern: '$CONN.execute(f"...")'
      - pattern: 'cursor.execute(f"...")'
    message: SQL injection - f-string in SQL execute
    languages: [python]
    severity: ERROR

  # IDOR/BOLA - Object access by URL parameter
  - id: py-idor-url-param-lookup
    patterns:
      - pattern: '$MODEL.query.filter_by(username=username).first()'
      - pattern: '$MODEL.query.filter_by($FIELD=$PARAM).first()'
    message: Object lookup by URL/function parameter - verify authorization
    languages: [python]
    severity: WARNING

  - id: py-idor-no-auth-update
    patterns:
      - pattern: |
          user = $MODEL.query.filter_by(username=username).first()
          ...
          user.$FIELD = $VALUE
      - pattern: |
          $OBJ = $MODEL.query.filter_by($FIELD=$PARAM).first()
          ...
          $OBJ.$ATTR = $VALUE
    message: Object update without checking current user owns object - IDOR risk
    languages: [python]
    severity: WARNING

  # Mass Assignment - Admin privilege escalation
  - id: py-mass-assignment-admin
    pattern-regex: 'if\s+(request_data|data|\w+_data)\s*(\[|\.get\()["\''"]admin["\''"]\]?\)?'
    message: Admin flag from user input - mass assignment privilege escalation
    languages: [python]
    severity: ERROR

  - id: py-mass-assignment-role
    patterns:
      - pattern: '$USER.admin = $DATA["admin"]'
      - pattern: '$USER.role = request.json["role"]'
      - pattern: '$USER.is_admin = $DATA.get("is_admin")'
    message: User role/admin from request data - privilege escalation risk
    languages: [python]
    severity: ERROR

  # User Enumeration - Different error messages
  - id: py-user-enum-username
    patterns:
      - pattern: 'return "Username does not exist"'
      - pattern: 'return {"status": "fail", "message": "Username does not exist"}'
      - pattern: '"Username does not exist"'
    message: User enumeration - reveals if username exists
    languages: [python]
    severity: WARNING

  - id: py-user-enum-password
    patterns:
      - pattern: 'return "Password is not correct"'
      - pattern: '"Password is not correct"'
      - pattern: 'return {"status": "fail", "message": "Password is not correct..."}'
    message: User enumeration - password error reveals username exists
    languages: [python]
    severity: WARNING

  - id: py-user-enum-separate-errors
    pattern-regex: '(if|elif)\s+not\s+user\s*:\s*return\s+'
    message: Separate user/password errors enable enumeration - use generic message
    languages: [python]
    severity: WARNING

  # ReDoS - Dangerous regex patterns
  - id: py-redos-nested-quantifier
    pattern-regex: "re\\.search\\([rf]?[\"'][^\"']*\\([^)]+\\)\\*[^\"']*[\"']"
    message: ReDoS - nested quantifiers in regex can cause catastrophic backtracking
    languages: [python]
    severity: WARNING

  - id: py-redos-pattern
    pattern-regex: "re\\.(search|match|findall)\\([rf]?[\"'][^\"']*\\+\\*[^\"']*[\"']"
    message: ReDoS - greedy quantifiers may cause excessive backtracking
    languages: [python]
    severity: WARNING

  # ReDoS - Nested group with quantifier like ([a-z]+)+ or (\w+)+
  - id: py-redos-nested-group-plus
    pattern-regex: "re\\.(search|match|findall)\\([rf]?[\"'][^\"']*\\([^)]+\\+\\)\\+[^\"']*[\"']"
    message: ReDoS - nested quantifier pattern (group+)+ causes catastrophic backtracking
    languages: [python]
    severity: ERROR

  # ReDoS - Email validation with nested quantifiers (VAmPI pattern)
  - id: py-redos-email-validation
    patterns:
      - pattern: 're.search($PATTERN, $EMAIL)'
      - pattern: 're.match($PATTERN, $EMAIL)'
    message: Email regex validation - check for ReDoS vulnerable patterns like (a+)+
    languages: [python]
    severity: INFO

  # Debug/Info Disclosure - Exposing sensitive data
  - id: py-debug-password-response
    patterns:
      - pattern: '"password": user.password'
      - pattern: '"password": $USER.password'
      - pattern: "'password': user.password"
    message: Password exposed in API response - remove immediately
    languages: [python]
    severity: ERROR

  - id: py-debug-json-all-fields
    patterns:
      - pattern: 'return user.json_debug()'
      - pattern: 'return $OBJ.json_debug()'
      - pattern: 'jsonify($MODEL.json_debug())'
    message: Debug JSON method in response - may expose sensitive fields
    languages: [python]
    severity: WARNING

  - id: py-debug-get-all-users
    patterns:
      - pattern: 'return User.get_all_users()'
      - pattern: 'return $MODEL.get_all_users()'
      - pattern: '$MODEL.query.all()'
    message: Returning all users - ensure authorization and field filtering
    languages: [python]
    severity: WARNING

  # Weak Authentication - Plaintext password comparison
  - id: py-plaintext-password-check
    patterns:
      - pattern: 'request_data.get("password") != user.password'
      - pattern: '$DATA["password"] != $USER.password'
      - pattern: 'password != user.password'
    message: Plaintext password comparison - use password hashing
    languages: [python]
    severity: ERROR

  - id: py-plaintext-password-store
    patterns:
      - pattern: 'user.password = request_data.get("password")'
      - pattern: '$USER.password = $DATA["password"]'
      - pattern: 'self.password = password'
    message: Storing plaintext password - use generate_password_hash
    languages: [python]
    severity: ERROR

  # Broken Object Level Authorization (BOLA) - No ownership check
  - id: py-bola-update-any-user
    patterns:
      - pattern: |
          user = User.query.filter_by(username=username).first()
          user.password = $NEW_PASS
      - pattern: |
          $OBJ = $MODEL.query.filter_by($FIELD=$PARAM).first()
          ...
          db.session.commit()
    message: BOLA - updating object by URL param without ownership verification
    languages: [python]
    severity: ERROR

  - id: py-bola-delete-any
    patterns:
      - pattern: |
          $OBJ = $MODEL.query.filter_by($FIELD=$PARAM).first()
          db.session.delete($OBJ)
    message: BOLA - deleting object by URL param without ownership check
    languages: [python]
    severity: ERROR

  # Excessive Data Exposure
  - id: py-excessive-data-all-fields
    patterns:
      - pattern: 'return jsonify([u.__dict__ for u in $USERS])'
      - pattern: 'return jsonify([$U.to_dict() for $U in $USERS])'
    message: Excessive data exposure - filter fields in response
    languages: [python]
    severity: WARNING

  - id: py-excessive-data-model-dump
    patterns:
      - pattern: 'return jsonify($MODEL.__dict__)'
      - pattern: 'return jsonify(vars($MODEL))'
    message: Model __dict__ in response - exposes all fields including sensitive
    languages: [python]
    severity: WARNING

  # Broken Authentication - Weak JWT
  - id: py-jwt-hardcoded-secret
    patterns:
      - pattern: 'SECRET_KEY = "..."'
      - pattern: "SECRET_KEY = '...'"
      - pattern: 'jwt.encode($P, "...", ...)'
    message: Hardcoded JWT secret - use environment variable
    languages: [python]
    severity: ERROR

  - id: py-jwt-no-expiry
    pattern: 'jwt.encode($PAYLOAD, $SECRET)'
    message: JWT without expiration - add exp claim
    languages: [python]
    severity: WARNING

  # Missing Rate Limiting
  - id: py-no-rate-limit-login
    pattern-regex: "@app\\.route\\(['\"].*login.*['\"]"
    message: Login endpoint - add rate limiting to prevent brute force
    languages: [python]
    severity: WARNING

  - id: py-no-rate-limit-register
    pattern-regex: "@app\\.route\\(['\"].*register.*['\"]"
    message: Registration endpoint - add rate limiting to prevent abuse
    languages: [python]
    severity: INFO

  # SQLAlchemy f-string injection (VAmPI specific)
  - id: py-sqli-vampi-style
    pattern: |
      $QUERY = f"SELECT * FROM $TABLE WHERE $FIELD = '{$VAR}'"
    message: SQL injection - user input in f-string query
    languages: [python]
    severity: ERROR

  - id: py-sqli-text-fstring
    pattern: 'text(f"...")'
    message: SQL injection - f-string in SQLAlchemy text()
    languages: [python]
    severity: ERROR

  # Broad Exception Handling
  - id: py-bare-except
    pattern: |
      try:
        ...
      except:
        ...
    message: Bare except clause - catch specific exceptions
    languages: [python]
    severity: INFO

  - id: py-except-pass
    pattern: |
      except:
        pass
    message: Silent exception swallowing - log or handle errors
    languages: [python]
    severity: WARNING

  # ============================================
  # VAmPI-Specific Exact Patterns
  # ============================================

  # SQL Injection - f-string with variable in WHERE clause (VAmPI pattern)
  - id: py-vampi-sqli-fstring
    pattern-regex: "user_query\\s*=\\s*f[\"']SELECT.*FROM.*WHERE.*\\{.*\\}"
    message: SQL injection - f-string with user input in WHERE clause
    languages: [python]
    severity: ERROR

  - id: py-vampi-sqli-text-execute
    pattern: 'db.session.execute(text($QUERY))'
    message: SQL injection - executing text query (check for f-string interpolation)
    languages: [python]
    severity: WARNING

  # Mass Assignment - admin flag from request data (VAmPI pattern)
  - id: py-vampi-mass-assign-admin-check
    pattern-regex: "if.*'admin'\\s+in\\s+request_data"
    message: Mass assignment - checking for admin flag in user input allows privilege escalation
    languages: [python]
    severity: ERROR

  - id: py-vampi-mass-assign-admin-value
    pattern-regex: "if\\s+request_data\\['admin'\\]"
    message: Mass assignment - admin flag from user input allows privilege escalation
    languages: [python]
    severity: ERROR

  - id: py-vampi-admin-from-request
    pattern: 'admin = $DATA[$KEY]'
    message: Admin flag from user request - mass assignment privilege escalation
    languages: [python]
    severity: ERROR

  # User Enumeration - specific error messages (VAmPI pattern)
  - id: py-vampi-user-enum-password-error
    pattern-regex: '"Password is not correct'
    message: User enumeration - password error message reveals username exists
    languages: [python]
    severity: WARNING

  - id: py-vampi-user-enum-username-error
    pattern-regex: '"Username does not exist'
    message: User enumeration - error message reveals username does not exist
    languages: [python]
    severity: WARNING

  # ReDoS - Complex regex with nested quantifiers (VAmPI pattern)
  - id: py-vampi-redos-email
    pattern-regex: "re\\.search\\([rf]?[\"'][^\"']*\\[-\\.\\\\w\\]\\*[^\"']*\\)"
    message: ReDoS - complex regex with nested quantifiers can cause catastrophic backtracking
    languages: [python]
    severity: WARNING

  - id: py-redos-email-validator
    pattern-regex: "re\\.(search|match)\\([^,]+,\\s*str\\(request"
    message: ReDoS - regex on user input may be vulnerable to ReDoS attack
    languages: [python]
    severity: WARNING

  # Weak JWT Secret - hardcoded in config (VAmPI pattern)
  - id: py-vampi-weak-jwt-secret
    pattern-regex: "config\\['SECRET_KEY'\\]\\s*=\\s*['\"]\\w+['\"]"
    message: Weak JWT secret - hardcoded short/predictable secret enables token forgery
    languages: [python]
    severity: ERROR

  - id: py-flask-config-secret-key
    pattern: "$APP.config['SECRET_KEY'] = '...'"
    message: Hardcoded Flask SECRET_KEY - use environment variable
    languages: [python]
    severity: ERROR

  # Debug Endpoint - exposing all user data (VAmPI pattern)
  - id: py-vampi-debug-endpoint
    pattern-regex: "def\\s+debug\\(\\):"
    message: Debug function exposed - may leak sensitive data
    languages: [python]
    severity: WARNING

  - id: py-vampi-debug-all-users
    pattern: 'User.get_all_users_debug()'
    message: Debug endpoint exposing all users with sensitive fields
    languages: [python]
    severity: ERROR

  - id: py-debug-method-call
    pattern-regex: '\w+\.get_all_\w+_debug\s*\(\)'
    message: Debug method exposing sensitive data - remove in production
    languages: [python]
    severity: ERROR

  - id: py-json-debug-method
    pattern: 'return $OBJ.json_debug()'
    message: Debug JSON method exposes sensitive fields like passwords
    languages: [python]
    severity: ERROR

  # BOLA - Object access by URL parameter without auth check (VAmPI pattern)
  - id: py-vampi-bola-password-update
    pattern: |
      user = User.query.filter_by(username=username).first()
      ...
      user.password = $VALUE
    message: BOLA - updating user password by URL username without ownership check
    languages: [python]
    severity: ERROR

  - id: py-vampi-bola-book-access
    pattern: 'Book.query.filter_by(book_title=$TITLE).first()'
    message: BOLA - accessing book by title without owner verification
    languages: [python]
    severity: WARNING

  - id: py-bola-query-url-param
    pattern: '$MODEL.query.filter_by($FIELD=$URL_PARAM).first()'
    message: BOLA - object lookup by URL parameter without authorization check
    languages: [python]
    severity: WARNING

  # Plaintext Password Comparison (VAmPI pattern)
  - id: py-vampi-plaintext-password
    pattern: "request_data.get('password') == user.password"
    message: Plaintext password comparison - passwords should be hashed
    languages: [python]
    severity: ERROR

  - id: py-vampi-plaintext-password-ne
    pattern: "request_data.get('password') != user.password"
    message: Plaintext password comparison - passwords should be hashed
    languages: [python]
    severity: ERROR

  - id: py-direct-password-equality
    pattern: '$USER_INPUT == $USER.password'
    message: Direct password comparison - use check_password_hash
    languages: [python]
    severity: ERROR

  # Flask Debug Mode (VAmPI has debug=True)
  - id: py-vampi-flask-debug
    pattern: 'vuln_app.run(host=$HOST, port=$PORT, debug=True)'
    message: Flask running with debug=True - disable in production
    languages: [python]
    severity: WARNING

  # Password stored in User model without hashing
  - id: py-model-password-plaintext
    pattern: 'self.password = password'
    message: Storing password without hashing - use generate_password_hash
    languages: [python]
    severity: ERROR

  # Missing authorization check on sensitive operations
  - id: py-update-without-auth-check
    pattern: |
      user = $MODEL.query.filter_by(username=$PARAM).first()
      user.$FIELD = $VALUE
      db.session.commit()
    message: Database update without authorization check - verify user owns object
    languages: [python]
    severity: ERROR

  # API route returning user debug info
  - id: py-route-returns-debug
    pattern-regex: 'return_value\s*=\s*jsonify\s*\(\s*\{.*\.get_all_\w+_debug\s*\(\)'
    message: API route returning debug data - may expose sensitive fields
    languages: [python]
    severity: ERROR

  # Password in JSON response
  - id: py-password-in-json-response
    pattern-regex: "'password':\\s*\\$?\\w+\\.password"
    message: Password field in response - never expose passwords in API responses
    languages: [python]
    severity: ERROR

  # Random string for secret (VAmPI uses 'random')
  - id: py-weak-secret-string
    pattern-regex: "SECRET_KEY['\"]\\]?\\s*=\\s*['\"]random['\"]"
    message: Weak secret key - use cryptographically secure random value
    languages: [python]
    severity: ERROR

  # JWT encode with config secret
  - id: py-jwt-encode-config-secret
    pattern: 'jwt.encode($PAYLOAD, $CONFIG.get($KEY), algorithm=$ALG)'
    message: JWT encoding - ensure secret key is not weak/hardcoded
    languages: [python]
    severity: INFO

  # ============================================
  # VAmPI: RegexDOS - Denial of Service via Regex
  # ============================================

  # Nested quantifiers in regex - exponential backtracking
  - id: py-redos-nested-quantifiers
    pattern-regex: "re\\.(match|search|findall|fullmatch|sub)\\([^)]*\\([^)]*[+*]\\)[^)]*[+*]"
    message: Regex with nested quantifiers - potential ReDoS vulnerability (exponential backtracking)
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1333"
      tags: [redos, vampi]

  # Evil regex patterns - common ReDoS patterns
  - id: py-redos-evil-pattern
    pattern-regex: "re\\.(compile|match|search)\\(['\"][^'\"]*\\([^)]+\\)\\+\\)[^'\"]*['\"]"
    message: Regex pattern may cause ReDoS - nested quantifiers with backtracking
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1333"
      tags: [redos, vampi]

  # Regex with user input without timeout
  - id: py-regex-user-input
    patterns:
      - pattern: |
          re.match($PATTERN, request.$X)
      - pattern: |
          re.search($PATTERN, request.$X)
      - pattern: |
          re.findall($PATTERN, request.$X)
    message: Regex on user input - consider using timeout to prevent ReDoS
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"
      tags: [redos, vampi]

  # ============================================
  # VAmPI: API Rate Limiting Missing
  # ============================================

  # Flask route without rate limiting
  - id: py-flask-no-rate-limit
    patterns:
      - pattern: |
          @app.route($PATH)
          def $FUNC():
              ...
      - pattern: |
          @app.route($PATH, methods=$METHODS)
          def $FUNC():
              ...
    message: Flask route without rate limiting - add flask-limiter to prevent abuse
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      tags: [rate-limiting, vampi]

  # Login endpoint without rate limiting
  - id: py-login-no-rate-limit
    pattern-regex: "@app\\.route\\(['\"]/(login|auth|signin|authenticate)['\"]"
    message: Authentication endpoint without visible rate limiting - add @limiter.limit() to prevent brute force
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-307"
      tags: [rate-limiting, auth, vampi]

  # Password reset without rate limiting
  - id: py-password-reset-no-rate-limit
    pattern-regex: "@app\\.route\\(['\"]/(reset|forgot|password)[^'\"]*['\"]"
    message: Password reset endpoint - ensure rate limiting is applied
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-307"
      tags: [rate-limiting, auth, vampi]

  # Flask-RESTful without rate limiting
  - id: py-flask-restful-no-rate-limit
    patterns:
      - pattern: |
          class $RESOURCE(Resource):
              def get(self):
                  ...
      - pattern: |
          class $RESOURCE(Resource):
              def post(self):
                  ...
    message: Flask-RESTful resource without rate limiting - add flask-limiter
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      tags: [rate-limiting, vampi]

  # Blueprint route without rate limiting
  - id: py-blueprint-no-rate-limit
    pattern-regex: "@\\w+_bp\\.route\\("
    message: Flask Blueprint route - ensure rate limiting is configured
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      tags: [rate-limiting, vampi]

  # ============================================
  # VAmPI: JWT Weak Key Detection (Additional)
  # ============================================

  # JWT with weak/short secret
  - id: py-jwt-weak-secret
    pattern-regex: "jwt\\.(encode|decode)\\([^)]+,\\s*['\"][^'\"]{1,16}['\"]"
    message: JWT with potentially weak secret (less than 16 chars) - use strong random key
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-327"
      tags: [jwt, vampi]

  # JWT algorithm none attack
  - id: py-jwt-algorithm-none
    patterns:
      - pattern: "jwt.decode($TOKEN, options={'verify_signature': False})"
      - pattern-regex: "algorithm\\s*=\\s*['\"]none['\"]"
    message: JWT signature verification disabled or algorithm=none - authentication bypass risk
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-347"
      tags: [jwt, vampi]

  # ============================================
  # c{api}tal / FastAPI OWASP API Vulnerabilities
  # ============================================

  # Command Injection - subprocess.Popen with shell=True (regex for multiline)
  - id: py-popen-shell-regex
    pattern-regex: 'subprocess\.Popen\s*\([\s\S]*?shell\s*=\s*True'
    message: subprocess.Popen with shell=True - command injection vulnerability
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-78"
      tags: [command-injection, capital]

  # Also catch Popen import usage
  - id: py-popen-direct-shell
    pattern: Popen(..., shell=True, ...)
    message: Popen with shell=True - command injection vulnerability
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-78"
      tags: [command-injection]

  # BOLA - Action before authorization check (c{api}tal pattern)
  # Note: Using regex since semgrep can't use metavariables inside method names
  - id: py-bola-delete-before-check
    pattern-regex: 'await.*\\.delete.*\\(.*\\)\\s*\\n.*if.*!=.*:'
    message: BOLA - delete operation before ownership check allows unauthorized deletion
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-639"
      tags: [bola, idor, capital]

  - id: py-bola-action-then-check
    pattern-regex: "(delete|remove|update).*\\n.*if.*author.*!=.*user"
    message: BOLA - action performed before authorization check
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-639"
      tags: [bola, capital]

  # FastAPI - Authenticated but not authorized endpoint
  - id: py-fastapi-auth-no-role-check
    patterns:
      - pattern: |
          @router.$METHOD($PATH)
          async def $FUNC(..., user: $TYPE = Depends(get_current_user_authorizer()), ...):
              ...
              return $RESPONSE
    message: FastAPI endpoint uses authentication but may lack role/permission check
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-862"
      tags: [fastapi, auth, capital]

  # FastAPI admin endpoint without role verification
  - id: py-fastapi-admin-no-role
    pattern-regex: "@router\\.(get|post|put|delete)\\([\"']/admin"
    message: Admin endpoint detected - verify role-based access control is enforced
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-862"
      tags: [fastapi, admin, capital]

  # Inadequate input validation (allows bypass)
  - id: py-shell-injection-weak-filter
    pattern-regex: "if.*[\"'](rm|cat|ls|whoami|id)[\"'].*in.*cmd"
    message: Weak command filtering - blacklist approach is bypassable
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-78"
      tags: [command-injection, capital]

  # Dangerous shell command patterns
  - id: py-shell-command-concat
    patterns:
      - pattern: 'cmd = $PREFIX + $USER_INPUT'
      - pattern: 'cmd = f"... {$VAR} ..."'
      - pattern: 'cmd = "...".format($VAR)'
    message: Shell command built from user input - command injection risk
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-78"
      tags: [command-injection]

  # Hardcoded test/example credentials
  - id: py-hardcoded-test-card
    pattern-regex: "['\"]4[0-9]{15}['\"]"
    message: Hardcoded credit card number (Visa format) - remove test data
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [pci, credentials, capital]

  - id: py-hardcoded-cvv
    pattern-regex: "['\"]\\d{3}['\"]\\s*#?\\s*(cvv|cvc|security)"
    message: Hardcoded CVV/security code detected
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [pci, credentials]

  # Flag/CTF indicator in code (indicates intentional vulnerability)
  - id: py-ctf-flag-response
    pattern-regex: "(flag|FLAG|Flag)\\s*[:=].*Injection|BOLA|SSRF|SQLi"
    message: CTF flag in response - this indicates an intentional vulnerability for testing
    languages: [python]
    severity: INFO
    metadata:
      tags: [ctf, capital]

  # FastAPI - Excessive data exposure
  # Fixed: Can't use metavariables inside method names, using valid patterns
  - id: py-fastapi-return-all-records
    patterns:
      - pattern: return await $REPO.get_all(...)
      - pattern: return $MODEL.query.all()
      - pattern: return await $FUNC.all()
    message: Returning all records - ensure authorization and pagination
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      tags: [data-exposure, capital]

  # Broken function level authorization
  - id: py-function-auth-bypass
    pattern-regex: "def.*admin.*\\(.*\\).*:\\s*\\n.*return"
    message: Admin function may lack authorization decorator
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-285"
      tags: [auth, capital]

  # ============================================
  # Mass Assignment / API3 Detection
  # ============================================

  # Mass Assignment - Direct attribute assignment from user input
  - id: py-mass-assignment-admin
    pattern-regex: "\\.(admin|is_admin|is_superuser|role|privilege)\\s*=\\s*(True|admin|request\\.|user_in\\.|\\$)"
    message: "Mass Assignment - Admin/privilege field set directly, allowing privilege escalation (OWASP API3)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-915"
      owasp: "API3:2023 Broken Object Property Level Authorization"
      tags: [mass-assignment, privilege-escalation, capital]

  # Mass Assignment - Accepting arbitrary fields from request
  - id: py-mass-assignment-kwargs
    patterns:
      - pattern: $OBJ.update(**$DICT)
      - pattern: $MODEL(**request.json)
      - pattern: $MODEL(**$DATA.dict())
    message: "Mass Assignment - Object updated with unfiltered user input"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment]

  # Mass Assignment - Pydantic model with arbitrary fields
  - id: py-mass-assignment-setattr
    pattern: setattr($OBJ, $KEY, $VALUE)
    message: "Dynamic attribute assignment - potential mass assignment if key is user-controlled"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment]

  # User-controlled field assignment in update operations
  - id: py-user-controlled-field-update
    pattern-regex: "for\\s+\\w+\\s*,\\s*\\w+\\s+in\\s+.*\\.items\\(\\).*:\\s*\\n\\s*setattr\\("
    message: "Iterating over user input to set attributes - mass assignment vulnerability"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment, capital]

  # Direct sensitive field assignment in FastAPI
  - id: py-fastapi-sensitive-field-assign
    pattern-regex: "user_in_db\\.(admin|role|is_admin|privilege|credit_card)\\s*=\\s*(True|admin|\\w+\\.admin)"
    message: "Sensitive field directly assigned without validation - mass assignment risk"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment, fastapi, capital]

  # ============================================
  # API7:2023 - Server-Side Request Forgery (SSRF)
  # ============================================

  # SSRF - requests library with user-controlled URL
  - id: py-ssrf-requests-get
    pattern-regex: "requests\\.(get|post|put|delete|head|patch)\\s*\\([^)]*\\b(url|uri|link|href|src|endpoint|target|redirect|callback|webhook|fetch)\\b"
    message: "Potential SSRF - HTTP request with user-controlled URL parameter (OWASP API7)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "API7:2023 Server-Side Request Forgery"
      tags: [ssrf, api-security]

  # SSRF - urllib with variable URL
  - id: py-ssrf-urllib
    pattern-regex: "urllib\\.(request\\.)?urlopen\\s*\\(\\s*[a-zA-Z_]"
    message: "Potential SSRF - urllib.urlopen with variable URL"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # SSRF - requests.get/post with url= keyword argument and any variable
  - id: py-ssrf-requests-url-kwarg
    pattern-regex: 'requests\.(get|post|put|delete|head|patch)\s*\([^)]*url\s*=\s*[a-zA-Z_][a-zA-Z0-9_]*'
    message: "SSRF - requests with url= keyword argument pointing to variable (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      tags: [ssrf, rfi]

  # SSRF - httpx library
  - id: py-ssrf-httpx
    pattern-regex: "httpx\\.(get|post|put|delete|head|patch|AsyncClient|Client)\\s*\\([^)]*\\b(url|uri|link|href)\\b"
    message: "Potential SSRF - httpx request with user-controlled URL"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # SSRF - aiohttp library
  - id: py-ssrf-aiohttp
    pattern-regex: "aiohttp\\.ClientSession\\(\\)|session\\.(get|post|put|delete)\\s*\\([^)]*\\b(url|uri)\\b"
    message: "Potential SSRF - aiohttp request with user-controlled URL"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # SSRF - Direct URL from request body/query
  - id: py-ssrf-request-url
    pattern-regex: "requests\\.(get|post)\\s*\\(\\s*(request\\.(json|form|args|data)\\[|data\\.)"
    message: "SSRF - HTTP request URL taken directly from user input"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "API7:2023 Server-Side Request Forgery"
      tags: [ssrf, capital]

  # ============================================
  # API4:2023 - Unrestricted Resource Consumption
  # ============================================

  # Missing rate limiting on FastAPI endpoint
  - id: py-fastapi-no-rate-limit
    pattern-regex: "@(app|router)\\.(get|post|put|delete|patch)\\s*\\([^)]*\\)\\s*\\n(async\\s+)?def\\s+\\w+\\s*\\("
    message: "FastAPI endpoint without rate limiting - vulnerable to brute force/DoS (OWASP API4)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      owasp: "API4:2023 Unrestricted Resource Consumption"
      tags: [rate-limiting, dos]

  # Missing rate limiting on Flask endpoint
  - id: py-flask-no-rate-limit
    pattern-regex: "@app\\.route\\s*\\([^)]*\\)\\s*\\ndef\\s+\\w+\\s*\\("
    message: "Flask endpoint without rate limiting decorator - consider adding @limiter.limit()"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      tags: [rate-limiting, dos]

  # Login endpoint without rate limiting (high priority)
  - id: py-login-no-rate-limit
    pattern-regex: "@(app|router)\\.(post|get)\\s*\\(['\"].*/(login|signin|auth|authenticate)['\"]"
    message: "Authentication endpoint may lack rate limiting - critical for brute force protection"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-307"
      owasp: "API4:2023 Unrestricted Resource Consumption"
      tags: [rate-limiting, auth, brute-force]

  # Password reset without rate limiting
  - id: py-password-reset-no-limit
    pattern-regex: "@(app|router)\\.(post|get)\\s*\\(['\"].*/(password|reset|forgot)['\"]"
    message: "Password reset endpoint - ensure rate limiting is applied"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-307"
      tags: [rate-limiting, auth]

  # ============================================
  # API2:2023 - Broken Authentication / JWT Issues
  # ============================================

  # Weak JWT secret
  - id: py-jwt-weak-secret
    pattern-regex: "(jwt\\.encode|jwt\\.decode)\\s*\\([^)]*['\"]?(secret|password|key|123|test|dev)['\"]?"
    message: "JWT using weak/hardcoded secret - use strong random secrets from environment"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      owasp: "API2:2023 Broken Authentication"
      tags: [jwt, auth, secrets]

  # JWT without algorithm verification
  - id: py-jwt-no-algorithm
    pattern-regex: "jwt\\.decode\\s*\\([^)]*algorithms\\s*=\\s*\\[\\s*\\]"
    message: "JWT decode with empty algorithms list - vulnerable to algorithm confusion attacks"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-327"
      tags: [jwt, auth]

  # JWT with none algorithm allowed
  - id: py-jwt-none-algorithm
    pattern-regex: "jwt\\.decode\\s*\\([^)]*['\"]none['\"]"
    message: "JWT allows 'none' algorithm - authentication bypass vulnerability"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-327"
      owasp: "API2:2023 Broken Authentication"
      tags: [jwt, auth, critical]

  # JWT secret from code (not environment)
  - id: py-jwt-hardcoded-secret
    pattern-regex: "SECRET_KEY\\s*=\\s*['\"][^'\"]+['\"]"
    message: "Hardcoded JWT/session secret key - use environment variables"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [jwt, secrets]

  # Missing JWT verification
  - id: py-jwt-no-verify
    pattern-regex: "jwt\\.decode\\s*\\([^)]*verify\\s*=\\s*False"
    message: "JWT signature verification disabled - authentication bypass"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-347"
      owasp: "API2:2023 Broken Authentication"
      tags: [jwt, auth, critical]

  # Password comparison without timing-safe function
  - id: py-password-compare-timing
    pattern-regex: "(password|passwd|pwd)\\s*(==|!=)\\s*(request|data|user)"
    message: "Password comparison may be vulnerable to timing attacks - use secrets.compare_digest()"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-208"
      tags: [auth, timing-attack]

  # ============================================
  # API10:2023 - Unsafe Consumption of APIs
  # ============================================

  # Trusting external API response without validation
  - id: py-unsafe-api-consumption
    pattern-regex: "response\\.json\\(\\)\\s*\\[|json\\.loads\\(response\\.(text|content)\\)"
    message: "External API response used without validation - verify and sanitize third-party data"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-20"
      owasp: "API10:2023 Unsafe Consumption of APIs"
      tags: [api-security, validation]

  # External API call without error handling
  - id: py-api-no-error-handling
    pattern-regex: "requests\\.(get|post)\\([^)]+\\)\\.json\\(\\)"
    message: "External API call without error handling - add try/except and status code checks"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-754"
      tags: [api-security, error-handling]

  # SSL verification disabled for external requests
  - id: py-ssl-verify-disabled
    pattern-regex: "requests\\.(get|post|put|delete)\\s*\\([^)]*verify\\s*=\\s*False"
    message: "SSL verification disabled - vulnerable to MITM attacks on external API calls"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-295"
      tags: [ssl, api-security]

  # ============================================
  # API3:2023 - Excessive Data Exposure
  # ============================================

  # Credit card number in response/model
  - id: py-pii-credit-card-response
    pattern-regex: "(credit_card|card_number|cardnumber|cc_number)\\s*[=:]"
    message: "Credit card field in data model - ensure PCI DSS compliance and mask in API responses (OWASP API3)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-359"
      owasp: "API3:2023 Broken Object Property Level Authorization"
      tags: [pii, pci-dss, data-exposure, capital]

  # Visa card number pattern in code
  - id: py-pii-visa-card-pattern
    pattern-regex: "['\"]4[0-9]{12}(?:[0-9]{3})?['\"]"
    message: "Potential Visa card number detected - PCI DSS violation if real"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-359"
      tags: [pii, pci-dss, capital]

  # Mastercard pattern
  - id: py-pii-mastercard-pattern
    pattern-regex: "['\"]5[1-5][0-9]{14}['\"]"
    message: "Potential Mastercard number detected - PCI DSS violation if real"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-359"
      tags: [pii, pci-dss]

  # SSN in response
  - id: py-pii-ssn-field
    pattern-regex: "(ssn|social_security|socialSecurity)\\s*[=:]"
    message: "SSN field detected - never expose in API responses"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-359"
      owasp: "API3:2023 Broken Object Property Level Authorization"
      tags: [pii, data-exposure]

  # Returning full user object without field filtering
  - id: py-data-exposure-full-object
    patterns:
      - pattern: 'return jsonify(user)'
      - pattern: 'return user.dict()'
      - pattern: 'return $MODEL.to_dict()'
    message: "Returning full object - filter sensitive fields (password, SSN, credit_card) before response"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      owasp: "API3:2023 Broken Object Property Level Authorization"
      tags: [data-exposure]

  # Password hash in response
  - id: py-data-exposure-password-hash
    pattern-regex: "['\"]password[_]?(hash)?['\"]\\s*:"
    message: "Password/hash field in response - never expose password data in API"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-200"
      tags: [data-exposure, auth]

  # Sensitive fields not excluded in Pydantic response model
  - id: py-pydantic-expose-sensitive
    pattern-regex: "class\\s+\\w+(Response|Out|Public).*:\\s*\\n.*\\s+(password|credit_card|ssn|secret)"
    message: "Sensitive field in response model - exclude from public API responses"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-200"
      owasp: "API3:2023 Broken Object Property Level Authorization"
      tags: [pydantic, data-exposure]

  # ============================================
  # API5:2023 - Broken Function Level Authorization (BFLA)
  # ============================================

  # Admin endpoint without role check
  - id: py-bfla-admin-no-role-check
    pattern-regex: "@(router|app)\\.(get|post|put|delete)\\(['\"]/?admin"
    message: "Admin endpoint - verify role-based access control (is_admin/is_superuser check) is enforced (OWASP API5)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-285"
      owasp: "API5:2023 Broken Function Level Authorization"
      tags: [bfla, admin, auth, capital]

  # Admin function without decorator
  - id: py-bfla-admin-function-unprotected
    pattern-regex: "async\\s+def\\s+(admin|get_admin|create_admin|delete_admin|update_admin)\\s*\\("
    message: "Admin function - ensure authorization decorator checks admin role"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-285"
      owasp: "API5:2023 Broken Function Level Authorization"
      tags: [bfla, admin]

  # Checking admin from user input (bypass vulnerability)
  - id: py-bfla-admin-from-input
    pattern-regex: "(request\\.(json|form|args)|data)\\s*\\[\\s*['\"]is_?admin['\"]\\s*\\]"
    message: "BFLA - checking admin status from user input allows privilege escalation"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-285"
      owasp: "API5:2023 Broken Function Level Authorization"
      tags: [bfla, privilege-escalation, capital]

  # Missing role verification pattern
  - id: py-bfla-missing-role-verify
    pattern-regex: "if\\s+not\\s+current_user\\s*:"
    message: "Auth check only verifies user exists - also verify role/permissions for admin operations"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-862"
      tags: [bfla, auth]

  # Undocumented admin endpoint (no OpenAPI docs)
  - id: py-bfla-hidden-admin-endpoint
    pattern-regex: "@(router|app)\\.(get|post)\\([^)]*include_in_schema\\s*=\\s*False[^)]*admin"
    message: "Hidden admin endpoint - security through obscurity is not protection"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-656"
      owasp: "API5:2023 Broken Function Level Authorization"
      tags: [bfla, admin]

  # ============================================
  # API7:2023 - Security Misconfiguration (Redis/Database)
  # ============================================

  # Redis connection without password
  - id: py-redis-no-auth
    pattern-regex: "redis\\.(Redis|StrictRedis)\\s*\\([^)]*\\)(?![^)]*password)"
    message: "Redis connection without authentication - set password for production (OWASP API7)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-287"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [redis, auth, misconfiguration, capital]

  # Redis connection with empty/default password
  - id: py-redis-weak-password
    pattern-regex: "redis\\.(Redis|StrictRedis)\\s*\\([^)]*password\\s*=\\s*['\"]['\"]"
    message: "Redis with empty password - configure strong authentication"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-287"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [redis, auth]

  # Redis URL without password
  - id: py-redis-url-no-auth
    pattern-regex: "redis://(localhost|127\\.0\\.0\\.1|0\\.0\\.0\\.0):[0-9]+/?['\"]"
    message: "Redis URL without authentication - use redis://:password@host:port format"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-287"
      tags: [redis, auth, capital]

  # aioredis without password
  - id: py-aioredis-no-auth
    pattern-regex: "aioredis\\.(create_redis|from_url)\\s*\\([^)]*\\)(?![^)]*password)"
    message: "aioredis connection may lack authentication"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-287"
      tags: [redis, auth]

  # MongoDB without authentication
  - id: py-mongodb-no-auth
    pattern-regex: "MongoClient\\s*\\(['\"]mongodb://(localhost|127\\.0\\.0\\.1)"
    message: "MongoDB connection to localhost - ensure authentication is configured for production"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-287"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [mongodb, auth, misconfiguration]

  # Exposed debug endpoint
  - id: py-debug-endpoint-exposed
    pattern-regex: "@(router|app)\\.(get|post)\\(['\"]/?debug"
    message: "Debug endpoint exposed - remove or protect in production (OWASP API7)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-489"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [debug, misconfiguration, capital]

  # ============================================
  # API4:2023 - Unrestricted Resource Consumption (Pagination)
  # ============================================

  # Query without limit
  - id: py-unbounded-query-all
    patterns:
      - pattern: '$MODEL.query.all()'
      - pattern: 'await $REPO.get_all()'
      - pattern: '$SESSION.query($MODEL).all()'
    message: "Unbounded query returns all records - add pagination with limit (OWASP API4)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-770"
      owasp: "API4:2023 Unrestricted Resource Consumption"
      tags: [pagination, dos, capital]

  # User-controlled limit without max validation
  - id: py-unbounded-limit-param
    pattern-regex: "limit\\s*=\\s*(request\\.(args|json|form)|int\\(request)"
    message: "User-controlled limit parameter - validate maximum value to prevent DoS"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-770"
      owasp: "API4:2023 Unrestricted Resource Consumption"
      tags: [pagination, dos, capital]

  # FastAPI Query without le (max) constraint
  - id: py-fastapi-unbounded-limit
    pattern-regex: "limit:\\s*int\\s*=\\s*Query\\s*\\([^)]*\\)(?![^)]*le\\s*=)"
    message: "FastAPI limit parameter without maximum constraint - add le=100 or similar"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-770"
      owasp: "API4:2023 Unrestricted Resource Consumption"
      tags: [fastapi, pagination, dos]

  # Large default limit
  - id: py-large-default-limit
    pattern-regex: "limit\\s*[=:]\\s*(1000|10000|100000|999+)"
    message: "Large default limit value - may cause resource exhaustion"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-770"
      tags: [pagination, dos]

  # Offset/skip without limit
  - id: py-offset-without-limit
    pattern-regex: "offset\\s*=.*(?!.*limit)"
    message: "Pagination offset without limit - always pair offset with reasonable limit"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      tags: [pagination]

  # File upload without size limit
  - id: py-upload-no-size-limit
    pattern-regex: "(UploadFile|FileStorage|request\\.files)"
    message: "File upload - ensure MAX_CONTENT_LENGTH or file size validation is configured"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-770"
      owasp: "API4:2023 Unrestricted Resource Consumption"
      tags: [upload, dos]

  # File upload - filename used directly (path traversal)
  - id: py-upload-filename-direct
    patterns:
      - pattern-either:
          - pattern: $FILE.filename
          - pattern: file.filename
          - pattern: upload.filename
    message: "File upload filename used directly - use secure_filename() to prevent path traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021 Broken Access Control"
      tags: [upload, path-traversal]

  # Flask file.save without secure_filename
  - id: py-flask-file-save-unsafe
    pattern: $FILE.save($PATH)
    message: "File save - ensure filename is sanitized with secure_filename() (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021 Broken Access Control"
      tags: [flask, upload, path-traversal]

  # ============================================
  # API9:2023 - Improper Asset Management
  # ============================================

  # Deprecated API version still active
  - id: py-deprecated-api-v1
    pattern-regex: "@(router|app)\\.(get|post|put|delete)\\(['\"]/?v1/"
    message: "API v1 endpoint - ensure deprecated versions are decommissioned (OWASP API9)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1104"
      owasp: "API9:2023 Improper Inventory Management"
      tags: [versioning, deprecated, capital]

  # Old/legacy endpoint naming
  - id: py-legacy-endpoint
    pattern-regex: "@(router|app)\\.(get|post)\\(['\"][^'\"]*(_old|_legacy|_deprecated|_v1)['\"]"
    message: "Legacy endpoint detected - remove deprecated API versions"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1104"
      owasp: "API9:2023 Improper Inventory Management"
      tags: [versioning, deprecated]

  # Multiple API versions in same file
  - id: py-multiple-api-versions
    pattern-regex: "(/v1/.*\\n.*)?/v2/"
    message: "Multiple API versions - ensure old versions are properly deprecated"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1104"
      tags: [versioning]

  # ============================================
  # API10:2023 - Insufficient Logging & Monitoring
  # ============================================

  # Login without audit logging
  - id: py-login-no-logging
    pattern-regex: "def\\s+(login|authenticate|signin)\\s*\\([^)]*\\):\\s*\\n(?!.*log)"
    message: "Authentication function without logging - log all auth attempts for security monitoring (OWASP API10)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-778"
      owasp: "API10:2023 Insufficient Logging & Monitoring"
      tags: [logging, auth, capital]

  # Failed login not logged
  - id: py-failed-auth-no-log
    pattern-regex: "return.*['\"]([Ii]nvalid|[Ww]rong|[Ff]ailed).*password"
    message: "Authentication failure - ensure failed attempts are logged with IP and timestamp"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-778"
      owasp: "API10:2023 Insufficient Logging & Monitoring"
      tags: [logging, auth]

  # Admin action without audit log
  - id: py-admin-action-no-log
    pattern-regex: "def\\s+(delete|remove|update|create)_?(user|admin|role)\\s*\\([^)]*\\):\\s*\\n(?!.*log)"
    message: "Admin action without audit logging - log privileged operations"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-778"
      owasp: "API10:2023 Insufficient Logging & Monitoring"
      tags: [logging, admin, audit]

  # Sensitive data access without logging
  - id: py-sensitive-access-no-log
    pattern-regex: "\\.(credit_card|ssn|password)(?!.*log)"
    message: "Sensitive data access - consider audit logging for compliance"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-778"
      tags: [logging, pii, audit]

  # ============================================
  # API7:2023 - CORS Misconfigurations
  # ============================================

  # CORS wildcard origin - allows any domain
  - id: py-cors-wildcard-origin
    pattern-regex: "Access-Control-Allow-Origin['\"]?\\s*[,:=]\\s*['\"]\\*['\"]"
    message: "CORS wildcard origin (*) allows any domain to access API - restrict to trusted domains (OWASP API7)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [cors, misconfiguration, capital]

  # Flask-CORS wildcard
  - id: py-flask-cors-wildcard
    patterns:
      - pattern: 'CORS($APP, origins="*")'
      - pattern: 'CORS($APP, origins=["*"])'
      - pattern: "CORS($APP, resources={$R: {'origins': '*'}})"
    message: "Flask-CORS with wildcard origin - restrict to specific trusted domains"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [cors, flask]

  # Flask-CORS regex pattern wildcard
  - id: py-flask-cors-wildcard-regex
    pattern-regex: "CORS\\s*\\([^)]*origins\\s*=\\s*[\"']\\*[\"']"
    message: "Flask-CORS configured with wildcard origin (*)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      tags: [cors, flask]

  # FastAPI CORS wildcard
  - id: py-fastapi-cors-wildcard
    patterns:
      - pattern: 'CORSMiddleware($APP, allow_origins=["*"], ...)'
      - pattern: 'add_middleware(CORSMiddleware, allow_origins=["*"], ...)'
    message: "FastAPI CORS with wildcard origin - allows any domain access (OWASP API7)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [cors, fastapi, capital]

  # FastAPI CORS wildcard regex
  - id: py-fastapi-cors-wildcard-regex
    pattern-regex: "allow_origins\\s*=\\s*\\[\\s*[\"']\\*[\"']\\s*\\]"
    message: "FastAPI CORS allows all origins (*) - restrict to trusted domains"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [cors, fastapi, capital]

  # CORS with credentials and wildcard (critical)
  - id: py-cors-wildcard-credentials
    pattern-regex: "allow_credentials\\s*=\\s*True.*allow_origins.*\\*|allow_origins.*\\*.*allow_credentials\\s*=\\s*True"
    message: "CRITICAL: CORS wildcard with credentials enabled - session hijacking vulnerability"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [cors, credentials, critical]

  # Django CORS wildcard
  - id: py-django-cors-wildcard
    pattern-regex: "CORS_ALLOW_ALL_ORIGINS\\s*=\\s*True"
    message: "Django CORS allows all origins - set CORS_ALLOWED_ORIGINS with specific domains"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      tags: [cors, django]

  # Direct header setting wildcard
  - id: py-cors-header-wildcard
    pattern-regex: "headers\\s*\\[\\s*['\"]Access-Control-Allow-Origin['\"]\\s*\\]\\s*=\\s*['\"]\\*['\"]"
    message: "Setting CORS header to wildcard - restrict to specific origin"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      tags: [cors, headers]

  # Response header wildcard
  - id: py-response-cors-wildcard
    pattern-regex: "response\\.headers\\s*\\[.*Access-Control.*\\]\\s*=\\s*['\"]\\*['\"]"
    message: "Response CORS header set to wildcard (*)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      tags: [cors, headers]

  # ============================================
  # API7:2023 - Missing Security Headers
  # ============================================

  # Missing X-Content-Type-Options
  - id: py-missing-content-type-options
    pattern-regex: "@(app|router)\\.(get|post|put|delete)\\s*\\([^)]*\\)\\s*\\n(async\\s+)?def"
    message: "Endpoint should include X-Content-Type-Options: nosniff header to prevent MIME sniffing"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-16"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [headers, security-headers]

  # Flask app without security headers
  - id: py-flask-no-security-headers
    pattern-regex: "Flask\\s*\\(__name__\\)"
    message: "Flask app - ensure security headers are configured (use Flask-Talisman or @after_request)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-16"
      tags: [flask, security-headers]

  # FastAPI app without security middleware
  - id: py-fastapi-no-security-middleware
    pattern-regex: "FastAPI\\s*\\([^)]*\\)"
    message: "FastAPI app - consider adding security headers middleware (Secure, starlette-security)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-16"
      tags: [fastapi, security-headers]

  # X-Frame-Options not set
  - id: py-missing-xframe-options
    pattern-regex: "response\\.headers\\s*=\\s*\\{(?![^}]*X-Frame-Options)"
    message: "Response headers missing X-Frame-Options - add to prevent clickjacking"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1021"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [headers, clickjacking]

  # Disabled security headers explicitly
  - id: py-disabled-security-header
    pattern-regex: "(X-XSS-Protection|X-Content-Type-Options|X-Frame-Options|Strict-Transport-Security).*None|None.*(X-XSS-Protection|X-Content-Type-Options)"
    message: "Security header explicitly disabled - this weakens client protection"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-16"
      tags: [headers, security-headers]

  # Content-Security-Policy unsafe-inline
  - id: py-csp-unsafe-inline
    pattern-regex: "Content-Security-Policy.*unsafe-inline"
    message: "CSP with unsafe-inline allows inline scripts - XSS risk"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [csp, xss, headers]

  # Content-Security-Policy unsafe-eval
  - id: py-csp-unsafe-eval
    pattern-regex: "Content-Security-Policy.*unsafe-eval"
    message: "CSP with unsafe-eval allows eval() - code injection risk"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-95"
      tags: [csp, code-injection, headers]

  # Missing HSTS header
  - id: py-missing-hsts
    pattern-regex: "https://.*(?!.*Strict-Transport-Security)"
    message: "HTTPS endpoint - consider adding Strict-Transport-Security header"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-319"
      tags: [hsts, headers, https]

  # CORS allowed_hosts wildcard in settings/config
  - id: py-cors-allowed-hosts-wildcard
    pattern-regex: "allowed_hosts.*=.*\\[\\s*[\"']\\*[\"']\\s*\\]"
    message: "CORS allowed_hosts set to wildcard ['*'] - restrict to specific trusted domains (OWASP API7)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-942"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [cors, settings, capital]

  # CORS allow all methods with wildcard
  - id: py-cors-allow-all-methods
    pattern-regex: "allow_methods\\s*=\\s*\\[\\s*[\"']\\*[\"']\\s*\\]"
    message: "CORS allows all HTTP methods (*) - restrict to needed methods only"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-942"
      tags: [cors, methods]

  # CORS allow all headers with wildcard
  - id: py-cors-allow-all-headers
    pattern-regex: "allow_headers\\s*=\\s*\\[\\s*[\"']\\*[\"']\\s*\\]"
    message: "CORS allows all headers (*) - restrict to needed headers only"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-942"
      tags: [cors, headers]

  # ============================================
  # XPath Injection (CWE-643) - vulnpy coverage
  # ============================================

  - id: py-xpath-lxml-findall
    pattern: lxml.etree.findall($PATH, ...)
    message: "lxml XPath query with potential user input - XPath injection vulnerability (CWE-643)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-643"
      owasp: "A03:2021 Injection"

  - id: py-xpath-lxml-findtext
    pattern: lxml.etree.findtext($PATH, ...)
    message: "lxml XPath text query - XPath injection vulnerability (CWE-643)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-643"

  - id: py-xpath-etree-findall
    pattern: $ELEM.findall($PATH)
    message: "XML Element findall with XPath - potential XPath injection (CWE-643)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-643"

  - id: py-xpath-etree-find
    pattern: $ELEM.find($PATH)
    message: "XML Element find with XPath - potential XPath injection (CWE-643)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-643"

  - id: py-xpath-iterfind
    pattern: $ELEM.iterfind($PATH)
    message: "XML iterfind with XPath - potential XPath injection (CWE-643)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-643"

  # ============================================
  # SSRF via http.client (CWE-918) - vulnpy
  # ============================================

  - id: py-ssrf-httpconnection
    pattern: http.client.HTTPConnection($HOST)
    message: "HTTPConnection with user-controlled host - SSRF vulnerability (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "API7:2023 SSRF"

  - id: py-ssrf-httpsconnection
    pattern: http.client.HTTPSConnection($HOST)
    message: "HTTPSConnection with user-controlled host - SSRF vulnerability (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"

  - id: py-ssrf-httpconnection-request
    pattern: $CONN.request($METHOD, $PATH, ...)
    message: "HTTP request method - ensure path is not user-controlled (SSRF)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  - id: py-ssrf-httpconnection-putrequest
    pattern: $CONN.putrequest($METHOD, $URL)
    message: "HTTP putrequest with URL - SSRF risk if user-controlled"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # ============================================
  # YAML unsafe loading - additional patterns
  # ============================================

  - id: py-yaml-load-all-unsafe
    pattern: yaml.load_all($DATA, ...)
    message: "yaml.load_all() - insecure deserialization, use safe_load_all (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"

  - id: py-yaml-full-load
    pattern: yaml.full_load($DATA)
    message: "yaml.full_load() - insecure deserialization, use safe_load (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"

  - id: py-yaml-unsafe-load
    pattern: yaml.unsafe_load($DATA)
    message: "yaml.unsafe_load() - intentionally insecure deserialization (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"

  # ============================================
  # Weak Hash - additional patterns
  # ============================================

  - id: py-hashlib-new-md5
    pattern: hashlib.new("md5", ...)
    message: "MD5 via hashlib.new() - cryptographically broken (CWE-327)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-327"

  - id: py-hashlib-new-sha1
    pattern: hashlib.new("sha1", ...)
    message: "SHA1 via hashlib.new() - deprecated weak hash (CWE-327)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-327"

  - id: py-hashlib-new-sha1-upper
    pattern: hashlib.new("SHA1", ...)
    message: "SHA1 via hashlib.new() - deprecated weak hash (CWE-327)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-327"

  # ============================================
  # ReDoS - Regex Denial of Service (CWE-1333)
  # ============================================

  - id: py-redos-re-match
    pattern: re.match($PATTERN, $INPUT)
    message: "Regex match - ensure pattern is not vulnerable to ReDoS (CWE-1333)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-re-search
    pattern: re.search($PATTERN, $INPUT)
    message: "Regex search - ensure pattern is not vulnerable to ReDoS (CWE-1333)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-re-findall
    pattern: re.findall($PATTERN, $INPUT)
    message: "Regex findall - ensure pattern is not vulnerable to ReDoS (CWE-1333)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-re-finditer
    pattern: re.finditer($PATTERN, $INPUT)
    message: "Regex finditer - ensure pattern is not vulnerable to ReDoS (CWE-1333)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-re-sub
    pattern: re.sub($PATTERN, $REPL, $INPUT)
    message: "Regex sub - ensure pattern is not vulnerable to ReDoS (CWE-1333)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-re-split
    pattern: re.split($PATTERN, $INPUT)
    message: "Regex split - ensure pattern is not vulnerable to ReDoS (CWE-1333)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-re-subn
    pattern: re.subn($PATTERN, $REPL, $INPUT)
    message: "Regex subn - ensure pattern is not vulnerable to ReDoS (CWE-1333)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-re-fullmatch
    pattern: re.fullmatch($PATTERN, $INPUT)
    message: "Regex fullmatch - ensure pattern is not vulnerable to ReDoS (CWE-1333)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-compiled-match
    pattern: $PATTERN.match($INPUT)
    message: "Compiled regex match - ensure pattern is not vulnerable to ReDoS"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-compiled-search
    pattern: $PATTERN.search($INPUT)
    message: "Compiled regex search - ensure pattern is not vulnerable to ReDoS"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-compiled-findall
    pattern: $PATTERN.findall($INPUT)
    message: "Compiled regex findall - ensure pattern is not vulnerable to ReDoS"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-compiled-finditer
    pattern: $PATTERN.finditer($INPUT)
    message: "Compiled regex finditer - ensure pattern is not vulnerable to ReDoS"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-compiled-fullmatch
    pattern: $PATTERN.fullmatch($INPUT)
    message: "Compiled regex fullmatch - ensure pattern is not vulnerable to ReDoS"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-compiled-sub
    pattern: $PATTERN.sub($REPL, $INPUT)
    message: "Compiled regex sub - ensure pattern is not vulnerable to ReDoS"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-compiled-subn
    pattern: $PATTERN.subn($REPL, $INPUT)
    message: "Compiled regex subn - ensure pattern is not vulnerable to ReDoS"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  - id: py-redos-compiled-split
    pattern: $PATTERN.split($INPUT)
    message: "Compiled regex split - ensure pattern is not vulnerable to ReDoS"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1333"

  # ============================================
  # Tarfile Path Traversal (CWE-22) - vulnpy
  # ============================================

  - id: py-tarfile-open
    pattern: tarfile.open($PATH, ...)
    message: "tarfile.open() - verify no path traversal in archive members (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  - id: py-tarfile-extractall
    pattern: $TAR.extractall(...)
    message: "tarfile extractall() - path traversal vulnerability, use extraction filter (CWE-22)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021 Broken Access Control"

  - id: py-tarfile-extract
    pattern: $TAR.extract($MEMBER, ...)
    message: "tarfile extract() - verify member path for traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  - id: py-tarfile-class
    pattern: tarfile.TarFile($PATH, ...)
    message: "TarFile class - verify archive for path traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  # ============================================
  # bz2 Path Traversal (CWE-22) - vulnpy
  # ============================================

  - id: py-bz2-open
    pattern: bz2.open($PATH, ...)
    message: "bz2.open() with user-controlled path - path traversal risk (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  - id: py-bz2-file
    pattern: bz2.BZ2File($PATH, ...)
    message: "BZ2File with user-controlled path - path traversal risk (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  # ============================================
  # io.open Path Traversal (CWE-22) - vulnpy
  # ============================================

  - id: py-io-open
    pattern: io.open($PATH, ...)
    message: "io.open() with potentially user-controlled path - path traversal risk (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  # ============================================
  # Random - additional weak patterns (CWE-338)
  # ============================================

  - id: py-random-uniform
    pattern: random.uniform($A, $B)
    message: "random.uniform() is not cryptographically secure - use secrets module (CWE-338)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-338"

  - id: py-random-randrange
    pattern: random.randrange(...)
    message: "random.randrange() is not cryptographically secure - use secrets module (CWE-338)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-338"

  - id: py-random-sample
    pattern: random.sample($POP, $K)
    message: "random.sample() is not cryptographically secure - use secrets module (CWE-338)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-338"

  - id: py-random-shuffle
    pattern: random.shuffle($LIST)
    message: "random.shuffle() is not cryptographically secure - use secrets module (CWE-338)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-338"

  # ============================================
  # XXE - Additional lxml patterns (CWE-611)
  # ============================================

  - id: py-lxml-fromstring
    pattern: lxml.etree.fromstring($DATA)
    message: "lxml.etree.fromstring() - disable external entity resolution (CWE-611)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2017 XXE"

  - id: py-lxml-html-fromstring
    pattern: lxml.html.fromstring($DATA)
    message: "lxml.html.fromstring() with user input - potential XSS/injection"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-611"

  - id: py-xml-dom-parsestring
    pattern: xml.dom.pulldom.parseString($DATA)
    message: "xml.dom.pulldom.parseString() - XXE vulnerability (CWE-611)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-611"

  - id: py-xml-sax-parsestring
    pattern: xml.sax.parseString($DATA, ...)
    message: "xml.sax.parseString() - XXE vulnerability (CWE-611)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-611"

  - id: py-xml-minidom-parsestring
    pattern: xml.dom.minidom.parseString($DATA)
    message: "xml.dom.minidom.parseString() - XXE vulnerability (CWE-611)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-611"

  # ============================================
  # execfile (Python 2) - vulnpy
  # ============================================

  - id: py-execfile
    pattern: execfile($PATH)
    message: "execfile() with user-controlled path - code execution vulnerability (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  # ============================================
  # SQL Injection - sqlite3 patterns (vulnpy)
  # ============================================

  - id: py-sqlite-execute-format
    pattern: $CURSOR.execute($Q % $V)
    message: "SQLite execute with string formatting - SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  - id: py-sqlite-execute-fstring
    pattern: $CURSOR.execute(f"...")
    message: "SQLite execute with f-string - SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  - id: py-sqlite-execute-concat
    pattern: $CURSOR.execute($Q + $V)
    message: "SQLite execute with concatenation - SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  - id: py-sqlite-executemany-format
    pattern: $CURSOR.executemany($Q % $V, ...)
    message: "SQLite executemany with string formatting - SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  - id: py-sqlite-executescript
    pattern: $CURSOR.executescript($SCRIPT)
    message: "SQLite executescript - ensure script is not user-controlled (CWE-89)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-89"

  # ============================================
  # urllib patterns - vulnpy SSRF
  # ============================================

  - id: py-urllib-urlopen-request
    patterns:
      - pattern: urllib.request.urlopen(urllib.request.Request($URL))
      - pattern: urlopen(Request($URL))
    message: "urllib urlopen via Request object - SSRF if URL is user-controlled (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # ============================================
  # Flask/FastAPI Response Headers
  # ============================================

  - id: py-missing-content-type-options
    pattern-regex: "(?:response\\.headers|headers)\\[.*\\]\\s*=(?!.*X-Content-Type-Options)"
    message: "Response missing X-Content-Type-Options header - add nosniff"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-16"

  - id: py-response-no-csp
    pattern-regex: "return\\s+Response\\((?!.*Content-Security-Policy)"
    message: "Response without Content-Security-Policy header"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-1021"

  # ============================================
  # Additional SSRF patterns (vulnpy coverage)
  # ============================================

  # Legacy Python 2 urllib.urlopen
  - id: py-ssrf-legacy-urlopen
    pattern: urllib.urlopen($URL)
    message: "Legacy urllib.urlopen() - SSRF vulnerability if URL is user-controlled (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"

  # HTTPConnection with host from variable
  - id: py-ssrf-httpconnection-init
    pattern-regex: "HTTPConnection\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*"
    message: "HTTPConnection with variable host - SSRF if user-controlled (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # HTTPSConnection with host from variable
  - id: py-ssrf-httpsconnection-init
    pattern-regex: "HTTPSConnection\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*"
    message: "HTTPSConnection with variable host - SSRF if user-controlled (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # putrequest with variable URL
  - id: py-ssrf-putrequest
    pattern-regex: "\\.putrequest\\s*\\([^,]+,\\s*[a-zA-Z_]"
    message: "HTTP putrequest with variable URL - SSRF risk (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # ============================================
  # Additional weak random patterns
  # ============================================

  - id: py-random-choices
    pattern: random.choices(...)
    message: "random.choices() is not cryptographically secure - use secrets module (CWE-338)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-338"

  - id: py-random-getrandbits
    pattern: random.getrandbits(...)
    message: "random.getrandbits() is not cryptographically secure - use secrets module (CWE-338)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-338"

  # ============================================
  # SQL Injection - format string patterns
  # ============================================

  - id: py-sql-format-string
    pattern: $CURSOR.execute($Q.format(...))
    message: "SQL query with .format() - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # ============================================
  # Jinja2 XSS patterns
  # ============================================

  - id: py-jinja2-safe-filter
    pattern-regex: "\\|\\s*safe\\b"
    message: "Jinja2 |safe filter - XSS risk if applied to user input (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  - id: py-markupsafe-markup
    pattern: Markup($USER_INPUT)
    message: "MarkupSafe Markup() - XSS risk if wrapping user input (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  # ============================================
  # SQL Injection - Indirect Taint Flow Patterns
  # Catches: sql = "...".format(x); cursor.execute(sql)
  # ============================================

  # vulnpy pattern: sql = CONST.format(user_input) then cursor.execute(sql)
  # Catch: variable = SOMETHING.format(anything)
  - id: py-sqli-var-format-call
    pattern-regex: "sql\\s*=\\s*[A-Za-z_][A-Za-z0-9_]*\\.format\\s*\\("
    message: "SQL variable built with .format() - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  # Catch cursor.execute(sql) where sql is a variable (not parameterized)
  - id: py-sqli-execute-var
    pattern-regex: "\\.(execute|executemany|executescript)\\s*\\(\\s*sql\\s*[,)]"
    message: "cursor.execute with sql variable - ensure parameterized queries (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # Catch cursor.execute(query) where query is a variable
  - id: py-sqli-execute-query-var
    pattern-regex: "\\.(execute|executemany|executescript)\\s*\\(\\s*query\\s*[,)]"
    message: "cursor.execute with query variable - ensure parameterized queries (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # String formatting then execute - multiline pattern
  - id: py-sqli-format-then-execute
    pattern-regex: '\.format\s*\(.*?\)[\s\S]{0,100}\.(execute|executemany|executescript)\s*\('
    message: "SQL string with .format() passed to execute - SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # Variable assigned with string literal format
  - id: py-sqli-sql-var-format
    pattern-regex: "sql\\s*=\\s*[\"'][^\"']*[\"']\\.format\\s*\\("
    message: "SQL query built with .format() - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # f-string SQL assignment
  - id: py-sqli-sql-var-fstring
    pattern-regex: "sql\\s*=\\s*f[\"']"
    message: "SQL query built with f-string - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # Percent formatting SQL
  - id: py-sqli-sql-var-percent
    pattern-regex: "sql\\s*=\\s*[\"'][^\"']*%s[^\"']*[\"']\\s*%"
    message: "SQL query built with % formatting - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # Dict-style %(name)s formatting in SQL (dvpwa pattern)
  - id: py-sqli-dict-format
    pattern-regex: "%\\([a-zA-Z_][a-zA-Z0-9_]*\\)s.*%\\s*\\{"
    message: "SQL query with dict % formatting - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"
      tags: [sqli, dict-format]

  # INSERT/UPDATE/DELETE with dict % formatting
  - id: py-sqli-insert-dict-format
    pattern-regex: "(INSERT|UPDATE|DELETE).*%\\([a-zA-Z_][a-zA-Z0-9_]*\\)s"
    message: "SQL INSERT/UPDATE/DELETE with dict % formatting - SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"
      tags: [sqli, dict-format]

  # query variable with format
  - id: py-sqli-query-var-format
    pattern-regex: "query\\s*=\\s*[\"'][^\"']*[\"']\\.format\\s*\\("
    message: "Query string built with .format() - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # query = CONST.format() pattern
  - id: py-sqli-query-const-format
    pattern-regex: "query\\s*=\\s*[A-Za-z_][A-Za-z0-9_]*\\.format\\s*\\("
    message: "Query variable built with .format() - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # ============================================
  # SSRF - HTTPConnection/HTTPSConnection Indirect
  # ============================================

  # HTTPConnection with any variable (not just string literal)
  - id: py-ssrf-httpconnection-var
    pattern-regex: "HTTPConnection\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*[,)]"
    message: "HTTPConnection with variable host - SSRF if user-controlled (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021 SSRF"

  # HTTPSConnection with any variable
  - id: py-ssrf-httpsconnection-var
    pattern-regex: "HTTPSConnection\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*[,)]"
    message: "HTTPSConnection with variable host - SSRF if user-controlled (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"

  # vulnpy pattern: connection_class(user_input) where connection_class is HTTP(S)Connection
  - id: py-ssrf-connection-class-var
    pattern-regex: "connection_class\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)"
    message: "HTTP connection class with variable host - SSRF vulnerability (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"

  # Generic: any_var(user_input) then .request() pattern - catches dynamic connection classes
  - id: py-ssrf-dynamic-connection
    pattern-regex: "[a-zA-Z_][a-zA-Z0-9_]*\\s*=\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\(\\s*user_input\\s*\\)"
    message: "Connection with user_input parameter - potential SSRF (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # conn.request with variable in first OR second position
  - id: py-ssrf-conn-request-var
    pattern-regex: "\\.(request|putrequest)\\s*\\([^,]+,\\s*[a-zA-Z_][a-zA-Z0-9_]*"
    message: "HTTP request with variable URL/path - SSRF risk (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # .request(user_input, ...) - method injection
  - id: py-ssrf-request-method-var
    pattern-regex: "\\.request\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*,"
    message: "HTTP request with variable method - potential request smuggling (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # urlopen with variable
  - id: py-ssrf-urlopen-var
    pattern-regex: "urlopen\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)"
    message: "urlopen with variable URL - SSRF if user-controlled (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"

  # urllib.urlopen (legacy)
  - id: py-ssrf-urllib-legacy-var
    pattern-regex: "urllib\\.urlopen\\s*\\(\\s*[a-zA-Z_]"
    message: "Legacy urllib.urlopen with variable - SSRF vulnerability (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"

  # requests library with variable URL
  - id: py-ssrf-requests-var
    pattern-regex: "requests\\.(get|post|put|delete|patch|head|options)\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*[,)]"
    message: "requests library with variable URL - SSRF if user-controlled (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # ============================================
  # XPath Injection - Indirect Patterns
  # ============================================

  # lxml etree operations with variable xpath
  - id: py-xpath-lxml-var
    pattern-regex: "etree\\.(findall|findtext|find|iterfind|xpath)\\s*\\(\\s*[a-zA-Z_]"
    message: "lxml XPath query with variable - XPath injection if user-controlled (CWE-643)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-643"

  # Element find operations
  - id: py-xpath-element-var
    pattern-regex: "\\.(findall|findtext|find|iterfind)\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)"
    message: "XML find with variable XPath - XPath injection risk (CWE-643)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-643"

  # ============================================
  # Deserialization - Indirect Patterns
  # ============================================

  # pickle.loads with variable
  - id: py-pickle-loads-var
    pattern-regex: "pickle\\.loads?\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)"
    message: "pickle.load(s) with variable data - insecure deserialization (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"

  # yaml.load with variable
  - id: py-yaml-load-var
    pattern-regex: "yaml\\.(load|load_all|full_load|unsafe_load)\\s*\\(\\s*[a-zA-Z_]"
    message: "YAML load with variable data - insecure deserialization (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"

  # ============================================
  # Command Injection - Indirect Patterns
  # ============================================

  # os.system with variable
  - id: py-cmdi-os-system-var
    pattern-regex: "os\\.system\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)"
    message: "os.system with variable command - command injection (CWE-78)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-78"

  # subprocess with shell=True and variable
  - id: py-cmdi-subprocess-var
    pattern-regex: "subprocess\\.(call|run|Popen)\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*.*shell\\s*=\\s*True"
    message: "subprocess with variable and shell=True - command injection (CWE-78)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-78"

  # ============================================
  # Code Execution - Indirect Patterns
  # ============================================

  # exec with variable
  - id: py-exec-var
    pattern-regex: "exec\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)"
    message: "exec() with variable - code injection if user-controlled (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  # eval with variable
  - id: py-eval-var
    pattern-regex: "eval\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)"
    message: "eval() with variable - code injection if user-controlled (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  # compile with variable
  - id: py-compile-var
    pattern-regex: "compile\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*,"
    message: "compile() with variable - code injection risk (CWE-94)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-94"

  # ============================================
  # Path Traversal - Indirect Patterns
  # ============================================

  # open with variable path
  - id: py-path-open-var
    pattern-regex: "(?:^|[^a-zA-Z_])open\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*[,)]"
    message: "open() with variable path - path traversal if user-controlled (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  # io.open with variable
  - id: py-path-io-open-var
    pattern-regex: "io\\.open\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*"
    message: "io.open() with variable path - path traversal risk (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  # tarfile operations with variable
  - id: py-path-tarfile-var
    pattern-regex: "tarfile\\.(open|TarFile)\\s*\\(\\s*[a-zA-Z_]"
    message: "tarfile with variable path - path traversal risk (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  # ============================================
  # XXE - Indirect Patterns
  # ============================================

  # lxml.etree.fromstring with variable
  - id: py-xxe-lxml-fromstring-var
    pattern-regex: "etree\\.fromstring\\s*\\(\\s*[a-zA-Z_]"
    message: "lxml.etree.fromstring with variable - XXE vulnerability (CWE-611)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-611"

  # xml parsing with variable
  - id: py-xxe-parse-var
    pattern-regex: "(parseString|parse|fromstring)\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*[,)]"
    message: "XML parsing with variable data - XXE risk (CWE-611)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-611"

  # ============================================
  # Weak Random - Function Call Patterns
  # ============================================

  # random module function with any args
  - id: py-random-insecure-call
    pattern-regex: "random\\.(random|randint|randrange|choice|choices|uniform|sample|shuffle|getrandbits)\\s*\\("
    message: "random module is not cryptographically secure - use secrets module (CWE-338)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-338"

  # ============================================
  # Additional Security Patterns
  # ============================================

  # Insecure tempfile usage
  - id: py-tempfile-mktemp
    pattern: tempfile.mktemp(...)
    message: "tempfile.mktemp() is insecure - use tempfile.mkstemp() or NamedTemporaryFile (CWE-377)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-377"

  # World-writable permissions
  - id: py-chmod-world-writable
    pattern-regex: "os\\.chmod\\s*\\([^,]+,\\s*0o?777\\s*\\)"
    message: "Setting world-writable permissions (777) is insecure (CWE-732)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-732"

  - id: py-chmod-world-writable-decimal
    pattern-regex: "os\\.chmod\\s*\\([^,]+,\\s*511\\s*\\)"
    message: "Setting world-writable permissions (511 = 0o777) is insecure (CWE-732)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-732"

  # Assert for security checks - disabled in optimized mode
  - id: py-assert-security-check
    pattern-regex: "assert\\s+(?:request\\.|user\\.|session\\.|auth\\.|token|password|credential|permission|role|admin)"
    message: "Using assert for security checks - assert is stripped with python -O (CWE-617)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-617"

  # Unsafe zipfile extraction
  - id: py-zipfile-extractall
    pattern: $ZIP.extractall(...)
    message: "zipfile.extractall() - verify no path traversal in archive (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  - id: py-zipfile-extract
    pattern: $ZIP.extract($MEMBER, ...)
    message: "zipfile.extract() - verify member path has no traversal (CWE-22)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-22"

  # Unsafe shutil operations with user input
  - id: py-shutil-rmtree
    pattern: shutil.rmtree($PATH)
    message: "shutil.rmtree() - ensure path is not user-controlled (CWE-22)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-22"

  # Unsafe os.remove/unlink
  - id: py-os-remove
    pattern: os.remove($PATH)
    message: "os.remove() - ensure path is not user-controlled (CWE-22)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-22"

  # Direct import rmtree (from shutil import rmtree)
  - id: py-rmtree-direct
    pattern: rmtree($PATH)
    message: "rmtree() deletes directory recursively - ensure path is validated (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021 Broken Access Control"

  # Direct import remove (from os import remove)
  - id: py-remove-direct
    pattern: remove($PATH)
    message: "remove() deletes file - ensure path is validated (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021 Broken Access Control"

  # SQL injection with unquoted f-string variable
  - id: py-sql-fstring-unquoted
    pattern-regex: "f['\"][^'\"]*=\\s*\\{[^}]+\\}[^'\"]*['\"]"
    message: "SQL with unquoted f-string variable - SQL injection risk (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  # Unsafe symlink following
  - id: py-os-path-realpath-check
    pattern-regex: "os\\.path\\.realpath\\s*\\([^)]*\\)"
    message: "Verify symlink target is within expected directory to prevent traversal"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-59"

  # Binding to all interfaces
  - id: py-socket-bind-all-interfaces
    pattern-regex: "\\.bind\\s*\\(\\s*\\(['\"]0\\.0\\.0\\.0['\"]"
    message: "Binding to 0.0.0.0 exposes service to all network interfaces (CWE-668)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-668"

  # Empty password/secret
  - id: py-empty-password
    pattern-regex: "(?:password|secret|api_key|token)\\s*=\\s*['\"]['\"]"
    message: "Empty password/secret string detected (CWE-258)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-258"

  # Disabled certificate verification in requests
  - id: py-requests-cert-false
    pattern: requests.$METHOD(..., cert=False, ...)
    message: "Disabled certificate verification - vulnerable to MITM (CWE-295)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-295"

  # Unsafe YAML Loader explicit
  - id: py-yaml-fullloader
    pattern: yaml.load($DATA, Loader=yaml.FullLoader)
    message: "yaml.FullLoader can still execute Python objects in some versions - use SafeLoader"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-502"

  # ============================================
  # Server-Side Template Injection (SSTI) - Enhanced
  # ============================================

  # Jinja2 Template with string concatenation - CRITICAL
  - id: py-ssti-jinja2-string-concat
    pattern-regex: "Template\\s*\\(\\s*[\"'][^\"']*[\"']\\s*\\+\\s*[a-zA-Z_]"
    message: "Jinja2 Template with string concatenation - SSTI vulnerability (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"
      owasp: "A03:2021-Injection"

  # Template constructor with variable
  - id: py-ssti-template-variable
    pattern-regex: "Template\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)"
    message: "Jinja2 Template with variable - SSTI vulnerability if user-controlled (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  # Template with format string
  - id: py-ssti-template-format
    pattern-regex: "Template\\s*\\(\\s*[\"'][^\"']*[\"']\\s*\\.\\s*format\\s*\\("
    message: "Jinja2 Template with format string - SSTI vulnerability (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  # Template with f-string
  - id: py-ssti-template-fstring
    pattern-regex: "Template\\s*\\(\\s*f[\"']"
    message: "Jinja2 Template with f-string - SSTI vulnerability (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  # Mako Template with variable
  - id: py-ssti-mako-variable
    pattern-regex: "MakoTemplate\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)"
    message: "Mako Template with variable - SSTI vulnerability if user-controlled (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  # Tornado template execute with user input
  - id: py-ssti-tornado-template
    pattern-regex: "tornado\\.template\\.Template\\s*\\(\\s*[a-zA-Z_]"
    message: "Tornado Template with variable - SSTI vulnerability if user-controlled (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  # Django mark_safe with user input
  - id: py-ssti-django-mark-safe
    pattern: mark_safe($INPUT)
    message: "Django mark_safe() - XSS if user input is passed (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  # ============================================
  # Host Header Injection
  # ============================================

  # Request headers in response
  - id: py-host-header-injection
    pattern-regex: "request\\.headers\\s*\\[\\s*[\"']Host[\"']\\s*\\]"
    message: "Host header used directly - potential host header injection (CWE-644)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-644"

  # Request host in redirect or link
  - id: py-host-header-redirect
    pattern-regex: "request\\.host"
    message: "request.host used - verify not in redirects or links (CWE-601)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-601"

  # Flask request.url used in response
  - id: py-request-url-reflected
    pattern-regex: "request\\.url\\s"
    message: "request.url used - verify not reflected unsanitized (CWE-79)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-79"

  # ============================================
  # Hardcoded Credentials
  # ============================================

  # Hardcoded admin credentials in INSERT
  - id: py-hardcoded-admin-insert
    pattern-regex: "INSERT\\s+INTO\\s+\\w*[Uu]sers?\\w*\\s+VALUES\\s*\\([^)]*admin"
    message: "Hardcoded admin credentials in INSERT statement (CWE-798)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-798"

  # Hardcoded password in INSERT
  - id: py-hardcoded-password-insert
    pattern-regex: "INSERT\\s+INTO\\s+\\w*[Uu]sers?\\w*.*VALUES"
    message: "User data inserted directly - ensure no hardcoded credentials (CWE-798)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-798"

  # ============================================
  # SQL Injection - INSERT statements
  # ============================================

  # SQL injection in INSERT with f-string
  - id: py-sqli-fstring-insert
    pattern-regex: 'f"INSERT\\s+INTO'
    message: "SQL injection - f-string in INSERT query (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # SQL injection in INSERT with format
  - id: py-sqli-format-insert
    pattern-regex: 'INSERT\s+INTO.*?\.format\s*\('
    message: "SQL injection - format() in INSERT query (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # ============================================
  # Network Exposure
  # ============================================

  # Flask/app binding to all interfaces
  - id: py-flask-bind-all-interfaces
    pattern-regex: "\\.run\\s*\\([^)]*host\\s*=\\s*[\"']0\\.0\\.0\\.0[\"']"
    message: "App binding to 0.0.0.0 exposes to all network interfaces (CWE-668)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-668"

  # ============================================
  # Host Header - Additional patterns
  # ============================================

  # Dictionary access to Host header
  - id: py-host-header-dict-access
    pattern-regex: "headers\\s*\\[\\s*[\"']Host[\"']\\s*\\]"
    message: "Host header accessed from dictionary - potential header injection (CWE-644)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-644"

  # Response containing headers variable
  - id: py-header-reflected-response
    pattern-regex: "return\\s+.*headers"
    message: "Headers variable in return - verify Host header not reflected (CWE-644)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-644"

  # Generic Host header access pattern (any variable name)
  - id: py-host-header-generic-access
    pattern-regex: "\\[\\s*[\"']Host[\"']\\s*\\]"
    message: "Host header accessed - potential header injection if used in response/redirect (CWE-644)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-644"

  # Host value used in HTML/link
  - id: py-host-in-html-link
    pattern-regex: "<a\\s+href\\s*=\\s*[\"']?\\{?\\$?[a-zA-Z_]"
    message: "Variable in HTML href attribute - verify not user/header controlled (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  # ============================================
  # SQL Injection - More INSERT patterns
  # ============================================

  # f-string INSERT with VALUES
  - id: py-sqli-fstring-insert-values
    pattern-regex: "f\"INSERT\\s+INTO\\s+\\w+\\s+VALUES\\s*\\("
    message: "SQL injection - f-string in INSERT VALUES (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # ============================================
  # Hardcoded Credentials - Additional patterns
  # ============================================

  # Hardcoded username/password in SQL
  - id: py-hardcoded-creds-in-sql
    pattern-regex: "VALUES\\s*\\(\\s*[a-zA-Z_]+\\s*,\\s*[a-zA-Z_]+\\s*\\)"
    message: "Possible hardcoded credentials in SQL VALUES - use parameters (CWE-798)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-798"

  # Literal admin in code
  - id: py-hardcoded-admin-literal
    pattern-regex: "[\"']admin[\"']\\s*,\\s*[\"']admin[\"']"
    message: "Hardcoded admin:admin credentials detected (CWE-798)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
  # Hardcoded credentials in SQL INSERT (e.g., admin/admin)
  - id: py-hardcoded-creds-sql-insert
    pattern-regex: 'INSERT\s+INTO\s+\w*USER\w*.*VALUES\s*\([^)]*(?:admin|password|secret|root|test)[^)]*\)'
    message: "Hardcoded credentials in SQL INSERT statement - remove or use environment variables (CWE-798)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      tags: [hardcoded-credentials, sql]


  # ============================================
  # NoSQL Injection - MongoDB/PyMongo
  # ============================================

  # FastAPI/Flask endpoint passing request JSON directly to MongoDB
  - id: py-nosqli-request-json-to-find
    patterns:
      - pattern-either:
          - pattern: |
              $QUERY = await $REQUEST.json()
              ...
              $COLLECTION.find($QUERY)
          - pattern: |
              $QUERY = await $REQUEST.json()
              ...
              $COLLECTION.find_one($QUERY)
          - pattern: $COLLECTION.find(await $REQUEST.json())
          - pattern: $COLLECTION.find_one(await $REQUEST.json())
    message: "NoSQL injection - passing request JSON directly to MongoDB find() allows operator injection (CWE-943)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-943"
      owasp: "A03:2021 Injection"
      tags: [nosql-injection, mongodb, fastapi]

  # MongoDB find with user-controlled dict variable
  - id: py-nosqli-mongodb-find-var
    pattern: $COLLECTION.find($QUERY)
    message: "MongoDB find() with variable - ensure query is validated to prevent NoSQL injection (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb]

  # Request JSON passed to function (potential NoSQL injection)
  - id: py-nosqli-request-json-to-function
    patterns:
      - pattern: |
          $QUERY = await $REQUEST.json()
          ...
          $FUNC($QUERY)
    message: "Request JSON passed to function - validate before database operations (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, input-validation]

  # delete_one with variable (NoSQL)
  - id: py-nosqli-mongodb-delete-var
    pattern: $COLLECTION.delete_one($QUERY)
    message: "MongoDB delete_one() with variable - validate query to prevent injection (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb]

  # update_one with variable (NoSQL)
  - id: py-nosqli-mongodb-update-var
    pattern: $COLLECTION.update_one($QUERY, ...)
    message: "MongoDB update_one() with variable - validate query to prevent injection (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb]

  # MontyDB (MongoDB-compatible) find with variable
  - id: py-nosqli-montydb-find
    pattern-regex: 'db_client\.[a-zA-Z_]+\.[a-zA-Z_]+\.find\s*\(\s*[a-zA-Z_][a-zA-Z0-9_]*\s*\)'
    message: "MontyDB find() with variable - validate query to prevent NoSQL injection (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, montydb]

  # Generic MongoDB operators in user input (regex detection)
  - id: py-nosqli-operator-in-query
    pattern-regex: '\{\s*["\x27]\$(?:gt|gte|lt|lte|ne|in|nin|or|and|not|exists|type|regex|where)["\x27]'
    message: "MongoDB query operators detected - validate user input to prevent NoSQL injection (CWE-943)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb]

  # MongoDB find with $where operator (allows JS execution)
  - id: py-nosqli-mongodb-where
    pattern-regex: '\.(find|find_one)\s*\(\s*\{\s*["\x27]\$where["\x27]'
    message: "NoSQL injection - MongoDB $where allows JavaScript execution (CWE-943)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-943"
      owasp: "A03:2021"
      tags: [nosql-injection, mongodb]

  # MongoDB $regex operator with user input
  - id: py-nosqli-mongodb-regex
    pattern-regex: '\$regex["\x27]?\s*:\s*[a-zA-Z_][a-zA-Z0-9_]*'
    message: "NoSQL injection - $regex with variable can cause ReDoS or auth bypass (CWE-943)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb, redos]

  # MongoDB $ne (not equal) auth bypass pattern
  - id: py-nosqli-mongodb-ne-bypass
    pattern-regex: '\$ne["\x27]?\s*:\s*["\x27]'
    message: "Potential NoSQL auth bypass - $ne operator in query (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb, auth-bypass]

  # MongoDB eval (deprecated, dangerous)
  - id: py-nosqli-mongodb-eval
    pattern-regex: 'db\.eval\s*\([^)]*\)'
    message: "MongoDB eval() is deprecated and dangerous - allows arbitrary JS execution (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"
      tags: [nosql-injection, mongodb, code-execution]

  # ============================================
  # LDAP Injection
  # ============================================

  # python-ldap search_s with variable filter
  - id: py-ldap-search-var
    pattern-regex: '\.search_s\s*\([^,]+,\s*[^,]+,\s*[a-zA-Z_][a-zA-Z0-9_]*\s*[,)]'
    message: "LDAP search with variable filter - use ldap.filter.escape_filter_chars() (CWE-90)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-90"
      tags: [ldap-injection]

  # LDAP filter string formatting
  - id: py-ldap-filter-format
    pattern-regex: '\(uid=%s\)|cn=%s|dn=.*%s'
    message: "LDAP injection - string formatting in LDAP filter (CWE-90)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-90"
      tags: [ldap-injection]

  # ============================================
  # GraphQL Security
  # ============================================

  # GraphQL introspection enabled in production
  - id: py-graphql-introspection-enabled
    pattern-regex: 'introspection\s*[=:]\s*True'
    message: "GraphQL introspection enabled - disable in production to prevent schema exposure (CWE-200)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      tags: [graphql, information-disclosure]

  # ============================================
  # Additional Security Patterns
  # ============================================

  # Unsafe object deserialization with dill
  - id: py-dill-loads-unsafe
    pattern-regex: 'dill\.loads?\s*\('
    message: "Unsafe deserialization with dill - can execute arbitrary code (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, rce]

  # Marshal module unsafe load
  - id: py-marshal-loads-unsafe
    pattern-regex: 'marshal\.loads?\s*\('
    message: "Unsafe deserialization with marshal - can execute arbitrary code (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, rce]

  # Weak cryptographic key size
  - id: py-weak-rsa-key-size
    pattern-regex: 'generate\s*\(\s*(512|768|1024)\s*\)'
    message: "Weak RSA key size - use at least 2048 bits (CWE-326)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-326"
      tags: [cryptography, weak-key]

  # ECB mode in cryptography (insecure)
  - id: py-crypto-ecb-mode
    pattern-regex: 'modes\.ECB\s*\(|MODE_ECB'
    message: "ECB mode is insecure - use CBC, GCM, or CTR mode (CWE-327)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-327"
      tags: [cryptography, ecb]

  # Hardcoded IV (initialization vector)
  - id: py-crypto-hardcoded-iv
    pattern-regex: 'iv\s*=\s*b?["\x27][a-zA-Z0-9+/=]{8,}["\x27]'
    message: "Hardcoded IV detected - use random IV for each encryption (CWE-329)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-329"
      tags: [cryptography, iv]

  # ============================================
  # Reflected User Input (XSS/Data Exposure)
  # ============================================

  # User input reflected in JSON/dict response via f-string
  - id: py-reflected-input-json-fstring
    pattern-regex: 'return\s*\{[^}]*f"[^"]*\{[a-zA-Z_][a-zA-Z0-9_]*\}'
    message: "User input reflected in response - potential XSS if rendered as HTML (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, reflected-input, api]

  # User input from .get() reflected in response
  - id: py-reflected-input-get-method
    pattern-regex: '\.get\s*\(\s*"[a-zA-Z_]+"'
    message: "Input from .get() may be reflected - sanitize before output (CWE-79)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-79"
      tags: [xss, reflected-input]

  # ============================================
  # vfapi / FastAPI Enhanced Security Rules
  # ============================================

  # NoSQL Injection - raw request.json() passed to MongoDB query
  - id: py-nosqli-raw-request-json
    patterns:
      - pattern: |
          $QUERY = await request.json()
          ...
          $COLLECTION.find($QUERY)
      - pattern: |
          $DATA = await request.json()
          ...
          $COLLECTION.find_one($DATA)
    message: "NoSQL injection - raw request.json() passed to MongoDB find() allows query operator injection (CWE-943)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-943"
      owasp: "A03:2021 Injection"
      tags: [nosql-injection, mongodb, vfapi]

  # SQL DELETE without proper quoting (vfapi pattern)
  - id: py-sqli-delete-unquoted-var
    pattern-regex: "DELETE\\s+FROM\\s+\\w+\\s+WHERE\\s+\\w+\\s*=\\s*\\{[^}]+\\}[^\"']"
    message: "SQL injection - DELETE with unquoted f-string variable allows numeric injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"
      tags: [sql-injection, vfapi]

  # FastAPI endpoint accepting full request.json() to database
  - id: py-fastapi-mass-assignment-nosql
    patterns:
      - pattern: |
          @$APP.$METHOD($PATH)
          async def $FUNC($REQ: Request):
              ...
              $DATA = await $REQ.json()
              ...
              $COLLECTION.insert_one($DATA)
    message: "Mass assignment - full request body inserted to NoSQL without validation (CWE-915)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      owasp: "API6:2023 Unrestricted Access to Sensitive Business Flows"
      tags: [mass-assignment, nosql, fastapi]

  # FastAPI route without any authentication dependency
  - id: py-fastapi-no-auth-crud
    pattern-regex: "@(app|router)\\.(post|put|patch|delete)\\s*\\(.*\\)\\s*\\n\\s*(async\\s+)?def\\s+\\w+"
    message: "FastAPI CRUD endpoint without authentication dependency - add Depends(get_current_user) (CWE-306)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-306"
      owasp: "API2:2023 Broken Authentication"
      tags: [authentication, fastapi, vfapi]

  # Returning all database records without pagination
  - id: py-fastapi-no-pagination
    patterns:
      - pattern: 'return list($COLLECTION.find())'
      - pattern: 'return list($COLLECTION.find({}))'
    message: "Data exposure - returning all database records without pagination (CWE-200)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      owasp: "API3:2023 Broken Object Property Level Authorization"
      tags: [data-exposure, pagination, fastapi]

  # SQL INSERT with f-string containing user model fields
  - id: py-sqli-insert-fstring-model
    pattern-regex: 'INSERT\s+INTO\s+\w+.*VALUES\s*\([^)]*\{[^}]+\.(username|name|email|password|address)[^}]*\}'
    message: "SQL injection - INSERT with f-string interpolation of user fields (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"
      tags: [sql-injection, insert, vfapi]

  # MongoDB find_one with user-controlled query
  - id: py-nosqli-find-one-user-input
    patterns:
      - pattern: '$COLLECTION.find_one($USER_INPUT)'
      - pattern: '$COLLECTION.find_one({"$FIELD": $VAR})'
    message: "Potential NoSQL injection - find_one() with user-controlled query (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb]

  # cursor.fetchall() after unsafe execute
  - id: py-sqli-fetchall-after-execute
    pattern: |
        $CURSOR.execute($QUERY)
        ...
        $CURSOR.fetchall()
    message: "SQL result fetch after potentially unsafe execute - verify query is parameterized (CWE-89)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection]

  # Direct password comparison without timing-safe comparison
  - id: py-auth-password-direct-compare
    pattern-regex: "if\\s+.*password.*==.*password|if\\s+.*==.*\\.password"
    message: "Direct password comparison - use secrets.compare_digest() for timing-safe comparison (CWE-208)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-208"
      tags: [authentication, timing-attack]

  # SQL INSERT with f-string interpolation
  - id: py-sqli-insert-fstring
    pattern-regex: "f['\"]INSERT\\s+INTO\\s+\\w+.*\\{[^}]+\\}"
    message: "SQL injection - INSERT with f-string interpolation allows arbitrary data injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"
      tags: [sql-injection, insert]

  # SQL UPDATE with f-string interpolation
  - id: py-sqli-update-fstring
    pattern-regex: "f['\"]UPDATE\\s+\\w+\\s+SET.*\\{[^}]+\\}"
    message: "SQL injection - UPDATE with f-string interpolation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"
      tags: [sql-injection, update]

  # Pickle insecure deserialization
  - id: py-insecure-pickle-loads
    patterns:
      - pattern: pickle.loads($DATA)
      - pattern: pickle.load($FILE)
      - pattern: cPickle.loads($DATA)
      - pattern: cPickle.load($FILE)
    message: "Insecure deserialization - pickle can execute arbitrary code (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      owasp: "A08:2021 Software and Data Integrity Failures"
      tags: [deserialization, rce]

  # YAML unsafe load
  - id: py-insecure-yaml-load
    patterns:
      - pattern: yaml.load($DATA)
      - pattern: yaml.load($DATA, ...)
      - pattern: yaml.unsafe_load($DATA)
    message: "Insecure YAML deserialization - use yaml.safe_load() instead (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      owasp: "A08:2021 Software and Data Integrity Failures"
      tags: [deserialization, yaml]

  # SSTI - Jinja2 render_template_string with user input
  - id: py-ssti-jinja2-template-string
    patterns:
      - pattern: render_template_string($USER_INPUT)
      - pattern: Template($USER_INPUT).render(...)
      - pattern: jinja2.Template($USER_INPUT)
      - pattern: Environment(...).from_string($USER_INPUT)
    message: "Server-Side Template Injection - user input in template allows RCE (CWE-1336)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      owasp: "A03:2021 Injection"
      tags: [ssti, template-injection, rce]

  # SSRF - requests with user-controlled URL
  - id: py-ssrf-requests-user-url
    patterns:
      - pattern: requests.get($URL, ...)
      - pattern: requests.post($URL, ...)
      - pattern: requests.put($URL, ...)
      - pattern: requests.delete($URL, ...)
      - pattern: requests.head($URL, ...)
      - pattern: httpx.get($URL, ...)
      - pattern: httpx.post($URL, ...)
      - pattern: aiohttp.ClientSession().get($URL)
      - pattern: urllib.request.urlopen($URL)
    message: "Potential SSRF - validate URL is not user-controlled or use allowlist (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021 Server-Side Request Forgery"
      tags: [ssrf, requests]

  # XXE - XML parsing without disabling external entities
  - id: py-xxe-etree-parse
    patterns:
      - pattern: etree.parse($INPUT)
      - pattern: etree.fromstring($INPUT)
      - pattern: ET.parse($INPUT)
      - pattern: ET.fromstring($INPUT)
      - pattern: xml.dom.minidom.parse($INPUT)
      - pattern: xml.dom.minidom.parseString($INPUT)
      - pattern: xml.sax.parse($INPUT, ...)
    message: "Potential XXE - disable external entities in XML parser (CWE-611)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-611"
      owasp: "A05:2021 Security Misconfiguration"
      tags: [xxe, xml]

  # JWT decode without verification
  - id: py-jwt-no-verify
    patterns:
      - pattern: 'jwt.decode($TOKEN, options={"verify_signature": False})'
      - pattern: 'jwt.decode($TOKEN, verify=False)'
    message: "JWT decoded without signature verification - tokens can be forged (CWE-347)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-347"
      owasp: "A02:2021 Cryptographic Failures"
      tags: [jwt, authentication]

  # os.system command injection
  - id: py-cmdi-os-system
    patterns:
      - pattern: os.system($CMD)
      - pattern: os.popen($CMD)
      - pattern: os.popen($CMD, ...)
    message: "Command injection - os.system/popen executes shell commands (CWE-78)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-78"
      owasp: "A03:2021 Injection"
      tags: [command-injection, os]

  # eval() with any input - extremely dangerous
  - id: py-code-injection-eval
    patterns:
      - pattern: eval($INPUT)
      - pattern: eval($INPUT, ...)
    message: "Code injection - eval() executes arbitrary Python code (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"
      owasp: "A03:2021 Injection"
      tags: [code-injection, eval]

  # exec() with any input - extremely dangerous
  - id: py-code-injection-exec
    patterns:
      - pattern: exec($INPUT)
      - pattern: exec($INPUT, ...)
    message: "Code injection - exec() executes arbitrary Python code (CWE-94)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"
      owasp: "A03:2021 Injection"
      tags: [code-injection, exec]

  # Hardcoded JWT secret
  - id: py-hardcoded-jwt-secret
    pattern-regex: "jwt\\.(encode|decode)\\([^)]*,\\s*['\"][^'\"]{8,}['\"]"
    message: "Hardcoded JWT secret - move to environment variable (CWE-798)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021 Cryptographic Failures"
      tags: [jwt, hardcoded-secret]

  # Flask debug mode enabled
  - id: py-flask-debug-enabled
    patterns:
      - pattern: app.run(debug=True)
      - pattern: app.run(..., debug=True, ...)
    message: "Flask debug mode exposes debugger and reloader - disable in production (CWE-489)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-489"
      tags: [flask, debug, misconfiguration]

  # Django DEBUG=True
  - id: py-django-debug-enabled
    pattern-regex: "DEBUG\\s*=\\s*True"
    message: "Django DEBUG=True exposes sensitive information - disable in production (CWE-489)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-489"
      tags: [django, debug, misconfiguration]

  # File open with user-controlled path
  - id: py-path-traversal-open
    patterns:
      - pattern: open($PATH, ...)
    message: "Potential path traversal - validate file path is not user-controlled (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, file-access]

  # SQL query string formatting (% operator)
  - id: py-sqli-percent-format
    pattern-regex: "['\"]SELECT.*%s.*['\"]\\s*%"
    message: "SQL injection - string formatting with % operator is unsafe (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection]

  # SQL query .format() method
  - id: py-sqli-format-method
    pattern-regex: "['\"]SELECT.*\\{\\}.*['\"].format\\("
    message: "SQL injection - .format() in SQL query is unsafe (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection]

  # Binding to 0.0.0.0 (all interfaces)
  - id: py-bind-all-interfaces
    pattern-regex: "\\.(run|bind|listen)\\([^)]*['\"]0\\.0\\.0\\.0['\"]"
    message: "Binding to 0.0.0.0 exposes service to all network interfaces (CWE-200)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      tags: [network, misconfiguration]

  # assert used for security check (can be disabled with -O flag)
  - id: py-assert-security-check
    pattern-regex: "assert\\s+.*password|assert\\s+.*auth|assert\\s+.*token|assert\\s+.*permission"
    message: "assert can be disabled with -O flag - do not use for security checks (CWE-617)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-617"
      tags: [assertion, security]

  # ============================================
  # vfapi-specific and advanced injection rules
  # ============================================

  # SQL with VALUES clause using f-string (INSERT)
  - id: py-sqli-values-fstring
    pattern-regex: "f['\"].*VALUES\\s*\\([^)]*\\{[^}]+\\}"
    message: "SQL injection - VALUES clause with f-string interpolation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"
      tags: [sql-injection, insert, values]

  # await request.json() passed to function - NoSQL injection vector
  - id: py-nosqli-request-json-to-func
    pattern: |
      $QUERY = await $REQUEST.json()
      ...
      $FUNC($QUERY)
    message: "Request JSON body passed directly to function - validate before database operations (CWE-943)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-943"
      owasp: "A03:2021 Injection"
      tags: [nosql-injection, request-body]

  # Direct request.json() in function call
  - id: py-nosqli-await-request-json
    patterns:
      - pattern: await $REQUEST.json()
    message: "Unvalidated request JSON - validate schema before use in database queries (CWE-20)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-20"
      tags: [input-validation, nosql]

  # MontyDB/MongoDB insert_one with user data
  - id: py-nosqli-insert-one-user-data
    patterns:
      - pattern: $COLLECTION.insert_one({...})
      - pattern: $DB.$COLLECTION.insert_one($DATA)
    message: "MongoDB insert_one - ensure user data is validated to prevent injection (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb, insert]

  # SQL query built with triple-quoted f-string (multi-line)
  - id: py-sqli-multiline-fstring
    pattern-regex: "f'''[^']*\\{[^}]+\\}[^']*'''|f\"\"\"[^\"]*\\{[^}]+\\}[^\"]*\"\"\""
    message: "SQL injection - multi-line f-string with variable interpolation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection, multiline]

  # cursor.execute or db.execute with f-string query
  - id: py-sqli-execute-fstring
    patterns:
      - pattern: $DB.execute(f"...")
      - pattern: $DB.execute(f'...')
      - pattern: $CURSOR.execute(f"...")
      - pattern: $CURSOR.execute(f'...')
      - pattern: await $DB.execute(f"...")
      - pattern: await $DB.execute(f'...')
    message: "SQL injection - execute() with f-string query (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"
      tags: [sql-injection, execute]

  # run_sql_query or similar custom function with f-string
  - id: py-sqli-custom-query-func
    pattern-regex: "(run_sql_query|execute_query|run_query|sql_query|db_query)\\(f['\"]"
    message: "SQL injection - custom query function with f-string (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection, custom-function]

  # aiosqlite connection without parameterized queries
  - id: py-sqli-aiosqlite-execute
    patterns:
      - pattern: await $DB.execute($QUERY)
    message: "aiosqlite execute - ensure parameterized queries are used (CWE-89)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection, aiosqlite, async]

  # Pydantic model field assigned to query without validation
  - id: py-sqli-pydantic-model-in-query
    pattern-regex: "f['\"][^'\"]*\\{\\s*\\w+\\.(name|username|email|address|password|id|user_id)[^}]*\\}"
    message: "Pydantic model field in SQL query - use parameterized queries (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection, pydantic]

  # MD5 encoding pattern (common in vfapi)
  - id: py-weak-hash-md5-encode
    pattern-regex: "md5\\([^)]+\\.encode\\(\\)\\)"
    message: "MD5 hash with encode() - MD5 is cryptographically broken, use bcrypt/argon2 for passwords (CWE-328)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-328"
      owasp: "A02:2021 Cryptographic Failures"
      tags: [weak-hash, md5, password]

  # hashlib.md5 usage
  - id: py-weak-hash-hashlib-md5
    patterns:
      - pattern: hashlib.md5($DATA)
      - pattern: hashlib.md5($DATA).hexdigest()
      - pattern: hashlib.md5($DATA).digest()
    message: "MD5 hash is cryptographically weak - use SHA-256 or bcrypt for passwords (CWE-328)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-328"
      tags: [weak-hash, md5]

  # from hashlib import md5
  - id: py-weak-hash-import-md5
    pattern: from hashlib import md5
    message: "MD5 import detected - MD5 is cryptographically broken (CWE-328)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-328"
      tags: [weak-hash, md5, import]

  # SHA1 weak hash
  - id: py-weak-hash-sha1
    patterns:
      - pattern: hashlib.sha1($DATA)
      - pattern: hashlib.sha1($DATA).hexdigest()
    message: "SHA1 hash is cryptographically weak - use SHA-256 or better (CWE-328)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-328"
      tags: [weak-hash, sha1]

  # FileResponse without path validation
  - id: py-path-traversal-fileresponse
    patterns:
      - pattern: FileResponse($PATH)
      - pattern: FileResponse($PATH, ...)
    message: "FileResponse - ensure path is not user-controlled to prevent path traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, fastapi, file]

  # StaticFiles mount - potential directory listing
  - id: py-fastapi-staticfiles-mount
    patterns:
      - pattern: app.mount($PATH, StaticFiles(...), ...)
    message: "StaticFiles mount - ensure sensitive files are not exposed (CWE-538)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-538"
      tags: [information-disclosure, fastapi, static]

  # uvicorn.run or __import__('uvicorn').run
  - id: py-uvicorn-run-config
    pattern-regex: "uvicorn['\"]\\)\\.run\\(|uvicorn\\.run\\("
    message: "Uvicorn run detected - ensure host/port are properly configured for production"
    languages: [python]
    severity: INFO
    metadata:
      tags: [configuration, uvicorn]

  # Optional parameter with None default for security-sensitive field
  - id: py-optional-user-param
    pattern-regex: "Optional\\[.*User.*\\]\\s*=\\s*None"
    message: "Optional User parameter - ensure proper validation when None (CWE-754)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-754"
      tags: [input-validation, optional]

  # delete_one/delete_many with variable query
  - id: py-nosqli-delete-variable-query
    patterns:
      - pattern: $COLLECTION.delete_one($QUERY)
      - pattern: $COLLECTION.delete_many($QUERY)
    message: "MongoDB delete with variable query - validate to prevent NoSQL injection (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb, delete]

  # find() with dict containing user field
  - id: py-nosqli-find-user-field
    pattern-regex: "\\.find\\(\\{['\"]username['\"]:\\s*\\w+\\}\\)"
    message: "MongoDB find with username field - ensure value is validated (CWE-943)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-943"
      tags: [nosql-injection, mongodb]

  # Faker usage in production code (test data in prod)
  - id: py-faker-in-production
    patterns:
      - pattern: from faker import Faker
      - pattern: Faker()
    message: "Faker library detected - ensure not used in production for real data (CWE-330)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-330"
      tags: [test-data, faker]

  # asyncio.run in __main__ without proper error handling
  - id: py-asyncio-run-main
    pattern-regex: "asyncio\\.run\\([^)]+\\)"
    message: "asyncio.run() - ensure proper error handling for async initialization"
    languages: [python]
    severity: INFO
    metadata:
      tags: [async, error-handling]

  # MontyDB/MongoDB set_storage or client config
  - id: py-mongodb-storage-config
    patterns:
      - pattern: set_storage(...)
      - pattern: MontyClient(...)
      - pattern: MongoClient(...)
    message: "MongoDB client configuration - ensure connection is secured and credentials are not hardcoded"
    languages: [python]
    severity: INFO
    metadata:
      tags: [mongodb, configuration]

  # Return statement missing after delete operation
  - id: py-missing-return-after-delete
    pattern: |
      if $COND:
          ...
          return {...}
      elif $OTHER:
          ...
          $DB.delete_one(...)
    message: "Missing return after delete in elif branch - potential logic flaw (CWE-670)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-670"
      tags: [logic-flaw, control-flow]

  # Password field not filtered from response
  - id: py-password-in-dict-response
    pattern-regex: "['\"]password['\"]:\\s*\\w+\\.(password|passwd)"
    message: "Password field included in response dictionary - filter sensitive data (CWE-200)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-200"
      owasp: "A01:2021 Broken Access Control"
      tags: [information-disclosure, password]

  # Generic database exception handler that retries (using regex for complex patterns)
  - id: py-db-exception-retry-dangerous
    pattern-regex: "except\\s+\\w+.*:\\s*\\n.*return await"
    message: "Database exception with recursive retry - may cause infinite loops or mask errors (CWE-755)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-755"
      tags: [error-handling, database]

  # SQL string concatenation with + operator
  - id: py-sqli-string-concat
    pattern-regex: "['\"]SELECT[^'\"]+['\"]\\s*\\+\\s*\\w+"
    message: "SQL injection - string concatenation in query (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection, concatenation]

  # Dangerous import pattern (__import__)
  - id: py-dangerous-import
    pattern-regex: "__import__\\(['\"][^'\"]+['\"]\\)"
    message: "Dynamic __import__ - potential code injection if user-controlled (CWE-94)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-94"
      tags: [code-injection, import]

  # ============================================
  # Additional vfapi-specific detection rules
  # ============================================

  # FastAPI app without CORS middleware
  - id: py-fastapi-no-cors
    patterns:
      - pattern: app = FastAPI(...)
      - pattern: FastAPI(...)
    message: "FastAPI app - consider adding CORSMiddleware for cross-origin requests (CWE-942)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-942"
      tags: [cors, fastapi, misconfiguration]

  # Pydantic BaseModel without validators
  - id: py-pydantic-no-validation
    pattern: |
      class $MODEL(BaseModel):
          $FIELD: str
    message: "Pydantic model with string fields - consider adding validators for input sanitization"
    languages: [python]
    severity: INFO
    metadata:
      tags: [pydantic, validation, input]

  # MongoDB insert_one with dict containing user fields
  - id: py-nosqli-insert-all-user-fields
    pattern-regex: "insert_one\\(\\{[^}]*'(password|email|username)'[^}]*\\}\\)"
    message: "MongoDB insert with sensitive fields - ensure password is hashed and fields are validated (CWE-312)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-312"
      tags: [nosql, sensitive-data, mongodb]

  # dict.pop() on password field (good practice detection)
  - id: py-sensitive-field-removal
    pattern-regex: "\\.pop\\(['\"](_id|password|secret|token)['\"]\\)"
    message: "Sensitive field removal detected - ensure this happens before returning data"
    languages: [python]
    severity: INFO
    metadata:
      tags: [sensitive-data, good-practice]

  # db.commit() without try/except for rollback
  - id: py-db-commit-no-rollback
    pattern: await $DB.commit()
    message: "Database commit without rollback handling - consider wrapping in try/except (CWE-754)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-754"
      tags: [database, transaction, error-handling]

  # KeyboardInterrupt except (unusual pattern)
  - id: py-keyboard-interrupt-catch
    pattern-regex: "except\\s+KeyboardInterrupt"
    message: "Catching KeyboardInterrupt may prevent clean shutdown - use signal handlers instead"
    languages: [python]
    severity: INFO
    metadata:
      tags: [error-handling, signals]

  # tuple() call on database result (potential data exposure)
  - id: py-tuple-db-result
    pattern-regex: "tuple\\([^)]*\\.find\\([^)]*\\)[^)]*\\)"
    message: "Converting MongoDB find() to tuple - ensure sensitive fields are filtered first"
    languages: [python]
    severity: INFO
    metadata:
      tags: [mongodb, data-exposure]

  # aiosqlite.connect without context manager
  - id: py-aiosqlite-no-context-manager
    pattern: await aiosqlite.connect($DB)
    message: "aiosqlite connection - prefer async context manager for automatic cleanup"
    languages: [python]
    severity: INFO
    metadata:
      tags: [aiosqlite, resource-management]

  # fetchall without limit (potential DoS)
  - id: py-fetchall-no-limit
    pattern: await $CURSOR.fetchall()
    message: "fetchall() without LIMIT - may cause memory issues with large datasets (CWE-400)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-400"
      tags: [database, dos, resource]

  # cursor.close() pattern (should use context manager)
  - id: py-cursor-manual-close
    pattern: await $CURSOR.close()
    message: "Manual cursor close - prefer context manager for automatic resource cleanup"
    languages: [python]
    severity: INFO
    metadata:
      tags: [database, resource-management]

  # INTEGER PRIMARY KEY without explicit type safety
  - id: py-sql-create-table-no-strict
    pattern-regex: "CREATE\\s+TABLE.*INTEGER\\s+PRIMARY\\s+KEY"
    message: "SQLite table - consider using STRICT mode for type safety (SQLite 3.37+)"
    languages: [python]
    severity: INFO
    metadata:
      tags: [sqlite, schema, type-safety]

  # FastAPI endpoint returning dict directly (simplified pattern)
  - id: py-fastapi-return-dict
    pattern: |
      return {"$KEY": ...}
    message: "FastAPI endpoint returning dict - consider using response_model for schema validation"
    languages: [python]
    severity: INFO
    metadata:
      tags: [fastapi, response, validation]

  # f-string with .address field (common injection point)
  - id: py-sqli-address-field
    pattern-regex: "f['\"][^'\"]*\\{[^}]*\\.address[^}]*\\}"
    message: "User address field in f-string - addresses often contain special chars that can cause injection (CWE-89)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-89"
      tags: [sql-injection, user-input]

  # len() check on user-controlled list (timing attack)
  - id: py-len-timing-attack
    pattern-regex: "if\\s+len\\([^)]+\\)\\s*==\\s*1:"
    message: "Length check on result - consider constant-time comparison for security operations (CWE-208)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-208"
      tags: [timing-attack]

  # Returning password hash in response (even if hashed)
  - id: py-password-hash-in-response
    pattern-regex: "['\"]password['\"]:\\s*\\w+\\[\\d+\\]"
    message: "Password hash may be exposed in response - never return password data even if hashed (CWE-200)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      tags: [password, information-disclosure]

  # MontyClient or MongoClient without authentication
  - id: py-mongodb-no-auth
    pattern-regex: "(MontyClient|MongoClient)\\([^)]*\\)"
    message: "MongoDB client - ensure authentication is configured for production (CWE-306)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-306"
      tags: [mongodb, authentication]

  # set_storage for MontyDB
  - id: py-montydb-storage-config
    pattern: set_storage(...)
    message: "MontyDB storage configuration - ensure database files are not web-accessible"
    languages: [python]
    severity: INFO
    metadata:
      tags: [montydb, configuration]

  # HTMLResponse with string concatenation
  - id: py-xss-htmlresponse-concat
    pattern-regex: "HTMLResponse\\([^)]*\\+[^)]*\\)"
    message: "HTMLResponse with string concatenation - potential XSS if user data is included (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021 Injection"
      tags: [xss, htmlresponse]

  # HTMLResponse with f-string
  - id: py-xss-htmlresponse-fstring
    pattern-regex: "HTMLResponse\\(f['\"]"
    message: "HTMLResponse with f-string - escape user data to prevent XSS (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, htmlresponse]

  # app.title in HTML (potential XSS if configurable)
  - id: py-xss-app-title-in-html
    pattern-regex: "HTMLResponse\\([^)]*app\\.title[^)]*\\)"
    message: "app.title in HTMLResponse - ensure title is sanitized if user-configurable (CWE-79)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-79"
      tags: [xss, configuration]

  # include_in_schema=False (hiding endpoints)
  - id: py-fastapi-hidden-endpoint
    pattern-regex: "@app\\.(get|post|put|delete)\\([^)]*include_in_schema\\s*=\\s*False"
    message: "Hidden endpoint (include_in_schema=False) - security through obscurity is not protection"
    languages: [python]
    severity: INFO
    metadata:
      tags: [fastapi, documentation, security]

  # docs_url=False or redoc_url=False
  - id: py-fastapi-docs-disabled
    pattern-regex: "FastAPI\\([^)]*(docs_url|redoc_url)\\s*=\\s*False"
    message: "API documentation disabled - ensure alternative documentation exists"
    languages: [python]
    severity: INFO
    metadata:
      tags: [fastapi, documentation]

  # synchronous=1 in database config (blocking mode)
  - id: py-db-synchronous-mode
    pattern-regex: "synchronous\\s*=\\s*1"
    message: "Database synchronous mode - may impact performance under load"
    languages: [python]
    severity: INFO
    metadata:
      tags: [database, performance]

  # ============================================
  # Insecure Deserialization - Advanced Patterns
  # ============================================

  # Base64 decode + pickle.loads (cookie deserialization attack)
  - id: py-pickle-b64decode-cookie
    pattern-regex: "loads\\(b64decode\\([^)]*cookie"
    message: "Insecure deserialization - pickle.loads on base64-decoded cookie data enables RCE (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      owasp: "A08:2021"
      tags: [deserialization, rce, cookie]

  # Base64 decode + pickle (general pattern)
  - id: py-pickle-b64decode
    pattern-regex: "(pickle\\.loads?|loads)\\s*\\(\\s*b64decode"
    message: "Insecure deserialization - pickle.loads with b64decode often indicates untrusted data (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, rce]

  # Cookie data directly to pickle
  - id: py-pickle-from-cookie
    pattern-regex: "(pickle\\.loads?|loads)\\s*\\([^)]*cookies"
    message: "Insecure deserialization - deserializing cookie data can lead to RCE (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, cookie]

  # ============================================
  # IDOR / Broken Access Control
  # ============================================

  # session.delete without ownership check (IDOR)
  - id: py-sqlalchemy-delete-no-owner-check
    pattern-regex: "session\\.delete\\([^)]+\\)"
    message: "Database delete operation - verify object ownership before deletion to prevent IDOR (CWE-639)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021"
      tags: [idor, authorization]

  # Accessing user resources by ID without ownership verification
  - id: py-idor-user-id-param
    pattern-regex: "def\\s+\\w+\\([^)]*user_id[^)]*\\):"
    message: "Function accepts user_id parameter - ensure authorization check before accessing user resources (CWE-639)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-639"
      tags: [idor, authorization]

  # Flask route with <int:user_id> without @login_required check
  - id: py-flask-route-user-id-idor
    pattern-regex: "@(app|bp|blueprint)\\.route\\([^)]*<int:user_id>"
    message: "Route exposes user_id - verify requesting user has permission to access this resource (CWE-639)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021"
      tags: [idor, flask, authorization]

  # Note/resource access without ownership check
  - id: py-idor-note-access
    pattern-regex: "session\\.get\\(Note,\\s*\\w+_id\\)"
    message: "Note access by ID - verify note ownership before returning to prevent IDOR (CWE-639)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      tags: [idor, authorization]

  # ============================================
  # Authentication / Information Disclosure
  # ============================================

  # Timing attack - checking user existence before password
  - id: py-timing-attack-user-check
    pattern-regex: "if\\s+user\\s+(is\\s+not\\s+None|!=\\s*None|is\\s+None|==\\s*None)"
    message: "User existence check before password verification may enable timing attacks (CWE-208)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-208"
      tags: [authentication, timing-attack]

  # Exposing email in response
  - id: py-email-disclosure-response
    pattern-regex: "(jsonify|json\\.dumps)\\([^)]*email[^)]*\\)"
    message: "Email exposure in API response - consider if this enables user enumeration (CWE-200)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-200"
      tags: [information-disclosure, privacy]

  # Endpoint that reveals user existence
  - id: py-user-enumeration-endpoint
    pattern-regex: "(is_logged_in|check_user|user_exists|verify_email)"
    message: "Endpoint may enable user enumeration - ensure consistent responses for valid/invalid users (CWE-203)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-203"
      tags: [authentication, enumeration]

  # ============================================
  # Password Handling Issues
  # ============================================

  # Password stored as String column (no hashing indicator)
  - id: py-password-column-string
    pattern-regex: "password\\s*=\\s*Column\\(String"
    message: "Password column as String - ensure passwords are hashed with bcrypt/argon2, not stored as plaintext (CWE-256)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-256"
      owasp: "A02:2021"
      tags: [authentication, password]

  # Direct password assignment without hashing
  - id: py-password-plaintext-assignment
    pattern-regex: "self\\.password\\s*=\\s*password(?!\\s*_hash)"
    message: "Direct password assignment without hashing - use bcrypt.hashpw() or similar (CWE-256)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-256"
      tags: [authentication, password]

  # No password validation/strength check visible
  - id: py-weak-password-policy
    pattern-regex: "def\\s+__init__\\([^)]*password[^)]*\\):[^}]*self\\.password"
    message: "Password in constructor - consider adding password strength validation (CWE-521)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-521"
      tags: [authentication, password-policy]

  # ============================================
  # File Upload Vulnerabilities
  # ============================================

  # BLOB column for images without validation
  - id: py-unrestricted-file-upload-blob
    pattern-regex: "(profile_image|avatar|image|photo)\\s*=\\s*Column\\(BLOB"
    message: "Binary file storage - validate file type, size, and content before storing (CWE-434)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-434"
      owasp: "A04:2021"
      tags: [file-upload, validation]

  # File upload without content type check
  - id: py-file-upload-no-validation
    pattern-regex: "request\\.files\\[[^]]+\\]\\.read\\(\\)"
    message: "File upload read without validation - check file type, size, and scan for malware (CWE-434)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-434"
      tags: [file-upload]

  # ============================================
  # Flask Security Issues
  # ============================================

  # Flash message with json.dumps (error structure disclosure)
  - id: py-flask-flash-json-errors
    pattern-regex: "flash\\((json\\.)?dumps\\("
    message: "Flash message with JSON dumps - may expose internal error structure to users (CWE-209)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-209"
      tags: [flask, information-disclosure]

  # No CSRF token visible in form handling
  - id: py-flask-form-no-csrf
    pattern-regex: "form\\.validate_on_submit\\(\\)"
    message: "Form validation - ensure Flask-WTF CSRF protection is enabled (CWE-352)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-352"
      owasp: "A05:2021"
      tags: [flask, csrf]

  # WTForms without CSRFProtect
  - id: py-wtforms-csrf-disabled
    pattern-regex: "class\\s+\\w+Form\\(.*\\):[^}]*class\\s+Meta:[^}]*csrf\\s*=\\s*False"
    message: "CSRF protection disabled in WTForms - enable CSRF to prevent cross-site request forgery (CWE-352)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-352"
      tags: [flask, csrf]

  # ============================================
  # Race Conditions / TOCTOU
  # ============================================

  # Validate then use pattern (TOCTOU)
  - id: py-toctou-validate-then-get
    pattern-regex: "validate_\\w+\\([^)]+\\)[^}]*session\\.get\\("
    message: "Validate-then-use pattern may have race condition - consider atomic operations (CWE-367)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-367"
      tags: [race-condition, toctou]

  # Check exists then delete/update
  - id: py-toctou-check-then-delete
    pattern-regex: "if\\s+\\w+\\s+is\\s+not\\s+None:[^}]*session\\.delete"
    message: "Check-then-delete pattern - consider using database-level constraints to prevent TOCTOU (CWE-367)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-367"
      tags: [race-condition]

  # ============================================
  # Unsafe URL Handling
  # ============================================

  # urlopen without timeout
  - id: py-urlopen-no-timeout
    pattern-regex: "urlopen\\([^)]*\\)(?!.*timeout)"
    message: "urlopen without timeout - can cause indefinite blocking, vulnerable to slowloris attacks (CWE-400)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-400"
      tags: [dos, timeout]

  # No URL scheme validation
  - id: py-url-no-scheme-validation
    pattern-regex: "urlopen\\(\\w+\\)"
    message: "URL opened without scheme validation - may allow file:// or other dangerous protocols (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf, url-validation]

  # URL from request parameter directly to urlopen
  - id: py-ssrf-request-to-urlopen
    pattern-regex: "(request\\.(args|form|json|data))[^}]*urlopen"
    message: "User-controlled URL to urlopen - SSRF vulnerability allows access to internal services (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021"
      tags: [ssrf]

  # ============================================
  # Jinja2 Template Security
  # ============================================

  # Jinja2 safe filter on user data
  - id: py-jinja-safe-filter
    pattern: '{{ $VAR | safe }}'
    message: "Jinja2 safe filter bypasses HTML escaping - XSS risk if $VAR contains user input (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, jinja2, template]

  # Markup() with user data
  - id: py-markup-user-data
    pattern: Markup($DATA)
    message: "Markup() marks content as safe - XSS risk if $DATA contains user input (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, jinja2]

  # ============================================
  # Misc Flask Vulnerabilities
  # ============================================

  # logout_user() called unconditionally
  - id: py-flask-logout-redundant
    pattern-regex: "logout_user\\(\\)"
    message: "logout_user() call - verify this is intentional and not a logic flaw"
    languages: [python]
    severity: INFO
    metadata:
      tags: [flask, authentication]

  # Return redirect without validating URL
  - id: py-open-redirect
    pattern-regex: "redirect\\(request\\.(args|form)\\["
    message: "Redirect to user-controlled URL - validate or whitelist destinations to prevent open redirect (CWE-601)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      owasp: "A03:2021"
      tags: [redirect, flask]

  # Using request.referrer for redirect
  - id: py-open-redirect-referrer
    pattern-regex: "redirect\\(request\\.referrer"
    message: "Redirect to referrer - can be manipulated by attacker for open redirect (CWE-601)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [redirect, flask]

  # Flask app with SESSION_COOKIE_SECURE = False
  - id: py-flask-insecure-session-cookie
    pattern-regex: "SESSION_COOKIE_SECURE\\s*=\\s*False"
    message: "Session cookie not secure - enable HTTPS and SESSION_COOKIE_SECURE (CWE-614)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-614"
      tags: [flask, session, cookie]

  # Flask app with SESSION_COOKIE_HTTPONLY = False
  - id: py-flask-session-cookie-httponly
    pattern-regex: "SESSION_COOKIE_HTTPONLY\\s*=\\s*False"
    message: "Session cookie HTTP-only disabled - XSS can steal session cookies (CWE-1004)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1004"
      tags: [flask, session, cookie]

  # send_file without safe path handling
  - id: py-flask-send-file-unsafe
    pattern-regex: "send_file\\((request\\.|f['\"])"
    message: "send_file with user input - validate path to prevent directory traversal (CWE-22)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021"
      tags: [flask, path-traversal]

  # ============================================
  # SQL Injection - Additional Patterns
  # ============================================

  # Triple-quoted f-string SQL
  - id: py-sqli-triple-quote-fstring
    pattern-regex: "text\\(f\"\"\""
    message: "SQL injection - triple-quoted f-string in text() allows SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sqli, sqlalchemy]

  # execute() with user input
  - id: py-sqli-execute-fstring
    pattern-regex: "\\.execute\\(f['\"]"
    message: "SQL injection - f-string in execute() allows SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sqli]

  # Raw SQL with % formatting
  - id: py-sqli-percent-format
    pattern-regex: "(execute|text)\\([^)]*%\\s*\\("
    message: "SQL injection - % string formatting in SQL is vulnerable (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sqli]

  # Raw SQL with .format()
  - id: py-sqli-string-format
    pattern-regex: "(execute|text)\\([^)]*\\.format\\("
    message: "SQL injection - .format() in SQL query is vulnerable (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      tags: [sqli]

  # SQL string concatenation patterns
  - id: py-sqli-select-concat-double
    pattern-regex: '"SELECT[^"]*"\\s*\\+\\s*\\w+'
    message: "SQL injection - SELECT query built with string concatenation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sqli-select-concat-single
    pattern-regex: "'SELECT[^']*'\\s*\\+\\s*\\w+"
    message: "SQL injection - SELECT query built with string concatenation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sqli-query-var-concat
    pattern-regex: "query\\s*=.*SELECT.*\\+\\s*\\w+"
    message: "SQL injection - query variable built with string concatenation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sqli-string-plus-var
    pattern-regex: "\".*SELECT.*\"\\s*\\+\\s*\\w+"
    message: "SQL injection - SELECT query concatenated with variable (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sqli-insert-concat
    pattern-regex: "[\"']INSERT[^\"']*[\"']\\s*\\+\\s*\\w+"
    message: "SQL injection - INSERT query built with string concatenation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sqli-update-concat
    pattern-regex: "[\"']UPDATE[^\"']*[\"']\\s*\\+\\s*\\w+"
    message: "SQL injection - UPDATE query built with string concatenation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sqli-delete-concat
    pattern-regex: "[\"']DELETE[^\"']*[\"']\\s*\\+\\s*\\w+"
    message: "SQL injection - DELETE query built with string concatenation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  - id: py-sqli-where-concat
    pattern-regex: "[\"'].*WHERE[^\"']*[\"']\\s*\\+\\s*\\w+"
    message: "SQL injection - WHERE clause built with string concatenation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021 Injection"

  # ============================================
  # WTForms / Form Validation Issues
  # ============================================

  # URLField without scheme validation (SSRF/XSS)
  - id: py-wtforms-urlfield-no-scheme
    pattern-regex: "URLField\\([^)]*\\)"
    message: "WTForms URLField - ensure scheme validation to prevent javascript: or data: URLs (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [wtforms, xss, ssrf]

  # Form without CSRF protection indicator
  - id: py-wtforms-no-csrf-indicator
    pattern-regex: "class\\s+\\w+Form\\(FlaskForm\\):"
    message: "WTForms FlaskForm - verify CSRFProtect is initialized in app factory (CWE-352)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-352"
      tags: [wtforms, csrf]

  # DataRequired but no Length validator (potential DoS)
  - id: py-wtforms-no-length-validator
    pattern-regex: "StringField\\([^)]*DataRequired\\(\\)[^)]*\\)(?![^)]*Length)"
    message: "StringField with DataRequired but no Length validator - may allow oversized input (CWE-400)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-400"
      tags: [wtforms, validation]

  # ============================================
  # Hardcoded Secrets / Registration Codes
  # ============================================

  # Hardcoded UUID (often used as registration/invite codes)
  - id: py-hardcoded-uuid-secret
    pattern-regex: "['\"][0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}['\"]"
    message: "Hardcoded UUID - if used as invite/registration code, move to environment variable (CWE-798)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-798"
      tags: [secrets, uuid]

  # Hardcoded simple password in seed/test data
  - id: py-hardcoded-weak-password
    pattern-regex: "password\\s*[=:]\\s*['\"](?:admin|password|123456|user|test|root|guest)['\"]"
    message: "Hardcoded weak password - use strong random passwords even in seed data (CWE-798)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-798"
      tags: [secrets, password]

  # Default admin credentials
  - id: py-default-admin-creds
    pattern-regex: "(admin|root|superuser).*password.*[=:]"
    message: "Default admin credentials pattern - ensure these are not used in production (CWE-798)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-798"
      tags: [secrets, admin]

  # ============================================
  # bcrypt / Password Hashing Issues
  # ============================================

  # bcrypt gensalt without cost factor
  - id: py-bcrypt-gensalt-no-rounds
    pattern-regex: "gensalt\\(\\)"
    message: "bcrypt gensalt() without rounds - specify rounds (e.g., gensalt(12)) for adequate security (CWE-916)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-916"
      tags: [bcrypt, password]

  # bcrypt with low rounds
  - id: py-bcrypt-low-rounds
    pattern-regex: "gensalt\\(\\s*([1-9]|10)\\s*\\)"
    message: "bcrypt with low cost factor - use at least 12 rounds for adequate security (CWE-916)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-916"
      tags: [bcrypt, password]

  # checkpw with potential timing leak
  - id: py-bcrypt-checkpw-timing
    pattern-regex: "if\\s+.*checkpw\\("
    message: "bcrypt checkpw in conditional - ensure consistent response time to prevent timing attacks (CWE-208)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-208"
      tags: [bcrypt, timing-attack]

  # ============================================
  # Flask-Login Security Issues
  # ============================================

  # login_user with remember=True without duration
  - id: py-flask-login-remember-no-duration
    pattern-regex: "login_user\\([^)]*remember\\s*=\\s*True[^)]*\\)"
    message: "login_user with remember=True - configure REMEMBER_COOKIE_DURATION for security (CWE-613)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-613"
      tags: [flask-login, session]

  # login_user without checking user.is_active
  - id: py-flask-login-no-active-check
    pattern-regex: "login_user\\(\\s*user\\s*[,)]"
    message: "login_user - verify user.is_active is checked before login to prevent disabled account access (CWE-863)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-863"
      tags: [flask-login, authorization]

  # ============================================
  # Template XSS - Advanced Patterns
  # ============================================

  # .decode() in template context (potential XSS)
  - id: py-template-decode-xss
    pattern-regex: "\\{\\{[^}]*\\.decode\\(\\)[^}]*\\}\\}"
    message: "Template .decode() - binary data in template may enable XSS, ensure proper escaping (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, template]

  # data attribute with template variable (data URI injection)
  - id: py-template-data-attr-xss
    pattern-regex: "data\\s*=\\s*[\"']\\{\\{"
    message: "Template variable in data attribute - may allow data URI XSS injection (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, template]

  # value attribute with template variable
  - id: py-template-value-attr
    pattern-regex: "value\\s*=\\s*[\"']\\{\\{[^}]+\\}\\}[\"']"
    message: "Template variable in value attribute - ensure proper escaping to prevent XSS (CWE-79)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-79"
      tags: [xss, template]

  # href/src with template variable (potential open redirect/SSRF)
  - id: py-template-href-src-injection
    pattern-regex: "(href|src)\\s*=\\s*[\"']\\{\\{[^}]+\\}\\}[\"']"
    message: "Template variable in href/src - validate URL to prevent open redirect or SSRF (CWE-601)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-601"
      tags: [redirect, ssrf, template]

  # onclick/onerror with template variable (direct XSS)
  - id: py-template-event-handler-xss
    pattern-regex: "(onclick|onerror|onload|onmouseover)\\s*=\\s*[\"'][^\"']*\\{\\{"
    message: "Template variable in event handler - critical XSS vulnerability (CWE-79)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [xss, template]

  # ============================================
  # Database Seed / Migration Security
  # ============================================

  # Creating user with plaintext password in seed
  - id: py-seed-plaintext-password
    pattern-regex: "User\\([^)]*password\\s*=\\s*['\"][^'\"]+['\"][^)]*\\)"
    message: "User creation with plaintext password - hash passwords even in seed data (CWE-256)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-256"
      tags: [seed, password]

  # Admin user in seed data
  - id: py-seed-admin-user
    pattern-regex: "User\\([^)]*is_admin\\s*=\\s*True"
    message: "Admin user in seed data - ensure admin credentials are properly secured (CWE-250)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-250"
      tags: [seed, admin]

  # ============================================
  # Object/Embed Tag Security
  # ============================================

  # object tag with user data (PDF/Flash injection)
  - id: py-template-object-tag
    pattern-regex: "<object[^>]*\\{\\{"
    message: "Object tag with template variable - may allow malicious PDF/Flash embedding (CWE-829)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-829"
      tags: [xss, template, embed]

  # embed tag with user data
  - id: py-template-embed-tag
    pattern-regex: "<embed[^>]*\\{\\{"
    message: "Embed tag with template variable - may allow malicious content embedding (CWE-829)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-829"
      tags: [xss, template, embed]

  # iframe with user data
  - id: py-template-iframe-injection
    pattern-regex: "<iframe[^>]*\\{\\{"
    message: "Iframe with template variable - may allow clickjacking or malicious embedding (CWE-1021)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1021"
      tags: [clickjacking, template]

  # ============================================
  # Session / Cookie Security
  # ============================================

  # Setting cookie without secure flag
  - id: py-cookie-no-secure
    pattern-regex: "set_cookie\\([^)]*\\)(?![^)]*secure\\s*=\\s*True)"
    message: "set_cookie without secure flag - cookie can be intercepted over HTTP (CWE-614)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-614"
      tags: [cookie, session]

  # Setting cookie without httponly flag
  - id: py-cookie-no-httponly
    pattern-regex: "set_cookie\\([^)]*\\)(?![^)]*httponly\\s*=\\s*True)"
    message: "set_cookie without httponly flag - cookie accessible to JavaScript (CWE-1004)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1004"
      tags: [cookie, session]

  # Setting cookie without samesite
  - id: py-cookie-no-samesite
    pattern-regex: "set_cookie\\([^)]*\\)(?![^)]*samesite)"
    message: "set_cookie without samesite attribute - vulnerable to CSRF (CWE-352)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-352"
      tags: [cookie, csrf]

  # ============================================
  # Error Handling / Information Disclosure
  # ============================================

  # Catching bare exception
  - id: py-bare-exception
    pattern-regex: "except\\s*:"
    message: "Bare except catches all exceptions including KeyboardInterrupt - be specific (CWE-396)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-396"
      tags: [exception, error-handling]

  # Printing exception details
  - id: py-print-exception
    pattern-regex: "print\\([^)]*(?:exception|error|traceback|exc_info)"
    message: "Printing exception details - use logging and avoid exposing to users (CWE-209)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-209"
      tags: [exception, information-disclosure]

  # traceback.print_exc in production code
  - id: py-traceback-print
    pattern-regex: "traceback\\.print_exc\\(\\)"
    message: "traceback.print_exc() - avoid in production, may expose sensitive information (CWE-209)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      tags: [exception, information-disclosure]

  # ============================================
  # Cryptographic Issues
  # ============================================

  # Using random instead of secrets
  - id: py-random-for-security
    pattern-regex: "random\\.(choice|randint|random)\\([^)]*\\)"
    message: "random module is not cryptographically secure - use secrets module for security purposes (CWE-330)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-330"
      tags: [crypto, random]

  # uuid4 for tokens (fine but could use secrets)
  - id: py-uuid-for-token
    pattern-regex: "(token|secret|key|code)\\s*=\\s*.*uuid\\.uuid4\\(\\)"
    message: "UUID for security token - consider secrets.token_urlsafe() for better entropy (CWE-330)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-330"
      tags: [crypto, token]

  # Static IV for encryption
  - id: py-static-iv
    pattern-regex: "(iv|IV|nonce)\\s*=\\s*b['\"]"
    message: "Static IV/nonce for encryption - use random IV for each encryption (CWE-329)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-329"
      tags: [crypto, iv]

  # ECB mode usage
  - id: py-ecb-mode
    pattern-regex: "(MODE_ECB|ECB)"
    message: "ECB encryption mode - patterns in data are preserved, use CBC or GCM (CWE-327)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-327"
      tags: [crypto, encryption]

  # ============================================
  # WTForms CSRF - Form vs FlaskForm
  # ============================================

  # Form class without CSRF (should use FlaskForm)
  - id: py-wtforms-no-csrf
    pattern-regex: "class\\s+\\w+\\s*\\(\\s*Form\\s*\\)"
    message: "WTForms Form without CSRF - use FlaskForm from flask_wtf instead for CSRF protection (CWE-352)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-352"
      owasp: "A01:2021"
      tags: [csrf, wtforms, flask]

  # Importing Form from wtforms instead of FlaskForm
  - id: py-import-wtforms-form
    pattern-regex: "from\\s+wtforms\\s+import.*\\bForm\\b"
    message: "Importing Form from wtforms - use FlaskForm from flask_wtf for CSRF protection (CWE-352)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-352"
      tags: [csrf, wtforms, flask]

  # ============================================
  # Mass Assignment Vulnerabilities
  # ============================================

  # is_admin field in form (mass assignment risk)
  - id: py-mass-assignment-admin
    pattern-regex: "is_admin\\s*=\\s*(BooleanField|IntegerField|StringField)"
    message: "Admin flag in form - mass assignment vulnerability, never accept is_admin from user input (CWE-915)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-915"
      owasp: "A01:2021"
      tags: [mass-assignment, authorization]

  # role field in user form
  - id: py-mass-assignment-role
    pattern-regex: "(role|user_role|permission)\\s*=\\s*(StringField|SelectField|IntegerField)"
    message: "Role/permission field in form - mass assignment vulnerability, validate server-side (CWE-915)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment, authorization]

  # Populating model directly from form
  - id: py-form-populate-obj
    pattern-regex: "form\\.populate_obj\\("
    message: "form.populate_obj() copies all form fields to model - verify no sensitive fields can be overwritten (CWE-915)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment, wtforms]

  # **kwargs in model __init__
  - id: py-model-kwargs-init
    pattern-regex: "def\\s+__init__\\s*\\([^)]*\\*\\*kwargs"
    message: "Model __init__ with **kwargs - may allow mass assignment of unintended attributes (CWE-915)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-915"
      tags: [mass-assignment]

  # ============================================
  # User Enumeration / Information Disclosure
  # ============================================

  # Exposing user email in response
  - id: py-user-email-exposure
    pattern-regex: "(return|jsonify|json\\.dumps).*\\.(email|username|user_id)"
    message: "Exposing user email/username in response - may enable user enumeration (CWE-200)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      tags: [user-enumeration, information-disclosure]

  # Different error messages for user exists vs wrong password
  - id: py-user-enumeration-message
    pattern-regex: "(User not found|Invalid username|Unknown user|Email not registered)"
    message: "Specific 'user not found' message enables user enumeration - use generic 'Invalid credentials' (CWE-204)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-204"
      tags: [user-enumeration, authentication]

  # is_logged_in endpoint exposing user details
  - id: py-auth-status-exposure
    pattern-regex: "(is_logged_in|check_auth|auth_status).*current_user\\."
    message: "Auth check endpoint exposing user details - avoid returning user info in auth status (CWE-200)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-200"
      tags: [user-enumeration, authentication]

  # ============================================
  # Flash Messages Security
  # ============================================

  # flash() with json.dumps (exposing form errors)
  - id: py-flash-json-dumps
    pattern-regex: "flash\\s*\\(\\s*(json\\.)?dumps\\s*\\("
    message: "flash() with dumps() - may expose sensitive error details to users (CWE-209)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      tags: [information-disclosure, flask]

  # flash() with form.errors
  - id: py-flash-form-errors
    pattern-regex: "flash\\s*\\([^)]*form\\.errors"
    message: "flash() with form.errors - may expose validation details, use generic error message (CWE-209)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-209"
      tags: [information-disclosure, flask]

  # flash() with exception message
  - id: py-flash-exception
    pattern-regex: "flash\\s*\\([^)]*str\\s*\\(\\s*e\\s*\\)|flash\\s*\\([^)]*exception"
    message: "flash() with exception details - may expose sensitive information (CWE-209)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      tags: [information-disclosure, flask]

  # ============================================
  # Password Comparison Issues
  # ============================================

  # Direct password comparison (timing attack + plaintext)
  - id: py-password-direct-compare
    pattern-regex: "password\\s*==\\s*[^=]|[^=]\\s*==\\s*password"
    message: "Direct password comparison - vulnerable to timing attack, use bcrypt.checkpw() (CWE-208)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-208"
      owasp: "A02:2021"
      tags: [authentication, timing-attack]

  # Storing password without hashing
  - id: py-password-store-plaintext
    pattern-regex: "self\\.password\\s*=\\s*(password|pwd|pass)"
    message: "Storing password without hashing - always hash passwords with bcrypt (CWE-256)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-256"
      owasp: "A02:2021"
      tags: [authentication, password]

  # ============================================
  # Flask Route Security
  # ============================================

  # Route without login_required that accesses current_user
  - id: py-route-no-login-required
    pattern-regex: "@app\\.route\\([^)]+\\)\\s*\\n\\s*def\\s+\\w+\\([^)]*\\):[^@]*current_user"
    message: "Route accessing current_user without @login_required - unauthorized access possible (CWE-862)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-862"
      tags: [authentication, flask]

  # Route modifying data without POST method
  - id: py-route-get-modify
    pattern-regex: "@app\\.route\\(['\"][^'\"]+['\"]\\)\\s*\\n\\s*def\\s+\\w+\\([^)]*\\):[^@]*(delete|remove|update|create|add|insert)"
    message: "Route modifying data without specifying POST method - may be vulnerable to CSRF via GET (CWE-352)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-352"
      tags: [csrf, flask]

  # ============================================
  # Session Security
  # ============================================

  # Session without expiry
  - id: py-session-no-expiry
    pattern-regex: "session\\[['\"]\\w+['\"]\\]\\s*="
    message: "Session value set - ensure PERMANENT_SESSION_LIFETIME is configured (CWE-613)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-613"
      tags: [session, flask]

  # Flask session secret key issues
  - id: py-flask-secret-short
    pattern-regex: "SECRET_KEY\\s*=\\s*['\"][^'\"]{1,16}['\"]"
    message: "Flask SECRET_KEY appears short - use at least 32 bytes of random data (CWE-331)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-331"
      tags: [session, flask, crypto]

  # ============================================
  # Request Handling Security
  # ============================================

  # request.form without validation
  - id: py-request-form-direct
    pattern-regex: "request\\.form\\[['\"]\\w+['\"]\\]"
    message: "Direct request.form access - use request.form.get() with validation (CWE-20)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-20"
      tags: [input-validation, flask]

  # request.args in SQL or command
  - id: py-request-args-injection
    pattern-regex: "(execute|system|popen|subprocess).*request\\.(args|form|json)"
    message: "User input from request directly in dangerous function - validate and sanitize (CWE-77)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-77"
      owasp: "A03:2021"
      tags: [injection, flask]

  # ============================================
  # JWT Security
  # ============================================

  # JWT decode without verify
  - id: py-jwt-no-verify
    pattern-regex: "jwt\\.decode\\([^)]*verify\\s*=\\s*False"
    message: "JWT decode with verify=False - signature not verified, token can be forged (CWE-347)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-347"
      owasp: "A02:2021"
      tags: [jwt, authentication]

  # JWT with algorithm none
  - id: py-jwt-none-algorithm
    pattern-regex: "jwt\\.(encode|decode)\\([^)]*algorithm\\s*=\\s*['\"]none['\"]"
    message: "JWT with 'none' algorithm - token can be forged without secret (CWE-327)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-327"
      tags: [jwt, crypto]

  # JWT secret from environment without fallback check
  - id: py-jwt-secret-env
    pattern-regex: "jwt\\.(encode|decode)\\([^)]*os\\.environ\\.get\\("
    message: "JWT secret from environment - ensure fallback is not used if env var missing (CWE-798)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-798"
      tags: [jwt, configuration]

  # ============================================
  # Debug / Development Mode
  # ============================================

  # Flask debug mode enabled
  - id: py-flask-debug-true
    pattern-regex: "app\\.run\\([^)]*debug\\s*=\\s*True"
    message: "Flask debug mode enabled - exposes debugger and auto-reloader in production (CWE-489)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-489"
      owasp: "A05:2021"
      tags: [debug, flask]

  # DEBUG = True in config
  - id: py-debug-config-true
    pattern-regex: "DEBUG\\s*=\\s*True"
    message: "DEBUG = True in configuration - disable in production (CWE-489)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-489"
      tags: [debug, configuration]

  # TESTING = True left enabled
  - id: py-testing-config-true
    pattern-regex: "TESTING\\s*=\\s*True"
    message: "TESTING = True in configuration - may bypass security checks (CWE-489)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-489"
      tags: [debug, configuration]

  # ============================================
  # Logging Security
  # ============================================

  # Logging password or secret
  - id: py-log-sensitive
    pattern-regex: "(logger|logging)\\.(info|debug|warning|error)\\([^)]*(?:password|secret|token|key|credential)"
    message: "Logging potentially sensitive data (password/secret/token) - mask before logging (CWE-532)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-532"
      tags: [logging, information-disclosure]

  # print() with sensitive data
  - id: py-print-sensitive
    pattern-regex: "print\\([^)]*(?:password|secret|api_key|token|credential)"
    message: "Printing sensitive data - remove or mask in production (CWE-532)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-532"
      tags: [logging, information-disclosure]

  # ============================================
  # Flask-CKEditor / Rich Text Stored XSS
  # ============================================

  # Flask-CKEditor import (indicates rich text XSS risk)
  - id: py-flask-ckeditor-import
    pattern-regex: "from\\s+flask_ckeditor\\s+import|import\\s+flask_ckeditor"
    message: "Flask-CKEditor detected - ensure stored content is sanitized before rendering with | safe filter (CWE-79)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-79"
      tags: [xss, stored-xss, ckeditor]

  # CKEditor field storing user content
  - id: py-ckeditor-field
    pattern-regex: "CKEditorField\\("
    message: "CKEditor field stores rich HTML - sanitize before storage or use Content Security Policy (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021"
      tags: [xss, stored-xss, ckeditor]

  # Storing HTML content in database (potential stored XSS source)
  - id: py-html-content-storage
    pattern-regex: "(text|content|body|description|message|comment)\\s*=\\s*(form|request)\\.(data|form)"
    message: "Storing user content - sanitize HTML to prevent stored XSS when rendering (CWE-79)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-79"
      tags: [xss, stored-xss]

  # ============================================
  # SQLAlchemy text() SQL Injection
  # ============================================

  # text() with f-string (SQL injection)
  - id: py-sqla-text-fstring
    pattern-regex: "text\\s*\\(\\s*f[\"']"
    message: "SQLAlchemy text() with f-string - SQL injection vulnerability, use bound parameters (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sqli, sqlalchemy]

  # text() with .format() (SQL injection)
  - id: py-sqla-text-format
    pattern-regex: "text\\s*\\([^)]+\\.format\\s*\\("
    message: "SQLAlchemy text() with .format() - SQL injection vulnerability, use bound parameters (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sqli, sqlalchemy]

  # text() with % formatting (SQL injection)
  - id: py-sqla-text-percent
    pattern-regex: "text\\s*\\([^)]+%\\s*[^)]"
    message: "SQLAlchemy text() with % formatting - SQL injection vulnerability, use bound parameters (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sqli, sqlalchemy]

  # session.execute with text() and f-string
  - id: py-session-execute-text-fstring
    pattern-regex: "session\\.execute\\s*\\(\\s*text\\s*\\(\\s*f[\"']"
    message: "session.execute with text(f'...') - SQL injection via string interpolation (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sqli, sqlalchemy]

  # ============================================
  # Download/Fetch Without URL Validation (SSRF)
  # ============================================

  # Generic download function with urlopen
  - id: py-download-urlopen-ssrf
    pattern-regex: "def\\s+download\\s*\\([^)]*url[^)]*\\)[^:]*:[^}]*urlopen\\s*\\(\\s*url\\s*\\)"
    message: "Download function using urlopen without URL validation - SSRF allows access to internal services (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021"
      tags: [ssrf]

  # Image download from user URL
  - id: py-image-download-ssrf
    pattern-regex: "(image|img|avatar|profile).*url.*urlopen|urlopen.*\\.(jpg|png|gif|jpeg|webp|image)"
    message: "Image download from URL - validate URL scheme and host to prevent SSRF (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # URL from parameter passed directly to request
  - id: py-param-url-ssrf
    pattern-regex: "def\\s+\\w+\\s*\\([^)]*url[^)]*\\)[^:]*:[^}]*(requests\\.(get|post)|urlopen|urllib)"
    message: "URL parameter passed to HTTP request - validate against allowlist to prevent SSRF (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      tags: [ssrf]

  # ============================================
  # IDOR - Delete Without Ownership Check
  # ============================================

  # Route with ID param doing delete
  - id: py-route-delete-by-id
    pattern-regex: "@(app|bp|blueprint)\\.route\\([\"'][^\"']*<int:\\w+>[^\"']*(delete|remove)"
    message: "Delete route with ID parameter - verify user owns resource before deletion to prevent IDOR (CWE-639)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021"
      tags: [idor, authorization]

  # session.delete without user check nearby
  - id: py-session-delete-no-user-check
    pattern-regex: "session\\.delete\\s*\\(\\s*\\w+\\s*\\)(?!.*current_user)"
    message: "Database delete operation - ensure ownership check before deletion (CWE-639)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      tags: [idor, authorization]

  # Getting object by ID then deleting without ownership check
  - id: py-get-and-delete-idor
    pattern-regex: "session\\.(get|query).*\\n.*session\\.delete"
    message: "Object retrieved then deleted - verify current_user owns object before deletion (CWE-639)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      tags: [idor, authorization]

  # ============================================
  # Registration/Invite Code Vulnerabilities
  # ============================================

  # Registration code in SQL query
  - id: py-registration-code-sqli
    pattern-regex: "(registration|invite|referral).*code.*text\\s*\\(\\s*f"
    message: "Registration/invite code in SQL query with f-string - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sqli, registration]

  # Weak registration code validation
  - id: py-registration-code-weak
    pattern-regex: "code\\s*==\\s*[\"'][^\"']{1,8}[\"']"
    message: "Short/weak registration code comparison - use cryptographically secure codes (CWE-330)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-330"
      tags: [crypto, registration]

  # ============================================
  # Pickle Deserialization from Cookies
  # ============================================

  # Pickle loads from cookie
  - id: py-pickle-cookie-rce
    pattern-regex: "pickle\\.loads\\s*\\([^)]*cookie|cookie[^)]*pickle\\.loads"
    message: "Pickle deserialization from cookie - RCE vulnerability, use JSON or signed cookies (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      owasp: "A08:2021"
      tags: [deserialization, rce]

  # Base64 decode then pickle (common pattern)
  - id: py-b64-pickle-chain
    pattern-regex: "pickle\\.loads\\s*\\(\\s*(base64\\.)?b64decode|b64decode[^)]*\\)[^}]*pickle\\.loads"
    message: "Base64 decode to pickle - insecure deserialization chain, attacker-controlled RCE (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      owasp: "A08:2021"
      tags: [deserialization, rce]

  # ============================================
  # No Rate Limiting Detection
  # ============================================

  # Login route without rate limit decorator
  - id: py-login-no-rate-limit
    pattern-regex: "@(app|bp)\\.route\\([\"']/(login|signin|auth)[\"'][^)]*\\)\\s*\\ndef"
    message: "Login endpoint without visible rate limiting - add flask-limiter to prevent brute force (CWE-307)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-307"
      tags: [brute-force, authentication]

  # Password reset without rate limit
  - id: py-password-reset-no-rate-limit
    pattern-regex: "@(app|bp)\\.route\\([\"']/(reset|forgot|password)[^\"']*[\"'][^)]*\\)\\s*\\ndef"
    message: "Password reset endpoint without rate limiting - vulnerable to enumeration attacks (CWE-307)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-307"
      tags: [brute-force, authentication]

  # Signup without rate limit
  - id: py-signup-no-rate-limit
    pattern-regex: "@(app|bp)\\.route\\([\"']/(signup|register)[\"'][^)]*\\)\\s*\\ndef"
    message: "Registration endpoint without rate limiting - vulnerable to spam/abuse (CWE-307)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-307"
      tags: [brute-force, registration]

  # ============================================
  # Bcrypt Timing Attack Prevention
  # ============================================

  # checkpw result used in conditional
  - id: py-bcrypt-checkpw-timing
    pattern-regex: "if\\s+(not\\s+)?bcrypt\\.checkpw|if\\s+(not\\s+)?checkpw"
    message: "bcrypt.checkpw in conditional - ensure consistent response time to prevent timing attacks (CWE-208)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-208"
      tags: [timing-attack, authentication]

  # ============================================
  # SQLAlchemy Session Patterns
  # ============================================

  # Session not using context manager
  - id: py-sqlalchemy-session-no-context
    pattern-regex: "session\\s*=\\s*Session\\(\\)(?!.*with)"
    message: "SQLAlchemy Session without context manager - use 'with Session() as session:' for proper cleanup (CWE-404)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-404"
      tags: [sqlalchemy, resource-leak]

  # Commit without try/except
  - id: py-sqlalchemy-commit-no-except
    pattern-regex: "session\\.commit\\(\\)(?!.*except)"
    message: "session.commit() without exception handling - wrap in try/except for rollback on failure (CWE-754)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-754"
      tags: [sqlalchemy, error-handling]

  # ============================================
  # Missing Authentication on Routes
  # ============================================

  # POST route without @login_required
  - id: py-post-route-no-auth
    pattern-regex: "@(app|bp)\\.route\\([^)]*methods\\s*=\\s*\\[[^]]*[\"']POST[\"'][^]]*\\][^)]*\\)\\s*\\ndef\\s+(?!login|signup|register|do_login|do_signup)"
    message: "POST route without @login_required - verify authentication is enforced (CWE-306)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-306"
      owasp: "A07:2021"
      tags: [authentication, flask]

  # Route accessing session/db without auth decorator
  - id: py-route-db-no-auth
    pattern-regex: "@(app|bp)\\.route\\([^)]+\\)\\s*\\ndef\\s+\\w+\\([^)]*\\):[^@]*(Session\\(\\)|db\\.session)"
    message: "Route accessing database without visible @login_required - verify authentication (CWE-306)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-306"
      tags: [authentication, flask]

  # ============================================
  # Hardcoded Secrets in Seed Data
  # ============================================

  # Hardcoded static UUID (registration/invite codes)
  - id: py-hardcoded-static-uuid
    pattern-regex: "static_code\\s*=\\s*[\"'][0-9a-f-]{36}[\"']"
    message: "Hardcoded static registration/invite code - generate dynamically or use environment variable (CWE-798)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-798"
      tags: [hardcoded-secrets, seed-data]

  # Weak seed password patterns
  - id: py-weak-seed-password
    pattern-regex: "hashpw\\s*\\(\\s*b[\"'](user|admin|test|password|123|pass)[\"']"
    message: "Weak password in seed data - use strong passwords even in development (CWE-521)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-521"
      tags: [password, seed-data]

  # Predictable test credentials
  - id: py-predictable-credentials
    pattern-regex: "(user|admin|test)@.*\\.com.*hashpw|hashpw.*b[\"'](user|admin|test)[\"']"
    message: "Predictable test credentials - attackers check common email/password combinations (CWE-798)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-798"
      tags: [credentials, seed-data]

  # ============================================
  # Auth State Exposure Endpoints
  # ============================================

  # /is_logged_in or /check_auth style endpoints
  - id: py-auth-check-endpoint
    pattern-regex: "@(app|bp)\\.route\\([\"']/(is_logged_in|check_auth|auth_status|logged_in|session_check)[\"']"
    message: "Auth check endpoint - ensure no sensitive user data is exposed (CWE-200)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-200"
      tags: [authentication, information-disclosure]

  # Returning current_user attributes in JSON
  - id: py-current-user-json-exposure
    pattern-regex: "jsonify\\s*\\([^)]*current_user\\.(email|id|username|is_admin)"
    message: "Exposing current_user attributes in JSON response - may leak sensitive info (CWE-200)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      tags: [information-disclosure, flask]

  # ============================================
  # Database Configuration Security
  # ============================================

  # SQLite/SQLAlchemy echo=True (query logging)
  - id: py-sqlalchemy-echo-true
    pattern-regex: "create_engine\\s*\\([^)]*echo\\s*=\\s*True"
    message: "SQLAlchemy echo=True logs all SQL queries - disable in production (CWE-532)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-532"
      tags: [logging, sqlalchemy, configuration]

  # SQLite database in project directory
  - id: py-sqlite-project-dir
    pattern-regex: "sqlite:///.*database\\.db|sqlite:///.*\\.db"
    message: "SQLite database file - ensure not web-accessible and properly backed up (CWE-219)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-219"
      tags: [database, configuration]

  # ============================================
  # Password Handling Issues
  # ============================================

  # Password encode before bcrypt compare
  - id: py-bcrypt-encode-issue
    pattern-regex: "\\.password\\.encode\\([\"']utf-8[\"']\\)"
    message: "Password encoding before bcrypt - ensure consistent encoding, bcrypt expects bytes (CWE-261)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-261"
      tags: [password, bcrypt]

  # Password field without validators
  - id: py-password-field-no-validator
    pattern-regex: "PasswordField\\s*\\([^)]*\\)(?!.*validators)"
    message: "PasswordField without validators - add Length, DataRequired validators (CWE-521)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-521"
      tags: [password, wtforms]

  # ============================================
  # User Enumeration Patterns
  # ============================================

  # Query user then check if None with different messages
  - id: py-user-query-enumeration
    pattern-regex: "user\\s*=.*query.*\\n.*if\\s+(not\\s+)?user"
    message: "User lookup pattern - ensure same error message for user not found and wrong password (CWE-204)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-204"
      tags: [user-enumeration, authentication]

  # Separate flash messages for user vs password
  - id: py-separate-auth-errors
    pattern-regex: "flash\\([\"'].*[Uu]ser.*[\"']\\).*\\n.*flash\\([\"'].*[Pp]assword.*[\"']\\)|flash\\([\"'].*[Pp]assword.*[\"']\\).*\\n.*flash\\([\"'].*[Uu]ser.*[\"']\\)"
    message: "Separate error messages for user/password - use generic 'Invalid credentials' (CWE-204)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-204"
      tags: [user-enumeration, authentication]

  # ============================================
  # Logic Flaws
  # ============================================

  # Unconditional logout after login attempt
  - id: py-unconditional-logout
    pattern-regex: "login_user\\([^)]+\\).*\\n.*logout_user\\(\\)"
    message: "logout_user() called after login_user() - possible logic flaw (CWE-287)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-287"
      tags: [authentication, logic-flaw]

  # Return after flash without conditional
  - id: py-flash-return-logic
    pattern-regex: "flash\\([^)]+\\)\\s*\\n\\s*return\\s+redirect"
    message: "Flash then redirect pattern - verify this is in correct conditional branch (CWE-287)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-287"
      tags: [logic-flaw, flask]

  # ============================================
  # IDOR via User ID Parameter
  # ============================================

  # Route with user_id accessing other user's data
  - id: py-route-user-id-idor
    pattern-regex: "@(app|bp)\\.route\\([\"'][^\"']*<int:user_id>[^\"']*[\"']"
    message: "Route with user_id parameter - verify authorization check against current_user (CWE-639)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021"
      tags: [idor, authorization]

  # Accessing notes/resources by user_id from URL
  - id: py-notes-by-user-id
    pattern-regex: "get_notes.*user_id|notes.*filter.*user_id"
    message: "Accessing notes by user_id - verify current_user.id == user_id (CWE-639)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-639"
      tags: [idor, authorization]

  # ============================================
  # Filtered Values Logic Issues
  # ============================================

  # Accessing key that was filtered out
  - id: py-filtered-dict-access
    pattern-regex: "filtered.*=.*\\{.*for.*if.*\\}.*\\n.*filtered.*\\.get\\("
    message: "Accessing filtered dict - verify key wasn't excluded by filter (CWE-754)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-754"
      tags: [logic-flaw]

  # Dict comprehension filtering then accessing original key
  - id: py-dict-filter-then-access
    pattern-regex: "if\\s+k\\s+(!=|not in).*\\}.*\\n.*\\[.*password.*\\]"
    message: "Dict filtering pattern - verify filtered key is not accessed later (CWE-754)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-754"
      tags: [logic-flaw]

  # ============================================
  # Jinja2 Dynamic Template Injection (SSTI)
  # ============================================

  # Jinja2 Template() with user input - critical SSTI
  - id: py-jinja2-template-dynamic
    pattern-regex: "Template\\s*\\([^)]*\\+|Template\\s*\\(\\s*f[\"']|Template\\s*\\([^)]*\\.format\\("
    message: "Jinja2 Template() with dynamic content - Server-Side Template Injection vulnerability (CWE-1336)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      owasp: "A03:2021"
      tags: [ssti, template-injection, jinja2]

  # Jinja2 Environment.from_string with user input
  - id: py-jinja2-env-from-string
    pattern-regex: "(Environment|env)\\s*\\(\\s*\\)\\s*\\.from_string\\s*\\("
    message: "Jinja2 Environment.from_string() - SSTI if content is user-controlled (CWE-1336)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      owasp: "A03:2021"
      tags: [ssti, template-injection, jinja2]

  # Template concatenation with user input
  - id: py-template-string-concat
    pattern-regex: "Template\\s*\\(\\s*[\"'][^\"']*[\"']\\s*\\+\\s*\\w+\\s*\\)"
    message: "Template string concatenation - SSTI vulnerability if variable is user-controlled (CWE-1336)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      owasp: "A03:2021"
      tags: [ssti, template-injection]

  # render_template_string with user input
  - id: py-flask-render-template-string-var
    pattern-regex: "render_template_string\\s*\\([^)]*\\+|render_template_string\\s*\\(\\s*f[\"']"
    message: "render_template_string with dynamic content - SSTI vulnerability (CWE-1336)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-1336"
      owasp: "A03:2021"
      tags: [ssti, template-injection, flask]

  # ============================================
  # HTTP Header Injection
  # ============================================

  # Host header used in HTML response
  - id: py-host-header-html
    pattern-regex: "request\\.headers\\[[\"']Host[\"']\\].*href|href.*request\\.headers"
    message: "Host header in HTML href - HTTP Response Splitting/XSS risk (CWE-113)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-113"
      owasp: "A03:2021"
      tags: [header-injection, xss]

  # Request header directly in response
  - id: py-header-reflection
    pattern-regex: "h\\s*=\\s*request\\.headers\\[|header.*=.*request\\.headers\\.get"
    message: "Request header assigned to variable - ensure sanitization before use in response (CWE-113)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-113"
      tags: [header-injection]

  # Headers in f-string response
  - id: py-header-fstring-response
    pattern-regex: "return.*f[\"'].*\\{.*headers.*\\}"
    message: "Request headers in f-string response - header injection risk (CWE-113)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-113"
      tags: [header-injection, xss]

  # ============================================
  # Bare Except Masking Security Operations
  # ============================================

  # File open with bare except
  - id: py-file-open-bare-except
    pattern-regex: "try:\\s*\\n\\s*.*open\\s*\\([^)]+\\).*\\n\\s*except:\\s*\\n"
    message: "File open with bare except - masks path traversal attacks (CWE-390)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-390"
      tags: [exception-handling, path-traversal]

  # Request access with bare except
  - id: py-request-bare-except
    pattern-regex: "try:\\s*\\n\\s*.*request\\.(headers|args|form|json)\\[.*\\n\\s*except:\\s*\\n"
    message: "Request access with bare except - may mask injection attempts (CWE-390)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-390"
      tags: [exception-handling]

  # Database operation with bare except
  - id: py-db-bare-except
    pattern-regex: "try:\\s*\\n\\s*.*(execute|query|cursor).*\\n\\s*except:\\s*\\n"
    message: "Database operation with bare except - may mask SQL injection attempts (CWE-390)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-390"
      tags: [exception-handling, sqli]

  # Catch all Exception silently
  - id: py-silent-exception-pass
    pattern-regex: "except\\s+(Exception|BaseException).*:\\s*\\n\\s*pass"
    message: "Silently catching all exceptions - may hide security errors (CWE-390)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-390"
      tags: [exception-handling]

  # ============================================
  # Exception Information Disclosure
  # ============================================

  # Exception in JSON response
  - id: py-exception-json-response
    pattern-regex: "return\\s*\\{[^}]*[\"']error[\"']:\\s*(str\\(e\\)|e\\.message|repr\\(e\\))"
    message: "Exception details in JSON response - information disclosure (CWE-209)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      owasp: "A01:2021"
      tags: [information-disclosure]

  # Exception in f-string response
  - id: py-exception-fstring-response
    pattern-regex: "return.*f[\"'].*\\{e\\}|return.*f[\"'].*\\{(str\\(e\\)|repr\\(e\\)|e\\.args)\\}"
    message: "Exception in f-string response - leaks internal error details (CWE-209)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      owasp: "A01:2021"
      tags: [information-disclosure]

  # Flask abort with exception details
  - id: py-flask-abort-exception
    pattern-regex: "abort\\s*\\([^,]+,\\s*(str\\(e\\)|e\\.message|description=.*e)"
    message: "Flask abort with exception details - information disclosure (CWE-209)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-209"
      tags: [information-disclosure, flask]

  # Traceback in response
  - id: py-traceback-response
    pattern-regex: "traceback\\.(format_exc|print_exc|format_exception).*return|return.*traceback"
    message: "Traceback in response - exposes internal code structure (CWE-209)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-209"
      owasp: "A01:2021"
      tags: [information-disclosure]

  # ============================================
  # Tarfile/Zipfile Path Traversal
  # ============================================

  # Tarfile extractall without validation
  - id: py-tarfile-extractall
    pattern-regex: "tarfile\\.(open|TarFile).*\\.extractall\\s*\\("
    message: "tarfile.extractall() - validate members for path traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021"
      tags: [path-traversal, archive]

  # Tarfile extract without checking member name
  - id: py-tarfile-extract-member
    pattern-regex: "tarfile.*\\.extract\\s*\\(\\s*member|tarfile.*\\.extract\\s*\\(\\s*\\w+\\s*\\)"
    message: "tarfile.extract() - check member.name for ../ before extraction (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, archive]

  # Zipfile extractall without validation
  - id: py-zipfile-extractall
    pattern-regex: "zipfile\\.ZipFile.*\\.extractall\\s*\\("
    message: "zipfile.extractall() - validate member names for path traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021"
      tags: [path-traversal, archive]

  # ZipFile extract without checking
  - id: py-zipfile-extract-member
    pattern-regex: "ZipFile.*\\.extract\\s*\\(|zipfile.*\\.extract\\s*\\("
    message: "zipfile.extract() - verify filename doesn't contain ../ (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, archive]

  # Tarfile user input in open
  - id: py-tarfile-user-input
    pattern-regex: "tarfile\\.(open|TarFile)\\s*\\(\\s*(request\\.|user_input|filename|path)"
    message: "tarfile with user input - potential path traversal or zip bomb (CWE-22)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, archive]

  # ============================================
  # SSL/TLS Verification Disabled (All Methods)
  # ============================================

  # requests.put with verify=False
  - id: py-requests-put-verify-false
    pattern-regex: "requests\\.put\\s*\\([^)]*verify\\s*=\\s*False"
    message: "requests.put() with SSL verification disabled - MITM risk (CWE-295)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-295"
      owasp: "A02:2021"
      tags: [ssl, mitm]

  # requests.patch with verify=False
  - id: py-requests-patch-verify-false
    pattern-regex: "requests\\.patch\\s*\\([^)]*verify\\s*=\\s*False"
    message: "requests.patch() with SSL verification disabled - MITM risk (CWE-295)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-295"
      owasp: "A02:2021"
      tags: [ssl, mitm]

  # requests.delete with verify=False
  - id: py-requests-delete-verify-false
    pattern-regex: "requests\\.delete\\s*\\([^)]*verify\\s*=\\s*False"
    message: "requests.delete() with SSL verification disabled - MITM risk (CWE-295)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-295"
      owasp: "A02:2021"
      tags: [ssl, mitm]

  # requests.head with verify=False
  - id: py-requests-head-verify-false
    pattern-regex: "requests\\.head\\s*\\([^)]*verify\\s*=\\s*False"
    message: "requests.head() with SSL verification disabled - MITM risk (CWE-295)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-295"
      owasp: "A02:2021"
      tags: [ssl, mitm]

  # requests.options with verify=False
  - id: py-requests-options-verify-false
    pattern-regex: "requests\\.options\\s*\\([^)]*verify\\s*=\\s*False"
    message: "requests.options() with SSL verification disabled - MITM risk (CWE-295)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-295"
      owasp: "A02:2021"
      tags: [ssl, mitm]

  # Session with verify=False
  - id: py-requests-session-verify-false
    pattern-regex: "Session\\(\\).*\\.verify\\s*=\\s*False|session\\.verify\\s*=\\s*False"
    message: "Requests session with SSL verification disabled - MITM risk (CWE-295)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-295"
      owasp: "A02:2021"
      tags: [ssl, mitm]

  # ============================================
  # YAML Unsafe Loader Variants
  # ============================================

  # yaml.load with explicit UnsafeLoader
  - id: py-yaml-unsafe-loader
    pattern-regex: "yaml\\.load\\s*\\([^)]*Loader\\s*=\\s*yaml\\.UnsafeLoader"
    message: "yaml.load with UnsafeLoader - arbitrary code execution (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      owasp: "A08:2021"
      tags: [deserialization, yaml]

  # yaml.load_all with UnsafeLoader
  - id: py-yaml-load-all-unsafe
    pattern-regex: "yaml\\.load_all\\s*\\([^)]*Loader\\s*=\\s*yaml\\.UnsafeLoader"
    message: "yaml.load_all with UnsafeLoader - arbitrary code execution (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      owasp: "A08:2021"
      tags: [deserialization, yaml]

  # yaml.full_load (deprecated but still dangerous)
  - id: py-yaml-full-load
    pattern-regex: "yaml\\.full_load\\s*\\("
    message: "yaml.full_load() - can execute arbitrary Python objects (CWE-502)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"
      tags: [deserialization, yaml]

  # ============================================
  # HTTPConnection/HTTPSConnection SSRF
  # ============================================

  # HTTPConnection with user input
  - id: py-httpconnection-user-input
    pattern-regex: "HTTPConnection\\s*\\(\\s*(request\\.|user_input|host|url)"
    message: "HTTPConnection with user-controlled host - SSRF vulnerability (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021"
      tags: [ssrf]

  # HTTPSConnection with user input
  - id: py-httpsconnection-user-input
    pattern-regex: "HTTPSConnection\\s*\\(\\s*(request\\.|user_input|host|url)"
    message: "HTTPSConnection with user-controlled host - SSRF vulnerability (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021"
      tags: [ssrf]

  # ============================================
  # Hardcoded Database Credentials
  # ============================================

  # INSERT with admin/admin credentials
  - id: py-hardcoded-admin-creds-insert
    pattern-regex: "INSERT INTO.*VALUES.*[\"']admin[\"'].*[\"']admin[\"']"
    message: "Hardcoded admin credentials in database seed - use environment variables (CWE-798)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      tags: [hardcoded-credentials]

  # INSERT with root/root credentials
  - id: py-hardcoded-root-creds-insert
    pattern-regex: "INSERT INTO.*VALUES.*[\"']root[\"'].*[\"']root[\"']"
    message: "Hardcoded root credentials in database seed - use environment variables (CWE-798)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      tags: [hardcoded-credentials]

  # INSERT with user/password credentials
  - id: py-hardcoded-user-password-insert
    pattern-regex: "INSERT INTO.*VALUES.*[\"']user[\"'].*[\"']password[\"']"
    message: "Hardcoded credentials in database seed - use strong passwords (CWE-798)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-798"
      tags: [hardcoded-credentials]

  # ============================================
  # Insecure Random for Security Operations
  # ============================================

  # random for token generation
  - id: py-random-token
    pattern-regex: "token\\s*=\\s*[\"']\\s*\\.join\\s*\\(\\s*random\\.(choice|choices|sample)"
    message: "Using random module for token - use secrets module instead (CWE-330)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-330"
      owasp: "A02:2021"
      tags: [weak-random, cryptography]

  # random for session ID
  - id: py-random-session-id
    pattern-regex: "session_id\\s*=.*random\\.(randint|choice|random)"
    message: "Using random module for session ID - use secrets.token_urlsafe() (CWE-330)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-330"
      owasp: "A02:2021"
      tags: [weak-random, session]

  # random.randint for security value
  - id: py-random-randint-security
    pattern-regex: "(otp|code|pin|key|nonce)\\s*=\\s*random\\.randint"
    message: "Using random.randint for security value - use secrets module (CWE-330)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-330"
      tags: [weak-random]

  # ============================================
  # ReDoS with User Input
  # ============================================

  # Regex with request input
  - id: py-regex-request-input
    pattern-regex: "re\\.(match|search|findall)\\s*\\([^,]+,\\s*request\\."
    message: "Regex matching user input - ensure pattern is not vulnerable to ReDoS (CWE-1333)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1333"
      tags: [redos, regex]

  # Catastrophic backtracking patterns
  - id: py-redos-nested-quantifier
    pattern-regex: "re\\.(compile|match|search)\\s*\\([^)]*\\(\\.[+*]\\)\\+[^)]*\\)"
    message: "Regex with nested quantifiers - potential ReDoS vulnerability (CWE-1333)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1333"
      tags: [redos, regex]

  # ============================================
  # Flask Response Security
  # ============================================

  # Returning entire user object
  - id: py-flask-return-user-object
    pattern-regex: "return.*jsonify\\s*\\(\\s*user\\s*\\)|return.*\\{.*[\"']user[\"']:\\s*user\\s*\\}"
    message: "Returning entire user object - may expose sensitive fields like password hash (CWE-200)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      tags: [information-disclosure]

  # Returning query results directly
  - id: py-flask-return-query-result
    pattern-regex: "return.*jsonify\\s*\\(\\s*\\w+\\.query\\.all\\(\\)"
    message: "Returning raw query results - ensure sensitive fields are filtered (CWE-200)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-200"
      tags: [information-disclosure]

  # ============================================
  # Unsafe File Operations
  # ============================================

  # shutil.copy with user input
  - id: py-shutil-copy-user-input
    pattern-regex: "shutil\\.(copy|copy2|copyfile)\\s*\\(\\s*(request\\.|user_input|src|source)"
    message: "shutil copy with user input - potential path traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, file-operations]

  # shutil.move with user input
  - id: py-shutil-move-user-input
    pattern-regex: "shutil\\.move\\s*\\(\\s*(request\\.|user_input|src|source)"
    message: "shutil.move with user input - potential path traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, file-operations]

  # os.rename with user input
  - id: py-os-rename-user-input
    pattern-regex: "os\\.rename\\s*\\(\\s*(request\\.|user_input|src|old)"
    message: "os.rename with user input - potential path traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, file-operations]

  # pathlib write with user content
  - id: py-pathlib-write-user
    pattern-regex: "Path\\s*\\([^)]+\\)\\.write_(text|bytes)\\s*\\(\\s*(request\\.|user_input)"
    message: "pathlib write with user content - ensure path and content are validated (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      tags: [path-traversal, file-operations]

  # ============================================
  # Django Security - DjangoGoat Patterns
  # ============================================

  # Django raw SQL with string formatting (% operator)
  - id: py-django-raw-sql-format
    pattern-regex: "objects\\.raw\\s*\\([^)]*%\\s*\\("
    message: "Django raw SQL with string formatting (%) - use parameterized queries to prevent SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sql-injection, django, djangogoat]

  # Django raw SQL with f-string
  - id: py-django-raw-fstring
    pattern-regex: "objects\\.raw\\s*\\(\\s*f['\"]"
    message: "Django raw SQL with f-string - use parameterized queries to prevent SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sql-injection, django, djangogoat]

  # Django raw with query variable built from user input
  - id: py-django-raw-query-var
    patterns:
      - pattern: |
          $QUERY = "..." % $VARS
          ...
          $MODEL.objects.raw($QUERY)
      - pattern: |
          $QUERY = f"..."
          ...
          $MODEL.objects.raw($QUERY)
    message: "Django raw SQL with user-controlled query - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sql-injection, django, djangogoat]

  # Empty password validators
  - id: py-django-no-password-validators
    pattern: "AUTH_PASSWORD_VALIDATORS = []"
    message: "Django password validators disabled - weak passwords will be allowed (CWE-521)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-521"
      owasp: "A07:2021"
      tags: [authentication, password, django, djangogoat]

  # SESSION_COOKIE_HTTPONLY disabled
  - id: py-django-session-cookie-httponly-false
    pattern: "SESSION_COOKIE_HTTPONLY = False"
    message: "Django session cookie HttpOnly disabled - XSS can steal session cookies (CWE-1004)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-1004"
      owasp: "A05:2021"
      tags: [session, cookie, django, djangogoat]

  # SESSION_COOKIE_SECURE disabled
  - id: py-django-session-cookie-secure-false
    pattern: "SESSION_COOKIE_SECURE = False"
    message: "Django session cookie Secure flag disabled - cookies sent over HTTP (CWE-614)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-614"
      tags: [session, cookie, django]

  # Cleartext password field in model
  - id: py-django-cleartext-password-field
    pattern-regex: "cleartext_password|plain_password|password_plaintext|raw_password"
    message: "Cleartext password field detected - passwords must be hashed (CWE-256)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-256"
      owasp: "A02:2021"
      tags: [password, plaintext, django, djangogoat]

  # Django serve() for media files without auth
  - id: py-django-serve-media
    pattern-regex: "serve\\s*,\\s*\\{\\s*['\"]document_root['\"]"
    message: "Django serve() for media files - ensure access control is implemented (CWE-552)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-552"
      tags: [file-access, media, django, djangogoat]

  # Django ALLOWED_HOSTS wildcard
  - id: py-django-allowed-hosts-wildcard
    patterns:
      - pattern: "ALLOWED_HOSTS = ['*']"
      - pattern: 'ALLOWED_HOSTS = ["*"]'
    message: "Django ALLOWED_HOSTS allows all hosts - configure specific hosts (CWE-16)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-16"
      tags: [configuration, django]

  # Django CSRF_COOKIE_SECURE disabled
  - id: py-django-csrf-cookie-secure-false
    pattern: "CSRF_COOKIE_SECURE = False"
    message: "Django CSRF cookie not secure - CSRF token sent over HTTP (CWE-352)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-352"
      tags: [csrf, cookie, django]

  # ============================================
  # Django Security - DjangoGoat Deep Analysis
  # ============================================

  # Hardcoded SECRET_KEY (CWE-798)
  - id: py-django-hardcoded-secret-key
    pattern-regex: "SECRET_KEY\\s*=\\s*['\"][^'\"]{20,}['\"]"
    message: "Django SECRET_KEY is hardcoded - use environment variables for secrets (CWE-798)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-798"
      owasp: "A02:2021"
      tags: [secrets, django, hardcoded-credentials]

  # Missing SECURE_SSL_REDIRECT
  - id: py-django-ssl-redirect-false
    pattern: "SECURE_SSL_REDIRECT = False"
    message: "Django SSL redirect disabled - HTTP traffic not redirected to HTTPS (CWE-319)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-319"
      tags: [ssl, https, django]

  # Missing SESSION_COOKIE_SECURE
  - id: py-django-session-cookie-insecure
    pattern: "SESSION_COOKIE_SECURE = False"
    message: "Django session cookie not secure - session sent over HTTP (CWE-614)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-614"
      owasp: "A02:2021"
      tags: [session, cookie, django]

  # Missing X_FRAME_OPTIONS (clickjacking)
  - id: py-django-xframe-options-disabled
    patterns:
      - pattern: "X_FRAME_OPTIONS = 'ALLOWALL'"
      - pattern: 'X_FRAME_OPTIONS = "ALLOWALL"'
      - pattern: "X_FRAME_OPTIONS = None"
    message: "Django X-Frame-Options disabled - clickjacking vulnerability (CWE-1021)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-1021"
      tags: [clickjacking, headers, django]

  # IDOR - get_object_or_404 without ownership check in view
  - id: py-django-idor-get-object
    pattern: |
      def $FUNC(request, $PK):
        ...
        $OBJ = get_object_or_404($MODEL, pk=$PK)
        ...
        return render(...)
    message: "Potential IDOR - object fetched by pk without ownership verification (CWE-639)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021"
      tags: [idor, authorization, django]

  # IDOR - direct object access pattern
  - id: py-django-idor-direct-pk
    pattern: |
      $OBJ = get_object_or_404($MODEL, pk=pk)
      return render(request, $TEMPLATE, {..., $KEY: $OBJ})
    message: "Potential IDOR - verify user has permission to access this object (CWE-639)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-639"
      owasp: "A01:2021"
      tags: [idor, authorization, django]

  # View function without login_required accessing user data
  - id: py-django-view-no-login-required
    pattern-regex: "^def\\s+\\w+\\(request[^)]*\\):\\s*\\n(?!.*@login_required)[^\\n]*get_object_or_404\\(User"
    message: "View accessing User without @login_required decorator - missing authentication (CWE-306)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-306"
      owasp: "A07:2021"
      tags: [authentication, missing-auth, django]

  # Profile view pattern without authentication
  - id: py-django-profile-no-auth
    pattern: |
      def profile(request, $PK):
        ...
        $USER = get_object_or_404(User, pk=$PK)
        ...
    message: "Profile view may be missing authentication - ensure @login_required is applied (CWE-306)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-306"
      owasp: "A07:2021"
      tags: [authentication, profile, django]

  # Django SECURE_BROWSER_XSS_FILTER disabled
  - id: py-django-xss-filter-false
    pattern: "SECURE_BROWSER_XSS_FILTER = False"
    message: "Django browser XSS filter disabled - browser XSS protection not enabled (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [xss, headers, django]

  # Django SECURE_CONTENT_TYPE_NOSNIFF disabled
  - id: py-django-content-type-nosniff-false
    pattern: "SECURE_CONTENT_TYPE_NOSNIFF = False"
    message: "Django content type nosniff disabled - MIME sniffing attacks possible (CWE-16)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-16"
      tags: [mime, headers, django]

  # Raw SQL with .format() - another SQLi pattern
  - id: py-django-raw-sql-format-method
    pattern: |
      $QUERY = "...".format(...)
      ...
      $MODEL.objects.raw($QUERY)
    message: "Django raw SQL with .format() - SQL injection vulnerability (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sql-injection, django]

  # User.objects.raw with string formatting
  - id: py-django-user-raw-sql
    pattern-regex: "User\\.objects\\.raw\\s*\\([^)]*%\\s*\\("
    message: "User.objects.raw() with string formatting - SQL injection (CWE-89)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      owasp: "A03:2021"
      tags: [sql-injection, django, authentication]

  # ============================================
  # FastAPI Security Patterns
  # ============================================

  # CWE-22: Path Traversal - open() with variable (any variable, not just request)
  - id: py-path-traversal-open-var
    pattern: open($VAR, ...)
    message: "File open with variable path - validate path to prevent path traversal (CWE-22)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"
      owasp: "A01:2021 Broken Access Control"
      tags: [path-traversal, file-operations]

  # CWE-23: Path Traversal - open(os.path.join(...)) with any variable
  - id: py-path-traversal-open-join
    pattern: open(os.path.join(...), ...)
    message: "File open with os.path.join() - validate path segments to prevent relative path traversal (CWE-23)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-23"
      owasp: "A01:2021 Broken Access Control"
      tags: [path-traversal, file-operations]

  # CWE-918: SSRF - requests.get with object attribute (e.g., ssrf_data.url)
  - id: py-ssrf-requests-obj-attr
    pattern: requests.get($OBJ.$ATTR)
    message: "SSRF - requests.get() with object attribute - validate URL against allowlist (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021 Server-Side Request Forgery"
      tags: [ssrf, requests]

  # SSRF - requests.post with object attribute
  - id: py-ssrf-requests-post-obj-attr
    pattern: requests.post($OBJ.$ATTR, ...)
    message: "SSRF - requests.post() with object attribute - validate URL against allowlist (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021 Server-Side Request Forgery"
      tags: [ssrf, requests]

  # SSRF - any requests method with object attribute
  - id: py-ssrf-requests-method-obj-attr
    pattern: requests.$METHOD($OBJ.$ATTR, ...)
    message: "SSRF - requests.$METHOD() with object attribute - validate URL against allowlist (CWE-918)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021 Server-Side Request Forgery"
      tags: [ssrf, requests]

  # CWE-285: Authorization - returning item without checking user permissions
  - id: py-fastapi-return-item-no-auth
    pattern: return $ITEM
    message: "Returning item directly - verify user has access to this item before returning (CWE-285)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-285"
      owasp: "A01:2021 Broken Access Control"
      tags: [authorization, bola]

  # ============================================
  # BOLA/IDOR (Broken Object Level Authorization)
  # ============================================

  # BOLA - Returning database item without ownership check
  - id: py-bola-return-db-item
    pattern: |
      if $ITEM is None:
          ...
      return $ITEM
    message: "BOLA vulnerability - returning item without ownership verification (CWE-285)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-285"
      owasp: "API1:2023 Broken Object Level Authorization"
      tags: [bola, idor, authorization]

  # BOLA - FastAPI route with ID parameter
  - id: py-bola-fastapi-id-route
    pattern-regex: "@router\\.(get|post|put|delete|patch)\\([^)]*\\{id\\}"
    message: "API endpoint with ID parameter - ensure object-level authorization is enforced (BOLA)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-285"
      owasp: "API1:2023 Broken Object Level Authorization"
      tags: [bola, idor, fastapi]

  # ============================================
  # Weak URL Validation (SSRF Bypass)
  # ============================================

  # Weak regex for domain validation - can be bypassed
  - id: py-ssrf-weak-domain-regex
    pattern-regex: "re\\.compile\\(r?['\"]\\.\\.?\\.\\w+\\.\\w+"
    message: "Weak domain regex validation - pattern like '.*\\.domain\\.com' can be bypassed with 'domain.com.evil.com' (CWE-918)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"
      owasp: "A10:2021 Server-Side Request Forgery"
      tags: [ssrf, regex, bypass]

  # Regex domain validation without end anchor
  - id: py-ssrf-regex-no-anchor
    pattern-regex: "valid.*re.*=.*re\\.compile.*\\.com[^$]"
    message: "Domain regex without end anchor ($) - may allow bypass via subdomains (CWE-918)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-918"
      tags: [ssrf, regex]

  # ============================================
  # Weak Authentication Patterns
  # ============================================

  # Naive bearer token extraction
  - id: py-auth-naive-bearer-split
    pattern: $VAR.split(" ")[-1]
    message: "Naive bearer token extraction - validate 'Bearer' prefix before extracting token (CWE-287)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-287"
      owasp: "A07:2021 Identification and Authentication Failures"
      tags: [authentication, bearer, jwt]

  # Authorization header without Bearer validation
  - id: py-auth-header-no-bearer-check
    pattern-regex: "authorization.*split.*\\[-1\\]"
    message: "Authorization header parsed without Bearer prefix validation (CWE-287)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-287"
      owasp: "A07:2021 Identification and Authentication Failures"
      tags: [authentication, authorization]

  # Missing None check before split
  - id: py-auth-split-no-none-check
    pattern-regex: "Header\\(\\).*\\.split"
    message: "Header value split without None check - may raise AttributeError"
    languages: [python]
    severity: INFO
    metadata:
      tags: [error-handling, authentication]

  # ============================================
  # FastAPI Security Misconfiguration
  # ============================================

  # FastAPI returning JSONResponse with error details
  - id: py-fastapi-jsonresponse-error-detail
    pattern: |
      JSONResponse(
          status_code=...,
          content={"error": ...}
      )
    message: "JSONResponse with error message - ensure sensitive info is not leaked in errors"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-209"
      tags: [fastapi, error-handling, info-disclosure]

  # Pydantic model without field validation
  - id: py-pydantic-url-no-validation
    pattern: |
      class $CLASS(BaseModel):
          url: str
    message: "Pydantic model with URL field - consider using HttpUrl type for validation"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-20"
      tags: [pydantic, validation, ssrf]

  # ============================================
  # Unvalidated Redirect (CWE-601)
  # ============================================

  - id: py-open-redirect-flask
    pattern: 'redirect(request.args.get(...))'
    message: "Open redirect vulnerability - user input used directly in redirect (CWE-601)"
    languages: [python]
    severity: HIGH
    metadata:
      cwe: "CWE-601"
      owasp: "A01:2021 Broken Access Control"
      tags: [flask, redirect, open-redirect]

  - id: py-open-redirect-django
    pattern: 'HttpResponseRedirect(request.GET.get(...))'
    message: "Open redirect vulnerability - user input used directly in redirect (CWE-601)"
    languages: [python]
    severity: HIGH
    metadata:
      cwe: "CWE-601"
      owasp: "A01:2021 Broken Access Control"
      tags: [django, redirect, open-redirect]

  - id: py-open-redirect-var
    pattern: 'redirect($URL)'
    message: "Redirect with variable - ensure URL is validated (CWE-601)"
    languages: [python]
    severity: MEDIUM
    metadata:
      cwe: "CWE-601"
      tags: [redirect, open-redirect]

  # ============================================
  # HTTP Header Injection (CWE-113)
  # ============================================

  - id: py-header-injection-set
    pattern: '$RESPONSE.headers[$KEY] = $VALUE'
    message: "Setting response header - ensure value is sanitized (CWE-113)"
    languages: [python]
    severity: MEDIUM
    metadata:
      cwe: "CWE-113"
      owasp: "A03:2021 Injection"
      tags: [header-injection, http]

  - id: py-header-content-type-var
    pattern: '$RESPONSE.content_type = $VALUE'
    message: "Content-Type header set dynamically - potential header injection (CWE-113)"
    languages: [python]
    severity: MEDIUM
    metadata:
      cwe: "CWE-113"
      tags: [header-injection]

  # ============================================
  # DSVW-specific patterns (BaseHTTPServer)
  # ============================================

  - id: py-meta-refresh-redirect
    pattern: |
      ... % params[$KEY]
    message: "User input from params dict used in string formatting - potential injection (CWE-601/CWE-113)"
    languages: [python]
    severity: HIGH
    metadata:
      cwe: "CWE-601"
      owasp: "A03:2021 Injection"
      tags: [open-redirect, header-injection, user-input]

  - id: py-send-header-user-input
    pattern: 'self.send_header($HEADER, ... % params.$FUNC(...))'
    message: "HTTP header set with user input from params - header injection risk (CWE-113)"
    languages: [python]
    severity: HIGH
    metadata:
      cwe: "CWE-113"
      owasp: "A03:2021 Injection"
      tags: [header-injection, http-response-splitting]

  - id: py-send-header-format
    pattern: 'self.send_header($HEADER, $FMT % $VALUE)'
    message: "HTTP header with string formatting - ensure values are sanitized (CWE-113)"
    languages: [python]
    severity: MEDIUM
    metadata:
      cwe: "CWE-113"
      tags: [header-injection]

  - id: py-content-replace-user-input
    pattern: '$CONTENT.replace(..., ... % params[$KEY])'
    message: "User input from params used in content replacement - potential XSS/redirect (CWE-79/CWE-601)"
    languages: [python]
    severity: HIGH
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021 Injection"
      tags: [xss, open-redirect, user-input]

  - id: py-params-dict-access
    pattern: 'params[$KEY]'
    message: "Direct access to user-controlled params dictionary - validate before use"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-20"
      tags: [user-input, validation]

  - id: py-params-get-method
    pattern: 'params.get($KEY, ...)'
    message: "User input accessed via params.get() - validate before use in security-sensitive operations"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-20"
      tags: [user-input, validation]

  # ============================================
  # JSONP Callback Injection (CWE-79)
  # ============================================

  - id: py-jsonp-callback-injection
    patterns:
      - pattern: '... params["callback"] ...'
    message: "JSONP callback from user input - XSS risk if not validated (CWE-79)"
    languages: [python]
    severity: HIGH
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021 Injection"
      tags: [jsonp, xss, callback-injection]

  - id: py-jsonp-callback-format
    pattern: '$FMT % params[$KEY]'
    message: "User input in string formatting - validate callback parameter (CWE-79)"
    languages: [python]
    severity: MEDIUM
    metadata:
      cwe: "CWE-79"
      tags: [jsonp, xss, user-input]

  # ============================================
  # Django XSS (CWE-79)
  # ============================================

  - id: py-django-mark-safe
    pattern: mark_safe($X)
    message: "Django mark_safe() bypasses HTML escaping - XSS risk if input is user-controlled (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      owasp: "A03:2021 Injection"
      tags: [django, xss]

  - id: py-django-mark-safe-format
    pattern: mark_safe($FMT.format(...))
    message: "Django mark_safe() with format string - XSS risk (CWE-79)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [django, xss]

  - id: py-django-mark-safe-percent
    pattern: mark_safe($FMT % $VAR)
    message: "Django mark_safe() with % formatting - XSS risk (CWE-79)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-79"
      tags: [django, xss]

  - id: py-django-safestring
    pattern: SafeString($X)
    message: "Django SafeString bypasses HTML escaping - XSS risk if user-controlled (CWE-79)"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"
      tags: [django, xss]

  - id: py-django-format-html-unsafe
    pattern: format_html($FMT, $X)
    message: "Django format_html - ensure variables are properly escaped (CWE-79)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-79"
      tags: [django, xss]

  # ============================================
  # Django Open Redirect (CWE-601)
  # ============================================

  - id: py-django-redirect-request
    pattern: redirect(request.$ATTR[$X])
    message: "Django redirect from request parameter - open redirect vulnerability (CWE-601)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-601"
      owasp: "A01:2021 Broken Access Control"
      tags: [django, redirect]

  - id: py-django-redirect-get
    pattern: redirect(request.GET.get(...))
    message: "Django redirect from GET parameter - open redirect vulnerability (CWE-601)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-601"
      tags: [django, redirect]

  - id: py-django-redirect-post
    pattern: redirect(request.POST.get(...))
    message: "Django redirect from POST parameter - open redirect vulnerability (CWE-601)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-601"
      tags: [django, redirect]

  - id: py-django-httpresponseredirect-get
    pattern: HttpResponseRedirect(request.GET.get(...))
    message: "Django HttpResponseRedirect from GET - open redirect vulnerability (CWE-601)"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-601"
      tags: [django, redirect]

  - id: py-django-redirect-var
    pattern: redirect($URL)
    message: "Django redirect - validate URL against whitelist if user-controlled (CWE-601)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-601"
      tags: [django, redirect]

  - id: py-django-httpresponseredirect-var
    pattern: HttpResponseRedirect($URL)
    message: "Django HttpResponseRedirect - validate URL if user-controlled (CWE-601)"
    languages: [python]
    severity: INFO
    metadata:
      cwe: "CWE-601"
      tags: [django, redirect]

