# YAML Configuration Security Rules
# Based on semgrep-rules/yaml - https://github.com/semgrep/semgrep-rules
# Covers GitHub Actions, Kubernetes, Docker Compose
rules:
  # ============================================
  # GitHub Actions - Command Injection
  # ============================================

  - id: gha-run-shell-injection
    message: >-
      Using ${{...}} with untrusted github context data in a run: step could allow code injection.
      Use env: to store the data first, then reference with "$ENV_VAR".
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-78: OS Command Injection"
      references:
        - https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#understanding-the-risk-of-script-injections
        - https://securitylab.github.com/research/github-actions-untrusted-input/
    pattern-regex: 'run:.*\$\{\{\s*github\.event\.(issue|pull_request|comment|review|discussion)\.(title|body)'

  - id: gha-head-ref-injection
    message: >-
      github.head_ref is user-controlled and can be used for injection attacks.
      Validate the branch name or use env: variable.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-78: OS Command Injection"
    pattern-regex: 'run:.*\$\{\{\s*github\.head_ref\s*\}\}'

  - id: gha-curl-pipe-bash
    message: >-
      Piping curl to bash is dangerous - an attacker controlling the URL could execute arbitrary code.
      Download the script first, verify its contents, then execute.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94: Code Injection"
    pattern-regex: 'curl.*\|\s*(bash|sh|zsh)'

  # ============================================
  # GitHub Actions - Dangerous Triggers
  # ============================================

  - id: gha-pull-request-target-checkout
    message: >-
      Using pull_request_target with checkout of PR code gives untrusted code access to secrets.
      This is a critical security vulnerability - see GitHub Security Lab advisory.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-913: Improper Control of Dynamically-Managed Code Resources"
      references:
        - https://securitylab.github.com/research/github-actions-preventing-pwn-requests/
    patterns:
      - pattern-regex: 'pull_request_target'
      - pattern-regex: 'actions/checkout'
      - pattern-regex: 'ref:.*\$\{\{\s*github\.event\.pull_request'

  - id: gha-workflow-dispatch-no-validation
    message: >-
      workflow_dispatch inputs should be validated before use.
      User-provided inputs could contain malicious values.
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    pattern-regex: '\$\{\{\s*github\.event\.inputs\.'

  # ============================================
  # GitHub Actions - Secrets
  # ============================================

  - id: gha-secrets-in-output
    message: >-
      Secrets should not be written to workflow outputs as they may be logged.
      Use GITHUB_OUTPUT file instead.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-532: Insertion of Sensitive Information into Log File"
    pattern-regex: 'echo.*\$\{\{\s*secrets\.'

  - id: gha-hardcoded-token
    message: >-
      Hardcoded token or credential in workflow file. Use GitHub secrets instead.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
    pattern-regex: "(token|password|api_key|apikey|secret):\\s*[\"'][^$][^\"']{8,}"

  # ============================================
  # Kubernetes - Privileged Containers
  # ============================================

  - id: k8s-privileged-container
    message: >-
      Container running in privileged mode has full host access.
      This enables container escape and host compromise. Remove privileged: true.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
      references:
        - https://kubernetes.io/docs/concepts/security/pod-security-standards/
    pattern-regex: 'privileged:\s*true'

  - id: k8s-allow-privilege-escalation
    message: >-
      allowPrivilegeEscalation enables setuid binaries to gain privileges.
      Set to false unless specifically required.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
    pattern-regex: 'allowPrivilegeEscalation:\s*true'

  - id: k8s-run-as-root
    message: >-
      Container running as root (UID 0). Use runAsNonRoot: true or specify a non-root runAsUser.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
    pattern-regex: 'runAsUser:\s*0\b'

  # ============================================
  # Kubernetes - Host Access
  # ============================================

  - id: k8s-hostnetwork
    message: >-
      Pod using host network namespace. This gives access to host network interfaces and services.
      Remove hostNetwork: true unless absolutely required.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-668: Exposure of Resource to Wrong Sphere"
    pattern-regex: 'hostNetwork:\s*true'

  - id: k8s-hostpid
    message: >-
      Pod using host PID namespace. This exposes host processes to the container.
      Remove hostPID: true unless absolutely required.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-668: Exposure of Resource to Wrong Sphere"
    pattern-regex: 'hostPID:\s*true'

  - id: k8s-hostipc
    message: >-
      Pod using host IPC namespace. This allows inter-process communication with host processes.
      Remove hostIPC: true unless absolutely required.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-668: Exposure of Resource to Wrong Sphere"
    pattern-regex: 'hostIPC:\s*true'

  - id: k8s-docker-socket
    message: >-
      Docker socket mounted in container. This gives container full control over Docker daemon.
      Critical security risk - container escape possible.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
    pattern-regex: '/var/run/docker\.sock'

  # ============================================
  # Kubernetes - RBAC
  # ============================================

  - id: k8s-cluster-admin-binding
    message: >-
      ClusterRoleBinding to cluster-admin grants full cluster access.
      Use more restrictive roles following principle of least privilege.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
    patterns:
      - pattern-regex: 'kind:\s*ClusterRoleBinding'
      - pattern-regex: 'name:\s*cluster-admin'

  - id: k8s-wildcard-rbac
    message: >-
      RBAC rule with wildcard (*) grants excessive permissions.
      Specify explicit resources and verbs.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
    patterns:
      - pattern-regex: "kind:\\s*(Cluster)?Role\\b"
      - pattern-regex: "resources:\\s*\\[\\s*[\"']?\\*[\"']?\\s*\\]"

  # ============================================
  # Docker Compose - Security
  # ============================================

  - id: docker-compose-privileged
    message: >-
      Docker Compose service running in privileged mode.
      This grants full host capabilities. Remove privileged: true.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
    patterns:
      - pattern-regex: 'services:'
      - pattern-regex: 'privileged:\s*true'

  - id: docker-compose-cap-add-all
    message: >-
      Adding all Linux capabilities defeats container isolation.
      Only add specific capabilities that are needed.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
    patterns:
      - pattern-regex: 'cap_add:'
      - pattern-regex: '- ALL'

  - id: docker-compose-no-new-privileges
    message: >-
      Container allows privilege escalation via setuid/setgid.
      Add 'no-new-privileges:true' to security_opt.
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-732: Incorrect Permission Assignment"
      references:
        - https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html
    patterns:
      - pattern-regex: 'services:'
      - pattern-regex: 'image:'
      - pattern-not-regex: 'no-new-privileges'

  # ============================================
  # Docker Compose - Network Exposure
  # ============================================

  - id: docker-compose-host-network
    message: >-
      Docker container using host network mode exposes all host ports.
      Use bridge networking with explicit port mappings.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-668: Exposure of Resource to Wrong Sphere"
    pattern-regex: "network_mode:\\s*[\"']?host[\"']?"

  - id: docker-compose-port-binding-all
    message: >-
      Port bound to all interfaces (0.0.0.0). Consider binding to 127.0.0.1 for local-only access.
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-668: Exposure of Resource to Wrong Sphere"
    pattern-regex: "ports:[\\s\\S]*?[\"']?0\\.0\\.0\\.0:"

  # ============================================
  # General YAML - Environment Variables
  # ============================================

  - id: yaml-hardcoded-password
    message: >-
      Hardcoded password in configuration file.
      Use environment variables or secrets management.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
    pattern-regex: "(password|passwd|pwd):\\s*[\"'][^$\\{][^\"']{4,}"

  - id: yaml-hardcoded-api-key
    message: >-
      Hardcoded API key in configuration file.
      Use environment variables or secrets management.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
    pattern-regex: "(api_key|apikey|api-key):\\s*[\"'][a-zA-Z0-9]{16,}"

  - id: yaml-debug-enabled
    message: >-
      Debug mode enabled in configuration. Disable for production deployment.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-489: Active Debug Code"
    pattern-regex: '(debug|DEBUG):\s*(true|True|1|yes|on)'

  # ============================================
  # Docker Compose - Redis Security (OWASP API7)
  # ============================================

  - id: docker-compose-redis-no-auth
    message: >-
      Redis container without authentication configured. Add --requirepass or REDIS_PASSWORD
      environment variable for production security (OWASP API7: Security Misconfiguration).
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-287: Improper Authentication"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [redis, auth, docker-compose, capital]
    pattern-regex: "image:\\s*['\"]?redis[^\\n]*\\n(?![\\s\\S]*(?:requirepass|REDIS_PASSWORD))"

  - id: docker-compose-redis-exposed-port
    message: >-
      Redis port 6379 exposed without authentication. Redis should never be exposed
      to untrusted networks without password protection.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-287: Improper Authentication"
      tags: [redis, network, docker-compose]
    pattern-regex: "6379:6379"

  - id: docker-compose-redis-bind-all
    message: >-
      Redis bound to all interfaces (0.0.0.0). Restrict to localhost or internal network.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-668: Exposure of Resource to Wrong Sphere"
      tags: [redis, network]
    pattern-regex: "redis.*\\n.*0\\.0\\.0\\.0:6379|0\\.0\\.0\\.0:6379.*redis"

  # ============================================
  # Docker Compose - Database Security
  # ============================================

  - id: docker-compose-mongo-no-auth
    message: >-
      MongoDB container without authentication. Set MONGO_INITDB_ROOT_USERNAME
      and MONGO_INITDB_ROOT_PASSWORD environment variables.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-287: Improper Authentication"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [mongodb, auth, docker-compose]
    pattern-regex: "image:\\s*['\"]?mongo[^\\n]*\\n(?![\\s\\S]*MONGO_INITDB_ROOT)"

  - id: docker-compose-postgres-weak-password
    message: >-
      PostgreSQL with weak/empty password. Use strong password in production.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-521: Weak Password Requirements"
      tags: [postgres, password, docker-compose]
    pattern-regex: "POSTGRES_PASSWORD:\\s*['\"]?['\"]?\\s*$|POSTGRES_PASSWORD:\\s*['\"]?(password|postgres|admin|test|123)['\"]?"

  - id: docker-compose-mysql-empty-password
    message: >-
      MySQL with MYSQL_ALLOW_EMPTY_PASSWORD or weak password. Configure strong authentication.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-521: Weak Password Requirements"
      tags: [mysql, password, docker-compose]
    pattern-regex: "MYSQL_ALLOW_EMPTY_PASSWORD:\\s*(yes|true|1)"

  # ============================================
  # Docker Compose - CORS and API Security
  # ============================================

  - id: docker-compose-cors-wildcard
    message: >-
      CORS configured with wildcard (*) origin. Restrict to specific trusted domains
      to prevent cross-origin attacks (OWASP API7).
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-942: Overly Permissive Cross-domain Whitelist"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [cors, docker-compose, capital]
    pattern-regex: "CORS.*\\*|ACCESS_CONTROL_ALLOW_ORIGIN.*\\*|ALLOWED_ORIGINS.*\\*"

  - id: docker-compose-debug-enabled
    message: >-
      Debug mode enabled in container environment. Disable for production.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-489: Active Debug Code"
      tags: [debug, docker-compose]
    pattern-regex: "(DEBUG|FLASK_DEBUG|DJANGO_DEBUG):\\s*['\"]?(true|True|1|yes)['\"]?"

  # ============================================
  # Kubernetes - Security Misconfiguration
  # ============================================

  - id: k8s-redis-no-auth
    message: >-
      Redis Kubernetes deployment without authentication. Set requirepass in Redis config.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-287: Improper Authentication"
      owasp: "API7:2023 Server-Side Security Misconfiguration"
      tags: [redis, kubernetes, auth]
    pattern-regex: "image:\\s*redis[^\\n]*\\n(?![\\s\\S]*(?:requirepass|REDIS_PASSWORD))"

  - id: k8s-secret-in-env
    message: >-
      Secret value directly in environment variable. Use Kubernetes Secrets instead.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
      tags: [kubernetes, secrets]
    pattern-regex: "env:\\s*\\n\\s*-\\s*name:\\s*(PASSWORD|SECRET|API_KEY|TOKEN)\\s*\\n\\s*value:"

  # ============================================
  # OpenAPI/Swagger Security
  # ============================================

  - id: openapi-no-security-schemes
    message: >-
      OpenAPI spec has no securitySchemes defined. APIs should require authentication (OWASP API2).
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-306: Missing Authentication"
      owasp: "API2:2023 Broken Authentication"
      tags: [openapi, swagger, auth]
    pattern-regex: "openapi:\\s*[\"']?3\\.[0-9]"

  - id: openapi-no-security-requirement
    message: >-
      OpenAPI paths without security requirement. Endpoints may be unauthenticated (OWASP API2).
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-306: Missing Authentication"
      owasp: "API2:2023 Broken Authentication"
      tags: [openapi, swagger, auth]
    pattern-regex: "paths:\\s*\\n\\s*/[a-zA-Z]"

  - id: swagger-v2-detected
    message: >-
      Swagger 2.0 detected - consider upgrading to OpenAPI 3.x for better security features.
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      tags: [swagger, openapi]
    pattern-regex: "swagger:\\s*[\"']?2\\."

  - id: openapi-server-http
    message: >-
      OpenAPI server URL uses HTTP instead of HTTPS. Use HTTPS for production APIs.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-319: Cleartext Transmission"
      tags: [openapi, swagger, tls]
    pattern-regex: "servers:\\s*\\n\\s*-\\s*url:\\s*[\"']?http://"

  - id: openapi-no-rate-limiting
    message: >-
      OpenAPI spec - consider documenting rate limiting with x-ratelimit extension (OWASP API4).
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      owasp: "API4:2023 Unrestricted Resource Consumption"
      tags: [openapi, swagger, ratelimit]
    pattern-regex: "openapi:\\s*[\"']?3\\.[0-9]"

  # ============================================
  # GitHub Actions - Unpinned Actions (Supply Chain)
  # ============================================

  - id: gha-unpinned-action-main
    message: >-
      GitHub Action using @main or @master branch. Pin to a specific commit SHA for security.
      Unpinned actions can be modified by attackers to inject malicious code.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      owasp: "A08:2021 Software and Data Integrity Failures"
      references:
        - https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-third-party-actions
    pattern-regex: "uses:\\s*[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+@(main|master)\\b"

  - id: gha-unpinned-action-tag
    message: >-
      GitHub Action using version tag (v1, v2, etc.) instead of commit SHA.
      Tags can be moved to point to different code. Pin to full commit SHA.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
    pattern-regex: "uses:\\s*[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+@v[0-9]+"

  - id: gha-unpinned-action-latest
    message: >-
      GitHub Action using @latest which always fetches the newest version.
      This creates unpredictable builds and supply chain risk. Pin to SHA.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
    pattern-regex: "uses:\\s*[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+@latest"

  # ============================================
  # GitHub Actions - Excessive Permissions
  # ============================================

  - id: gha-permissions-write-all
    message: >-
      Workflow has write-all permissions granting full access to repository.
      Use minimal required permissions (principle of least privilege).
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
      references:
        - https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
    pattern-regex: "permissions:\\s*write-all"

  - id: gha-pull-request-target
    message: >-
      CRITICAL: pull_request_target trigger runs with write permissions and secrets access.
      Code from fork PRs runs in privileged context. Never checkout untrusted PR code.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-863: Incorrect Authorization"
      references:
        - https://securitylab.github.com/research/github-actions-preventing-pwn-requests/
    pattern-regex: "pull_request_target:"

  - id: gha-contents-write
    message: >-
      Workflow has contents: write permission allowing code modification.
      Ensure this is necessary and the workflow is not vulnerable to injection.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
    pattern-regex: "contents:\\s*write"

  # ============================================
  # GitHub Actions - Script Injection (Extended)
  # ============================================

  - id: gha-commit-message-injection
    message: >-
      Using github.event.commits[].message in run: step allows injection via commit message.
      Store in environment variable first.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-78: OS Command Injection"
    pattern-regex: 'run:.*\$\{\{\s*github\.event\.commits\[.*\]\.message'

  - id: gha-author-injection
    message: >-
      Using github.event author data (name/email) in run: step allows injection.
      Attacker can set malicious git config values. Use env: variable.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-78: OS Command Injection"
    pattern-regex: 'run:.*\$\{\{\s*github\.event\.(commits\[.*\]\.)?(author|committer)\.(name|email)'

  - id: gha-label-injection
    message: >-
      Using github.event.*.labels[].name in run: step allows injection via PR/issue labels.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-78: OS Command Injection"
    pattern-regex: 'run:.*\$\{\{\s*github\.event\.(issue|pull_request)\.labels\['

  # ============================================
  # GitHub Actions - Self-Hosted Runner Risks
  # ============================================

  - id: gha-self-hosted-runner
    message: >-
      Workflow uses self-hosted runner. Ensure runner is properly secured.
      Self-hosted runners persist state between jobs - avoid for public repos.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-912: Hidden Functionality"
      references:
        - https://docs.github.com/en/actions/hosting-your-own-runners/about-self-hosted-runners#self-hosted-runner-security
    pattern-regex: "runs-on:.*self-hosted"

  - id: gha-public-repo-self-hosted
    message: >-
      Self-hosted runner on potentially public workflow. Never use self-hosted runners
      for public repos as any fork can run malicious code on your infrastructure.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-912: Hidden Functionality"
    patterns:
      - pattern-regex: "runs-on:.*self-hosted"
      - pattern-regex: "pull_request:"

  # ============================================
  # GitHub Actions - OIDC and Credential Security
  # ============================================

  - id: gha-long-lived-credentials
    message: >-
      Long-lived credentials detected (AWS keys, GCP service account, Azure creds).
      Use OIDC federation for cloud provider authentication instead.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
      references:
        - https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect
    pattern-regex: "(AWS_ACCESS_KEY_ID|AWS_SECRET_ACCESS_KEY|GOOGLE_APPLICATION_CREDENTIALS|AZURE_CREDENTIALS):"

  - id: gha-expose-secrets-in-logs
    message: >-
      Pattern may expose secrets in workflow logs. GitHub masks secrets but
      derived values or base64 encoded secrets may leak.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-532: Insertion of Sensitive Information into Log File"
    pattern-regex: "echo.*\\$\\{\\{\\s*secrets\\."

  # ============================================
  # GitHub Actions - Workflow Run Risks
  # ============================================

  - id: gha-workflow-run-untrusted
    message: >-
      workflow_run event triggered by external workflow. The triggering workflow
      could be from a fork. Validate the source before using artifacts.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
    pattern-regex: "on:\\s*\\n\\s*workflow_run:"

  - id: gha-artifact-download-untrusted
    message: >-
      Downloading artifacts from workflow_run. Artifacts from fork PRs can contain
      malicious code. Validate artifact contents before use.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
    patterns:
      - pattern-regex: "workflow_run:"
      - pattern-regex: "actions/download-artifact"

  # ============================================
  # GitHub Actions - Environment Security
  # ============================================

  - id: gha-environment-no-protection
    message: >-
      Deployment to environment without protection rules may expose secrets.
      Configure required reviewers and wait timer for production environments.
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: "environment:\\s*production"

  - id: gha-github-token-permissions
    message: >-
      Explicit GITHUB_TOKEN usage detected. Ensure token has minimal permissions
      defined at workflow level for security.
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-250: Execution with Unnecessary Privileges"
    pattern-regex: "\\$\\{\\{\\s*secrets\\.GITHUB_TOKEN\\s*\\}\\}"

  # ============================================
  # GitHub Actions - Code Execution Risks
  # ============================================

  - id: gha-npm-publish-untrusted
    message: >-
      NPM publish step detected. Ensure provenance attestation is enabled
      and package is not built from untrusted fork code.
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
    pattern-regex: "npm publish"

  - id: gha-docker-build-push
    message: >-
      Docker build and push detected. Ensure base images are pinned by digest
      and no secrets are included in the image.
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
    pattern-regex: "docker/build-push-action"

  - id: gha-eval-expression
    message: >-
      Eval or dynamic code execution in workflow. User-controlled input
      could lead to code injection.
    languages: [yaml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94: Code Injection"
    pattern-regex: 'run:.*eval\s+.*\$\{\{'

  # ============================================
  # GitHub Actions - Step Output Injection
  # ============================================

  - id: gha-step-output-in-run
    message: >-
      Using step outputs directly in run command. Step outputs can contain untrusted
      data that leads to script injection. Store in env variable first.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-78: OS Command Injection"
      references:
        - https://securitylab.github.com/research/github-actions-untrusted-input/
    pattern-regex: 'for\s+.*\s+in\s+\$\{\{\s*steps\.[^}]+\.outputs\.'

  - id: gha-changed-files-injection
    message: >-
      tj-actions/changed-files output used in run command. File names could contain
      malicious characters leading to injection. Validate and sanitize inputs.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-78: OS Command Injection"
    pattern-regex: "tj-actions/changed-files"

  - id: gha-gcp-service-account
    message: >-
      GCP service account key used in workflow. Consider using Workload Identity
      Federation with OIDC for keyless authentication.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
    pattern-regex: "GCP_SERVICE_ACCOUNT_KEY|GOOGLE_CREDENTIALS"

  - id: gha-echo-secret-variable
    message: >-
      Echoing a variable that may contain secret data to logs. GitHub masks
      direct secrets but derived values may leak.
    languages: [yaml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-532: Insertion of Sensitive Information into Log File"
    pattern-regex: 'echo\s+.*\$(PRIVATE_KEY|SECRET|TOKEN|PASSWORD|API_KEY)'

  - id: gha-docker-registry-push
    message: >-
      Docker image push to registry detected. Ensure no secrets are baked into
      image and use proper access controls on registry.
    languages: [yaml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-200: Exposure of Sensitive Information"
    pattern-regex: "Publish-Docker-Github-Action|docker/build-push"

  # ============================================
  # Android Manifest/XML Security
  # ============================================

  - id: android-fileprovider-root-path
    message: >-
      FileProvider with root-path exposes the entire filesystem via content provider.
      Use specific paths (files-path, cache-path) to limit access (CWE-552).
    languages: [xml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-552: Files or Directories Accessible to External Parties"
    pattern-regex: '<root-path\s+[^>]*path\s*=\s*["\'']\.["\'']\s*/>'

  - id: android-fileprovider-external-path
    message: >-
      FileProvider with external-path exposes files on external storage.
      External storage is world-readable - avoid sharing sensitive files (CWE-552).
    languages: [xml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-552: Files or Directories Accessible to External Parties"
    pattern-regex: '<external-path\s+[^>]*path\s*=\s*["\'']\.?["\'']'

  - id: android-exported-true-no-permission
    message: >-
      Android component exported without permission requirement. Any app can access
      this component. Add android:permission attribute or set exported=false (CWE-926).
    languages: [xml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-926: Improper Export of Android Application Components"
    pattern-regex: 'android:exported\s*=\s*["\'']true["\''](?!.*android:permission)'

  - id: android-allowbackup-true
    message: >-
      android:allowBackup="true" allows data backup which may expose sensitive data.
      Set to false or implement BackupAgent with encryption (CWE-312).
    languages: [xml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-312: Cleartext Storage of Sensitive Information"
    pattern-regex: 'android:allowBackup\s*=\s*["\'']true["\'']'

  - id: android-debuggable-true
    message: >-
      android:debuggable="true" enables debugging in production. This exposes
      sensitive data and allows attaching debuggers. Must be false in release (CWE-489).
    languages: [xml]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-489: Active Debug Code"
    pattern-regex: 'android:debuggable\s*=\s*["\'']true["\'']'

  - id: android-cleartexttraffic-true
    message: >-
      android:usesCleartextTraffic="true" allows HTTP connections. Use HTTPS only
      and set to false to prevent cleartext network traffic (CWE-319).
    languages: [xml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-319: Cleartext Transmission of Sensitive Information"
    pattern-regex: 'android:usesCleartextTraffic\s*=\s*["\'']true["\'']'

  - id: android-network-security-cleartext
    message: >-
      Network Security Config allows cleartext traffic. Only enable cleartext
      for specific debug domains, never in production (CWE-319).
    languages: [xml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-319: Cleartext Transmission of Sensitive Information"
    pattern-regex: 'cleartextTrafficPermitted\s*=\s*["\'']true["\'']'

  - id: android-intent-filter-exported
    message: >-
      Activity with intent-filter is implicitly exported on Android 12+.
      Explicitly set android:exported="false" if not meant to be public (CWE-926).
    languages: [xml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-926: Improper Export of Android Application Components"
    pattern-regex: '<intent-filter>'

  - id: android-provider-exported
    message: >-
      Content provider exported to other apps. Ensure proper URI permissions
      and avoid exposing sensitive data via content provider (CWE-284).
    languages: [xml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: '<provider[^>]*android:exported\s*=\s*["\'']true["\'']'

  - id: android-receiver-exported
    message: >-
      Broadcast receiver exported to other apps. Malicious apps can send
      intents to this receiver. Add permission protection or set exported=false (CWE-926).
    languages: [xml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-926: Improper Export of Android Application Components"
    pattern-regex: '<receiver[^>]*android:exported\s*=\s*["\'']true["\'']'

  - id: android-service-exported
    message: >-
      Service exported to other apps. Any app can bind to or start this service.
      Add permission protection or set exported=false (CWE-926).
    languages: [xml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-926: Improper Export of Android Application Components"
    pattern-regex: '<service[^>]*android:exported\s*=\s*["\'']true["\'']'

  - id: android-grantable-uri-permissions
    message: >-
      android:grantUriPermissions="true" allows temporary URI access grants.
      Ensure content provider properly validates URI access (CWE-284).
    languages: [xml]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: 'android:grantUriPermissions\s*=\s*["\'']true["\'']'

  - id: android-taskaffinity-hijack
    message: >-
      Empty taskAffinity with allowTaskReparenting may allow task hijacking attacks.
      Set explicit taskAffinity or remove allowTaskReparenting (CWE-923).
    languages: [xml]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-923: Improper Restriction of Communication Channel"
    pattern-regex: 'android:taskAffinity\s*=\s*["\'']['\'"]'

