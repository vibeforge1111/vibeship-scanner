# Solidity/Smart Contract Security Rules
# Based on semgrep-rules/solidity - https://github.com/semgrep/semgrep-rules
rules:
  # ============================================
  # Critical: Access Control
  # ============================================

  - id: sol-accessible-selfdestruct
    message: Contract can be destructed by anyone - missing access control on selfdestruct
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://www.parity.io/blog/a-postmortem-on-the-parity-multi-sig-library-self-destruct/
    patterns:
      - pattern-either:
          - pattern: selfdestruct($ADDR)
          - pattern: suicide($ADDR)
      - pattern-not-inside: |
          function $FUNC(...) onlyOwner { ... }
      - pattern-not-inside: |
          require(msg.sender == owner, ...);
          ...

  - id: sol-unrestricted-transferownership
    message: transferOwnership() lacks access control - anyone can take ownership
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-inside: |
          function transferOwnership($ADDR) public { ... }
      - pattern-not-inside: |
          function transferOwnership($ADDR) public onlyOwner { ... }

  # ============================================
  # Critical: Reentrancy
  # ============================================

  - id: sol-erc721-reentrancy
    message: ERC721 safeTransferFrom/safeMint can trigger reentrancy via onERC721Received callback
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://blocksecteam.medium.com/when-safemint-becomes-unsafe-lessons-from-the-hypebears-security-incident-2965209bda2a
    pattern: _checkOnERC721Received(...)

  - id: sol-erc777-reentrancy
    message: ERC777 tokens have send/receive hooks that can trigger reentrancy
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    pattern-either:
      - pattern: IERC777($TOKEN).send(...)
      - pattern: IERC777($TOKEN).operatorSend(...)

  - id: sol-external-call-state-change
    message: State change after external call - potential reentrancy vulnerability
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://consensys.github.io/smart-contract-best-practices/attacks/reentrancy/
    pattern-regex: '\.call\s*\{[^}]*\}\s*\([^)]*\)\s*;[\s\S]*?\w+\s*='

  # ============================================
  # Critical: Arbitrary Calls
  # ============================================

  - id: sol-arbitrary-low-level-call
    message: Arbitrary address with controlled calldata in low-level call - potential code injection
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://blocksecteam.medium.com/li-fi-attack-a-cross-chain-bridge-vulnerability-no-its-due-to-unchecked-external-call-c31e7dadf60f
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $ADDR, ..., bytes calldata $DATA, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $ADDR, ..., bytes calldata $DATA, ...) public { ... }
      - pattern-either:
          - pattern: $ADDR.call($DATA)
          - pattern: '$ADDR.call{value:$V}($DATA)'

  - id: sol-delegatecall-to-arbitrary-address
    message: Delegatecall to user-controlled address - attacker can execute arbitrary code in contract context
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://entethalliance.org/specs/ethtrust-sl/v1/#req-1-delegatecall
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $ANY(..., address $CONTRACT, ...) public {...}
          - pattern-inside: |
              function $ANY(..., address $CONTRACT, ...) external {...}
      - pattern-either:
          - pattern: $CONTRACT.delegatecall(...)
          - pattern: '$CONTRACT.delegatecall{gas:$GAS}(...)'

  # ============================================
  # High: Integer Issues
  # ============================================

  - id: sol-unchecked-arithmetic
    message: Unchecked arithmetic operation - potential overflow/underflow (Solidity <0.8.0)
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
    patterns:
      - pattern-inside: |
          unchecked {
            ...
          }
      - pattern-either:
          - pattern: $X + $Y
          - pattern: $X - $Y
          - pattern: $X * $Y

  # ============================================
  # High: Token Security
  # ============================================

  - id: sol-erc20-public-burn
    message: Public burn function without access control - anyone can burn tokens
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: 'function\s+burn\s*\([^)]*\)\s+(public|external)\s*\{'

  - id: sol-arbitrary-transferfrom
    message: ERC721/ERC20 transferFrom with user-controlled from address - potential unauthorized transfer
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $FROM, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $FROM, ...) public { ... }
      - pattern-either:
          - pattern: $TOKEN.transferFrom($FROM, ...)
          - pattern: IERC20($TOKEN).transferFrom($FROM, ...)
          - pattern: IERC721($TOKEN).transferFrom($FROM, ...)

  # ============================================
  # High: Oracle & Price Manipulation
  # ============================================

  - id: sol-basic-oracle-manipulation
    message: Single-block price oracle - vulnerable to flash loan manipulation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://www.paradigm.xyz/2020/11/so-you-want-to-use-a-price-oracle
    patterns:
      - pattern-either:
          - pattern: $PAIR.getReserves()
          - pattern: IUniswapV2Pair($PAIR).getReserves()

  - id: sol-no-slippage-check
    message: DEX swap without slippage protection - vulnerable to sandwich attacks
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    pattern-regex: '(swap\w+|swapExact\w+)\s*(\{[^}]*\})?\s*\([^)]*,\s*0\s*,'

  # ============================================
  # Medium: Randomness
  # ============================================

  - id: sol-weak-randomness-blockhash
    message: Using blockhash for randomness - miners can manipulate this value
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern-either:
      - pattern: blockhash($BLOCK)
      - pattern: block.timestamp
      - pattern: block.difficulty
      - pattern: block.prevrandao

  - id: sol-incorrect-blockhash
    message: blockhash(block.number) always returns 0 - use block.number - 1
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern: blockhash(block.number)

  # ============================================
  # Medium: Signature Issues
  # ============================================

  - id: sol-ecrecover-malleable
    message: ecrecover is vulnerable to signature malleability - use OpenZeppelin ECDSA
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-347: Improper Verification of Cryptographic Signature"
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/ECDSA.sol
    pattern: ecrecover($HASH, $V, $R, $S)

  - id: sol-missing-zero-address-check
    message: Missing zero address validation - tokens/ETH could be lost
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $ADDR, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $ADDR, ...) public { ... }
      - pattern-either:
          - pattern: $ADDR.transfer(...)
          - pattern: $TOKEN.transfer($ADDR, ...)
      - pattern-not-inside: |
          require($ADDR != address(0), ...);
          ...

  # ============================================
  # Medium: Proxy Patterns
  # ============================================

  - id: sol-proxy-storage-collision
    message: Potential storage collision in proxy pattern - use EIP-1967 slots
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-706: Use of Incorrectly-Resolved Name or Reference"
      references:
        - https://eips.ethereum.org/EIPS/eip-1967
    patterns:
      - pattern-inside: |
          contract $PROXY {
            ...
            address $IMPL;
            ...
          }
      - pattern: delegatecall(...)

  # ============================================
  # Info: Best Practices
  # ============================================

  - id: sol-use-ownable2step
    message: Consider using Ownable2Step instead of Ownable for safer ownership transfers
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable2Step.sol
    pattern: import "@openzeppelin/contracts/access/Ownable.sol"

  - id: sol-tx-origin-auth
    message: tx.origin used for authorization - vulnerable to phishing attacks
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
    patterns:
      - pattern-either:
          - pattern: require(tx.origin == $ADDR, ...)
          - pattern: if (tx.origin == $ADDR) { ... }
          - pattern: tx.origin == owner

  - id: sol-encode-packed-collision
    message: abi.encodePacked with multiple dynamic types - potential hash collision
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"
    pattern: abi.encodePacked($A, $B, ...)

  - id: sol-deprecated-suicide
    message: suicide() is deprecated - use selfdestruct() instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: suicide(...)

  - id: sol-floating-pragma
    message: Floating pragma version - pin to a specific version for production
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-regex: 'pragma solidity \^'

  - id: sol-missing-visibility
    message: Function missing explicit visibility specifier
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern: |
          function $FUNC(...) {
            ...
          }
      - pattern-not: |
          function $FUNC(...) public { ... }
      - pattern-not: |
          function $FUNC(...) external { ... }
      - pattern-not: |
          function $FUNC(...) internal { ... }
      - pattern-not: |
          function $FUNC(...) private { ... }

  # ============================================
  # DeFi: Flash Loan Attacks
  # ============================================

  - id: sol-flash-loan-no-check
    message: Flash loan without proper balance check - ensure atomic execution
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
    pattern-either:
      - pattern: IFlashLoanReceiver($X).executeOperation(...)
      - pattern: IERC3156FlashBorrower($X).onFlashLoan(...)

  - id: sol-unchecked-return-value
    message: Return value of external call not checked - silent failure possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
    patterns:
      - pattern: $TOKEN.transfer($TO, $AMT)
      - pattern-not-inside: require($TOKEN.transfer(...), ...)
      - pattern-not-inside: if ($TOKEN.transfer(...)) { ... }

  - id: sol-unsafe-erc20-transfer
    message: ERC20 transfer without SafeERC20 - some tokens dont return bool
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol
    pattern-either:
      - pattern: IERC20($TOKEN).transfer(...)
      - pattern: IERC20($TOKEN).transferFrom(...)
      - pattern: IERC20($TOKEN).approve(...)

  # ============================================
  # DeFi: Liquidity & AMM Issues
  # ============================================

  - id: sol-hardcoded-deadline
    message: Hardcoded deadline in swap - use block.timestamp + buffer
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern-either:
      - pattern: $ROUTER.swapExactTokensForTokens(..., 9999999999, ...)
      - pattern: $ROUTER.swapExactTokensForTokens(..., type(uint256).max, ...)

  - id: sol-approve-max
    message: Unlimited token approval - use exact amount needed
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-either:
      - pattern: $TOKEN.approve($SPENDER, type(uint256).max)
      - pattern: IERC20($TOKEN).approve($SPENDER, type(uint256).max)

  - id: sol-missing-deadline
    message: DEX swap without deadline - transaction can be delayed by miners
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern: $ROUTER.swapExactTokensForTokens(..., block.timestamp, ...)

  # ============================================
  # NFT Security
  # ============================================

  - id: sol-nft-overflow-mint
    message: NFT mint without supply check - potential overflow in tokenId
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: _mint($TO, $ID)
      - pattern-not-inside: |
          require($ID <= $MAX, ...);
          ...

  - id: sol-erc721-no-exists-check
    message: ERC721 operation without existence check - token may not exist
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    patterns:
      - pattern: ownerOf($ID)
      - pattern-not-inside: |
          require(_exists($ID), ...);
          ...

  - id: sol-nft-royalty-bypass
    message: NFT transfer without royalty enforcement - use ERC2981
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-either:
      - pattern: safeTransferFrom($FROM, $TO, $ID)
      - pattern: transferFrom($FROM, $TO, $ID)

  # ============================================
  # Staking & Rewards
  # ============================================

  - id: sol-reward-before-update
    message: Reward calculation before state update - stale rewards possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          function $FUNC(...) {
            ...
          }
      - pattern: |
          $REWARD = $CALC;
          ...
          $STATE = $NEW;

  - id: sol-division-before-multiplication
    message: Division before multiplication causes precision loss
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern: ($X / $Y) * $Z

  # ============================================
  # Gas & DOS
  # ============================================

  - id: sol-unbounded-loop
    message: Unbounded loop over array - potential DOS via gas limit
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
    patterns:
      - pattern: |
          for (uint $I = 0; $I < $ARR.length; $I++) {
            ...
          }

  - id: sol-external-call-in-loop
    message: External call in loop - gas griefing and DOS risk
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern-either:
          - pattern: $ADDR.call(...)
          - pattern: $ADDR.transfer(...)
          - pattern: $ADDR.send(...)

  - id: sol-send-without-check
    message: send() return value not checked - silent failure
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: $ADDR.send($AMT)
      - pattern-not-inside: require($ADDR.send(...), ...)
      - pattern-not-inside: if ($ADDR.send(...)) { ... }

  # ============================================
  # Governance & Voting
  # ============================================

  - id: sol-flashloan-governance
    message: Governance vote without snapshot - flash loan attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: balanceOf($VOTER)
      - pattern-inside: |
          function vote(...) {
            ...
          }

  - id: sol-centralized-admin
    message: Single admin with full control - consider multisig or timelock
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern-either:
          - pattern: onlyOwner
          - pattern: require(msg.sender == owner, ...)

  # ============================================
  # Upgradeable Contracts
  # ============================================

  - id: sol-initialize-not-protected
    message: initialize() without initializer modifier - can be called multiple times
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: |
          function initialize(...) public {
            ...
          }
      - pattern-not: |
          function initialize(...) public initializer { ... }

  - id: sol-selfdestruct-in-implementation
    message: selfdestruct in implementation contract - proxy becomes unusable
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: selfdestruct($ADDR)
      - pattern-inside: |
          contract $CONTRACT is Initializable {
            ...
          }

  - id: sol-no-gap-storage
    message: Upgradeable contract without storage gap - future upgrade collision risk
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
      references:
        - https://docs.openzeppelin.com/contracts/4.x/upgradeable#storage_gaps
    pattern-regex: 'contract\s+\w+\s+is\s+Initializable\s*\{'

  # ============================================
  # Cross-Chain & Bridge
  # ============================================

  - id: sol-cross-chain-replay
    message: Cross-chain call without chain ID check - replay attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-either:
          - pattern: keccak256(abi.encode(...))
          - pattern: keccak256(abi.encodePacked(...))
      - pattern-not-inside: |
          keccak256(abi.encode(..., block.chainid, ...))

  # ============================================
  # Additional Token Issues
  # ============================================

  - id: sol-erc20-double-approve
    message: ERC20 approve race condition - use increaseAllowance instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      references:
        - https://github.com/ethereum/EIPs/issues/20#issuecomment-263524729
    pattern: approve($SPENDER, $AMT)

  - id: sol-fee-on-transfer-token
    message: Token amount after transfer may differ - check actual received amount
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    patterns:
      - pattern: $TOKEN.transferFrom($FROM, $TO, $AMT)
      - pattern-not-inside: |
          $BEFORE = $TOKEN.balanceOf($TO);
          ...
          $AFTER = $TOKEN.balanceOf($TO);

  - id: sol-reentrancy-lock
    message: State variable used as reentrancy guard - use OpenZeppelin ReentrancyGuard
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-regex: '(bool\s+(private|internal)?\s*locked\s*;|require\s*\(\s*!locked\s*,)'

  # ============================================
  # Compiler & Language Issues
  # ============================================

  - id: sol-assembly-usage
    message: Inline assembly detected - review carefully for security issues
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-regex: 'assembly\s*\{'

  - id: sol-deprecated-sha3
    message: sha3() is deprecated - use keccak256() instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: sha3(...)

  - id: sol-implicit-conversion
    message: Implicit type conversion - use explicit casting
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-either:
      - pattern: int($X)
      - pattern: uint($X)

  # ============================================
  # Event & Logging
  # ============================================

  - id: sol-missing-event-ownership
    message: Ownership transfer without event - makes tracking difficult
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern: owner = $NEW
      - pattern-not-inside: |
          emit OwnershipTransferred(...);

  - id: sol-missing-indexed-event
    message: Event parameter not indexed - harder to filter logs
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: event $NAME(address $ADDR, ...)

  # ============================================
  # Security Modifiers
  # ============================================

  - id: sol-require-without-message
    message: require() without error message - harder to debug failures
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern: require($COND)
      - pattern-not: require($COND, $MSG)

  # ============================================
  # DeFi: Flash Loan Attack Patterns
  # ============================================

  - id: sol-flash-loan-callback-external-call
    message: Flash loan callback making external call - potential for callback abuse (Truster/Naive Receiver pattern)
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://www.damnvulnerabledefi.xyz/
    patterns:
      - pattern-inside: |
          function onFlashLoan(...) external returns (bytes32) {
            ...
          }
      - pattern-either:
          - pattern: $ADDR.call(...)
          - pattern: $ADDR.functionCall(...)
          - pattern: $TOKEN.approve($SPENDER, ...)

  - id: sol-flash-loan-governance-attack
    message: Governance action in same transaction as token balance change - flash loan governance attack possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
      references:
        - https://www.damnvulnerabledefi.xyz/
    patterns:
      - pattern-either:
          - pattern: |
              $TOKEN.flashLoan(...);
              ...
              $GOV.propose(...)
          - pattern: |
              $TOKEN.flashLoan(...);
              ...
              $GOV.castVote(...)
          - pattern: |
              $TOKEN.flashLoan(...);
              ...
              $GOV.queue(...)

  - id: sol-flash-loan-reentrancy-side-entrance
    message: Flash loan with deposit/withdraw pattern - potential side entrance attack
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    patterns:
      - pattern-inside: |
          function execute() external {
            ...
          }
      - pattern: '$POOL.deposit{value: ...}()'

  # ============================================
  # DeFi: Oracle Security
  # ============================================

  - id: sol-chainlink-stale-price
    message: Chainlink latestRoundData() without staleness check - stale prices can be exploited
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
      references:
        - https://docs.chain.link/data-feeds/price-feeds
    patterns:
      - pattern: $FEED.latestRoundData()
      - pattern-not-inside: |
          require(block.timestamp - $UPDATED < ..., ...);
          ...
      - pattern-not-inside: |
          if (block.timestamp - $UPDATED > ...) { ... }
          ...

  - id: sol-twap-manipulation
    message: TWAP oracle with short observation window - vulnerable to manipulation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern-regex: 'observe\s*\(\s*\[\s*\d{1,3}\s*,'

  - id: sol-uniswap-v3-twap-short
    message: Uniswap V3 TWAP with short period - consider using longer observation windows
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: $POOL.observe($SECONDS)
      - metavariable-comparison:
          metavariable: $SECONDS
          comparison: $SECONDS < 1800

  # ============================================
  # DeFi: Timelock & Governance
  # ============================================

  - id: sol-timelock-bypass-schedule-in-execute
    message: Schedule called from execute context - timelock bypass vulnerability (Climber pattern)
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-inside: |
          function execute(...) external {
            ...
          }
      - pattern: $TIMELOCK.schedule(...)

  - id: sol-governance-no-quorum-check
    message: Governance proposal execution without quorum validation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: $PROPOSAL.execute(...)
      - pattern-not-inside: |
          require($VOTES >= $QUORUM, ...);
          ...

  # ============================================
  # DeFi: Signature & Permit Security
  # ============================================

  - id: sol-permit-no-deadline-check
    message: ERC20 permit without deadline validation - permits can be replayed
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    patterns:
      - pattern: $TOKEN.permit($OWNER, $SPENDER, $VALUE, $DEADLINE, $V, $R, $S)
      - pattern-not-inside: |
          require($DEADLINE >= block.timestamp, ...);
          ...

  - id: sol-meta-tx-replay
    message: Meta-transaction without nonce tracking - replay attack possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    patterns:
      - pattern-inside: |
          function executeMetaTransaction(...) external {
            ...
          }
      - pattern: ecrecover(...)
      - pattern-not-inside: |
          nonces[$USER]++;
          ...

  - id: sol-signature-no-domain-separator
    message: Signature verification without domain separator - cross-contract replay possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    patterns:
      - pattern: ecrecover($HASH, $V, $R, $S)
      - pattern-not-inside: |
          $DOMAIN = keccak256(abi.encode(..., block.chainid, address(this), ...));
          ...

  # ============================================
  # DeFi: Calldata & ABI Security
  # ============================================

  - id: sol-abi-decode-untrusted
    message: abi.decode on untrusted calldata - potential ABI smuggling attack
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    patterns:
      - pattern-inside: |
          function $FUNC(..., bytes calldata $DATA, ...) external {
            ...
          }
      - pattern: abi.decode($DATA, ...)

  - id: sol-multicall-delegatecall
    message: Multicall with delegatecall - batched operations can bypass checks
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-863: Incorrect Authorization"
    patterns:
      - pattern-inside: |
          function multicall(...) external {
            ...
          }
      - pattern: delegatecall(...)

  # ============================================
  # DeFi: Bridge & Cross-Chain
  # ============================================

  - id: sol-bridge-withdrawal-no-merkle-verify
    message: Bridge withdrawal without Merkle proof verification
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
    patterns:
      - pattern-inside: |
          function withdraw(...) external {
            ...
          }
      - pattern: $TOKEN.transfer($TO, $AMOUNT)
      - pattern-not-inside: |
          MerkleProof.verify(...);
          ...
      - pattern-not-inside: |
          require(MerkleProof.verify(...), ...);
          ...

  - id: sol-bridge-double-spend
    message: Bridge claim without marking as processed - double-spend possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition"
    patterns:
      - pattern-inside: |
          function claim(...) external {
            ...
          }
      - pattern: $TOKEN.transfer(...)
      - pattern-not-inside: |
          claimed[$ID] = true;
          ...
      - pattern-not-inside: |
          processed[$HASH] = true;
          ...

  # ============================================
  # DeFi: Liquidation & Collateral
  # ============================================

  - id: sol-liquidation-no-health-check
    message: Liquidation without health factor validation
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
    patterns:
      - pattern-inside: |
          function liquidate(...) external {
            ...
          }
      - pattern: $TOKEN.transferFrom($BORROWER, ...)
      - pattern-not-inside: |
          require($HEALTH < ..., ...);
          ...

  - id: sol-collateral-price-single-source
    message: Collateral valuation from single price source - use aggregated oracles
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          function getCollateralValue(...) {
            ...
          }
      - pattern: $PRICE = $ORACLE.getPrice(...)
      - pattern-not-inside: |
          $PRICE1 = ...;
          $PRICE2 = ...;
          ...

  # ============================================
  # DeFi: AMM & DEX
  # ============================================

  - id: sol-curve-pool-manipulation
    message: Curve pool interaction without slippage protection - sandwich attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern-regex: '(ICurve|IStableSwap|curve)\w*\.(exchange|add_liquidity|remove_liquidity)\s*\([^)]*,\s*0\s*[,)]'

  - id: sol-amm-spot-price-usage
    message: Using spot price from AMM for valuation - flash loan manipulation possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
    patterns:
      - pattern-either:
          - pattern: $POOL.getReserves()
          - pattern: $PAIR.token0().balanceOf($PAIR)
      - pattern-inside: |
          function $FUNC(...) {
            ...
            $VALUE = ...;
            ...
          }

  # ============================================
  # DeFi: Damn Vulnerable DeFi Patterns
  # ============================================

  - id: sol-msg-value-loop-reuse
    message: "msg.value used in loop - payment can be reused for multiple iterations (Free Rider pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/free-rider/
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern: msg.value

  - id: sol-accounting-mismatch-balanceof
    message: "Contract compares internal accounting to balanceOf() - direct transfers can break invariants (Unstoppable pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/unstoppable/
    pattern-regex: 'require\s*\(\s*\w+\.balanceOf\s*\(\s*(address\s*\(\s*this\s*\)|this)\s*\)\s*==\s*\w+'

  - id: sol-flash-loan-arbitrary-receiver
    message: "Flash loan allows arbitrary receiver address - can drain third-party contracts (Naive Receiver pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/naive-receiver/
    patterns:
      - pattern-inside: |
          function flashLoan(..., address $RECEIVER, ...) external {
            ...
          }
      - pattern-not-inside: |
          require($RECEIVER == msg.sender, ...);
          ...

  - id: sol-flash-loan-external-call-data
    message: "Flash loan executes arbitrary external call with user data - attacker can call any function (Truster pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/truster/
    patterns:
      - pattern-inside: |
          function flashLoan(...) external {
            ...
          }
      - pattern-either:
          - pattern: $TARGET.functionCall($DATA)
          - pattern: $TARGET.call($DATA)

  - id: sol-deposit-in-flash-callback
    message: "Deposit function callable during flash loan callback - side entrance attack possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/side-entrance/
    patterns:
      - pattern-inside: |
          function execute() external payable {
            ...
          }
      - pattern-either:
          - pattern: $POOL.deposit(...)
          - pattern: '$POOL.deposit{value: ...}(...)'

  - id: sol-snapshot-reward-claim
    message: "Reward claim uses current balance snapshot - vulnerable to flash loan manipulation (The Rewarder pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/the-rewarder/
    patterns:
      - pattern-inside: |
          function distributeRewards() external {
            ...
          }
      - pattern: balanceOf(msg.sender)
      - pattern-not-inside: |
          require(block.timestamp > lastRewardTime + ..., ...);
          ...

  - id: sol-execute-before-schedule-check
    message: "Timelock executes operations before verifying they were scheduled - bypass vulnerability (Climber pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/climber/
    pattern-regex: 'for\s*\([^)]+\)\s*\{[^}]*\.call[^}]*\}[^}]*require\s*\('

  - id: sol-fixed-calldata-offset
    message: "Fixed offset used for calldata parsing - ABI smuggling attack possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/abi-smuggling/
    pattern-regex: 'calldataload\s*\(\s*(4\s*\+\s*32\s*\*\s*\d+|\d{2,3})\s*\)'

  - id: sol-gnosis-safe-setup-unchecked
    message: "Safe.setup() called without validating initializer parameters - backdoor possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-749: Exposed Dangerous Method or Function"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/backdoor/
    patterns:
      - pattern: $SAFE.setup($OWNERS, $THRESHOLD, $TO, $DATA, ...)
      - pattern-not-inside: |
          require($TO == address(0), ...);
          ...
      - pattern-not-inside: |
          require($DATA.length == 0, ...);
          ...

  - id: sol-uups-implementation-not-initialized
    message: "UUPS implementation contract not initialized - attacker can take ownership"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/wallet-mining/
    patterns:
      - pattern-inside: |
          contract $CONTRACT is UUPSUpgradeable {
            ...
          }
      - pattern-not: |
          constructor() {
            _disableInitializers();
          }

  - id: sol-curve-virtual-price-in-callback
    message: "Curve get_virtual_price() called during callback - read-only reentrancy attack possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/curvy-puppet/
        - https://chainsecurity.com/heartbreaks-curve-lp-oracles/
    pattern-either:
      - pattern: $POOL.get_virtual_price()
      - pattern: ICurvePool($POOL).get_virtual_price()

  - id: sol-precision-loss-mul-div
    message: "Division before multiplication in fixed-point math - precision loss vulnerability (Shards pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/shards/
    pattern-either:
      - pattern: mulDivDown($X, $Y, $Z)
      - pattern: mulDivUp($X, $Y, $Z)
      - pattern: FixedPointMathLib.mulDivDown($X, $Y, $Z)

  - id: sol-nft-payment-after-transfer
    message: "NFT transfer before payment - msg.sender becomes owner and receives payment (Free Rider pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/free-rider/
    pattern-regex: '(safeTransferFrom|transferFrom)\s*\([^)]+\)\s*;[\s\S]*?payable\s*\(\s*\w+\s*\)\s*\.\s*(transfer|call)'

  - id: sol-bridge-merkle-leaf-no-encode
    message: "Merkle leaf constructed without proper encoding - potential proof forgery"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/withdrawal/
    patterns:
      - pattern: keccak256(abi.encodePacked($LEAF))
      - pattern-inside: |
          function $FUNC(...) {
            ...
            MerkleProof.verify(...);
            ...
          }

  - id: sol-cross-chain-deploy-no-chainid
    message: "Contract deployment without chain ID - cross-chain replay attack possible (Wallet Mining pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/wallet-mining/
    patterns:
      - pattern-either:
          - pattern: CREATE2
          - pattern: create2(...)
      - pattern-not-inside: |
          require(block.chainid == ..., ...);
          ...

  # ============================================
  # DeFi: Additional DVD Patterns for 100% Coverage
  # ============================================

  - id: sol-transfer-in-loop-before-state-update
    message: "Token transfer inside loop before state update - multiple claims possible before validation (The Rewarder pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/the-rewarder/
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern-either:
          - pattern: $TOKEN.transfer($TO, $AMT)
          - pattern: $TOKEN.safeTransfer($TO, $AMT)
          - pattern: SafeTransferLib.safeTransfer($TOKEN, $TO, $AMT)

  - id: sol-merkle-leaf-missing-fields
    message: "Merkle leaf hash missing critical fields - proof may be reusable across contexts (The Rewarder pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/the-rewarder/
    patterns:
      - pattern: keccak256(abi.encodePacked(msg.sender, $AMOUNT))
      - pattern-inside: |
          function $FUNC(...) {
            ...
            MerkleProof.verify(...);
            ...
          }

  - id: sol-oracle-single-source
    message: "Oracle with MIN_SOURCES = 1 - single point of failure, median easily manipulated (Compromised pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-693: Protection Mechanism Failure"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/compromised/
    pattern-regex: 'MIN_SOURCES\s*=\s*1\s*;'

  - id: sol-oracle-no-price-deviation-check
    message: "Oracle price update without deviation check - prices can change arbitrarily (Compromised pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/compromised/
    patterns:
      - pattern-inside: |
          function $FUNC(..., uint256 $PRICE) external {
            ...
          }
      - pattern-either:
          - pattern: _pricesBySource[$SRC][$SYM] = $PRICE
          - pattern: prices[$SYM] = $PRICE
          - pattern: $MAP[$KEY] = $PRICE
      - pattern-not-inside: |
          require($PRICE <= $OLD * ..., ...);
          ...
      - pattern-not-inside: |
          require($PRICE >= $OLD / ..., ...);
          ...

  - id: sol-trusted-role-price-setter
    message: "Price oracle relies on trusted roles without safeguards - compromised keys can manipulate prices"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-269: Improper Privilege Management"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/compromised/
    patterns:
      - pattern-inside: |
          function postPrice(...) external onlyRole($ROLE) {
            ...
          }
      - pattern-not-inside: |
          require(block.timestamp > lastUpdate + ..., ...);
          ...

  - id: sol-claim-bitmap-after-transfer
    message: "Claim bitmap updated after token transfer - reentrancy can bypass claim tracking"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    patterns:
      - pattern: |
          $TOKEN.transfer(...);
          ...
          $CLAIMS[$USER] = ...;

  - id: sol-median-few-sources
    message: "Median price calculated from small source set - vulnerable to collusion or compromise"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-693: Protection Mechanism Failure"
    pattern-regex: 'getMedianPrice|computeMedian|_computeMedianPrice'

  # ============================================
  # Ethernaut Challenge Patterns
  # ============================================

  - id: sol-reverting-fallback-dos
    message: "Fallback/receive with require can cause DoS - callers cannot send ETH if condition fails (King pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-248: Uncaught Exception"
      references:
        - https://ethernaut.openzeppelin.com/level/9
    pattern-regex: '(receive|fallback)\s*\(\s*\)\s+external\s+payable\s*\{[^}]*require\s*\('

  - id: sol-private-not-hidden
    message: "Private variables are readable on-chain via eth_getStorageAt - do not store secrets (Vault pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-200: Exposure of Sensitive Information"
      references:
        - https://ethernaut.openzeppelin.com/level/8
    pattern-regex: '(bytes32|string|bytes)\s+private\s+\w*(password|secret|key|private)\w*\s*[=;]'

  - id: sol-private-array-exposure
    message: "Private arrays/mappings are readable on-chain - storage slots can be computed and read (Privacy pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-200: Exposure of Sensitive Information"
      references:
        - https://ethernaut.openzeppelin.com/level/12
    pattern-regex: 'bytes32\s*\[\s*\d*\s*\]\s+private'

  - id: sol-external-view-manipulation
    message: "External view function called multiple times - attacker can return different values (Elevator/Shop pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-367: Time-of-Check Time-of-Use"
      references:
        - https://ethernaut.openzeppelin.com/level/11
        - https://ethernaut.openzeppelin.com/level/21
    patterns:
      - pattern-inside: |
          function $FUNC(...) {
            ...
          }
      - pattern-either:
          - pattern: |
              if ($IFACE.$VIEW(...)) {
                ...
                $IFACE.$VIEW2(...)
              }
          - pattern: |
              $X = $IFACE.$VIEW(...);
              ...
              $Y = $IFACE.$VIEW2(...);

  - id: sol-array-length-manipulation
    message: "Array length can be manipulated - potential storage slot overflow attack (AlienCodex pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-680: Integer Overflow to Buffer Overflow"
      references:
        - https://ethernaut.openzeppelin.com/level/19
    pattern-either:
      - pattern: $ARR.length--
      - pattern: $ARR.length = $ARR.length - 1
      - pattern-regex: '\w+\.length\s*-=\s*1'

  - id: sol-extcodesize-check-bypassable
    message: "extcodesize check can be bypassed during contract construction (GatekeeperTwo pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://ethernaut.openzeppelin.com/level/14
    pattern-either:
      - pattern: require(extcodesize(msg.sender) == 0, ...)
      - pattern: |
          if (extcodesize(msg.sender) == 0) {
            ...
          }
      - pattern-regex: 'extcodesize\s*\(\s*msg\.sender\s*\)\s*==\s*0'

  - id: sol-gasleft-manipulation
    message: "gasleft() used for access control - can be manipulated by attacker (GatekeeperOne pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      references:
        - https://ethernaut.openzeppelin.com/level/13
    pattern-either:
      - pattern: require(gasleft() % $N == $M, ...)
      - pattern: |
          if (gasleft() % $N == $M) {
            ...
          }

  - id: sol-selfdestruct-force-eth
    message: "selfdestruct can force ETH to any address - contracts cannot prevent receiving ETH this way (Force pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      references:
        - https://ethernaut.openzeppelin.com/level/7
    pattern-either:
      - pattern: selfdestruct(payable($ADDR))
      - pattern: selfdestruct($ADDR)

  - id: sol-delegatecall-preserves-context
    message: "Delegatecall in fallback executes external code in caller's context - storage/owner can be hijacked (Delegation pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://ethernaut.openzeppelin.com/level/6
    pattern-regex: 'fallback\s*\(\s*\)\s+external[^{]*\{[^}]*\.delegatecall\s*\(\s*msg\.data\s*\)'

  - id: sol-transfer-locktime-bypass
    message: "transfer() locked but transferFrom() may not be - check all ERC20 transfer methods (NaughtCoin pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-269: Improper Access Control"
      references:
        - https://ethernaut.openzeppelin.com/level/15
    pattern-regex: 'function\s+transfer\s*\([^)]*\)[^{]*override[^{]*\{[^}]*require\s*\([^)]*lockTime'

  - id: sol-dex-token-validation
    message: "DEX swap accepts any token address - attacker can use fake tokens to drain real ones (DexTwo pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://ethernaut.openzeppelin.com/level/23
    pattern-regex: 'function\s+swap\s*\(\s*address\s+\w+\s*,\s*address\s+\w+[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*token[12])'

  - id: sol-integer-underflow-pre-080
    message: "Unchecked subtraction can underflow in Solidity <0.8.0 - use SafeMath (Token pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-191: Integer Underflow"
      references:
        - https://ethernaut.openzeppelin.com/level/5
    pattern-regex: 'pragma solidity\s*[\^~]?\s*0\.[4-7]\.\d+.*\n[\s\S]*?(balances\s*\[\s*\w+\s*\]\s*-=|balances\s*\[\s*\w+\s*\]\s*-\s*\w+)'

  - id: sol-recovery-address-calculation
    message: "Contract addresses are deterministic - CREATE addresses can be computed from deployer + nonce (Recovery pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      references:
        - https://ethernaut.openzeppelin.com/level/17
    pattern: new $CONTRACT(...)

  - id: sol-good-samaritan-error-spoof
    message: "Custom errors can be spoofed by malicious contracts - do not trust error type for control flow (GoodSamaritan pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-755: Improper Handling of Exceptional Conditions"
      references:
        - https://ethernaut.openzeppelin.com/level/27
    patterns:
      - pattern: |
          try ... {
            ...
          } catch (bytes memory $ERR) {
            if (keccak256($ERR) == keccak256(...)) {
              ...
            }
          }

  - id: sol-higher-order-calldata-bypass
    message: "Assembly calldataload reads 32 bytes regardless of declared type - uint8 can receive larger values (HigherOrder pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://ethernaut.openzeppelin.com/level/30
    pattern-regex: 'function\s+\w+\s*\(\s*(uint8|uint16|uint24|uint32|int8|int16|int24|int32)\s+\w+[^)]*\)[^{]*\{[^}]*calldataload\s*\('

  # ============================================
  # MagicNumber Pattern (Level 18)
  # ============================================

  - id: sol-raw-bytecode-create
    message: "Raw bytecode deployment via create/create2 - verify bytecode source and intent (MagicNumber pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      references:
        - https://ethernaut.openzeppelin.com/level/18
    pattern-either:
      - pattern: create($VALUE, $OFFSET, $SIZE)
      - pattern: create2($VALUE, $OFFSET, $SIZE, $SALT)

  - id: sol-assembly-codecopy
    message: "Assembly codecopy can deploy arbitrary bytecode - ensure code source is trusted (MagicNumber pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      references:
        - https://ethernaut.openzeppelin.com/level/18
    pattern: codecopy($DEST, $OFFSET, $SIZE)

  - id: sol-extcodesize-check
    message: "extcodesize check can be bypassed during constructor - contracts have size 0 while being created"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition"
      references:
        - https://ethernaut.openzeppelin.com/level/18
    pattern: extcodesize($ADDR)

  # ============================================
  # DoubleEntryPoint Pattern (Level 26)
  # ============================================

  - id: sol-delegate-transfer-function
    message: "delegateTransfer function enables proxy attacks - callers may unknowingly trigger different token transfers"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-441: Unintended Proxy or Intermediary"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-regex: 'function\s+delegateTransfer\s*\([^)]*\)'

  - id: sol-sweep-token-no-delegation-check
    message: "Sweep function doesn't check for token delegation - tokens may delegate to protected underlying (DoubleEntryPoint pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-441: Unintended Proxy or Intermediary"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-regex: 'function\s+(sweepToken|sweep)\s*\([^)]*\)[^{]*\{[^}]*\.transfer\s*\('

  - id: sol-transfer-delegates-to-other
    message: "Token transfer function delegates to another contract - may cause unexpected state changes in caller"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-441: Unintended Proxy or Intermediary"
    pattern-regex: 'function\s+transfer\s*\([^)]*\)[^{]*\{[^}]*\.delegateTransfer\s*\('

  - id: sol-token-identity-check-bypass
    message: "Token identity check may be bypassed via delegation - compare actual underlying, not wrapper address"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-290: Authentication Bypass by Spoofing"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-regex: 'require\s*\(\s*\w+\s*!=\s*(underlying|token)\s*,'

  - id: sol-forta-detection-bot
    message: "Forta detection bot pattern - monitors for suspicious transactions (DoubleEntryPoint defense)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-either:
      - pattern-regex: 'function\s+handleTransaction\s*\([^)]*\)[^{]*\{[^}]*raiseAlert\s*\('
      - pattern: IDetectionBot($BOT).handleTransaction(...)

  # ============================================
  # Capture The Ether Patterns
  # ============================================

  - id: sol-transferfrom-msg-sender-balance
    message: "transferFrom deducts from msg.sender instead of from parameter - allows unauthorized transfers (TokenWhale pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-269: Improper Privilege Management"
      references:
        - https://capturetheether.com/challenges/math/token-whale/
    pattern-regex: 'function\s+transferFrom\s*\([^)]*\)[^{]*\{[^}]*balanceOf\s*\[\s*msg\.sender\s*\]\s*-='

  - id: sol-uninitialized-storage-pointer
    message: "Uninitialized storage pointer defaults to slot 0 - can overwrite critical state (FiftyYears pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      references:
        - https://capturetheether.com/challenges/math/fifty-years/
    pattern-regex: '\w+\s+storage\s+\w+\s*;'

  - id: sol-dynamic-array-length-write
    message: "Direct array length modification can corrupt adjacent storage slots (Mapping pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-119: Buffer Overflow"
      references:
        - https://capturetheether.com/challenges/math/mapping/
    pattern-regex: '\w+\.length\s*=\s*[^;]*\+\s*1'

  - id: sol-tautological-overflow-check
    message: "Tautological overflow check (a + b >= a) is always true - provides no protection (TokenBank pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-697: Incorrect Comparison"
      references:
        - https://capturetheether.com/challenges/miscellaneous/token-bank/
    pattern-regex: 'require\s*\(\s*\w+\s*\+\s*\w+\s*>=\s*\w+\s*\)'

  - id: sol-small-space-keccak
    message: "keccak256 of uint8 has only 256 possibilities - trivially brute-forceable (GuessTheSecretNumber pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-327: Use of Broken Crypto"
      references:
        - https://capturetheether.com/challenges/lottery/guess-secret-number/
    pattern-regex: 'keccak256\s*\(\s*abi\.encodePacked\s*\(\s*uint8'

  - id: sol-constructor-typo
    message: "Function name similar to contract name but not exact - may be intended constructor (AssumeOwnership pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1025: Comparison Using Wrong Factors"
      references:
        - https://capturetheether.com/challenges/miscellaneous/assume-ownership/
    pattern-regex: 'function\s+(Owmer|Ownr|Onwer|owmer|ownr)\s*\('

  - id: sol-hardcoded-answer
    message: "Hardcoded answer in contract - visible to anyone reading bytecode or storage (GuessTheNumber pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-798: Hardcoded Credentials"
      references:
        - https://capturetheether.com/challenges/lottery/guess-the-number/
    pattern-regex: 'uint8\s+(answer|secret|password)\s*=\s*\d+'

  - id: sol-overflow-in-scale-calculation
    message: "Large constant multiplication can overflow - 10**18 * 1 ether overflows (Donation pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow"
      references:
        - https://capturetheether.com/challenges/math/donation/
    pattern-regex: '10\s*\*\*\s*18\s*\*\s*(1\s*)?(ether|gwei)'

  - id: sol-blockhash-256-limit
    message: "blockhash only works for last 256 blocks - older blocks return 0 (PredictTheBlockHash pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-570: Expression Always False"
      references:
        - https://capturetheether.com/challenges/lottery/predict-block-hash/
    pattern-either:
      - pattern: blockhash($BLOCK)
      - pattern: block.blockhash($BLOCK)

  - id: sol-fuzzy-identity-byte-pattern
    message: "Address validation using byte pattern matching - attacker can deploy contracts until address matches (FuzzyIdentity pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-290: Authentication Bypass by Spoofing"
      references:
        - https://capturetheether.com/challenges/accounts/fuzzy-identity/
    pattern-regex: '(bytes20|bytes32)\s+\w+\s*=\s*(bytes20|bytes32)\s*\(\s*(uint160|uint256|address)\s*\('

  - id: sol-public-key-hash-auth
    message: "Authentication based on public key hash - public keys can be recovered from any blockchain transaction (PublicKey pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-287: Improper Authentication"
      references:
        - https://capturetheether.com/challenges/accounts/public-key/
    pattern-regex: 'keccak256\s*\(\s*abi\.(encodePacked|encode)\s*\([^)]*publicKey'

  - id: sol-ecdsa-nonce-reuse-risk
    message: "ECDSA signature validation in critical path - if signer reuses nonce k, private key is recoverable (AccountTakeover pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-323: Reusing a Nonce"
      references:
        - https://capturetheether.com/challenges/accounts/account-takeover/
    patterns:
      - pattern-inside: |
          function $FUNC(...) external {
            ...
          }
      - pattern: ecrecover($HASH, $V, $R, $S)
      - pattern-not-inside: |
          nonces[$USER]++;
          ...

  # ============================================
  # SWC Registry Coverage Rules
  # ============================================

  - id: sol-swc-102-outdated-compiler
    message: "SWC-102: Using outdated Solidity compiler version with known vulnerabilities"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-937: OWASP Top Ten 2013 Category A9"
      swc: "SWC-102"
      references:
        - https://swcregistry.io/docs/SWC-102
    pattern-regex: 'pragma solidity\s*[\^~]?\s*0\.[0-4]\.\d+'

  - id: sol-swc-105-unprotected-withdrawal
    message: "SWC-105: Ether withdrawal without access control - anyone can drain funds"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      swc: "SWC-105"
      references:
        - https://swcregistry.io/docs/SWC-105
    pattern-regex: 'function\s+withdraw\w*\s*\([^)]*\)\s+(public|external)(?![^{]*onlyOwner)[^{]*\{[^}]*\.(transfer|call|send)\s*\('

  - id: sol-swc-108-state-visibility
    message: "SWC-108: State variable missing explicit visibility specifier"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      swc: "SWC-108"
      references:
        - https://swcregistry.io/docs/SWC-108
    pattern-regex: '^\s*(uint\d*|int\d*|address|bool|bytes\d*|string|mapping)\s+(?!public|private|internal)\w+\s*[=;]'

  - id: sol-swc-110-assert-user-input
    message: "SWC-110: assert() used for input validation - use require() instead, assert is for invariants"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-670: Always-Incorrect Control Flow Implementation"
      swc: "SWC-110"
      references:
        - https://swcregistry.io/docs/SWC-110
    pattern-regex: 'assert\s*\(\s*\w+\s*(>|<|>=|<=|==|!=)\s*\w+'

  - id: sol-swc-114-front-running
    message: "SWC-114: Transaction order dependence - vulnerable to front-running/sandwich attacks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      swc: "SWC-114"
      references:
        - https://swcregistry.io/docs/SWC-114
    pattern-regex: 'function\s+(buy|sell|swap|trade|bid|offer)\w*\s*\([^)]*\)[^{]*\{[^}]*msg\.value'

  - id: sol-swc-118-constructor-mismatch
    message: "SWC-118: Function name matches contract name - likely intended as constructor (pre-0.4.22)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      swc: "SWC-118"
      references:
        - https://swcregistry.io/docs/SWC-118
    pattern-regex: 'contract\s+(\w+)\s*\{[^}]*function\s+\1\s*\('

  - id: sol-swc-119-shadowed-variable
    message: "SWC-119: Local variable shadows state variable - may cause unintended behavior"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-706: Use of Incorrectly-Resolved Name"
      swc: "SWC-119"
      references:
        - https://swcregistry.io/docs/SWC-119
    pattern-regex: '(uint\d*|int\d*|address|bool)\s+(owner|balance|total\w*)\s*[=;]'

  - id: sol-swc-125-inheritance-order
    message: "SWC-125: Multiple inheritance may cause incorrect function resolution - check C3 linearization"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      swc: "SWC-125"
      references:
        - https://swcregistry.io/docs/SWC-125
    pattern-regex: 'contract\s+\w+\s+is\s+\w+\s*,\s*\w+\s*,\s*\w+'

  - id: sol-swc-129-typo-plus-equals
    message: "SWC-129: Possible typo - '=+' should likely be '+='"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-480: Use of Incorrect Operator"
      swc: "SWC-129"
      references:
        - https://swcregistry.io/docs/SWC-129
    pattern-regex: '\w+\s*=\+\s*\d+'

  - id: sol-swc-130-rtl-override
    message: "SWC-130: Right-to-left override character detected - possible code obfuscation attack"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-451: User Interface Misrepresentation"
      swc: "SWC-130"
      references:
        - https://swcregistry.io/docs/SWC-130
    pattern-regex: '(\xe2\x80\xae|\xe2\x80\xad|\xe2\x80\xac|\xe2\x81\xa6|\xe2\x81\xa7|\xe2\x81\xa8|\xe2\x81\xa9|\xd8\x9c)'

  - id: sol-swc-134-hardcoded-gas
    message: "SWC-134: Hardcoded gas amount - may break after EVM gas cost changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-676: Use of Potentially Dangerous Function"
      swc: "SWC-134"
      references:
        - https://swcregistry.io/docs/SWC-134
    pattern-regex: '\.(call|send)\s*\{\s*gas\s*:\s*\d+\s*\}'

  - id: sol-swc-135-no-effect
    message: "SWC-135: Comparison has no effect - did you mean assignment (=) instead of (==)?"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-482: Comparing instead of Assigning"
      swc: "SWC-135"
      references:
        - https://swcregistry.io/docs/SWC-135
    pattern-regex: '^\s*\w+\s*==\s*\w+\s*;'

  # ============================================
  # Trail of Bits Not-So-Smart-Contracts Patterns
  # ============================================

  - id: sol-deprecated-var-keyword
    message: "Deprecated 'var' keyword can cause type confusion - resolves to smallest type (e.g., uint8 in loops)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-628: Function Call with Incorrectly Specified Arguments"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/honeypots
    pattern-regex: '\bvar\s+\w+\s*='

  - id: sol-balance-includes-msgvalue
    message: "Logic error: this.balance already includes msg.value - condition may always fail (Honeypot pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-1025: Comparison Using Wrong Factors"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/honeypots
    pattern-regex: 'if\s*\(\s*msg\.value\s*(>=|>|==)\s*(this\.balance|address\s*\(\s*this\s*\)\.balance)'

  - id: sol-callback-no-sender-check
    message: "Callback function without sender validation - unauthorized callers can trigger state changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/unprotected_function
    pattern-regex: 'function\s+(__callback|oracleCallback|fulfillRandomness|rawFulfillRandomWords)\s*\([^)]*\)\s+(public|external)(?![^{]*require\s*\(\s*msg\.sender)'

  - id: sol-public-admin-function
    message: "Administrative function without access control modifier - anyone can call"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/unprotected_function
    pattern-regex: 'function\s+(setOwner|changeOwner|updateOwner|setAdmin|setConfig|setPrice|setRate|pause|unpause|mint|burn)\s*\([^)]*\)\s+(public|external)(?![^{]*(onlyOwner|onlyAdmin|require\s*\(\s*msg\.sender))'

  - id: sol-send-all-balance
    message: "Sending entire contract balance - consider if this is intended behavior"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/denial_of_service
    pattern-regex: '\.(transfer|send|call)\s*(\{[^}]*\})?\s*\(\s*(this\.balance|address\s*\(\s*this\s*\)\.balance)'

  - id: sol-loop-with-transfer
    message: "ETH transfer inside loop - single failed transfer blocks all others (DoS pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/denial_of_service
    pattern-regex: 'for\s*\([^)]*\)\s*\{[^}]*\.(transfer|send)\s*\('

  - id: sol-interface-external-call
    message: "Calling external contract via interface - ensure address is trusted and validated"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/incorrect_interface
    patterns:
      - pattern-inside: |
          function $FUNC(..., address $ADDR, ...) {
            ...
          }
      - pattern-either:
          - pattern: $IFACE($ADDR).$METHOD(...)
          - pattern: I$NAME($ADDR).$METHOD(...)

  - id: sol-forced-ether-assumption
    message: "Strict ETH balance check - contract can receive ETH via selfdestruct bypassing this"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/forced_ether_reception
    pattern-regex: 'require\s*\(\s*(this\.balance|address\s*\(\s*this\s*\)\.balance)\s*==\s*\d+'

  # ============================================
  # Short Address Attack Mitigation
  # ============================================

  - id: sol-short-address-no-payload-check
    message: "ERC20 transfer without msg.data.length validation - vulnerable to short address attack padding"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://blog.sigmaprime.io/solidity-security.html#short-address
        - https://vessenes.com/the-erc20-short-address-attack-explained/
    pattern-regex: 'function\s+transfer\s*\(\s*address\s+\w+\s*,\s*uint\d*\s+\w+\s*\)[^{]*\{(?![^}]*msg\.data\.length)'

  - id: sol-erc20-missing-payload-modifier
    message: "ERC20 transferFrom without payload size validation - consider adding onlyPayloadSize modifier"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://blog.sigmaprime.io/solidity-security.html#short-address
    pattern-regex: 'function\s+transferFrom\s*\(\s*address[^)]+\)[^{]*\{(?![^}]*msg\.data\.length)'

  # ============================================
  # DeFiHackLabs Real-World Attack Patterns
  # ============================================

  - id: sol-read-only-reentrancy
    message: "View function reads state that may be stale during callback - read-only reentrancy risk"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
        - https://chainsecurity.com/curve-lp-oracle-manipulation-post-mortem/
    pattern-regex: 'function\s+\w+\s*\([^)]*\)\s+(external|public)\s+view[^{]*\{[^}]*(balanceOf|totalSupply|getReserves)\s*\('

  - id: sol-first-depositor-attack
    message: "Share calculation vulnerable to first depositor attack - attacker can inflate share price"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
        - https://blog.openzeppelin.com/compound-comprehensive-security-assessment
    pattern-regex: 'totalSupply\s*\(\s*\)\s*==\s*0|totalSupply\s*==\s*0'

  - id: sol-deflationary-token-transfer
    message: "Token transfer without checking actual received amount - deflationary tokens may transfer less"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    patterns:
      - pattern: $TOKEN.transferFrom($FROM, $TO, $AMOUNT)
      - pattern-not-inside: |
          $BEFORE = $TOKEN.balanceOf(...);
          ...
          $AFTER = $TOKEN.balanceOf(...);

  - id: sol-callback-without-reentrancy-guard
    message: "Token callback function without reentrancy protection - ERC777/721/1155 callbacks can reenter"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: 'function\s+(onERC721Received|onERC1155Received|onERC1155BatchReceived|tokensReceived)\s*\([^)]*\)[^{]*\{(?![^}]*nonReentrant)'

  - id: sol-share-inflation-via-donation
    message: "Share price can be manipulated via direct token transfer (donation attack)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: 'assets\s*=\s*\w+\.balanceOf\s*\(\s*address\s*\(\s*this\s*\)\s*\)'

  - id: sol-missing-deadline-check
    message: "Swap/liquidity operation without deadline parameter - transaction can be delayed indefinitely"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: 'function\s+(swap|addLiquidity|removeLiquidity)\w*\s*\([^)]*\)[^{]*\{(?![^}]*deadline)'

  - id: sol-unsafe-downcast
    message: "Unsafe downcast may truncate value - use SafeCast library"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-681: Incorrect Conversion between Numeric Types"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: '(uint128|uint96|uint64|uint32|uint16|uint8|int128|int64|int32|int16|int8)\s*\(\s*\w+'

  - id: sol-unchecked-transfer-return
    message: "Low-level transfer without success check - funds may be lost silently"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: '\(bool\s+\w+,\s*\)\s*=\s*\w+\.call\{value:[^}]+\}\([^)]*\)\s*;(?![^;]*require)'

  - id: sol-price-manipulation-single-block
    message: "Price derived from single block data - vulnerable to flash loan manipulation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: 'getAmountOut|getAmountsOut|quote\s*\('

  - id: sol-missing-slippage-parameter
    message: "DEX interaction without slippage parameter - vulnerable to sandwich attacks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    pattern-regex: 'swapExact\w+\s*\([^)]*,\s*0\s*,'

  # ============================================
  # Secureum Mind Map - High Priority Patterns
  # ============================================

  - id: sol-block-timestamp-manipulation
    message: "Block timestamp used for critical logic - miners can manipulate within ~15 second window"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      secureum: "Pitfalls 101 - Block values as time proxies"
      references:
        - https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/timestamp-dependence/
    pattern-regex: '(block\.timestamp|now)\s*(>|<|>=|<=|==)\s*\w+'

  - id: sol-dangerous-strict-equality
    message: "Strict equality on balance - can be manipulated via selfdestruct or direct transfer"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-697: Incorrect Comparison"
      secureum: "Pitfalls 101 - Dangerous strict equalities"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#dangerous-strict-equalities
    pattern-regex: '(address\s*\(\s*this\s*\)\.balance|this\.balance|\w+\.balanceOf\s*\([^)]*\))\s*==\s*\w+'

  - id: sol-locked-ether
    message: "Contract can receive ETH but has no withdraw function - funds may be permanently locked"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-664: Improper Control of a Resource Through its Lifetime"
      secureum: "Pitfalls 101 - Locked Ether"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#contracts-that-lock-ether
    pattern-regex: '(receive|fallback)\s*\(\s*\)\s*(external|public)\s+payable\s*\{'

  - id: sol-boolean-constant-comparison
    message: "Unnecessary comparison to boolean constant - use variable directly"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-1126: Declaration of Variable with Unnecessarily Wide Scope"
      secureum: "Pitfalls 101 - Boolean constant"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#boolean-equality
    pattern-regex: '(==\s*true|==\s*false|!=\s*true|!=\s*false|true\s*==|false\s*==)'

  - id: sol-chainlink-deprecated-api
    message: "Using deprecated Chainlink latestAnswer() - use latestRoundData() for staleness checks"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
      secureum: "Audit Findings 101 - Assimilators use a deprecated Chainlink API"
      references:
        - https://docs.chain.link/data-feeds/api-reference
    pattern-regex: '\.latestAnswer\s*\(\s*\)'

  - id: sol-uninitialized-local-storage
    message: "Uninitialized local storage variable - points to slot 0 by default, can overwrite state"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-908: Use of Uninitialized Resource"
      secureum: "Pitfalls 101 - Uninitialized storage pointers"
      references:
        - https://swcregistry.io/docs/SWC-109
    pattern-regex: '(struct|mapping)[^;]*\s+storage\s+\w+\s*;'

  - id: sol-function-type-variable
    message: "Function type variable - can be manipulated to jump to arbitrary code locations"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-695: Use of Low-Level Functionality"
      secureum: "Pitfalls 101 - Arbitrary jump with function type variable"
      references:
        - https://swcregistry.io/docs/SWC-127
    pattern-regex: 'function\s*\([^)]*\)\s+(internal|external|public|private)\s+\w+\s*;'

  - id: sol-modifier-no-underscore
    message: "Modifier without underscore (_) - function body will not execute"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-670: Always-Incorrect Control Flow Implementation"
      secureum: "Pitfalls 101 - Incorrect modifier"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-modifier
    pattern-regex: 'modifier\s+\w+\s*\([^)]*\)\s*\{[^}]*\}(?![^}]*_\s*;)'

  - id: sol-assert-state-change
    message: "assert() should only check invariants - state changes in assert can cause issues"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-617: Reachable Assertion"
      secureum: "Pitfalls 101 - assert(), require() state change"
      references:
        - https://swcregistry.io/docs/SWC-110
    pattern-regex: 'assert\s*\([^)]*(\+\+|--|\+=|-=|\*=|/=)[^)]*\)'

  - id: sol-rebasing-token-balance
    message: "Storing rebasing token balance - balance may change without transfer events"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      secureum: "Pitfalls 201 - Token Inflation via interest"
      references:
        - https://github.com/d-xo/weird-erc20#rebasing-tokens
    pattern-regex: 'balances\s*\[\s*\w+\s*\]\s*=\s*\w+\.balanceOf'

  - id: sol-missing-interface-implementation
    message: "Contract inherits interface but may be missing function implementations"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-573: Improper Following of Specification by Caller"
      secureum: "Pitfalls 101 - Missing inheritance"
    pattern-regex: 'contract\s+\w+\s+is\s+[^{]*I[A-Z]\w+'

  - id: sol-insufficient-gas-griefing
    message: "External call with limited gas - may fail due to gas griefing if recipient uses all gas"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      secureum: "Pitfalls 101 - Insufficient gas griefing"
      references:
        - https://consensys.github.io/smart-contract-best-practices/attacks/griefing/
    pattern-regex: '\.(call|send)\s*\{\s*gas\s*:\s*\d+\s*\}\s*\('

  - id: sol-token-decimals-assumption
    message: "Hardcoded 18 decimals assumption - tokens with different decimals will cause calculation errors"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      secureum: "Audit Findings 101 - Tokens with more than 18 decimal points"
      references:
        - https://github.com/d-xo/weird-erc20#high-decimals
    pattern-regex: '(1e18|10\s*\*\*\s*18|1000000000000000000)'

  - id: sol-unprotected-clone-initializer
    message: "Clone/minimal proxy initializer without protection - can be front-run and hijacked"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      secureum: "Audit Findings 101 - Initialization functions can be front-run"
      references:
        - https://blog.openzeppelin.com/security-advisory-initialize-uups-implementation-contracts
    pattern-regex: 'function\s+initialize\s*\([^)]*\)\s+(public|external)(?![^{]*(initializer|onlyOwner|require\s*\(\s*!?\s*initialized))'

  - id: sol-instant-parameter-change
    message: "Critical parameter change without timelock - users cannot react to changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      secureum: "Audit Findings 101 - Governance parameter changes should not be instant"
      references:
        - https://docs.openzeppelin.com/contracts/4.x/api/governance#TimelockController
    pattern-regex: 'function\s+(setFee|setRate|setPrice|setLimit|setThreshold|updateConfig)\s*\([^)]*\)\s+(external|public)(?![^{]*timelock)'

  # ============================================
  # Secureum Mind Map - Medium Priority Patterns
  # ============================================

  - id: sol-dangerous-unary-minus
    message: "Possible typo: '=-' should likely be '-=' (unary minus assignment)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-480: Use of Incorrect Operator"
      secureum: "Pitfalls 101 - Dangerous unary expressions"
      references:
        - https://swcregistry.io/docs/SWC-129
    pattern-regex: '\w+\s*=-\s*\d+'

  - id: sol-modifier-external-call
    message: "Modifier makes external call - can introduce reentrancy or unexpected state changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      secureum: "Pitfalls 101 - Modifier side-effects"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#reentrancy-vulnerabilities-4
    pattern-regex: 'modifier\s+\w+[^{]*\{[^}]*\.(call|delegatecall|staticcall|transfer|send)\s*[({]'

  - id: sol-pre-declaration-usage
    message: "Variable used before declaration - behavior differs between Solidity versions"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-908: Use of Uninitialized Resource"
      secureum: "Pitfalls 101 - Pre-declaration usage of local variables"
    pattern-regex: '\w+\s*=\s*\w+\s*;[^;]*\b(uint|int|address|bool|bytes)\d*\s+\1\s*;'

  - id: sol-similar-variable-names
    message: "Variables with very similar names - potential source of bugs and confusion"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-1114: Inappropriate Whitespace Style"
      secureum: "Pitfalls 101 - Similar variable names"
    pattern-regex: '(\w+)_?\s*,\s*\1[A-Z_]'

  - id: sol-tautology-condition
    message: "Condition is always true/false (tautology/contradiction) - logic error"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-571: Expression is Always True"
      secureum: "Pitfalls 101 - Tautology or contradiction"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#tautology-or-contradiction
    pattern-regex: '(uint\d*\s+\w+[^;]*;\s*[^}]*\1\s*>=\s*0|uint\d*\s+\w+[^;]*<\s*0)'

  - id: sol-out-of-range-enum
    message: "Casting to enum without bounds check - invalid values cause revert in Solidity 0.8+"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-704: Incorrect Type Conversion"
      secureum: "Pitfalls 101 - Out-of-range enum"
      references:
        - https://swcregistry.io/docs/SWC-133
    pattern-regex: '\w+\s*=\s*\w+\s*\(\s*uint\d*\s*\(\s*\w+\s*\)\s*\)'

  - id: sol-multiple-pragma
    message: "Multiple Solidity pragma statements - may cause compilation issues"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-758: Reliance on Undefined Behavior"
      secureum: "Pitfalls 101 - Multiple Solidity pragma"
    pattern-regex: 'pragma\s+solidity[^;]+;[\s\S]*pragma\s+solidity'

  - id: sol-memory-array-length
    message: "Dynamic memory array length from user input - can cause out-of-gas or memory issues"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      secureum: "Pitfalls 101 - Memory array creation overflow"
    pattern-regex: 'new\s+\w+\s*\[\s*\w+\s*\]'

  - id: sol-void-constructor
    message: "Empty constructor or constructor with no effect - may indicate incomplete implementation"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-1164: Irrelevant Code"
      secureum: "Pitfalls 101 - Void constructor"
    pattern-regex: 'constructor\s*\([^)]*\)\s*(\w+\s*)*\{\s*\}'

  - id: sol-redundant-statement
    message: "Redundant statement with no effect - may indicate logic error"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1164: Irrelevant Code"
      secureum: "Pitfalls 101 - Redundant statements"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#redundant-statements
    pattern-regex: '^\s*\w+\s*;\s*$'

  - id: sol-unreachable-code
    message: "Code after return/revert/throw - unreachable and likely a logic error"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-561: Dead Code"
      secureum: "Pitfalls 101 - Dead, Unreachable code"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#dead-code
    pattern-regex: '(return\s+[^;]+;|revert\s*\([^)]*\)\s*;|throw\s*;)\s*\n\s*\w'

  # ============================================
  # Slither HIGH Severity Patterns
  # ============================================

  - id: sol-array-by-reference
    message: "Storage array passed by value to internal function - changes won't persist"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-704: Incorrect Type Conversion"
      slither: "array-by-reference"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#modifying-storage-array-by-value
    pattern-regex: 'function\s+\w+\s*\([^)]*\[\]\s+memory\s+\w+[^)]*\)\s+internal'

  - id: sol-incorrect-shift-assembly
    message: "Incorrect shift in assembly - parameters may be reversed (value, shift vs shift, value)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      slither: "incorrect-shift"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-shift-in-assembly
    pattern-regex: 'assembly\s*\{[^}]*(shl|shr|sar)\s*\([^)]*\)[^}]*\}'

  - id: sol-state-variable-shadowing
    message: "State variable shadows inherited variable - may cause unexpected behavior"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "shadowing-state"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#state-variable-shadowing
    pattern-regex: 'contract\s+\w+\s+is\s+\w+[^{]*\{[^}]*(uint|int|address|bool|bytes|string|mapping)\d*\s+(public|private|internal)?\s*\w+\s*[=;]'

  - id: sol-delegatecall-in-loop
    message: "Delegatecall inside loop with msg.value - value may be reused across iterations"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-670: Always-Incorrect Control Flow Implementation"
      slither: "delegatecall-loop"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#payable-functions-using-delegatecall-inside-a-loop
    pattern-regex: 'for\s*\([^)]*\)\s*\{[^}]*\.delegatecall'

  - id: sol-incorrect-exponentiation
    message: "Possible incorrect exponentiation - ^ is XOR in Solidity, use ** for power"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      slither: "incorrect-exp"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-exponentiation
    pattern-regex: '\d+\s*\^\s*\d+'

  - id: sol-return-bomb
    message: "External call result copied to memory - malicious contract can return huge data (return bomb)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      slither: "return-bomb"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#return-bomb
    pattern-regex: '\(\s*bool\s+\w+\s*,\s*bytes\s+memory\s+\w+\s*\)\s*=\s*\w+\.(call|staticcall)'

  # ============================================
  # Slither MEDIUM Severity Patterns
  # ============================================

  - id: sol-domain-separator-collision
    message: "Custom function named DOMAIN_SEPARATOR may collide with EIP-712 implementation"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-694: Use of Multiple Resources with Duplicate Identifier"
      slither: "domain-separator-collision"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#domain-separator-collision
    pattern-regex: 'function\s+DOMAIN_SEPARATOR\s*\('

  - id: sol-incorrect-erc20-interface
    message: "ERC20 function signature doesn't match standard - may cause integration issues"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-573: Improper Following of Specification by Caller"
      slither: "erc20-interface"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-erc20-interface
    pattern-regex: 'function\s+(transfer|approve|transferFrom)\s*\([^)]*\)\s+(public|external)[^{]*\{(?![^}]*returns\s*\(\s*bool)'

  - id: sol-mapping-deletion
    message: "Deleting mapping inside struct leaves nested data - use separate mapping deletion"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-459: Incomplete Cleanup"
      slither: "mapping-deletion"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#deletion-on-mapping-containing-a-structure
    pattern-regex: 'delete\s+\w+\s*\[\s*\w+\s*\]'

  - id: sol-write-after-write
    message: "Variable written twice without being read between - first write is dead store"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-563: Assignment to Variable without Use"
      slither: "write-after-write"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#write-after-write
    pattern-regex: '(\w+)\s*=\s*[^;]+;\s*\n\s*\1\s*='

  - id: sol-constant-function-assembly
    message: "View/pure function uses assembly - may modify state unexpectedly"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "constant-function-asm"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#constant-functions-using-assembly-code
    pattern-regex: 'function\s+\w+\s*\([^)]*\)[^{]*(view|pure)[^{]*\{[^}]*assembly\s*\{'

  - id: sol-constant-function-state
    message: "View/pure function modifies state - violates function declaration"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "constant-function-state"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#constant-functions-changing-the-state
    pattern-regex: 'function\s+\w+\s*\([^)]*\)[^{]*(view|pure)[^{]*\{[^}]*(\w+\s*=\s*[^=]|\.push\(|\.pop\(|delete\s+)'

  - id: sol-reused-constructor
    message: "Base constructor called multiple times through diamond inheritance - may initialize twice"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-694: Use of Multiple Resources with Duplicate Identifier"
      slither: "reused-constructor"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#reused-base-constructor
    pattern-regex: 'contract\s+\w+\s+is\s+\w+\s*,\s*\w+\s*,\s*\w+'

  # ============================================
  # Oracle-Specific Patterns (Pyth, Chronicle)
  # ============================================

  - id: sol-pyth-deprecated-functions
    message: "Using deprecated Pyth functions - use getPrice/getPriceNoOlderThan instead"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
      slither: "pyth-deprecated-functions"
      references:
        - https://docs.pyth.network/price-feeds/api-reference
    pattern-regex: '\.getValidTimePeriod\s*\(\s*\)|\.getEmaPrice\s*\('

  - id: sol-pyth-unchecked-confidence
    message: "Pyth price used without checking confidence interval - price may be unreliable"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      slither: "pyth-unchecked-confidence"
      references:
        - https://docs.pyth.network/price-feeds/best-practices
    pattern-regex: 'pyth\.\w*[Pp]rice\w*\s*\([^)]*\)(?![^;]*\.conf)'

  - id: sol-chronicle-unchecked-price
    message: "Chronicle oracle price used without staleness/validity check"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      slither: "chronicle-unchecked-price"
      references:
        - https://docs.chroniclelabs.org/
    pattern-regex: 'IChronicle\s*\([^)]*\)\s*\.\s*read\s*\(\s*\)'

  # ============================================
  # Shadowing Patterns
  # ============================================

  - id: sol-shadowing-builtin
    message: "Variable shadows Solidity builtin (msg, block, tx, now, etc.) - very confusing"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "shadowing-builtin"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#builtin-symbol-shadowing
    pattern-regex: '(uint|int|address|bool|bytes)\d*\s+(msg|block|tx|now|this|super|abi|type)\s*[;=]'

  - id: sol-shadowing-local
    message: "Local variable shadows state variable - may cause confusion and bugs"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "shadowing-local"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#local-variable-shadowing
    pattern-regex: 'function\s+\w+\s*\([^)]*\b(\w+)\b[^)]*\)[^{]*\{[^}]*\b\1\b\s*='

  # ============================================
  # Event Patterns
  # ============================================

  - id: sol-missing-events-access-control
    message: "Access control change without event emission - harder to monitor and audit"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      slither: "events-access"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#missing-events-access-control
    pattern-regex: 'function\s+(setOwner|transferOwnership|grantRole|revokeRole|renounceRole)\s*\([^)]*\)[^{]*\{(?![^}]*emit\s+)'

  - id: sol-missing-events-arithmetic
    message: "Critical arithmetic operation without event emission - harder to track state changes"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      slither: "events-maths"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#missing-events-arithmetic
    pattern-regex: 'function\s+(mint|burn|withdraw|deposit|stake|unstake)\s*\([^)]*\)[^{]*\{(?![^}]*emit\s+)'

  - id: sol-unindexed-erc20-events
    message: "ERC20 Transfer/Approval events should have indexed from/to/owner/spender parameters"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      slither: "erc20-indexed"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#unindexed-erc20-event-parameters
    pattern-regex: 'event\s+(Transfer|Approval)\s*\(\s*address\s+(?!indexed)'

  # ============================================
  # L2 / Cross-Chain Patterns
  # ============================================

  - id: sol-optimism-deprecated
    message: "Using deprecated Optimism predeploy or function - may break in future upgrades"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
      slither: "optimism-deprecation"
      references:
        - https://docs.optimism.io/builders/dapp-developers/contracts/system-contracts
    pattern-regex: '(OVM_L2CrossDomainMessenger|OVM_L1BlockNumber|L2CrossDomainMessenger\s*\(\s*0x4200)'

  - id: sol-arbitrum-retryable-order
    message: "Multiple retryable tickets in one transaction - execution order not guaranteed"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      slither: "out-of-order-retryable"
      references:
        - https://docs.arbitrum.io/arbos/l1-to-l2-messaging
    pattern-regex: 'createRetryableTicket\s*\([^)]*\)[^;]*;[^}]*createRetryableTicket\s*\('

  # ============================================
  # Additional DeFi Patterns
  # ============================================

  - id: sol-gelato-unprotected-randomness
    message: "Gelato VRF callback without sender verification - may be spoofed"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      slither: "gelato-unprotected-randomness"
    pattern-regex: 'function\s+_fulfillRandomness\s*\([^)]*\)[^{]*\{(?![^}]*require\s*\(\s*msg\.sender)'

  - id: sol-unprotected-callback
    message: "Callback function without caller validation - external contracts can trigger unexpected behavior"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: 'function\s+(uniswapV2Call|uniswapV3\w*Callback|pancakeCall|onFlashLoan)\s*\([^)]*\)\s+(external|public)(?![^{]*require)'

  - id: sol-erc4626-inflation
    message: "ERC4626 vault without virtual shares/assets - vulnerable to inflation attack"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://blog.openzeppelin.com/a-]novel-defense-against-erc4626-inflation-attacks
    pattern-regex: 'function\s+_convertToShares\s*\([^)]*\)[^{]*\{[^}]*\*\s*totalSupply[^}]*\/\s*totalAssets'

  # ============================================
  # Secureum Audit Findings 101/201 Patterns
  # ============================================

  - id: sol-blacklist-bypass-transferfrom
    message: "transferFrom may bypass blacklist - missing check on 'from' address allows blacklisted users to transfer via approved spenders"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-863: Incorrect Authorization"
      secureum: "Audit Findings 101 - Blacklisting Bypass via transferFrom"
      references:
        - https://github.com/x676f64/secureum-mind_map
    pattern-regex: 'function\s+transferFrom\s*\([^)]*\)[^{]*\{[^}]*(notBlacklisted|_blacklist|blacklisted)[^}]*(?!notBlacklisted\s*\(\s*from)'

  - id: sol-missing-chainid-signature
    message: "Permit/signature without chainId validation - signatures can be replayed across forks"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
      secureum: "Audit Findings 101 - Lack of chainID validation"
      references:
        - https://eips.ethereum.org/EIPS/eip-2612
    pattern-regex: 'DOMAIN_SEPARATOR\s*=[^;]*keccak256\s*\([^)]*(?!chainId|block\.chainid)'

  - id: sol-missing-storage-gap
    message: "Upgradeable contract without storage gap - adding variables in parent will corrupt child storage"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-664: Improper Control of a Resource Through its Lifetime"
      secureum: "Audit Findings 101 - Storage layout in upgradeable contracts"
      references:
        - https://docs.openzeppelin.com/upgrades-plugins/writing-upgradeable
    pattern-regex: 'contract\s+\w+\s+is\s+[^{]*Upgradeable[^{]*\{(?![^}]*uint256\s*\[\s*\d+\s*\]\s+[_]*gap)'

  - id: sol-token-decimals-assumption
    message: "Hardcoded 18 decimal assumption - tokens with >18 or <18 decimals will cause overflow/underflow"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
      secureum: "Audit Findings 201 - Token decimals greater than 18"
      references:
        - https://github.com/d-xo/weird-erc20
    pattern-regex: '(10\s*\*\*\s*18|1e18)\s*[/*]|[/*]\s*(10\s*\*\*\s*18|1e18)'

  - id: sol-event-after-external-call
    message: "Event emitted after external call - reentrancy can cause events to be logged out of order"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      secureum: "Audit Findings 201 - Reentrancy affects event ordering"
    pattern-regex: '\.(call|transfer|send)\s*[\({][^;]*;[^}]*emit\s+\w+'

  - id: sol-erc20-approve-frontrun
    message: "Using approve() without increaseAllowance/decreaseAllowance - vulnerable to front-running race condition"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      secureum: "Audit Findings 201 - ERC20 approval front-running"
      references:
        - https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM
    pattern-regex: 'function\s+approve\s*\(\s*address[^)]*,\s*uint256[^)]*\)[^}]*\{[^}]*_approve[^}]*\}'

  - id: sol-abiencoderv2-experimental
    message: "ABIEncoderV2 is experimental and has had 20+ high-severity bugs - avoid in production"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      secureum: "Audit Findings 201 - ABIEncoderV2 not production-ready"
    pattern-regex: 'pragma\s+experimental\s+ABIEncoderV2'

  - id: sol-flash-loan-callback-unprotected
    message: "Flash loan callback without loan verification - attacker can call directly without actual flash loan"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      secureum: "Audit Findings 101 - Flash minting vulnerabilities"
    pattern-regex: 'function\s+(executeOperation|onFlashLoan|receiveFlashLoan)\s*\([^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*initiator|msg\.sender)'

  - id: sol-initialization-frontrun
    message: "Initialization function can be front-run - use initializer modifier or constructor"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      secureum: "Audit Findings 101 - Initialization functions can be front-run"
    pattern-regex: 'function\s+(init|initialize|setup)\s*\([^)]*\)\s+(external|public)(?![^{]*initializer)'

  - id: sol-contract-existence-check
    message: "Low-level call without contract existence check - call to empty address returns success"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      secureum: "Audit Findings 101 - Lack of contract existence check"
    pattern-regex: '\w+\.(call|delegatecall|staticcall)\s*\([^)]*\)(?![^;]*extcodesize|[^;]*code\.length)'

  - id: sol-two-step-ownership
    message: "Critical ownership transfer in single step - use two-step transfer with pending owner acceptance"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      secureum: "Audit Findings 101 - Lack of two-step procedure"
      references:
        - https://docs.openzeppelin.com/contracts/access-control
    pattern-regex: 'function\s+transferOwnership\s*\([^)]*\)[^{]*\{[^}]*owner\s*=\s*\w+[^}]*\}'

  - id: sol-deprecated-chainlink-api
    message: "Using deprecated Chainlink API (latestAnswer/latestTimestamp) - use latestRoundData() instead"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
      secureum: "Audit Findings 201 - Chainlink deprecated API"
    pattern-regex: '\.(latestAnswer|latestTimestamp|latestRound|getAnswer|getTimestamp)\s*\(\s*\)'

  - id: sol-unbounded-loop-dos
    message: "Unbounded loop iterating over dynamic array - can cause out-of-gas DoS"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      secureum: "Audit Findings 201 - Denial of Service from Unbound List"
    pattern-regex: 'for\s*\([^)]*;\s*\w+\s*<\s*\w+\.length\s*;[^)]*\)[^{]*\{[^}]*(transfer|call|send|external)'

  - id: sol-missing-event-indexed
    message: "Event parameters not indexed - harder to filter and search in logs"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      secureum: "Audit Findings 201 - Lack of indexed parameters in events"
    pattern-regex: 'event\s+\w+\s*\(\s*(?!.*indexed)[^)]+\)'

  - id: sol-instant-governance-change
    message: "Governance parameter changed instantly - use timelock for critical parameter changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      secureum: "Audit Findings 101 - Governance parameter changes should not be instant"
    pattern-regex: 'function\s+set(Fee|Rate|Threshold|Limit|Admin|Owner)\s*\([^)]*\)[^{]*\{[^}]*=[^}]*;[^}]*\}'

  - id: sol-owner-privilege-escalation
    message: "Owner has excessive privileges - single account controls critical functions without checks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-269: Improper Privilege Management"
      secureum: "Audit Findings 201 - Contract owner has too many privileges"
    pattern-regex: 'onlyOwner[^{]*\{[^}]*(selfdestruct|delegatecall|upgrade|mint\s*\(|burn\s*\()'

  - id: sol-safeapprove-usage
    message: "Using safeApprove incorrectly - must set allowance to 0 first for tokens that require it"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      secureum: "Audit Findings 101 - Incorrect safeApprove usage"
    pattern-regex: 'safeApprove\s*\([^,]+,\s*[^0][^)]*\)(?![^;]*safeApprove\s*\([^,]+,\s*0\s*\))'

  # ============================================
  # AMAZEX-DSS-PARIS CTF Patterns
  # ============================================

  - id: sol-inverted-allowance-burnfrom
    message: "burnFrom checks allowance(msg.sender, account) instead of allowance(account, msg.sender) - inverted authorization"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-863: Incorrect Authorization"
      ctf: "AMAZEX-DSS-PARIS Challenge 1 - MagicETH"
    pattern-regex: 'function\s+burnFrom[^{]*\{[^}]*allowance\s*\(\s*msg\.sender\s*,\s*\w+\s*\)'

  - id: sol-selfdestruct-zero-address
    message: "selfdestruct sends funds to zero address - ETH will be permanently lost"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-401: Missing Release of Memory after Effective Lifetime"
      ctf: "AMAZEX-DSS-PARIS Challenge 3 - LendingPool"
    pattern-regex: 'selfdestruct\s*\(\s*payable\s*\(\s*(0|address\s*\(\s*0\s*\))\s*\)\s*\)'

  - id: sol-external-call-before-burn
    message: "External call before _burn - violates CEI pattern, funds transferred but tokens not burned on revert"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      ctf: "AMAZEX-DSS-PARIS Challenge 2 - ModernWETH"
    pattern-regex: '\.call\s*\{[^}]*value[^}]*\}[^;]*;[^}]*_burn\s*\('

  - id: sol-flashloan-fee-truncation
    message: "Flash loan fee uses integer division that can truncate to 0 for small amounts"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "AMAZEX-DSS-PARIS Challenge 6 - YieldPool"
    pattern-regex: 'function\s+flashFee[^{]*\{[^}]*return\s+\w+\s*\/\s*\d+'

  - id: sol-health-factor-decimal-mismatch
    message: "Health factor divided by 10**18 but may use different precision - causes incorrect liquidation logic"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: 'healthFactor\s*\([^)]*\)\s*\/\s*10\s*\*\*\s*18'

  - id: sol-msg-sender-instead-of-param
    message: "Using msg.sender instead of function parameter - common copy-paste bug in user-specific functions"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-480: Use of Incorrect Operator"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: 'function\s+\w+\s*\([^)]*address\s+_user[^)]*\)[^{]*\{[^}]*\[\s*msg\.sender\s*\]'

  - id: sol-withdraw-wrong-comparison
    message: "Withdraw uses >= comparison allowing withdrawal when borrow equals amount - can leave position undercollateralized"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-697: Incorrect Comparison"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: 'function\s+withdraw[^{]*\{[^}]*require\s*\([^)]*\.borrow\s*>=\s*_amount'

  - id: sol-liquidation-incentive-excessive
    message: "Liquidator receives all collateral but repays only partial debt - excessive incentive can drain protocol"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: 'function\s+liquidate[^{]*\{[^}]*collateral[^}]*\/\s*\d+[^}]*transfer'

  - id: sol-division-before-multiplication
    message: "Division before multiplication causes precision loss - multiply first then divide"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "AMAZEX-DSS-PARIS Challenge 6 - YieldPool"
    pattern-regex: '\(\s*\w+\s*\/\s*\w+\s*\)\s*\*\s*\w+'

  - id: sol-amm-price-oracle-single-block
    message: "Using AMM spot price without TWAP - vulnerable to flash loan price manipulation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: '(amm|pool|pair)\.(getPrice|getPriceToken|getReserve|quote)\s*\([^)]*\)(?![^;]*(twap|average|cumulative))'

  - id: sol-flashloan-callback-before-check
    message: "Flash loan transfers assets before validating callback result - assets may not be returned"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      ctf: "AMAZEX-DSS-PARIS Challenge 6 - YieldPool"
    pattern-regex: '(\.transfer\(|\.call\{value)[^;]*;[^}]*(onFlashLoan|executeOperation|flashCallback)'

  - id: sol-missing-zero-amount-check
    message: "Function accepts zero amount without validation - can cause division by zero or empty operations"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      ctf: "AMAZEX-DSS-PARIS Challenge 6 - YieldPool"
    pattern-regex: 'function\s+(deposit|withdraw|swap|addLiquidity|removeLiquidity)\s*\([^)]*uint256\s+\w*(amount|value|wad)[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*>\s*0)'

  # ============================================
  # Paradigm CTF 2021 Patterns
  # ============================================

  - id: sol-dynamic-array-length-increment
    message: "Direct array length increment (pre-0.6 pattern) - can cause storage corruption"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
      ctf: "Paradigm CTF 2021 - Bank"
    pattern-regex: '\w+\s*\[\s*\w+\s*\]\s*\.length\s*\+\+'

  - id: sol-assembly-storage-slot-collision
    message: "sstore with user-controlled slot offset - can overwrite critical storage slots like owner"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-123: Write-what-where Condition"
      ctf: "Paradigm CTF 2021 - Market (EternalStorage)"
    pattern-regex: 'sstore\s*\(\s*add\s*\(\s*(tokenId|id|key|slot)\s*,'

  - id: sol-untrusted-protocol-call
    message: "Calling interface method on untrusted protocol address - attacker can pass malicious contract"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      ctf: "Paradigm CTF 2021 - YieldAggregator"
    pattern-regex: 'function\s+\w+\s*\([^)]*Protocol\s+protocol[^)]*\)[^{]*\{[^}]*(protocol\.(mint|burn|deposit|withdraw|transfer))'

  - id: sol-reserve-integer-division
    message: "Integer division of reserves loses precision - use multiplication before division"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
      ctf: "Paradigm CTF 2021 - Broker"
    pattern-regex: '_?reserve[01]?\s*/\s*_?reserve[01]?'

  - id: sol-unprotected-delegatecall-function
    message: "Function with delegatecall only protected by internal guard check - verify guard cannot be bypassed"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      ctf: "Paradigm CTF 2021 - Vault"
    pattern-regex: 'function\s+(emergencyCall|execute|proxy)\s*\([^)]*address\s+\w+[^)]*bytes\s+(memory|calldata)\s+\w+[^)]*\)[^{]*\{[^}]*\.delegatecall\s*\('

  - id: sol-decimal-scaling-mismatch
    message: "Token decimal scaling with exponentiation - verify consistent handling across different decimals"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "Paradigm CTF 2021 - Swap"
    pattern-regex: '10\s*\*\*\s*\(\s*18\s*-\s*decimals\s*\)|10\s*\*\*\s*\(\s*decimals\s*-\s*18\s*\)'

  - id: sol-owner-delegatecall-hatch
    message: "Owner-only delegatecall function - if owner is compromised, contract storage can be corrupted"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      ctf: "Paradigm CTF 2021 - Bouncer"
    pattern-regex: 'function\s+hatch\s*\([^)]*\)[^{]*\{[^}]*require\s*\([^)]*owner[^)]*\)[^}]*\.delegatecall\s*\('

  - id: sol-convertmany-msgvalue-reuse
    message: "Loop calling payable function - msg.value may be reused across iterations"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-837: Improper Enforcement of a Single, Unique Action"
      ctf: "Paradigm CTF 2021 - Bouncer"
    pattern-regex: 'function\s+\w+Many\s*\([^)]*\)\s+(external|public)\s+payable[^{]*\{[^}]*for\s*\([^)]*\)[^}]*\w+\s*\([^)]*\)\s*;'

  - id: sol-erc20-approval-requirement
    message: "Requiring max approval before transfer - consider using permit or incremental approvals"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-285: Improper Authorization"
      ctf: "Paradigm CTF 2021 - Bouncer"
    pattern-regex: 'require\s*\([^)]*allowance[^)]*==\s*type\s*\(\s*uint256\s*\)\s*\.max'

  - id: sol-withdraw-without-balance-update-first
    message: "Token transfer before balance decrement - potential reentrancy if token has callbacks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      ctf: "Paradigm CTF 2021 - Bank/Vault"
    pattern-regex: '(token|tok)\.(transfer|safeTransfer)\s*\([^)]*\)\s*;[\s\n]*\w+\s*\[\s*\w+\s*\]\s*-='

