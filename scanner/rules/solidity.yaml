# Solidity/Smart Contract Security Rules
# Based on semgrep-rules/solidity - https://github.com/semgrep/semgrep-rules
rules:
  # ============================================
  # Critical: Access Control
  # ============================================

  - id: sol-accessible-selfdestruct
    message: Contract can be destructed by anyone - missing access control on selfdestruct
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://www.parity.io/blog/a-postmortem-on-the-parity-multi-sig-library-self-destruct/
    patterns:
      - pattern-either:
          - pattern: selfdestruct($ADDR)
          - pattern: suicide($ADDR)
      - pattern-not-inside: |
          function $FUNC(...) onlyOwner { ... }
      - pattern-not-inside: |
          require(msg.sender == owner, ...);
          ...

  - id: sol-unrestricted-transferownership
    message: transferOwnership() lacks access control - anyone can take ownership
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-inside: |
          function transferOwnership($ADDR) public { ... }
      - pattern-not-inside: |
          function transferOwnership($ADDR) public onlyOwner { ... }

  # ============================================
  # Critical: Reentrancy
  # ============================================

  - id: sol-erc721-reentrancy
    message: ERC721 safeTransferFrom/safeMint can trigger reentrancy via onERC721Received callback
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://blocksecteam.medium.com/when-safemint-becomes-unsafe-lessons-from-the-hypebears-security-incident-2965209bda2a
    pattern: _checkOnERC721Received(...)

  - id: sol-erc777-reentrancy
    message: ERC777 tokens have send/receive hooks that can trigger reentrancy
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    pattern-either:
      - pattern: IERC777($TOKEN).send(...)
      - pattern: IERC777($TOKEN).operatorSend(...)

  - id: sol-external-call-state-change
    message: State change after external call - potential reentrancy vulnerability
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://consensys.github.io/smart-contract-best-practices/attacks/reentrancy/
    pattern-regex: '\.call\s*\{[^}]*\}\s*\([^)]*\)\s*;[\s\S]*?\w+\s*='

  # ============================================
  # Critical: Arbitrary Calls
  # ============================================

  - id: sol-arbitrary-low-level-call
    message: Arbitrary address with controlled calldata in low-level call - potential code injection
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://blocksecteam.medium.com/li-fi-attack-a-cross-chain-bridge-vulnerability-no-its-due-to-unchecked-external-call-c31e7dadf60f
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $ADDR, ..., bytes calldata $DATA, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $ADDR, ..., bytes calldata $DATA, ...) public { ... }
      - pattern-either:
          - pattern: $ADDR.call($DATA)
          - pattern: '$ADDR.call{value:$V}($DATA)'

  - id: sol-delegatecall-to-arbitrary-address
    message: Delegatecall to user-controlled address - attacker can execute arbitrary code in contract context
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://entethalliance.org/specs/ethtrust-sl/v1/#req-1-delegatecall
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $ANY(..., address $CONTRACT, ...) public {...}
          - pattern-inside: |
              function $ANY(..., address $CONTRACT, ...) external {...}
      - pattern-either:
          - pattern: $CONTRACT.delegatecall(...)
          - pattern: '$CONTRACT.delegatecall{gas:$GAS}(...)'

  # ============================================
  # High: Integer Issues
  # ============================================

  - id: sol-unchecked-arithmetic
    message: Unchecked arithmetic operation - potential overflow/underflow (Solidity <0.8.0)
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
    patterns:
      - pattern-inside: |
          unchecked {
            ...
          }
      - pattern-either:
          - pattern: $X + $Y
          - pattern: $X - $Y
          - pattern: $X * $Y

  # ============================================
  # High: Token Security
  # ============================================

  - id: sol-erc20-public-burn
    message: Public burn function without access control - anyone can burn tokens
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: 'function\s+burn\s*\([^)]*\)\s+(public|external)\s*\{'

  - id: sol-arbitrary-transferfrom
    message: ERC721/ERC20 transferFrom with user-controlled from address - potential unauthorized transfer
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $FROM, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $FROM, ...) public { ... }
      - pattern-either:
          - pattern: $TOKEN.transferFrom($FROM, ...)
          - pattern: IERC20($TOKEN).transferFrom($FROM, ...)
          - pattern: IERC721($TOKEN).transferFrom($FROM, ...)

  # ============================================
  # High: Oracle & Price Manipulation
  # ============================================

  - id: sol-basic-oracle-manipulation
    message: Single-block price oracle - vulnerable to flash loan manipulation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://www.paradigm.xyz/2020/11/so-you-want-to-use-a-price-oracle
    patterns:
      - pattern-either:
          - pattern: $PAIR.getReserves()
          - pattern: IUniswapV2Pair($PAIR).getReserves()

  - id: sol-no-slippage-check
    message: DEX swap without slippage protection - vulnerable to sandwich attacks
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    pattern-regex: '(swap\w+|swapExact\w+)\s*(\{[^}]*\})?\s*\([^)]*,\s*0\s*,'

  # ============================================
  # Medium: Randomness
  # ============================================

  - id: sol-weak-randomness-blockhash
    message: Using blockhash for randomness - miners can manipulate this value
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern-either:
      - pattern: blockhash($BLOCK)
      - pattern: block.timestamp
      - pattern: block.difficulty
      - pattern: block.prevrandao

  - id: sol-incorrect-blockhash
    message: blockhash(block.number) always returns 0 - use block.number - 1
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern: blockhash(block.number)

  # ============================================
  # Medium: Signature Issues
  # ============================================

  - id: sol-ecrecover-malleable
    message: ecrecover is vulnerable to signature malleability - use OpenZeppelin ECDSA
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-347: Improper Verification of Cryptographic Signature"
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/ECDSA.sol
    pattern: ecrecover($HASH, $V, $R, $S)

  - id: sol-missing-zero-address-check
    message: Missing zero address validation - tokens/ETH could be lost
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $ADDR, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $ADDR, ...) public { ... }
      - pattern-either:
          - pattern: $ADDR.transfer(...)
          - pattern: $TOKEN.transfer($ADDR, ...)
      - pattern-not-inside: |
          require($ADDR != address(0), ...);
          ...

  # ============================================
  # Medium: Proxy Patterns
  # ============================================

  - id: sol-proxy-storage-collision
    message: Potential storage collision in proxy pattern - use EIP-1967 slots
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-706: Use of Incorrectly-Resolved Name or Reference"
      references:
        - https://eips.ethereum.org/EIPS/eip-1967
    patterns:
      - pattern-inside: |
          contract $PROXY {
            ...
            address $IMPL;
            ...
          }
      - pattern: delegatecall(...)

  # ============================================
  # Info: Best Practices
  # ============================================

  - id: sol-use-ownable2step
    message: Consider using Ownable2Step instead of Ownable for safer ownership transfers
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable2Step.sol
    pattern: import "@openzeppelin/contracts/access/Ownable.sol"

  - id: sol-tx-origin-auth
    message: tx.origin used for authorization - vulnerable to phishing attacks
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
    patterns:
      - pattern-either:
          - pattern: require(tx.origin == $ADDR, ...)
          - pattern: if (tx.origin == $ADDR) { ... }
          - pattern: tx.origin == owner

  - id: sol-encode-packed-collision
    message: abi.encodePacked with multiple dynamic types - potential hash collision
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"
    pattern: abi.encodePacked($A, $B, ...)

  - id: sol-deprecated-suicide
    message: suicide() is deprecated - use selfdestruct() instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: suicide(...)

  - id: sol-floating-pragma
    message: Floating pragma version - pin to a specific version for production
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-regex: 'pragma solidity \^'

  - id: sol-missing-visibility
    message: Function missing explicit visibility specifier
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern: |
          function $FUNC(...) {
            ...
          }
      - pattern-not: |
          function $FUNC(...) public { ... }
      - pattern-not: |
          function $FUNC(...) external { ... }
      - pattern-not: |
          function $FUNC(...) internal { ... }
      - pattern-not: |
          function $FUNC(...) private { ... }

  # ============================================
  # DeFi: Flash Loan Attacks
  # ============================================

  - id: sol-flash-loan-no-check
    message: Flash loan without proper balance check - ensure atomic execution
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
    pattern-either:
      - pattern: IFlashLoanReceiver($X).executeOperation(...)
      - pattern: IERC3156FlashBorrower($X).onFlashLoan(...)

  - id: sol-unchecked-return-value
    message: Return value of external call not checked - silent failure possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
    patterns:
      - pattern: $TOKEN.transfer($TO, $AMT)
      - pattern-not-inside: require($TOKEN.transfer(...), ...)
      - pattern-not-inside: if ($TOKEN.transfer(...)) { ... }

  - id: sol-unsafe-erc20-transfer
    message: ERC20 transfer without SafeERC20 - some tokens dont return bool
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol
    pattern-either:
      - pattern: IERC20($TOKEN).transfer(...)
      - pattern: IERC20($TOKEN).transferFrom(...)
      - pattern: IERC20($TOKEN).approve(...)

  # ============================================
  # DeFi: Liquidity & AMM Issues
  # ============================================

  - id: sol-hardcoded-deadline
    message: Hardcoded deadline in swap - use block.timestamp + buffer
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern-either:
      - pattern: $ROUTER.swapExactTokensForTokens(..., 9999999999, ...)
      - pattern: $ROUTER.swapExactTokensForTokens(..., type(uint256).max, ...)

  - id: sol-approve-max
    message: Unlimited token approval - use exact amount needed
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-either:
      - pattern: $TOKEN.approve($SPENDER, type(uint256).max)
      - pattern: IERC20($TOKEN).approve($SPENDER, type(uint256).max)

  - id: sol-missing-deadline
    message: DEX swap without deadline - transaction can be delayed by miners
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern: $ROUTER.swapExactTokensForTokens(..., block.timestamp, ...)

  # ============================================
  # NFT Security
  # ============================================

  - id: sol-nft-overflow-mint
    message: NFT mint without supply check - potential overflow in tokenId
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: _mint($TO, $ID)
      - pattern-not-inside: |
          require($ID <= $MAX, ...);
          ...

  - id: sol-erc721-no-exists-check
    message: ERC721 operation without existence check - token may not exist
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    patterns:
      - pattern: ownerOf($ID)
      - pattern-not-inside: |
          require(_exists($ID), ...);
          ...

  - id: sol-nft-royalty-bypass
    message: NFT transfer without royalty enforcement - use ERC2981
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-either:
      - pattern: safeTransferFrom($FROM, $TO, $ID)
      - pattern: transferFrom($FROM, $TO, $ID)

  # ============================================
  # Staking & Rewards
  # ============================================

  - id: sol-reward-before-update
    message: "Potential reward-before-update pattern - verify state is updated before calculations (review suggested)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      note: "Downgraded to INFO - pattern is too broad (matches any two sequential assignments)"
    patterns:
      - pattern-inside: |
          function $FUNC(...) {
            ...
          }
      - pattern: |
          $REWARD = $CALC;
          ...
          $STATE = $NEW;

  - id: sol-division-before-multiplication
    message: Division before multiplication causes precision loss
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern: ($X / $Y) * $Z

  # ============================================
  # Gas & DOS
  # ============================================

  - id: sol-unbounded-loop
    message: Unbounded loop over array - potential DOS via gas limit
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
    patterns:
      - pattern: |
          for (uint $I = 0; $I < $ARR.length; $I++) {
            ...
          }

  - id: sol-external-call-in-loop
    message: External call in loop - gas griefing and DOS risk
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern-either:
          - pattern: $ADDR.call(...)
          - pattern: $ADDR.transfer(...)
          - pattern: $ADDR.send(...)

  - id: sol-send-without-check
    message: send() return value not checked - silent failure
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: $ADDR.send($AMT)
      - pattern-not-inside: require($ADDR.send(...), ...)
      - pattern-not-inside: if ($ADDR.send(...)) { ... }

  # ============================================
  # Governance & Voting
  # ============================================

  - id: sol-flashloan-governance
    message: Governance vote without snapshot - flash loan attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: balanceOf($VOTER)
      - pattern-inside: |
          function vote(...) {
            ...
          }

  - id: sol-centralized-admin
    message: Single admin with full control - consider multisig or timelock
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern-either:
          - pattern: onlyOwner
          - pattern: require(msg.sender == owner, ...)

  # ============================================
  # Upgradeable Contracts
  # ============================================

  - id: sol-initialize-not-protected
    message: initialize() without initializer modifier - can be called multiple times
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: |
          function initialize(...) public {
            ...
          }
      - pattern-not: |
          function initialize(...) public initializer { ... }

  - id: sol-selfdestruct-in-implementation
    message: selfdestruct in implementation contract - proxy becomes unusable
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: selfdestruct($ADDR)
      - pattern-inside: |
          contract $CONTRACT is Initializable {
            ...
          }

  - id: sol-no-gap-storage
    message: Upgradeable contract without storage gap - future upgrade collision risk
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
      references:
        - https://docs.openzeppelin.com/contracts/4.x/upgradeable#storage_gaps
    pattern-regex: 'contract\s+\w+\s+is\s+Initializable\s*\{'

  # ============================================
  # Cross-Chain & Bridge
  # ============================================

  - id: sol-cross-chain-replay
    message: Cross-chain call without chain ID check - replay attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-either:
          - pattern: keccak256(abi.encode(...))
          - pattern: keccak256(abi.encodePacked(...))
      - pattern-not-inside: |
          keccak256(abi.encode(..., block.chainid, ...))

  # ============================================
  # Additional Token Issues
  # ============================================

  - id: sol-erc20-double-approve
    message: ERC20 approve race condition - use increaseAllowance instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      references:
        - https://github.com/ethereum/EIPs/issues/20#issuecomment-263524729
    pattern: approve($SPENDER, $AMT)

  - id: sol-fee-on-transfer-token
    message: Token amount after transfer may differ - check actual received amount
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    patterns:
      - pattern: $TOKEN.transferFrom($FROM, $TO, $AMT)
      - pattern-not-inside: |
          $BEFORE = $TOKEN.balanceOf($TO);
          ...
          $AFTER = $TOKEN.balanceOf($TO);

  - id: sol-reentrancy-lock
    message: State variable used as reentrancy guard - use OpenZeppelin ReentrancyGuard
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-regex: '(bool\s+(private|internal)?\s*locked\s*;|require\s*\(\s*!locked\s*,)'

  # ============================================
  # Compiler & Language Issues
  # ============================================

  - id: sol-assembly-usage
    message: Inline assembly detected - review carefully for security issues
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-regex: 'assembly\s*\{'

  - id: sol-deprecated-sha3
    message: sha3() is deprecated - use keccak256() instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: sha3(...)

  - id: sol-implicit-conversion
    message: Implicit type conversion - use explicit casting
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-either:
      - pattern: int($X)
      - pattern: uint($X)

  # ============================================
  # Event & Logging
  # ============================================

  - id: sol-missing-event-ownership
    message: Ownership transfer without event - makes tracking difficult
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern: owner = $NEW
      - pattern-not-inside: |
          emit OwnershipTransferred(...);

  - id: sol-missing-indexed-event
    message: Event parameter not indexed - harder to filter logs
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: event $NAME(address $ADDR, ...)

  # ============================================
  # Security Modifiers
  # ============================================

  - id: sol-require-without-message
    message: require() without error message - harder to debug failures
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern: require($COND)
      - pattern-not: require($COND, $MSG)

  # ============================================
  # DeFi: Flash Loan Attack Patterns
  # ============================================

  - id: sol-flash-loan-callback-external-call
    message: Flash loan callback making external call - potential for callback abuse (Truster/Naive Receiver pattern)
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://www.damnvulnerabledefi.xyz/
    patterns:
      - pattern-inside: |
          function onFlashLoan(...) external returns (bytes32) {
            ...
          }
      - pattern-either:
          - pattern: $ADDR.call(...)
          - pattern: $ADDR.functionCall(...)
          - pattern: $TOKEN.approve($SPENDER, ...)

  - id: sol-flash-loan-governance-attack
    message: Governance action in same transaction as token balance change - flash loan governance attack possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
      references:
        - https://www.damnvulnerabledefi.xyz/
    patterns:
      - pattern-either:
          - pattern: |
              $TOKEN.flashLoan(...);
              ...
              $GOV.propose(...)
          - pattern: |
              $TOKEN.flashLoan(...);
              ...
              $GOV.castVote(...)
          - pattern: |
              $TOKEN.flashLoan(...);
              ...
              $GOV.queue(...)

  - id: sol-flash-loan-reentrancy-side-entrance
    message: Flash loan with deposit/withdraw pattern - potential side entrance attack
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    patterns:
      - pattern-inside: |
          function execute() external {
            ...
          }
      - pattern: '$POOL.deposit{value: ...}()'

  # ============================================
  # DeFi: Oracle Security
  # ============================================

  - id: sol-chainlink-stale-price
    message: Chainlink latestRoundData() without staleness check - stale prices can be exploited
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
      references:
        - https://docs.chain.link/data-feeds/price-feeds
    patterns:
      - pattern: $FEED.latestRoundData()
      - pattern-not-inside: |
          require(block.timestamp - $UPDATED < ..., ...);
          ...
      - pattern-not-inside: |
          if (block.timestamp - $UPDATED > ...) { ... }
          ...

  - id: sol-twap-manipulation
    message: TWAP oracle with short observation window - vulnerable to manipulation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern-regex: 'observe\s*\(\s*\[\s*\d{1,3}\s*,'

  - id: sol-uniswap-v3-twap-short
    message: Uniswap V3 TWAP with short period - consider using longer observation windows
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: $POOL.observe($SECONDS)
      - metavariable-comparison:
          metavariable: $SECONDS
          comparison: $SECONDS < 1800

  # ============================================
  # DeFi: Timelock & Governance
  # ============================================

  - id: sol-timelock-bypass-schedule-in-execute
    message: Schedule called from execute context - timelock bypass vulnerability (Climber pattern)
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-inside: |
          function execute(...) external {
            ...
          }
      - pattern: $TIMELOCK.schedule(...)

  - id: sol-governance-no-quorum-check
    message: Governance proposal execution without quorum validation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: $PROPOSAL.execute(...)
      - pattern-not-inside: |
          require($VOTES >= $QUORUM, ...);
          ...

  # ============================================
  # DeFi: Signature & Permit Security
  # ============================================

  - id: sol-permit-no-deadline-check
    message: ERC20 permit without deadline validation - permits can be replayed
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    patterns:
      - pattern: $TOKEN.permit($OWNER, $SPENDER, $VALUE, $DEADLINE, $V, $R, $S)
      - pattern-not-inside: |
          require($DEADLINE >= block.timestamp, ...);
          ...

  - id: sol-meta-tx-replay
    message: Meta-transaction without nonce tracking - replay attack possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    patterns:
      - pattern-inside: |
          function executeMetaTransaction(...) external {
            ...
          }
      - pattern: ecrecover(...)
      - pattern-not-inside: |
          nonces[$USER]++;
          ...

  - id: sol-signature-no-domain-separator
    message: Signature verification without domain separator - cross-contract replay possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    patterns:
      - pattern: ecrecover($HASH, $V, $R, $S)
      - pattern-not-inside: |
          $DOMAIN = keccak256(abi.encode(..., block.chainid, address(this), ...));
          ...

  # ============================================
  # DeFi: Calldata & ABI Security
  # ============================================

  - id: sol-abi-decode-untrusted
    message: abi.decode on untrusted calldata - potential ABI smuggling attack
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    patterns:
      - pattern-inside: |
          function $FUNC(..., bytes calldata $DATA, ...) external {
            ...
          }
      - pattern: abi.decode($DATA, ...)

  - id: sol-multicall-delegatecall
    message: Multicall with delegatecall - batched operations can bypass checks
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-863: Incorrect Authorization"
    patterns:
      - pattern-inside: |
          function multicall(...) external {
            ...
          }
      - pattern: delegatecall(...)

  # ============================================
  # DeFi: Bridge & Cross-Chain
  # ============================================

  - id: sol-bridge-withdrawal-no-merkle-verify
    message: Bridge withdrawal without Merkle proof verification
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
    patterns:
      - pattern-inside: |
          function withdraw(...) external {
            ...
          }
      - pattern: $TOKEN.transfer($TO, $AMOUNT)
      - pattern-not-inside: |
          MerkleProof.verify(...);
          ...
      - pattern-not-inside: |
          require(MerkleProof.verify(...), ...);
          ...

  - id: sol-bridge-double-spend
    message: Bridge claim without marking as processed - double-spend possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition"
    patterns:
      - pattern-inside: |
          function claim(...) external {
            ...
          }
      - pattern: $TOKEN.transfer(...)
      - pattern-not-inside: |
          claimed[$ID] = true;
          ...
      - pattern-not-inside: |
          processed[$HASH] = true;
          ...

  # ============================================
  # DeFi: Liquidation & Collateral
  # ============================================

  - id: sol-liquidation-no-health-check
    message: Liquidation without health factor validation
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
    patterns:
      - pattern-inside: |
          function liquidate(...) external {
            ...
          }
      - pattern: $TOKEN.transferFrom($BORROWER, ...)
      - pattern-not-inside: |
          require($HEALTH < ..., ...);
          ...

  - id: sol-collateral-price-single-source
    message: Collateral valuation from single price source - use aggregated oracles
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          function getCollateralValue(...) {
            ...
          }
      - pattern: $PRICE = $ORACLE.getPrice(...)
      - pattern-not-inside: |
          $PRICE1 = ...;
          $PRICE2 = ...;
          ...

  # ============================================
  # DeFi: AMM & DEX
  # ============================================

  - id: sol-curve-pool-manipulation
    message: Curve pool interaction without slippage protection - sandwich attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern-regex: '(ICurve|IStableSwap|curve)\w*\.(exchange|add_liquidity|remove_liquidity)\s*\([^)]*,\s*0\s*[,)]'

  - id: sol-amm-spot-price-usage
    message: Using spot price from AMM for valuation - flash loan manipulation possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
    patterns:
      - pattern-either:
          - pattern: $POOL.getReserves()
          - pattern: $PAIR.token0().balanceOf($PAIR)
      - pattern-inside: |
          function $FUNC(...) {
            ...
            $VALUE = ...;
            ...
          }

  # ============================================
  # DeFi: Damn Vulnerable DeFi Patterns
  # ============================================

  - id: sol-msg-value-loop-reuse
    message: "msg.value used in loop - payment can be reused for multiple iterations (Free Rider pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/free-rider/
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern: msg.value

  - id: sol-accounting-mismatch-balanceof
    message: "Contract compares internal accounting to balanceOf() - direct transfers can break invariants (Unstoppable pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/unstoppable/
    pattern-regex: 'require\s*\(\s*\w+\.balanceOf\s*\(\s*(address\s*\(\s*this\s*\)|this)\s*\)\s*==\s*\w+'

  - id: sol-flash-loan-arbitrary-receiver
    message: "Flash loan allows arbitrary receiver address - can drain third-party contracts (Naive Receiver pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/naive-receiver/
    patterns:
      - pattern-inside: |
          function flashLoan(..., address $RECEIVER, ...) external {
            ...
          }
      - pattern-not-inside: |
          require($RECEIVER == msg.sender, ...);
          ...

  - id: sol-flash-loan-external-call-data
    message: "Flash loan executes arbitrary external call with user data - attacker can call any function (Truster pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/truster/
    patterns:
      - pattern-inside: |
          function flashLoan(...) external {
            ...
          }
      - pattern-either:
          - pattern: $TARGET.functionCall($DATA)
          - pattern: $TARGET.call($DATA)

  - id: sol-deposit-in-flash-callback
    message: "Deposit function callable during flash loan callback - side entrance attack possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/side-entrance/
    patterns:
      - pattern-inside: |
          function execute() external payable {
            ...
          }
      - pattern-either:
          - pattern: $POOL.deposit(...)
          - pattern: '$POOL.deposit{value: ...}(...)'

  - id: sol-snapshot-reward-claim
    message: "Reward claim uses current balance snapshot - vulnerable to flash loan manipulation (The Rewarder pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/the-rewarder/
    patterns:
      - pattern-inside: |
          function distributeRewards() external {
            ...
          }
      - pattern: balanceOf(msg.sender)
      - pattern-not-inside: |
          require(block.timestamp > lastRewardTime + ..., ...);
          ...

  - id: sol-execute-before-schedule-check
    message: "Timelock executes operations before verifying they were scheduled - bypass vulnerability (Climber pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/climber/
    pattern-regex: 'for\s*\([^)]+\)\s*\{[^}]*\.call[^}]*\}[^}]*require\s*\('

  - id: sol-fixed-calldata-offset
    message: "Fixed offset used for calldata parsing - ABI smuggling attack possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/abi-smuggling/
    pattern-regex: 'calldataload\s*\(\s*(4\s*\+\s*32\s*\*\s*\d+|\d{2,3})\s*\)'

  - id: sol-gnosis-safe-setup-unchecked
    message: "Safe.setup() called without validating initializer parameters - backdoor possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-749: Exposed Dangerous Method or Function"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/backdoor/
    patterns:
      - pattern: $SAFE.setup($OWNERS, $THRESHOLD, $TO, $DATA, ...)
      - pattern-not-inside: |
          require($TO == address(0), ...);
          ...
      - pattern-not-inside: |
          require($DATA.length == 0, ...);
          ...

  - id: sol-uups-implementation-not-initialized
    message: "UUPS implementation contract not initialized - attacker can take ownership"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/wallet-mining/
    patterns:
      - pattern-inside: |
          contract $CONTRACT is UUPSUpgradeable {
            ...
          }
      - pattern-not: |
          constructor() {
            _disableInitializers();
          }

  - id: sol-curve-virtual-price-in-callback
    message: "Curve get_virtual_price() called during callback - read-only reentrancy attack possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/curvy-puppet/
        - https://chainsecurity.com/heartbreaks-curve-lp-oracles/
    pattern-either:
      - pattern: $POOL.get_virtual_price()
      - pattern: ICurvePool($POOL).get_virtual_price()

  - id: sol-precision-loss-mul-div
    message: "Division before multiplication in fixed-point math - precision loss vulnerability (Shards pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/shards/
    pattern-either:
      - pattern: mulDivDown($X, $Y, $Z)
      - pattern: mulDivUp($X, $Y, $Z)
      - pattern: FixedPointMathLib.mulDivDown($X, $Y, $Z)

  - id: sol-nft-payment-after-transfer
    message: "NFT transfer before payment - msg.sender becomes owner and receives payment (Free Rider pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/free-rider/
    pattern-regex: '(safeTransferFrom|transferFrom)\s*\([^)]+\)\s*;[\s\S]*?payable\s*\(\s*\w+\s*\)\s*\.\s*(transfer|call)'

  - id: sol-bridge-merkle-leaf-no-encode
    message: "Merkle leaf constructed without proper encoding - potential proof forgery"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/withdrawal/
    patterns:
      - pattern: keccak256(abi.encodePacked($LEAF))
      - pattern-inside: |
          function $FUNC(...) {
            ...
            MerkleProof.verify(...);
            ...
          }

  - id: sol-cross-chain-deploy-no-chainid
    message: "Contract deployment without chain ID - cross-chain replay attack possible (Wallet Mining pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/wallet-mining/
    patterns:
      - pattern-either:
          - pattern: CREATE2
          - pattern: create2(...)
      - pattern-not-inside: |
          require(block.chainid == ..., ...);
          ...

  # ============================================
  # DeFi: Additional DVD Patterns for 100% Coverage
  # ============================================

  - id: sol-transfer-in-loop-before-state-update
    message: "Token transfer inside loop before state update - multiple claims possible before validation (The Rewarder pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/the-rewarder/
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern-either:
          - pattern: $TOKEN.transfer($TO, $AMT)
          - pattern: $TOKEN.safeTransfer($TO, $AMT)
          - pattern: SafeTransferLib.safeTransfer($TOKEN, $TO, $AMT)

  - id: sol-merkle-leaf-missing-fields
    message: "Merkle leaf hash missing critical fields - proof may be reusable across contexts (The Rewarder pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/the-rewarder/
    patterns:
      - pattern: keccak256(abi.encodePacked(msg.sender, $AMOUNT))
      - pattern-inside: |
          function $FUNC(...) {
            ...
            MerkleProof.verify(...);
            ...
          }

  - id: sol-oracle-single-source
    message: "Oracle with MIN_SOURCES = 1 - single point of failure, median easily manipulated (Compromised pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-693: Protection Mechanism Failure"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/compromised/
    pattern-regex: 'MIN_SOURCES\s*=\s*1\s*;'

  - id: sol-oracle-no-price-deviation-check
    message: "Oracle price update without deviation check - prices can change arbitrarily (Compromised pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/compromised/
    patterns:
      - pattern-inside: |
          function $FUNC(..., uint256 $PRICE) external {
            ...
          }
      - pattern-either:
          - pattern: _pricesBySource[$SRC][$SYM] = $PRICE
          - pattern: prices[$SYM] = $PRICE
          - pattern: $MAP[$KEY] = $PRICE
      - pattern-not-inside: |
          require($PRICE <= $OLD * ..., ...);
          ...
      - pattern-not-inside: |
          require($PRICE >= $OLD / ..., ...);
          ...

  - id: sol-trusted-role-price-setter
    message: "Price oracle relies on trusted roles without safeguards - compromised keys can manipulate prices"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-269: Improper Privilege Management"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/compromised/
    patterns:
      - pattern-inside: |
          function postPrice(...) external onlyRole($ROLE) {
            ...
          }
      - pattern-not-inside: |
          require(block.timestamp > lastUpdate + ..., ...);
          ...

  - id: sol-claim-bitmap-after-transfer
    message: "Claim bitmap updated after token transfer - reentrancy can bypass claim tracking"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    patterns:
      - pattern: |
          $TOKEN.transfer(...);
          ...
          $CLAIMS[$USER] = ...;

  - id: sol-median-few-sources
    message: "Median price calculated from small source set - vulnerable to collusion or compromise"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-693: Protection Mechanism Failure"
    pattern-regex: 'getMedianPrice|computeMedian|_computeMedianPrice'

  # ============================================
  # Ethernaut Challenge Patterns
  # ============================================

  - id: sol-reverting-fallback-dos
    message: "Fallback/receive with require can cause DoS - callers cannot send ETH if condition fails (King pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-248: Uncaught Exception"
      references:
        - https://ethernaut.openzeppelin.com/level/9
    pattern-regex: '(receive|fallback)\s*\(\s*\)\s+external\s+payable\s*\{[^}]*require\s*\('

  - id: sol-private-not-hidden
    message: "Private variables are readable on-chain via eth_getStorageAt - do not store secrets (Vault pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-200: Exposure of Sensitive Information"
      references:
        - https://ethernaut.openzeppelin.com/level/8
    pattern-regex: '(bytes32|string|bytes)\s+private\s+\w*(password|secret|key|private)\w*\s*[=;]'

  - id: sol-private-array-exposure
    message: "Private arrays/mappings are readable on-chain - storage slots can be computed and read (Privacy pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-200: Exposure of Sensitive Information"
      references:
        - https://ethernaut.openzeppelin.com/level/12
    pattern-regex: 'bytes32\s*\[\s*\d*\s*\]\s+private'

  - id: sol-external-view-manipulation
    message: "External view function called multiple times - attacker can return different values (Elevator/Shop pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-367: Time-of-Check Time-of-Use"
      references:
        - https://ethernaut.openzeppelin.com/level/11
        - https://ethernaut.openzeppelin.com/level/21
    patterns:
      - pattern-inside: |
          function $FUNC(...) {
            ...
          }
      - pattern-either:
          - pattern: |
              if ($IFACE.$VIEW(...)) {
                ...
                $IFACE.$VIEW2(...)
              }
          - pattern: |
              $X = $IFACE.$VIEW(...);
              ...
              $Y = $IFACE.$VIEW2(...);

  - id: sol-array-length-manipulation
    message: "Array length can be manipulated - potential storage slot overflow attack (AlienCodex pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-680: Integer Overflow to Buffer Overflow"
      references:
        - https://ethernaut.openzeppelin.com/level/19
    pattern-either:
      - pattern: $ARR.length--
      - pattern: $ARR.length = $ARR.length - 1
      - pattern-regex: '\w+\.length\s*-=\s*1'

  - id: sol-extcodesize-check-bypassable
    message: "extcodesize check can be bypassed during contract construction (GatekeeperTwo pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://ethernaut.openzeppelin.com/level/14
    pattern-either:
      - pattern: require(extcodesize(msg.sender) == 0, ...)
      - pattern: |
          if (extcodesize(msg.sender) == 0) {
            ...
          }
      - pattern-regex: 'extcodesize\s*\(\s*msg\.sender\s*\)\s*==\s*0'

  - id: sol-gasleft-manipulation
    message: "gasleft() used for access control - can be manipulated by attacker (GatekeeperOne pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      references:
        - https://ethernaut.openzeppelin.com/level/13
    pattern-either:
      - pattern: require(gasleft() % $N == $M, ...)
      - pattern: |
          if (gasleft() % $N == $M) {
            ...
          }

  - id: sol-selfdestruct-force-eth
    message: "selfdestruct can force ETH to any address - contracts cannot prevent receiving ETH this way (Force pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      references:
        - https://ethernaut.openzeppelin.com/level/7
    pattern-either:
      - pattern: selfdestruct(payable($ADDR))
      - pattern: selfdestruct($ADDR)

  - id: sol-delegatecall-preserves-context
    message: "Delegatecall in fallback executes external code in caller's context - storage/owner can be hijacked (Delegation pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://ethernaut.openzeppelin.com/level/6
    pattern-regex: 'fallback\s*\(\s*\)\s+external[^{]*\{[^}]*\.delegatecall\s*\(\s*msg\.data\s*\)'

  - id: sol-transfer-locktime-bypass
    message: "transfer() locked but transferFrom() may not be - check all ERC20 transfer methods (NaughtCoin pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-269: Improper Access Control"
      references:
        - https://ethernaut.openzeppelin.com/level/15
    pattern-regex: 'function\s+transfer\s*\([^)]*\)[^{]*override[^{]*\{[^}]*require\s*\([^)]*lockTime'

  - id: sol-dex-token-validation
    message: "DEX swap accepts any token address - attacker can use fake tokens to drain real ones (DexTwo pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://ethernaut.openzeppelin.com/level/23
    pattern-regex: 'function\s+swap\s*\(\s*address\s+\w+\s*,\s*address\s+\w+[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*token[12])'

  - id: sol-integer-underflow-pre-080
    message: "Unchecked subtraction can underflow in Solidity <0.8.0 - use SafeMath (Token pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-191: Integer Underflow"
      references:
        - https://ethernaut.openzeppelin.com/level/5
    pattern-regex: 'pragma solidity\s*[\^~]?\s*0\.[4-7]\.\d+.*\n[\s\S]*?(balances\s*\[\s*\w+\s*\]\s*-=|balances\s*\[\s*\w+\s*\]\s*-\s*\w+)'

  - id: sol-recovery-address-calculation
    message: "Contract addresses are deterministic - CREATE addresses can be computed from deployer + nonce (Recovery pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      references:
        - https://ethernaut.openzeppelin.com/level/17
    pattern: new $CONTRACT(...)

  - id: sol-good-samaritan-error-spoof
    message: "Custom errors can be spoofed by malicious contracts - do not trust error type for control flow (GoodSamaritan pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-755: Improper Handling of Exceptional Conditions"
      references:
        - https://ethernaut.openzeppelin.com/level/27
    patterns:
      - pattern: |
          try ... {
            ...
          } catch (bytes memory $ERR) {
            if (keccak256($ERR) == keccak256(...)) {
              ...
            }
          }

  - id: sol-higher-order-calldata-bypass
    message: "Assembly calldataload reads 32 bytes regardless of declared type - uint8 can receive larger values (HigherOrder pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://ethernaut.openzeppelin.com/level/30
    pattern-regex: 'function\s+\w+\s*\(\s*(uint8|uint16|uint24|uint32|int8|int16|int24|int32)\s+\w+[^)]*\)[^{]*\{[^}]*calldataload\s*\('

  # ============================================
  # MagicNumber Pattern (Level 18)
  # ============================================

  - id: sol-raw-bytecode-create
    message: "Raw bytecode deployment via create/create2 - verify bytecode source and intent (MagicNumber pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      references:
        - https://ethernaut.openzeppelin.com/level/18
    pattern-either:
      - pattern: create($VALUE, $OFFSET, $SIZE)
      - pattern: create2($VALUE, $OFFSET, $SIZE, $SALT)

  - id: sol-assembly-codecopy
    message: "Assembly codecopy can deploy arbitrary bytecode - ensure code source is trusted (MagicNumber pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      references:
        - https://ethernaut.openzeppelin.com/level/18
    pattern: codecopy($DEST, $OFFSET, $SIZE)

  - id: sol-extcodesize-check
    message: "extcodesize check can be bypassed during constructor - contracts have size 0 while being created"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition"
      references:
        - https://ethernaut.openzeppelin.com/level/18
    pattern: extcodesize($ADDR)

  # ============================================
  # DoubleEntryPoint Pattern (Level 26)
  # ============================================

  - id: sol-delegate-transfer-function
    message: "delegateTransfer function enables proxy attacks - callers may unknowingly trigger different token transfers"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-441: Unintended Proxy or Intermediary"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-regex: 'function\s+delegateTransfer\s*\([^)]*\)'

  - id: sol-sweep-token-no-delegation-check
    message: "Sweep function doesn't check for token delegation - tokens may delegate to protected underlying (DoubleEntryPoint pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-441: Unintended Proxy or Intermediary"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-regex: 'function\s+(sweepToken|sweep)\s*\([^)]*\)[^{]*\{[^}]*\.transfer\s*\('

  - id: sol-transfer-delegates-to-other
    message: "Token transfer function delegates to another contract - may cause unexpected state changes in caller"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-441: Unintended Proxy or Intermediary"
    pattern-regex: 'function\s+transfer\s*\([^)]*\)[^{]*\{[^}]*\.delegateTransfer\s*\('

  - id: sol-token-identity-check-bypass
    message: "Token identity check may be bypassed via delegation - compare actual underlying, not wrapper address"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-290: Authentication Bypass by Spoofing"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-regex: 'require\s*\(\s*\w+\s*!=\s*(underlying|token)\s*,'

  - id: sol-forta-detection-bot
    message: "Forta detection bot pattern - monitors for suspicious transactions (DoubleEntryPoint defense)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-either:
      - pattern-regex: 'function\s+handleTransaction\s*\([^)]*\)[^{]*\{[^}]*raiseAlert\s*\('
      - pattern: IDetectionBot($BOT).handleTransaction(...)

  # ============================================
  # Capture The Ether Patterns
  # ============================================

  - id: sol-transferfrom-msg-sender-balance
    message: "transferFrom deducts from msg.sender instead of from parameter - allows unauthorized transfers (TokenWhale pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-269: Improper Privilege Management"
      references:
        - https://capturetheether.com/challenges/math/token-whale/
    pattern-regex: 'function\s+transferFrom\s*\([^)]*\)[^{]*\{[^}]*balanceOf\s*\[\s*msg\.sender\s*\]\s*-='

  - id: sol-uninitialized-storage-pointer
    message: "Uninitialized storage pointer defaults to slot 0 - can overwrite critical state (FiftyYears pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      references:
        - https://capturetheether.com/challenges/math/fifty-years/
    pattern-regex: '\w+\s+storage\s+\w+\s*;'

  - id: sol-dynamic-array-length-write
    message: "Direct array length modification can corrupt adjacent storage slots (Mapping pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-119: Buffer Overflow"
      references:
        - https://capturetheether.com/challenges/math/mapping/
    pattern-regex: '\w+\.length\s*=\s*[^;]*\+\s*1'

  - id: sol-tautological-overflow-check
    message: "Tautological overflow check (a + b >= a) is always true - provides no protection (TokenBank pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-697: Incorrect Comparison"
      references:
        - https://capturetheether.com/challenges/miscellaneous/token-bank/
    pattern-regex: 'require\s*\(\s*\w+\s*\+\s*\w+\s*>=\s*\w+\s*\)'

  - id: sol-small-space-keccak
    message: "keccak256 of uint8 has only 256 possibilities - trivially brute-forceable (GuessTheSecretNumber pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-327: Use of Broken Crypto"
      references:
        - https://capturetheether.com/challenges/lottery/guess-secret-number/
    pattern-regex: 'keccak256\s*\(\s*abi\.encodePacked\s*\(\s*uint8'

  - id: sol-constructor-typo
    message: "Function name similar to contract name but not exact - may be intended constructor (AssumeOwnership pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1025: Comparison Using Wrong Factors"
      references:
        - https://capturetheether.com/challenges/miscellaneous/assume-ownership/
    pattern-regex: 'function\s+(Owmer|Ownr|Onwer|owmer|ownr)\s*\('

  - id: sol-hardcoded-answer
    message: "Hardcoded answer in contract - visible to anyone reading bytecode or storage (GuessTheNumber pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-798: Hardcoded Credentials"
      references:
        - https://capturetheether.com/challenges/lottery/guess-the-number/
    pattern-regex: 'uint8\s+(answer|secret|password)\s*=\s*\d+'

  - id: sol-overflow-in-scale-calculation
    message: "Large constant multiplication can overflow - 10**18 * 1 ether overflows (Donation pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow"
      references:
        - https://capturetheether.com/challenges/math/donation/
    pattern-regex: '10\s*\*\*\s*18\s*\*\s*(1\s*)?(ether|gwei)'

  - id: sol-blockhash-256-limit
    message: "blockhash only works for last 256 blocks - older blocks return 0 (PredictTheBlockHash pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-570: Expression Always False"
      references:
        - https://capturetheether.com/challenges/lottery/predict-block-hash/
    pattern-either:
      - pattern: blockhash($BLOCK)
      - pattern: block.blockhash($BLOCK)

  - id: sol-fuzzy-identity-byte-pattern
    message: "Address validation using byte pattern matching - attacker can deploy contracts until address matches (FuzzyIdentity pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-290: Authentication Bypass by Spoofing"
      references:
        - https://capturetheether.com/challenges/accounts/fuzzy-identity/
    pattern-regex: '(bytes20|bytes32)\s+\w+\s*=\s*(bytes20|bytes32)\s*\(\s*(uint160|uint256|address)\s*\('

  - id: sol-public-key-hash-auth
    message: "Authentication based on public key hash - public keys can be recovered from any blockchain transaction (PublicKey pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-287: Improper Authentication"
      references:
        - https://capturetheether.com/challenges/accounts/public-key/
    pattern-regex: 'keccak256\s*\(\s*abi\.(encodePacked|encode)\s*\([^)]*publicKey'

  - id: sol-ecdsa-nonce-reuse-risk
    message: "ECDSA signature validation in critical path - if signer reuses nonce k, private key is recoverable (AccountTakeover pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-323: Reusing a Nonce"
      references:
        - https://capturetheether.com/challenges/accounts/account-takeover/
    patterns:
      - pattern-inside: |
          function $FUNC(...) external {
            ...
          }
      - pattern: ecrecover($HASH, $V, $R, $S)
      - pattern-not-inside: |
          nonces[$USER]++;
          ...

  # ============================================
  # SWC Registry Coverage Rules
  # ============================================

  - id: sol-swc-102-outdated-compiler
    message: "SWC-102: Using outdated Solidity compiler version with known vulnerabilities"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-937: OWASP Top Ten 2013 Category A9"
      swc: "SWC-102"
      references:
        - https://swcregistry.io/docs/SWC-102
    pattern-regex: 'pragma solidity\s*[\^~]?\s*0\.[0-4]\.\d+'

  - id: sol-swc-105-unprotected-withdrawal
    message: "SWC-105: Ether withdrawal without access control - anyone can drain funds"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      swc: "SWC-105"
      references:
        - https://swcregistry.io/docs/SWC-105
    pattern-regex: 'function\s+withdraw\w*\s*\([^)]*\)\s+(public|external)(?![^{]*onlyOwner)[^{]*\{[^}]*\.(transfer|call|send)\s*\('

  - id: sol-swc-108-state-visibility
    message: "SWC-108: State variable missing explicit visibility specifier"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      swc: "SWC-108"
      references:
        - https://swcregistry.io/docs/SWC-108
    pattern-regex: '^\s*(uint\d*|int\d*|address|bool|bytes\d*|string|mapping)\s+(?!public|private|internal)\w+\s*[=;]'

  - id: sol-swc-110-assert-user-input
    message: "SWC-110: assert() used for input validation - use require() instead, assert is for invariants"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-670: Always-Incorrect Control Flow Implementation"
      swc: "SWC-110"
      references:
        - https://swcregistry.io/docs/SWC-110
    pattern-regex: 'assert\s*\(\s*\w+\s*(>|<|>=|<=|==|!=)\s*\w+'

  - id: sol-swc-114-front-running
    message: "SWC-114: Transaction order dependence - vulnerable to front-running/sandwich attacks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      swc: "SWC-114"
      references:
        - https://swcregistry.io/docs/SWC-114
    pattern-regex: 'function\s+(buy|sell|swap|trade|bid|offer)\w*\s*\([^)]*\)[^{]*\{[^}]*msg\.value'

  - id: sol-swc-118-constructor-mismatch
    message: "SWC-118: Function name matches contract name - likely intended as constructor (pre-0.4.22)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      swc: "SWC-118"
      references:
        - https://swcregistry.io/docs/SWC-118
    pattern-regex: 'contract\s+(\w+)\s*\{[^}]*function\s+\1\s*\('

  - id: sol-swc-119-shadowed-variable
    message: "SWC-119: Local variable shadows state variable - may cause unintended behavior"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-706: Use of Incorrectly-Resolved Name"
      swc: "SWC-119"
      references:
        - https://swcregistry.io/docs/SWC-119
    pattern-regex: '(uint\d*|int\d*|address|bool)\s+(owner|balance|total\w*)\s*[=;]'

  - id: sol-swc-125-inheritance-order
    message: "SWC-125: Multiple inheritance may cause incorrect function resolution - check C3 linearization"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      swc: "SWC-125"
      references:
        - https://swcregistry.io/docs/SWC-125
    pattern-regex: 'contract\s+\w+\s+is\s+\w+\s*,\s*\w+\s*,\s*\w+'

  - id: sol-swc-129-typo-plus-equals
    message: "SWC-129: Possible typo - '=+' should likely be '+='"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-480: Use of Incorrect Operator"
      swc: "SWC-129"
      references:
        - https://swcregistry.io/docs/SWC-129
    pattern-regex: '\w+\s*=\+\s*\d+'

  - id: sol-swc-130-rtl-override
    message: "SWC-130: Right-to-left override character detected - possible code obfuscation attack"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-451: User Interface Misrepresentation"
      swc: "SWC-130"
      references:
        - https://swcregistry.io/docs/SWC-130
    pattern-regex: '(\xe2\x80\xae|\xe2\x80\xad|\xe2\x80\xac|\xe2\x81\xa6|\xe2\x81\xa7|\xe2\x81\xa8|\xe2\x81\xa9|\xd8\x9c)'

  - id: sol-swc-134-hardcoded-gas
    message: "SWC-134: Hardcoded gas amount - may break after EVM gas cost changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-676: Use of Potentially Dangerous Function"
      swc: "SWC-134"
      references:
        - https://swcregistry.io/docs/SWC-134
    pattern-regex: '\.(call|send)\s*\{\s*gas\s*:\s*\d+\s*\}'

  - id: sol-swc-135-no-effect
    message: "SWC-135: Comparison has no effect - did you mean assignment (=) instead of (==)?"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-482: Comparing instead of Assigning"
      swc: "SWC-135"
      references:
        - https://swcregistry.io/docs/SWC-135
    pattern-regex: '^\s*\w+\s*==\s*\w+\s*;'

  # ============================================
  # Trail of Bits Not-So-Smart-Contracts Patterns
  # ============================================

  - id: sol-deprecated-var-keyword
    message: "Deprecated 'var' keyword can cause type confusion - resolves to smallest type (e.g., uint8 in loops)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-628: Function Call with Incorrectly Specified Arguments"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/honeypots
    pattern-regex: '\bvar\s+\w+\s*='

  - id: sol-balance-includes-msgvalue
    message: "Logic error: this.balance already includes msg.value - condition may always fail (Honeypot pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-1025: Comparison Using Wrong Factors"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/honeypots
    pattern-regex: 'if\s*\(\s*msg\.value\s*(>=|>|==)\s*(this\.balance|address\s*\(\s*this\s*\)\.balance)'

  - id: sol-callback-no-sender-check
    message: "Callback function without sender validation - unauthorized callers can trigger state changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/unprotected_function
    pattern-regex: 'function\s+(__callback|oracleCallback|fulfillRandomness|rawFulfillRandomWords)\s*\([^)]*\)\s+(public|external)(?![^{]*require\s*\(\s*msg\.sender)'

  - id: sol-public-admin-function
    message: "Administrative function without access control modifier - anyone can call"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/unprotected_function
    pattern-regex: 'function\s+(setOwner|changeOwner|updateOwner|setAdmin|setConfig|setPrice|setRate|pause|unpause|mint|burn)\s*\([^)]*\)\s+(public|external)(?![^{]*(onlyOwner|onlyAdmin|require\s*\(\s*msg\.sender))'

  - id: sol-send-all-balance
    message: "Sending entire contract balance - consider if this is intended behavior"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/denial_of_service
    pattern-regex: '\.(transfer|send|call)\s*(\{[^}]*\})?\s*\(\s*(this\.balance|address\s*\(\s*this\s*\)\.balance)'

  - id: sol-loop-with-transfer
    message: "ETH transfer inside loop - single failed transfer blocks all others (DoS pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/denial_of_service
    pattern-regex: 'for\s*\([^)]*\)\s*\{[^}]*\.(transfer|send)\s*\('

  - id: sol-interface-external-call
    message: "Calling external contract via interface - ensure address is trusted and validated"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/incorrect_interface
    patterns:
      - pattern-inside: |
          function $FUNC(..., address $ADDR, ...) {
            ...
          }
      - pattern-either:
          - pattern: $IFACE($ADDR).$METHOD(...)
          - pattern: I$NAME($ADDR).$METHOD(...)

  - id: sol-forced-ether-assumption
    message: "Strict ETH balance check - contract can receive ETH via selfdestruct bypassing this"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      references:
        - https://github.com/crytic/not-so-smart-contracts/tree/master/forced_ether_reception
    pattern-regex: 'require\s*\(\s*(this\.balance|address\s*\(\s*this\s*\)\.balance)\s*==\s*\d+'

  # ============================================
  # Short Address Attack Mitigation
  # ============================================

  - id: sol-short-address-no-payload-check
    message: "ERC20 transfer without msg.data.length validation - vulnerable to short address attack padding"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://blog.sigmaprime.io/solidity-security.html#short-address
        - https://vessenes.com/the-erc20-short-address-attack-explained/
    pattern-regex: 'function\s+transfer\s*\(\s*address\s+\w+\s*,\s*uint\d*\s+\w+\s*\)[^{]*\{(?![^}]*msg\.data\.length)'

  - id: sol-erc20-missing-payload-modifier
    message: "ERC20 transferFrom without payload size validation - consider adding onlyPayloadSize modifier"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://blog.sigmaprime.io/solidity-security.html#short-address
    pattern-regex: 'function\s+transferFrom\s*\(\s*address[^)]+\)[^{]*\{(?![^}]*msg\.data\.length)'

  # ============================================
  # DeFiHackLabs Real-World Attack Patterns
  # ============================================

  - id: sol-read-only-reentrancy
    message: "View function reads state that may be stale during callback - read-only reentrancy risk"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
        - https://chainsecurity.com/curve-lp-oracle-manipulation-post-mortem/
    pattern-regex: 'function\s+\w+\s*\([^)]*\)\s+(external|public)\s+view[^{]*\{[^}]*(balanceOf|totalSupply|getReserves)\s*\('

  - id: sol-first-depositor-attack
    message: "Share calculation vulnerable to first depositor attack - attacker can inflate share price"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
        - https://blog.openzeppelin.com/compound-comprehensive-security-assessment
    pattern-regex: 'totalSupply\s*\(\s*\)\s*==\s*0|totalSupply\s*==\s*0'

  - id: sol-deflationary-token-transfer
    message: "Token transfer without checking actual received amount - deflationary tokens may transfer less"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    patterns:
      - pattern: $TOKEN.transferFrom($FROM, $TO, $AMOUNT)
      - pattern-not-inside: |
          $BEFORE = $TOKEN.balanceOf(...);
          ...
          $AFTER = $TOKEN.balanceOf(...);

  - id: sol-callback-without-reentrancy-guard
    message: "Token callback function without reentrancy protection - ERC777/721/1155 callbacks can reenter"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: 'function\s+(onERC721Received|onERC1155Received|onERC1155BatchReceived|tokensReceived)\s*\([^)]*\)[^{]*\{(?![^}]*nonReentrant)'

  - id: sol-share-inflation-via-donation
    message: "Share price can be manipulated via direct token transfer (donation attack)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: 'assets\s*=\s*\w+\.balanceOf\s*\(\s*address\s*\(\s*this\s*\)\s*\)'

  - id: sol-missing-deadline-check
    message: "Swap/liquidity operation without deadline parameter - transaction can be delayed indefinitely"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: 'function\s+(swap|addLiquidity|removeLiquidity)\w*\s*\([^)]*\)[^{]*\{(?![^}]*deadline)'

  - id: sol-unsafe-downcast
    message: "Unsafe downcast may truncate value - use SafeCast library"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-681: Incorrect Conversion between Numeric Types"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: '(uint128|uint96|uint64|uint32|uint16|uint8|int128|int64|int32|int16|int8)\s*\(\s*\w+'

  - id: sol-unchecked-transfer-return
    message: "Low-level transfer without success check - funds may be lost silently"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: '\(bool\s+\w+,\s*\)\s*=\s*\w+\.call\{value:[^}]+\}\([^)]*\)\s*;(?![^;]*require)'

  - id: sol-price-manipulation-single-block
    message: "Price derived from single block data - vulnerable to flash loan manipulation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://github.com/SunWeb3Sec/DeFiHackLabs
    pattern-regex: 'getAmountOut|getAmountsOut|quote\s*\('

  - id: sol-missing-slippage-parameter
    message: "DEX interaction without slippage parameter - vulnerable to sandwich attacks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    pattern-regex: 'swapExact\w+\s*\([^)]*,\s*0\s*,'

  # ============================================
  # Secureum Mind Map - High Priority Patterns
  # ============================================

  - id: sol-block-timestamp-manipulation
    message: "Block timestamp used for critical logic - miners can manipulate within ~15 second window"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      secureum: "Pitfalls 101 - Block values as time proxies"
      references:
        - https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/timestamp-dependence/
    pattern-regex: '(block\.timestamp|now)\s*(>|<|>=|<=|==)\s*\w+'

  - id: sol-dangerous-strict-equality
    message: "Strict equality on balance - can be manipulated via selfdestruct or direct transfer"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-697: Incorrect Comparison"
      secureum: "Pitfalls 101 - Dangerous strict equalities"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#dangerous-strict-equalities
    pattern-regex: '(address\s*\(\s*this\s*\)\.balance|this\.balance|\w+\.balanceOf\s*\([^)]*\))\s*==\s*\w+'

  - id: sol-locked-ether
    message: "Contract can receive ETH but has no withdraw function - funds may be permanently locked"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-664: Improper Control of a Resource Through its Lifetime"
      secureum: "Pitfalls 101 - Locked Ether"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#contracts-that-lock-ether
    pattern-regex: '(receive|fallback)\s*\(\s*\)\s*(external|public)\s+payable\s*\{'

  - id: sol-boolean-constant-comparison
    message: "Unnecessary comparison to boolean constant - use variable directly"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-1126: Declaration of Variable with Unnecessarily Wide Scope"
      secureum: "Pitfalls 101 - Boolean constant"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#boolean-equality
    pattern-regex: '(==\s*true|==\s*false|!=\s*true|!=\s*false|true\s*==|false\s*==)'

  - id: sol-chainlink-deprecated-api
    message: "Using deprecated Chainlink latestAnswer() - use latestRoundData() for staleness checks"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
      secureum: "Audit Findings 101 - Assimilators use a deprecated Chainlink API"
      references:
        - https://docs.chain.link/data-feeds/api-reference
    pattern-regex: '\.latestAnswer\s*\(\s*\)'

  - id: sol-uninitialized-local-storage
    message: "Uninitialized local storage variable - points to slot 0 by default, can overwrite state"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-908: Use of Uninitialized Resource"
      secureum: "Pitfalls 101 - Uninitialized storage pointers"
      references:
        - https://swcregistry.io/docs/SWC-109
    pattern-regex: '(struct|mapping)[^;]*\s+storage\s+\w+\s*;'

  - id: sol-function-type-variable
    message: "Function type variable - can be manipulated to jump to arbitrary code locations"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-695: Use of Low-Level Functionality"
      secureum: "Pitfalls 101 - Arbitrary jump with function type variable"
      references:
        - https://swcregistry.io/docs/SWC-127
    pattern-regex: 'function\s*\([^)]*\)\s+(internal|external|public|private)\s+\w+\s*;'

  - id: sol-modifier-no-underscore
    message: "Modifier without underscore (_) - function body will not execute"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-670: Always-Incorrect Control Flow Implementation"
      secureum: "Pitfalls 101 - Incorrect modifier"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-modifier
    pattern-regex: 'modifier\s+\w+\s*\([^)]*\)\s*\{[^}]*\}(?![^}]*_\s*;)'

  - id: sol-assert-state-change
    message: "assert() should only check invariants - state changes in assert can cause issues"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-617: Reachable Assertion"
      secureum: "Pitfalls 101 - assert(), require() state change"
      references:
        - https://swcregistry.io/docs/SWC-110
    pattern-regex: 'assert\s*\([^)]*(\+\+|--|\+=|-=|\*=|/=)[^)]*\)'

  - id: sol-rebasing-token-balance
    message: "Storing rebasing token balance - balance may change without transfer events"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      secureum: "Pitfalls 201 - Token Inflation via interest"
      references:
        - https://github.com/d-xo/weird-erc20#rebasing-tokens
    pattern-regex: 'balances\s*\[\s*\w+\s*\]\s*=\s*\w+\.balanceOf'

  - id: sol-missing-interface-implementation
    message: "Contract inherits interface but may be missing function implementations"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-573: Improper Following of Specification by Caller"
      secureum: "Pitfalls 101 - Missing inheritance"
    pattern-regex: 'contract\s+\w+\s+is\s+[^{]*I[A-Z]\w+'

  - id: sol-insufficient-gas-griefing
    message: "External call with limited gas - may fail due to gas griefing if recipient uses all gas"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      secureum: "Pitfalls 101 - Insufficient gas griefing"
      references:
        - https://consensys.github.io/smart-contract-best-practices/attacks/griefing/
    pattern-regex: '\.(call|send)\s*\{\s*gas\s*:\s*\d+\s*\}\s*\('

  - id: sol-token-decimals-assumption
    message: "Hardcoded 18 decimals assumption - tokens with different decimals will cause calculation errors"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      secureum: "Audit Findings 101 - Tokens with more than 18 decimal points"
      references:
        - https://github.com/d-xo/weird-erc20#high-decimals
    pattern-regex: '(1e18|10\s*\*\*\s*18|1000000000000000000)'

  - id: sol-unprotected-clone-initializer
    message: "Clone/minimal proxy initializer without protection - can be front-run and hijacked"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      secureum: "Audit Findings 101 - Initialization functions can be front-run"
      references:
        - https://blog.openzeppelin.com/security-advisory-initialize-uups-implementation-contracts
    pattern-regex: 'function\s+initialize\s*\([^)]*\)\s+(public|external)(?![^{]*(initializer|onlyOwner|require\s*\(\s*!?\s*initialized))'

  - id: sol-instant-parameter-change
    message: "Critical parameter change without timelock - users cannot react to changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      secureum: "Audit Findings 101 - Governance parameter changes should not be instant"
      references:
        - https://docs.openzeppelin.com/contracts/4.x/api/governance#TimelockController
    pattern-regex: 'function\s+(setFee|setRate|setPrice|setLimit|setThreshold|updateConfig)\s*\([^)]*\)\s+(external|public)(?![^{]*timelock)'

  # ============================================
  # Secureum Mind Map - Medium Priority Patterns
  # ============================================

  - id: sol-dangerous-unary-minus
    message: "Possible typo: '=-' should likely be '-=' (unary minus assignment)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-480: Use of Incorrect Operator"
      secureum: "Pitfalls 101 - Dangerous unary expressions"
      references:
        - https://swcregistry.io/docs/SWC-129
    pattern-regex: '\w+\s*=-\s*\d+'

  - id: sol-modifier-external-call
    message: "Modifier makes external call - can introduce reentrancy or unexpected state changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      secureum: "Pitfalls 101 - Modifier side-effects"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#reentrancy-vulnerabilities-4
    pattern-regex: 'modifier\s+\w+[^{]*\{[^}]*\.(call|delegatecall|staticcall|transfer|send)\s*[({]'

  - id: sol-pre-declaration-usage
    message: "Variable used before declaration - behavior differs between Solidity versions"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-908: Use of Uninitialized Resource"
      secureum: "Pitfalls 101 - Pre-declaration usage of local variables"
    pattern-regex: '\w+\s*=\s*\w+\s*;[^;]*\b(uint|int|address|bool|bytes)\d*\s+\1\s*;'

  - id: sol-similar-variable-names
    message: "Variables with very similar names - potential source of bugs and confusion"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-1114: Inappropriate Whitespace Style"
      secureum: "Pitfalls 101 - Similar variable names"
    pattern-regex: '(\w+)_?\s*,\s*\1[A-Z_]'

  - id: sol-tautology-condition
    message: "Condition is always true/false (tautology/contradiction) - logic error"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-571: Expression is Always True"
      secureum: "Pitfalls 101 - Tautology or contradiction"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#tautology-or-contradiction
    pattern-regex: '(uint\d*\s+\w+[^;]*;\s*[^}]*\1\s*>=\s*0|uint\d*\s+\w+[^;]*<\s*0)'

  - id: sol-out-of-range-enum
    message: "Casting to enum without bounds check - invalid values cause revert in Solidity 0.8+"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-704: Incorrect Type Conversion"
      secureum: "Pitfalls 101 - Out-of-range enum"
      references:
        - https://swcregistry.io/docs/SWC-133
    pattern-regex: '\w+\s*=\s*\w+\s*\(\s*uint\d*\s*\(\s*\w+\s*\)\s*\)'

  - id: sol-multiple-pragma
    message: "Multiple Solidity pragma statements - may cause compilation issues"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-758: Reliance on Undefined Behavior"
      secureum: "Pitfalls 101 - Multiple Solidity pragma"
    pattern-regex: 'pragma\s+solidity[^;]+;[\s\S]*pragma\s+solidity'

  - id: sol-memory-array-length
    message: "Dynamic memory array length from user input - can cause out-of-gas or memory issues"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      secureum: "Pitfalls 101 - Memory array creation overflow"
    pattern-regex: 'new\s+\w+\s*\[\s*\w+\s*\]'

  - id: sol-void-constructor
    message: "Empty constructor or constructor with no effect - may indicate incomplete implementation"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-1164: Irrelevant Code"
      secureum: "Pitfalls 101 - Void constructor"
    pattern-regex: 'constructor\s*\([^)]*\)\s*(\w+\s*)*\{\s*\}'

  - id: sol-redundant-statement
    message: "Redundant statement with no effect - may indicate logic error"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1164: Irrelevant Code"
      secureum: "Pitfalls 101 - Redundant statements"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#redundant-statements
    pattern-regex: '^\s*\w+\s*;\s*$'

  - id: sol-unreachable-code
    message: "Code after return/revert/throw - unreachable and likely a logic error"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-561: Dead Code"
      secureum: "Pitfalls 101 - Dead, Unreachable code"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#dead-code
    pattern-regex: '(return\s+[^;]+;|revert\s*\([^)]*\)\s*;|throw\s*;)\s*\n\s*\w'

  # ============================================
  # Slither HIGH Severity Patterns
  # ============================================

  - id: sol-array-by-reference
    message: "Storage array passed by value to internal function - changes won't persist"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-704: Incorrect Type Conversion"
      slither: "array-by-reference"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#modifying-storage-array-by-value
    pattern-regex: 'function\s+\w+\s*\([^)]*\[\]\s+memory\s+\w+[^)]*\)\s+internal'

  - id: sol-incorrect-shift-assembly
    message: "Incorrect shift in assembly - parameters may be reversed (value, shift vs shift, value)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      slither: "incorrect-shift"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-shift-in-assembly
    pattern-regex: 'assembly\s*\{[^}]*(shl|shr|sar)\s*\([^)]*\)[^}]*\}'

  - id: sol-state-variable-shadowing
    message: "State variable shadows inherited variable - may cause unexpected behavior"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "shadowing-state"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#state-variable-shadowing
    pattern-regex: 'contract\s+\w+\s+is\s+\w+[^{]*\{[^}]*(uint|int|address|bool|bytes|string|mapping)\d*\s+(public|private|internal)?\s*\w+\s*[=;]'

  - id: sol-delegatecall-in-loop
    message: "Delegatecall inside loop with msg.value - value may be reused across iterations"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-670: Always-Incorrect Control Flow Implementation"
      slither: "delegatecall-loop"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#payable-functions-using-delegatecall-inside-a-loop
    pattern-regex: 'for\s*\([^)]*\)\s*\{[^}]*\.delegatecall'

  - id: sol-incorrect-exponentiation
    message: "Possible incorrect exponentiation - ^ is XOR in Solidity, use ** for power"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      slither: "incorrect-exp"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-exponentiation
    pattern-regex: '\d+\s*\^\s*\d+'

  - id: sol-return-bomb
    message: "External call result copied to memory - malicious contract can return huge data (return bomb)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      slither: "return-bomb"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#return-bomb
    pattern-regex: '\(\s*bool\s+\w+\s*,\s*bytes\s+memory\s+\w+\s*\)\s*=\s*\w+\.(call|staticcall)'

  # ============================================
  # Slither MEDIUM Severity Patterns
  # ============================================

  - id: sol-domain-separator-collision
    message: "Custom function named DOMAIN_SEPARATOR may collide with EIP-712 implementation"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-694: Use of Multiple Resources with Duplicate Identifier"
      slither: "domain-separator-collision"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#domain-separator-collision
    pattern-regex: 'function\s+DOMAIN_SEPARATOR\s*\('

  - id: sol-incorrect-erc20-interface
    message: "ERC20 function signature doesn't match standard - may cause integration issues"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-573: Improper Following of Specification by Caller"
      slither: "erc20-interface"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-erc20-interface
    pattern-regex: 'function\s+(transfer|approve|transferFrom)\s*\([^)]*\)\s+(public|external)[^{]*\{(?![^}]*returns\s*\(\s*bool)'

  - id: sol-mapping-deletion
    message: "Deleting mapping inside struct leaves nested data - use separate mapping deletion"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-459: Incomplete Cleanup"
      slither: "mapping-deletion"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#deletion-on-mapping-containing-a-structure
    pattern-regex: 'delete\s+\w+\s*\[\s*\w+\s*\]'

  - id: sol-write-after-write
    message: "Variable written twice without being read between - first write is dead store"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-563: Assignment to Variable without Use"
      slither: "write-after-write"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#write-after-write
    pattern-regex: '(\w+)\s*=\s*[^;]+;\s*\n\s*\1\s*='

  - id: sol-constant-function-assembly
    message: "View/pure function uses assembly - may modify state unexpectedly"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "constant-function-asm"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#constant-functions-using-assembly-code
    pattern-regex: 'function\s+\w+\s*\([^)]*\)[^{]*(view|pure)[^{]*\{[^}]*assembly\s*\{'

  - id: sol-constant-function-state
    message: "View/pure function modifies state - violates function declaration"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "constant-function-state"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#constant-functions-changing-the-state
    pattern-regex: 'function\s+\w+\s*\([^)]*\)[^{]*(view|pure)[^{]*\{[^}]*(\w+\s*=\s*[^=]|\.push\(|\.pop\(|delete\s+)'

  - id: sol-reused-constructor
    message: "Base constructor called multiple times through diamond inheritance - may initialize twice"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-694: Use of Multiple Resources with Duplicate Identifier"
      slither: "reused-constructor"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#reused-base-constructor
    pattern-regex: 'contract\s+\w+\s+is\s+\w+\s*,\s*\w+\s*,\s*\w+'

  # ============================================
  # Oracle-Specific Patterns (Pyth, Chronicle)
  # ============================================

  - id: sol-pyth-deprecated-functions
    message: "Using deprecated Pyth functions - use getPrice/getPriceNoOlderThan instead"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
      slither: "pyth-deprecated-functions"
      references:
        - https://docs.pyth.network/price-feeds/api-reference
    pattern-regex: '\.getValidTimePeriod\s*\(\s*\)|\.getEmaPrice\s*\('

  - id: sol-pyth-unchecked-confidence
    message: "Pyth price used without checking confidence interval - price may be unreliable"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      slither: "pyth-unchecked-confidence"
      references:
        - https://docs.pyth.network/price-feeds/best-practices
    pattern-regex: 'pyth\.\w*[Pp]rice\w*\s*\([^)]*\)(?![^;]*\.conf)'

  - id: sol-chronicle-unchecked-price
    message: "Chronicle oracle price used without staleness/validity check"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      slither: "chronicle-unchecked-price"
      references:
        - https://docs.chroniclelabs.org/
    pattern-regex: 'IChronicle\s*\([^)]*\)\s*\.\s*read\s*\(\s*\)'

  # ============================================
  # Shadowing Patterns
  # ============================================

  - id: sol-shadowing-builtin
    message: "Variable shadows Solidity builtin (msg, block, tx, now, etc.) - very confusing"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "shadowing-builtin"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#builtin-symbol-shadowing
    pattern-regex: '(uint|int|address|bool|bytes)\d*\s+(msg|block|tx|now|this|super|abi|type)\s*[;=]'

  - id: sol-shadowing-local
    message: "Local variable shadows state variable - may cause confusion and bugs"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      slither: "shadowing-local"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#local-variable-shadowing
    pattern-regex: 'function\s+\w+\s*\([^)]*\b(\w+)\b[^)]*\)[^{]*\{[^}]*\b\1\b\s*='

  # ============================================
  # Event Patterns
  # ============================================

  - id: sol-missing-events-access-control
    message: "Access control change without event emission - harder to monitor and audit"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      slither: "events-access"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#missing-events-access-control
    pattern-regex: 'function\s+(setOwner|transferOwnership|grantRole|revokeRole|renounceRole)\s*\([^)]*\)[^{]*\{(?![^}]*emit\s+)'

  - id: sol-missing-events-arithmetic
    message: "Critical arithmetic operation without event emission - harder to track state changes"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      slither: "events-maths"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#missing-events-arithmetic
    pattern-regex: 'function\s+(mint|burn|withdraw|deposit|stake|unstake)\s*\([^)]*\)[^{]*\{(?![^}]*emit\s+)'

  - id: sol-unindexed-erc20-events
    message: "ERC20 Transfer/Approval events should have indexed from/to/owner/spender parameters"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      slither: "erc20-indexed"
      references:
        - https://github.com/crytic/slither/wiki/Detector-Documentation#unindexed-erc20-event-parameters
    pattern-regex: 'event\s+(Transfer|Approval)\s*\(\s*address\s+(?!indexed)'

  # ============================================
  # L2 / Cross-Chain Patterns
  # ============================================

  - id: sol-optimism-deprecated
    message: "Using deprecated Optimism predeploy or function - may break in future upgrades"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
      slither: "optimism-deprecation"
      references:
        - https://docs.optimism.io/builders/dapp-developers/contracts/system-contracts
    pattern-regex: '(OVM_L2CrossDomainMessenger|OVM_L1BlockNumber|L2CrossDomainMessenger\s*\(\s*0x4200)'

  - id: sol-arbitrum-retryable-order
    message: "Multiple retryable tickets in one transaction - execution order not guaranteed"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      slither: "out-of-order-retryable"
      references:
        - https://docs.arbitrum.io/arbos/l1-to-l2-messaging
    pattern-regex: 'createRetryableTicket\s*\([^)]*\)[^;]*;[^}]*createRetryableTicket\s*\('

  # ============================================
  # Additional DeFi Patterns
  # ============================================

  - id: sol-gelato-unprotected-randomness
    message: "Gelato VRF callback without sender verification - may be spoofed"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      slither: "gelato-unprotected-randomness"
    pattern-regex: 'function\s+_fulfillRandomness\s*\([^)]*\)[^{]*\{(?![^}]*require\s*\(\s*msg\.sender)'

  - id: sol-unprotected-callback
    message: "Callback function without caller validation - external contracts can trigger unexpected behavior"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: 'function\s+(uniswapV2Call|uniswapV3\w*Callback|pancakeCall|onFlashLoan)\s*\([^)]*\)\s+(external|public)(?![^{]*require)'

  - id: sol-erc4626-inflation
    message: "ERC4626 vault without virtual shares/assets - vulnerable to inflation attack"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://blog.openzeppelin.com/a-]novel-defense-against-erc4626-inflation-attacks
    pattern-regex: 'function\s+_convertToShares\s*\([^)]*\)[^{]*\{[^}]*\*\s*totalSupply[^}]*\/\s*totalAssets'

  # ============================================
  # Secureum Audit Findings 101/201 Patterns
  # ============================================

  - id: sol-blacklist-bypass-transferfrom
    message: "transferFrom may bypass blacklist - missing check on 'from' address allows blacklisted users to transfer via approved spenders"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-863: Incorrect Authorization"
      secureum: "Audit Findings 101 - Blacklisting Bypass via transferFrom"
      references:
        - https://github.com/x676f64/secureum-mind_map
    pattern-regex: 'function\s+transferFrom\s*\([^)]*\)[^{]*\{[^}]*(notBlacklisted|_blacklist|blacklisted)[^}]*(?!notBlacklisted\s*\(\s*from)'

  - id: sol-missing-chainid-signature
    message: "Permit/signature without chainId validation - signatures can be replayed across forks"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
      secureum: "Audit Findings 101 - Lack of chainID validation"
      references:
        - https://eips.ethereum.org/EIPS/eip-2612
    pattern-regex: 'DOMAIN_SEPARATOR\s*=[^;]*keccak256\s*\([^)]*(?!chainId|block\.chainid)'

  - id: sol-missing-storage-gap
    message: "Upgradeable contract without storage gap - adding variables in parent will corrupt child storage"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-664: Improper Control of a Resource Through its Lifetime"
      secureum: "Audit Findings 101 - Storage layout in upgradeable contracts"
      references:
        - https://docs.openzeppelin.com/upgrades-plugins/writing-upgradeable
    pattern-regex: 'contract\s+\w+\s+is\s+[^{]*Upgradeable[^{]*\{(?![^}]*uint256\s*\[\s*\d+\s*\]\s+[_]*gap)'

  - id: sol-token-decimals-assumption
    message: "Hardcoded 18 decimal assumption - tokens with >18 or <18 decimals will cause overflow/underflow"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
      secureum: "Audit Findings 201 - Token decimals greater than 18"
      references:
        - https://github.com/d-xo/weird-erc20
    pattern-regex: '(10\s*\*\*\s*18|1e18)\s*[/*]|[/*]\s*(10\s*\*\*\s*18|1e18)'

  - id: sol-event-after-external-call
    message: "Event emitted after external call - reentrancy can cause events to be logged out of order"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      secureum: "Audit Findings 201 - Reentrancy affects event ordering"
    pattern-regex: '\.(call|transfer|send)\s*[\({][^;]*;[^}]*emit\s+\w+'

  - id: sol-erc20-approve-frontrun
    message: "Using approve() without increaseAllowance/decreaseAllowance - vulnerable to front-running race condition"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      secureum: "Audit Findings 201 - ERC20 approval front-running"
      references:
        - https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM
    pattern-regex: 'function\s+approve\s*\(\s*address[^)]*,\s*uint256[^)]*\)[^}]*\{[^}]*_approve[^}]*\}'

  - id: sol-abiencoderv2-experimental
    message: "ABIEncoderV2 is experimental and has had 20+ high-severity bugs - avoid in production"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      secureum: "Audit Findings 201 - ABIEncoderV2 not production-ready"
    pattern-regex: 'pragma\s+experimental\s+ABIEncoderV2'

  - id: sol-flash-loan-callback-unprotected
    message: "Flash loan callback without loan verification - attacker can call directly without actual flash loan"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      secureum: "Audit Findings 101 - Flash minting vulnerabilities"
    pattern-regex: 'function\s+(executeOperation|onFlashLoan|receiveFlashLoan)\s*\([^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*initiator|msg\.sender)'

  - id: sol-initialization-frontrun
    message: "Initialization function can be front-run - use initializer modifier or constructor"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      secureum: "Audit Findings 101 - Initialization functions can be front-run"
    pattern-regex: 'function\s+(init|initialize|setup)\s*\([^)]*\)\s+(external|public)(?![^{]*initializer)'

  - id: sol-contract-existence-check
    message: "Low-level call without contract existence check - call to empty address returns success"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      secureum: "Audit Findings 101 - Lack of contract existence check"
    pattern-regex: '\w+\.(call|delegatecall|staticcall)\s*\([^)]*\)(?![^;]*extcodesize|[^;]*code\.length)'

  - id: sol-two-step-ownership
    message: "Critical ownership transfer in single step - use two-step transfer with pending owner acceptance"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      secureum: "Audit Findings 101 - Lack of two-step procedure"
      references:
        - https://docs.openzeppelin.com/contracts/access-control
    pattern-regex: 'function\s+transferOwnership\s*\([^)]*\)[^{]*\{[^}]*owner\s*=\s*\w+[^}]*\}'

  - id: sol-deprecated-chainlink-api
    message: "Using deprecated Chainlink API (latestAnswer/latestTimestamp) - use latestRoundData() instead"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
      secureum: "Audit Findings 201 - Chainlink deprecated API"
    pattern-regex: '\.(latestAnswer|latestTimestamp|latestRound|getAnswer|getTimestamp)\s*\(\s*\)'

  - id: sol-unbounded-loop-dos
    message: "Unbounded loop iterating over dynamic array - can cause out-of-gas DoS"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      secureum: "Audit Findings 201 - Denial of Service from Unbound List"
    pattern-regex: 'for\s*\([^)]*;\s*\w+\s*<\s*\w+\.length\s*;[^)]*\)[^{]*\{[^}]*(transfer|call|send|external)'

  - id: sol-missing-event-indexed
    message: "Event parameters not indexed - harder to filter and search in logs"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      secureum: "Audit Findings 201 - Lack of indexed parameters in events"
    pattern-regex: 'event\s+\w+\s*\(\s*(?!.*indexed)[^)]+\)'

  - id: sol-instant-governance-change
    message: "Governance parameter changed instantly - use timelock for critical parameter changes"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      secureum: "Audit Findings 101 - Governance parameter changes should not be instant"
    pattern-regex: 'function\s+set(Fee|Rate|Threshold|Limit|Admin|Owner)\s*\([^)]*\)[^{]*\{[^}]*=[^}]*;[^}]*\}'

  - id: sol-owner-privilege-escalation
    message: "Owner has excessive privileges - single account controls critical functions without checks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-269: Improper Privilege Management"
      secureum: "Audit Findings 201 - Contract owner has too many privileges"
    pattern-regex: 'onlyOwner[^{]*\{[^}]*(selfdestruct|delegatecall|upgrade|mint\s*\(|burn\s*\()'

  - id: sol-safeapprove-usage
    message: "Using safeApprove incorrectly - must set allowance to 0 first for tokens that require it"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      secureum: "Audit Findings 101 - Incorrect safeApprove usage"
    pattern-regex: 'safeApprove\s*\([^,]+,\s*[^0][^)]*\)(?![^;]*safeApprove\s*\([^,]+,\s*0\s*\))'

  # ============================================
  # AMAZEX-DSS-PARIS CTF Patterns
  # ============================================

  - id: sol-inverted-allowance-burnfrom
    message: "burnFrom checks allowance(msg.sender, account) instead of allowance(account, msg.sender) - inverted authorization"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-863: Incorrect Authorization"
      ctf: "AMAZEX-DSS-PARIS Challenge 1 - MagicETH"
    pattern-regex: 'function\s+burnFrom[^{]*\{[^}]*allowance\s*\(\s*msg\.sender\s*,\s*\w+\s*\)'

  - id: sol-selfdestruct-zero-address
    message: "selfdestruct sends funds to zero address - ETH will be permanently lost"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-401: Missing Release of Memory after Effective Lifetime"
      ctf: "AMAZEX-DSS-PARIS Challenge 3 - LendingPool"
    pattern-regex: 'selfdestruct\s*\(\s*payable\s*\(\s*(0|address\s*\(\s*0\s*\))\s*\)\s*\)'

  - id: sol-external-call-before-burn
    message: "External call before _burn - violates CEI pattern, funds transferred but tokens not burned on revert"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      ctf: "AMAZEX-DSS-PARIS Challenge 2 - ModernWETH"
    pattern-regex: '\.call\s*\{[^}]*value[^}]*\}[^;]*;[^}]*_burn\s*\('

  - id: sol-flashloan-fee-truncation
    message: "Flash loan fee uses integer division that can truncate to 0 for small amounts"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "AMAZEX-DSS-PARIS Challenge 6 - YieldPool"
    pattern-regex: 'function\s+flashFee[^{]*\{[^}]*return\s+\w+\s*\/\s*\d+'

  - id: sol-health-factor-decimal-mismatch
    message: "Health factor divided by 10**18 but may use different precision - causes incorrect liquidation logic"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: 'healthFactor\s*\([^)]*\)\s*\/\s*10\s*\*\*\s*18'

  - id: sol-msg-sender-instead-of-param
    message: "Using msg.sender instead of function parameter - common copy-paste bug in user-specific functions"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-480: Use of Incorrect Operator"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: 'function\s+\w+\s*\([^)]*address\s+_user[^)]*\)[^{]*\{[^}]*\[\s*msg\.sender\s*\]'

  - id: sol-withdraw-wrong-comparison
    message: "Withdraw uses >= comparison allowing withdrawal when borrow equals amount - can leave position undercollateralized"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-697: Incorrect Comparison"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: 'function\s+withdraw[^{]*\{[^}]*require\s*\([^)]*\.borrow\s*>=\s*_amount'

  - id: sol-liquidation-incentive-excessive
    message: "Liquidator receives all collateral but repays only partial debt - excessive incentive can drain protocol"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: 'function\s+liquidate[^{]*\{[^}]*collateral[^}]*\/\s*\d+[^}]*transfer'

  - id: sol-division-before-multiplication
    message: "Division before multiplication causes precision loss - multiply first then divide"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "AMAZEX-DSS-PARIS Challenge 6 - YieldPool"
    pattern-regex: '\(\s*\w+\s*\/\s*\w+\s*\)\s*\*\s*\w+'

  - id: sol-amm-price-oracle-single-block
    message: "Using AMM spot price without TWAP - vulnerable to flash loan price manipulation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      ctf: "AMAZEX-DSS-PARIS Challenge 8 - Oiler"
    pattern-regex: '(amm|pool|pair)\.(getPrice|getPriceToken|getReserve|quote)\s*\([^)]*\)(?![^;]*(twap|average|cumulative))'

  - id: sol-flashloan-callback-before-check
    message: "Flash loan transfers assets before validating callback result - assets may not be returned"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      ctf: "AMAZEX-DSS-PARIS Challenge 6 - YieldPool"
    pattern-regex: '(\.transfer\(|\.call\{value)[^;]*;[^}]*(onFlashLoan|executeOperation|flashCallback)'

  - id: sol-missing-zero-amount-check
    message: "Function accepts zero amount without validation - can cause division by zero or empty operations"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      ctf: "AMAZEX-DSS-PARIS Challenge 6 - YieldPool"
    pattern-regex: 'function\s+(deposit|withdraw|swap|addLiquidity|removeLiquidity)\s*\([^)]*uint256\s+\w*(amount|value|wad)[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*>\s*0)'

  # ============================================
  # Paradigm CTF 2021 Patterns
  # ============================================

  - id: sol-dynamic-array-length-increment
    message: "Direct array length increment (pre-0.6 pattern) - can cause storage corruption"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
      ctf: "Paradigm CTF 2021 - Bank"
    pattern-regex: '\w+\s*\[\s*\w+\s*\]\s*\.length\s*\+\+'

  - id: sol-assembly-storage-slot-collision
    message: "sstore with user-controlled slot offset - can overwrite critical storage slots like owner"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-123: Write-what-where Condition"
      ctf: "Paradigm CTF 2021 - Market (EternalStorage)"
    pattern-regex: 'sstore\s*\(\s*add\s*\(\s*(tokenId|id|key|slot)\s*,'

  - id: sol-untrusted-protocol-call
    message: "Calling interface method on untrusted protocol address - attacker can pass malicious contract"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      ctf: "Paradigm CTF 2021 - YieldAggregator"
    pattern-regex: 'function\s+\w+\s*\([^)]*Protocol\s+protocol[^)]*\)[^{]*\{[^}]*(protocol\.(mint|burn|deposit|withdraw|transfer))'

  - id: sol-reserve-integer-division
    message: "Integer division of reserves loses precision - use multiplication before division"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
      ctf: "Paradigm CTF 2021 - Broker"
    pattern-regex: '_?reserve[01]?\s*/\s*_?reserve[01]?'

  - id: sol-unprotected-delegatecall-function
    message: "Function with delegatecall only protected by internal guard check - verify guard cannot be bypassed"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      ctf: "Paradigm CTF 2021 - Vault"
    pattern-regex: 'function\s+(emergencyCall|execute|proxy)\s*\([^)]*address\s+\w+[^)]*bytes\s+(memory|calldata)\s+\w+[^)]*\)[^{]*\{[^}]*\.delegatecall\s*\('

  - id: sol-decimal-scaling-mismatch
    message: "Token decimal scaling with exponentiation - verify consistent handling across different decimals"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "Paradigm CTF 2021 - Swap"
    pattern-regex: '10\s*\*\*\s*\(\s*18\s*-\s*decimals\s*\)|10\s*\*\*\s*\(\s*decimals\s*-\s*18\s*\)'

  - id: sol-owner-delegatecall-hatch
    message: "Owner-only delegatecall function - if owner is compromised, contract storage can be corrupted"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      ctf: "Paradigm CTF 2021 - Bouncer"
    pattern-regex: 'function\s+hatch\s*\([^)]*\)[^{]*\{[^}]*require\s*\([^)]*owner[^)]*\)[^}]*\.delegatecall\s*\('

  - id: sol-convertmany-msgvalue-reuse
    message: "Loop calling payable function - msg.value may be reused across iterations"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-837: Improper Enforcement of a Single, Unique Action"
      ctf: "Paradigm CTF 2021 - Bouncer"
    pattern-regex: 'function\s+\w+Many\s*\([^)]*\)\s+(external|public)\s+payable[^{]*\{[^}]*for\s*\([^)]*\)[^}]*\w+\s*\([^)]*\)\s*;'

  - id: sol-erc20-approval-requirement
    message: "Requiring max approval before transfer - consider using permit or incremental approvals"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-285: Improper Authorization"
      ctf: "Paradigm CTF 2021 - Bouncer"
    pattern-regex: 'require\s*\([^)]*allowance[^)]*==\s*type\s*\(\s*uint256\s*\)\s*\.max'

  - id: sol-withdraw-without-balance-update-first
    message: "Token transfer before balance decrement - potential reentrancy if token has callbacks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-696: Incorrect Behavior Order"
      ctf: "Paradigm CTF 2021 - Bank/Vault"
    pattern-regex: '(token|tok)\.(transfer|safeTransfer)\s*\([^)]*\)\s*;[\s\n]*\w+\s*\[\s*\w+\s*\]\s*-='

  - id: sol-wrong-variable-in-mapping-assignment
    message: "Mapping assignment uses different variable than function parameter - possible copy-paste bug"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-480: Use of Incorrect Operator"
      ctf: "Paradigm CTF 2021 - Secure (Wallet)"
    pattern-regex: 'function\s+(add|remove)\w*\s*\(\s*address\s+(\w+)\s*\)[^{]*\{[^}]*_\w+\s*\[\s*owner\s*\]\s*='

  - id: sol-overflow-addition-check
    message: "Using a + b < a for overflow check - use SafeMath or Solidity 0.8+ instead"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
      ctf: "Paradigm CTF 2021 - Lockbox Stage2"
    pattern-regex: 'require\s*\([^)]*\+[^)]*<[^)]*,'

  - id: sol-staticcall-then-call-bypass
    message: "staticcall followed by regular call on same target - state changes on second call bypass sandbox"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-693: Protection Mechanism Failure"
      ctf: "Paradigm CTF 2021 - BabySandbox"
    pattern-regex: 'staticcall\s*\([^)]*address\s*\(\s*\)[^)]*\)[^}]*call\s*\([^)]*address\s*\(\s*\)'

  - id: sol-blockhash-previous-block
    message: "blockhash(block.number - 1) used for randomness - miners can manipulate"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      ctf: "Paradigm CTF 2021 - Lockbox"
    pattern-regex: 'blockhash\s*\(\s*block\.number\s*-\s*1\s*\)'

  - id: sol-ecrecover-fixed-address-compare
    message: "ecrecover compared to hardcoded address without zero check - invalid sigs return address(0)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-347: Improper Verification of Cryptographic Signature"
      ctf: "Paradigm CTF 2021 - Lockbox Stage1"
    pattern-regex: 'ecrecover\s*\([^)]*\)\s*==\s*0x[0-9a-fA-F]{40}'

  - id: sol-self-delegatecall-on-caller-check
    message: "Delegatecall triggered when caller equals address - privilege escalation via self-call"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-269: Improper Privilege Management"
      ctf: "Paradigm CTF 2021 - BabySandbox"
    pattern-regex: 'eq\s*\(\s*caller\s*\(\s*\)\s*,\s*address\s*\(\s*\)\s*\)[^}]*delegatecall'

  - id: sol-unauthorized-transfer-reclaim
    message: "Function transfers tokens FROM another address without their approval - unauthorized fund movement"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-862: Missing Authorization"
      ctf: "Paradigm CTF 2021 - Upgrade (FiatTokenV3)"
    pattern-regex: 'function\s+reclaim\s*\([^)]*address\s+from[^)]*\)[^{]*\{[^}]*_transfer\s*\(\s*from\s*,'

  - id: sol-assembly-storage-slot-overflow
    message: "sstore with add(tokenId, N) can overflow to slot 0 (owner) if tokenId is MAX_UINT - N + 1"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
      ctf: "Paradigm CTF 2021 - Market (EternalStorage)"
    pattern-regex: 'sstore\s*\(\s*add\s*\(\s*(tokenId|id)\s*,\s*[0-9]+\s*\)\s*,'

  - id: sol-transfer-before-state-update-reentrancy
    message: "ETH transfer via .transfer() before state update - potential reentrancy via fallback"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      ctf: "Paradigm CTF 2021 - Market"
    pattern-regex: 'msg\.sender\.transfer\s*\([^)]+\)\s*;[^}]*\w+\s*='

  - id: sol-extcodecopy-arbitrary-address
    message: "extcodecopy from user-controlled address - can read arbitrary contract bytecode"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-200: Information Exposure"
      ctf: "Paradigm CTF 2021 - Market"
    pattern-regex: 'extcodecopy\s*\(\s*\w+\s*,'

  - id: sol-two-step-ownership-no-zero-check
    message: "acceptOwnership without checking new owner is non-zero - ownership can be renounced accidentally"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      ctf: "Paradigm CTF 2021 - Market (EternalStorage)"
    pattern-regex: 'function\s+acceptOwnership\s*\(\s*\)[^{]*\{[^}]*sstore\s*\(\s*0x00\s*,\s*sload\s*\(\s*0x01'

  - id: sol-loan-without-collateral-check
    message: "Lending function without collateral or balance verification - uncollateralized loan risk"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-862: Missing Authorization"
      ctf: "Paradigm CTF 2021 - Upgrade (FiatTokenV3)"
    pattern-regex: 'function\s+lend\s*\([^)]*address\s+to[^)]*uint\s+amount[^)]*\)[^{]*\{[^}]*_transfer\s*\(\s*msg\.sender\s*,\s*to\s*,\s*amount'

  # Paradigm CTF 2022 Rules

  - id: sol-abi-encodepacked-uint96-collision
    message: "abi.encodePacked with uint96 can cause hash collisions - use abi.encode instead"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-328: Reversible One-Way Hash"
      ctf: "Paradigm CTF 2022 - MerkleDrop"
    pattern-regex: 'abi\.encodePacked\s*\([^)]*uint96[^)]*\)'

  - id: sol-share-calculation-uses-balanceof
    message: "Share calculation using balanceOf(this) - vulnerable to donation/flashloan manipulation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "Paradigm CTF 2022 - HintFinance"
    pattern-regex: 'shares\s*=\s*[^;]*\*\s*totalSupply\s*/\s*bal'

  - id: sol-deposit-share-inflation
    message: "Deposit calculates shares from balanceOf - first depositor inflation attack possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "Paradigm CTF 2022 - HintFinance"
    pattern-regex: 'function\s+deposit[^{]*\{[^}]*balanceOf\s*\([^)]*address\s*\(\s*this\s*\)[^}]*shares\s*='

  - id: sol-unlimited-approval-type-max
    message: "Unlimited token approval using type(uint256).max - consider limited approvals"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-285: Improper Authorization"
      ctf: "Paradigm CTF 2022 - Rescue"
    pattern-regex: '\.approve\s*\([^,]+,\s*type\s*\(\s*uint256\s*\)\s*\.max\s*\)'

  - id: sol-swap-zero-slippage
    message: "Swap with zero minAmountOut - vulnerable to sandwich/MEV attacks"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "Paradigm CTF 2022 - Rescue"
    pattern-regex: 'swapExactTokensForTokens\s*\([^,]+,\s*0\s*,'

  - id: sol-arbitrary-memory-write-assembly
    message: "mstore with user-controlled address - arbitrary memory corruption"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-787: Out-of-bounds Write"
      ctf: "Paradigm CTF 2022 - Lockbox2"
    pattern-regex: 'assembly\s*\{[^}]*mstore\s*\(\s*[a-z]\s*,'

  - id: sol-tx-origin-codehash-comparison
    message: "Comparing tx.origin to codehash - possible CREATE2 address manipulation"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-697: Incorrect Comparison"
      ctf: "Paradigm CTF 2022 - Lockbox2"
    pattern-regex: 'tx\.origin\s*==\s*[^;]*codehash'

  - id: sol-create-then-delegatecall
    message: "Contract creates bytecode then delegatecalls - arbitrary code execution risk"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94: Code Injection"
      ctf: "Paradigm CTF 2022 - JIT"
    pattern-regex: 'create\s*\([^)]*\)[^}]*\.delegatecall'

  - id: sol-receive-without-withdraw
    message: "Contract has receive() but may lack withdrawal function - funds can get stuck"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      ctf: "Paradigm CTF 2022 - JIT"
    pattern-regex: 'receive\s*\(\s*\)\s*external\s*payable\s*\{\s*\}'

  - id: sol-flashloan-callback-reentrancy
    message: "Flashloan with callback before state finalization - potential reentrancy"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      ctf: "Paradigm CTF 2022 - HintFinance"
    pattern-regex: 'function\s+flashloan[^{]*\{[^}]*\.transfer\s*\([^)]*\)[^}]*\w+Receiver\s*\('

  - id: sol-hardcoded-random-number
    message: "Function returns hardcoded 'random' value - predictable output"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      ctf: "Paradigm CTF 2022 - Random"
    pattern-regex: 'function\s+_?get\w*Random\w*\s*\([^)]*\)[^{]*\{[^}]*return\s+\d+\s*;'

  - id: sol-merkle-proof-encodepacked
    message: "Merkle proof using abi.encodePacked - vulnerable to hash collision attacks"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-328: Reversible One-Way Hash"
      ctf: "Paradigm CTF 2022 - MerkleDrop"
    pattern-regex: 'keccak256\s*\(\s*abi\.encodePacked\s*\([^)]*proofElement'

  - id: sol-swap-output-to-contract
    message: "Swap output sent to contract address - tokens can be rescued by others"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-669: Incorrect Resource Transfer Between Spheres"
      ctf: "Paradigm CTF 2022 - Rescue"
    pattern-regex: 'swapExact\w+For\w+\s*\([^)]*,\s*address\s*\(\s*this\s*\)\s*,'

  - id: sol-erc777-without-reentrancy-guard
    message: "ERC777 token interaction without reentrancy guard - token hooks can reenter"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      ctf: "Paradigm CTF 2022 - HintFinance"
    pattern-regex: 'function\s+(deposit|withdraw)\s*\([^)]*\)[^{]*\{[^}]*\.transferFrom\s*\('

  - id: sol-approve-and-call-callback
    message: "approveAndCall pattern enables callback attacks - verify callback target"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      ctf: "Paradigm CTF 2022 - HintFinance"
    pattern-regex: 'approveAndCall\s*\('

  - id: sol-erc1820-registry-hook
    message: "ERC1820 registry hook registration - can enable reentrancy via token hooks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      ctf: "Paradigm CTF 2022 - HintFinance"
    pattern-regex: 'setInterfaceImplementer\s*\('

  - id: sol-no-withdrawal-function
    message: "Contract accepts ETH or tokens but has no withdrawal function - funds may be stuck"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      ctf: "Paradigm CTF 2022 - Rescue/JIT"
    pattern-regex: 'contract\s+\w+[^{]*\{[^}]*receive\s*\(\s*\)\s*external\s*payable'

  - id: sol-delegatecall-to-created-contract
    message: "Delegatecall to newly created contract - arbitrary code execution if input controlled"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94: Code Injection"
      ctf: "Paradigm CTF 2022 - JIT"
    pattern-regex: 'assembly\s*\{[^}]*create\s*\([^}]*\}[^}]*\.delegatecall'

  - id: sol-erc1271-arbitrary-signer
    message: "ERC1271 signature check on arbitrary address - precompile contracts can return valid signatures"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-290: Authentication Bypass by Spoofing"
      ctf: "Paradigm CTF 2022 - Vanity"
    pattern-regex: 'signer\.staticcall\s*\([^)]*isValidSignature'

  - id: sol-isvalidsignature-caller-dependent
    message: "isValidSignature returns different values based on msg.sender - signature replay across contracts"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-290: Authentication Bypass by Spoofing"
      ctf: "Paradigm CTF 2022 - Stealing-sats"
    pattern-regex: 'function\s+isValidSignature\s*\([^)]*\)[^{]*\{[^}]*msg\.sender\s*=='

  - id: sol-precompile-address-call
    message: "Call to low address (precompile) - addresses 0x01-0x09 are precompiled contracts"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-749: Exposed Dangerous Method or Function"
      ctf: "Paradigm CTF 2022 - Vanity"
    pattern-regex: 'address\s*\(\s*0x0[1-9]\s*\)'

  - id: sol-signature-without-nonce
    message: "Signature verification without nonce or unique identifier - replay attack possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
      ctf: "Paradigm CTF 2022"
    pattern-regex: 'ecrecover\s*\([^)]*keccak256\s*\([^)]*abi\.encode(Packed)?\s*\([^)]*\)[^)]*\)'

  - id: sol-fillorkillorder-external
    message: "0x Protocol fillOrKillOrder call - verify order parameters and signatures carefully"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
      ctf: "Paradigm CTF 2022 - Stealing-sats"
    pattern-regex: 'fillOrKillOrder\s*\('

  # Paradigm CTF 2022 - Electric Sheep & Trapdoor patterns
  - id: sol-balance-threshold-check
    message: "Balance threshold check using balanceOf(this) - vulnerable to flash loan manipulation"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      ctf: "Paradigm CTF 2022 - Electric Sheep"
    pattern-regex: 'balanceOf\s*\(\s*(address\s*\(\s*)?this\s*\)?\s*\)\s*[><=]'

  - id: sol-foundry-vm-readfile
    message: "Foundry vm.readFile() can access host filesystem - security risk in tests/challenges"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-22: Path Traversal"
      ctf: "Paradigm CTF 2022 - Trapdoooor"
    pattern-regex: 'vm\.readFile\s*\('

  - id: sol-foundry-vm-envstring
    message: "Foundry vm.envString() can leak environment variables including secrets"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-526: Exposure of Sensitive Information Through Environmental Variables"
      ctf: "Paradigm CTF 2022 - Trapdooor"
    pattern-regex: 'vm\.envString\s*\('

  - id: sol-foundry-cheatcode-address
    message: "Foundry cheatcode address detected - test code using privileged VM operations"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-749: Exposed Dangerous Method or Function"
      ctf: "Paradigm CTF 2022 - Trapdooor"
    pattern-regex: 'address\s*\(\s*uint160\s*\(\s*uint256\s*\(\s*keccak256\s*\(\s*["\x27]hevm cheat code["\x27]\s*\)\s*\)\s*\)\s*\)'

  - id: sol-foundry-vm-ffi
    message: "Foundry vm.ffi() allows arbitrary command execution - extreme security risk"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-78: OS Command Injection"
    pattern-regex: 'vm\.ffi\s*\('

  - id: sol-foundry-vm-store
    message: "Foundry vm.store() can modify arbitrary storage slots - bypasses all access controls"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-749: Exposed Dangerous Method or Function"
    pattern-regex: 'vm\.store\s*\('

  - id: sol-isSolved-balance-check
    message: "Challenge solved by balance check - likely vulnerable to flash loans or donations"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      ctf: "Paradigm CTF 2022"
    pattern-regex: 'function\s+isSolved\s*\([^)]*\)[^{]*\{[^}]*balanceOf'

  # ============================================
  # Paradigm CTF 2021 Patterns
  # ============================================

  # BABYSANDBOX - Staticcall escape via selfdestruct
  - id: sol-staticcall-then-call
    message: "Staticcall validation followed by call - can be bypassed via selfdestruct in fallback"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-863: Incorrect Authorization"
      ctf: "Paradigm CTF 2021 - BabySandbox"
    pattern-regex: 'staticcall\s*\([^)]+\)[^;]*;[^}]*\.call'

  - id: sol-selfdestruct-in-fallback
    message: "Selfdestruct in fallback/receive - can bypass staticcall checks or force ETH"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-749: Exposed Dangerous Method or Function"
      ctf: "Paradigm CTF 2021 - BabySandbox/Bouncer"
    pattern-regex: '(?:fallback|receive)\s*\([^)]*\)[^{]*\{[^}]*selfdestruct'

  # BOUNCER - Force-send ETH via selfdestruct
  - id: sol-eth-balance-accounting
    message: "ETH balance check without accounting for selfdestruct donations - can be manipulated"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      ctf: "Paradigm CTF 2021 - Bouncer"
    pattern-regex: 'address\s*\(\s*this\s*\)\s*\.balance\s*[><=]'

  # BROKER/FARMER - Spot price oracle manipulation
  - id: sol-uniswap-getreserves-oracle
    message: "Using Uniswap getReserves() as price oracle - vulnerable to flash loan manipulation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-807: Reliance on Untrusted Inputs in a Security Decision"
      ctf: "Paradigm CTF 2021 - Broker/Farmer"
    pattern-regex: '\.getReserves\s*\(\s*\)[^;]*(?:reserve|price|rate|ratio)'

  - id: sol-spot-price-oracle
    message: "Spot price from DEX reserves - use TWAP or Chainlink for secure pricing"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-807: Reliance on Untrusted Inputs in a Security Decision"
      ctf: "Paradigm CTF 2021 - Broker"
    pattern-regex: 'reserve\d?\s*\*\s*\d+\s*/\s*reserve\d?'

  # BANK - Storage corruption via nested mappings
  - id: sol-nested-mapping-in-array
    message: "Nested mapping inside array struct - potential storage collision vulnerability"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-787: Out-of-bounds Write"
      ctf: "Paradigm CTF 2021 - Bank"
    pattern-regex: 'struct\s+\w+\s*\{[^}]*mapping\s*\([^)]+\)[^}]*\}[^;]*\[\s*\]'

  - id: sol-reentrancy-in-view
    message: "External call in view/pure function - can enable reentrancy during reads"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      ctf: "Paradigm CTF 2021 - Bank"
    pattern-regex: 'function\s+\w+\s*\([^)]*\)[^{]*(?:view|pure)[^{]*\{[^}]*\.call'

  # JOP - Function pointer hijacking
  - id: sol-sstore-function-pointer
    message: "Assembly sstore to function pointer slot - can hijack control flow"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      ctf: "Paradigm CTF 2021 - JOP"
    pattern-regex: 'assembly\s*\{[^}]*sstore\s*\([^,]+\.slot'

  - id: sol-function-pointer-state
    message: "Function pointer stored in state variable - potential hijack target"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      ctf: "Paradigm CTF 2021 - JOP"
    pattern-regex: 'function\s*\([^)]*\)\s+(?:external|public|internal|private)[^;]*\s+\w+\s*;'

  # LOCKBOX - Blockhash as randomness
  - id: sol-blockhash-randomness
    message: "Using blockhash for randomness - predictable by miners, 0 after 256 blocks"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      ctf: "Paradigm CTF 2021 - Lockbox"
    pattern-regex: 'blockhash\s*\(\s*block\.number'

  - id: sol-blockhash-validation
    message: "Blockhash used in validation - can be manipulated or becomes zero"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      ctf: "Paradigm CTF 2021 - Lockbox"
    pattern-regex: 'require\s*\([^)]*blockhash'

  # MARKET - Eternal storage without access control
  - id: sol-eternal-storage-delegatecall
    message: "Delegatecall to eternal storage pattern - ensure proper access controls"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      ctf: "Paradigm CTF 2021 - Market"
    pattern-regex: 'delegatecall\s*\([^)]*(?:Storage|storage|STORAGE)'

  - id: sol-unprotected-storage-write
    message: "Storage write without access control - arbitrary data manipulation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      ctf: "Paradigm CTF 2021 - Market"
    pattern-regex: 'function\s+(?:set|write|store)\w*\s*\([^)]*bytes32[^)]*\)[^{]*(?:external|public)[^{]*\{(?![^}]*onlyOwner|require\s*\()'

  # UPGRADE - Flash loan via lend/reclaim
  - id: sol-lend-reclaim-pattern
    message: "Lend/reclaim pattern without flash loan protection - atomic drain possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution using Shared Resource"
      ctf: "Paradigm CTF 2021 - Upgrade"
    pattern-regex: 'function\s+(?:lend|borrow)\s*\([^)]*\)[^}]*function\s+(?:reclaim|repay)'

  # YIELD_AGGREGATOR - Reentrancy in try-catch
  - id: sol-reentrancy-try-catch
    message: "External call in try-catch without reentrancy guard - state can be corrupted"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      ctf: "Paradigm CTF 2021 - YieldAggregator"
    pattern-regex: 'try\s+\w+\.[^{]+\{[^}]*\}\s*catch'

  - id: sol-fake-token-callback
    message: "Token callback during transfer - fake token can reenter"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      ctf: "Paradigm CTF 2021 - YieldAggregator"
    pattern-regex: '\.transferFrom\s*\([^)]+\)[^;]*;[^}]*\.mint\s*\('

  # VAULT - EIP1167 clone initialization race
  - id: sol-eip1167-clone
    message: "EIP1167 minimal proxy clone - ensure initialization is protected"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      ctf: "Paradigm CTF 2021 - Vault"
    pattern-regex: '3d602d80600a3d3981f3363d3d373d3d3d363d73'

  - id: sol-clone-uninitialized
    message: "Clone factory without initialization check - front-running possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      ctf: "Paradigm CTF 2021 - Vault"
    pattern-regex: 'function\s+clone\s*\([^)]*\)[^{]*\{[^}]*create\s*\((?![^}]*initialize)'

  # SWAP - Integer overflow in pre-0.8
  - id: sol-unchecked-array-access
    message: "Low-level call with array - potential overflow in index calculation"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
      ctf: "Paradigm CTF 2021 - Swap"
    pattern-regex: 'assembly\s*\{[^}]*calldataload\s*\([^)]*add\s*\('

  # General - Selfdestruct patterns
  - id: sol-selfdestruct-arbitrary
    message: "Selfdestruct with user-controlled recipient - funds can be sent anywhere"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: 'selfdestruct\s*\(\s*(?:payable\s*\()?\s*(?:msg\.sender|_?\w+)\s*\)?'

  - id: sol-emergencycall-delegatecall
    message: "Emergency function with delegatecall - can be used to change owner/state"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      ctf: "Paradigm CTF 2021 - Vault"
    pattern-regex: 'function\s+emergency\w*\s*\([^)]*\)[^{]*\{[^}]*delegatecall'

  # ============================================
  # Sherlock Protocol Audit Gap Closures
  # ============================================

  # H-02: Protocol Iteration Deadlock
  - id: sol-iterate-all-protocols
    message: "Loop iterates over all protocols/users - one failure blocks entire operation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-834: Excessive Iteration"
      audit: "Sherlock Code4rena 2021 - H-01"
    pattern-regex: 'for\s*\([^)]*;\s*\w+\s*<\s*(?:protocols|users|stakers|accounts)\w*\.length'

  - id: sol-unbounded-protocol-loop
    message: "Unbounded loop over dynamic array - can cause DoS if array grows large"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-834: Excessive Iteration"
      audit: "Sherlock Code4rena 2021"
    pattern-regex: 'for\s*\([^)]*;\s*\w+\s*<\s*\w+\.length\s*;[^)]*\)[^{]*\{[^}]*(?:transfer|call|send)'

  - id: sol-payoff-all-debt
    message: "PayOff/settle all debts in single tx - one underfunded protocol blocks all"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      audit: "Sherlock Code4rena 2021 - H-01"
    pattern-regex: 'function\s+(?:payOff|settle|claim)All\w*\s*\('

  # H-03: Calldata Manipulation
  - id: sol-calldataload-no-length-check
    message: "Assembly calldataload without calldatasize check - calldata injection possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-129: Improper Validation of Array Index"
      audit: "Sherlock Code4rena 2021 - H-02"
    pattern-regex: 'assembly\s*\{[^}]*calldataload\s*\([^}]*\}(?![^}]*calldatasize)'

  - id: sol-calldata-token-extraction
    message: "Token address extracted from calldata via assembly - validate calldata bounds"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-129: Improper Validation of Array Index"
      audit: "Sherlock Code4rena 2021 - H-02"
    pattern-regex: 'assembly\s*\{[^}]*(?:token|addr)\w*\s*:=\s*(?:shr|and)\s*\([^)]*calldataload'

  # M-02: State Update Mismatch
  - id: sol-shares-balance-mismatch
    message: "Share update without corresponding balance update - accounting inconsistency"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      audit: "Sherlock Code4rena 2022 - M-02"
    pattern-regex: '(?:shares|stakeShares)\s*\[[^\]]+\]\s*[-+]?=(?![^;]*(?:balance|Balance)\s*\[)'

  - id: sol-nft-shares-no-address-update
    message: "NFT shares modified but address mapping not updated - balance reporting error"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      audit: "Sherlock Code4rena 2022 - M-02"
    pattern-regex: 'function\s+(?:arb|force)?\w*[Rr]estake\s*\([^)]*\)[^{]*\{[^}]*shares\s*\['

  # M-03: Yield Strategy Fund Freezing
  - id: sol-strategy-withdraw-unconditional
    message: "Strategy link removed regardless of withdrawal success - funds may freeze"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      audit: "Sherlock Code4rena 2022 - M-03"
    pattern-regex: 'strategy\w*\s*=\s*(?:address\s*\(\s*0\s*\)|I\w+Strategy\s*\([^)]*0[^)]*\))(?![^;]*require)'

  - id: sol-update-strategy-no-full-withdraw
    message: "Update strategy without ensuring full withdrawal - remaining funds locked"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      audit: "Sherlock Code4rena 2022 - M-03"
    pattern-regex: 'function\s+update\w*[Ss]trategy\s*\([^)]*\)[^{]*\{(?![^}]*withdrawAll\s*\(\s*\)[^}]*require)'

  # M-05: Optimistic Balance Assumptions
  - id: sol-optimistic-balance-calculation
    message: "Calculation assumes sufficient balance - may revert or return incorrect value"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      audit: "Sherlock Code4rena 2021 - M-02"
    pattern-regex: 'accrued\w*\s*\+\s*(?:pending|owed|due)\w*(?![^;]*require|if\s*\()'

  - id: sol-premium-assumes-balance
    message: "Premium/debt calculation assumes protocol has balance - may fail silently"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      audit: "Sherlock Code4rena 2021 - M-02"
    pattern-regex: '(?:premium|debt|owed)\s*=\s*[^;]*(?:block\.timestamp|now)\s*-\s*last\w*(?![^;]*balance)'

  # M-07: First-Come-First-Served Pool Drain
  - id: sol-unallocated-pool-drain
    message: "Unallocated/remaining pool accessible first-come-first-served - unfair distribution"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      audit: "Sherlock Code4rena 2021 - M-04"
    pattern-regex: 'unallocated\w*\s*[-=]'

  - id: sol-pool-claimable-race
    message: "Pool rewards claimable without fair distribution - early claimers drain pool"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      audit: "Sherlock Code4rena 2021 - M-04"
    pattern-regex: 'function\s+claim\w*\s*\([^)]*\)[^{]*\{[^}]*(?:remaining|available|pool)\w*\s*[-=]'

  # M-08: External Protocol Integration Issues
  - id: sol-uma-oracle-integration
    message: "UMA Optimistic Oracle integration - verify bond/escalation amounts match docs"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-1104: Use of Unmaintained Third Party Components"
      audit: "Sherlock Code4rena 2022 - M-01"
    pattern-regex: '(?:UMA|Optimistic)\w*(?:Oracle|Asserter)'

  - id: sol-external-protocol-bond
    message: "External protocol bond/stake - verify actual amounts vs documentation"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-1104: Use of Unmaintained Third Party Components"
      audit: "Sherlock Code4rena 2022 - M-01"
    pattern-regex: '(?:bond|stake|collateral)\w*\s*=\s*[^;]*(?:BOND|STAKE|COLLATERAL)'

  # Additional Sherlock-specific patterns
  - id: sol-safe-approve-nonzero
    message: "safeApprove fails if current approval non-zero - use forceApprove or reset first"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-670: Always-Incorrect Control Flow Implementation"
      audit: "Sherlock Code4rena 2022 - L-01"
    pattern-regex: 'safeApprove\s*\([^,]+,\s*[^0][^)]*\)(?![^;]*approve\s*\([^,]+,\s*0)'

  - id: sol-missing-slippage-protection
    message: "Token swap/buy without slippage protection - MEV/sandwich attack risk"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      audit: "Sherlock Code4rena 2022 - L-02"
    pattern-regex: 'function\s+(?:buy|swap|exchange)\w*\s*\([^)]*\)[^{]*\{(?![^}]*(?:minAmount|slippage|deadline))'

  - id: sol-coverage-history-overwrite
    message: "Protocol update overwrites coverage history - data loss on repeated updates"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-404: Improper Resource Shutdown or Release"
      audit: "Sherlock Code4rena 2022 - L-03"
    pattern-regex: 'function\s+protocol(?:Update|Add)\s*\([^)]*\)[^{]*\{[^}]*coverage\w*\s*='

  - id: sol-nonexistent-nft-no-revert
    message: "NFT operation doesn't revert for non-existent ID - silent failure"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      audit: "Sherlock Code4rena 2022 - L-05"
    pattern-regex: 'function\s+\w+\s*\([^)]*(?:nft|token)Id[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*exist)'

  - id: sol-pausable-not-enforced
    message: "Pausable interface expected but not enforced - pause may not work"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-670: Always-Incorrect Control Flow Implementation"
      audit: "Sherlock Code4rena 2022 - L-07/L-08"
    pattern-regex: 'I\w*Pausable[^{]*\{(?![^}]*whenNotPaused)'

  - id: sol-division-precision-loss
    message: "Sequential divisions cause precision loss - multiply before dividing"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      audit: "Sherlock Code4rena 2021 - L-03"
    pattern-regex: '\)\s*/\s*\w+\s*\)\s*/\s*\w+'

  - id: sol-non-standard-erc20-names
    message: "Non-standard ERC20 function names - compatibility issues with tooling"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-710: Improper Adherence to Coding Standards"
      audit: "Sherlock Code4rena 2021 - L-04"
    pattern-regex: 'function\s+(?:increaseApproval|decreaseApproval)\s*\('

  - id: sol-strategy-trust-without-verify
    message: "Strategy return value trusted without verification - funds may be miscounted"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
      audit: "Sherlock Code4rena 2021 - L-02/L-06"
    pattern-regex: 'strategy\w*\.withdraw\w*\s*\([^)]*\)(?![^;]*==|require)'

  - id: sol-initializer-not-protected
    message: "Initializer function not protected - can be called multiple times"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      audit: "Sherlock Code4rena 2021"
    pattern-regex: 'function\s+initialize\w*\s*\([^)]*\)[^{]*(?:external|public)[^{]*\{(?![^}]*initialized|initializer)'

  - id: sol-accidental-token-burn
    message: "Token transfer to zero address - accidental burn possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual Conditions"
      audit: "Sherlock Code4rena 2021"
    pattern-regex: '\.transfer\s*\(\s*(?:address\s*\(\s*0\s*\)|0x0+)\s*,'

  - id: sol-reentrancy-state-delete
    message: "State deletion after external call - reentrancy can access deleted state"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-672: Operation on a Resource after Expiration"
      audit: "Sherlock Code4rena 2022 - M-04"
    pattern-regex: '\.(?:transfer|call|send)\s*\([^)]*\)[^;]*;[^}]*delete\s+\w+'

  # ============================================
  # Advanced DeFi Vulnerability Patterns (2024-2025)
  # Based on Sherlock/Immunefi Audit Research
  # ============================================

  # CRITICAL: Unchecked Low-Level Call Return Value ($69M losses in 2024)
  - id: sol-unchecked-call-return
    message: "Low-level call without checking return value - silent failure possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      swc: "SWC-104"
      references:
        - https://swcregistry.io/docs/SWC-104/
        - https://blocksecteam.medium.com/li-fi-attack
    pattern-regex: '\.call\s*\{[^}]*\}\s*\([^)]*\)\s*;'

  - id: sol-unchecked-send-return
    message: "send() return value not checked - Ether may be stuck if recipient reverts"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      swc: "SWC-104"
    pattern-regex: '\.send\s*\([^)]*\)\s*;(?!\s*//)'

  - id: sol-call-success-not-required
    message: "Call success variable declared but never checked - funds may be lost"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      swc: "SWC-104"
    pattern-regex: '\(bool\s+(?:success|ok)\s*,.*?\)\s*=.*?\.call[^;]*;(?![^}]*require\s*\(\s*(?:success|ok))'

  # CRITICAL: ERC4626 Vault Inflation Attack
  - id: sol-erc4626-no-virtual-offset
    message: "ERC4626 convertToShares without virtual offset - vulnerable to first depositor inflation attack"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.euler.finance/blog/exchange-rate-manipulation-in-erc4626-vaults
        - https://docs.openzeppelin.com/contracts/5.x/erc4626#inflation-attack
    pattern-regex: 'function\s+convertToShares\s*\([^)]*\)[^{]*\{[^}]*totalSupply\s*\(\s*\)\s*/\s*totalAssets'

  - id: sol-vault-share-ratio-manipulation
    message: "Vault share calculation without virtual assets - exchange rate can be manipulated via donation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: 'assets\s*\*\s*totalSupply\s*\(\s*\)\s*/\s*totalAssets\s*\(\s*\)(?![^;]*\+\s*1)'

  - id: sol-erc4626-missing-decimal-offset
    message: "ERC4626 vault missing _decimalsOffset() - vulnerable to precision loss attacks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: 'contract\s+\w+\s+is\s+[^{]*ERC4626[^{]*\{(?![^}]*_decimalsOffset)'

  # HIGH: MEV/Sandwich Attack Patterns
  - id: sol-mev-timestamp-deadline
    message: "block.timestamp used as swap deadline - MEV bots can delay and sandwich the transaction"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      references:
        - https://arxiv.org/html/2511.15245v1
    pattern-regex: '(?:swap|exchange)\w*\s*\([^)]*block\.timestamp\s*[,\)]'

  - id: sol-swap-no-slippage-protection
    message: "DEX swap with amountOutMin of 0 - vulnerable to sandwich attacks"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
    pattern-regex: 'swap\w*\s*\([^)]*,\s*0\s*,.*?address\s*\(\s*this\s*\)'

  - id: sol-frontrunnable-approval
    message: "ERC20 approve without setting to 0 first - frontrunning double-spend possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      references:
        - https://github.com/ethereum/EIPs/issues/20#issuecomment-263524729
    pattern-regex: '\.approve\s*\(\s*\w+\s*,\s*(?!0\s*\))[^)]+\)(?![^;]*approve\s*\([^,]*,\s*0)'

  # HIGH: ERC20 Return Value Issues
  - id: sol-erc20-approve-no-return-check
    message: "ERC20 approve() return value not checked - some tokens return false instead of revert"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      references:
        - https://github.com/d-xo/weird-erc20#no-revert-on-failure
    pattern-regex: '(?<![Ss]afe)\w+\.approve\s*\([^)]*\)\s*;(?!\s*//)'

  - id: sol-erc20-transfer-no-return-check
    message: "ERC20 transfer() return value not checked - tokens like USDT don't return bool"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
    pattern-regex: '(?<![Ss]afe)\w+\.transfer\s*\(\s*[^,]+\s*,\s*[^)]+\)\s*;(?!\s*//)'

  # HIGH: Cross-Function Reentrancy Patterns
  - id: sol-cross-function-state-read
    message: "Balance read after external call in different function - cross-function reentrancy possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-662: Improper Synchronization"
      references:
        - https://medium.com/immunefi/the-ultimate-guide-to-reentrancy
    pattern-regex: 'function\s+\w+\s*\([^)]*\)[^{]*\{[^}]*\.call[^}]*\}[^}]*function\s+\w+[^{]*\{[^}]*balances?\s*\['

  - id: sol-shared-state-external-call
    message: "External call with shared state variable - reentrancy between functions possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-662: Improper Synchronization"
    pattern-regex: '(?:mapping|uint256|address)\s+(?:public|internal|private)\s+(\w+)[^;]*;[^}]*\.call[^}]*\1\s*[=\[\+\-]'

  # HIGH: Griefing Attack Patterns
  - id: sol-gas-griefing-subcall
    message: "External call with forwarded gas - subcalls may be gas-griefed (63/64 rule)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      references:
        - https://dedaub.com/blog/mass-disclosure-of-griefing-vulnerabilities/
    pattern-regex: '\.call\s*\{[^}]*gas\s*:\s*gasleft\s*\(\s*\)'

  - id: sol-denial-of-service-loop-transfer
    message: "Loop with external transfers - one failing recipient blocks all others"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
    pattern-regex: 'for\s*\([^)]*\)\s*\{[^}]*\.(?:transfer|call|send)\s*\('

  - id: sol-force-revert-griefing
    message: "require() in withdrawal path - griefing possible if condition can be manipulated"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
    pattern-regex: 'function\s+withdraw\w*\s*\([^)]*\)[^{]*\{[^}]*require\s*\([^)]*balance'

  # HIGH: Price Oracle Manipulation
  - id: sol-spot-price-oracle
    message: "Spot price used directly - vulnerable to flash loan manipulation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-807: Reliance on Untrusted Inputs"
      references:
        - https://www.certik.com/resources/blog/oracle-wars
    pattern-regex: '(?:getReserves|balanceOf|totalSupply)\s*\([^)]*\)[^;]*[/\*][^;]*(?:price|value|worth)'

  - id: sol-twap-too-short
    message: "TWAP period less than 30 minutes - vulnerable to multi-block manipulation"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-807: Reliance on Untrusted Inputs"
    pattern-regex: 'twap\w*\s*[=:]\s*[0-9]+(?:\s*\*\s*)?(?:minutes?|seconds?)?(?:[^;]*[<]\s*(?:30|1800)|\s*(?:[0-9]{1,3}|1[0-7][0-9]{2})\s*;)'

  - id: sol-chainlink-stale-price
    message: "Chainlink oracle without staleness check - stale prices can cause liquidations"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-672: Operation on Resource after Expiration"
    pattern-regex: 'latestRoundData\s*\(\s*\)[^;]*;(?![^}]*updatedAt|heartbeat|staleness)'

  - id: sol-oracle-no-sequencer-check
    message: "L2 oracle without sequencer uptime check - prices may be stale after sequencer downtime"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-672: Operation on Resource after Expiration"
    pattern-regex: 'latestRoundData\s*\(\s*\)(?![^}]*sequencer|Sequencer)'

  # MEDIUM: Additional Audit Patterns
  - id: sol-arbitrary-delegatecall-data
    message: "Delegatecall with user-controlled data - storage slot collision possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Code Generation"
    pattern-regex: '\.delegatecall\s*\(\s*(?:abi\.encode|data|_data|callData|payload)'

  - id: sol-memory-vs-storage-loop
    message: "Storage variable modified in loop - should cache in memory for gas savings"
    languages: [solidity]
    severity: INFO
    metadata:
      category: gas-optimization
    pattern-regex: 'for\s*\([^)]*;\s*\w+\s*<\s*\w+\.length\s*;[^)]*\)[^{]*\{[^}]*\w+\s*\[[^\]]+\]\s*[-+\*]?='

  - id: sol-signature-malleability
    message: "ECDSA signature without s-value check - signature malleability possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-347: Improper Verification of Cryptographic Signature"
    pattern-regex: 'ecrecover\s*\([^)]*\)(?![^;]*s\s*[<>])'

  - id: sol-permit2-missing-nonce
    message: "Permit2 without nonce tracking - signature replay possible across chains"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    pattern-regex: 'permit2\w*\s*\([^)]*\)(?![^}]*nonce|Nonce)'

  # ============================================
  # Code4rena Sherlock V1 Audit Gap Closures
  # Based on 2021-07-sherlock report findings
  # ============================================

  # H-02: Assembly token extraction without calldatasize check
  - id: sol-assembly-token-from-calldata
    message: "Assembly extracts token/address from calldata without bounds validation - calldata injection possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-129: Improper Validation of Array Index"
      audit: "Code4rena Sherlock 2021 - H-02"
      references:
        - https://code4rena.com/reports/2021-07-sherlock
    pattern-regex: 'assembly\s*\{[^}]*(?:shr|and)\s*\([^)]*calldataload[^}]*\}(?![^}]*calldatasize)'

  - id: sol-calldata-arbitrary-offset
    message: "Calldata read at arbitrary/user-controlled offset - out-of-bounds read possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-125: Out-of-bounds Read"
      audit: "Code4rena Sherlock 2021 - H-02"
    pattern-regex: 'calldataload\s*\(\s*(?:add\s*\([^)]*\$|_offset|\w+Offset)'

  # M-01: Fee-on-transfer token accounting
  - id: sol-transfer-no-balance-check
    message: "Transfer amount assumed without checking balance delta - fee-on-transfer tokens break accounting"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      audit: "Code4rena Sherlock 2021 - M-01"
    pattern-regex: '\.(?:safeT|t)ransferFrom\s*\([^)]*\)\s*;[^}]*(?:balance|Balance)\s*(?:\+|-)=\s*(?:amount|_amount|value)'

  - id: sol-no-balance-before-after
    message: "Token transfer without before/after balance comparison - rebasing/fee tokens may transfer different amounts"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: 'function\s+(?:stake|deposit)\w*\s*\([^)]*\)[^{]*\{(?![^}]*balanceOf[^}]*balanceOf)[^}]*transferFrom'

  # M-03: Diamond proxy upgrade without safeguards
  - id: sol-diamond-upgrade-no-timelock
    message: "Diamond upgrade function without timelock - instant rug pull possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      audit: "Code4rena Sherlock 2021 - M-03"
    pattern-regex: 'function\s+(?:updateSolution|diamondCut|upgradeTo)\s*\([^)]*\)[^{]*\{(?![^}]*timelock|Timelock|delay|DELAY)'

  - id: sol-proxy-upgrade-no-delay
    message: "Proxy upgrade executable immediately - malicious upgrade can drain funds before users react"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: 'function\s+upgrade\w*\s*\(\s*address\s+(?:new|_new)?\w*[Ii]mplementation[^)]*\)[^{]*external[^{]*\{(?![^}]*pendingImplementation|delay)'

  # M-04: First harvester gets all yield
  - id: sol-yield-first-come-first-served
    message: "Yield distribution favors first harvester - unfair distribution after large payouts"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
      audit: "Code4rena Sherlock 2021 - M-04"
    pattern-regex: 'function\s+(?:harvest|claim|getYield|doYield)\w*\s*\([^)]*\)[^{]*\{[^}]*unallocated\w*\s*[-=]'

  - id: sol-reward-drain-no-snapshot
    message: "Reward claim without snapshot - early claimers can drain pool before others"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution"
    pattern-regex: 'function\s+claim\w*\s*\([^)]*\)[^{]*\{[^}]*reward\w*\s*=\s*[^;]*(?:pending|available|total)[^}]*transfer'

  # Additional patterns for comprehensive coverage
  - id: sol-diamond-facet-collision
    message: "Diamond facet function may collide with existing selector - upgrade can break functionality"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-694: Use of Multiple Resources with Duplicate Identifier"
    pattern-regex: 'function\s+diamondCut\s*\([^)]*\)[^{]*\{(?![^}]*selectorCollision|existingFacet)'

  - id: sol-strategy-balance-trusted
    message: "External strategy balance trusted without verification - malicious strategy can report inflated balance"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
    pattern-regex: 'strategy\w*\.(?:balanceOf|balance|totalAssets)\s*\(\s*\)(?![^;]*require|verify|assert)'

  - id: sol-premium-accrual-without-balance
    message: "Premium/interest accrues without checking payer balance - accounting drift over time"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: '(?:premium|interest|yield)\w*\s*\+=\s*[^;]*(?:block\.timestamp|now)\s*-\s*last'

  # ============================================
  # Code4rena Audit Patterns (2024-08-chakra)
  # ============================================

  # Address Confusion Patterns - using address(this) where parameter should be used
  - id: sol-address-this-in-struct-init
    message: "address(this) used in struct initialization - likely should use parameter token/handler address instead"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-704: Incorrect Type Conversion"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: '\w+\s*\{[^}]*(?:from_?(?:token|address|handler)|to_?(?:token|address|handler))\s*:\s*address\s*\(\s*this\s*\)'

  - id: sol-address-this-in-event
    message: "address(this) emitted in event - may emit wrong address (handler vs token confusion)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-704: Incorrect Type Conversion"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'emit\s+\w+\s*\([^)]*address\s*\(\s*this\s*\)[^)]*\)'

  - id: sol-address-this-in-mapping-storage
    message: "address(this) stored in mapping - contracts often confuse handler address with token address"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-704: Incorrect Type Conversion"
    pattern-regex: '\w+\s*\[[^\]]+\]\s*=\s*[^;]*address\s*\(\s*this\s*\)'

  # Error Handling - Functions that always revert instead of returning false
  - id: sol-return-bool-always-reverts
    message: "Function returns bool but uses require/revert - will never return false, only revert"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'function\s+\w+\s*\([^)]*\)[^{]*returns\s*\([^)]*bool[^)]*\)\s*\{[^}]*require\s*\([^}]*return\s+true\s*;[^}]*\}'

  - id: sol-cross-chain-no-failure-status
    message: "Cross-chain handler without failure status - always reverts instead of setting FAILED status"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
    pattern-regex: '(?:receive|handle)_?(?:cross|chain|message)\s*\([^)]*\)[^{]*\{(?![^}]*(?:status\s*=\s*FAILED|failed\s*=\s*true))'

  # Unverified Event Parameters
  - id: sol-event-unverified-parameter
    message: "External parameter directly emitted in event without validation - can emit misleading data"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    pattern-regex: 'emit\s+\w+\s*\([^)]*(?:payload|data|message)_?(?:type|kind|id)[^)]*\)(?![^;]*require|validate|verify)'

  # Public function without access control that modifies mapping
  - id: sol-public-mapping-modifier
    message: "Public function modifies mapping without access control - anyone can modify state"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-inside: |
          function $FUNC(...) public { ... }
      - pattern: $MAPPING[$KEY]++
      - pattern-not-inside: |
          function $FUNC(...) public onlyOwner { ... }
      - pattern-not-inside: |
          function $FUNC(...) public onlyAdmin { ... }
      - pattern-not-inside: |
          require(msg.sender == $AUTHORIZED, ...);
          ...

  - id: sol-nonce-increment-no-auth
    message: "Nonce can be incremented without authorization - potential DoS or replay protection bypass"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: 'function\s+\w*(?:nonce|increment)\w*\s*\([^)]*\)\s*(?:public|external)(?![^{]*only|require\s*\(\s*msg\.sender)[^{]*\{[^}]*nonce\w*\s*\[[^\]]*\]\s*(?:\+\+|\+=)'

  # Cross-chain specific patterns
  - id: sol-cross-chain-msg-no-source-validation
    message: "Cross-chain message handling without source chain/sender validation"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-346: Origin Validation Error"
    pattern-regex: 'function\s+(?:receive|handle)_?(?:cross|chain|message)\s*\([^)]*\)[^{]*\{(?![^}]*(?:require|assert)\s*\([^)]*(?:source|origin|sender|from_?chain))'

  - id: sol-cross-chain-handler-no-whitelist
    message: "Cross-chain handler call without destination handler whitelist check"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: '\.(?:cross_chain|send_message|bridge)\s*\([^)]*handler[^)]*\)(?![^;]*(?:whitelist|allowed|supported))'

  # ============================================
  # Code4rena Audit Patterns (2023-04-rubicon)
  # ============================================

  # Offer/Order System Zero Address Vulnerabilities
  - id: sol-offer-owner-zero-address
    message: "Offer/order owner can be set to address(0) - breaks buy/cancel functionality and loses funds"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://github.com/code-423n4/2023-04-rubicon-findings
    pattern-regex: 'struct\s+(?:Offer|Order)\s*\{[^}]*address\s+(?:owner|maker)[^}]*\}(?![^}]*require[^}]*!=\s*address\s*\(\s*0\s*\))'

  - id: sol-offer-recipient-zero
    message: "Offer recipient not validated - zero address loses funds permanently"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://github.com/code-423n4/2023-04-rubicon-findings
    pattern-regex: 'function\s+(?:buy|fill|take)\w*\s*\([^)]*address[^)]*recipient[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*recipient\s*!=\s*address\s*\(\s*0\s*\))'

  - id: sol-unfillable-order
    message: "Order/offer with zero parameters can block market functionality"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://github.com/code-423n4/2023-04-rubicon-findings
    pattern-regex: 'function\s+(?:make|create|place)(?:Offer|Order)\s*\([^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*>\s*0)'

  # Leverage/Borrowing Without Safety Margin
  - id: sol-leverage-max-capacity
    message: "Borrowing at maximum LTV without safety margin - price movement causes immediate liquidation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/code-423n4/2023-04-rubicon-findings
    pattern-regex: 'while\s*\([^)]*(?:borrow|leverage)[^)]*\)\s*\{[^}]*(?:100|max|full)[^}]*(?:borrow|deposit)[^}]*\}'

  - id: sol-borrow-loop-no-margin
    message: "Loop borrowing/depositing without safety margin - vulnerable to price volatility"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: 'for\s*\([^)]*\)\s*\{[^}]*(?:borrow\s*\([^)]*\)[^}]*deposit|deposit\s*\([^)]*\)[^}]*borrow)[^}]*\}'

  - id: sol-ltv-100-percent
    message: "LTV set to 100% - no safety margin for price fluctuations"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: '(?:ltv|loanToValue|collateralRatio)\s*=\s*(?:100|1e18|10\*\*18|1\s*\*\s*10\s*\*\*\s*18)'

  # Reward Timing Manipulation
  - id: sol-reward-no-snapshot
    message: "Reward distribution uses current balance - vulnerable to deposit-claim-withdraw attack"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      references:
        - https://github.com/code-423n4/2023-04-rubicon-findings
    pattern-regex: 'function\s+(?:distribute|claim)Reward\w*\s*\([^)]*\)[^{]*\{[^}]*(?:balanceOf|shares)\s*\[[^]]*\][^}]*reward'

  - id: sol-reward-deposit-timing
    message: "Rewards calculated from spot balance - deposit timing manipulation possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      references:
        - https://github.com/code-423n4/2023-04-rubicon-findings
    pattern-regex: 'reward\w*\s*=\s*[^;]*(?:balanceOf|shares|deposit)\w*\s*\[[^]]*\]\s*\*'

  # Automatic Matching Fee Manipulation
  - id: sol-matching-fee-attack
    message: "Automatic order matching without fee protection - attackers can force makers to pay fees"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Race Condition"
      references:
        - https://github.com/code-423n4/2023-04-rubicon-findings
    pattern-regex: 'function\s+(?:match|settle)Order\w*\s*\([^)]*\)[^{]*\{[^}]*(?:fee|taker)[^}]*transfer[^}]*\}'

  # Comptroller/Protocol Solvency
  - id: sol-unclaimed-rewards-solvency
    message: "Rewards can be claimed without proper accounting - protocol solvency at risk"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/code-423n4/2023-04-rubicon-findings
    pattern-regex: 'function\s+claim\w*\s*\([^)]*\)[^{]*\{[^}]*transfer\s*\([^)]*reward[^}]*\}(?![^}]*totalClaimed|claimedAmount)'

  # Version Compatibility Issues
  - id: sol-v1-v2-compatibility
    message: "Function handles V1/V2 differently without proper version check - inconsistent behavior"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-436: Interpretation Conflict"
      references:
        - https://github.com/code-423n4/2023-04-rubicon-findings
    pattern-regex: 'if\s*\([^)]*(?:v1|version\s*==\s*1|isLegacy)[^)]*\)\s*\{[^}]*\}\s*else'

  # ============================================
  # IMPROVED PATTERNS: C4 Gap Analysis Fixes
  # ============================================

  # IMPROVED: address(this) in emit statements (more comprehensive)
  - id: sol-emit-address-this
    message: "address(this) directly in emit - likely wrong address (should use token/handler variable)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-704: Incorrect Type Conversion"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'emit\s+\w+\s*\([^;]*address\s*\(\s*this\s*\)'

  # IMPROVED: Mixed bool return with require/revert (C4 HIGH pattern)
  - id: sol-bool-return-with-revert
    message: "Function returns bool but uses require/revert - inconsistent error handling, callers expect false not revert"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'function\s+\w+[^{]*returns\s*\([^)]*bool[^)]*\)\s*\{[^}]*(?:require|revert)\s*\('

  # IMPROVED: Return false mixed with require in same function
  - id: sol-mixed-return-false-require
    message: "Function mixes 'return false' with require() - inconsistent error handling pattern"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
    pattern-regex: 'return\s+false\s*;[^}]*require\s*\(|require\s*\([^}]*return\s+false\s*;'

  # ============================================
  # NEW CATEGORY: Flash Loan Attack Patterns
  # ============================================

  - id: sol-flash-loan-callback-no-validation
    message: "Flash loan callback without sender validation - anyone can call with fake flash loan"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://github.com/code-423n4/2024-07-loopfi-findings
    pattern-regex: 'function\s+(?:on|execute|receive)Flash\w*\s*\([^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*msg\.sender\s*==)'

  - id: sol-flash-loan-fee-not-accounted
    message: "Flash loan fee not included in liquidity calculation - share value manipulation possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/code-423n4/2024-07-loopfi-findings
    pattern-regex: 'function\s+(?:flash|loan)\w*\s*\([^)]*\)[^{]*\{[^}]*(?:fee|premium)[^}]*\}(?![^}]*(?:expectedLiquidity|totalAssets)\s*\+=)'

  - id: sol-flash-loan-amount-validation
    message: "Flash loan amount not validated against available liquidity"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    pattern-regex: 'function\s+flash\w*\s*\([^)]*uint\d*\s+amount[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*amount\s*<=)'

  # ============================================
  # NEW CATEGORY: Calculation Error Patterns
  # ============================================

  - id: sol-liquidation-penalty-wrong-base
    message: "Liquidation penalty calculated on wrong base (repayAmount vs debtAmount) - penalty avoidance possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/code-423n4/2024-07-loopfi-findings
    pattern-regex: '(?:take|seize)Collateral\s*=\s*[^;]*repay(?:Amount|Value)[^;]*(?:penalty|fee)'

  - id: sol-interest-rate-one-direction
    message: "Interest rate only adjusts in one direction - rate suppression/inflation over time"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/code-423n4/2024-07-loopfi-findings
    pattern-regex: '(?:baseRate|interestRate)\s*(?:\-=|\+=)[^;]*(?:loss|profit)(?![^}]*(?:baseRate|interestRate)\s*(?:\+=|\-=))'

  - id: sol-double-incentive-application
    message: "Incentive/reward applied multiple times in same function - over-distribution"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/code-423n4/2024-07-loopfi-findings
    pattern-regex: '(?:incentive|reward|bonus)\s*\+=[^}]*(?:incentive|reward|bonus)\s*\+='

  - id: sol-missing-accrued-interest
    message: "Accrued interest not included in repayment calculation - treasury/lender loss"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/code-423n4/2024-07-loopfi-findings
    pattern-regex: 'function\s+(?:repay|liquidate)\w*[^{]*\{[^}]*(?:principal|debt)[^}]*transfer(?![^}]*(?:accrued|interest))'

  - id: sol-profit-not-minted
    message: "Profit from operation not minted to treasury - value leakage"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: 'function\s+(?:liquidate|repay|settle)\w*[^{]*\{[^}]*profit\s*=[^}]*\}(?![^}]*(?:mint|transfer)\s*\([^)]*treasury)'

  # ============================================
  # NEW CATEGORY: Collateral/Debt Patterns
  # ============================================

  - id: sol-collateral-transfer-wrong-amount
    message: "Collateral transfer uses wrong calculation base - over/under collateralization"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/code-423n4/2024-07-loopfi-findings
    pattern-regex: 'collateral\w*\s*=\s*[^;]*(?:repay|debt)Amount[^;]*(?:penalty|fee)(?![^;]*\-\s*(?:penalty|fee))'

  - id: sol-no-refund-mechanism
    message: "Excess payment with no refund - user funds permanently lost"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/code-423n4/2024-07-loopfi-findings
    pattern-regex: 'function\s+(?:liquidate|repay|settle)\w*\s*\([^)]*uint\d*\s+(?:repay|pay)Amount[^)]*\)[^{]*\{(?![^}]*(?:refund|excess|remaining)\s*=)'

  - id: sol-wrong-position-parameter
    message: "Position/account parameter may reference wrong address - transaction revert or wrong state"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-704: Incorrect Type Conversion"
      references:
        - https://github.com/code-423n4/2024-07-loopfi-findings
    pattern-regex: '(?:decrease|increase)(?:Lever|Position)\w*\s*\([^)]*\)[^{]*\{[^}]*(?:withdraw|deposit)\s*\([^)]*(?:address\s*\(\s*this\s*\)|msg\.sender)'

  # ============================================
  # NEW CATEGORY: State Validation Patterns
  # ============================================

  - id: sol-missing-pending-check
    message: "Operation executed without checking PENDING status - double execution possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-367: TOCTOU Race Condition"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'function\s+(?:execute|process|handle)(?:Callback|Message|Request)\w*\s*\([^)]*\)[^{]*\{(?![^}]*(?:require|assert)\s*\([^)]*(?:PENDING|status\s*==))'

  - id: sol-callback-no-status-update
    message: "Callback handler doesn't update status - repeated callbacks possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-367: TOCTOU Race Condition"
    pattern-regex: 'function\s+\w*[Cc]allback\w*\s*\([^)]*\)[^{]*\{(?![^}]*status\s*=)'

  - id: sol-cross-chain-replay
    message: "Cross-chain message can be replayed - no nonce or hash tracking"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    pattern-regex: 'function\s+(?:receive|handle)(?:Cross|Chain|Message)\w*\s*\([^)]*\)[^{]*\{(?![^}]*(?:processed|used|consumed)\s*\[[^\]]*\]\s*=\s*true)'

  # ============================================
  # NEW CATEGORY: Accounting/Bookkeeping Errors
  # ============================================

  - id: sol-balance-after-transfer
    message: "Balance checked after transfer - use balanceBefore/balanceAfter pattern"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: '\.transfer\w*\s*\([^)]*\)\s*;[^}]*balanceOf\s*\('

  - id: sol-shares-before-deposit
    message: "Shares calculated before actual deposit - vulnerable to donation attacks"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: 'shares\s*=\s*[^;]*balanceOf[^;]*;[^}]*\.transferFrom'

  - id: sol-expected-vs-actual-mismatch
    message: "Expected delta calculated but actual amount not verified - accounting drift"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern-regex: 'expected\w*Delta\s*=[^;]*;(?![^}]*actual\w*Delta|(?:require|assert)\s*\([^)]*expected)'

  # ============================================
  # NEW CATEGORY: Chakra C4 Targeted Rules
  # Specific patterns from Code4rena 2024-08-chakra audit
  # ============================================

  - id: sol-address-this-in-cross-chain-payload
    message: "address(this) stored in cross-chain payload - wrong address on destination chain"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-697: Incorrect Comparison"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: '(?:CrossChain|Message|Payload|Tx)\w*\s*\([^)]*address\s*\(\s*this\s*\)[^)]*(?:to_|dest|target)'

  - id: sol-address-this-in-token-struct
    message: "address(this) stored in token struct instead of actual token address"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-697: Incorrect Comparison"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: '(?:Token|Asset)\w*\s*\{[^}]*address\s*\(\s*this\s*\)[^}]*(?:to_token|token_address|dest_token)'

  - id: sol-callback-status-without-all-cases
    message: "Callback only handles Success/Failed but doesn't verify PENDING was checked first"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'if\s*\(\s*\w+\s*==\s*(?:Status\.)?(?:Success|SUCCESS)\s*\)[^{]*\{[^}]*\}[^}]*else\s+if\s*\(\s*\w+\s*==\s*(?:Status\.)?(?:Failed|FAILED)\s*\)'

  - id: sol-cross-chain-from-handler-unvalidated
    message: "Cross-chain from_handler not validated against whitelist - spoofed source possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-346: Origin Validation Error"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'function\s+(?:receive|handle|process)(?:Cross|Chain|Message)\w*\s*\([^)]*(?:from_handler|source_handler|srcHandler)[^)]*\)[^{]*\{(?![^}]*(?:require|assert)\s*\([^)]*(?:whitelist|allowed|valid)\w*\[[^\]]*from_handler)'

  - id: sol-cross-chain-from-chain-unvalidated
    message: "Cross-chain from_chain not validated - messages from unknown chains accepted"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-346: Origin Validation Error"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'function\s+(?:receive|handle|process)(?:Cross|Chain|Message)\w*\s*\([^)]*(?:from_chain|source_chain|srcChain)[^)]*\)[^{]*\{(?![^}]*(?:require|assert)\s*\([^)]*(?:supported|allowed|valid)(?:Chain|Chains)\[)'

  - id: sol-settlement-status-not-marked
    message: "Settlement handler doesn't mark status as processed - double settlement possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-367: TOCTOU Race Condition"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'function\s+(?:settle|execute|finalize)(?:Settlement|Order|Trade)\w*\s*\([^)]*\)[^{]*\{(?![^}]*(?:status|processed|settled)\s*\[[^\]]*\]\s*=)'

  - id: sol-handler-return-bool-no-false
    message: "Handler returns bool but never returns false - caller can't detect failures"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
      references:
        - https://github.com/code-423n4/2024-08-chakra-findings
    pattern-regex: 'function\s+(?:handle|process|execute)\w+\s*\([^)]*\)[^)]*returns\s*\([^)]*bool[^)]*\)[^{]*\{(?![^}]*return\s+false)'

  # ============================================
  # NEW CATEGORY: DeFiVulnLabs Coverage Rules
  # Based on https://github.com/SunWeb3Sec/DeFiVulnLabs
  # ============================================

  - id: sol-divide-before-multiply
    message: "Division before multiplication causes precision loss - multiply first then divide"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Divmultiply.sol
    pattern-regex: '\(\s*\w+\s*/\s*\d+\s*\)\s*\*\s*\w+'

  - id: sol-dirty-bytes-storage
    message: "Copying bytes to storage can create dirty bytes - use assembly or proper length handling"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-1004: Sensitive Cookie Without 'HttpOnly' Flag"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Dirtybytes.sol
    pattern-regex: 'bytes\s+memory\s+\w+\s*=\s*new\s+bytes\s*\([^)]*\)[^;]*;[^}]*\.push\s*\(\s*\)'

  - id: sol-empty-array-loop-bypass
    message: "Empty array bypasses loop logic - add length check before loop"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1004: Sensitive Cookie Without 'HttpOnly' Flag"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/empty-loop.sol
    pattern-regex: 'for\s*\(\s*uint\s+\w+\s*=\s*0\s*;\s*\w+\s*<\s*\w+\.length\s*;[^)]*\)[^{]*\{(?![^}]*require\s*\(\s*\w+\.length\s*>)'

  - id: sol-struct-delete-with-mapping
    message: "Deleting struct with mapping leaves mapping data - manually clear mapping first"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-1109: Use of Same Variable for Multiple Purposes"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Struct-deletion.sol
    pattern-regex: 'delete\s+\w+\s*\[\s*\w+\s*\]\s*;[^}]*mapping\s*\('

  - id: sol-array-element-delete
    message: "delete array[i] leaves gap with zero value - use swap-and-pop pattern instead"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1109: Use of Same Variable for Multiple Purposes"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Array-deletion.sol
    pattern-regex: 'delete\s+\w+\s*\[\s*\w+\s*\]\s*;'

  - id: sol-tx-gasprice-manipulation
    message: "tx.gasprice can be manipulated by miners - avoid using for financial calculations"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/gas-price.sol
    pattern-regex: 'tx\.gasprice\s*\*'

  - id: sol-return-in-nested-loop
    message: "return in nested loop exits entire function - use break or flag variable"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1046: Creation of Immutable Text Using String Concatenation"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/return-break.sol
    pattern-regex: 'for\s*\([^)]*\)[^{]*\{[^}]*for\s*\([^)]*\)[^{]*\{[^}]*return\s+[^;]*;'

  - id: sol-payable-transfer-gas-limit
    message: "payable.transfer() has 2300 gas limit - fails for contracts with receive logic"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/payable-transfer.sol
    pattern-regex: 'payable\s*\(\s*\w+\s*\)\s*\.transfer\s*\('

  - id: sol-nft-transfer-no-approval-check
    message: "NFT transfer without approval/ownership check - add _isApprovedOrOwner validation"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-862: Missing Authorization"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/NFT-transfer.sol
    pattern-regex: 'function\s+transferFrom\s*\([^)]*\)[^{]*\{(?![^}]*(?:require|_isApprovedOrOwner|ownerOf))'

  - id: sol-self-transfer-unchecked
    message: "Self transfer not checked - can cause balance corruption with from == to"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/self-transfer.sol
    pattern-regex: 'function\s+(?:transfer|_transfer)\s*\([^)]*from[^)]*to[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*from\s*!=\s*to)'

  - id: sol-recover-erc20-backdoor
    message: "recoverERC20 can withdraw reward tokens - exclude staking/reward token addresses"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/recoverERC20.sol
    pattern-regex: 'function\s+recoverERC20\s*\([^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*!=\s*(?:rewardsToken|stakingToken))'

  - id: sol-flash-loan-no-initiator-check
    message: "Flash loan callback doesn't verify initiator - add require(initiator == address(this))"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-862: Missing Authorization"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Flashloan-flaw.sol
    pattern-regex: 'function\s+executeOperation\s*\([^)]*initiator[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*initiator\s*==)'

  - id: sol-transient-storage-callback
    message: "Transient storage (tstore/tload) vulnerable during callbacks - clear before external calls"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-367: TOCTOU Race Condition"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/TransientStorageMisuse.t.sol
    pattern-regex: 'tstore\s*\([^)]*\)[^}]*\.call\s*\{'

  - id: sol-assembly-sstore-backdoor
    message: "Direct sstore in assembly can modify arbitrary storage slots - potential backdoor"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-573: Improper Following of Specification"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Backdoor-assembly.sol
    pattern-regex: 'assembly\s*\{[^}]*sstore\s*\(\s*\d+\s*,'

  - id: sol-data-location-memory-update
    message: "Struct copied to memory then modified - changes lost, use storage reference"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/DataLocation.sol
    pattern-regex: '\w+\s+memory\s+\w+\s*=\s*\w+\s*\[\s*\w+\s*\]\s*;[^}]*\w+\.\w+\s*='

  - id: sol-phantom-function-permit
    message: "Calling permit on token without EIP-2612 support silently succeeds via fallback"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1104: Use of Unmaintained Third Party Components"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/phantom-permit.sol
    pattern-regex: '\.call\s*\(\s*abi\.encodeWithSignature\s*\(\s*"permit\s*\('

  - id: sol-invariant-uint64-overflow
    message: "Casting to smaller uint in unchecked accumulator can overflow silently"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Invariant.sol
    pattern-regex: '\+=\s*uint(?:8|16|32|64)\s*\([^)]*msg\.value'

  - id: sol-nft-metadata-exposure
    message: "NFT metadata accessible before mint - enables targeted minting attacks (CVE-2022-38217)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-213: Exposure of Sensitive Information Due to Incompatible Policies"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/NFTMint_exposedMetadata.sol
    pattern-regex: 'tokenURI\s*\([^)]*\)[^{]*return.*(?:ipfs|https).*json'

  - id: sol-sanity-check-bypass
    message: "Sanity check can be bypassed with multiple small operations before expiry"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1025: Comparison Using Wrong Factors"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Incorrect_sanity_checks.sol
    pattern-regex: 'if\s*\(\s*block\.timestamp\s*>=?\s*\w+\s*\)[^{]*\{[^}]*=\s*0\s*;[^}]*transfer'

  # ============================================
  # CLOSING THE GAPS: Final 6 DeFiVulnLabs Rules
  # Target: 100% coverage of 48 vulnerabilities
  # ============================================

  - id: sol-dirty-bytes-storage-copy
    message: "Bytes array copied to storage with non-32-aligned length - dirty bytes vulnerability (fixed in 0.8.15)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-195: Signed to Unsigned Conversion Error"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Dirtybytes.sol
        - https://blog.soliditylang.org/2022/06/15/dirty-bytes-array-to-storage-bug/
    pattern-regex: 'bytes\s+memory\s+\w+\s*=\s*new\s+bytes\s*\(\s*(?!32|64|96|128)\d+\s*\)\s*;[^;]*\w+\s*=\s*\w+'

  - id: sol-approval-scam-max-uint
    message: "Unlimited token approval (type(uint256).max) - user loses control of all tokens"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/ApproveScam.sol
    pattern-regex: '\.approve\s*\([^,]+,\s*type\s*\(\s*uint256\s*\)\s*\.max\s*\)'

  - id: sol-approval-scam-max-value
    message: "Unlimited token approval (2**256-1 or max uint) - enables complete token drain"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/ApproveScam.sol
    pattern-regex: '\.approve\s*\([^,]+,\s*(?:2\s*\*\*\s*256\s*-\s*1|0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff)\s*\)'

  - id: sol-setapprovalforall-scam
    message: "setApprovalForAll grants unlimited NFT access - verify operator is trusted"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/ApproveScam.sol
    pattern-regex: '\.setApprovalForAll\s*\([^,]+,\s*true\s*\)'

  - id: sol-memory-struct-from-mapping
    message: "Struct copied to memory from mapping - modifications won't persist to storage"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-664: Improper Control of a Resource"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/DataLocation.sol
    pattern-regex: '\w+\s+memory\s+\w+\s*=\s*\w+\s*\[\s*(?:msg\.sender|_?\w+)\s*\]\s*;'

  - id: sol-erc20-return-false-pattern
    message: "ERC20 returns false on failure instead of reverting - use SafeERC20"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-253: Incorrect Check of Function Return Value"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Returnfalse.sol
    pattern-regex: 'function\s+transfer\s*\([^)]*\)[^{]*returns\s*\(\s*bool\s*\)[^{]*\{[^}]*return\s+false\s*;'

  - id: sol-unchecked-transfer-bool
    message: "ERC20 transfer return value not checked - token may return false instead of revert"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-253: Incorrect Check of Function Return Value"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Returnfalse.sol
    pattern-regex: 'IERC20\s*\([^)]*\)\s*\.transfer\s*\([^)]*\)\s*;(?!\s*(?:require|if|assert))'

  - id: sol-undersized-balance-mapping
    message: "Balance mapping uses uint64/uint32 - overflows at ~18 ETH, use uint256"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Invariant.sol
    pattern-regex: 'mapping\s*\(\s*address\s*=>\s*uint(?:8|16|32|64)\s*\)\s*(?:public|private|internal)?\s*\w*[Bb]alance'

  - id: sol-undersized-eth-accumulator
    message: "ETH value cast to uint64/uint32 - overflows silently at ~18 ETH"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/Invariant.sol
    pattern-regex: '\+=\s*uint(?:8|16|32|64)\s*\(\s*msg\.value\s*\)'

  - id: sol-nft-ipfs-metadata-exposed
    message: "IPFS NFT metadata URL pattern detected - ensure metadata is hidden until reveal"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-213: Exposure of Sensitive Information"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/NFTMint_exposedMetadata.sol
        - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-38217
    pattern-regex: 'ipfs://[a-zA-Z0-9]+/\d+\.json'

  - id: sol-nft-http-metadata-exposed
    message: "HTTP NFT metadata URL with token ID - vulnerable to metadata sniping (CVE-2022-38217)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-213: Exposure of Sensitive Information"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/NFTMint_exposedMetadata.sol
    pattern-regex: 'https?://[^"]+/\d+\.json'

  - id: sol-tokenuri-predictable
    message: "tokenURI returns predictable path with tokenId - metadata visible before mint"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-213: Exposure of Sensitive Information"
      references:
        - https://github.com/SunWeb3Sec/DeFiVulnLabs/blob/main/src/test/NFTMint_exposedMetadata.sol
    pattern-regex: 'function\s+tokenURI\s*\([^)]*\)[^{]*\{[^}]*return\s+[^;]*(?:baseURI|_baseURI)[^;]*tokenId'

