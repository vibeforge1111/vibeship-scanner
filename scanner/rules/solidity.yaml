# Solidity/Smart Contract Security Rules
# Based on semgrep-rules/solidity - https://github.com/semgrep/semgrep-rules
rules:
  # ============================================
  # Critical: Access Control
  # ============================================

  - id: sol-accessible-selfdestruct
    message: Contract can be destructed by anyone - missing access control on selfdestruct
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://www.parity.io/blog/a-postmortem-on-the-parity-multi-sig-library-self-destruct/
    patterns:
      - pattern-either:
          - pattern: selfdestruct($ADDR)
          - pattern: suicide($ADDR)
      - pattern-not-inside: |
          function $FUNC(...) onlyOwner { ... }
      - pattern-not-inside: |
          require(msg.sender == owner, ...);
          ...

  - id: sol-unrestricted-transferownership
    message: transferOwnership() lacks access control - anyone can take ownership
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-inside: |
          function transferOwnership($ADDR) public { ... }
      - pattern-not-inside: |
          function transferOwnership($ADDR) public onlyOwner { ... }

  # ============================================
  # Critical: Reentrancy
  # ============================================

  - id: sol-erc721-reentrancy
    message: ERC721 safeTransferFrom/safeMint can trigger reentrancy via onERC721Received callback
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://blocksecteam.medium.com/when-safemint-becomes-unsafe-lessons-from-the-hypebears-security-incident-2965209bda2a
    pattern: _checkOnERC721Received(...)

  - id: sol-erc777-reentrancy
    message: ERC777 tokens have send/receive hooks that can trigger reentrancy
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    pattern-either:
      - pattern: IERC777($TOKEN).send(...)
      - pattern: IERC777($TOKEN).operatorSend(...)

  - id: sol-external-call-state-change
    message: State change after external call - potential reentrancy vulnerability
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://consensys.github.io/smart-contract-best-practices/attacks/reentrancy/
    pattern-regex: '\.call\s*\{[^}]*\}\s*\([^)]*\)\s*;[\s\S]*?\w+\s*='

  # ============================================
  # Critical: Arbitrary Calls
  # ============================================

  - id: sol-arbitrary-low-level-call
    message: Arbitrary address with controlled calldata in low-level call - potential code injection
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://blocksecteam.medium.com/li-fi-attack-a-cross-chain-bridge-vulnerability-no-its-due-to-unchecked-external-call-c31e7dadf60f
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $ADDR, ..., bytes calldata $DATA, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $ADDR, ..., bytes calldata $DATA, ...) public { ... }
      - pattern-either:
          - pattern: $ADDR.call($DATA)
          - pattern: '$ADDR.call{value:$V}($DATA)'

  - id: sol-delegatecall-to-arbitrary-address
    message: Delegatecall to user-controlled address - attacker can execute arbitrary code in contract context
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://entethalliance.org/specs/ethtrust-sl/v1/#req-1-delegatecall
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $ANY(..., address $CONTRACT, ...) public {...}
          - pattern-inside: |
              function $ANY(..., address $CONTRACT, ...) external {...}
      - pattern-either:
          - pattern: $CONTRACT.delegatecall(...)
          - pattern: '$CONTRACT.delegatecall{gas:$GAS}(...)'

  # ============================================
  # High: Integer Issues
  # ============================================

  - id: sol-unchecked-arithmetic
    message: Unchecked arithmetic operation - potential overflow/underflow (Solidity <0.8.0)
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
    patterns:
      - pattern-inside: |
          unchecked {
            ...
          }
      - pattern-either:
          - pattern: $X + $Y
          - pattern: $X - $Y
          - pattern: $X * $Y

  # ============================================
  # High: Token Security
  # ============================================

  - id: sol-erc20-public-burn
    message: Public burn function without access control - anyone can burn tokens
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    pattern-regex: 'function\s+burn\s*\([^)]*\)\s+(public|external)\s*\{'

  - id: sol-arbitrary-transferfrom
    message: ERC721/ERC20 transferFrom with user-controlled from address - potential unauthorized transfer
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $FROM, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $FROM, ...) public { ... }
      - pattern-either:
          - pattern: $TOKEN.transferFrom($FROM, ...)
          - pattern: IERC20($TOKEN).transferFrom($FROM, ...)
          - pattern: IERC721($TOKEN).transferFrom($FROM, ...)

  # ============================================
  # High: Oracle & Price Manipulation
  # ============================================

  - id: sol-basic-oracle-manipulation
    message: Single-block price oracle - vulnerable to flash loan manipulation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://www.paradigm.xyz/2020/11/so-you-want-to-use-a-price-oracle
    patterns:
      - pattern-either:
          - pattern: $PAIR.getReserves()
          - pattern: IUniswapV2Pair($PAIR).getReserves()

  - id: sol-no-slippage-check
    message: DEX swap without slippage protection - vulnerable to sandwich attacks
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    pattern-regex: '(swap\w+|swapExact\w+)\s*(\{[^}]*\})?\s*\([^)]*,\s*0\s*,'

  # ============================================
  # Medium: Randomness
  # ============================================

  - id: sol-weak-randomness-blockhash
    message: Using blockhash for randomness - miners can manipulate this value
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern-either:
      - pattern: blockhash($BLOCK)
      - pattern: block.timestamp
      - pattern: block.difficulty
      - pattern: block.prevrandao

  - id: sol-incorrect-blockhash
    message: blockhash(block.number) always returns 0 - use block.number - 1
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern: blockhash(block.number)

  # ============================================
  # Medium: Signature Issues
  # ============================================

  - id: sol-ecrecover-malleable
    message: ecrecover is vulnerable to signature malleability - use OpenZeppelin ECDSA
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-347: Improper Verification of Cryptographic Signature"
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/ECDSA.sol
    pattern: ecrecover($HASH, $V, $R, $S)

  - id: sol-missing-zero-address-check
    message: Missing zero address validation - tokens/ETH could be lost
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $ADDR, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $ADDR, ...) public { ... }
      - pattern-either:
          - pattern: $ADDR.transfer(...)
          - pattern: $TOKEN.transfer($ADDR, ...)
      - pattern-not-inside: |
          require($ADDR != address(0), ...);
          ...

  # ============================================
  # Medium: Proxy Patterns
  # ============================================

  - id: sol-proxy-storage-collision
    message: Potential storage collision in proxy pattern - use EIP-1967 slots
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-706: Use of Incorrectly-Resolved Name or Reference"
      references:
        - https://eips.ethereum.org/EIPS/eip-1967
    patterns:
      - pattern-inside: |
          contract $PROXY {
            ...
            address $IMPL;
            ...
          }
      - pattern: delegatecall(...)

  # ============================================
  # Info: Best Practices
  # ============================================

  - id: sol-use-ownable2step
    message: Consider using Ownable2Step instead of Ownable for safer ownership transfers
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable2Step.sol
    pattern: import "@openzeppelin/contracts/access/Ownable.sol"

  - id: sol-tx-origin-auth
    message: tx.origin used for authorization - vulnerable to phishing attacks
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
    patterns:
      - pattern-either:
          - pattern: require(tx.origin == $ADDR, ...)
          - pattern: if (tx.origin == $ADDR) { ... }
          - pattern: tx.origin == owner

  - id: sol-encode-packed-collision
    message: abi.encodePacked with multiple dynamic types - potential hash collision
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"
    pattern: abi.encodePacked($A, $B, ...)

  - id: sol-deprecated-suicide
    message: suicide() is deprecated - use selfdestruct() instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: suicide(...)

  - id: sol-floating-pragma
    message: Floating pragma version - pin to a specific version for production
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-regex: 'pragma solidity \^'

  - id: sol-missing-visibility
    message: Function missing explicit visibility specifier
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern: |
          function $FUNC(...) {
            ...
          }
      - pattern-not: |
          function $FUNC(...) public { ... }
      - pattern-not: |
          function $FUNC(...) external { ... }
      - pattern-not: |
          function $FUNC(...) internal { ... }
      - pattern-not: |
          function $FUNC(...) private { ... }

  # ============================================
  # DeFi: Flash Loan Attacks
  # ============================================

  - id: sol-flash-loan-no-check
    message: Flash loan without proper balance check - ensure atomic execution
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
    pattern-either:
      - pattern: IFlashLoanReceiver($X).executeOperation(...)
      - pattern: IERC3156FlashBorrower($X).onFlashLoan(...)

  - id: sol-unchecked-return-value
    message: Return value of external call not checked - silent failure possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
    patterns:
      - pattern: $TOKEN.transfer($TO, $AMT)
      - pattern-not-inside: require($TOKEN.transfer(...), ...)
      - pattern-not-inside: if ($TOKEN.transfer(...)) { ... }

  - id: sol-unsafe-erc20-transfer
    message: ERC20 transfer without SafeERC20 - some tokens dont return bool
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol
    pattern-either:
      - pattern: IERC20($TOKEN).transfer(...)
      - pattern: IERC20($TOKEN).transferFrom(...)
      - pattern: IERC20($TOKEN).approve(...)

  # ============================================
  # DeFi: Liquidity & AMM Issues
  # ============================================

  - id: sol-hardcoded-deadline
    message: Hardcoded deadline in swap - use block.timestamp + buffer
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern-either:
      - pattern: $ROUTER.swapExactTokensForTokens(..., 9999999999, ...)
      - pattern: $ROUTER.swapExactTokensForTokens(..., type(uint256).max, ...)

  - id: sol-approve-max
    message: Unlimited token approval - use exact amount needed
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-either:
      - pattern: $TOKEN.approve($SPENDER, type(uint256).max)
      - pattern: IERC20($TOKEN).approve($SPENDER, type(uint256).max)

  - id: sol-missing-deadline
    message: DEX swap without deadline - transaction can be delayed by miners
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern: $ROUTER.swapExactTokensForTokens(..., block.timestamp, ...)

  # ============================================
  # NFT Security
  # ============================================

  - id: sol-nft-overflow-mint
    message: NFT mint without supply check - potential overflow in tokenId
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: _mint($TO, $ID)
      - pattern-not-inside: |
          require($ID <= $MAX, ...);
          ...

  - id: sol-erc721-no-exists-check
    message: ERC721 operation without existence check - token may not exist
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    patterns:
      - pattern: ownerOf($ID)
      - pattern-not-inside: |
          require(_exists($ID), ...);
          ...

  - id: sol-nft-royalty-bypass
    message: NFT transfer without royalty enforcement - use ERC2981
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-either:
      - pattern: safeTransferFrom($FROM, $TO, $ID)
      - pattern: transferFrom($FROM, $TO, $ID)

  # ============================================
  # Staking & Rewards
  # ============================================

  - id: sol-reward-before-update
    message: Reward calculation before state update - stale rewards possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          function $FUNC(...) {
            ...
          }
      - pattern: |
          $REWARD = $CALC;
          ...
          $STATE = $NEW;

  - id: sol-division-before-multiplication
    message: Division before multiplication causes precision loss
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern: ($X / $Y) * $Z

  # ============================================
  # Gas & DOS
  # ============================================

  - id: sol-unbounded-loop
    message: Unbounded loop over array - potential DOS via gas limit
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
    patterns:
      - pattern: |
          for (uint $I = 0; $I < $ARR.length; $I++) {
            ...
          }

  - id: sol-external-call-in-loop
    message: External call in loop - gas griefing and DOS risk
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern-either:
          - pattern: $ADDR.call(...)
          - pattern: $ADDR.transfer(...)
          - pattern: $ADDR.send(...)

  - id: sol-send-without-check
    message: send() return value not checked - silent failure
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: $ADDR.send($AMT)
      - pattern-not-inside: require($ADDR.send(...), ...)
      - pattern-not-inside: if ($ADDR.send(...)) { ... }

  # ============================================
  # Governance & Voting
  # ============================================

  - id: sol-flashloan-governance
    message: Governance vote without snapshot - flash loan attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: balanceOf($VOTER)
      - pattern-inside: |
          function vote(...) {
            ...
          }

  - id: sol-centralized-admin
    message: Single admin with full control - consider multisig or timelock
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern-either:
          - pattern: onlyOwner
          - pattern: require(msg.sender == owner, ...)

  # ============================================
  # Upgradeable Contracts
  # ============================================

  - id: sol-initialize-not-protected
    message: initialize() without initializer modifier - can be called multiple times
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: |
          function initialize(...) public {
            ...
          }
      - pattern-not: |
          function initialize(...) public initializer { ... }

  - id: sol-selfdestruct-in-implementation
    message: selfdestruct in implementation contract - proxy becomes unusable
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: selfdestruct($ADDR)
      - pattern-inside: |
          contract $CONTRACT is Initializable {
            ...
          }

  - id: sol-no-gap-storage
    message: Upgradeable contract without storage gap - future upgrade collision risk
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
      references:
        - https://docs.openzeppelin.com/contracts/4.x/upgradeable#storage_gaps
    pattern-regex: 'contract\s+\w+\s+is\s+Initializable\s*\{'

  # ============================================
  # Cross-Chain & Bridge
  # ============================================

  - id: sol-cross-chain-replay
    message: Cross-chain call without chain ID check - replay attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-either:
          - pattern: keccak256(abi.encode(...))
          - pattern: keccak256(abi.encodePacked(...))
      - pattern-not-inside: |
          keccak256(abi.encode(..., block.chainid, ...))

  # ============================================
  # Additional Token Issues
  # ============================================

  - id: sol-erc20-double-approve
    message: ERC20 approve race condition - use increaseAllowance instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      references:
        - https://github.com/ethereum/EIPs/issues/20#issuecomment-263524729
    pattern: approve($SPENDER, $AMT)

  - id: sol-fee-on-transfer-token
    message: Token amount after transfer may differ - check actual received amount
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    patterns:
      - pattern: $TOKEN.transferFrom($FROM, $TO, $AMT)
      - pattern-not-inside: |
          $BEFORE = $TOKEN.balanceOf($TO);
          ...
          $AFTER = $TOKEN.balanceOf($TO);

  - id: sol-reentrancy-lock
    message: State variable used as reentrancy guard - use OpenZeppelin ReentrancyGuard
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-regex: '(bool\s+(private|internal)?\s*locked\s*;|require\s*\(\s*!locked\s*,)'

  # ============================================
  # Compiler & Language Issues
  # ============================================

  - id: sol-assembly-usage
    message: Inline assembly detected - review carefully for security issues
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-regex: 'assembly\s*\{'

  - id: sol-deprecated-sha3
    message: sha3() is deprecated - use keccak256() instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: sha3(...)

  - id: sol-implicit-conversion
    message: Implicit type conversion - use explicit casting
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-either:
      - pattern: int($X)
      - pattern: uint($X)

  # ============================================
  # Event & Logging
  # ============================================

  - id: sol-missing-event-ownership
    message: Ownership transfer without event - makes tracking difficult
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern: owner = $NEW
      - pattern-not-inside: |
          emit OwnershipTransferred(...);

  - id: sol-missing-indexed-event
    message: Event parameter not indexed - harder to filter logs
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: event $NAME(address $ADDR, ...)

  # ============================================
  # Security Modifiers
  # ============================================

  - id: sol-require-without-message
    message: require() without error message - harder to debug failures
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern: require($COND)
      - pattern-not: require($COND, $MSG)

  # ============================================
  # DeFi: Flash Loan Attack Patterns
  # ============================================

  - id: sol-flash-loan-callback-external-call
    message: Flash loan callback making external call - potential for callback abuse (Truster/Naive Receiver pattern)
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://www.damnvulnerabledefi.xyz/
    patterns:
      - pattern-inside: |
          function onFlashLoan(...) external returns (bytes32) {
            ...
          }
      - pattern-either:
          - pattern: $ADDR.call(...)
          - pattern: $ADDR.functionCall(...)
          - pattern: $TOKEN.approve($SPENDER, ...)

  - id: sol-flash-loan-governance-attack
    message: Governance action in same transaction as token balance change - flash loan governance attack possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
      references:
        - https://www.damnvulnerabledefi.xyz/
    patterns:
      - pattern-either:
          - pattern: |
              $TOKEN.flashLoan(...);
              ...
              $GOV.propose(...)
          - pattern: |
              $TOKEN.flashLoan(...);
              ...
              $GOV.castVote(...)
          - pattern: |
              $TOKEN.flashLoan(...);
              ...
              $GOV.queue(...)

  - id: sol-flash-loan-reentrancy-side-entrance
    message: Flash loan with deposit/withdraw pattern - potential side entrance attack
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    patterns:
      - pattern-inside: |
          function execute() external {
            ...
          }
      - pattern: '$POOL.deposit{value: ...}()'

  # ============================================
  # DeFi: Oracle Security
  # ============================================

  - id: sol-chainlink-stale-price
    message: Chainlink latestRoundData() without staleness check - stale prices can be exploited
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
      references:
        - https://docs.chain.link/data-feeds/price-feeds
    patterns:
      - pattern: $FEED.latestRoundData()
      - pattern-not-inside: |
          require(block.timestamp - $UPDATED < ..., ...);
          ...
      - pattern-not-inside: |
          if (block.timestamp - $UPDATED > ...) { ... }
          ...

  - id: sol-twap-manipulation
    message: TWAP oracle with short observation window - vulnerable to manipulation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern-regex: 'observe\s*\(\s*\[\s*\d{1,3}\s*,'

  - id: sol-uniswap-v3-twap-short
    message: Uniswap V3 TWAP with short period - consider using longer observation windows
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: $POOL.observe($SECONDS)
      - metavariable-comparison:
          metavariable: $SECONDS
          comparison: $SECONDS < 1800

  # ============================================
  # DeFi: Timelock & Governance
  # ============================================

  - id: sol-timelock-bypass-schedule-in-execute
    message: Schedule called from execute context - timelock bypass vulnerability (Climber pattern)
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-inside: |
          function execute(...) external {
            ...
          }
      - pattern: $TIMELOCK.schedule(...)

  - id: sol-governance-no-quorum-check
    message: Governance proposal execution without quorum validation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: $PROPOSAL.execute(...)
      - pattern-not-inside: |
          require($VOTES >= $QUORUM, ...);
          ...

  # ============================================
  # DeFi: Signature & Permit Security
  # ============================================

  - id: sol-permit-no-deadline-check
    message: ERC20 permit without deadline validation - permits can be replayed
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    patterns:
      - pattern: $TOKEN.permit($OWNER, $SPENDER, $VALUE, $DEADLINE, $V, $R, $S)
      - pattern-not-inside: |
          require($DEADLINE >= block.timestamp, ...);
          ...

  - id: sol-meta-tx-replay
    message: Meta-transaction without nonce tracking - replay attack possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    patterns:
      - pattern-inside: |
          function executeMetaTransaction(...) external {
            ...
          }
      - pattern: ecrecover(...)
      - pattern-not-inside: |
          nonces[$USER]++;
          ...

  - id: sol-signature-no-domain-separator
    message: Signature verification without domain separator - cross-contract replay possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
    patterns:
      - pattern: ecrecover($HASH, $V, $R, $S)
      - pattern-not-inside: |
          $DOMAIN = keccak256(abi.encode(..., block.chainid, address(this), ...));
          ...

  # ============================================
  # DeFi: Calldata & ABI Security
  # ============================================

  - id: sol-abi-decode-untrusted
    message: abi.decode on untrusted calldata - potential ABI smuggling attack
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    patterns:
      - pattern-inside: |
          function $FUNC(..., bytes calldata $DATA, ...) external {
            ...
          }
      - pattern: abi.decode($DATA, ...)

  - id: sol-multicall-delegatecall
    message: Multicall with delegatecall - batched operations can bypass checks
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-863: Incorrect Authorization"
    patterns:
      - pattern-inside: |
          function multicall(...) external {
            ...
          }
      - pattern: delegatecall(...)

  # ============================================
  # DeFi: Bridge & Cross-Chain
  # ============================================

  - id: sol-bridge-withdrawal-no-merkle-verify
    message: Bridge withdrawal without Merkle proof verification
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
    patterns:
      - pattern-inside: |
          function withdraw(...) external {
            ...
          }
      - pattern: $TOKEN.transfer($TO, $AMOUNT)
      - pattern-not-inside: |
          MerkleProof.verify(...);
          ...
      - pattern-not-inside: |
          require(MerkleProof.verify(...), ...);
          ...

  - id: sol-bridge-double-spend
    message: Bridge claim without marking as processed - double-spend possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition"
    patterns:
      - pattern-inside: |
          function claim(...) external {
            ...
          }
      - pattern: $TOKEN.transfer(...)
      - pattern-not-inside: |
          claimed[$ID] = true;
          ...
      - pattern-not-inside: |
          processed[$HASH] = true;
          ...

  # ============================================
  # DeFi: Liquidation & Collateral
  # ============================================

  - id: sol-liquidation-no-health-check
    message: Liquidation without health factor validation
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
    patterns:
      - pattern-inside: |
          function liquidate(...) external {
            ...
          }
      - pattern: $TOKEN.transferFrom($BORROWER, ...)
      - pattern-not-inside: |
          require($HEALTH < ..., ...);
          ...

  - id: sol-collateral-price-single-source
    message: Collateral valuation from single price source - use aggregated oracles
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          function getCollateralValue(...) {
            ...
          }
      - pattern: $PRICE = $ORACLE.getPrice(...)
      - pattern-not-inside: |
          $PRICE1 = ...;
          $PRICE2 = ...;
          ...

  # ============================================
  # DeFi: AMM & DEX
  # ============================================

  - id: sol-curve-pool-manipulation
    message: Curve pool interaction without slippage protection - sandwich attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern-regex: '(ICurve|IStableSwap|curve)\w*\.(exchange|add_liquidity|remove_liquidity)\s*\([^)]*,\s*0\s*[,)]'

  - id: sol-amm-spot-price-usage
    message: Using spot price from AMM for valuation - flash loan manipulation possible
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
    patterns:
      - pattern-either:
          - pattern: $POOL.getReserves()
          - pattern: $PAIR.token0().balanceOf($PAIR)
      - pattern-inside: |
          function $FUNC(...) {
            ...
            $VALUE = ...;
            ...
          }

  # ============================================
  # DeFi: Damn Vulnerable DeFi Patterns
  # ============================================

  - id: sol-msg-value-loop-reuse
    message: "msg.value used in loop - payment can be reused for multiple iterations (Free Rider pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/free-rider/
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern: msg.value

  - id: sol-accounting-mismatch-balanceof
    message: "Contract compares internal accounting to balanceOf() - direct transfers can break invariants (Unstoppable pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/unstoppable/
    pattern-regex: 'require\s*\(\s*\w+\.balanceOf\s*\(\s*(address\s*\(\s*this\s*\)|this)\s*\)\s*==\s*\w+'

  - id: sol-flash-loan-arbitrary-receiver
    message: "Flash loan allows arbitrary receiver address - can drain third-party contracts (Naive Receiver pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/naive-receiver/
    patterns:
      - pattern-inside: |
          function flashLoan(..., address $RECEIVER, ...) external {
            ...
          }
      - pattern-not-inside: |
          require($RECEIVER == msg.sender, ...);
          ...

  - id: sol-flash-loan-external-call-data
    message: "Flash loan executes arbitrary external call with user data - attacker can call any function (Truster pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/truster/
    patterns:
      - pattern-inside: |
          function flashLoan(...) external {
            ...
          }
      - pattern-either:
          - pattern: $TARGET.functionCall($DATA)
          - pattern: $TARGET.call($DATA)

  - id: sol-deposit-in-flash-callback
    message: "Deposit function callable during flash loan callback - side entrance attack possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/side-entrance/
    patterns:
      - pattern-inside: |
          function execute() external payable {
            ...
          }
      - pattern-either:
          - pattern: $POOL.deposit(...)
          - pattern: '$POOL.deposit{value: ...}(...)'

  - id: sol-snapshot-reward-claim
    message: "Reward claim uses current balance snapshot - vulnerable to flash loan manipulation (The Rewarder pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/the-rewarder/
    patterns:
      - pattern-inside: |
          function distributeRewards() external {
            ...
          }
      - pattern: balanceOf(msg.sender)
      - pattern-not-inside: |
          require(block.timestamp > lastRewardTime + ..., ...);
          ...

  - id: sol-execute-before-schedule-check
    message: "Timelock executes operations before verifying they were scheduled - bypass vulnerability (Climber pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/climber/
    pattern-regex: 'for\s*\([^)]+\)\s*\{[^}]*\.call[^}]*\}[^}]*require\s*\('

  - id: sol-fixed-calldata-offset
    message: "Fixed offset used for calldata parsing - ABI smuggling attack possible"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/abi-smuggling/
    pattern-regex: 'calldataload\s*\(\s*(4\s*\+\s*32\s*\*\s*\d+|\d{2,3})\s*\)'

  - id: sol-gnosis-safe-setup-unchecked
    message: "Safe.setup() called without validating initializer parameters - backdoor possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-749: Exposed Dangerous Method or Function"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/backdoor/
    patterns:
      - pattern: $SAFE.setup($OWNERS, $THRESHOLD, $TO, $DATA, ...)
      - pattern-not-inside: |
          require($TO == address(0), ...);
          ...
      - pattern-not-inside: |
          require($DATA.length == 0, ...);
          ...

  - id: sol-uups-implementation-not-initialized
    message: "UUPS implementation contract not initialized - attacker can take ownership"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-665: Improper Initialization"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/wallet-mining/
    patterns:
      - pattern-inside: |
          contract $CONTRACT is UUPSUpgradeable {
            ...
          }
      - pattern-not: |
          constructor() {
            _disableInitializers();
          }

  - id: sol-curve-virtual-price-in-callback
    message: "Curve get_virtual_price() called during callback - read-only reentrancy attack possible"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/curvy-puppet/
        - https://chainsecurity.com/heartbreaks-curve-lp-oracles/
    pattern-either:
      - pattern: $POOL.get_virtual_price()
      - pattern: ICurvePool($POOL).get_virtual_price()

  - id: sol-precision-loss-mul-div
    message: "Division before multiplication in fixed-point math - precision loss vulnerability (Shards pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/shards/
    pattern-either:
      - pattern: mulDivDown($X, $Y, $Z)
      - pattern: mulDivUp($X, $Y, $Z)
      - pattern: FixedPointMathLib.mulDivDown($X, $Y, $Z)

  - id: sol-nft-payment-after-transfer
    message: "NFT transfer before payment - msg.sender becomes owner and receives payment (Free Rider pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/free-rider/
    pattern-regex: '(safeTransferFrom|transferFrom)\s*\([^)]+\)\s*;[\s\S]*?payable\s*\(\s*\w+\s*\)\s*\.\s*(transfer|call)'

  - id: sol-bridge-merkle-leaf-no-encode
    message: "Merkle leaf constructed without proper encoding - potential proof forgery"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/withdrawal/
    patterns:
      - pattern: keccak256(abi.encodePacked($LEAF))
      - pattern-inside: |
          function $FUNC(...) {
            ...
            MerkleProof.verify(...);
            ...
          }

  - id: sol-cross-chain-deploy-no-chainid
    message: "Contract deployment without chain ID - cross-chain replay attack possible (Wallet Mining pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-294: Authentication Bypass by Capture-replay"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/wallet-mining/
    patterns:
      - pattern-either:
          - pattern: CREATE2
          - pattern: create2(...)
      - pattern-not-inside: |
          require(block.chainid == ..., ...);
          ...

  # ============================================
  # DeFi: Additional DVD Patterns for 100% Coverage
  # ============================================

  - id: sol-transfer-in-loop-before-state-update
    message: "Token transfer inside loop before state update - multiple claims possible before validation (The Rewarder pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/the-rewarder/
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern-either:
          - pattern: $TOKEN.transfer($TO, $AMT)
          - pattern: $TOKEN.safeTransfer($TO, $AMT)
          - pattern: SafeTransferLib.safeTransfer($TOKEN, $TO, $AMT)

  - id: sol-merkle-leaf-missing-fields
    message: "Merkle leaf hash missing critical fields - proof may be reusable across contexts (The Rewarder pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/the-rewarder/
    patterns:
      - pattern: keccak256(abi.encodePacked(msg.sender, $AMOUNT))
      - pattern-inside: |
          function $FUNC(...) {
            ...
            MerkleProof.verify(...);
            ...
          }

  - id: sol-oracle-single-source
    message: "Oracle with MIN_SOURCES = 1 - single point of failure, median easily manipulated (Compromised pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-693: Protection Mechanism Failure"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/compromised/
    pattern-regex: 'MIN_SOURCES\s*=\s*1\s*;'

  - id: sol-oracle-no-price-deviation-check
    message: "Oracle price update without deviation check - prices can change arbitrarily (Compromised pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-754: Improper Check for Unusual or Exceptional Conditions"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/compromised/
    patterns:
      - pattern-inside: |
          function $FUNC(..., uint256 $PRICE) external {
            ...
          }
      - pattern-either:
          - pattern: _pricesBySource[$SRC][$SYM] = $PRICE
          - pattern: prices[$SYM] = $PRICE
          - pattern: $MAP[$KEY] = $PRICE
      - pattern-not-inside: |
          require($PRICE <= $OLD * ..., ...);
          ...
      - pattern-not-inside: |
          require($PRICE >= $OLD / ..., ...);
          ...

  - id: sol-trusted-role-price-setter
    message: "Price oracle relies on trusted roles without safeguards - compromised keys can manipulate prices"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-269: Improper Privilege Management"
      references:
        - https://www.damnvulnerabledefi.xyz/challenges/compromised/
    patterns:
      - pattern-inside: |
          function postPrice(...) external onlyRole($ROLE) {
            ...
          }
      - pattern-not-inside: |
          require(block.timestamp > lastUpdate + ..., ...);
          ...

  - id: sol-claim-bitmap-after-transfer
    message: "Claim bitmap updated after token transfer - reentrancy can bypass claim tracking"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    patterns:
      - pattern: |
          $TOKEN.transfer(...);
          ...
          $CLAIMS[$USER] = ...;

  - id: sol-median-few-sources
    message: "Median price calculated from small source set - vulnerable to collusion or compromise"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-693: Protection Mechanism Failure"
    pattern-regex: 'getMedianPrice|computeMedian|_computeMedianPrice'

  # ============================================
  # Ethernaut Challenge Patterns
  # ============================================

  - id: sol-reverting-fallback-dos
    message: "Fallback/receive with require can cause DoS - callers cannot send ETH if condition fails (King pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-248: Uncaught Exception"
      references:
        - https://ethernaut.openzeppelin.com/level/9
    pattern-regex: '(receive|fallback)\s*\(\s*\)\s+external\s+payable\s*\{[^}]*require\s*\('

  - id: sol-private-not-hidden
    message: "Private variables are readable on-chain via eth_getStorageAt - do not store secrets (Vault pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-200: Exposure of Sensitive Information"
      references:
        - https://ethernaut.openzeppelin.com/level/8
    pattern-regex: '(bytes32|string|bytes)\s+private\s+\w*(password|secret|key|private)\w*\s*[=;]'

  - id: sol-private-array-exposure
    message: "Private arrays/mappings are readable on-chain - storage slots can be computed and read (Privacy pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-200: Exposure of Sensitive Information"
      references:
        - https://ethernaut.openzeppelin.com/level/12
    pattern-regex: 'bytes32\s*\[\s*\d*\s*\]\s+private'

  - id: sol-external-view-manipulation
    message: "External view function called multiple times - attacker can return different values (Elevator/Shop pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-367: Time-of-Check Time-of-Use"
      references:
        - https://ethernaut.openzeppelin.com/level/11
        - https://ethernaut.openzeppelin.com/level/21
    patterns:
      - pattern-inside: |
          function $FUNC(...) {
            ...
          }
      - pattern-either:
          - pattern: |
              if ($IFACE.$VIEW(...)) {
                ...
                $IFACE.$VIEW2(...)
              }
          - pattern: |
              $X = $IFACE.$VIEW(...);
              ...
              $Y = $IFACE.$VIEW2(...);

  - id: sol-array-length-manipulation
    message: "Array length can be manipulated - potential storage slot overflow attack (AlienCodex pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-680: Integer Overflow to Buffer Overflow"
      references:
        - https://ethernaut.openzeppelin.com/level/19
    pattern-either:
      - pattern: $ARR.length--
      - pattern: $ARR.length = $ARR.length - 1
      - pattern-regex: '\w+\.length\s*-=\s*1'

  - id: sol-extcodesize-check-bypassable
    message: "extcodesize check can be bypassed during contract construction (GatekeeperTwo pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://ethernaut.openzeppelin.com/level/14
    pattern-either:
      - pattern: require(extcodesize(msg.sender) == 0, ...)
      - pattern: |
          if (extcodesize(msg.sender) == 0) {
            ...
          }
      - pattern-regex: 'extcodesize\s*\(\s*msg\.sender\s*\)\s*==\s*0'

  - id: sol-gasleft-manipulation
    message: "gasleft() used for access control - can be manipulated by attacker (GatekeeperOne pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      references:
        - https://ethernaut.openzeppelin.com/level/13
    pattern-either:
      - pattern: require(gasleft() % $N == $M, ...)
      - pattern: |
          if (gasleft() % $N == $M) {
            ...
          }

  - id: sol-selfdestruct-force-eth
    message: "selfdestruct can force ETH to any address - contracts cannot prevent receiving ETH this way (Force pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
      references:
        - https://ethernaut.openzeppelin.com/level/7
    pattern-either:
      - pattern: selfdestruct(payable($ADDR))
      - pattern: selfdestruct($ADDR)

  - id: sol-delegatecall-preserves-context
    message: "Delegatecall in fallback executes external code in caller's context - storage/owner can be hijacked (Delegation pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://ethernaut.openzeppelin.com/level/6
    pattern-regex: 'fallback\s*\(\s*\)\s+external[^{]*\{[^}]*\.delegatecall\s*\(\s*msg\.data\s*\)'

  - id: sol-transfer-locktime-bypass
    message: "transfer() locked but transferFrom() may not be - check all ERC20 transfer methods (NaughtCoin pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-269: Improper Access Control"
      references:
        - https://ethernaut.openzeppelin.com/level/15
    pattern-regex: 'function\s+transfer\s*\([^)]*\)[^{]*override[^{]*\{[^}]*require\s*\([^)]*lockTime'

  - id: sol-dex-token-validation
    message: "DEX swap accepts any token address - attacker can use fake tokens to drain real ones (DexTwo pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://ethernaut.openzeppelin.com/level/23
    pattern-regex: 'function\s+swap\s*\(\s*address\s+\w+\s*,\s*address\s+\w+[^)]*\)[^{]*\{(?![^}]*require\s*\([^)]*token[12])'

  - id: sol-integer-underflow-pre-080
    message: "Unchecked subtraction can underflow in Solidity <0.8.0 - use SafeMath (Token pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-191: Integer Underflow"
      references:
        - https://ethernaut.openzeppelin.com/level/5
    pattern-regex: 'pragma solidity\s*[\^~]?\s*0\.[4-7]\.\d+.*\n[\s\S]*?(balances\s*\[\s*\w+\s*\]\s*-=|balances\s*\[\s*\w+\s*\]\s*-\s*\w+)'

  - id: sol-recovery-address-calculation
    message: "Contract addresses are deterministic - CREATE addresses can be computed from deployer + nonce (Recovery pattern)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
      references:
        - https://ethernaut.openzeppelin.com/level/17
    pattern: new $CONTRACT(...)

  - id: sol-good-samaritan-error-spoof
    message: "Custom errors can be spoofed by malicious contracts - do not trust error type for control flow (GoodSamaritan pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-755: Improper Handling of Exceptional Conditions"
      references:
        - https://ethernaut.openzeppelin.com/level/27
    patterns:
      - pattern: |
          try ... {
            ...
          } catch (bytes memory $ERR) {
            if (keccak256($ERR) == keccak256(...)) {
              ...
            }
          }

  - id: sol-higher-order-calldata-bypass
    message: "Assembly calldataload reads 32 bytes regardless of declared type - uint8 can receive larger values (HigherOrder pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://ethernaut.openzeppelin.com/level/30
    pattern-regex: 'function\s+\w+\s*\(\s*(uint8|uint16|uint24|uint32|int8|int16|int24|int32)\s+\w+[^)]*\)[^{]*\{[^}]*calldataload\s*\('

  # ============================================
  # MagicNumber Pattern (Level 18)
  # ============================================

  - id: sol-raw-bytecode-create
    message: "Raw bytecode deployment via create/create2 - verify bytecode source and intent (MagicNumber pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      references:
        - https://ethernaut.openzeppelin.com/level/18
    pattern-either:
      - pattern: create($VALUE, $OFFSET, $SIZE)
      - pattern: create2($VALUE, $OFFSET, $SIZE, $SALT)

  - id: sol-assembly-codecopy
    message: "Assembly codecopy can deploy arbitrary bytecode - ensure code source is trusted (MagicNumber pattern)"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-94: Improper Control of Generation of Code"
      references:
        - https://ethernaut.openzeppelin.com/level/18
    pattern: codecopy($DEST, $OFFSET, $SIZE)

  - id: sol-extcodesize-check
    message: "extcodesize check can be bypassed during constructor - contracts have size 0 while being created"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition"
      references:
        - https://ethernaut.openzeppelin.com/level/18
    pattern: extcodesize($ADDR)

  # ============================================
  # DoubleEntryPoint Pattern (Level 26)
  # ============================================

  - id: sol-delegate-transfer-function
    message: "delegateTransfer function enables proxy attacks - callers may unknowingly trigger different token transfers"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-441: Unintended Proxy or Intermediary"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-regex: 'function\s+delegateTransfer\s*\([^)]*\)'

  - id: sol-sweep-token-no-delegation-check
    message: "Sweep function doesn't check for token delegation - tokens may delegate to protected underlying (DoubleEntryPoint pattern)"
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-441: Unintended Proxy or Intermediary"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-regex: 'function\s+(sweepToken|sweep)\s*\([^)]*\)[^{]*\{[^}]*\.transfer\s*\('

  - id: sol-transfer-delegates-to-other
    message: "Token transfer function delegates to another contract - may cause unexpected state changes in caller"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-441: Unintended Proxy or Intermediary"
    pattern-regex: 'function\s+transfer\s*\([^)]*\)[^{]*\{[^}]*\.delegateTransfer\s*\('

  - id: sol-token-identity-check-bypass
    message: "Token identity check may be bypassed via delegation - compare actual underlying, not wrapper address"
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-290: Authentication Bypass by Spoofing"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-regex: 'require\s*\(\s*\w+\s*!=\s*(underlying|token)\s*,'

  - id: sol-forta-detection-bot
    message: "Forta detection bot pattern - monitors for suspicious transactions (DoubleEntryPoint defense)"
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-778: Insufficient Logging"
      references:
        - https://ethernaut.openzeppelin.com/level/26
    pattern-either:
      - pattern-regex: 'function\s+handleTransaction\s*\([^)]*\)[^{]*\{[^}]*raiseAlert\s*\('
      - pattern: IDetectionBot($BOT).handleTransaction(...)

