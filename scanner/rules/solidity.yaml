# Solidity/Smart Contract Security Rules
# Based on semgrep-rules/solidity - https://github.com/semgrep/semgrep-rules
rules:
  # ============================================
  # Critical: Access Control
  # ============================================

  - id: sol-accessible-selfdestruct
    message: Contract can be destructed by anyone - missing access control on selfdestruct
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      references:
        - https://www.parity.io/blog/a-postmortem-on-the-parity-multi-sig-library-self-destruct/
    patterns:
      - pattern-either:
          - pattern: selfdestruct($ADDR)
          - pattern: suicide($ADDR)
      - pattern-not-inside: |
          function $FUNC(...) onlyOwner { ... }
      - pattern-not-inside: |
          require(msg.sender == owner, ...);
          ...

  - id: sol-unrestricted-transferownership
    message: transferOwnership() lacks access control - anyone can take ownership
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-inside: |
          function transferOwnership($ADDR) public { ... }
      - pattern-not-inside: |
          function transferOwnership($ADDR) public onlyOwner { ... }

  # ============================================
  # Critical: Reentrancy
  # ============================================

  - id: sol-erc721-reentrancy
    message: ERC721 safeTransferFrom/safeMint can trigger reentrancy via onERC721Received callback
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://blocksecteam.medium.com/when-safemint-becomes-unsafe-lessons-from-the-hypebears-security-incident-2965209bda2a
    pattern: _checkOnERC721Received(...)

  - id: sol-erc777-reentrancy
    message: ERC777 tokens have send/receive hooks that can trigger reentrancy
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
    pattern-either:
      - pattern: IERC777($TOKEN).send(...)
      - pattern: IERC777($TOKEN).operatorSend(...)

  - id: sol-external-call-state-change
    message: State change after external call - potential reentrancy vulnerability
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-841: Improper Enforcement of Behavioral Workflow"
      references:
        - https://consensys.github.io/smart-contract-best-practices/attacks/reentrancy/
    patterns:
      - pattern-inside: |
          function $FUNC(...) {
            ...
          }
      - pattern: |
          $ADDR.call{...}(...);
          ...
          $STATE = $VALUE;

  # ============================================
  # Critical: Arbitrary Calls
  # ============================================

  - id: sol-arbitrary-low-level-call
    message: Arbitrary address with controlled calldata in low-level call - potential code injection
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://blocksecteam.medium.com/li-fi-attack-a-cross-chain-bridge-vulnerability-no-its-due-to-unchecked-external-call-c31e7dadf60f
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $ADDR, ..., bytes calldata $DATA, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $ADDR, ..., bytes calldata $DATA, ...) public { ... }
      - pattern-either:
          - pattern: $ADDR.call($DATA)
          - pattern: $ADDR.call{value:$V}($DATA)

  - id: sol-delegatecall-to-arbitrary-address
    message: Delegatecall to user-controlled address - attacker can execute arbitrary code in contract context
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
      references:
        - https://entethalliance.org/specs/ethtrust-sl/v1/#req-1-delegatecall
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $ANY(..., address $CONTRACT, ...) public {...}
          - pattern-inside: |
              function $ANY(..., address $CONTRACT, ...) external {...}
      - pattern-either:
          - pattern: $CONTRACT.delegatecall(...)
          - pattern: $CONTRACT.delegatecall{gas:$GAS}(...)

  # ============================================
  # High: Integer Issues
  # ============================================

  - id: sol-unchecked-arithmetic
    message: Unchecked arithmetic operation - potential overflow/underflow (Solidity <0.8.0)
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-190: Integer Overflow or Wraparound"
    patterns:
      - pattern-inside: |
          unchecked {
            ...
          }
      - pattern-either:
          - pattern: $X + $Y
          - pattern: $X - $Y
          - pattern: $X * $Y

  # ============================================
  # High: Token Security
  # ============================================

  - id: sol-erc20-public-burn
    message: Public burn function without access control - anyone can burn tokens
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-either:
          - pattern: |
              function burn($AMT) public {
                ...
              }
          - pattern: |
              function burn($AMT) external {
                ...
              }
      - pattern-not-inside: |
          function burn(...) ... onlyOwner { ... }

  - id: sol-arbitrary-transferfrom
    message: ERC721/ERC20 transferFrom with user-controlled from address - potential unauthorized transfer
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $FROM, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $FROM, ...) public { ... }
      - pattern-either:
          - pattern: $TOKEN.transferFrom($FROM, ...)
          - pattern: IERC20($TOKEN).transferFrom($FROM, ...)
          - pattern: IERC721($TOKEN).transferFrom($FROM, ...)

  # ============================================
  # High: Oracle & Price Manipulation
  # ============================================

  - id: sol-basic-oracle-manipulation
    message: Single-block price oracle - vulnerable to flash loan manipulation
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      references:
        - https://www.paradigm.xyz/2020/11/so-you-want-to-use-a-price-oracle
    patterns:
      - pattern-either:
          - pattern: $PAIR.getReserves()
          - pattern: IUniswapV2Pair($PAIR).getReserves()

  - id: sol-no-slippage-check
    message: DEX swap without slippage protection - vulnerable to sandwich attacks
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    patterns:
      - pattern-either:
          - pattern: $ROUTER.swapExactTokensForTokens(..., 0, ...)
          - pattern: $ROUTER.swapExactETHForTokens{...}(..., 0, ...)
          - pattern: IUniswapV2Router($R).swapExactTokensForTokens(..., 0, ...)

  # ============================================
  # Medium: Randomness
  # ============================================

  - id: sol-weak-randomness-blockhash
    message: Using blockhash for randomness - miners can manipulate this value
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern-either:
      - pattern: blockhash($BLOCK)
      - pattern: block.timestamp
      - pattern: block.difficulty
      - pattern: block.prevrandao

  - id: sol-incorrect-blockhash
    message: blockhash(block.number) always returns 0 - use block.number - 1
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"
    pattern: blockhash(block.number)

  # ============================================
  # Medium: Signature Issues
  # ============================================

  - id: sol-ecrecover-malleable
    message: ecrecover is vulnerable to signature malleability - use OpenZeppelin ECDSA
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-347: Improper Verification of Cryptographic Signature"
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/ECDSA.sol
    pattern: ecrecover($HASH, $V, $R, $S)

  - id: sol-missing-zero-address-check
    message: Missing zero address validation - tokens/ETH could be lost
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-20: Improper Input Validation"
    patterns:
      - pattern-either:
          - pattern-inside: |
              function $F(..., address $ADDR, ...) external { ... }
          - pattern-inside: |
              function $F(..., address $ADDR, ...) public { ... }
      - pattern-either:
          - pattern: $ADDR.transfer(...)
          - pattern: $TOKEN.transfer($ADDR, ...)
      - pattern-not-inside: |
          require($ADDR != address(0), ...);
          ...

  # ============================================
  # Medium: Proxy Patterns
  # ============================================

  - id: sol-proxy-storage-collision
    message: Potential storage collision in proxy pattern - use EIP-1967 slots
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-706: Use of Incorrectly-Resolved Name or Reference"
      references:
        - https://eips.ethereum.org/EIPS/eip-1967
    patterns:
      - pattern-inside: |
          contract $PROXY {
            ...
            address $IMPL;
            ...
          }
      - pattern: delegatecall(...)

  # ============================================
  # Info: Best Practices
  # ============================================

  - id: sol-use-ownable2step
    message: Consider using Ownable2Step instead of Ownable for safer ownership transfers
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable2Step.sol
    pattern: import "@openzeppelin/contracts/access/Ownable.sol"

  - id: sol-tx-origin-auth
    message: tx.origin used for authorization - vulnerable to phishing attacks
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-477: Use of Obsolete Function"
    patterns:
      - pattern-either:
          - pattern: require(tx.origin == $ADDR, ...)
          - pattern: if (tx.origin == $ADDR) { ... }
          - pattern: tx.origin == owner

  - id: sol-encode-packed-collision
    message: abi.encodePacked with multiple dynamic types - potential hash collision
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"
    pattern: abi.encodePacked($A, $B, ...)

  - id: sol-deprecated-suicide
    message: suicide() is deprecated - use selfdestruct() instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: suicide(...)

  - id: sol-floating-pragma
    message: Floating pragma version - pin to a specific version for production
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-regex: 'pragma solidity \^'

  - id: sol-missing-visibility
    message: Function missing explicit visibility specifier
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
    patterns:
      - pattern: |
          function $FUNC(...) {
            ...
          }
      - pattern-not: |
          function $FUNC(...) public { ... }
      - pattern-not: |
          function $FUNC(...) external { ... }
      - pattern-not: |
          function $FUNC(...) internal { ... }
      - pattern-not: |
          function $FUNC(...) private { ... }

  # ============================================
  # DeFi: Flash Loan Attacks
  # ============================================

  - id: sol-flash-loan-no-check
    message: Flash loan without proper balance check - ensure atomic execution
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-362: Concurrent Execution Using Shared Resource"
    pattern-either:
      - pattern: IFlashLoanReceiver($X).executeOperation(...)
      - pattern: IERC3156FlashBorrower($X).onFlashLoan(...)

  - id: sol-unchecked-return-value
    message: Return value of external call not checked - silent failure possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-252: Unchecked Return Value"
    patterns:
      - pattern: $TOKEN.transfer($TO, $AMT)
      - pattern-not-inside: require($TOKEN.transfer(...), ...)
      - pattern-not-inside: if ($TOKEN.transfer(...)) { ... }

  - id: sol-unsafe-erc20-transfer
    message: ERC20 transfer without SafeERC20 - some tokens dont return bool
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      references:
        - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol
    pattern-either:
      - pattern: IERC20($TOKEN).transfer(...)
      - pattern: IERC20($TOKEN).transferFrom(...)
      - pattern: IERC20($TOKEN).approve(...)

  # ============================================
  # DeFi: Liquidity & AMM Issues
  # ============================================

  - id: sol-hardcoded-deadline
    message: Hardcoded deadline in swap - use block.timestamp + buffer
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern-either:
      - pattern: $ROUTER.swapExactTokensForTokens(..., 9999999999, ...)
      - pattern: $ROUTER.swapExactTokensForTokens(..., type(uint256).max, ...)

  - id: sol-approve-max
    message: Unlimited token approval - use exact amount needed
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-either:
      - pattern: $TOKEN.approve($SPENDER, type(uint256).max)
      - pattern: IERC20($TOKEN).approve($SPENDER, type(uint256).max)

  - id: sol-missing-deadline
    message: DEX swap without deadline - transaction can be delayed by miners
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    pattern: $ROUTER.swapExactTokensForTokens(..., block.timestamp, ...)

  # ============================================
  # NFT Security
  # ============================================

  - id: sol-nft-overflow-mint
    message: NFT mint without supply check - potential overflow in tokenId
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: _mint($TO, $ID)
      - pattern-not-inside: |
          require($ID <= $MAX, ...);
          ...

  - id: sol-erc721-no-exists-check
    message: ERC721 operation without existence check - token may not exist
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    patterns:
      - pattern: ownerOf($ID)
      - pattern-not-inside: |
          require(_exists($ID), ...);
          ...

  - id: sol-nft-royalty-bypass
    message: NFT transfer without royalty enforcement - use ERC2981
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern-either:
      - pattern: safeTransferFrom($FROM, $TO, $ID)
      - pattern: transferFrom($FROM, $TO, $ID)

  # ============================================
  # Staking & Rewards
  # ============================================

  - id: sol-reward-before-update
    message: Reward calculation before state update - stale rewards possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          function $FUNC(...) {
            ...
          }
      - pattern: |
          $REWARD = $CALC;
          ...
          $STATE = $NEW;

  - id: sol-division-before-multiplication
    message: Division before multiplication causes precision loss
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-682: Incorrect Calculation"
    pattern: ($X / $Y) * $Z

  # ============================================
  # Gas & DOS
  # ============================================

  - id: sol-unbounded-loop
    message: Unbounded loop over array - potential DOS via gas limit
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-400: Uncontrolled Resource Consumption"
    patterns:
      - pattern: |
          for (uint $I = 0; $I < $ARR.length; $I++) {
            ...
          }

  - id: sol-external-call-in-loop
    message: External call in loop - gas griefing and DOS risk
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern-inside: |
          for (...) {
            ...
          }
      - pattern-either:
          - pattern: $ADDR.call(...)
          - pattern: $ADDR.transfer(...)
          - pattern: $ADDR.send(...)

  - id: sol-send-without-check
    message: send() return value not checked - silent failure
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: $ADDR.send($AMT)
      - pattern-not-inside: require($ADDR.send(...), ...)
      - pattern-not-inside: if ($ADDR.send(...)) { ... }

  # ============================================
  # Governance & Voting
  # ============================================

  - id: sol-flashloan-governance
    message: Governance vote without snapshot - flash loan attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern: balanceOf($VOTER)
      - pattern-inside: |
          function vote(...) {
            ...
          }

  - id: sol-centralized-admin
    message: Single admin with full control - consider multisig or timelock
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern-either:
          - pattern: onlyOwner
          - pattern: require(msg.sender == owner, ...)

  # ============================================
  # Upgradeable Contracts
  # ============================================

  - id: sol-initialize-not-protected
    message: initialize() without initializer modifier - can be called multiple times
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: |
          function initialize(...) public {
            ...
          }
      - pattern-not: |
          function initialize(...) public initializer { ... }

  - id: sol-selfdestruct-in-implementation
    message: selfdestruct in implementation contract - proxy becomes unusable
    languages: [solidity]
    severity: ERROR
    metadata:
      category: security
    patterns:
      - pattern: selfdestruct($ADDR)
      - pattern-inside: |
          contract $CONTRACT is Initializable {
            ...
          }

  - id: sol-no-gap-storage
    message: Upgradeable contract without storage gap - future upgrade collision risk
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
      references:
        - https://docs.openzeppelin.com/contracts/4.x/upgradeable#storage_gaps
    patterns:
      - pattern-inside: |
          contract $CONTRACT is Initializable {
            ...
          }
      - pattern-not: uint256[50] private __gap

  # ============================================
  # Cross-Chain & Bridge
  # ============================================

  - id: sol-cross-chain-replay
    message: Cross-chain call without chain ID check - replay attack possible
    languages: [solidity]
    severity: WARNING
    metadata:
      category: security
    patterns:
      - pattern-either:
          - pattern: keccak256(abi.encode(...))
          - pattern: keccak256(abi.encodePacked(...))
      - pattern-not-inside: |
          keccak256(abi.encode(..., block.chainid, ...))

  # ============================================
  # Additional Token Issues
  # ============================================

  - id: sol-erc20-double-approve
    message: ERC20 approve race condition - use increaseAllowance instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
      references:
        - https://github.com/ethereum/EIPs/issues/20#issuecomment-263524729
    pattern: approve($SPENDER, $AMT)

  - id: sol-fee-on-transfer-token
    message: Token amount after transfer may differ - check actual received amount
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    patterns:
      - pattern: $TOKEN.transferFrom($FROM, $TO, $AMT)
      - pattern-not-inside: |
          $BEFORE = $TOKEN.balanceOf($TO);
          ...
          $AFTER = $TOKEN.balanceOf($TO);

  - id: sol-reentrancy-lock
    message: State variable used as reentrancy guard - use OpenZeppelin ReentrancyGuard
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern-either:
          - pattern: |
              bool private locked;
          - pattern: |
              require(!locked, ...);
              locked = true;

  # ============================================
  # Compiler & Language Issues
  # ============================================

  - id: sol-assembly-usage
    message: Inline assembly detected - review carefully for security issues
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern: assembly { ... }

  - id: sol-deprecated-sha3
    message: sha3() is deprecated - use keccak256() instead
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: sha3(...)

  - id: sol-implicit-conversion
    message: Implicit type conversion - use explicit casting
    languages: [solidity]
    severity: INFO
    metadata:
      category: security
    pattern-either:
      - pattern: int($X)
      - pattern: uint($X)

  # ============================================
  # Event & Logging
  # ============================================

  - id: sol-missing-event-ownership
    message: Ownership transfer without event - makes tracking difficult
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern: owner = $NEW
      - pattern-not-inside: |
          emit OwnershipTransferred(...);

  - id: sol-missing-indexed-event
    message: Event parameter not indexed - harder to filter logs
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    pattern: event $NAME(address $ADDR, ...)

  # ============================================
  # Security Modifiers
  # ============================================

  - id: sol-require-without-message
    message: require() without error message - harder to debug failures
    languages: [solidity]
    severity: INFO
    metadata:
      category: best-practice
    patterns:
      - pattern: require($COND)
      - pattern-not: require($COND, $MSG)

